<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JMBN ‚Äì Admin Console</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--card:#0c0c0c;--border:#d6b44c;
  --accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;
  --fs:14px;
}
*{box-sizing:border-box}
body{
  margin:0;padding:14px;
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text);font-family:'Play',system-ui,sans-serif;font-size:var(--fs);letter-spacing:.25px
}

/* header mount */
.brand{display:flex;align-items:center;gap:10px;margin:0 0 8px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.brand-logo{width:44px;height:44px;object-fit:contain}
.brand h1{font-weight:700;font-size:clamp(18px,2.2vw,22px);color:var(--accent);margin:0}

/* layout */
.wrap{display:grid;grid-template-columns:320px 1fr;gap:16px;max-width:1280px;margin:0 auto}
@media(max-width:980px){.wrap{grid-template-columns:1fr}}

.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:0 0 18px rgba(214,180,76,.20)}
.section{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:10px}

h2{margin:6px 0 10px;color:var(--accent);font-size:16px}

/* left: members list */
.search{width:100%;background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:9px 10px;color:var(--text)}
.list{margin-top:10px;display:flex;flex-direction:column;gap:8px;max-height:75vh;overflow:auto;padding-right:4px}
.item{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:9px;border:1px solid var(--border);border-radius:10px;background:#0a0a0a;cursor:pointer}
.item:hover{background:#111}
.badge{border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;background:#121212;color:var(--accent)}
.small{font-size:12px;color:var(--muted)}

/* right: tabs */
.tabs{display:flex;gap:8px;flex-wrap:wrap}
.tab-btn{padding:7px 12px;border:1px solid var(--border);border-radius:10px;background:linear-gradient(180deg,#0c0c0c,#060606);color:var(--accent);cursor:pointer}
.tab-btn.active,
button.primary{background:linear-gradient(180deg,var(--accent),#e7c760);color:#000}
button{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:#0c0c0c;color:var(--accent);cursor:pointer;font-family:'Play'}
button:hover{filter:brightness(1.1)}
button.danger{border-color:var(--bad);color:var(--bad)}

.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:900px){.grid-2{grid-template-columns:1fr}}
.row{display:flex;align-items:center;gap:10px}

/* cert cards */
.cert{display:grid;grid-template-columns:56px 1fr auto;gap:10px;align-items:center;padding:8px;border:1px solid var(--border);border-radius:10px;background:#0b0b0b}
.cert .thumb{width:56px;height:56px;border:1px solid var(--border);border-radius:10px;background:#111;display:grid;place-items:center}
.cert .thumb img{max-width:80%;max-height:80%}
.progress{height:8px;border-radius:999px;background:#111;border:1px solid var(--border);overflow:hidden}
.fill{height:100%;background:linear-gradient(180deg,var(--accent),#d6b44c)}
.dim{opacity:.55;filter:grayscale(.6)}

/* events list */
.events{list-style:none;margin:6px 0 0;padding:0}
.events li{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.06)}
.events .muted{color:var(--muted)}
</style>
</head>
<body>

<!-- header mount -->
<div id="header-container"></div>
<script>
(async () => {
  try {
    const res = await fetch('header.html', { cache: 'no-cache' });
    const html = await res.text();
    document.getElementById('header-container').outerHTML = html;
    requestAnimationFrame(() => {
      const here = (location.pathname.split('/').pop()||'admin.html').toLowerCase();
      document.querySelectorAll('.nav-btn').forEach(a=>{
        const href=(a.getAttribute('href')||'').toLowerCase();
        if(href===here) a.classList.add('active');
      });
    });
  } catch {}
})();
</script>

<div class="wrap">
  <!-- LEFT: members -->
  <div class="panel">
    <h2>Members</h2>
    <input id="q" class="search" placeholder="Search handle / rank / role‚Ä¶">
    <div class="row" style="margin-top:8px">
      <span id="mcount" class="badge">0</span>
      <span class="small">Select a member to manage.</span>
    </div>
    <div id="mlist" class="list"><div class="small">Loading‚Ä¶</div></div>
  </div>

  <!-- RIGHT: inspector -->
  <div class="panel">
    <div class="row" style="justify-content:space-between">
      <h2 id="title">Inspector</h2>
      <div class="row small"><span id="who"></span><span id="pg" class="badge">‚Äî</span></div>
    </div>

    <div class="tabs" style="margin-bottom:10px">
      <button class="tab-btn active" data-tab="overview">Overview</button>
      <button class="tab-btn" data-tab="certs">Certifications</button>
      <button class="tab-btn" data-tab="training">Training</button>
      <button class="tab-btn" data-tab="rank">Rank</button>
    </div>

    <!-- OVERVIEW -->
    <div class="section" data-pane="overview">
      <div class="grid-2">
        <div>
          <div class="small">Handle</div>
          <div id="ov_handle" style="font-weight:700;color:var(--accent)">‚Äî</div>
        </div>
        <div>
          <div class="small">Current Rank</div>
          <div><span id="ov_rank">‚Äî</span></div>
        </div>
        <div>
          <div class="small">Rank Category</div>
          <div id="ov_cat">‚Äî</div>
        </div>
        <div>
          <div class="small">Missions Attended</div>
          <div id="ov_missions">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- CERTIFICATIONS -->
    <div class="section" data-pane="certs" style="display:none">
      <h2 style="margin-top:0">Certifications</h2>
      <div id="certList" class="grid-2">Loading‚Ä¶</div>
      <div class="small" style="margin-top:8px">Grant/Remove training events to change completion. Your triggers will auto-award or revoke the cert.</div>
    </div>

    <!-- TRAINING -->
    <div class="section" data-pane="training" style="display:none">
      <h2 style="margin-top:0">Training Events</h2>
      <div class="row" style="gap:8px;margin-bottom:8px">
        <input id="teSearch" class="search" placeholder="Filter events‚Ä¶">
        <button id="refreshTE">Refresh</button>
      </div>
      <ul id="events" class="events"><li class="small">Loading‚Ä¶</li></ul>
    </div>

    <!-- RANK -->
    <div class="section" data-pane="rank" style="display:none">
      <h2 style="margin-top:0">Rank Actions</h2>
      <div class="row" style="flex-wrap:wrap;gap:8px">
        <button id="btnPromote" class="primary">Run Promotion Check</button>
        <span class="small">Uses <code>request_promotion(p_user uuid)</code>.</span>
      </div>

      <hr style="border:none;height:1px;background:linear-gradient(90deg,rgba(214,180,76,.15),rgba(214,180,76,.4),rgba(214,180,76,.15));margin:12px 0">

      <div class="row" style="flex-wrap:wrap;gap:10px">
        <select id="rankSelect" style="background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:8px;color:var(--text);min-width:260px"></select>
        <button id="btnForce">Force Set Rank</button>
        <span class="small">Calls <code>set_rank_track(uuid, text)</code>. Adjust arg names in the JS if your function differs.</span>
      </div>
    </div>
  </div>
</div>

<!-- libs -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
/* ========= helpers ========= */
const $ = s => document.querySelector(s);
const $$= s => Array.from(document.querySelectorAll(s));
const esc = s => { const d=document.createElement('div'); d.textContent = s ?? ''; return d.innerHTML; };
const pane = name => document.querySelector('[data-pane="'+name+'"]');

/* ========= state ========= */
let sb=null, me=null, elevated=false;
let MEMBERS=[], SELECTED=null;
let ALL_EVENTS=[];  // training_events catalog
let CERT_REQS=new Map(); // code -> req rows

/* ========= tab UI ========= */
$$('.tab-btn').forEach(b=>{
  b.onclick=()=>{
    $$('.tab-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const tab=b.dataset.tab;
    ['overview','certs','training','rank'].forEach(t=>pane(t).style.display = (t===tab?'block':'none'));
  };
});

/* ========= boot ========= */
document.addEventListener('DOMContentLoaded', async () => {
  const session = await requireAuth(); if(!session) return;
  sb = getSupabase(); me = session.user.id;

  // must be elevated
  const { data:isElev } = await sb.rpc('is_elevated', { u: me });
  elevated = isElev === true;
  if(!elevated){
    alert('You need officer/admin privileges to use the Admin Console.');
    location.href='index.html'; return;
  }

  // warm lookups
  await Promise.all([loadMembers(), loadEventsCatalog(), loadCertRequirements(), loadRanks()]);
  wireSearch();
});

/* ========= members ========= */
async function loadMembers(){
  const { data, error } = await sb
    .from('v_profiles_detailed')
    .select('user_id,handle,display_name,current_rank_name,current_rank_category,current_rank_code,missions_attended')
    .order('current_rank_category',{ascending:true})
    .order('handle',{ascending:true});
  if(error){ $('#mlist').innerHTML = `<div class="small" style="color:var(--bad)">Failed: ${esc(error.message)}</div>`; return; }
  MEMBERS = data || [];
  renderMemberList(MEMBERS);
}
function renderMemberList(rows){
  $('#mcount').textContent = `${rows.length} member${rows.length===1?'':'s'}`;
  const list = rows.map(r=>{
    const name = r.handle || r.display_name || r.user_id.slice(0,8);
    const sub  = `${r.current_rank_category||'‚Äî'} ‚Äî ${r.current_rank_name||'Unrated'} ‚Ä¢ ${r.missions_attended||0} missions`;
    return `
      <div class="item" data-id="${r.user_id}">
        <div>
          <div style="font-weight:700;color:var(--accent)">${esc(name)}</div>
          <div class="small">${esc(sub)}</div>
        </div>
        <span class="badge">${esc(r.current_rank_code||'‚Äî')}</span>
      </div>`;
  }).join('');
  $('#mlist').innerHTML = list || '<div class="small">No members.</div>';
  $$('#mlist .item').forEach(el=>el.onclick=()=>selectMember(el.dataset.id));
}
function wireSearch(){
  const q = $('#q');
  q.addEventListener('input', ()=>{
    const term = (q.value||'').toLowerCase().trim();
    const rows = !term ? MEMBERS : MEMBERS.filter(r => (
      `${r.handle||''} ${r.display_name||''} ${r.current_rank_category||''} ${r.current_rank_name||''}`.toLowerCase().includes(term)
    ));
    renderMemberList(rows);
  });
}

/* ========= selecting a member ========= */
async function selectMember(uid){
  SELECTED = MEMBERS.find(x=>x.user_id===uid) || null;
  if(!SELECTED) return;

  // header bits
  $('#title').textContent = 'Inspector ‚Äî ' + (SELECTED.handle || SELECTED.display_name || uid.slice(0,8));
  $('#who').textContent   = uid.slice(0,8);
  $('#pg').textContent    = SELECTED.current_rank_code || '‚Äî';

  // overview
  $('#ov_handle').textContent  = SELECTED.handle || SELECTED.display_name || uid.slice(0,8);
  $('#ov_rank').textContent    = SELECTED.current_rank_name || 'Unrated';
  $('#ov_cat').textContent     = SELECTED.current_rank_category || '‚Äî';
  $('#ov_missions').textContent= SELECTED.missions_attended || 0;

  // build panes
  await Promise.all([renderCerts(uid), renderTraining(uid)]);
}

/* ========= events & cert requirements ========= */
async function loadEventsCatalog(){
  const { data } = await sb.from('training_events').select('event_code,title').order('title');
  ALL_EVENTS = data || [];
}
async function loadCertRequirements(){
  const { data } = await sb.from('certification_requirements').select('certification_code,event_code,required,sort_order,training_events(title)');
  CERT_REQS.clear();
  (data||[]).forEach(r=>{
    if(!CERT_REQS.has(r.certification_code)) CERT_REQS.set(r.certification_code, []);
    CERT_REQS.get(r.certification_code).push(r);
  });
  // sort inside each cert
  for(const [k,arr] of CERT_REQS.entries()){
    arr.sort((a,b)=>(a.sort_order||0)-(b.sort_order||0));
  }
}

/* ========= certifications pane ========= */
async function renderCerts(uid){
  const grid = $('#certList'); grid.textContent='Loading‚Ä¶';

  // owned flags (catalog + owned)
  const { data } = await sb
    .from('v_user_certifications')
    .select('certification_code,name,image_url,owned,sort_order,user_id')
    .or(`user_id.eq.${uid},user_id.is.null`)
    .order('sort_order',{ascending:true});

  const { data: ute } = await sb.from('user_training_events').select('event_code').eq('user_id', uid);
  const done = new Set((ute||[]).map(x=>x.event_code));

  grid.innerHTML = (data||[]).map(row=>{
    const code = row.certification_code;
    const name = row.name || code;
    const reqs = CERT_REQS.get(code)||[];
    const have = reqs.filter(r=>done.has(r.event_code)).length;
    const need = reqs.filter(r=>r.required).length || reqs.length || 1;
    const pct  = Math.round( (have/Math.max(need,1))*100 );
    const dim  = row.owned ? '' : 'dim';
    const img  = row.image_url ? `<img src="${row.image_url}" alt="${esc(name)}">` : 'üèÖ';

    return `
      <div class="cert ${dim}">
        <div class="thumb">${img}</div>
        <div>
          <div style="font-weight:700;color:var(--accent)">${esc(name)}</div>
          <div class="progress" title="${have}/${reqs.length} events"><div class="fill" style="width:${pct}%"></div></div>
          <div class="small" style="margin-top:4px">${have}/${reqs.length} events</div>
        </div>
        <div>
          <button data-manage="${esc(code)}">Manage</button>
        </div>
      </div>`;
  }).join('') || '<div class="small">No certifications configured.</div>';

  // manage click
  grid.querySelectorAll('button[data-manage]').forEach(b=>{
    b.onclick = ()=> openCertManager(uid, b.dataset.manage);
  });
}

async function openCertManager(uid, code){
  const reqs = CERT_REQS.get(code)||[];
  const { data: doneRows } = await sb.from('user_training_events').select('event_code').eq('user_id', uid);
  const done = new Set((doneRows||[]).map(x=>x.event_code));

  // build modal-ish inline list (reuse training buttons)
  const html = `
    <div class="section">
      <h2 style="margin:0 0 6px">Manage ${esc(code)}</h2>
      <ul class="events">
        ${reqs.map(r=>{
          const has = done.has(r.event_code);
          return `<li>
            <span>${esc(r.training_events?.title||r.event_code)}</span>
            ${has
              ? `<button class="danger" data-remove="${r.event_code}">Remove</button>`
              : `<button class="primary" data-add="${r.event_code}">Grant</button>`}
          </li>`;
        }).join('')}
      </ul>
      <div class="small">Changes here insert/delete rows in <code>user_training_events</code>. Your triggers refresh <code>user_certifications</code> automatically.</div>
    </div>`;
  // inject below cert pane
  pane('certs').insertAdjacentHTML('beforeend', html);

  const box = pane('certs').lastElementChild;
  box.querySelectorAll('button[data-add]').forEach(b=>{
    b.onclick = async ()=>{
      await sb.from('user_training_events').insert({ user_id: uid, event_code: b.dataset.add, completed_at: new Date().toISOString() });
      await renderCerts(uid); await renderTraining(uid);
      box.remove();
    };
  });
  box.querySelectorAll('button[data-remove]').forEach(b=>{
    b.onclick = async ()=>{
      await sb.from('user_training_events').delete().eq('user_id', uid).eq('event_code', b.dataset.remove);
      await renderCerts(uid); await renderTraining(uid);
      box.remove();
    };
  });
}

/* ========= training pane ========= */
async function renderTraining(uid){
  const ul = $('#events'); ul.innerHTML = '<li class="small">Loading‚Ä¶</li>';

  const { data:done } = await sb.from('user_training_events').select('event_code').eq('user_id', uid);
  const doneSet = new Set((done||[]).map(x=>x.event_code));

  const filter = ($('#teSearch').value||'').toLowerCase().trim();
  const rows = !filter ? ALL_EVENTS : ALL_EVENTS.filter(e => (e.title||'').toLowerCase().includes(filter) || (e.event_code||'').toLowerCase().includes(filter));

  ul.innerHTML = rows.map(r=>{
    const has = doneSet.has(r.event_code);
    return `<li>
      <span>${esc(r.title)} <span class="small muted">(${esc(r.event_code)})</span></span>
      ${has
        ? `<button class="danger" data-remove="${r.event_code}">Remove</button>`
        : `<button class="primary" data-add="${r.event_code}">Grant</button>`}
    </li>`;
  }).join('') || '<li class="small">No events.</li>';

  ul.querySelectorAll('button[data-add]').forEach(b=>{
    b.onclick = async ()=>{
      await sb.from('user_training_events').insert({ user_id: uid, event_code: b.dataset.add, completed_at: new Date().toISOString() });
      await renderTraining(uid); await renderCerts(uid);
    };
  });
  ul.querySelectorAll('button[data-remove]').forEach(b=>{
    b.onclick = async ()=>{
      await sb.from('user_training_events').delete().eq('user_id', uid).eq('event_code', b.dataset.remove);
      await renderTraining(uid); await renderCerts(uid);
    };
  });
}
$('#teSearch').addEventListener('input', ()=> SELECTED && renderTraining(SELECTED.user_id));
$('#refreshTE').onclick = ()=> SELECTED && renderTraining(SELECTED.user_id);

/* ========= rank pane ========= */
async function loadRanks(){
  const { data } = await sb.from('ranks').select('code,name,category,sort_order').order('sort_order');
  const sel = $('#rankSelect'); sel.innerHTML = (data||[]).map(r=>`<option value="${esc(r.code)}">${esc(r.name)} ‚Äî ${esc(r.category)}</option>`).join('');
}
$('#btnPromote').onclick = async ()=>{
  if(!SELECTED) return;
  const { data, error } = await sb.rpc('request_promotion', { p_user: SELECTED.user_id });
  if(error){ alert('Promotion failed: '+error.message); return; }
  if(data?.ok){ alert('Promotion updated ‚úì'); await loadMembers(); SELECTED = MEMBERS.find(x=>x.user_id===SELECTED.user_id)||SELECTED; selectMember(SELECTED.user_id); }
  else alert(data?.message || 'Not eligible.');
};

/* If your function signature differs, edit this helper to match your arg names. */
const SET_RANK_ARGS = (uid, code) => ({ p_user: uid, p_code: code });

$('#btnForce').onclick = async ()=>{
  if(!SELECTED) return;
  const code = $('#rankSelect').value;
  if(!code) return alert('Choose a rank.');
  if(!confirm(`Force set rank to ${code}?`)) return;
  const { error } = await sb.rpc('set_rank_track', SET_RANK_ARGS(SELECTED.user_id, code));
  if(error){ alert('Force set failed: '+error.message); return; }
  alert('Rank updated ‚úì');
  await loadMembers(); SELECTED = MEMBERS.find(x=>x.user_id===SELECTED.user_id)||SELECTED; selectMember(SELECTED.user_id);
};
</script>
</body>
</html>
