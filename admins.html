<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JMBN â€“ Progression (Badge Collection Case)</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  --bg:#000; --line:#d6b44c; --accent:#f2d675; --text:#f7f1d0; --muted:#c9b06a;
  --ink:#0b0b0b; --ink2:#111; --fs:14px;
}
*{box-sizing:border-box}
html,body{margin:0}
body{
  font-family:'Play',system-ui,sans-serif; font-size:var(--fs); color:var(--text);
  background:
    radial-gradient(1200px 900px at 10% -15%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
}

/* Ambient grid + vignette */
.hud-grid{position:fixed;inset:0;z-index:-2;pointer-events:none;opacity:.42;
  background-image:
    linear-gradient(rgba(214,180,76,.09) 1px, transparent 1px),
    linear-gradient(90deg, rgba(214,180,76,.09) 1px, transparent 1px);
  background-size:80px 80px; animation:drift 95s linear infinite;}
@keyframes drift{from{background-position:0 0}to{background-position:-160px -160px}}
body::after{content:"";position:fixed;inset:0;z-index:-1;pointer-events:none;
  background:radial-gradient(900px 650px at 55% 42%, rgba(0,0,0,0) 28%, rgba(0,0,0,.55) 72%, rgba(0,0,0,.85) 100%)}

/* Hero */
.hero{position:relative;border-bottom:1px solid var(--line);
  background:linear-gradient(180deg,rgba(0,0,0,.9),rgba(0,0,0,.75));}
.shell{max-width:1180px;margin:0 auto;padding:14px}
.hero-row{display:grid;grid-template-columns:auto 1fr auto;gap:14px;align-items:center}
.logo-wrap{position:relative;width:56px;height:56px;border-radius:14px;overflow:hidden;background:#000;display:grid;place-items:center;
  box-shadow:0 0 14px rgba(214,180,76,.25)}
.logo{width:100%;height:100%;object-fit:cover}
.logo-wrap::after{content:"";position:absolute;inset:0;border-radius:14px;box-shadow:inset 0 0 0 8px #000}
.hero h1{margin:0;color:var(--accent);font-size:clamp(22px,3vw,28px);letter-spacing:.4px}
.hero .sub{color:var(--muted);font-size:12px}
.hero-rule{height:1px;background:linear-gradient(90deg,transparent,rgba(214,180,76,.6),transparent);border-radius:999px;margin-top:10px}

/* Layout */
.main{max-width:1180px;margin:0 auto;padding:14px}
.grid{display:grid;grid-template-columns:320px 1fr;gap:20px}
@media(max-width:1020px){.grid{grid-template-columns:1fr}}

/* Left rail */
.rail{position:sticky;top:12px;height:fit-content}
.block{padding:10px 0;border-bottom:1px solid rgba(214,180,76,.28)}
.block:last-child{border-bottom:none}
.block-title{margin:0 0 8px;color:var(--accent);font-weight:700;font-size:16px}

/* Rank rows */
.row{display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;padding:8px 4px;
  transition:background .18s ease;border-radius:8px}
.row:hover{background:rgba(214,180,76,.07)}
.kv{display:flex;flex-direction:column}
.k{color:var(--muted);font-size:12px}
.v{font-weight:800}

/* Mask baked gold rim on rank emblem */
.rankImg{width:54px;height:54px;border-radius:14px;background:#000;object-fit:contain;display:block;box-shadow:inset 0 0 0 7px #000}

/* Chips */
.pill{display:inline-flex;align-items:center;gap:6px;padding:7px 12px;border:1px solid var(--line);
  border-radius:999px;background:linear-gradient(180deg,#121212,#070707);color:var(--accent);font-weight:800;font-size:12px}
.btn{cursor:pointer;transition:filter .18s ease,transform .06s ease}
.btn:hover{filter:brightness(1.08)} .btn:active{transform:translateY(1px)}
.btn.pulse{animation:pulseGlow 1.6s ease-in-out infinite}
@keyframes pulseGlow{0%{box-shadow:0 0 0 0 rgba(242,214,117,.0)}50%{box-shadow:0 0 18px 0 rgba(242,214,117,.35)}100%{box-shadow:0 0 0 0 rgba(242,214,117,.0)}}

/* Requirement meters */
.pb{display:grid;grid-template-columns:110px 1fr auto;gap:10px;align-items:center;margin:8px 0}
.pb .label{color:var(--muted);font-size:12px}
.track{--w:0%;height:12px;border-radius:999px;position:relative;background:#0a0a0a;
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.28);overflow:hidden}
.track::before{content:"";position:absolute;inset:0;background-image:linear-gradient(to right, rgba(214,180,76,.15) 1px, transparent 1px);
  background-size:10% 100%;opacity:.35;pointer-events:none}
.fill{height:100%;width:var(--w);background:linear-gradient(180deg,var(--accent),#d6b44c);
  transition:width .9s cubic-bezier(.25,.9,.25,1)}
.val{font-size:12px;color:var(--muted);font-variant-numeric:tabular-nums}
.count{display:inline-block;min-width:38px;text-align:right}

/* Right content */
.section{position:relative;padding-top:4px}
.ribbon{position:sticky;top:0;z-index:5;display:flex;align-items:center;gap:10px;padding:10px 0;
  background:linear-gradient(180deg,rgba(0,0,0,.92),rgba(0,0,0,.76));border-bottom:1px solid var(--line);backdrop-filter:saturate(1.2) blur(2px)}
.ribbon h2{margin:0;color:var(--accent);font-size:18px}
.sep{height:1px;background:linear-gradient(90deg,transparent,rgba(214,180,76,.5),transparent);border-radius:999px;margin:16px 0}

/* Timeline */
.timeline{position:relative;padding-left:18px;margin-top:8px}
.timeline::before{content:"";position:absolute;left:7px;top:0;bottom:0;width:2px;background:linear-gradient(180deg,rgba(214,180,76,.35),transparent)}
.ti{position:relative;padding:11px 0 11px 10px;border-bottom:1px dashed rgba(214,180,76,.28)}
.ti:last-child{border-bottom:none}
.ti::before{content:"";position:absolute;left:-2px;top:17px;width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 10px rgba(242,214,117,.6)}
.ti .when{color:var(--muted);font-size:12px}
.ti .chg b{color:var(--accent)}

/* ===== Badge Collection Case ===== */
.case{
  position:relative;margin-top:10px;border-radius:16px;
  background:
    linear-gradient(180deg, rgba(214,180,76,.18), rgba(214,180,76,.04)) border-box,
    linear-gradient(180deg, #0b0b0b, #050505) padding-box;
  border:1px solid transparent;
  box-shadow:0 0 22px rgba(214,180,76,.18), inset 0 0 0 1px rgba(214,180,76,.18);
  padding:14px;
}
.case::before{ /* glass sheen */
  content:""; position:absolute; inset:0; pointer-events:none; border-radius:16px;
  background:
    linear-gradient(120deg, rgba(255,255,255,.05) 0%, rgba(255,255,255,.08) 18%, rgba(255,255,255,0) 25%),
    radial-gradient(800px 140px at 30% -10%, rgba(255,255,255,.07), transparent 70%);
  mix-blend-mode:screen;
}
.shelf{
  --h: 140px;
  display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));
  gap:14px; padding:16px 6px 10px; margin:0 0 12px;
  position:relative;
  background:
    linear-gradient(180deg, rgba(214,180,76,.25), rgba(214,180,76,.0)) top/100% 2px no-repeat,
    linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
  border-radius:12px;
}
.shelf:last-child{margin-bottom:0}

/* slots */
.slot{
  height:var(--h); border-radius:14px; position:relative; overflow:hidden;
  background:radial-gradient(200px 120px at 50% 20%, rgba(255,255,255,.06), rgba(255,255,255,0) 60%), #0e0e0e;
  box-shadow:
    inset 0 0 0 1px rgba(214,180,76,.25),
    0 0 0 1px rgba(0,0,0,.6);
  display:grid; place-items:center;
  transition:transform .15s ease, box-shadow .2s ease, filter .2s ease;
}
.slot:hover{transform:translateY(-2px); box-shadow:0 0 20px rgba(214,180,76,.20), inset 0 0 0 1px rgba(214,180,76,.3)}
.slot .img-wrap{width:86%; height:86%; display:grid; place-items:center}
.slot img{max-width:100%; max-height:100%; display:block}

/* owned effect */
.slot.owned{filter:none}
.slot.owned::after{
  content:""; position:absolute; inset:0; pointer-events:none; border-radius:14px;
  box-shadow:0 0 18px rgba(242,214,117,.35), inset 0 0 0 1px rgba(242,214,117,.35);
}

/* locked/empty */
.slot.locked{opacity:.55; filter:grayscale(.6) contrast(.95)}
.slot.locked .lock{
  position:absolute; inset:auto 8px 8px auto; width:22px; height:22px;
  border-radius:6px; background:#0b0b0b; border:1px solid rgba(214,180,76,.35);
  display:grid; place-items:center; font-size:12px; color:var(--muted)
}

/* label under slot */
.label{
  text-align:center; margin-top:6px;
  font-size:12px; color:var(--muted)
}
.label .name{display:block; color:var(--text); font-weight:700}
.label .code{opacity:.85}

/* Helpers */
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="hud-grid"></div>

<header class="hero">
  <div id="header-container" class="shell">
    <div class="hero-row">
      <div class="logo-wrap"><img class="logo" src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" alt="JMBN"></div>
      <div>
        <h1>Rank Progression</h1>
        <div class="sub">Live requirements â€¢ Eligibility â€¢ Badge Collection Case</div>
      </div>
      <div><span class="pill" id="curPgHero">PG: â€”</span></div>
    </div>
    <div class="hero-rule"></div>
  </div>
</header>
<script>
(async () => {
  try {
    const res = await fetch('header.html', { cache: 'no-cache' });
    if (res.ok) {
      const html = await res.text();
      document.getElementById('header-container').outerHTML = html;
      requestAnimationFrame(() => {
        const here = (location.pathname.split('/').pop() || 'rank-progression.html').toLowerCase();
        document.querySelectorAll('.nav-btn').forEach(a=>{
          const href=(a.getAttribute('href')||'').toLowerCase();
          if(href===here || (here==='' && href==='index.html')) a.classList.add('active');
        });
      });
    }
  } catch {}
})();
</script>

<main class="main">
  <div class="grid">
    <!-- LEFT: Command Rail -->
    <aside class="rail">
      <div class="block">
        <div class="block-title">Overview</div>
        <div class="row">
          <img id="curImg" class="rankImg" alt="Current Rank">
          <div class="kv">
            <div class="k">Current Rank</div>
            <div class="v" id="curRank">â€”</div>
          </div>
          <span class="pill" id="curPg">PG: â€”</span>
        </div>
        <div class="row">
          <img id="nextImg" class="rankImg" alt="Next Rank">
          <div class="kv">
            <div class="k">Next Rank</div>
            <div class="v" id="nextName">â€”</div>
          </div>
          <span class="pill" id="nextPg">PG: â€”</span>
        </div>
        <div class="row" style="justify-content:flex-end">
          <button class="pill btn" id="btnPromote" disabled title="Available when all targets are met">Request Promotion</button>
        </div>
      </div>

      <div class="block">
        <div class="block-title">Requirements</div>
        <div class="pb">
          <div class="label">Missions</div>
          <div class="track" id="trkM"><div id="pbMissions" class="fill"></div></div>
          <div class="val"><span class="count" id="cm">0</span> / <span id="cmt">0</span></div>
        </div>
        <div class="pb">
          <div class="label">Hours</div>
          <div class="track" id="trkH"><div id="pbHours" class="fill"></div></div>
          <div class="val"><span class="count" id="ch">0</span> / <span id="cht">0</span></div>
        </div>
        <div class="pb">
          <div class="label">Certifications</div>
          <div class="track" id="trkC"><div id="pbCerts" class="fill"></div></div>
          <div class="val"><span class="count" id="cc">0</span> / <span id="cct">0</span></div>
        </div>
        <div class="small" id="note" style="margin-top:6px">Promotion is available when all targets are met.</div>
      </div>
    </aside>

    <!-- RIGHT: History + Badge Case -->
    <section>
      <div class="section">
        <div class="ribbon"><h2>History</h2></div>
        <div class="timeline" id="history"><div class="small">Loadingâ€¦</div></div>
      </div>

      <div class="sep"></div>

      <div class="section">
        <div class="ribbon"><h2>Badge Collection Case</h2></div>

        <!-- Shelves will be filled dynamically, but we keep one container -->
        <div class="case">
          <div id="caseShelves">
            <!-- shelves get injected here -->
          </div>
        </div>

        <div class="small" style="margin-top:8px">Glow = owned. Dim = not yet earned.</div>
      </div>
    </section>
  </div>
</main>

<!-- Supabase + App -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
const $ = s => document.querySelector(s);
let session=null, sb=null, me=null;

function setFill(trackSel, pct){
  const track = $(trackSel);
  const x = Math.max(0, Math.min(1, Number(pct)||0));
  if(track) track.style.setProperty('--w', (x*100)+'%');
}
function countUp(el, to, ms=800){
  const n = Number(to)||0; const start = Number(el?.textContent||0)||0;
  if(!el) return;
  const t0 = performance.now();
  function step(t){
    const k = Math.min(1, (t - t0) / ms);
    const v = Math.round(start + (n - start) * (k<1? (1 - Math.pow(1-k,2)) : 1));
    el.textContent = v;
    if(k<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}
async function fetchRankImage(code){
  if(!code) return '';
  try{ return sb.storage.from('Ranks').getPublicUrl(`${code}.png`).data.publicUrl || ''; }
  catch{ return ''; }
}

/* Load progression + meters */
async function loadProgress(){
  const { data: prog } = await sb
    .from('v_user_rank_progress')
    .select('*')
    .eq('user_id', me)
    .maybeSingle();

  $('#curRank').textContent  = prog?.current_name || '(unranked)';
  const curPgText = `PG: ${prog?.current_paygrade || 'â€”'}`;
  $('#curPg').textContent = curPgText; $('#curPgHero').textContent = curPgText;
  $('#nextName').textContent = prog?.next_name || 'â€”';
  $('#nextPg').textContent   = `PG: ${prog?.next_paygrade || 'â€”'}`;

  const curImg = await fetchRankImage(prog?.current_code);
  const nxtImg = await fetchRankImage(prog?.next_code);
  if (curImg){ $('#curImg').src = curImg; $('#curImg').style.visibility='visible'; } else { $('#curImg').style.visibility='hidden'; }
  if (nxtImg){ $('#nextImg').src = nxtImg; $('#nextImg').style.visibility='visible'; } else { $('#nextImg').style.visibility='hidden'; }

  const { data: up } = await sb
    .from('v_user_progress')
    .select('*')
    .eq('user_id', me)
    .maybeSingle();

  const m = Number(up?.missions_attended || 0);
  const h = Number(up?.hours_total || 0);
  const c = Number(up?.certifications_total || 0);

  const mt = Number(prog?.missions_target || 0);
  const ht = Number(prog?.hours_target || 0);
  const ct = Number(prog?.certification_target || 0);

  countUp($('#cm'), m); $('#cmt').textContent = mt;
  countUp($('#ch'), h); $('#cht').textContent = ht;
  countUp($('#cc'), c); $('#cct').textContent = ct;

  setFill('#trkM', mt ? Math.min(1, m/mt) : 1);
  setFill('#trkH', ht ? Math.min(1, h/ht) : 1);
  setFill('#trkC', ct ? Math.min(1, c/ct) : 1);

  const allMet = (!!prog?.next_code) && (!mt || m>=mt) && (!ht || h>=ht) && (!ct || c>=ct);
  const btn = $('#btnPromote');
  btn.disabled = !allMet;
  btn.classList.toggle('pulse', allMet);
  $('#note').textContent = !prog?.next_code
    ? 'You are at the highest rank or next rank is not configured.'
    : allMet ? 'All requirements met. You can request promotion.'
             : 'Promotion is available when all targets are met.';
}

/* History timeline */
async function loadHistory(){
  const { data, error } = await sb
    .from('rank_changes')
    .select('from_rank_code,to_rank_code,changed_by,created_at,reason')
    .eq('user_id', me)
    .order('created_at', { ascending:false })
    .limit(16);

  const host = $('#history');
  if(error){ host.innerHTML = '<div class="small">Failed to load history.</div>'; return; }
  if(!data?.length){ host.innerHTML = '<div class="small">No changes yet.</div>'; return; }

  host.innerHTML = data.map(r=>{
    const when = new Date(r.created_at).toLocaleString();
    const who  = r.changed_by?.slice(0,8) || 'system';
    const from = r.from_rank_code || 'â€”';
    const to   = r.to_rank_code || 'â€”';
    const why  = r.reason ? ` â€” <span class="small">${r.reason}</span>` : '';
    return `<div class="ti">
              <div class="when">${when}</div>
              <div class="chg">${from} <span style="color:var(--accent)">â†’</span> <b>${to}</b> â€¢ by ${who}${why}</div>
            </div>`;
  }).join('');
}

/* ===== Badge Case =====
   We render rows of slots. Each certification gets one slot.
   Owned => .owned glow; Not owned => .locked with a small lock chip.
*/
function groupIntoShelves(items, perRow = 6){
  const rows = [];
  for(let i=0;i<items.length;i+=perRow) rows.push(items.slice(i, i+perRow));
  return rows;
}
function renderBadgeCase(rows){
  const host = $('#caseShelves');
  if(!rows.length){ host.innerHTML = '<div class="small">No certifications configured.</div>'; return; }

  host.innerHTML = rows.map(row=>{
    const slots = row.map(r=>{
      const owned = !!r.owned;
      const img   = r.image_url || '';
      const code  = r.certification_code || '';
      const name  = r.name || code || 'Certification';
      const cls   = `slot ${owned?'owned':'locked'}`;
      return `
        <div class="slot-wrap">
          <div class="${cls}" title="${owned?'Obtained':'Not earned'}">
            <div class="img-wrap">${img?`<img src="${img}" alt="${name}">`:''}</div>
            ${owned?'':'<div class="lock">ðŸ”’</div>'}
          </div>
          <div class="label"><span class="name">${name}</span><span class="code">${code}</span></div>
        </div>`;
    }).join('');
    return `<div class="shelf">${slots}</div>`;
  }).join('');
}

/* Load certifications -> Badge Case */
async function loadCerts(){
  const { data, error } = await sb
    .from('v_user_certifications')
    .select('certification_code,name,image_url,owned,sort_order,user_id')
    .or(`user_id.eq.${me},user_id.is.null`)
    .order('sort_order', { ascending:true });

  if (error){ renderBadgeCase([]); return; }
  const rows = groupIntoShelves(data || [], 6);
  renderBadgeCase(rows);
}

/* Promotion */
async function promote(){
  const { data, error } = await sb.rpc('request_promotion', { p_user: me });
  if(error){ alert('Promotion failed: ' + error.message); return; }
  if(!data?.ok){ alert(data?.message || 'Not eligible.'); return; }
  alert('Promoted to ' + (data.to || 'next rank') + '!');
  await loadProgress(); await loadHistory();
}

/* Boot */
document.addEventListener('DOMContentLoaded', async ()=>{
  session = await requireAuth();
  if(!session) return;
  sb = getSupabase();
  me = session.user.id;

  $('#btnPromote').onclick = promote;

  await loadProgress();
  await loadHistory();
  await loadCerts();
});
</script>
</body>
</html>