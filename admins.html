<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>JMBN ‚Äì Admin Console</title>

<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png">

<style>
:root{
  --bg:#000; --panel:#0b0b0b; --sub:#0f0f0f; --row:#0a0a0a;
  --border:#d6b44c; --accent:#f2d675; --text:#f7f1d0; --muted:#c9b06a; --bad:#ff6b6b; --ok:#5cd47c;
  --fs:14px;
}
*{box-sizing:border-box}
html,body{margin:0;background:#000;color:var(--text);font-family:'Play',system-ui,sans-serif;font-size:var(--fs)}

/* Fallback header */
.brand{display:flex;align-items:center;gap:10px;margin:12px 16px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.brand img{width:44px;height:44px;object-fit:contain}
.brand h1{margin:0;color:var(--accent);font-size:22px}

.wrap{max-width:1200px;margin:0 auto;padding:0 16px 40px}
.grid{display:grid;grid-template-columns:340px 1fr;gap:16px}
@media(max-width:980px){.grid{grid-template-columns:1fr}}

.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:0 0 18px rgba(214,180,76,.18)}
.panel .hd{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border)}
.panel .hd h3{margin:0;color:var(--accent);font-size:16px}
.panel .body{padding:12px}

input[type="search"],select{
  width:100%;background:#0a0a0a;border:1px solid var(--border);border-radius:8px;padding:9px;color:var(--text);font-family:'Play'
}
button{
  padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);cursor:pointer;font-family:'Play'
}
button:hover{background:var(--accent);color:#000}
.pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;background:#121212;color:var(--accent)}
.btn-danger{border-color:var(--bad);color:var(--bad)}
.btn-ok{border-color:var(--ok);color:var(--ok)}

/* Members list */
.mlist{display:flex;flex-direction:column;gap:8px;max-height:70vh;overflow:auto}
.mrow{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:8px;border:1px solid transparent;border-radius:10px;background:#0a0a0a;cursor:pointer}
.mrow:hover{background:#111;border-color:rgba(214,180,76,.35)}
.mrow.active{background:rgba(214,180,76,.12);border-color:var(--border)}
.mavatar{width:38px;height:38px;border:1px solid var(--border);border-radius:8px;background:#111;display:grid;place-items:center;overflow:hidden}

/* KPIs + bars */
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.kpi{background:#0c0c0c;border:1px solid var(--border);border-radius:12px;padding:10px;text-align:center}
.kpi h4{margin:0 0 6px;color:var(--muted);font-size:11px;text-transform:uppercase}
.kpi .val{font-size:18px;font-weight:700;color:var(--accent)}
.pb{display:grid;grid-template-columns:120px 1fr auto;gap:10px;align-items:center;margin:6px 0}
.pb .label{color:var(--muted);font-size:12px}
.bar{height:12px;background:#0a0a0a;border:1px solid var(--border);border-radius:999px;overflow:hidden}
.fill{height:100%;background:linear-gradient(180deg,var(--accent),#d6b44c)}
.pb .val{font-variant-numeric:tabular-nums;color:var(--muted);font-size:12px}

/* Certifications grid ‚Äî smaller images */
.certGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.cert{background:#0a0a0a;border:1px solid var(--border);border-radius:12px;padding:10px}
.cert .thumb{height:120px;border:1px solid var(--border);border-radius:10px;background:#101010;display:grid;place-items:center;margin-bottom:8px;padding:8px}
.cert .thumb img{width:auto;max-width:110px;max-height:100%;object-fit:contain}
.cert .title{font-weight:700}
.cert.dim{opacity:.6;filter:grayscale(.5)}
.small{font-size:12px;color:var(--muted)}

/* Timeline */
.timeline{position:relative;margin-top:10px;padding-left:24px}
.timeline::before{content:"";position:absolute;left:10px;top:0;bottom:0;width:2px;background:linear-gradient(var(--border),transparent)}
.titem{position:relative;padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.06);display:grid;grid-template-columns:1fr auto;gap:10px}
.tdot{position:absolute;left:6px;top:16px;width:10px;height:10px;border-radius:50%;background:#222;border:2px solid var(--border)}
.titem.done .tdot{background:var(--border)}
.tlabel{font-weight:700}
</style>
</head>
<body>

<!-- Header mount -->
<div id="header-container">
  <div class="brand"><img src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" alt=""><h1>JMBN Admin Console</h1></div>
</div>
<script>
(async()=>{try{
  const r=await fetch('header.html',{cache:'no-cache'});
  if(r.ok){document.getElementById('header-container').outerHTML=await r.text();}
}catch{}})();
</script>

<div class="wrap">
  <div class="grid">

    <!-- LEFT -->
    <div class="panel">
      <div class="hd"><h3>Members</h3></div>
      <div class="body">
        <input id="mSearch" type="search" placeholder="Search handle / name‚Ä¶">
        <div id="mList" class="mlist" style="margin-top:8px">Loading‚Ä¶</div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="panel">
      <div class="hd">
        <h3>Inspector</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="rankTrack" title="Rank Track">
            <option value="">‚Äî Track ‚Äî</option>
            <option value="Officer">Officer</option>
            <option value="Enlisted">Enlisted</option>
            <option value="Warrant">Warrant</option>
          </select>
          <button id="btnForce" class="pill" title="Force set user's rank track">Force Set Track</button>

          <select id="rankCode" title="Rank Code">
            <option value="">‚Äî Select Rank ‚Äî</option>
          </select>
          <button id="btnSetRank" class="pill" title="Force set a specific rank code">Set Rank</button>

          <button id="btnPromote" class="pill" disabled>Run Promotion Check</button>
        </div>
      </div>

      <div class="body" id="inspector">
        <div class="small">Select a member to view and edit their progression & certifications.</div>
      </div>
    </div>

  </div>
</div>

<!-- libs -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
const $ = s => document.querySelector(s);
const esc = s => { const d=document.createElement('div'); d.textContent=s??''; return d.innerHTML; };
const setFill=(el,p)=>{const x=Math.max(0,Math.min(1,Number(p)||0));el.style.width=(x*100)+'%';};

let sb, me, isElev=false, MEMBERS=[], SELECTED=null, RANKS=[];

/* Boot */
document.addEventListener('DOMContentLoaded', async ()=>{
  const session = await requireAuth(); if(!session) return;
  sb = getSupabase(); me = session.user.id;

  try{ const { data } = await sb.rpc('is_elevated',{ u: me }); isElev = data===true; }catch{}
  if(!isElev){ $('#inspector').innerHTML='<div class="small" style="color:#ff6b6b">Access denied ‚Äî not elevated.</div>'; return; }

  await loadMembers();
  await loadRankOptions();

  $('#mSearch').oninput = renderMembers;
  $('#rankTrack').onchange = e => loadRankOptions(e.target.value);

  $('#btnForce').onclick = async ()=>{
    if(!SELECTED) return alert('Select a member first.');
    const track=$('#rankTrack').value; if(!track) return alert('Choose a track.');
    if(!confirm(`Force set ${SELECTED.handle||SELECTED.display_name||SELECTED.user_id.slice(0,8)} to ${track}?`)) return;
    const { error } = await sb.rpc('set_rank_track',{ p_user: SELECTED.user_id, p_track: track });
    if(error) return alert('Force set failed: '+error.message);
    alert('Track updated ‚úì'); await openMember(SELECTED.user_id); await loadMembers();
  };

  $('#btnSetRank').onclick = async ()=>{
    if(!SELECTED) return alert('Select a member first.');
    const code=$('#rankCode').value; if(!code) return alert('Choose a rank.');
    if(!confirm(`Force set ${SELECTED.handle||SELECTED.display_name||SELECTED.user_id.slice(0,8)} to ${code}?`)) return;
    const { error } = await sb.rpc('set_rank_code',{ p_user: SELECTED.user_id, p_code: code });
    if(error) return alert('Set rank failed: '+error.message);
    alert('Rank updated ‚úì'); await openMember(SELECTED.user_id); await loadMembers();
  };

  $('#btnPromote').onclick = async ()=>{
    if(!SELECTED) return;
    const { data, error } = await sb.rpc('request_promotion',{ p_user: SELECTED.user_id });
    if(error) return alert('Promotion failed: '+error.message);
    alert(data?.message || (data?.ok?'Promotion OK':'Not eligible yet'));
    await openMember(SELECTED.user_id);
  };
});

/* Ranks dropdown */
async function loadRankOptions(track=''){
  if(!RANKS.length){
    const { data, error } = await sb.from('ranks').select('code,name,category,sort_order').order('sort_order');
    if(error){ console.warn(error.message); return; }
    RANKS=data||[];
  }
  const want = (track||$('#rankTrack').value||'').toLowerCase();
  const items = RANKS.filter(r=>!want || (r.category||'').toLowerCase()===want);
  const sel = $('#rankCode');
  sel.innerHTML = '<option value="">‚Äî Select Rank ‚Äî</option>' +
    items.map(r=>`<option value="${r.code}">${r.code} ‚Äî ${esc(r.name)}</option>`).join('');
}

/* Members list */
async function loadMembers(){
  const { data, error } = await sb.from('v_profiles_detailed').select(`
    user_id,handle,display_name,
    current_rank_category,current_rank_name,current_rank_code,current_rank_image_url
  `).order('handle');

  if(error){ $('#mList').textContent='Failed to load members: '+error.message; return; }
  MEMBERS=data||[]; renderMembers();
}
function renderMembers(){
  const q=($('#mSearch').value||'').toLowerCase().trim();
  const list=$('#mList');
  const rows=q?MEMBERS.filter(m=>(`${m.handle} ${m.display_name}`).toLowerCase().includes(q)):MEMBERS;
  if(!rows.length){ list.textContent='No matches.'; return; }
  list.innerHTML='';
  rows.forEach(m=>{
    const row=document.createElement('div'); row.className='mrow';
    row.innerHTML=`
      <div class="mavatar">${m.current_rank_image_url?`<img src="${esc(m.current_rank_image_url)}" style="width:100%;height:100%;object-fit:contain">`:'üë§'}</div>
      <div>
        <div><b>${esc(m.handle||'(no handle)')}</b> <span class="small">‚Ä¢ ${esc(m.display_name||'')}</span></div>
        <div class="small">${esc(m.current_rank_category||'Unrated')} ‚Äî ${esc(m.current_rank_name||'Unrated')}</div>
      </div>
      <div><button class="pill">Open</button></div>`;
    row.querySelector('button').onclick=()=>openMember(m.user_id,row);
    list.appendChild(row);
  });
}
function markActive(row){document.querySelectorAll('.mrow').forEach(x=>x.classList.remove('active'));row?.classList.add('active');}

/* Inspector */
async function openMember(userId,rowEl){
  const res=MEMBERS.find(x=>x.user_id===userId); if(!res) return;
  SELECTED=res; markActive(rowEl); $('#btnPromote').disabled=false;

  // preselect UI
  $('#rankTrack').value=res.current_rank_category||'';
  await loadRankOptions(res.current_rank_category||'');
  if(res.current_rank_code) $('#rankCode').value = res.current_rank_code;

  // Full inspector UI (summary + KPIs + bars + Certs + Timeline)
  $('#inspector').innerHTML = `
    <div id="summary"></div>

    <div class="kpis" style="margin:10px 0">
      <div class="kpi"><h4>Total Missions</h4><div class="val" id="k_mis">‚Äî</div></div>
      <div class="kpi"><h4>Total Hours</h4><div class="val" id="k_hrs">‚Äî</div></div>
      <div class="kpi"><h4>Owned Certs</h4><div class="val" id="k_cer">‚Äî</div></div>
    </div>

    <div class="pb"><div class="label">Missions</div><div class="bar"><div id="pbMis" class="fill" style="width:0%"></div></div><div class="val" id="vMis">‚Äî</div></div>
    <div class="pb"><div class="label">Hours</div><div class="bar"><div id="pbHrs" class="fill" style="width:0%"></div></div><div class="val" id="vHrs">‚Äî</div></div>
    <div class="pb"><div class="label">Certifications</div><div class="bar"><div id="pbCer" class="fill" style="width:0%"></div></div><div class="val" id="vCer">‚Äî</div></div>

    <div class="panel" style="margin-top:12px">
      <div class="hd"><h3>Certifications</h3></div>
      <div class="body"><div id="certGrid" class="certGrid">Loading‚Ä¶</div></div>
    </div>

    <div class="panel" style="margin-top:12px">
      <div class="hd">
        <h3>Certification Timeline</h3>
        <div>
          <select id="certSelect"></select>
          <button id="btnReloadTL">Load</button>
        </div>
      </div>
      <div class="body">
        <div id="tlHint" class="small">Pick a certification to manage completions.</div>
        <div id="timeline" class="timeline" style="margin-top:8px"></div>
      </div>
    </div>
  `;

  await Promise.all([loadProgress(userId), loadCerts(userId)]);
}

/* Progress */
async function loadProgress(uid){
  const [{ data: prog }, { data: up }] = await Promise.all([
    sb.from('v_user_rank_progress').select('*').eq('user_id', uid).maybeSingle(),
    sb.from('v_user_progress').select('*').eq('user_id', uid).maybeSingle()
  ]);

  const cur = esc(prog?.current_name||'(unranked)');
  const curPg = esc(prog?.current_paygrade||'‚Äî');
  const nxt = esc(prog?.next_name||'‚Äî');
  const nxtPg = esc(prog?.next_paygrade||'‚Äî');

  $('#summary').innerHTML = `
    <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
      <div>
        <div><b>Current:</b> <span style="color:var(--accent)">${cur}</span> <span class="pill">PG: ${curPg}</span></div>
        <div class="small">Next: ${nxt} <span class="pill">PG: ${nxtPg}</span></div>
      </div>
      <div class="small">Targets ‚Ä¢ M:${prog?.missions_target??0} ‚Ä¢ H:${prog?.hours_target??0} ‚Ä¢ C:${prog?.certification_target??0}</div>
    </div>`;

  const m=Number(up?.missions_attended||0), h=Number(up?.hours_total||0), c=Number(up?.certifications_total||0);
  const mt=Number(prog?.missions_target||0), ht=Number(prog?.hours_target||0), ct=Number(prog?.certification_target||0);

  $('#k_mis').textContent=String(m);
  $('#k_hrs').textContent=String(h);
  $('#k_cer').textContent=String(c);

  $('#vMis').textContent=`${m} / ${mt}`;
  $('#vHrs').textContent=`${h} / ${ht}`;
  $('#vCer').textContent=`${c} / ${ct}`;

  setFill($('#pbMis'), mt?Math.min(1,m/mt):1);
  setFill($('#pbHrs'), ht?Math.min(1,h/ht):1);
  setFill($('#pbCer'), ct?Math.min(1,c/ct):1);
}

/* Certifications (grid + timeline) */
async function loadCerts(uid){
  const [{ data: catalog }, { data: mine }, { data: reqs }] = await Promise.all([
    sb.from('certifications').select('certification_code,name,image_url,sort_order,is_active').order('sort_order'),
    sb.from('user_certifications').select('certification_code').eq('user_id', uid),
    sb.from('certification_requirements').select('certification_code,event_code')
  ]);

  const owned = new Set((mine||[]).map(x=>x.certification_code));
  const byCert = new Map();
  (reqs||[]).forEach(r=>{
    if(!byCert.has(r.certification_code)) byCert.set(r.certification_code,[]);
    byCert.get(r.certification_code).push(r.event_code);
  });

  const grid=$('#certGrid'); grid.innerHTML='';
  const select=$('#certSelect'); select.innerHTML='';

  (catalog||[]).forEach(c=>{
    const div=document.createElement('div');
    div.className='cert'+(owned.has(c.certification_code)?'':' dim');
    div.innerHTML=`
      <div class="thumb">${c.image_url?`<img src="${esc(c.image_url)}" alt="">`:'üèÖ'}</div>
      <div class="title">${esc(c.name)}</div>
      <div class="small">${esc(c.certification_code)}${c.is_active===false?' ‚Ä¢ (Inactive)':''}</div>
      <div class="small">Reqs: ${byCert.get(c.certification_code)?.length ?? 0}</div>
      <div style="margin-top:8px"><button class="pill" data-open="${c.certification_code}">Open Timeline</button></div>
    `;
    div.querySelector('button').onclick=()=>{
      select.value=c.certification_code;
      loadTimeline(uid,c.certification_code);
      $('#tlHint').textContent=c.name;
    };
    grid.appendChild(div);

    const opt=document.createElement('option');
    opt.value=c.certification_code; opt.textContent=`${c.certification_code} ‚Äî ${c.name}`;
    select.appendChild(opt);
  });

  $('#btnReloadTL').onclick = ()=> loadTimeline(uid, select.value);
}

async function loadTimeline(uid, certCode){
  const tl=$('#timeline'); tl.innerHTML='';
  if(!certCode){ tl.innerHTML='<div class="small">Pick a certification.</div>'; return; }

  const [{ data: reqs }, { data: recs }] = await Promise.all([
    sb.from('certification_requirements')
      .select('event_code, sort_order, training_events(title, description)')
      .eq('certification_code', certCode)
      .order('sort_order'),
    sb.from('user_training_events')
      .select('event_code, completed_at, approved_by, approved_at')
      .eq('user_id', uid)
  ]);
  const done=new Map((recs||[]).map(r=>[r.event_code,r]));

  if(!reqs?.length){ tl.innerHTML='<div class="small">No requirements configured.</div>'; return; }

  reqs.forEach(r=>{
    const rec=done.get(r.event_code); const ok=!!rec;
    const row=document.createElement('div'); row.className='titem'+(ok?' done':'');
    row.innerHTML=`
      <div class="tdot"></div>
      <div>
        <div class="tlabel">${esc(r.training_events?.title||r.event_code)}</div>
        <div class="small">${esc(r.training_events?.description||'')}</div>
        ${ok?`<div class="small">Completed: ${new Date(rec.approved_at||rec.completed_at).toLocaleString()}${rec.approved_by?` ‚Ä¢ by ${esc(rec.approved_by.slice(0,8))}`:''}</div>`:''}
      </div>
      <div>
        ${ok?`<button class="btn-danger" data-remove="${r.event_code}">Remove</button>`
            :`<button class="btn-ok" data-add="${r.event_code}">Grant</button>`}
      </div>`;
    tl.appendChild(row);
  });

  tl.querySelectorAll('button[data-add]').forEach(b=>{
    b.onclick=async ()=>{
      const { error } = await sb.from('user_training_events').insert({
        user_id: uid, event_code: b.dataset.add, completed_at: new Date().toISOString()
      });
      if(error) return alert('Grant failed: '+error.message);
      await Promise.all([loadTimeline(uid,certCode),loadProgress(uid)]);
    };
  });
  tl.querySelectorAll('button[data-remove]').forEach(b=>{
    b.onclick=async ()=>{
      const { error } = await sb.from('user_training_events')
        .delete().eq('user_id',uid).eq('event_code',b.dataset.remove);
      if(error) return alert('Remove failed: '+error.message);
      await Promise.all([loadTimeline(uid,certCode),loadProgress(uid)]);
    };
  });
}
</script>
</body>
</html>
