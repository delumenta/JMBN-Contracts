<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JMBN Org Hub</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">
<style>
:root{
  --bg:#000; --panel:#0b0b0b; --card:#0c0c0c; --border:#d6b44c;
  --accent:#f2d675; --text:#f7f1d0; --muted:#c9b06a; --bad:#ff6b6b;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--text); background:#000; font-family:'Play',system-ui,sans-serif;
}

/* Background layers (starfield compatible) */
#goldDust{position:fixed;inset:0;z-index:0;width:100%;height:100%;pointer-events:none;background:#000}
.hud-grid{
  position:fixed;inset:0;z-index:1;pointer-events:none;
  background-image:
    linear-gradient(rgba(255,230,150,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,230,150,0.03) 1px, transparent 1px);
  background-size:80px 80px; animation:drift 80s linear infinite;
}
@keyframes drift{from{background-position:0 0} to{background-position:-200px -200px}}
body::after{
  content:""; position:fixed; inset:0; z-index:2; pointer-events:none;
  background:
    radial-gradient(1200px 800px at 50% 45%, rgba(0,0,0,0) 35%, rgba(0,0,0,.45) 70%, rgba(0,0,0,.75) 100%),
    linear-gradient(to bottom, rgba(0,0,0,.25), rgba(0,0,0,.55));
}

/* Layout */
.wrapper{position:relative; z-index:3; min-height:100%; padding:22px}
.center{width:min(1180px,96vw); margin-inline:auto}

/* Brand */
.brand{display:flex; align-items:center; gap:12px; margin-bottom:12px}
.brand-logo{width:56px; height:56px; object-fit:contain; filter:drop-shadow(0 0 8px rgba(242,214,117,.35))}
.brand h1{margin:0; font-size:clamp(22px,3.6vw,36px); color:var(--accent); font-weight:700}
.tagline{color:var(--muted); font-size:13px; margin-top:2px}

/* Cards */
.card{
  background:rgba(11,11,11,.9);
  border:1px solid var(--border); border-radius:14px; padding:14px;
  box-shadow:0 0 18px rgba(214,180,76,.18), inset 0 0 0 1px rgba(214,180,76,.12);
  backdrop-filter: blur(6px) brightness(1.1) saturate(1.05);
  position:relative; overflow:hidden;
}
.card::after{
  content:""; position:absolute; inset:0; border-radius:14px;
  background:linear-gradient(120deg, rgba(255,255,255,0) 30%, rgba(255,255,255,0.16) 50%, rgba(255,255,255,0) 70%);
  transform:translateX(-100%); transition:transform .6s ease; pointer-events:none;
}
.card:hover::after{transform:translateX(100%)}

/* Member Holo ID */
.member{
  display:grid; grid-template-columns:1fr 130px; gap:14px; align-items:center; margin-bottom:14px;
}
.member .name{font-weight:900; font-size:20px; color:var(--accent)}
.badge{border:1px solid var(--border); border-radius:999px; padding:4px 10px; font-size:12px; background:#0c0c0c; color:var(--muted)}
.rankline{display:flex; flex-wrap:wrap; align-items:center; gap:8px; font-size:14px; margin-top:6px}
.rankimg{width:120px; height:120px; object-fit:contain; border-radius:10px; border:1px solid var(--border); background:#0c0c0c; display:block; justify-self:end}
.small{font-size:12px; color:var(--muted); margin-top:4px}

/* Grid */
.grid{display:grid; grid-template-columns:2fr 1fr; gap:14px}
@media(max-width:980px){.grid{grid-template-columns:1fr}}

/* KPI row */
.kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:14px}
.kpi{
  background:#0a0a0a; border:1px solid var(--border); border-radius:12px; padding:12px;
  display:flex; flex-direction:column; gap:6px; align-items:flex-start;
}
.kpi .lbl{color:var(--muted); font-size:12px}
.kpi .val{font-size:22px; font-weight:900; color:var(--accent)}
.kpi .sub{font-size:12px; color:var(--muted)}
.kpi.good .val{color:#a0f0c0}
.kpi.warn .val{color:#ffe08a}
.kpi.bad .val{color:#ff9c9c}

/* Lists */
.list{display:flex; flex-direction:column; gap:8px; margin-top:6px}
.item{border:1px solid var(--border); border-radius:10px; padding:10px; background:#0f0f0f}
.item h4{margin:0 0 4px; color:var(--accent); font-size:15px}
.item .meta{font-size:12px; color:var(--muted)}
.empty{color:var(--muted); font-size:13px; padding:10px}

/* Section headers */
.hsec{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
.hsec h3{margin:0; color:var(--accent); font-size:16px}
.btn{
  padding:7px 11px; border-radius:10px; background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent); border:1px solid var(--border); cursor:pointer; font-family:'Play';
}
.btn:hover{background:var(--accent); color:#000}
.link{color:var(--accent); text-decoration:none; font-weight:700}

/* Footer */
.footer{color:var(--muted); font-size:12px; margin-top:16px; text-align:center}
</style>
</head>
<body>

<canvas id="goldDust"></canvas>
<div class="hud-grid"></div>

<div class="wrapper">
  <main class="center">
    <!-- Brand -->
    <div class="brand">
      <img class="brand-logo" alt="JMBN"
        src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png/v1/fill/w_66,h_66,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/0_New_JMBN_Logo_Gold.png">
      <div>
        <h1>JMBN Org Hub</h1>
        <div class="tagline">Hilarity • Immersion • Teamwork</div>
      </div>
    </div>

    <!-- Member ID -->
    <section class="card member" id="memberCard">
      <div>
        <div class="name" id="mName">Loading…</div>
        <div class="rankline">
          <span id="mRank">Unranked</span>
          <span class="badge" id="mCategory">—</span>
          <span class="badge" id="mRole">Member</span>
        </div>
        <div class="small" id="mEmail"></div>
      </div>
      <img id="mRankImg" class="rankimg" alt="Rank">
    </section>

    <!-- KPIs -->
    <section class="kpis">
      <div class="kpi" id="kpiMissions">
        <div class="lbl">Missions (Last 30d)</div>
        <div class="val">—</div>
        <div class="sub" id="kpiMissionsSub">Loading…</div>
      </div>
      <div class="kpi" id="kpiSuccess">
        <div class="lbl">Success Rate</div>
        <div class="val">—</div>
        <div class="sub">Success / (Success+Fail)</div>
      </div>
      <div class="kpi" id="kpiAttendance">
        <div class="lbl">Total Attendance (30d)</div>
        <div class="val">—</div>
        <div class="sub">All completed missions</div>
      </div>
    </section>

    <!-- Two-column content -->
    <section class="grid">
      <!-- Left: Ongoing Missions -->
      <div class="card">
        <div class="hsec">
          <h3>Ongoing Missions</h3>
          <div style="display:flex;gap:8px">
            <a class="btn" href="mission-log.html">Open Mission Log</a>
            <button class="btn" id="btnNewMission" style="display:none">+ New Mission</button>
          </div>
        </div>
        <div id="ongoing" class="list"><div class="empty">Loading…</div></div>
      </div>

      <!-- Right: Announcements & Events -->
      <div style="display:flex; flex-direction:column; gap:14px">
        <div class="card">
          <div class="hsec">
            <h3>Announcements</h3>
            <a class="link" href="#" id="postAnnc" style="display:none">Post</a>
          </div>
          <div id="annc" class="list"><div class="empty">No announcements yet.</div></div>
        </div>

        <div class="card">
          <div class="hsec">
            <h3>Upcoming Events</h3>
            <a class="link" href="#" id="addEvent" style="display:none">Add</a>
          </div>
          <div id="events" class="list"><div class="empty">No events scheduled.</div></div>
        </div>
      </div>
    </section>

    <div class="footer">Theme: Play • Gold · Links are relative (GitHub Pages ready)</div>
  </main>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
/* ========= Tiny helpers ========= */
const $ = s => document.querySelector(s);
const esc = s => { const d=document.createElement('div'); d.textContent = s ?? ''; return d.innerHTML; };

/* ========= Starfield (minimal) ========= */
(function(){
  const c=document.getElementById('goldDust'),ctx=c.getContext('2d',{alpha:true});
  let W,H,DPR=Math.min(devicePixelRatio||1,2), stars=[];
  function resize(){W=c.width=innerWidth*DPR; H=c.height=innerHeight*DPR; c.style.width=innerWidth+'px'; c.style.height=innerHeight+'px';}
  resize(); addEventListener('resize',resize);
  for(let i=0;i<700;i++) stars.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.4+.2});
  (function draw(){
    ctx.clearRect(0,0,W,H);
    ctx.globalCompositeOperation='lighter';
    ctx.fillStyle='rgba(242,214,117,.8)';
    for(const s of stars){ ctx.beginPath(); ctx.arc(s.x,s.y,s.r,0,6.283); ctx.fill(); }
    requestAnimationFrame(draw);
  })();
})();

/* ========= Main loader ========= */
(async () => {
  const session = await requireAuth(); if(!session) return;
  const sb = getSupabase();

  // 1) Member card from v_profiles_detailed
  let me = {};
  try {
    const { data, error } = await sb
      .from('v_profiles_detailed')
      .select('handle, display_name, current_rank_name, current_rank_code, current_rank_image_url, current_rank_category, ingame_role')
      .eq('user_id', session.user.id)
      .maybeSingle();
    if (error) throw error; me = data||{};
  } catch (e){ console.warn('member view:', e.message); }

  const handle = me.handle || me.display_name || (session.user.email||'').split('@')[0] || 'Pilot';
  const prettyHandle = handle ? handle.charAt(0).toUpperCase() + handle.slice(1) : 'Pilot';
  $('#mName').textContent = prettyHandle;
  $('#mRank').textContent = me.current_rank_code ? `${me.current_rank_name || 'Unranked'} (${me.current_rank_code})` : (me.current_rank_name || 'Unranked');
  $('#mCategory').textContent = me.current_rank_category || '—';
  $('#mRole').textContent = me.ingame_role || 'Member';
  $('#mEmail').textContent = session.user.email || '';

  const rankImg = me.current_rank_image_url || ( me.current_rank_code
     ? sb.storage.from('Ranks').getPublicUrl(`${me.current_rank_code}.png`).data.publicUrl
     : '' );
  if (rankImg) { const img=$('#mRankImg'); img.src=rankImg; img.alt=me.current_rank_name||'Rank'; }

  // 2) Officer tools: show if elevated
  let elevated=false;
  try{
    const { data, error } = await sb.rpc('is_elevated', { u: session.user.id });
    if(!error && data===true) elevated=true;
  }catch(e){}
  if (elevated) {
    $('#btnNewMission').style.display='';
    $('#postAnnc').style.display='';
    $('#addEvent').style.display='';
  }

  // 3) KPIs (last 30 days)
  const since = new Date(); since.setDate(since.getDate()-30);
  const toISO = d => new Date(d).toISOString();

  // total missions
  let total=0, succ=0, fail=0, attended=0;
  try{
    const { data, error } = await sb
      .from('missions')
      .select('status, attendees')
      .gte('start_time', toISO(since));
    if (error) throw error;
    total = data.length;
    for(const m of data){
      if (m.status === 'Success') succ++;
      if (m.status === 'Fail') fail++;
      // attendees: if you store comma-separated names
      if (m.attendees) {
        const n = String(m.attendees).split(',').map(s=>s.trim()).filter(Boolean).length;
        attended += n;
      }
    }
  } catch(e){ console.warn('kpi missions:', e.message); }

  // render kpis
  (function(){
    const k1 = $('#kpiMissions'); k1.querySelector('.val').textContent = total;
    k1.querySelector('.sub').textContent = `Since ${since.toLocaleDateString()}`;
    const rate = (succ+fail) ? Math.round((succ/(succ+fail))*100) : 0;
    const k2 = $('#kpiSuccess'); k2.querySelector('.val').textContent = (succ+fail)? `${rate}%` : '—';
    k2.classList.toggle('good', rate>=70);
    k2.classList.toggle('warn', rate>0 && rate<70);
    k2.classList.toggle('bad', (succ+fail)>0 && rate<40);
    const k3 = $('#kpiAttendance'); k3.querySelector('.val').textContent = attended || '—';
  })();

  // 4) Ongoing missions (Planned/Active)
  async function loadOngoing(){
    const box = $('#ongoing'); box.innerHTML = '<div class="empty">Loading…</div>';
    try{
      const { data, error } = await sb
        .from('missions')
        .select('id, title, type, status, origin, destination, start_time, submitted_by')
        .in('status', ['Planned','Active'])
        .order('start_time', { ascending: true })
        .limit(12);
      if (error) throw error;
      if (!data.length) { box.innerHTML = '<div class="empty">No ongoing missions.</div>'; return; }
      box.innerHTML = data.map(m => `
        <div class="item">
          <h4>${esc(m.title||'Untitled')}</h4>
          <div class="meta">
            ${esc(m.type||'—')} • ${esc(m.status)} • ${esc(m.origin||'—')} → ${esc(m.destination||'—')}
            • ${m.start_time ? new Date(m.start_time).toLocaleString() : '—'}
          </div>
        </div>
      `).join('');
    }catch(e){
      box.innerHTML = `<div class="empty" style="color:var(--bad)">Failed: ${esc(e.message)}</div>`;
    }
  }
  loadOngoing();

  // 5) Announcements (latest 5)
  async function loadAnnouncements(){
    const box = $('#annc');
    try{
      const { data, error } = await sb
        .from('announcements')
        .select('id,title,body,created_at')
        .order('created_at', { ascending:false })
        .limit(5);
      if (error) throw error;
      if (!data.length) { box.innerHTML = '<div class="empty">No announcements yet.</div>'; return; }
      box.innerHTML = data.map(a => `
        <div class="item">
          <h4>${esc(a.title||'Announcement')}</h4>
          <div class="meta">${a.created_at ? new Date(a.created_at).toLocaleString() : ''}</div>
          ${a.body ? `<div class="small" style="margin-top:6px">${esc(a.body)}</div>` : ''}
        </div>
      `).join('');
    }catch(e){
      box.innerHTML = `<div class="empty" style="color:var(--bad)">Failed: ${esc(e.message)}</div>`;
    }
  }
  loadAnnouncements();

  // 6) Events (next 5)
  async function loadEvents(){
    const box = $('#events');
    try{
      const nowISO = new Date().toISOString();
      const { data, error } = await sb
        .from('events')
        .select('id,title,starts_at,location')
        .gte('starts_at', nowISO)
        .order('starts_at', { ascending:true })
        .limit(5);
      if (error) throw error;
      if (!data.length) { box.innerHTML = '<div class="empty">No events scheduled.</div>'; return; }
      box.innerHTML = data.map(e => `
        <div class="item">
          <h4>${esc(e.title)}</h4>
          <div class="meta">${new Date(e.starts_at).toLocaleString()}${e.location ? ' • '+esc(e.location) : ''}</div>
        </div>
      `).join('');
    }catch(e){
      box.innerHTML = `<div class="empty" style="color:var(--bad)">Failed: ${esc(e.message)}</div>`;
    }
  }
  loadEvents();

  // 7) Officer quick actions
  $('#btnNewMission').onclick = () => location.href = 'mission-editor.html';
  $('#postAnnc').onclick = async (ev) => {
    ev.preventDefault();
    const title = prompt('Announcement title?'); if (!title) return;
    const body  = prompt('Body (optional):') || null;
    try{
      const { error } = await sb.from('announcements').insert({ title, body });
      if (error) throw error; loadAnnouncements();
    }catch(e){ alert('Failed: '+e.message); }
  };
  $('#addEvent').onclick = async (ev) => {
    ev.preventDefault();
    const title = prompt('Event title?'); if (!title) return;
    const starts = prompt('Start time (YYYY-MM-DD HH:MM) local?'); if (!starts) return;
    const when = new Date(starts.replace(' ','T'));
    try{
      const { error } = await sb.from('events').insert({ title, starts_at: when.toISOString() });
      if (error) throw error; loadEvents();
    }catch(e){ alert('Failed: '+e.message); }
  };

})();
</script>
</body>
</html>