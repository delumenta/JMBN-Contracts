<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Mission Log</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png"
      href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png"
      sizes="32x32">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--border:#d6b44c;--card:#141414;
  --accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;
  --fs-base:14px;--fs-small:11px;--fs-table:13px;--fs-h1:clamp(18px,2.2vw,22px);
}
*{box-sizing:border-box}
body{
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text);
  font-family:'Play',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  margin:0;padding:14px;letter-spacing:.25px;font-size:var(--fs-base);
}

/* Header */
.brand{display:flex;align-items:center;gap:10px;margin:0 0 8px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.brand-logo{width:44px;height:44px;object-fit:contain;filter:drop-shadow(0 0 4px rgba(242,214,117,.25))}
.brand h1{font-weight:700;font-size:var(--fs-h1);color:var(--accent);margin:0}

/* Shiny nav */
.nav{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
.nav-btn{
  --gold:#f2d675;--gold2:#e7c760;--ring:#d6b44c;
  position:relative;display:inline-flex;align-items:center;justify-content:center;
  padding:7px 14px;border:1px solid var(--ring);border-radius:999px;
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);text-decoration:none;font-weight:700;
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.12);
  transition:transform .15s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
  overflow:hidden;
}
.nav-btn:hover{transform:translateY(-1px);box-shadow:0 0 12px rgba(214,180,76,.25), inset 0 0 0 1px rgba(214,180,76,.18);background:linear-gradient(180deg,#1a1a1a,#0a0a0a)}
.nav-btn.active{color:#000;background:linear-gradient(180deg,var(--gold),var(--gold2));border-color:var(--ring);box-shadow:0 0 20px rgba(214,180,76,.45)}
.nav-btn.active::after{content:"";position:absolute;inset:0;background:linear-gradient(120deg,rgba(255,255,255,0) 30%,rgba(255,255,255,.3) 50%,rgba(255,255,255,0) 70%);border-radius:inherit;transform:translateX(-120%);animation:shine 2.8s ease-in-out infinite;pointer-events:none}
@keyframes shine{0%{transform:translateX(-120%)}35%,100%{transform:translateX(120%)}}

/* Panels + controls */
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:8px;box-shadow:0 0 18px rgba(214,180,76,.22)}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
button,.small-btn{padding:7px 11px;border-radius:10px;background:linear-gradient(180deg,#0c0c0c,#060606);color:var(--accent);border:1px solid var(--border);cursor:pointer;font-family:'Play';transition:.2s}
button:hover,.small-btn:hover{background:var(--accent);color:#000}
.btn-primary{background:var(--accent);color:#000}
input,select{background:#0a0a0a;border:1px solid var(--border);border-radius:8px;padding:9px;color:var(--text);font-size:var(--fs-table);font-family:'Play'}
.small{font-size:var(--fs-small);color:var(--muted)}

/* KPI */
.kpis{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin:8px 0 6px}
@media(max-width:880px){.kpis{grid-template-columns:1fr}}
.kpi{background:linear-gradient(180deg,#0b0b0b,#080808);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:0 0 14px rgba(214,180,76,.18), inset 0 0 0 1px rgba(214,180,76,.12)}
.kpi-title{font-size:12px;color:var(--muted);margin-bottom:6px}
.kpi-value{font-size:22px;font-weight:700;color:var(--accent);line-height:1}
.kpi-sub{font-size:12px;color:var(--muted);margin-top:4px}

/* Table */
.tableWrap{border:1px solid var(--border);border-radius:12px;overflow:auto;max-height:70vh;margin-top:10px}
table{width:100%;border-collapse:collapse;font-size:var(--fs-table)}
th,td{border-bottom:1px solid rgba(214,180,76,.3);padding:8px;text-align:left;vertical-align:top}
th{color:var(--accent);background:#080808;font-weight:500}
tr:nth-child(even){background:#111}
tr:hover{background:rgba(214,180,76,.08)}
.pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px;color:var(--muted)}
.nowrap{white-space:nowrap}
.mono{font-variant-numeric:tabular-nums}

/* Attendance Modal */
.modal-mask{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
.modal{background:#0b0b0b;border:1px solid var(--border);border-radius:12px;max-width:760px;width:92vw;padding:14px;box-shadow:0 0 22px rgba(214,180,76,.25)}
.modal h3{margin:0 0 10px;color:var(--accent);font-size:16px}
.modal .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
.modal .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:6px 10px}
.modal .chip .x{cursor:pointer;border:1px solid var(--border);border-radius:6px;background:transparent;color:var(--muted);padding:0 6px}
.modal .chip .x:hover{background:#111;color:#ff6b6b}
.modal .list{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
  <!-- Header -->
  <div class="brand">
    <img class="brand-logo" src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png/v1/fill/w_66,h_66,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/0_New_JMBN_Logo_Gold.png" alt="JMBN">
    <h1>JMBN Mission Log</h1>
  </div>

  <!-- Nav -->
  <nav class="nav">
    <a class="nav-btn" href="index.html">Manifest</a>
    <a class="nav-btn" href="hangar.html">Hangar</a>
    <a class="nav-btn" href="components.html">Components</a>
    <a class="nav-btn" href="contracts.html">Contracts</a>
    <a class="nav-btn" href="mission-log.html">Mission Log</a>
  </nav>

  <div class="panel">
    <!-- Controls -->
    <div class="controls">
      <input id="search" placeholder="Search... (title, type, status, tags)">
      <select id="statusFilter">
        <option value="">All Status</option>
        <option>Draft</option>
        <option>In Progress</option>
        <option>Completed</option>
        <option>Aborted</option>
      </select>
      <button id="exportCsv">Export CSV</button>
    </div>

    <!-- KPI -->
    <div class="kpis">
      <div class="kpi">
        <div class="kpi-title">Total Missions</div>
        <div class="kpi-value" id="kpiCount">0</div>
        <div class="kpi-sub">after filters</div>
      </div>
      <div class="kpi">
        <div class="kpi-title">Total Payout (aUEC)</div>
        <div class="kpi-value" id="kpiTotal">0</div>
        <div class="kpi-sub">sum of payouts</div>
      </div>
    </div>

    <!-- Table -->
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Mission Title</th>
            <th>Type</th>
            <th>Status</th>
            <th>Origin</th>
            <th>Destination</th>
            <th class="nowrap">Date</th>
            <th class="nowrap">Hours</th>
            <th class="nowrap">Payout (aUEC)</th>
            <th>Tags</th>
            <th>Attachments</th>
            <th>Notes</th>
            <th class="nowrap">Attendance</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Attendance Modal -->
  <div id="attModalMask" class="modal-mask" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <h3 id="attTitle" style="margin-right:auto">Attendance</h3>
        <button class="small-btn" onclick="closeAttendance()">Close</button>
      </div>

      <div class="row">
        <button id="attIamGoing" class="small-btn">Iâ€™m going</button>
        <button id="attWithdraw" class="small-btn">Withdraw</button>
        <span class="small">These toggle <b>your</b> attendance.</span>
      </div>

      <div id="attElevatedTools" class="row" style="display:none">
        <input id="attAddEmail" placeholder="Add by email (crew@example.com)" style="flex:1;min-width:260px;background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:8px;color:var(--text)">
        <select id="attAddRole" style="background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:8px;color:var(--text)">
          <option value="">Role (optional)</option>
          <option>pilot</option><option>escort</option><option>hauler</option><option>miner</option><option>medic</option>
        </select>
        <button id="attAddBtn" class="small-btn">Add</button>
        <span class="small">Admin/Officer or mission owner can add/remove anyone.</span>
      </div>

      <div class="row">
        <strong class="small">Attendees:</strong>
        <div id="attList" class="list"></div>
      </div>
    </div>
  </div>

  <!-- ðŸ” Auth & shared client -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/auth.js"></script>

<script>
/* ===== Active nav highlight ===== */
(function(){
  const here = location.pathname.split('/').pop() || 'mission-log.html';
  document.querySelectorAll('.nav-btn').forEach(a=>{
    if(a.getAttribute('href')===here){ a.classList.add('active'); a.setAttribute('aria-current','page'); }
  });
})();

/* ===== Helpers ===== */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const esc=s=>{const d=document.createElement('div'); d.textContent=s??''; return d.innerHTML;};
const fmtDate=iso=>iso? new Date(iso).toLocaleString() : '';
const fmtNum=n=> (n||n===0) ? Number(n).toLocaleString() : '';

/* ===== State ===== */
let cache=[]; // all missions
let session=null, sb=null;
const tbody = $('#tbody');

/* ===== Render ===== */
function attachmentsCell(arr){
  if(!Array.isArray(arr)||!arr.length) return '';
  return arr.map((a,i)=>{
    const name = a?.name?.trim() || `Attachment ${i+1}`;
    const url  = a?.url || '#';
    return `<a href="${esc(url)}" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:underline">${esc(name)}</a>`;
  }).join(', ');
}
function row(r){
  return `<tr>
    <td><b style="color:var(--accent)">${esc(r.title||'(untitled)')}</b></td>
    <td>${r.type?`<span class="pill">${esc(r.type)}</span>`:''}</td>
    <td>${r.status?`<span class="pill">${esc(r.status)}</span>`:''}</td>
    <td>${esc(r.origin||'')}</td>
    <td>${esc(r.destination||'')}</td>
    <td class="nowrap mono">${fmtDate(r.start_time)}</td>
    <td class="mono">${r.hours ?? ''}</td>
    <td class="mono">${fmtNum(r.payout_auec)}</td>
    <td>${esc(r.tags||'')}</td>
    <td>${attachmentsCell(r.attachments)}</td>
    <td>${esc(r.notes||'')}</td>
    <td><button class="small-btn" onclick="openAttendance('${r.id}','${esc(r.title||'')}')">View</button></td>
  </tr>`;
}
function render(list){
  $('#kpiCount').textContent = (list||[]).length.toLocaleString();
  const total = (list||[]).reduce((s,x)=> s + (Number(x.payout_auec)||0), 0);
  $('#kpiTotal').textContent = total.toLocaleString();
  tbody.innerHTML = list.length ? list.map(row).join('') :
    `<tr><td colspan="13" class="small" style="padding:10px">No missions found.</td></tr>`;
}

/* ===== Filter + CSV ===== */
function getFiltered(){
  const q = ($('#search').value||'').toLowerCase();
  const st = ($('#statusFilter').value||'').toLowerCase();
  let arr = cache.slice();
  if(st) arr = arr.filter(x => (x.status||'').toLowerCase()===st);
  if(q) arr = arr.filter(x =>
    `${x.title||''} ${x.type||''} ${x.status||''} ${x.tags||''} ${x.origin||''} ${x.destination||''}`
    .toLowerCase().includes(q));
  return arr;
}
$('#search').addEventListener('input', ()=>render(getFiltered()));
$('#statusFilter').addEventListener('input', ()=>render(getFiltered()));

$('#exportCsv').addEventListener('click', ()=>{
  const rows = getFiltered();
  const cols = ['title','type','status','origin','destination','start_time','hours','payout_auec','tags','notes'];
  const csv = [
    cols.join(','),
    ...rows.map(r => cols.map(k=>{
      const v = r[k]==null?'':String(r[k]).replace(/"/g,'""');
      return `"${v}"`;
    }).join(','))
  ].join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download='missions.csv'; a.click(); URL.revokeObjectURL(url);
});

/* ===== Load (uses shared Supabase from auth.js) ===== */
async function loadMissions(){
  const { data, error } = await sb
    .from('missions')
    .select('id,title,type,status,origin,destination,start_time,hours,payout_auec,tags,attachments,notes,created_at')
    .order('created_at',{ascending:false});

  if(error){
    tbody.innerHTML = `<tr><td colspan="12" class="small" style="padding:10px">Failed to load missions: ${esc(error.message)}</td></tr>`;
    return;
  }
  cache = data || [];
  render(getFiltered());
}

/* ===== Attendance popup logic ===== */
let ATT_MISSION_ID = null;

async function openAttendance(missionId, title=''){
  ATT_MISSION_ID = missionId;
  $('#attTitle').textContent = `Attendance â€” ${title || missionId.slice(0,8)}`;
  $('#attModalMask').style.display = 'flex';

  // show elevated tools if admin/officer or mission owner
  const [{ data: elev }, { data: mission }] = await Promise.all([
    sb.rpc('is_elevated', { u: session.user.id }),
    sb.from('missions').select('submitted_by').eq('id', missionId).single()
  ]);
  const isOwner = mission?.submitted_by === session.user.id;
  $('#attElevatedTools').style.display = (elev || isOwner) ? 'flex' : 'none';

  $('#attIamGoing').onclick = async () => {
    await sb.from('mission_attendees').upsert({
      mission_id: ATT_MISSION_ID,
      user_id: session.user.id,
      attendance: 'going'
    }, { onConflict: 'mission_id,user_id' });
    await loadAttendees();
  };
  $('#attWithdraw').onclick = async () => {
    await sb.from('mission_attendees')
      .delete()
      .match({ mission_id: ATT_MISSION_ID, user_id: session.user.id });
    await loadAttendees();
  };
  $('#attAddBtn').onclick = async () => {
    const email = $('#attAddEmail').value.trim();
    const role  = $('#attAddRole').value || null;
    if(!email){ alert('Enter an email'); return; }
    const { error } = await sb.rpc('add_attendee_by_email', {
      p_mission: ATT_MISSION_ID,
      p_email: email,
      p_role: role,
      p_attendance: 'going'
    });
    if(error){ alert('Add failed: ' + error.message); return; }
    $('#attAddEmail').value=''; $('#attAddRole').value='';
    await loadAttendees();
  };

  await loadAttendees();
}

function closeAttendance(){
  $('#attModalMask').style.display = 'none';
  ATT_MISSION_ID = null;
}
window.openAttendance = openAttendance;
window.closeAttendance = closeAttendance;

async function loadAttendees(){
  const list = $('#attList');
  list.innerHTML = '<span class="small">Loadingâ€¦</span>';

  const { data, error } = await sb
    .from('v_mission_attendees_detailed')
    .select('*')
    .eq('mission_id', ATT_MISSION_ID)
    .order('joined_at', { ascending: true });

  if(error){ list.innerHTML = `<span class="small" style="color:var(--bad)">Load failed: ${esc(error.message)}</span>`; return; }
  if(!data?.length){ list.innerHTML = '<span class="small">No attendees yet.</span>'; return; }

  // permission to remove others?
  const [{ data: elev }, { data: mission }] = await Promise.all([
    sb.rpc('is_elevated', { u: session.user.id }),
    sb.from('missions').select('submitted_by').eq('id', ATT_MISSION_ID).single()
  ]);
  const canManageAll = (elev || mission?.submitted_by === session.user.id);

  list.innerHTML = '';
  for(const a of data){
    const chip = document.createElement('div');
    chip.className = 'chip';
    chip.innerHTML = `
      <span>${esc(a.attendee_name || a.user_id.slice(0,8))}</span>
      <span class="small" style="color:var(--muted)">${a.role_in_mission ? 'â€¢ '+esc(a.role_in_mission)+' ' : ''}${esc(a.attendance||'')}</span>
      ${ (canManageAll || a.user_id === session.user.id) ? `<button class="x" title="Remove" data-uid="${a.user_id}">x</button>` : '' }
    `;
    const x = chip.querySelector('.x');
    if(x){
      x.onclick = async () => {
        const targetUser = x.getAttribute('data-uid');
        const { error: delErr } = await sb
          .from('mission_attendees')
          .delete()
          .match({ mission_id: ATT_MISSION_ID, user_id: targetUser });
        if(delErr){ alert('Remove failed: ' + delErr.message); return; }
        await loadAttendees();
      };
    }
    list.appendChild(chip);
  }
}

/* ===== Gate by auth, then load ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  session = await requireAuth();        // redirect to auth.html if not logged in
  if(!session) return;
  sb = getSupabase();
  loadMissions();
});
</script>
</body>
</html>
