<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Mission Log</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png"
      href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png"
      sizes="32x32">
<style>
:root{
  --bg:#000;--panel:#0b0b0b;--border:#d6b44c;--card:#141414;
  --accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;
  --fs-base:14px;--fs-small:11px;--fs-table:13px;--fs-h1:clamp(18px,2.2vw,22px);
}
*{box-sizing:border-box}
body{
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text);
  font-family:'Play',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  margin:0;padding:14px;letter-spacing:.25px;font-size:var(--fs-base);
}

/* Header */
.brand{
  display:flex;align-items:center;gap:10px;
  margin:0 0 8px;padding-bottom:6px;border-bottom:1px solid var(--border)
}
.brand-logo{width:44px;height:44px;object-fit:contain;filter:drop-shadow(0 0 4px rgba(242,214,117,.25))}
.brand h1{font-weight:700;font-size:var(--fs-h1);color:var(--accent);margin:0}

/* Shiny nav */
.nav{
  display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:6px 0 10px
}
.nav-btn{
  --gold:#f2d675;--gold2:#e7c760;--ring:#d6b44c;
  position:relative;display:inline-flex;align-items:center;justify-content:center;
  padding:7px 14px;border:1px solid var(--ring);border-radius:999px;
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);text-decoration:none;font-weight:700;
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.12);
  transition:transform .15s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
  overflow:hidden;
}
.nav-btn:hover{
  transform:translateY(-1px);
  box-shadow:0 0 12px rgba(214,180,76,.25), inset 0 0 0 1px rgba(214,180,76,.18);
  background:linear-gradient(180deg,#1a1a1a,#0a0a0a)
}
.nav-btn.active{
  color:#000;background:linear-gradient(180deg,var(--gold),var(--gold2));
  border-color:var(--ring);box-shadow:0 0 20px rgba(214,180,76,.45)
}
.nav-btn.active::after{
  content:"";position:absolute;inset:0;
  background:linear-gradient(120deg,rgba(255,255,255,0) 30%,rgba(255,255,255,.3) 50%,rgba(255,255,255,0) 70%);
  border-radius:inherit;transform:translateX(-120%);animation:shine 2.8s ease-in-out infinite;pointer-events:none;
}
@keyframes shine{0%{transform:translateX(-120%)}35%{transform:translateX(120%)}100%{transform:translateX(120%)}}

/* Panel + controls */
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:8px;box-shadow:0 0 18px rgba(214,180,76,.22)}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
button{padding:7px 11px;border-radius:10px;background:linear-gradient(180deg,#0c0c0c,#060606);color:var(--accent);border:1px solid var(--border);cursor:pointer;font-family:'Play';transition:.2s}
button:hover{background:var(--accent);color:#000}
.btn-primary{background:var(--accent);color:#000}
input,select,textarea{background:#0a0a0a;border:1px solid var(--border);border-radius:8px;padding:9px;color:var(--text);font-size:var(--fs-table);font-family:'Play'}
textarea{resize:vertical}
label{display:flex;flex-direction:column;gap:4px;font-size:13px;color:var(--muted)}
.small{font-size:var(--fs-small);color:var(--muted)}

/* KPI cards */
.kpis{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin:8px 0 6px}
@media(max-width:880px){.kpis{grid-template-columns:1fr}}
.kpi{
  background:linear-gradient(180deg,#0b0b0b,#080808);
  border:1px solid var(--border);border-radius:12px;padding:12px;
  box-shadow:0 0 14px rgba(214,180,76,.18), inset 0 0 0 1px rgba(214,180,76,.12)
}
.kpi-title{font-size:12px;color:var(--muted);margin-bottom:6px}
.kpi-value{font-size:22px;font-weight:700;color:var(--accent);line-height:1}
.kpi-sub{font-size:12px;color:var(--muted);margin-top:4px}

/* Table */
.tableWrap{border:1px solid var(--border);border-radius:12px;overflow:auto;max-height:70vh;margin-top:10px}
table{width:100%;border-collapse:collapse;font-size:var(--fs-table);min-width:1100px}
th,td{border-bottom:1px solid rgba(214,180,76,.3);padding:8px;text-align:left;vertical-align:top}
th{color:var(--accent);background:#080808;font-weight:500;font-size:12px;position:sticky;top:0;z-index:1}
tr:nth-child(even){background:#111}
tr:hover{background:rgba(214,180,76,.08)}
.pill{display:inline-block;padding:4px 10px;border:1px solid var(--border);border-radius:999px;color:var(--accent);font-size:12px;background:#090909}
.link{color:var(--accent);text-decoration:underline;cursor:pointer}
.nowrap{white-space:nowrap}
.mono{font-variant-numeric:tabular-nums}
</style>
</head>
<body>
  <!-- Header -->
  <div class="brand">
    <img class="brand-logo" src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png/v1/fill/w_66,h_66,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/0_New_JMBN_Logo_Gold.png" alt="JMBN">
    <h1>JMBN Mission Log</h1>
  </div>

  <!-- Nav -->
  <nav class="nav">
    <a class="nav-btn" href="index.html">Manifest</a>
    <a class="nav-btn" href="hangar.html">Hangar</a>
    <a class="nav-btn" href="components.html">Components</a>
    <a class="nav-btn" href="contracts.html">Contracts</a>
    <a class="nav-btn active" href="mission-log.html">Mission Log</a>
  </nav>

  <div class="panel">
    <!-- Controls -->
    <div class="controls">
      <input id="search" placeholder="Searchâ€¦ (title, type, status, tags, origin, destination)">
      <!-- (optional) quick status filter to mirror contracts style -->
      <select id="statusFilter" title="Filter by Status">
        <option value="">All Status</option>
        <option>Planned</option>
        <option>Active</option>
        <option>Completed</option>
        <option>Failed</option>
      </select>
      <!-- Export current table view (client-side) -->
      <button id="exportCSV">Export CSV</button>
    </div>

    <!-- KPI Cards -->
    <div class="kpis">
      <div class="kpi">
        <div class="kpi-title">Total Missions</div>
        <div class="kpi-value" id="kpiCount">0</div>
        <div class="kpi-sub">after filters</div>
      </div>
      <div class="kpi">
        <div class="kpi-title">Total Payout (aUEC)</div>
        <div class="kpi-value" id="kpiTotal">0</div>
        <div class="kpi-sub">sum of payout_auec</div>
      </div>
      <div class="kpi">
        <div class="kpi-title">Average Payout / Mission</div>
        <div class="kpi-value" id="kpiAvg">0</div>
        <div class="kpi-sub">based on filtered list</div>
      </div>
    </div>

    <!-- Table -->
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Mission Title</th>
            <th>Type</th>
            <th>Status</th>
            <th>Origin</th>
            <th>Destination</th>
            <th class="nowrap">Date</th>
            <th class="nowrap">No. of Hours</th>
            <th class="nowrap">Payout (aUEC)</th>
            <th>Tags</th>
            <th>Attendees</th>
            <th>Attachments</th>
            <th>Notes</th>
            <th>ID</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- ðŸ” AUTH SECTION (same as Contracts) -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/auth.js"></script>
  <!-- END AUTH SECTION -->

  <!-- Supabase fetch + render -->
  <script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

  const SUPABASE_URL  = 'https://fcegavhipeaeihxegsnw.supabase.co'
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjZWdhdmhpcGVhZWlheGVnc253Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMjk3NTcsImV4cCI6MjA3NzcwNTc1N30.i-ZjOlKc89-uA7fqOIvmAMv60-C2_NmKikRI_78Jei8'
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON)

  const tbody  = document.getElementById('tbody')
  const search = document.getElementById('search')
  const statusFilter = document.getElementById('statusFilter')

  let cache = []   // full dataset
  let view  = []   // filtered dataset (for KPIs/export)

  const esc = (s='') => { const d=document.createElement('div'); d.textContent=s; return d.innerHTML }
  const fmtDate = iso => iso ? new Date(iso).toLocaleString() : ''
  const fmtNum = n => (n||n===0) ? Number(n).toLocaleString() : ''
  const pill = t => t ? `<span class="pill">${esc(t)}</span>` : ''

  function attachmentsCell(arr){
    if(!Array.isArray(arr) || !arr.length) return ''
    return arr.map((a,i)=>{
      const name = a?.name?.trim() || `Attachment ${i+1}`
      const url  = a?.url || '#'
      return `<a class="link" href="${esc(url)}" target="_blank" rel="noopener">${esc(name)}</a>`
    }).join(', ')
  }

  function rowHtml(r){
    return `
      <tr>
        <td>${esc(r.title||'(untitled)')}</td>
        <td>${pill(r.type)}</td>
        <td>${pill(r.status)}</td>
        <td>${esc(r.origin||'')}</td>
        <td>${esc(r.destination||'')}</td>
        <td class="nowrap mono">${fmtDate(r.start_time)}</td>
        <td class="mono">${r.hours ?? ''}</td>
        <td class="mono">${fmtNum(r.payout_auec)}</td>
        <td>${esc(r.tags||'')}</td>
        <td>${esc(r.attendees||'')}</td>
        <td>${attachmentsCell(r.attachments)}</td>
        <td>${esc(r.notes||'')}</td>
        <td>${esc(r.id||'')}</td>
      </tr>`
  }

  function render(rows){
    tbody.innerHTML = rows.length
      ? rows.map(rowHtml).join('')
      : `<tr><td colspan="13" class="small" style="padding:12px">No missions found.</td></tr>`
    view = rows
    updateKPIs(rows)
  }

  function updateKPIs(rows){
    const count = rows.length
    let total = 0
    for(const r of rows){ total += Number(r.payout_auec||0) }
    const avg = count ? Math.round(total / count) : 0
    document.getElementById('kpiCount').textContent = count.toLocaleString()
    document.getElementById('kpiTotal').textContent = total.toLocaleString()
    document.getElementById('kpiAvg').textContent   = avg.toLocaleString()
  }

  function applyFilters(){
    const q  = (search.value||'').toLowerCase()
    const sf = (statusFilter.value||'').toLowerCase()
    let rows = cache.slice()
    if(sf) rows = rows.filter(r => (r.status||'').toLowerCase() === sf)
    if(q){
      rows = rows.filter(r =>
        (r.title||'').toLowerCase().includes(q) ||
        (r.type||'').toLowerCase().includes(q) ||
        (r.status||'').toLowerCase().includes(q) ||
        (r.tags||'').toLowerCase().includes(q) ||
        (r.origin||'').toLowerCase().includes(q) ||
        (r.destination||'').toLowerCase().includes(q)
      )
    }
    render(rows)
  }

  async function load(){
    const { data, error } = await sb.from('missions')
      .select('id,title,type,status,origin,destination,start_time,hours,payout_auec,tags,attendees,attachments,notes,created_at')
      .order('created_at',{ascending:false})
    if(error){
      tbody.innerHTML = `<tr><td colspan="13" class="small" style="padding:12px">Failed to load missions: ${esc(error.message)}</td></tr>`
      return
    }
    cache = data || []
    applyFilters()
  }

  // Export current filtered view as CSV (client-side)
  document.getElementById('exportCSV').onclick = () => {
    if(!view.length){ alert('Nothing to export'); return }
    const cols = ['Mission Title','Type','Status','Origin','Destination','Date','No. of Hours','Payout (aUEC)','Tags','Attendees','Notes','ID']
    const lines = [cols.join(',')]
    for(const r of view){
      const row = [
        r.title||'',
        r.type||'',
        r.status||'',
        r.origin||'',
        r.destination||'',
        fmtDate(r.start_time),
        r.hours??'',
        r.payout_auec??'',
        (r.tags||'').replaceAll(',',';'),
        (r.attendees||'').replaceAll(',',';'),
        (r.notes||'').replaceAll('\n',' ').replaceAll(',',';'),
        r.id||''
      ].map(x=>`"${String(x??'').replaceAll('"','""')}"`)
      lines.push(row.join(','))
    }
    const blob = new Blob([lines.join('\n')],{type:'text/csv'})
    const url  = URL.createObjectURL(blob)
    const a = document.createElement('a'); a.href=url; a.download='jmbn-mission-log.csv'; a.click()
    URL.revokeObjectURL(url)
  }

  // Auth-gate like Contracts
  document.addEventListener('DOMContentLoaded', async () => {
    const session = await requireAuth();
    if (!session) return;
    await load();
  });

  search.addEventListener('input', applyFilters)
  statusFilter.addEventListener('input', applyFilters)
  </script>

  <!-- Active nav highlight -->
  <script>
  (function(){
    const here=location.pathname.split('/').pop()||'mission-log.html';
    document.querySelectorAll('.nav-btn').forEach(a=>{
      if(a.getAttribute('href')===here){
        a.classList.add('active');
        a.setAttribute('aria-current','page');
      }
    });
  })();
  </script>
</body>
</html>
