<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Mission Log</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png"
      href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png"
      sizes="32x32">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--border:#d6b44c;--card:#141414;
  --accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;
  --fs-base:14px;--fs-small:11px;--fs-table:13px;--fs-h1:clamp(18px,2.2vw,22px);
}
*{box-sizing:border-box}
body{
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text);
  font-family:'Play',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  margin:0;padding:14px;letter-spacing:.25px;font-size:var(--fs-base);
}

/* Header + nav */
.brand{display:flex;align-items:center;gap:10px;margin:0 0 8px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.brand-logo{width:44px;height:44px;object-fit:contain;filter:drop-shadow(0 0 4px rgba(242,214,117,.25))}
.brand h1{font-weight:700;font-size:var(--fs-h1);color:var(--accent);margin:0}
.nav{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
.nav-btn{
  --gold:#f2d675;--gold2:#e7c760;--ring:#d6b44c;
  position:relative;display:inline-flex;align-items:center;justify-content:center;
  padding:7px 14px;border:1px solid var(--ring);border-radius:999px;
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);text-decoration:none;font-weight:700;
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.12);
  transition:transform .15s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
  overflow:hidden;
}
.nav-btn:hover{transform:translateY(-1px);box-shadow:0 0 12px rgba(214,180,76,.25), inset 0 0 0 1px rgba(214,180,76,.18);background:linear-gradient(180deg,#1a1a1a,#0a0a0a)}
.nav-btn.active{color:#000;background:linear-gradient(180deg,var(--gold),var(--gold2));border-color:var(--ring);box-shadow:0 0 20px rgba(214,180,76,.45)}
.nav-btn.active::after{content:"";position:absolute;inset:0;background:linear-gradient(120deg,rgba(255,255,255,0) 30%,rgba(255,255,255,.3) 50%,rgba(255,255,255,0) 70%);border-radius:inherit;transform:translateX(-120%);animation:shine 2.8s ease-in-out infinite;pointer-events:none}
@keyframes shine{0%{transform:translateX(-120%)}35%,100%{transform:translateX(120%)}}

/* Panels + controls */
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:8px;box-shadow:0 0 18px rgba(214,180,76,.22)}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
button{padding:7px 11px;border-radius:10px;background:linear-gradient(180deg,#0c0c0c,#060606);color:var(--accent);border:1px solid var(--border);cursor:pointer;font-family:'Play';transition:.2s}
button:hover{background:var(--accent);color:#000}
.btn-primary{background:var(--accent);color:#000}
input,select{background:#0a0a0a;border:1px solid var(--border);border-radius:8px;padding:9px;color:var(--text);font-size:var(--fs-table);font-family:'Play'}
.small{font-size:var(--fs-small);color:var(--muted)}

/* KPI */
.kpis{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin:8px 0 6px}
@media(max-width:880px){.kpis{grid-template-columns:1fr}}
.kpi{background:linear-gradient(180deg,#0b0b0b,#080808);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:0 0 14px rgba(214,180,76,.18), inset 0 0 0 1px rgba(214,180,76,.12)}
.kpi-title{font-size:12px;color:var(--muted);margin-bottom:6px}
.kpi-value{font-size:22px;font-weight:700;color:var(--accent);line-height:1}
.kpi-sub{font-size:12px;color:var(--muted);margin-top:4px}

/* Table */
.tableWrap{border:1px solid var(--border);border-radius:12px;overflow:auto;max-height:70vh;margin-top:10px}
table{width:100%;border-collapse:collapse;font-size:var(--fs-table)}
th,td{border-bottom:1px solid rgba(214,180,76,.3);padding:8px;text-align:left;vertical-align:top}
th{color:var(--accent);background:#080808;font-weight:500}
tr:nth-child(even){background:#111}
tr:hover{background:rgba(214,180,76,.08)}
.pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px;color:var(--muted)}
.nowrap{white-space:nowrap}
.mono{font-variant-numeric:tabular-nums}

/* Admin button + modal */
#adminCreateBtn{display:none}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:50}
.modal.show{display:flex}
.modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(2px)}
.modal .sheet{position:relative;z-index:1;width:min(820px,92vw);background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.6);padding:14px}
.modal h3{margin:0 0 10px;color:var(--accent)}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid1{display:grid;grid-template-columns:1fr;gap:10px}
.modal label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
.modal input,.modal select,.modal textarea{width:100%;background:#0a0a0a;border:1px solid var(--border);border-radius:8px;padding:9px;color:var(--text);font-family:'Play'}
.modal .actions{display:flex;gap:8px;justify-content:space-between;margin-top:12px}
.modal .left-actions{display:flex;gap:8px}
.attach-row{display:grid;grid-template-columns:1fr 1fr auto;gap:8px}
.attach-row button{padding:6px 10px}
.tip{font-size:11px;color:var(--muted)}
</style>
</head>
<body>
  <!-- Header -->
  <div class="brand">
    <img class="brand-logo" src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png/v1/fill/w_66,h_66,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/0_New_JMBN_Logo_Gold.png" alt="JMBN">
    <h1>JMBN Mission Log</h1>
  </div>

  <!-- Nav -->
  <nav class="nav">
    <a class="nav-btn" href="index.html">Manifest</a>
    <a class="nav-btn" href="hangar.html">Hangar</a>
    <a class="nav-btn" href="components.html">Components</a>
    <a class="nav-btn" href="contracts.html">Contracts</a>
    <a class="nav-btn active" href="mission-log.html">Mission Log</a>
  </nav>

  <div class="panel">
    <!-- Controls -->
    <div class="controls">
      <input id="search" placeholder="Search... (title, type, status, tags)">
      <select id="statusFilter">
        <option value="">All Status</option>
        <option>Draft</option>
        <option>In Progress</option>
        <option>Completed</option>
        <option>Aborted</option>
      </select>
      <button id="exportCsv">Export CSV</button>
      <span class="small" style="margin-left:auto">Tip: Click a row to view. If you have permission, it will open in edit mode.</span>
      <button id="adminCreateBtn" class="btn-primary">+ New Mission</button>
    </div>

    <!-- KPI -->
    <div class="kpis">
      <div class="kpi">
        <div class="kpi-title">Total Missions</div>
        <div class="kpi-value" id="kpiCount">0</div>
        <div class="kpi-sub">after filters</div>
      </div>
      <div class="kpi">
        <div class="kpi-title">Total Payout (aUEC)</div>
        <div class="kpi-value" id="kpiTotal">0</div>
        <div class="kpi-sub">sum of payouts</div>
      </div>
    </div>

    <!-- Table -->
    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Mission Title</th>
            <th>Type</th>
            <th>Status</th>
            <th>Origin</th>
            <th>Destination</th>
            <th class="nowrap">Date</th>
            <th class="nowrap">Hours</th>
            <th class="nowrap">Payout (aUEC)</th>
            <th>Tags</th>
            <th>Attendees</th>
            <th>Attachments</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Admin Create/Edit Modal -->
  <div id="missionModal" class="modal" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="sheet">
      <h3 id="modalTitle">New Mission</h3>

      <div class="grid1">
        <div>
          <label>Title</label>
          <input id="f_title" placeholder="e.g., RW S2 â€” 24-box Haul">
        </div>
      </div>

      <div class="grid2">
        <div>
          <label>Type</label>
          <select id="f_type">
            <option></option><option>Hauling</option><option>Delivery</option>
            <option>Rescue</option><option>Bounty</option><option>Investigation</option>
            <option>Salvage</option><option>Mining</option><option>Exploration</option>
          </select>
        </div>
        <div>
          <label>Status</label>
          <select id="f_status">
            <option></option><option>Draft</option><option>In Progress</option>
            <option>Completed</option><option>Aborted</option>
          </select>
        </div>
      </div>

      <div class="grid2">
        <div><label>Origin</label><input id="f_origin"></div>
        <div><label>Destination</label><input id="f_destination"></div>
      </div>

      <div class="grid2">
        <div><label>Date/Time</label><input id="f_date" type="datetime-local"></div>
        <div><label>Hours</label><input id="f_hours" type="number" step="0.1"></div>
      </div>

      <div class="grid2">
        <div><label>Payout (aUEC)</label><input id="f_payout" type="number" step="1"></div>
        <div><label>Tags</label><input id="f_tags" placeholder="hauling, night"></div>
      </div>

      <div class="grid1">
        <div><label>Attendees</label><input id="f_attendees" placeholder="Vex, Kara"></div>
        <div><label>Notes</label><textarea id="f_notes" rows="4"></textarea></div>
      </div>

      <div class="grid1">
        <label>Attachments</label>
        <div id="attachWrap"></div>
        <button id="addAttach" style="margin-top:6px">+ Add attachment</button>
        <div class="tip">Each row is <b>Label</b> + <b>URL</b>.</div>
      </div>

      <div class="actions">
        <div class="left-actions">
          <button id="deleteBtn" class="bad" style="border-color:var(--bad);color:var(--bad)">ðŸ—‘ Delete</button>
        </div>
        <div>
          <button id="cancelBtn">Cancel</button>
          <button id="saveBtn" class="btn-primary">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ðŸ” Supabase client + your auth helper -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/auth.js"></script>

<script>
/* ===== Utilities ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const esc = s => { const d=document.createElement('div'); d.textContent=s??''; return d.innerHTML; };
const fmtDate = iso => iso? new Date(iso).toLocaleString() : '';
const fmtNum  = n => (n||n===0) ? Number(n).toLocaleString() : '';
const isoToLocal = iso => iso ? new Date(iso).toISOString().slice(0,16) : '';
const localToISO = v => v ? new Date(v).toISOString() : null;

/* ===== State ===== */
let sb, session, currentUser, elevated = false;
let cache = [];               // missions
let editingId = null;         // null = create

/* ===== Attachments control ===== */
function addAttachRow(name='',url=''){
  const row = document.createElement('div');
  row.className = 'attach-row';
  row.innerHTML = `
    <input placeholder="Label" value="${esc(name)}">
    <input placeholder="URL (https://...)" value="${esc(url)}">
    <button type="button">âœ•</button>`;
  row.querySelector('button').onclick = () => row.remove();
  $('#attachWrap').appendChild(row);
}
function attachmentsFromUI(){
  return [...$('#attachWrap').querySelectorAll('.attach-row')].map(r=>{
    const name = r.children[0].value.trim();
    const url  = r.children[1].value.trim();
    if(!url) return null;
    try { new URL(url); } catch { return null; }
    return { name: name || (url.split('/').pop() || 'link'), url };
  }).filter(Boolean);
}
function fillAttachments(arr){
  $('#attachWrap').innerHTML = '';
  if(Array.isArray(arr) && arr.length) arr.forEach(a=>addAttachRow(a.name||'', a.url||''));
  else addAttachRow();
}

/* ===== Table render ===== */
const tbody = $('#tbody');
function attachmentsCell(arr){
  if(!Array.isArray(arr)||!arr.length) return '';
  return arr.map((a,i)=>`<a href="${esc(a.url||'#')}" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:underline">${esc(a.name||`Attachment ${i+1}`)}</a>`).join(', ');
}
function rowHTML(r){
  return `<tr data-id="${r.id}">
    <td><b style="color:var(--accent)">${esc(r.title||'(untitled)')}</b></td>
    <td>${r.type?`<span class="pill">${esc(r.type)}</span>`:''}</td>
    <td>${r.status?`<span class="pill">${esc(r.status)}</span>`:''}</td>
    <td>${esc(r.origin||'')}</td>
    <td>${esc(r.destination||'')}</td>
    <td class="nowrap mono">${fmtDate(r.start_time)}</td>
    <td class="mono">${r.hours ?? ''}</td>
    <td class="mono">${fmtNum(r.payout_auec)}</td>
    <td>${esc(r.tags||'')}</td>
    <td>${esc(r.attendees||'')}</td>
    <td>${attachmentsCell(r.attachments)}</td>
    <td>${esc(r.notes||'')}</td>
  </tr>`;
}
function render(list){
  $('#kpiCount').textContent = (list||[]).length.toLocaleString();
  const total = (list||[]).reduce((s,x)=> s + (Number(x.payout_auec)||0), 0);
  $('#kpiTotal').textContent = total.toLocaleString();
  tbody.innerHTML = list.length ? list.map(rowHTML).join('') :
    `<tr><td colspan="12" class="small" style="padding:10px">No missions found.</td></tr>`;

  // row click to view/edit
  $$('#tbody tr').forEach(tr=>{
    tr.onclick = () => openForEdit(tr.getAttribute('data-id'));
  });
}

/* ===== Filters + CSV ===== */
function getFiltered(){
  const q = ($('#search').value||'').toLowerCase();
  const st = ($('#statusFilter').value||'').toLowerCase();
  let arr = cache.slice();
  if(st) arr = arr.filter(x => (x.status||'').toLowerCase()===st);
  if(q) arr = arr.filter(x =>
    `${x.title||''} ${x.type||''} ${x.status||''} ${x.tags||''} ${x.origin||''} ${x.destination||''}`
    .toLowerCase().includes(q));
  return arr;
}
function bindFilters(){
  $('#search').addEventListener('input', ()=>render(getFiltered()));
  $('#statusFilter').addEventListener('input', ()=>render(getFiltered()));
  $('#exportCsv').addEventListener('click', ()=>{
    const rows = getFiltered();
    const cols = ['title','type','status','origin','destination','start_time','hours','payout_auec','tags','attendees','notes'];
    const csv = [
      cols.join(','),
      ...rows.map(r => cols.map(k=>{
        const v = r[k]==null?'':String(r[k]).replace(/"/g,'""');
        return `"${v}"`;
      }).join(','))
    ].join('\n');
    const blob = new Blob([csv],{type:'text/csv'});
    const url = URL.createObjectURL(blob); const a=document.createElement('a');
    a.href=url; a.download='missions.csv'; a.click(); URL.revokeObjectURL(url);
  });
}

/* ===== Data ===== */
async function loadMissions(){
  const { data, error } = await sb
    .from('missions')
    .select('id,title,type,status,origin,destination,start_time,hours,payout_auec,tags,attendees,attachments,notes,submitted_by')
    .order('created_at',{ascending:false});
  if(error){
    tbody.innerHTML = `<tr><td colspan="12" class="small" style="padding:10px">Failed to load missions: ${esc(error.message)}</td></tr>`;
    return;
  }
  cache = data || [];
  render(getFiltered());
}

/* ===== Permissions ===== */
function canEditRow(r){
  if(elevated) return true; // admin/officer
  if(!currentUser) return false;
  // allow editing own mission if your RLS allows owner updates:
  return r.submitted_by && r.submitted_by === currentUser.id;
}

/* ===== Modal open/fill ===== */
const modal = $('#missionModal');
const showModal = ()=> modal.classList.add('show');
const hideModal = ()=> modal.classList.remove('show');

function fillForm(r){
  $('#modalTitle').textContent = editingId ? `Edit Mission (${editingId.slice(0,8)})` : 'New Mission';
  $('#deleteBtn').style.display = editingId && canEditRow(r||{}) ? 'inline-block' : 'none';

  $('#f_title').value = r?.title || '';
  $('#f_type').value = r?.type || '';
  $('#f_status').value = r?.status || '';
  $('#f_origin').value = r?.origin || '';
  $('#f_destination').value = r?.destination || '';
  $('#f_date').value = isoToLocal(r?.start_time);
  $('#f_hours').value = r?.hours ?? '';
  $('#f_payout').value = r?.payout_auec ?? '';
  $('#f_tags').value = r?.tags || '';
  $('#f_attendees').value = r?.attendees || '';
  $('#f_notes').value = r?.notes || '';
  fillAttachments(r?.attachments || []);
}

async function openForEdit(id){
  const row = cache.find(x=>x.id===id);
  if(!row){ return; }

  if(!canEditRow(row)){
    // view-only open (no delete/save)
    editingId = null;
    fillForm(row);
    $('#saveBtn').disabled = true;
    $('#deleteBtn').style.display = 'none';
    showModal();
    return;
  }

  // edit mode
  editingId = id;
  $('#saveBtn').disabled = false;
  fillForm(row);
  showModal();
}

/* ===== Create / Edit actions ===== */
function payloadFromUI(){
  return {
    title: $('#f_title').value.trim(),
    type: $('#f_type').value || null,
    status: $('#f_status').value || null,
    origin: $('#f_origin').value || null,
    destination: $('#f_destination').value || null,
    start_time: localToISO($('#f_date').value),
    hours: Number($('#f_hours').value || 0),
    payout_auec: Number($('#f_payout').value || 0),
    tags: $('#f_tags').value || null,
    attendees: $('#f_attendees').value || null,
    notes: $('#f_notes').value || null,
    attachments: attachmentsFromUI()
  };
}

async function saveMission(){
  const payload = payloadFromUI();
  if(!payload.title){ alert('Title is required.'); return; }

  if(!editingId){
    // insert
    const uid = currentUser?.id;
    if(!uid){ alert('Please log in again.'); return; }
    payload.submitted_by = uid; // RLS insert requirement
    const { error } = await sb.from('missions').insert(payload);
    if(error){ alert('Save failed: ' + error.message); return; }
    alert('Mission created âœ“');
  }else{
    // update
    const { error } = await sb.from('missions').update(payload).eq('id', editingId);
    if(error){ alert('Update failed: ' + error.message); return; }
    alert('Mission updated âœ“');
  }

  hideModal();
  await loadMissions();
}

async function deleteMission(){
  if(!editingId) return;
  if(!confirm('Delete this mission? This cannot be undone.')) return;
  const { error } = await sb.from('missions').delete().eq('id', editingId);
  if(error){ alert('Delete failed: ' + error.message); return; }
  alert('Deleted âœ“');
  hideModal();
  await loadMissions();
}

/* ===== Boot ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  // Require auth
  session = await window.requireAuth();
  if(!session) return;

  sb = window.sb;
  currentUser = session.user;

  // Elevation check
  const { data: prof } = await sb.from('v_profiles').select('roles').eq('user_id', currentUser.id).single();
  elevated = (prof?.roles || []).some(r => ['admin','officer'].includes(r));
  if(elevated) $('#adminCreateBtn').style.display = 'inline-flex';

  // Controls
  bindFilters();
  $('#adminCreateBtn').onclick = () => { editingId = null; $('#saveBtn').disabled = false; fillForm(null); showModal(); };
  $('#addAttach').onclick = () => addAttachRow();
  $('.backdrop').onclick = hideModal;
  $('#cancelBtn').onclick = hideModal;
  $('#saveBtn').onclick = saveMission;
  $('#deleteBtn').onclick = deleteMission;

  // Default one attachment row for new form
  addAttachRow();

  // Load data
  await loadMissions();
});
</script>
</body>
</html>
