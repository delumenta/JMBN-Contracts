<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Mission Editor</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png"
      href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png"
      sizes="32x32">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--border:#d6b44c;--card:#141414;
  --accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;
  --fs-base:14px;--fs-small:11px;--fs-table:13px;--fs-h1:clamp(18px,2.2vw,22px);
}
*{box-sizing:border-box}
body{
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text);
  font-family:'Play',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  margin:0;padding:14px;letter-spacing:.25px;font-size:var(--fs-base);
}

/* Header */
.brand{display:flex;align-items:center;gap:10px;margin:0 0 8px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.brand-logo{width:44px;height:44px;object-fit:contain;filter:drop-shadow(0 0 4px rgba(242,214,117,.25))}
.brand h1{font-weight:700;font-size:var(--fs-h1);color:var(--accent);margin:0}

/* Shiny nav */
.nav{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
.nav-btn{
  --gold:#f2d675;--gold2:#e7c760;--ring:#d6b44c;
  position:relative;display:inline-flex;align-items:center;justify-content:center;
  padding:7px 14px;border:1px solid var(--ring);border-radius:999px;
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);text-decoration:none;font-weight:700;
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.12);
  transition:transform .15s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
  overflow:hidden;
}
.nav-btn:hover{transform:translateY(-1px);box-shadow:0 0 12px rgba(214,180,76,.25), inset 0 0 0 1px rgba(214,180,76,.18);background:linear-gradient(180deg,#1a1a1a,#0a0a0a)}
.nav-btn.active{color:#000;background:linear-gradient(180deg,var(--gold),var(--gold2));border-color:var(--ring);box-shadow:0 0 20px rgba(214,180,76,.45)}
.nav-btn.active::after{content:"";position:absolute;inset:0;background:linear-gradient(120deg,rgba(255,255,255,0) 30%,rgba(255,255,255,.3) 50%,rgba(255,255,255,0) 70%);border-radius:inherit;transform:translateX(-120%);animation:shine 2.8s ease-in-out infinite;pointer-events:none}
@keyframes shine{0%{transform:translateX(-120%)}35%,100%{transform:translateX(120%)}}

/* Panel + form */
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:8px;box-shadow:0 0 18px rgba(214,180,76,.22)}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:900px){.form-grid{grid-template-columns:1fr}}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:4px}
input[type="text"],input[type="number"],input[type="datetime-local"],select,textarea{
  width:100%;background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:10px;color:var(--text);font-family:'Play';
}
textarea{min-height:120px;resize:vertical}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.small{font-size:var(--fs-small);color:var(--muted)}
hr{border:none;border-top:1px solid rgba(214,180,76,.3);margin:10px 0}

button,.btn{padding:9px 14px;border-radius:10px;background:linear-gradient(180deg,#0c0c0c,#060606);color:var(--accent);border:1px solid var(--border);cursor:pointer;font-family:'Play';transition:.2s}
button:hover,.btn:hover{background:var(--accent);color:#000}
.btn-primary{background:var(--accent);color:#000}
.btn-bad{border-color:#cc5a5a;color:#ffbcbc}
.btn-bad:hover{background:#ff6b6b;color:#000}

/* Attachments list */
.att-item{display:grid;grid-template-columns:1fr 1fr auto;gap:8px;margin-bottom:8px}
@media(max-width:900px){.att-item{grid-template-columns:1fr 1fr}}
.att-item .remove{padding:8px 10px}
</style>
</head>
<body>

<!-- üîÅ Shared header mount -->
<div id="header-container"></div>
<script>
(async () => {
  try {
    const res = await fetch('header.html', { cache: 'no-cache' });
    const html = await res.text();
    document.getElementById('header-container').outerHTML = html;

    // highlight tab
    requestAnimationFrame(() => {
      const here = (location.pathname.split('/').pop() || 'missions-editor.html').toLowerCase();
      document.querySelectorAll('.nav-btn').forEach(a => {
        const href = (a.getAttribute('href')||'').toLowerCase();
        if (href === here) {
          a.classList.add('active');
          a.setAttribute('aria-current','page');
        }
      });
    });
  } catch (e) {
    console.warn('Header load failed:', e);
  }
})();
</script>

<div class="panel">
  <div class="row" style="justify-content:space-between;margin-bottom:10px">
    <a class="btn" href="mission-log.html">‚Üê Back to Mission Log</a>
    <span class="small" id="statusMsg"></span>
  </div>

  <div class="form-grid">
    <div>
      <label>Mission Title</label>
      <input id="fTitle" type="text" placeholder="e.g., RW S2 ‚Äî 24-box Haul" />
    </div>

    <div class="row" style="gap:12px">
      <div style="flex:1">
        <label>Type</label>
        <input id="fType" type="text" placeholder="hauling / escort / mining‚Ä¶" />
      </div>
      <div style="flex:1">
        <label>Status</label>
        <select id="fStatus">
          <option>Draft</option>
          <option>In Progress</option>
          <option>Completed</option>
          <option>Aborted</option>
        </select>
      </div>
    </div>

    <div>
      <label>Origin</label>
      <input id="fOrigin" type="text" placeholder="e.g., Area18" />
    </div>
    <div>
      <label>Destination</label>
      <input id="fDestination" type="text" placeholder="e.g., Everus Harbor" />
    </div>

    <div>
      <label>Date & Time</label>
      <input id="fStart" type="datetime-local" />
    </div>

    <div class="row" style="gap:12px">
      <div style="flex:1">
        <label>No. of Hours</label>
        <input id="fHours" type="number" min="0" step="0.1" />
      </div>
      <div style="flex:1">
        <label>Payout (aUEC)</label>
        <input id="fPayout" type="number" min="0" step="1" />
      </div>
    </div>

    <div>
      <label>Tags (comma separated)</label>
      <input id="fTags" type="text" placeholder="hauling, night" />
    </div>
    <div></div>

    <div style="grid-column:1/-1">
      <label>Notes</label>
      <textarea id="fNotes" placeholder="Route, risks, cargo details, etc."></textarea>
    </div>

    <div style="grid-column:1/-1">
      <div class="row" style="justify-content:space-between;align-items:center">
        <label style="margin:0">Attachments</label>
        <button id="btnAddAtt" type="button">+ Add Attachment</button>
      </div>
      <div id="attList" style="margin-top:8px"></div>
      <div class="small">Tip: give each link a short label (e.g., ‚ÄúScreenshot 1‚Äù) and paste the URL.</div>
    </div>
  </div>

  <hr/>

  <div class="row" style="gap:8px">
    <button id="btnSave" class="btn-primary">Save Mission</button>
    <button id="btnDelete" class="btn-bad" style="display:none">Delete</button>
  </div>
</div>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>

<script>
/* ===== Helpers ===== */
const $ = s => document.querySelector(s);
const esc = s => { const d=document.createElement('div'); d.textContent = s ?? ''; return d.innerHTML; };
const params = new URLSearchParams(location.search);
const MISSION_ID = params.get('id') || null;

let sb = null, session = null;
let IS_ELEVATED = false;
let OWNER_ID = null;

/* ===== Attachments UI ===== */
function attRow(name='', url=''){
  const wrap = document.createElement('div');
  wrap.className = 'att-item';
  wrap.innerHTML = `
    <input type="text" class="att-name" placeholder="Label (e.g., Screenshot 1)" value="${esc(name)}" />
    <input type="text" class="att-url" placeholder="https://‚Ä¶" value="${esc(url)}" />
    <button type="button" class="remove">‚úï</button>
  `;
  wrap.querySelector('.remove').onclick = () => wrap.remove();
  return wrap;
}
function readAttachments(){
  const items = Array.from(document.querySelectorAll('#attList .att-item'));
  return items.map(x => {
    const n = x.querySelector('.att-name').value.trim();
    const u = x.querySelector('.att-url').value.trim();
    if(!n && !u) return null;
    return { name: n || null, url: u || null };
  }).filter(Boolean);
}
$('#btnAddAtt').onclick = () => $('#attList').appendChild(attRow());

/* ===== Load Existing (edit mode) ===== */
async function loadMission(){
  if(!MISSION_ID) return;

  const { data, error } = await sb
    .from('missions')
    .select('id,title,type,status,origin,destination,start_time,hours,payout_auec,tags,attachments,notes,submitted_by')
    .eq('id', MISSION_ID).maybeSingle();

  if(error){ $('#statusMsg').textContent = 'Failed to load mission: ' + error.message; return; }
  if(!data){ $('#statusMsg').textContent = 'Mission not found.'; return; }

  OWNER_ID = data.submitted_by || null;

  // Fill form
  $('#fTitle').value = data.title || '';
  $('#fType').value = data.type || '';
  $('#fStatus').value = data.status || 'Draft';
  $('#fOrigin').value = data.origin || '';
  $('#fDestination').value = data.destination || '';
  $('#fHours').value = data.hours ?? '';
  $('#fPayout').value = data.payout_auec ?? '';
  $('#fTags').value = data.tags || '';
  $('#fNotes').value = data.notes || '';

  if (data.start_time){
    // to datetime-local format
    const t = new Date(data.start_time);
    const pad = n => String(n).padStart(2,'0');
    const local = `${t.getFullYear()}-${pad(t.getMonth()+1)}-${pad(t.getDate())}T${pad(t.getHours())}:${pad(t.getMinutes())}`;
    $('#fStart').value = local;
  }

  $('#attList').innerHTML = '';
  (Array.isArray(data.attachments) ? data.attachments : []).forEach(a=>{
    $('#attList').appendChild(attRow(a?.name||'', a?.url||'')); 
  });

  // Delete button visibility
  if (IS_ELEVATED || (OWNER_ID && OWNER_ID === session.user.id)){
    $('#btnDelete').style.display = '';
  }
}

/* ===== Save / Delete ===== */
function isoFromLocalInput(v){
  if(!v) return null;
  // treat as local time; convert to ISO
  const dt = new Date(v);
  if (isNaN(dt)) return null;
  return dt.toISOString();
}

async function saveMission(){
  $('#statusMsg').textContent = 'Saving‚Ä¶';

  const payload = {
    title: $('#fTitle').value.trim() || null,
    type: $('#fType').value.trim() || null,
    status: $('#fStatus').value || null,
    origin: $('#fOrigin').value.trim() || null,
    destination: $('#fDestination').value.trim() || null,
    start_time: isoFromLocalInput($('#fStart').value) || null,
    hours: $('#fHours').value ? Number($('#fHours').value) : null,
    payout_auec: $('#fPayout').value ? Number($('#fPayout').value) : null,
    tags: $('#fTags').value.trim() || null,
    attachments: readAttachments(),
    notes: $('#fNotes').value || null
  };

  // new
  if(!MISSION_ID){
    payload.submitted_by = session.user.id;
    const { data, error } = await sb.from('missions').insert(payload).select('id').single();
    if(error){ $('#statusMsg').textContent = 'Save failed: ' + error.message; return; }
    location.href = `missions-editor.html?id=${data.id}`;
    return;
  }

  // update (RLS should allow owner or elevated)
  const { error } = await sb.from('missions').update(payload).eq('id', MISSION_ID);
  if(error){ $('#statusMsg').textContent = 'Save failed: ' + error.message; return; }
  $('#statusMsg').textContent = 'Saved.';
}

async function deleteMission(){
  if(!confirm('Delete this mission? This cannot be undone.')) return;
  const { error } = await sb.from('missions').delete().eq('id', MISSION_ID);
  if(error){ $('#statusMsg').textContent = 'Delete failed: ' + error.message; return; }
  location.href = 'mission-log.html';
}

$('#btnSave').onclick = saveMission;
$('#btnDelete').onclick = deleteMission;

/* ===== Boot ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  session = await requireAuth();
  if(!session) return;
  sb = getSupabase();

  // elevated?
  try {
    const { data } = await sb.rpc('is_elevated', { u: session.user.id });
    IS_ELEVATED = !!data;
  } catch(e){ IS_ELEVATED = false; }

  if(MISSION_ID) await loadMission();
});
</script>
</body>
</html>
