<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Mission Log</title>

<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png"
      href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png"
      sizes="32x32">

<style>
:root{
  --bg:#000; --panel:#0b0b0b; --row:#0a0a0a;
  --border:#d6b44c; --accent:#f2d675; --text:#f7f1d0; --muted:#c9b06a;
  --ring:#ddb54b;
}
*{box-sizing:border-box}
body{
  background:#000;color:var(--text);
  font-family:'Play',system-ui,sans-serif;
  margin:0;padding:20px;
}

/* Brand + Nav */
.brand{
  display:flex;align-items:center;gap:12px;
  margin-bottom:8px;
}
.brand-logo{
  width:40px;height:40px;border-radius:8px;object-fit:cover;
}
.brand h1{
  font-size:22px;letter-spacing:1px;margin:0;
}
.brand-sub{
  font-size:12px;color:var(--muted);margin-top:2px;
}
.nav{
  display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;
}
.nav-btn{
  display:inline-flex;align-items:center;justify-content:center;
  padding:7px 14px;border:1px solid var(--ring);border-radius:999px;
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:#f2d675;text-decoration:none;font-weight:700;letter-spacing:.2px;
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.12);
  transition:transform .15s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
}
.nav-btn:hover{
  transform:translateY(-1px);
  box-shadow:0 0 12px rgba(214,180,76,.25), inset 0 0 0 1px rgba(214,180,76,.18);
}
.nav-btn.active{
  color:#000;
  background:linear-gradient(180deg,#f2d675,#e7c760);
  border-color:var(--ring)
}

/* Toolbar */
.toolbar{
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px;
}
input[type="search"]{
  width:260px;background:#0a0a0a;border:1px solid var(--border);
  border-radius:10px;padding:8px 10px;color:var(--text);
}
.subtle{color:var(--muted);font-size:12px}

/* Panel + headings */
.panel{
  background:
    radial-gradient(900px 400px at 110% -10%,rgba(242,214,117,.04),transparent 50%),
    #050505;
  border-radius:16px;
  border:1px solid rgba(214,180,76,.6);
  box-shadow:0 18px 40px rgba(0,0,0,.9),
             0 0 0 1px rgba(0,0,0,.7),
             inset 0 0 0 1px rgba(214,180,76,.18);
  padding:14px 16px 16px;
}
.section-title{
  font-size:14px;font-weight:700;text-transform:uppercase;
  letter-spacing:.18em;color:var(--accent);margin:10px 0 6px;
}

/* Table */
.table-wrap{
  overflow:auto;
  border:1px solid var(--border);
  border-radius:12px;
  background:var(--panel);
  box-shadow:0 0 18px rgba(214,180,76,.12);
  margin-bottom:14px;
}
table{width:100%;border-collapse:collapse;min-width:1100px}
thead th{
  text-align:left;font-weight:700;color:var(--accent);
  padding:10px 10px;
  border-bottom:1px solid var(--border);
  position:sticky;top:0;background:var(--panel);z-index:1;
  font-size:11px;text-transform:uppercase;letter-spacing:.08em;
}
tbody td{
  padding:10px;border-bottom:1px solid rgba(214,180,76,.25);
  vertical-align:top;font-size:12px;
}
tbody tr:nth-child(even){background:#090909}
tbody tr:hover{background:#111}
.nowrap{white-space:nowrap}
.mono{font-variant-numeric:tabular-nums}

/* Pills + link buttons */
.pill{
  display:inline-block;padding:3px 8px;
  border:1px solid var(--border);border-radius:999px;
  color:var(--accent);font-size:11px;background:#090909;
}
.badge{border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:11px;color:var(--muted)}
.link-btn{
  border:none;background:none;color:var(--accent);cursor:pointer;font-size:11px;text-decoration:underline;
}
.small-btn{
  border-radius:999px;border:1px solid var(--border);
  background:#050505;color:var(--accent);
  padding:4px 10px;font-size:11px;cursor:pointer;
}
.small-btn:hover{background:var(--accent);color:#000}

/* Attendance modal (operations-style shell) */
.modal-bg{
  position:fixed;inset:0;
  background:rgba(0,0,0,.75);
  display:none;
  align-items:center;justify-content:center;
  z-index:50;
}
.modal{
  width:min(720px,95vw);
  background:
    radial-gradient(900px 400px at 110% -10%,rgba(242,214,117,.06),transparent 50%),
    #0b0b0b;
  border-radius:14px;
  border:1px solid var(--border);
  box-shadow:0 14px 36px rgba(0,0,0,.6),
             0 0 26px rgba(214,180,76,.25),
             inset 0 0 0 1px rgba(214,180,76,.08);
}
.modal-head{
  padding:12px 14px;
  border-bottom:1px solid rgba(214,180,76,.35);
  display:flex;align-items:center;justify-content:space-between;
}
.modal-title{font-weight:700;color:var(--accent)}
.modal-body{
  padding:10px 14px;
  max-height:70vh;overflow:auto;
  font-size:12px;
}
.modal-footer{
  padding:8px 14px;
  border-top:1px solid rgba(214,180,76,.35);
  display:flex;justify-content:flex-end;gap:8px;
}
.modal-close{
  border-radius:999px;border:1px solid var(--border);
  background:#050505;color:var(--accent);
  padding:4px 9px;font-size:12px;cursor:pointer;
}
.modal-close:hover{background:var(--accent);color:#000}
.att-title{font-weight:600;margin-bottom:2px}
.att-meta{font-size:11px;color:var(--muted);margin-bottom:8px}
.att-actions{
  display:flex;flex-wrap:wrap;align-items:center;gap:6px;
  margin:4px 0 8px;
}
.att-table{
  width:100%;border-collapse:collapse;font-size:12px;margin-top:4px;
}
.att-table th,.att-table td{
  padding:6px 8px;border-bottom:1px solid rgba(214,180,76,.25);
}
.att-auth-hint{font-size:11px;color:var(--muted)}
</style>
</head>
<body>

<!-- Brand -->
<div class="brand">
  <img class="brand-logo" src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" alt="JMBN">
  <div>
    <h1>JMBN Mission Log</h1>
    <div class="brand-sub">Missions · Crew · Payout</div>
  </div>
</div>

<!-- Nav -->
<nav class="nav">
  <a class="nav-btn" href="index.html">Manifest</a>
  <a class="nav-btn" href="hangar.html">Hangar</a>
  <a class="nav-btn" href="components.html">Components</a>
  <a class="nav-btn" href="contracts.html">Contracts</a>
  <a class="nav-btn active" href="mission-log.html">Mission Log</a>
  <a class="nav-btn" href="operations.html">Operations Log</a>
</nav>

<!-- Toolbar -->
<div class="toolbar">
  <input id="search" type="search" placeholder="Search title / type / tags / status...">
  <span class="subtle">Top table = ongoing. Bottom table = full mission log.</span>
</div>

<div class="panel">

  <!-- Table 1: Ongoing Missions -->
  <div class="section-title">Ongoing Missions</div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Mission Title</th>
          <th>Type</th>
          <th>Status</th>
          <th>Origin</th>
          <th class="nowrap">Crew</th>
          <th class="nowrap">Date</th>
          <th class="nowrap">Hours</th>
          <th class="nowrap">Payout (aUEC)</th>
          <th>Tags</th>
          <th>Notes</th>
          <th class="nowrap">Attendance</th>
        </tr>
      </thead>
      <tbody id="ongoingBody"></tbody>
    </table>
  </div>

  <!-- Table 2: Full Mission Log -->
  <div class="section-title">All Missions</div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Mission Title</th>
          <th>Type</th>
          <th>Status</th>
          <th>Origin</th>
          <th class="nowrap">Crew</th>
          <th class="nowrap">Date</th>
          <th class="nowrap">Hours</th>
          <th class="nowrap">Payout (aUEC)</th>
          <th>Tags</th>
          <th>Attachments</th>
          <th>Notes</th>
          <th class="nowrap">Attendance</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

</div>

<!-- Attendance Modal -->
<div class="modal-bg" id="attModalBg">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title" id="attTitle">Mission</div>
      <button type="button" class="modal-close" id="attClose">✕</button>
    </div>
    <div class="modal-body">
      <div class="att-title" id="attSummary"></div>
      <div class="att-meta" id="attMeta"></div>

      <div class="att-actions">
        <button class="small-btn" id="attGoing">I'm going</button>
        <button class="small-btn" id="attNotGoing">Not going</button>
        <button class="small-btn" id="attWithdraw">Withdraw</button>
        <span class="att-auth-hint" id="attAuthHint"></span>
      </div>

      <table class="att-table" id="attTable"></table>
    </div>
    <div class="modal-footer">
      <button type="button" class="modal-close" id="attClose2">Close</button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

// TODO: keep your real URL + anon key here (same as other pages)
const SUPABASE_URL  = 'https://fcegavhipeaeihxegsnw.supabase.co'
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjZWdhdmhpcGVhZWloeGVnc253Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTA2NDQzNzEsImV4cCI6MjAyNjIyMDM3MX0.gXpqQdajVS2iei1e-2gK5Z84p1doPv93FwsVbVyJMyU'

const sb = createClient(SUPABASE_URL, SUPABASE_ANON)

const tbody        = document.getElementById('tbody')
const ongoingBody  = document.getElementById('ongoingBody')
const searchInput  = document.getElementById('search')

const attBg        = document.getElementById('attModalBg')
const attTitleEl   = document.getElementById('attTitle')
const attSummaryEl = document.getElementById('attSummary')
const attMetaEl    = document.getElementById('attMeta')
const attTable     = document.getElementById('attTable')
const attAuthHint  = document.getElementById('attAuthHint')
const btnGoing     = document.getElementById('attGoing')
const btnNotGoing  = document.getElementById('attNotGoing')
const btnWithdraw  = document.getElementById('attWithdraw')
const btnClose     = document.getElementById('attClose')
const btnClose2    = document.getElementById('attClose2')

let missions = []
let missionCrewCounts = {}   // mission_id -> crew size
let session = null
let ATT_MISSION_ID = null

/* Helpers */
const esc = (s='') => {
  const d=document.createElement('div'); d.textContent=s ?? ''; return d.innerHTML;
}
const fmtDate = iso => iso ? new Date(iso).toLocaleString() : ''
const fmtNum  = n => (n||n===0) ? Number(n).toLocaleString('en-US') : ''

function crewCount(id){
  return missionCrewCounts[id] || 0
}

/* Fetch auth user once */
async function getSession(){
  if(session !== null) return session
  try{
    const { data, error } = await sb.auth.getUser()
    if(error){
      console.warn('auth error', error)
      session = { user:null }
    }else{
      session = { user:data.user || null }
    }
  }catch(err){
    console.warn('auth error', err)
    session = { user:null }
  }
  return session
}

/* Load missions + crew counts */
async function loadMissions(){
  // missions
  const { data, error } = await sb
    .from('missions')
    .select('id,title,type,status,origin,start_time,hours,payout_auec,tags,attachments,notes')
    .order('created_at',{ascending:false})

  if(error){
    tbody.innerHTML = `<tr><td colspan="12" style="padding:12px;color:var(--muted)">Failed to load missions: ${esc(error.message)}</td></tr>`
    ongoingBody.innerHTML = ''
    return
  }

  missions = data || []

  // crew counts from attendance view
  missionCrewCounts = {}
  const ids = missions.map(m => m.id).filter(Boolean)
  if(ids.length){
    const { data: attRows, error: attErr } = await sb
      .from('v_mission_attendees_detailed')
      .select('mission_id')
      .in('mission_id', ids)
    if(!attErr && Array.isArray(attRows)){
      for(const row of attRows){
        missionCrewCounts[row.mission_id] = (missionCrewCounts[row.mission_id]||0) + 1
      }
    }
  }

  renderAll()
  renderOngoing()
}

/* Row builders */
function rowHtml(m){
  return `
    <tr>
      <td>${esc(m.title||'(untitled)')}</td>
      <td>${m.type ? `<span class="pill">${esc(m.type)}</span>` : ''}</td>
      <td>${m.status ? `<span class="pill">${esc(m.status)}</span>` : ''}</td>
      <td>${esc(m.origin||'')}</td>
      <td class="mono">${crewCount(m.id)}</td>
      <td class="nowrap mono">${fmtDate(m.start_time)}</td>
      <td class="mono">${m.hours ?? ''}</td>
      <td class="mono">${fmtNum(m.payout_auec)}</td>
      <td>${esc(m.tags||'')}</td>
      <td>${attachmentsCell(m.attachments)}</td>
      <td>${esc(m.notes||'')}</td>
      <td><button class="small-btn" onclick="openAttendance('${m.id}','${esc(m.title||'')}')">View</button></td>
    </tr>`
}

function rowHtmlOngoing(m){
  return `
    <tr>
      <td>${esc(m.title||'(untitled)')}</td>
      <td>${m.type ? `<span class="pill">${esc(m.type)}</span>` : ''}</td>
      <td>${m.status ? `<span class="pill">${esc(m.status)}</span>` : ''}</td>
      <td>${esc(m.origin||'')}</td>
      <td class="mono">${crewCount(m.id)}</td>
      <td class="nowrap mono">${fmtDate(m.start_time)}</td>
      <td class="mono">${m.hours ?? ''}</td>
      <td class="mono">${fmtNum(m.payout_auec)}</td>
      <td>${esc(m.tags||'')}</td>
      <td>${esc(m.notes||'')}</td>
      <td><button class="small-btn" onclick="openAttendance('${m.id}','${esc(m.title||'')}')">View</button></td>
    </tr>`
}

function attachmentsCell(arr){
  if(!Array.isArray(arr) || !arr.length) return ''
  return arr.map((a,i)=>{
    const name = a?.name?.trim() || `Attachment ${i+1}`
    const url  = a?.url || '#'
    return `<a class="link-btn" href="${esc(url)}" target="_blank" rel="noopener">${esc(name)}</a>`
  }).join(', ')
}

/* Rendering */
function renderAll(){
  const q = (searchInput.value||'').toLowerCase()
  let rows = missions
  if(q){
    rows = rows.filter(m =>
      (m.title||'').toLowerCase().includes(q) ||
      (m.type||'').toLowerCase().includes(q) ||
      (m.status||'').toLowerCase().includes(q) ||
      (m.tags||'').toLowerCase().includes(q) ||
      (m.origin||'').toLowerCase().includes(q)
    )
  }
  tbody.innerHTML = rows.length
    ? rows.map(rowHtml).join('')
    : `<tr><td colspan="12" style="padding:12px;color:var(--muted)">No missions found.</td></tr>`
}

function renderOngoing(){
  const ongoingStatuses = ['Ongoing','In Progress','Active','Planned']
  const rows = missions.filter(m => ongoingStatuses.includes(m.status || ''))
  ongoingBody.innerHTML = rows.length
    ? rows.map(rowHtmlOngoing).join('')
    : `<tr><td colspan="11" style="padding:10px;color:var(--muted)">No ongoing missions right now.</td></tr>`
}

/* Attendance modal */
function closeAttendance(){
  ATT_MISSION_ID = null
  if(attBg) attBg.style.display='none'
}

if(btnClose)  btnClose.onclick  = closeAttendance
if(btnClose2) btnClose2.onclick = closeAttendance
if(attBg){
  attBg.addEventListener('click', e=>{
    if(e.target===attBg) closeAttendance()
  })
}

async function loadAttendees(){
  if(!ATT_MISSION_ID || !attTable) return
  attTable.innerHTML = '<tr><td class="small">Loading attendees…</td></tr>'
  try{
    const { data, error } = await sb
      .from('v_mission_attendees_detailed')
      .select('*')
      .eq('mission_id', ATT_MISSION_ID)
      .order('joined_at',{ascending:true})
    if(error){
      attTable.innerHTML = `<tr><td class="small" style="color:var(--muted)">Failed to load attendees: ${esc(error.message)}</td></tr>`
      return
    }
    const rows = data || []
    if(!rows.length){
      attTable.innerHTML = '<tr><td class="small">No attendees yet.</td></tr>'
      return
    }
    let html = '<thead><tr><th>Name</th><th>Status</th><th class="nowrap">Joined</th></tr></thead><tbody>'
    for(const a of rows){
      html += `
        <tr>
          <td>${esc(a.attendee_name || a.user_email || '')}</td>
          <td>${esc(a.attendance || '')}</td>
          <td class="mono small">${a.joined_at ? fmtDate(a.joined_at) : ''}</td>
        </tr>`
    }
    html += '</tbody>'
    attTable.innerHTML = html
  }catch(err){
    attTable.innerHTML = '<tr><td class="small" style="color:var(--muted)">Failed to load attendees.</td></tr>'
  }
}

function wireAttendanceButtons(user){
  if(!user){
    if(attAuthHint) attAuthHint.textContent = 'Sign in to mark your attendance.'
    btnGoing.disabled = true
    btnNotGoing.disabled = true
    btnWithdraw.disabled = true
    return
  }
  if(attAuthHint) attAuthHint.textContent = ''
  btnGoing.disabled = false
  btnNotGoing.disabled = false
  btnWithdraw.disabled = false

  const uid = user.id

  btnGoing.onclick = async () => {
    await sb.from('mission_attendees').upsert({
      mission_id: ATT_MISSION_ID,
      user_id: uid,
      attendance: 'going'
    }, { onConflict: 'mission_id,user_id' })
    await loadMissions()
    await loadAttendees()
  }
  btnNotGoing.onclick = async () => {
    await sb.from('mission_attendees').upsert({
      mission_id: ATT_MISSION_ID,
      user_id: uid,
      attendance: 'not_going'
    }, { onConflict: 'mission_id,user_id' })
    await loadMissions()
    await loadAttendees()
  }
  btnWithdraw.onclick = async () => {
    await sb.from('mission_attendees')
      .delete()
      .match({ mission_id: ATT_MISSION_ID, user_id: uid })
    await loadMissions()
    await loadAttendees()
  }
}

async function openAttendance(missionId, title=''){
  ATT_MISSION_ID = missionId
  if(attBg) attBg.style.display='flex'

  // try find mission from cache
  let m = missions.find(x => x.id === missionId)
  if(!m){
    const { data } = await sb
      .from('missions')
      .select('id,title,type,status,origin,start_time,hours,payout_auec,tags')
      .eq('id', missionId)
      .maybeSingle()
    m = data || {}
  }

  const name = m.title || title || '(untitled)'
  attTitleEl.textContent   = name
  attSummaryEl.textContent = [m.type, m.status].filter(Boolean).join(' • ')
  const metaParts = []
  if(m.start_time) metaParts.push(fmtDate(m.start_time))
  if(m.origin)     metaParts.push(m.origin)
  if(m.hours)      metaParts.push(`${m.hours} hrs`)
  if(m.payout_auec)metaParts.push(`${fmtNum(m.payout_auec)} aUEC`)
  attMetaEl.innerHTML = metaParts.join(' · ')

  await loadAttendees()
  const sess = await getSession()
  wireAttendanceButtons(sess.user)
}

// expose so the inline onclick works
window.openAttendance = openAttendance

/* Wire search + load */
searchInput.addEventListener('input', ()=>{
  renderAll()
  // ongoing stays as "true ongoing" list, not filtered by text
})

await loadMissions()
</script>

<!-- highlight nav -->
<script>
(() => {
  const here = location.pathname.split('/').pop() || 'mission-log.html';
  document.querySelectorAll('.nav-btn').forEach(a=>{
    if(a.getAttribute('href')===here){a.classList.add('active')}
  });
})();
</script>
</body>
</html>
