<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Mission Log</title>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">
<style>
:root{
  --bg:#000; --panel:#0b0b0b; --row:#0a0a0a;
  --border:#d6b44c; --accent:#f2d675; --text:#f7f1d0; --muted:#c9b06a;
}
*{box-sizing:border-box}
body{background:#000;color:var(--text);font-family:'Play',system-ui,sans-serif;margin:0;padding:20px}

h1,h2,h3{margin:0;font-weight:700}
a{color:var(--accent)}

/* Layout */
.page{max-width:1200px;margin:0 auto}
.brand{display:flex;align-items:center;gap:12px;margin-bottom:16px}
.brand-logo{width:40px;height:40px;border-radius:8px;object-fit:cover}
.brand-title{font-size:20px;letter-spacing:1px}
.brand-sub{font-size:12px;color:var(--muted)}

/* Nav */
.nav{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.nav-btn{
  display:inline-flex;align-items:center;justify-content:center;
  padding:7px 14px;border:1px solid var(--ring);border-radius:999px;
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:#f2d675;text-decoration:none;font-weight:700;letter-spacing:.2px;
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.12);
  transition:transform .15s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
}
.nav-btn:hover{transform:translateY(-1px);box-shadow:0 0 12px rgba(214,180,76,.25), inset 0 0 0 1px rgba(214,180,76,.18)}
.nav-btn.active{color:#000;background:linear-gradient(180deg,#f2d675,#e7c760);border-color:var(--ring)}

/* Toolbar */
.toolbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.btn-cta{
  display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);
  border-radius:12px;background:linear-gradient(180deg,#0c0c0c,#060606);color:var(--accent);
  text-decoration:none;font-weight:700
}
.btn-cta:hover{background:linear-gradient(180deg,#f2d675,#e7c760);color:#000}
input[type="search"]{
  width:260px;background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:8px 10px;color:var(--text)
}
.subtle{color:var(--muted);font-size:12px}

/* Panel */
.panel{
  background:
    radial-gradient(900px 400px at 110% -10%,rgba(242,214,117,.04),transparent 50%),
    #050505;
  border-radius:16px;
  border:1px solid rgba(214,180,76,.6);
  box-shadow:0 18px 40px rgba(0,0,0,.9),
             0 0 0 1px rgba(0,0,0,.7),
             inset 0 0 0 1px rgba(214,180,76,.18);
  padding:14px 16px 16px;
}
.panel-head{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px}
.panel-title{font-size:16px;letter-spacing:.8px;text-transform:uppercase}
.panel-meta{font-size:12px;color:var(--muted)}

/* Table */
.table-wrap{
  border-radius:10px;
  border:1px solid rgba(214,180,76,.5);
  overflow:auto;
  background:
    linear-gradient(180deg,rgba(242,214,117,.04),transparent 60%),
    radial-gradient(800px 400px at -20% -20%,rgba(242,214,117,.06),transparent 50%),
    #050505;
}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{padding:6px 8px;border-bottom:1px solid rgba(214,180,76,.2)}
th{
  text-align:left;
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.08em;
  color:var(--muted);
  background:radial-gradient(800px 300px at 50% -40%,rgba(242,214,117,.16),transparent 60%),#080808;
}
tbody tr:nth-child(even){background:rgba(255,255,255,.01)}
tbody tr:hover{background:rgba(242,214,117,.06)}
.nowrap{white-space:nowrap}
.mono{font-family:system-ui,monospace}

/* Pills + Links */
.pill{
  display:inline-flex;align-items:center;justify-content:center;
  padding:2px 8px;border-radius:999px;
  border:1px solid rgba(214,180,76,.6);
  background:rgba(214,180,76,.12);color:var(--accent);
  font-size:10px;text-transform:uppercase;letter-spacing:.08em;
}
.link{color:var(--accent);text-decoration:none;font-size:11px}
.link:hover{text-decoration:underline}

/* Attendance modal (operations-style) */
.modal-bg{
  position:fixed;inset:0;
  background:rgba(0,0,0,.75);
  display:none;
  align-items:center;justify-content:center;
  z-index:20;
}
.modal{
  width:min(720px,95vw);
  background:
    radial-gradient(900px 400px at 110% -10%,rgba(242,214,117,.06),transparent 50%),
    #0b0b0b;
  border-radius:14px;
  border:1px solid var(--border);
  box-shadow:0 14px 36px rgba(0,0,0,.6),
             0 0 26px rgba(214,180,76,.25),
             inset 0 0 0 1px rgba(214,180,76,.08);
}
.modal-head{
  padding:12px 14px;
  border-bottom:1px solid rgba(214,180,76,.35);
  display:flex;align-items:center;justify-content:space-between;
}
.modal-title{font-weight:700;color:var(--accent)}
.modal-body{
  padding:10px 14px;
  max-height:70vh;
  overflow:auto;
  font-size:var(--fs-table);
}
.modal-footer{
  padding:8px 14px;
  border-top:1px solid rgba(214,180,76,.35);
  display:flex;justify-content:flex-end;gap:8px;
}
.modal-close{
  border-radius:999px;border:1px solid var(--border);
  background:#050505;color:var(--accent);
  padding:4px 9px;font-size:12px;cursor:pointer;
}
.modal-close:hover{background:var(--accent);color:#000}
.att-title{font-weight:600;margin-bottom:4px}
.att-meta{font-size:var(--fs-small);color:var(--muted);margin-bottom:6px}
.att-table{
  width:100%;border-collapse:collapse;font-size:var(--fs-table);margin-top:4px;
}
.att-table th,.att-table td{
  padding:6px 8px;border-bottom:1px solid rgba(214,180,76,.25);
}
.att-actions{
  display:flex;flex-wrap:wrap;align-items:center;gap:6px;
  margin:4px 0 8px;
}
.small-btn{
  border-radius:999px;
  border:1px solid var(--border);
  background:#050505;
  color:var(--accent);
  padding:4px 10px;
  font-size:11px;
  cursor:pointer;
}
.small-btn:hover{
  background:var(--accent);
  color:#000;
}
.hidden{display:none !important}
</style>
</head>
<body>

<!-- Brand -->
<div class="brand">
  <img class="brand-logo" src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" alt="JMBN">
  <div>
    <div class="brand-title">JMBN Mission Log</div>
    <div class="brand-sub">Supabase-linked mission records</div>
  </div>
</div>

<div class="page">

  <!-- Nav -->
  <nav class="nav">
    <a class="nav-btn" href="index.html">Manifest</a>
    <a class="nav-btn" href="hangar.html">Hangar</a>
    <a class="nav-btn" href="components.html">Components</a>
    <a class="nav-btn" href="contracts.html">Contracts</a>
    <a class="nav-btn active" href="mission-log.html">Mission Log</a>
  </nav>

  <!-- Toolbar -->
  <div class="toolbar">
    <input id="search" type="search" placeholder="Search title / type / tags / status...">
    <span class="subtle">Click Attendance to view & update crew.</span>
  </div>

  <!-- Panel -->
  <div class="panel">
    <div class="panel-head">
      <div>
        <div class="panel-title">Mission Log</div>
        <div class="panel-meta">Pulled live from <code>missions</code> (Supabase)</div>
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Mission Title</th>
            <th>Type</th>
            <th>Status</th>
            <th>Origin</th>
            <th class="nowrap">Crew</th>
            <th class="nowrap">Date</th>
            <th class="nowrap">No. of Hours</th>
            <th class="nowrap">Payout (aUEC)</th>
            <th>Tags</th>
            <th>Attachments</th>
            <th>Notes</th>
            <th class="nowrap">Attendance</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Attendance Modal -->
<div class="modal-bg" id="attModalBg">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title" id="attTitle">Mission</div>
      <button type="button" class="modal-close" id="attClose">✕</button>
    </div>
    <div class="modal-body">
      <div class="att-title" id="attSummary"></div>
      <div class="att-meta" id="attMeta"></div>

      <div class="att-actions">
        <button class="small-btn" id="attIamGoing">I'm going</button>
        <button class="small-btn" id="attNotGoing">Not going</button>
        <button class="small-btn" id="attWithdraw">Withdraw</button>
        <span class="subtle" id="attAuthHint"></span>
      </div>

      <table class="att-table" id="attTable"></table>
    </div>
    <div class="modal-footer">
      <button type="button" class="modal-close" id="attClose2">Close</button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const SUPABASE_URL  = 'https://fcegavhipeaeihxegsnw.supabase.co'
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjZWdhdmhpcGVhZWloeGVnc253Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTA2NDQzNzEsImV4cCI6MjAyNjIyMDM3MX0.gXpqQdajVS2iei1e-2gK5Z84p1doPv93FwsVbVyJMyU'
const sb = createClient(SUPABASE_URL, SUPABASE_ANON)

const tbody = document.getElementById('tbody')
const search = document.getElementById('search')
let cache = []

const esc = (s='') => {
  const d=document.createElement('div'); d.textContent=s; return d.innerHTML
}
const fmtDate = iso => iso ? new Date(iso).toLocaleString() : ''
const fmtNum = n => (n||n===0) ? Number(n).toLocaleString() : ''
const pill = t => t ? `<span class="pill">${esc(t)}</span>` : ''

function attachmentsCell(arr){
  if(!Array.isArray(arr) || !arr.length) return ''
  return arr.map((a,i)=>{
    const name = a?.name?.trim() || `Attachment ${i+1}`
    const url  = a?.url || '#'
    return `<a class="link" href="${esc(url)}" target="_blank" rel="noopener">${esc(name)}</a>`
  }).join(', ')
}

// === Crew & Attendance state ===
let missionCrewCounts = {};
let session = null;
let ATT_MISSION_ID = null;

// Attendance modal elements
const attBg        = document.getElementById('attModalBg');
const attTitleEl   = document.getElementById('attTitle');
const attSummaryEl = document.getElementById('attSummary');
const attMetaEl    = document.getElementById('attMeta');
const attTable     = document.getElementById('attTable');
const attAuthHint  = document.getElementById('attAuthHint');
const btnGoing     = document.getElementById('attIamGoing');
const btnNotGoing  = document.getElementById('attNotGoing');
const btnWithdraw  = document.getElementById('attWithdraw');
const btnClose     = document.getElementById('attClose');
const btnClose2    = document.getElementById('attClose2');

function crewCount(id){
  return missionCrewCounts[id] || 0;
}

function rowHtml(r){
  return `
    <tr>
      <td>${esc(r.title||'(untitled)')}</td>
      <td>${pill(r.type)}</td>
      <td>${pill(r.status)}</td>
      <td>${esc(r.origin||'')}</td>
      <td class="mono">${crewCount(r.id)}</td>
      <td class="nowrap mono">${fmtDate(r.start_time)}</td>
      <td class="mono">${r.hours ?? ''}</td>
      <td class="mono">${fmtNum(r.payout_auec)}</td>
      <td>${esc(r.tags||'')}</td>
      <td>${attachmentsCell(r.attachments)}</td>
      <td>${esc(r.notes||'')}</td>
      <td><button class="small-btn" onclick="openAttendance('${r.id}','${esc(r.title||'')}')">View</button></td>
    </tr>`;
}

function render(rows){
  tbody.innerHTML = rows.map(rowHtml).join('') ||
    `<tr><td colspan="12" style="padding:12px;color:var(--muted)">No missions found.</td></tr>`;
}

function filter(){
  const q = (search.value||'').toLowerCase();
  if(!q){ render(cache); return; }
  render(cache.filter(r =>
    (r.title||'').toLowerCase().includes(q) ||
    (r.type||'').toLowerCase().includes(q) ||
    (r.status||'').toLowerCase().includes(q) ||
    (r.tags||'').toLowerCase().includes(q)
  ));
}

async function computeCrewCounts(){
  missionCrewCounts = {};
  if(!cache.length) return;
  const ids = cache.map(r=>r.id).filter(Boolean);
  if(!ids.length) return;
  try{
    const { data, error } = await sb
      .from('v_mission_attendees_detailed')
      .select('mission_id')
      .in('mission_id', ids);
    if(error){
      console.warn('crew count error', error);
      return;
    }
    for(const row of (data||[])){
      missionCrewCounts[row.mission_id] = (missionCrewCounts[row.mission_id]||0)+1;
    }
  }catch(e){
    console.warn('crew count error', e);
  }
}

async function load(){
  const { data, error } = await sb.from('missions')
    .select('id,title,type,status,origin,destination,start_time,hours,payout_auec,tags,attendees,attachments,notes')
    .order('created_at',{ascending:false});
  if(error){
    tbody.innerHTML = `<tr><td colspan="12" style="padding:12px;color:var(--muted)">Failed to load missions: ${esc(error.message)}</td></tr>`;
    return;
  }
  cache = data || [];
  await computeCrewCounts();
  render(cache);
}

async function getSession(){
  if(session!==null) return session;
  try{
    const { data, error } = await sb.auth.getUser();
    if(error){
      console.warn('auth error', error);
      session = { user:null };
    }else{
      session = { user:data.user || null };
    }
  }catch(e){
    console.warn('auth error', e);
    session = { user:null };
  }
  return session;
}

function closeAttendance(){
  ATT_MISSION_ID = null;
  if(attBg) attBg.style.display='none';
}

if(btnClose) btnClose.onclick = closeAttendance;
if(btnClose2) btnClose2.onclick = closeAttendance;
if(attBg){
  attBg.addEventListener('click', e=>{
    if(e.target===attBg) closeAttendance();
  });
}

async function loadAttendees(){
  if(!ATT_MISSION_ID || !attTable) return;
  attTable.innerHTML = '<tr><td class="small">Loading attendees…</td></tr>';
  try{
    const { data, error } = await sb
      .from('v_mission_attendees_detailed')
      .select('*')
      .eq('mission_id', ATT_MISSION_ID)
      .order('joined_at',{ascending:true});
    if(error){
      attTable.innerHTML = `<tr><td class="small" style="color:var(--muted)">Failed to load attendees: ${esc(error.message)}</td></tr>`;
      return;
    }
    const rows = data || [];
    if(!rows.length){
      attTable.innerHTML = '<tr><td class="small">No attendees yet.</td></tr>';
      return;
    }
    let html = '<thead><tr><th>Name</th><th>Role</th><th>Status</th><th class="nowrap">Joined</th></tr></thead><tbody>';
    for(const a of rows){
      html += `<tr>
        <td>${esc(a.attendee_name || a.user_email || '')}</td>
        <td>${esc(a.role_in_mission || '')}</td>
        <td>${esc(a.attendance || '')}</td>
        <td class="mono small">${a.joined_at ? fmtDate(a.joined_at) : ''}</td>
      </tr>`;
    }
    html += '</tbody>';
    attTable.innerHTML = html;
  }catch(e){
    attTable.innerHTML = '<tr><td class="small" style="color:var(--muted)">Failed to load attendees.</td></tr>';
  }
}

function wireSelfButtons(user){
  if(!user){
    if(attAuthHint) attAuthHint.textContent = 'Log in to mark your attendance.';
    if(btnGoing) btnGoing.disabled = true;
    if(btnNotGoing) btnNotGoing.disabled = true;
    if(btnWithdraw) btnWithdraw.disabled = true;
    return;
  }
  if(attAuthHint) attAuthHint.textContent = '';
  const uid = user.id;
  if(btnGoing) btnGoing.onclick = async () => {
    await sb.from('mission_attendees').upsert({
      mission_id: ATT_MISSION_ID,
      user_id: uid,
      attendance: 'going'
    }, { onConflict: 'mission_id,user_id' });
    await computeCrewCounts();
    render(cache);
    await loadAttendees();
  };
  if(btnNotGoing) btnNotGoing.onclick = async () => {
    await sb.from('mission_attendees').upsert({
      mission_id: ATT_MISSION_ID,
      user_id: uid,
      attendance: 'not_going'
    }, { onConflict: 'mission_id,user_id' });
    await computeCrewCounts();
    render(cache);
    await loadAttendees();
  };
  if(btnWithdraw) btnWithdraw.onclick = async () => {
    await sb.from('mission_attendees')
      .delete()
      .match({ mission_id: ATT_MISSION_ID, user_id: uid });
    await computeCrewCounts();
    render(cache);
    await loadAttendees();
  };
}

async function openAttendance(missionId, title=''){
  ATT_MISSION_ID = missionId;
  if(attBg) attBg.style.display='flex';

  // Fetch mission details for header (use cache if possible)
  let mission = cache.find(m=>m.id===missionId);
  if(!mission){
    const { data } = await sb.from('missions')
      .select('id,title,type,status,origin,destination,start_time,hours,payout_auec,tags')
      .eq('id', missionId)
      .maybeSingle();
    mission = data || {};
  }

  const name = mission.title || title || '(untitled)';
  if(attTitleEl) attTitleEl.textContent = name;

  const summaryParts = [];
  if(mission.type) summaryParts.push(mission.type);
  if(mission.status) summaryParts.push(mission.status);
  if(attSummaryEl) attSummaryEl.textContent = summaryParts.join(' • ');

  const metaParts = [];
  if(mission.start_time) metaParts.push(fmtDate(mission.start_time));
  if(mission.origin || mission.destination) metaParts.push(`${esc(mission.origin||'')} → ${esc(mission.destination||'')}`);
  if(typeof mission.hours === 'number') metaParts.push(`${mission.hours} hrs`);
  if(mission.payout_auec) metaParts.push(`${fmtNum(mission.payout_auec)} aUEC`);
  if(attMetaEl) attMetaEl.innerHTML = metaParts.join(' · ');

  await loadAttendees();
  const sess = await getSession();
  wireSelfButtons(sess.user);
}

// expose for inline onclick
window.openAttendance = openAttendance;

// init
search.oninput = filter;
await load();
</script>

<!-- highlight nav -->
<script>
(() => {
  const here = location.pathname.split('/').pop() || 'mission-log.html';
  document.querySelectorAll('.nav-btn').forEach(a=>{
    if(a.getAttribute('href')===here){a.classList.add('active')}
  });
})();
</script>
</body>
</html>
