<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>JMBN Contracts</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--border:#d6b44c;--card:#141414;
  --accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;
  --fs-base:14px;--fs-small:11px;--fs-table:13px;--fs-h1:clamp(18px,2.2vw,22px);
}
*{box-sizing:border-box}
body{
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text);
  font-family:'Play',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  margin:0;padding:14px;letter-spacing:.25px;font-size:var(--fs-base);
}

/* Header + Nav (styles only; content injected from header.html) */
.brand{display:flex;align-items:center;gap:10px;margin:0 0 8px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.brand-logo{width:44px;height:44px;object-fit:contain;filter:drop-shadow(0 0 4px rgba(242,214,117,.25))}
.brand h1{font-weight:700;font-size:var(--fs-h1);color:var(--accent);margin:0}
.nav{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
.nav-btn{
  --gold:#f2d675;--gold2:#e7c760;--ring:#d6b44c;
  position:relative;display:inline-flex;align-items:center;justify-content:center;
  padding:7px 14px;border:1px solid var(--ring);border-radius:999px;
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);text-decoration:none;font-weight:700;
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.12);
  transition:transform .15s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
  overflow:hidden;
}
.nav-btn:hover{transform:translateY(-1px);box-shadow:0 0 12px rgba(214,180,76,.25), inset 0 0 0 1px rgba(214,180,76,.18);background:linear-gradient(180deg,#1a1a1a,#0a0a0a)}
.nav-btn.active{color:#000;background:linear-gradient(180deg,var(--gold),var(--gold2));border-color:var(--ring);box-shadow:0 0 20px rgba(214,180,76,.45)}
.nav-btn.active::after{
  content:"";position:absolute;inset:0;
  background:linear-gradient(120deg,rgba(255,255,255,0) 30%,rgba(255,255,255,.3) 50%,rgba(255,255,255,0) 70%);
  border-radius:inherit;transform:translateX(-120%);animation:shine 2.8s ease-in-out infinite;pointer-events:none;
}
@keyframes shine{0%{transform:translateX(-120%)}35%,100%{transform:translateX(120%)}}

/* Panels + controls */
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:8px;box-shadow:0 0 18px rgba(214,180,76,.22)}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
button{padding:7px 11px;border-radius:10px;background:linear-gradient(180deg,#0c0c0c,#060606);color:var(--accent);border:1px solid var(--border);cursor:pointer;font-family:'Play';transition:.2s}
button:hover{background:var(--accent);color:#000}
.btn-primary{background:var(--accent);color:#000}
input,select,textarea{background:#0a0a0a;border:1px solid var(--border);border-radius:8px;padding:9px;color:var(--text);font-size:var(--fs-table);font-family:'Play'}
textarea{resize:vertical}

/* Labels */
label{display:flex;flex-direction:column;gap:4px;font-size:13px;color:var(--muted)}

/* KPI cards */
.kpis{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin:8px 0 6px}
@media(max-width:880px){.kpis{grid-template-columns:1fr}}
.kpi{background:linear-gradient(180deg,#0b0b0b,#080808);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:0 0 14px rgba(214,180,76,.18), inset 0 0 0 1px rgba(214,180,76,.12)}
.kpi-title{font-size:12px;color:var(--muted);margin-bottom:6px}
.kpi-value{font-size:22px;font-weight:700;color:var(--accent);line-height:1}
.kpi-sub{font-size:12px;color:var(--muted);margin-top:4px}

/* Table */
.tableWrap{border:1px solid var(--border);border-radius:12px;overflow:auto;max-height:70vh;margin-top:10px}
table{width:100%;border-collapse:collapse;font-size:var(--fs-table)}
th,td{border-bottom:1px solid rgba(214,180,76,.3);padding:8px;text-align:left}
th{color:var(--accent);background:#080808;font-weight:500;font-size:12px}
tr:nth-child(even){background:#111}
tr:hover{background:rgba(214,180,76,.08)}
.small{font-size:var(--fs-small);color:var(--muted)}
.badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px;color:var(--muted)}

/* Modal */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:10}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;width:95%;max-width:520px;box-shadow:0 0 25px rgba(214,180,76,.3)}
.modal h2{color:var(--accent);margin:0 0 10px}
.form-grid{display:grid;gap:8px}
.modal-buttons{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
</style>
</head>
<body>

  <!-- ðŸ” Shared header injected here -->
  <div id="header-container"></div>
  <script>
    // Load shared header and highlight the active tab
    fetch('header.html')
      .then(r=>r.text())
      .then(html=>{
        document.getElementById('header-container').innerHTML = html;
        const here = location.pathname.split('/').pop() || 'contracts.html';
        document.querySelectorAll('.nav-btn').forEach(a=>{
          if(a.getAttribute('href')===here){
            a.classList.add('active'); a.setAttribute('aria-current','page');
          }
        });
      });
  </script>

  <div class="panel">
    <div class="controls">
      <input id="search" placeholder="Searchâ€¦ (name, commodity, type, origin, destination, notes)">
      <select id="typeFilter" title="Filter by Type">
        <option value="">All Types</option>
        <option>Hauling</option>
        <option>Mining</option>
        <option>Cargo</option>
        <option>Medical</option>
      </select>
      <button id="addBtn" class="btn-primary">Add Contract</button>
      <button id="saveBtn">Save</button>
      <button id="resetBtn" style="border-color:var(--bad);color:var(--bad)">Clear All</button>
      <button id="exportJSON">Export JSON</button>
      <button id="importJSON" class="btn-primary">Import JSON</button>
    </div>

    <!-- KPI -->
    <div class="kpis">
      <div class="kpi">
        <div class="kpi-title">Total Contracts</div>
        <div class="kpi-value" id="kpiCount">0</div>
        <div class="kpi-sub" id="kpiCountSub">after filters</div>
      </div>
      <div class="kpi">
        <div class="kpi-title">Total Payout (aUEC)</div>
        <div class="kpi-value" id="kpiTotal">0</div>
        <div class="kpi-sub">sum of rewards</div>
      </div>
      <div class="kpi">
        <div class="kpi-title">Average Payout / Contract</div>
        <div class="kpi-value" id="kpiAvg">0</div>
        <div class="kpi-sub">based on filtered list</div>
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Contract</th>
            <th>Commodity</th>
            <th>Type</th>
            <th>Origin</th>
            <th>Destination</th>
            <th>Reward (aUEC)</th>
            <th>Status</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal: Add -->
  <div class="modal-bg" id="modal-bg">
    <div class="modal">
      <h2>Add Contract</h2>
      <div class="form-grid">
        <label>Contract Name *<input id="cName" placeholder="e.g., RW S2 â€” 24-box Haul"></label>
        <label>Commodity<select id="cCommodity" title="Commodity"></select></label>
        <label>Type of Mission
          <select id="cType" title="Type">
            <option>Hauling</option><option>Mining</option><option>Cargo</option><option>Medical</option>
          </select>
        </label>
        <label>Origin<select id="cOrigin" title="Origin"></select></label>
        <label>Destination<select id="cDest" title="Destination"></select></label>
        <label>Reward (aUEC)<input id="cReward" placeholder="e.g., 48000"></label>
        <label>Status
          <select id="cStatus"><option>Available</option><option>Accepted</option><option>Completed</option></select>
        </label>
        <label>Notes<textarea id="cNotes" rows="3" placeholder="e.g., Night run, clear weather"></textarea></label>
      </div>
      <div class="modal-buttons">
        <button id="cancelModal">Cancel</button>
        <button id="saveModal" class="btn-primary">Add</button>
      </div>
    </div>
  </div>

  <!-- Modal: Edit -->
  <div class="modal-bg" id="edit-modal-bg">
    <div class="modal">
      <h2>Edit Contract</h2>
      <div class="form-grid">
        <label>Contract Name *<input id="eName"></label>
        <label>Commodity<select id="eCommodity"></select></label>
        <label>Type of Mission
          <select id="eType"><option>Hauling</option><option>Mining</option><option>Cargo</option><option>Medical</option></select>
        </label>
        <label>Origin<select id="eOrigin"></select></label>
        <label>Destination<select id="eDest"></select></label>
        <label>Reward (aUEC)<input id="eReward"></label>
        <label>Status
          <select id="eStatus"><option>Available</option><option>Accepted</option><option>Completed</option></select>
        </label>
        <label>Notes<textarea id="eNotes" rows="3"></textarea></label>
      </div>
      <div class="modal-buttons">
        <button id="cancelEdit">Cancel</button>
        <button id="saveEdit" class="btn-primary">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- ðŸ” Auth -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/auth.js"></script>

<script>
/* ===== Storage + helpers ===== */
const STORE='jmbn-contracts';
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const uid=()=> 'CT-'+Math.random().toString(36).slice(2,8);
function esc(s=''){const d=document.createElement('div');d.textContent=s??'';return d.innerHTML;}
function parseAUEC(val){ if(val==null) return 0; const n=Number(String(val).replace(/[^\d.-]/g,'')); return Number.isFinite(n)? n : 0; }
function fmt(n){ try{ return Number(n).toLocaleString('en-US'); }catch{ return String(n); } }

/* ===== DATA LISTS ===== */
const originList = `Ambitious Dream Station (CRU-L1), Anderson (HDMS-Anderson), ARC-L1 Wide Forest Station, ARC-L2 Lively Pathway Station, ARC-L3 Modern Express Station, ARC-L4 Faint Glen Station, ARC-L5 Yellow Core Station, ArcCorp Mining Area 045, ArcCorp Mining Area 048, ArcCorp Mining Area 056, ArcCorp Mining Area 061, ArcCorp Mining Area 141, ArcCorp Mining Area 157, Area18 (Riker Memorial Spaceport), Arid Reach, Ashland, Astorâ€™s Clearing, Baijini Point, Beautiful Glen Station (CRU-L5), Benson Mining Outpost, Blackrock Exchange, Bloodshot Ridge, Bountiful Harvest Hydroponics, Brioâ€™s Breaker Yard, Budâ€™s Growery, Bueno Ravine, Canard View, Casillo (HDPC-Casillo), Chawlaâ€™s Beach, Checkmate, Covalex Distribution Centre S1DC06, Covalex Distribution Centre S4DC05, CRU-L1 Ambitious Dream Station, CRU-L4 Shallow Fields Station, CRU-L5 Beautiful Glen Station, Cry-Astro Processing Plant 19-02, Cry-Astro Processing Plant 34-12, Cutterâ€™s Rig, Deakins Research Outpost, Devlin Scrap & Salvage, Dudley & Daughters, Dunboro, Dupree Industrial Manufacturing Facility, Endgame, Endless Odyssey Station (MIC-L3), Everus Harbor, Faithful Dream Station (HUR-L2), Faint Glen Station (ARC-L4), Fallow Field, Farnesway (HDPC-Farnesway), Finnâ€™s Folley, Frostbite, Frigid Knot, Gallete Family Farms, Gaslight, Gonerâ€™s Deal, Golden Riviera (The Golden Riviera), Grim HEX, Greycat Stanton I Production Complex-B, Greycat Stanton IV Production Complex A, Hadley (HDMS-Hadley), Harperâ€™s Point, Hickes Research Outpost, High Course Station (HUR-L5), Humboldt Mines, HUR-L1 Green Glade Station, HUR-L2 Faithful Dream Station, HUR-L3 Thundering Express Station, HUR-L4 Melodic Fields Station, HUR-L5 High Course Station, Jacksonâ€™s Swap, Jumptown, Kabirâ€™s Outpost, Kudre Ore, Last Landings, Lathan (HDMS-Lathan), Lively Pathway Station (ARC-L2), Lorville (Teasa Spaceport), Long Forest Station (MIC-L2), Loveridge Mineral Reserve, Ludlow, Magnus Gateway, Makerâ€™s Point, Megumi Refueling, Melodic Fields Station (HUR-L4), MIC-L1 Shallow Frontier Station, MIC-L2 Long Forest Station, MIC-L3 Endless Odyssey Station, MIC-L4 Red Crossroads Station, MIC-L5 Modern Icarus Station, Modern Express Station (ARC-L3), Modern Icarus Station (MIC-L5), Moreland Hills, Necropolis (The Necropolis), New Babbage Interstellar Spaceport, Norgaard (HDMS-Norgaard), NT-999-XX, Nuen Waste Management, Oparei (HDMS-Oparei), Orbituary, Orinth (Reclamation & Disposal Orinth), Orison (August Dunlow Spaceport), Orphanage (The Orphanage), Outpost 54, Paradise Cove, Patch City, Pickers Field, Pinewood (HDMS-Pinewood), Private Property (PRIVATE PROPERTY), Pyro Gateway, Rappel, Ravenâ€™s Roost, Razorâ€™s Edge, Rayari Anvik Research Outpost, Rayari Cantwell Research Outpost, Rayari Deltana Research Outpost, Rayari Kaltag Research Outpost, Rayari McGrath Research Outpost, Ratâ€™s Nest, Riker Memorial Spaceport (Area18), Rodâ€™s Fuel â€™N Supplies, Rough Landing, Ruin Station, Rustville, Ryder (HDMS-Ryder), Sacrenâ€™s Plot, Sakura Sun Goldenrod Workcenter, Sakura Sun Magnolia Workcenter, Samson & Sonâ€™s Salvage Center, SCD-1 (Shubin Mining Facility SCD-1), Seerâ€™s Canyon, Seraphim Station, Shady Glen Farms, Shallow Fields Station (CRU-L4), Shallow Frontier Station (MIC-L1), Shepherdâ€™s Rest, Shubin Mining Facility SAL-2, Shubin Mining Facility SAL-5, Shubin Mining Facility SCD-1, Shubin Mining Facility SM0-10, Shubin Mining Facility SM0-13, Shubin Mining Facility SM0-18, Shubin Mining Facility SM0-22, Shubin Mining Facility SMCa-6, Shubin Mining Facility SMCa-8, S4DC05 (Covalex Distribution Centre S4DC05), S4LD01 (Microtech Logistics Depot S4LD01), S4LD13 (Microtech Logistics Depot S4LD13), Stanhope (HDMS-Stanhope), Starlight Service Station, Sunset Mesa, Teasa Spaceport (Lorville), Terra Gateway, Terra Mills HydroFarm, Thedus (HDMS-Thedus), Thundering Express Station (HUR-L3), Tram & Myers Mining, Port Tressler, Weeping Cove, Wide Forest Station (ARC-L1), Woodruff (HDMS-Woodruff), XenoThreat Security Station, Yellow Core Station (ARC-L5), Zephyr`.split(',');
const commodities = `AcryliPlex Composite, Agricium, Agricium (Ore), Agricultural Supplies, Altruciatoxin, Aluminum, Aluminum (Ore), Aluminium, Aluminium (Ore), Amioshi Plague, Ammonia, Aphorite, Apoxygenite, Argon, Astatine, Atlasium, Beryl, Beryl (Raw), Bexalite, Bexalite (Raw), Bioplastic, Blue Bilva, Borase, Borase (Ore), CK13-GID Seed Blend, Carbon, Carbon Silk, Chlorine, Cobalt, CompBoard, Construction Materials, Copper, Copper (Ore), Corundum, Corundum (Raw), DCSR2, Decari Pod, Degnous Root, Diamond, Diamond (Raw), Diamond Laminate, Diluthermex, Distilled Spirits, Dolivine, Dopple, Dymantium, DynaFlex, E-Tam, Elespo, Fireworks, Fluorine, Fotia Seedpod, Freeze, Fresh Food, Gasping Weevil Eggs, Glow, Gold, Gold (Ore), Golden Medmon, HLX99 Hyperprocessors, Hadanite, Heart of the woods, Helium, Hephaestanite, Hephaestanite (Ore), HexaPolyMesh Coating, Human Food Bars, Hydrogen, Hydrogen Fuel, Inert Materials, Iodine, Iron, Iron (Ore), Janalite, Jumping Limes, Kopion Horn, Laranite, Laranite (Ore), Lastaprene, Luminalia Gift, Lunes, Lycara, Mala, Marok Gem, Maze, MedPens, Medical Supplies, Mercury, Methane, Neograph, Neon, Nitrogen, Omnapoxy, Osoian Hides, Oxypen, Oza, Partillium, Pingala Seeds, Pitambu, Potassium, Pressurized Ice, Processed Food, Prota, Quantainium, Quantainium (Raw), Quantum Fuel, Quartz, Quartz (Raw), RS1 Odyssey Spacesuits, Ranta Dung, Raw Ice, Recycled Material Composite, Redfin Energy Modulators, Revenant Pod, Revenant Tree Pollen, Riccite, SLAM, Sarilus, Scrap, Ship Ammunition, Silicon, Silnex, Souvenirs, Steel, Stileron, Stims, Stone Bug Shell, Sunset Berries, Taranite, Taranite (Raw), Thermal Foam, Thrust, Tin, Titanium, Titanium (Ore), Tritium, Tungsten, Tungsten (Ore), Uncut SLAM, Waste, WiDoW, XaPyen, ZetaProlanide`.split(',');

/* Populate selects */
function populateSelect(sel, list){
  if(!sel) return;
  sel.innerHTML = '';
  const o0 = document.createElement('option');
  o0.value = ''; o0.textContent = '-- select --';
  sel.appendChild(o0);
  list.forEach(v=>{
    const t=(v||'').trim(); if(!t) return;
    const o=document.createElement('option'); o.value=t; o.textContent=t; sel.appendChild(o);
  });
}

let contracts=[];

/* Load + Save */
function load(){
  const raw=localStorage.getItem(STORE);
  contracts = raw ? JSON.parse(raw) : [];
  contracts.forEach(c=>{ if(c.commodity==null)c.commodity=''; if(c.type==null)c.type=''; });

  populateSelect(document.getElementById('cCommodity'), commodities);
  populateSelect(document.getElementById('cOrigin'), originList);
  populateSelect(document.getElementById('cDest'), originList);

  render();
}
function save(){ localStorage.setItem(STORE, JSON.stringify(contracts)); }
document.getElementById('saveBtn').onclick=save;
document.getElementById('resetBtn').onclick=()=>{ if(confirm('Clear all contracts?')){ contracts=[]; save(); render(); } };

/* Add Modal */
const addBG=document.getElementById('modal-bg');
document.getElementById('addBtn').onclick=()=>{ addBG.style.display='flex'; };
document.getElementById('cancelModal').onclick=()=>{ addBG.style.display='none'; clearAddForm(); };
document.getElementById('saveModal').onclick=()=>{
  const name=document.getElementById('cName').value.trim(); if(!name){ alert('Name required'); return; }
  const now=new Date().toLocaleString();
  const obj={
    id:uid(), time:now, name,
    commodity: document.getElementById('cCommodity').value.trim(),
    type: document.getElementById('cType').value,
    origin: document.getElementById('cOrigin').value.trim(),
    destination: document.getElementById('cDest').value.trim(),
    reward: document.getElementById('cReward').value.trim(),
    status: document.getElementById('cStatus').value,
    notes: document.getElementById('cNotes').value.trim()
  };
  contracts.push(obj);
  save(); render(); addBG.style.display='none'; clearAddForm();
};
function clearAddForm(){
  ['cName','cReward','cNotes'].forEach(id=>document.getElementById(id).value='');
  ['cCommodity','cOrigin','cDest','cType','cStatus'].forEach(id=>document.getElementById(id).selectedIndex=0);
}

/* KPIs */
function updateKPIs(arr){
  const count = arr.length;
  let total = 0;
  for(const c of arr){ total += parseAUEC(c.reward); }
  const avg = count ? total / count : 0;
  document.getElementById('kpiCount').textContent = fmt(count);
  document.getElementById('kpiTotal').textContent = fmt(total);
  document.getElementById('kpiAvg').textContent   = fmt(Math.round(avg));
}

/* Filter + Render */
function getFiltered(){
  const q=(document.getElementById('search').value||'').toLowerCase();
  const tf=(document.getElementById('typeFilter').value||'').toLowerCase();
  let arr=contracts.slice();
  if(tf) arr=arr.filter(x=>(x.type||'').toLowerCase()===tf);
  if(q) arr=arr.filter(x=>
    `${x.name} ${x.commodity||''} ${x.type||''} ${x.origin||''} ${x.destination||''} ${x.notes||''}`.toLowerCase().includes(q)
  );
  return arr;
}
function render(){
  const arr=getFiltered();
  updateKPIs(arr);
  document.getElementById('rows').innerHTML=arr.map(c=>`
    <tr>
      <td>${esc(c.time||'-')}</td>
      <td><b style="color:var(--accent)">${esc(c.name)}</b></td>
      <td>${esc(c.commodity||'-')}</td>
      <td>${c.type?`<span class="badge">${esc(c.type)}</span>`:'-'}</td>
      <td>${esc(c.origin||'')}</td>
      <td>${esc(c.destination||'')}</td>
      <td>${esc(c.reward||'')}</td>
      <td>${c.status?`<span class="badge">${esc(c.status)}</span>`:''}</td>
      <td>${esc(c.notes||'')}</td>
      <td style="white-space:nowrap">
        <button data-act="edit" data-id="${c.id}">Edit</button>
        <button data-act="del" data-id="${c.id}" style="border-color:var(--bad);color:var(--bad)">Del</button>
      </td>
    </tr>`).join('');

  Array.from(document.querySelectorAll('#rows button[data-act]')).forEach(b=>{
    const id=b.dataset.id;
    if(b.dataset.act==='edit') b.onclick=()=>edit(id);
    if(b.dataset.act==='del')  b.onclick=()=>{ if(confirm('Delete this contract?')){ contracts=contracts.filter(x=>x.id!==id); save(); render(); } };
  });
}
document.getElementById('search').addEventListener('input', render);
document.getElementById('typeFilter').addEventListener('input', render);

/* Edit modal */
const editBG=document.getElementById('edit-modal-bg');
document.getElementById('cancelEdit').onclick=()=>{ editBG.style.display='none'; };

function edit(id){
  const c=contracts.find(x=>x.id===id); if(!c) return;
  populateSelect(document.getElementById('eCommodity'), commodities);
  populateSelect(document.getElementById('eOrigin'), originList);
  populateSelect(document.getElementById('eDest'), originList);

  document.getElementById('eName').value = c.name||'';
  document.getElementById('eCommodity').value = c.commodity||'';
  document.getElementById('eType').value = c.type||'';
  document.getElementById('eOrigin').value = c.origin||'';
  document.getElementById('eDest').value = c.destination||'';
  document.getElementById('eReward').value = c.reward||'';
  document.getElementById('eStatus').value = c.status||'Available';
  document.getElementById('eNotes').value = c.notes||'';

  editBG.style.display='flex';

  document.getElementById('saveEdit').onclick = () => {
    c.name = document.getElementById('eName').value.trim();
    c.commodity = document.getElementById('eCommodity').value.trim();
    c.type = document.getElementById('eType').value;
    c.origin = document.getElementById('eOrigin').value.trim();
    c.destination = document.getElementById('eDest').value.trim();
    c.reward = document.getElementById('eReward').value.trim();
    c.status = document.getElementById('eStatus').value;
    c.notes = document.getElementById('eNotes').value.trim();
    save(); render(); editBG.style.display='none';
  };
}

/* Export / Import */
document.getElementById('exportJSON').onclick=()=>{
  const blob=new Blob([JSON.stringify(contracts,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='jmbn-contracts.json';a.click();
  URL.revokeObjectURL(url);
};
document.getElementById('importJSON').onclick=()=>{
  const inp=document.createElement('input');inp.type='file';inp.accept='application/json';
  inp.onchange=()=>{
    const f=inp.files?.[0];if(!f)return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const arr=JSON.parse(r.result);
        if(!Array.isArray(arr)) throw new Error('Invalid JSON');
        arr.forEach(x=>{ if(!x.id) x.id=uid(); if(x.commodity==null) x.commodity=''; if(x.type==null) x.type=''; });
        if(confirm('Merge with existing? Click Cancel to REPLACE.')){
          const map=new Map(contracts.map(x=>[x.id,x])); arr.forEach(x=>map.set(x.id,x)); contracts=[...map.values()];
        }else{ contracts=arr; }
        save(); render(); alert('Import complete');
      }catch(e){ alert('Import failed: '+e.message); }
    };
    r.readAsText(f);
  };
  inp.click();
};

/* Init (Auth gate) */
document.addEventListener('DOMContentLoaded', async () => {
  const session = await requireAuth();   // redirects to auth.html if not logged in
  if (!session) return;
  load();
});
</script>
</body>
</html>
