<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JMBN – Earnings Ledger</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png"
      href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png"
      sizes="32x32">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--sub:#101010;
  --border:#d6b44c;--row:#080808;
  --accent:#f2d675;--accent-soft:#e0c66d;
  --text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;--good:#37d996;
  --fs-base:14px;--fs-small:11px;--fs-table:13px;--fs-h1:clamp(18px,2.2vw,22px);
}
*{box-sizing:border-box}
body{
  margin:0;padding:14px;
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text);
  font-family:'Play',system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
  font-size:var(--fs-base);letter-spacing:.25px;
}

/* Header2 mount */
#header2-mount{margin-bottom:6px}

/* Panels */
.panel{
  background:var(--panel);
  border-radius:14px;
  border:1px solid var(--border);
  padding:12px;
  box-shadow:0 0 22px rgba(214,180,76,.32), inset 0 0 0 1px rgba(214,180,76,.18);
  margin-bottom:10px;
}
.section-title{
  font-size:13px;
  color:var(--accent);
  text-transform:uppercase;
  letter-spacing:.16em;
  margin:0 0 4px;
}
.subtle{font-size:var(--fs-small);color:var(--muted)}

/* Overview cards */
.overview-grid{
  display:grid;
  grid-template-columns:repeat(4,minmax(0,1fr));
  gap:8px;
  margin-top:6px;
}
@media(max-width:900px){.overview-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media(max-width:520px){.overview-grid{grid-template-columns:1fr}}
.stat{
  background:linear-gradient(180deg,#0c0c0c,#050505);
  border-radius:12px;
  border:1px solid var(--border);
  padding:8px 10px;
  box-shadow:0 0 12px rgba(214,180,76,.25), inset 0 0 0 1px rgba(214,180,76,.12);
}
.stat-label{
  font-size:11px;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:.12em;
  margin-bottom:3px;
}
.stat-value{
  font-size:20px;
  font-weight:700;
  color:var(--accent);
}
.stat-sub{font-size:11px;color:var(--muted);margin-top:2px}
.mono{font-variant-numeric:tabular-nums}

/* Pills for meta line */
.pills-row{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-top:6px;
}
.pill{
  display:inline-flex;
  align-items:center;
  gap:6px;
  border-radius:999px;
  border:1px solid var(--border);
  padding:3px 9px;
  font-size:11px;
  background:#050505;
  color:var(--muted);
}
.pill-dot{
  width:7px;height:7px;border-radius:50%;background:var(--accent);
}

/* Mission table */
.controls{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin:6px 0 8px;
  align-items:center;
}
input[type="search"]{
  background:#050505;
  border:1px solid var(--border);
  border-radius:999px;
  padding:8px 12px;
  color:var(--text);
  font-size:var(--fs-table);
  min-width:220px;
}
.filter-toggle{
  padding:7px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--muted);
  font-size:11px;
  cursor:pointer;
}
.filter-toggle.active{
  color:#000;
  background:linear-gradient(180deg,var(--accent),var(--accent-soft));
  box-shadow:0 0 14px rgba(214,180,76,.45);
}
select{
  background:#050505;
  border-radius:999px;
  border:1px solid var(--border);
  padding:7px 10px;
  color:var(--text);
  font-size:11px;
}

/* Table */
.tableWrap{
  border-radius:12px;
  border:1px solid var(--border);
  overflow:auto;
  max-height:62vh;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:var(--fs-table);
  min-width:720px;
}
th,td{
  padding:8px 9px;
  border-bottom:1px solid rgba(214,180,76,.28);
  text-align:left;
}
th{
  font-size:11px;
  color:var(--accent);
  background:#080808;
  text-transform:uppercase;
  letter-spacing:.14em;
  position:sticky;
  top:0;
  z-index:1;
}
tbody tr:nth-child(even){background:#111}
tbody tr:hover{background:rgba(214,180,76,.10)}
.mission-title{
  font-weight:700;
}
.mission-id{
  font-size:11px;
  color:var(--muted);
}
.badge-status{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:3px 9px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#050505;
  font-size:11px;
}
.badge-dot{
  width:7px;height:7px;border-radius:50%;background:var(--muted);
}
.badge-dot.good{background:var(--good)}
.badge-dot.bad{background:var(--bad)}
.text-right{text-align:right}
.text-center{text-align:center}

/* Toast */
.toast{
  position:fixed;right:16px;bottom:16px;
  background:#111;border:1px solid var(--border);border-radius:10px;
  padding:8px 12px;font-size:12px;color:var(--text);
  box-shadow:0 0 18px rgba(214,180,76,.32);
  max-width:320px;z-index:40;
}
.toast.bad{border-color:var(--bad);color:#ffd0d0}
</style>
</head>
<body>

<div id="header2-mount"></div>

<section class="panel">
  <div class="section-title">Personal Earnings Overview</div>
  <div class="subtle" id="overviewUser">Reference-only ledger.</div>

  <div class="overview-grid">
    <div class="stat">
      <div class="stat-label">Total Missions Paid</div>
      <div class="stat-value mono" id="statMissions">–</div>
      <div class="stat-sub">Any mission with a recorded payout row for you</div>
    </div>
    <div class="stat">
      <div class="stat-label">Total aUEC Earned</div>
      <div class="stat-value mono" id="statTotal">–</div>
      <div class="stat-sub">Sum of all final shares recorded</div>
    </div>
    <div class="stat">
      <div class="stat-label">Average Per Mission</div>
      <div class="stat-value mono" id="statAvg">–</div>
      <div class="stat-sub">Total / missions paid</div>
    </div>
    <div class="stat">
      <div class="stat-label">Best Mission</div>
      <div class="stat-value mono" id="statBest">–</div>
      <div class="stat-sub" id="statBestTitle">–</div>
    </div>
  </div>

  <div class="pills-row">
    <div class="pill">
      <span class="pill-dot"></span>
      <span id="pillLastPaid">Last paid mission: —</span>
    </div>
    <div class="pill">
      <span class="pill-dot"></span>
      <span id="pillBest">Best mission earned: —</span>
    </div>
  </div>
</section>

<section class="panel">
  <div class="section-title">Mission Earnings</div>
  <div class="subtle">Click a row to see a detailed breakdown for that mission (in admin ledger).</div>

  <div class="controls">
    <input id="search" type="search" placeholder="Search by mission title / ID">
    <button class="filter-toggle active" data-range="all">All time</button>
    <button class="filter-toggle" data-range="30">Last 30 days</button>
    <button class="filter-toggle" data-range="90">Last 90 days</button>
    <select id="statusFilter" aria-label="Status filter">
      <option value="">All statuses</option>
      <option value="Planned">Planned</option>
      <option value="Success">Success</option>
      <option value="Abort">Abort</option>
      <option value="Fail">Fail</option>
    </select>
  </div>

  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th style="width:15%">Date</th>
          <th style="width:32%">Mission</th>
          <th style="width:14%">Status</th>
          <th style="width:10%">Role / PG</th>
          <th style="width:14%" class="text-right">Mission Payout</th>
          <th style="width:15%" class="text-right">Your Share</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="6" class="subtle" style="padding:10px">Loading…</td></tr>
      </tbody>
    </table>
  </div>

  <div class="subtle" style="margin-top:6px">
    Note: this page is for reference only. Actual payouts are based on in-game transfers and admin records.
  </div>
</section>

<div id="toast" class="toast" style="display:none"></div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>

<script>
/* ---------- Header2 mount ---------- */
(async function mountHeader2(){
  const mount = document.getElementById('header2-mount');
  if(!mount) return;
  try{
    const res = await fetch('header2.html',{cache:'no-cache'});
    if(!res.ok) return;
    const html = await res.text();
    mount.innerHTML = html;

    // highlight nav
    requestAnimationFrame(()=>{
      const here = (location.pathname.split('/').pop() || 'earnings.html').toLowerCase();
      mount.querySelectorAll('.nav-btn').forEach(a=>{
        const href = (a.getAttribute('href')||'').toLowerCase();
        if(href === here) a.classList.add('active');
      });
    });
  }catch(e){
    console.warn('header2 failed',e);
  }
})();

/* ---------- Helpers ---------- */
const $ = s => document.querySelector(s);
const fmt = n => Number(n||0).toLocaleString('en-US',{maximumFractionDigits:0});
const esc = s => { const d=document.createElement('div'); d.textContent=s??''; return d.innerHTML; };

function showToast(msg,bad=false){
  const el = $('#toast');
  el.textContent = msg;
  el.className = 'toast' + (bad?' bad':'');
  el.style.display = 'block';
  setTimeout(()=>{ el.style.display='none'; }, 3200);
}

/* ---------- State ---------- */
let sb, me;
let RAW_ROWS = [];
let FILTER_RANGE = 'all';
let FILTER_STATUS = '';

/* ---------- Summary loader ---------- */
async function loadSummary(){
  try{
    const { data, error } = await sb
      .from('v_user_earnings_summary')
      .select('*')
      .eq('user_id', me)
      .maybeSingle();
    if(error){
      console.error(error);
      showToast('Failed to load summary',true);
      return;
    }
    const s = data || {};
    $('#overviewUser').textContent =
      `Reference-only ledger for ${s.handle || s.display_name || me.slice(0,8)}.`;

    $('#statMissions').textContent = s.missions_paid ? fmt(s.missions_paid) : '0';
    $('#statTotal').textContent    = s.total_earned ? fmt(s.total_earned) : '0';
    $('#statAvg').textContent      = s.missions_paid ? fmt(Math.round((s.total_earned||0)/(s.missions_paid||1))) : '0';
    $('#statBest').textContent     = s.best_mission_payout ? fmt(s.best_mission_payout) : '0';
    $('#statBestTitle').textContent= s.best_mission_title || '—';

    $('#pillLastPaid').textContent = s.last_paid_at
      ? `Last paid mission: ${new Date(s.last_paid_at).toLocaleString()}`
      : 'Last paid mission: —';

    $('#pillBest').textContent = s.best_mission_payout
      ? `Best mission earned ${fmt(s.best_mission_payout)} aUEC`
      : 'Best mission earned: —';
  }catch(e){
    console.error(e);
    showToast('Failed to load summary',true);
  }
}

/* ---------- Missions loader ---------- */
async function loadMissions(){
  try{
    const { data, error } = await sb
      .from('v_user_earnings_missions')
      .select('*')
      .eq('user_id', me)
      .order('start_time',{ascending:false});
    if(error){
      console.error(error);
      showToast('Failed to load missions',true);
      RAW_ROWS = [];
    }else{
      RAW_ROWS = data || [];
    }
    applyFiltersAndRender();
  }catch(e){
    console.error(e);
    showToast('Failed to load missions',true);
  }
}

/* ---------- Filters ---------- */
function applyFiltersAndRender(){
  const term = ($('#search').value || '').toLowerCase().trim();
  const now = Date.now();
  let rows = RAW_ROWS.slice();

  // time range
  if(FILTER_RANGE !== 'all'){
    const days = Number(FILTER_RANGE) || 0;
    const cutoff = now - days*24*60*60*1000;
    rows = rows.filter(r=>{
      const t = r.start_time ? new Date(r.start_time).getTime() : 0;
      return t >= cutoff;
    });
  }

  // status
  if(FILTER_STATUS){
    rows = rows.filter(r => (r.status || '').toLowerCase() === FILTER_STATUS.toLowerCase());
  }

  // text search
  if(term){
    rows = rows.filter(r=>{
      const hay = `${r.mission_title||''} ${r.mission_id||''}`.toLowerCase();
      return hay.includes(term);
    });
  }

  renderTable(rows);
}

function renderTable(rows){
  const tbody = $('#tbody');
  if(!rows.length){
    tbody.innerHTML = `<tr><td colspan="6" class="subtle" style="padding:10px">No missions found.</td></tr>`;
    return;
  }
  tbody.innerHTML = rows.map(r=>{
    const dt = r.start_time
      ? new Date(r.start_time).toLocaleString()
      : '—';
    const status = r.status || 'Unknown';
    const statusLower = status.toLowerCase();
    let badgeClass=''; // colour dot
    if(statusLower === 'success') badgeClass='good';
    else if(statusLower === 'fail' || statusLower === 'failed' || statusLower === 'abort') badgeClass='bad';

    const pg = r.paygrade || r.role_code || '—';
    const payout = r.mission_payout || 0;
    const share  = r.user_share || r.final_share || 0;

    return `
      <tr>
        <td>${esc(dt)}</td>
        <td>
          <div class="mission-title">${esc(r.mission_title || 'Untitled')}</div>
          <div class="mission-id">ID: ${esc(r.mission_id || r.id || '')}</div>
        </td>
        <td>
          <span class="badge-status">
            <span class="badge-dot ${badgeClass}"></span>
            <span>${esc(status)}</span>
          </span>
        </td>
        <td>${esc(pg)}</td>
        <td class="text-right mono">${payout ? fmt(payout) : '—'}</td>
        <td class="text-right mono">${share ? fmt(share) : '—'}</td>
      </tr>
    `;
  }).join('');
}

/* ---------- Events ---------- */
document.addEventListener('DOMContentLoaded', async ()=>{
  const session = await requireAuth();
  if(!session) return;
  sb = getSupabase();
  me = session.user.id;

  await loadSummary();
  await loadMissions();
});

$('#search').addEventListener('input', applyFiltersAndRender);
document.querySelectorAll('.filter-toggle').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.filter-toggle').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    FILTER_RANGE = btn.dataset.range || 'all';
    applyFiltersAndRender();
  });
});
$('#statusFilter').addEventListener('change',e=>{
  FILTER_STATUS = e.target.value || '';
  applyFiltersAndRender();
});
</script>
</body>
</html>