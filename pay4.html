<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JMBN – Earnings Ledger</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png"
      href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png"
      sizes="32x32">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--card:#101010;--row:#090909;
  --border:#d6b44c;
  --accent:#f2d675;--accent-soft:#c9b06a;
  --text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;--good:#37d996;
  --fs-base:14px;--fs-small:11px;--fs-table:13px;--fs-h1:clamp(18px,2.2vw,22px);
}
*{box-sizing:border-box}
body{
  margin:0;padding:14px;
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text);
  font-family:'Play',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  font-size:var(--fs-base);
  letter-spacing:.25px;
}

/* Fallback header (overwritten by header.html) */
#header-container .brand{
  display:flex;align-items:center;gap:10px;
  margin:0 0 8px;padding-bottom:6px;
  border-bottom:1px solid var(--border)
}
#header-container .brand-logo{
  width:44px;height:44px;object-fit:contain;
  filter:drop-shadow(0 0 4px rgba(242,214,117,.25))
}
#header-container .brand h1{
  font-weight:700;font-size:var(--fs-h1);color:var(--accent);margin:0
}

/* Panels */
.panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px 10px 12px;
  box-shadow:0 0 18px rgba(214,180,76,.22),inset 0 0 0 1px rgba(214,180,76,.14);
  margin-top:10px;
}
.panel-header{
  padding:4px 4px 8px;
  border-bottom:1px solid rgba(214,180,76,.4);
  margin-bottom:6px;
}
.panel-title{
  font-size:13px;
  color:var(--accent);
  text-transform:uppercase;
  letter-spacing:.16em;
  font-weight:700;
}
.panel-sub{
  font-size:11px;
  color:var(--muted);
  margin-top:2px;
}

/* Overview grid */
.overview-grid{
  display:grid;
  grid-template-columns:repeat(4,1fr);
  gap:8px;
}
@media(max-width:900px){.overview-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:520px){.overview-grid{grid-template-columns:1fr}}

.card{
  background:linear-gradient(180deg,#111,#090909);
  border-radius:12px;
  border:1px solid var(--border);
  padding:8px 10px;
  box-shadow:0 0 12px rgba(214,180,76,.2),inset 0 0 0 1px rgba(214,180,76,.18);
}
.card-label{
  font-size:11px;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:.12em;
  margin-bottom:3px;
}
.card-value{
  font-size:18px;
  font-weight:700;
  color:var(--accent);
}
.card-sub{
  font-size:11px;
  color:var(--muted);
  margin-top:2px;
}
.mono{font-variant-numeric:tabular-nums}

/* Overview footer badges */
.overview-footer{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-top:8px;
}
.badge-line{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:3px 8px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#090909;
  font-size:11px;
  color:var(--muted);
}
.badge-dot{
  width:7px;height:7px;border-radius:50%;background:var(--accent);
}

/* Mission earnings section */
.controls{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
  margin-bottom:6px;
}
.controls input[type="search"]{
  min-width:220px;
  background:#050505;
  border:1px solid var(--border);
  border-radius:999px;
  padding:7px 11px;
  font-size:12px;
  color:var(--text);
}
.controls select{
  background:#050505;
  border:1px solid var(--border);
  border-radius:999px;
  padding:6px 10px;
  font-size:11px;
  color:var(--text);
}
.filter-pill{
  border-radius:999px;
  border:1px solid var(--border);
  padding:4px 10px;
  font-size:11px;
  color:var(--muted);
  background:#050505;
  cursor:pointer;
}
.filter-pill.active{
  background:linear-gradient(180deg,#f2d675,#e7c760);
  color:#000;
  box-shadow:0 0 14px rgba(214,180,76,.45);
}

/* Table */
.tableWrap{
  border-radius:12px;
  border:1px solid var(--border);
  overflow:auto;
  max-height:55vh;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:var(--fs-table);
  min-width:760px;
}
th,td{
  padding:7px 8px;
  border-bottom:1px solid rgba(214,180,76,.35);
}
th{
  font-size:11px;
  color:var(--accent);
  background:#060606;
  text-transform:uppercase;
  letter-spacing:.12em;
  font-weight:500;
  position:sticky;top:0;z-index:1;
}
tbody tr:nth-child(even){background:#101010}
tbody tr:hover{background:rgba(214,180,76,.08)}
.text-right{text-align:right}
.mission-title{font-weight:700}
.mission-id{font-size:10px;color:var(--muted);margin-top:1px}

/* Status pill */
.badge-status{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:2px 8px;
  border-radius:999px;
  border:1px solid var(--border);
  font-size:11px;
  background:#050505;
  color:var(--muted);
}
.badge-status .dot{
  width:7px;height:7px;border-radius:50%;background:var(--muted);
}
.badge-status.planned .dot{background:#c9b06a}
.badge-status.success .dot{background:var(--good)}
.badge-status.abort .dot{background:#ffb347}
.badge-status.failed .dot{background:var(--bad)}

/* Note line */
.note-line{
  font-size:11px;
  color:var(--muted);
  margin-top:6px;
}

/* Toast */
.toast{
  position:fixed;
  right:16px;bottom:16px;
  background:#111;
  border:1px solid var(--border);
  border-radius:10px;
  padding:7px 11px;
  font-size:12px;
  color:var(--text);
  box-shadow:0 0 18px rgba(214,180,76,.32);
  max-width:320px;
  z-index:40;
}
.toast.bad{border-color:var(--bad);color:#ffd0d0}
</style>
</head>
<body>

<!-- Shared header mount -->
<div id="header-container">
  <div class="brand">
    <img class="brand-logo" src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" alt="JMBN">
    <h1>JMBN – Earnings</h1>
  </div>
</div>

<!-- Load shared header.html -->
<script>
(async () => {
  try{
    const res = await fetch('header.html',{cache:'no-cache'});
    if(!res.ok) return;
    const html = await res.text();
    const mount = document.getElementById('header-container');
    if(mount) mount.outerHTML = html;

    requestAnimationFrame(() => {
      const here = (location.pathname.split('/').pop() || 'earnings.html').toLowerCase();
      document.querySelectorAll('.nav-btn').forEach(a=>{
        const href = (a.getAttribute('href')||'').toLowerCase();
        if(href === here) a.classList.add('active');
      });
    });
  }catch(e){
    console.warn('Header load failed',e);
  }
})();
</script>

<!-- PERSONAL OVERVIEW -->
<section class="panel">
  <div class="panel-header">
    <div class="panel-title">Personal Earnings Overview</div>
    <div class="panel-sub" id="overviewHandle">Reference-only ledger.</div>
  </div>

  <div class="overview-grid">
    <div class="card">
      <div class="card-label">Total Missions Paid</div>
      <div class="card-value mono" id="kTotalMissions">–</div>
      <div class="card-sub">Any mission with a payout row for you.</div>
    </div>
    <div class="card">
      <div class="card-label">Total aUEC Earned</div>
      <div class="card-value mono" id="kTotalAuec">–</div>
      <div class="card-sub">Sum of all final shares recorded.</div>
    </div>
    <div class="card">
      <div class="card-label">Average Per Mission</div>
      <div class="card-value mono" id="kAvgPerMission">–</div>
      <div class="card-sub">Total ÷ paid missions.</div>
    </div>
    <div class="card">
      <div class="card-label">Best Mission</div>
      <div class="card-value mono" id="kBestAmount">–</div>
      <div class="card-sub" id="kBestTitle">–</div>
    </div>
  </div>

  <div class="overview-footer">
    <div class="badge-line" id="kLastPaid">
      <span class="badge-dot"></span>
      <span>Last paid mission: –</span>
    </div>
    <div class="badge-line" id="kBestBadge">
      <span class="badge-dot"></span>
      <span>Best mission earned: –</span>
    </div>
  </div>
</section>

<!-- MISSION EARNINGS -->
<section class="panel">
  <div class="panel-header">
    <div class="panel-title">Mission Earnings</div>
    <div class="panel-sub">Click a row in Discord or Supabase for detail breakdown — this page is for reference only.</div>
  </div>

  <div class="controls">
    <input id="search" type="search" placeholder="Search by mission title / ID">
    <div style="display:flex;gap:6px;align-items:center">
      <button class="filter-pill active" data-range="all">All time</button>
      <button class="filter-pill" data-range="30">Last 30 days</button>
      <button class="filter-pill" data-range="90">Last 90 days</button>
    </div>
    <select id="statusFilter">
      <option value="">All statuses</option>
      <option value="planned">Planned</option>
      <option value="success">Success</option>
      <option value="abort">Abort</option>
      <option value="failed">Failed</option>
    </select>
  </div>

  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th style="width:14%">Date</th>
          <th style="width:34%">Mission</th>
          <th style="width:14%">Status</th>
          <th style="width:10%">Role / PG</th>
          <th style="width:14%" class="text-right">Mission Payout</th>
          <th style="width:14%" class="text-right">Your Share</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="6" style="padding:10px;color:var(--muted)">Loading…</td></tr>
      </tbody>
    </table>
  </div>

  <div class="note-line">
    Note: this page is for reference only. Actual payouts are based on in-game transfers and admin records.
  </div>
</section>

<div id="toast" class="toast" style="display:none"></div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
const $ = s => document.querySelector(s);
const esc = s => { const d=document.createElement('div'); d.textContent=s??''; return d.innerHTML; };
const fmt = n => Number(n||0).toLocaleString('en-US',{maximumFractionDigits:0});
const fmtDateTime = iso => {
  if(!iso) return '–';
  const d = new Date(iso);
  return d.toLocaleString('en-GB',{day:'2-digit',month:'short',year:'2-digit',hour:'2-digit',minute:'2-digit'});
};

let sb, me, ALL_ROWS = [];
let activeRange = 'all';

function showToast(msg,bad=false){
  const el = $('#toast');
  el.textContent = msg;
  el.className = 'toast' + (bad ? ' bad':'');
  el.style.display = 'block';
  setTimeout(()=>{ el.style.display='none'; }, 3500);
}

/* ---------- Rendering ---------- */
function statusClass(status){
  const s = (status||'').toLowerCase();
  if(s==='success') return 'success';
  if(s==='abort' || s==='aborted') return 'abort';
  if(s==='failed' || s==='fail') return 'failed';
  if(s==='planned') return 'planned';
  return '';
}

function applyFilters(){
  const q = ($('#search').value||'').toLowerCase().trim();
  const st = $('#statusFilter').value;
  const now = new Date();
  let minDate = null;
  if(activeRange !== 'all'){
    const days = Number(activeRange)||0;
    minDate = new Date(now.getTime() - days*86400000);
  }

  const rows = ALL_ROWS.filter(r=>{
    if(st && (r.status || '').toLowerCase() !== st) return false;
    if(minDate && r.start_time){
      const d = new Date(r.start_time);
      if(d < minDate) return false;
    }
    if(!q) return true;
    const hay = `${r.mission_title||''} ${r.mission_id||''}`.toLowerCase();
    return hay.includes(q);
  }).sort((a,b)=>{
    const da = a.start_time ? new Date(a.start_time).getTime() : 0;
    const db = b.start_time ? new Date(b.start_time).getTime() : 0;
    return db - da;
  });

  renderTable(rows);
}

function renderTable(rows){
  const tbody = $('#tbody');
  if(!rows.length){
    tbody.innerHTML = `<tr><td colspan="6" style="padding:10px;color:var(--muted)">No missions found for this filter.</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(r=>{
    const dt = fmtDateTime(r.start_time);
    const status = r.status || 'Unknown';
    const paygrade = r.paygrade || '–';
    const payout = r.payout_auec || 0;
    const share  = r.final_share || 0;
    const cls = statusClass(status);

    return `
      <tr>
        <td>${esc(dt)}</td>
        <td>
          <div class="mission-title">${esc(r.mission_title || 'Untitled')}</div>
          <div class="mission-id">ID: ${esc(r.mission_id || r.id || '')}</div>
        </td>
        <td>
          <span class="badge-status ${cls}">
            <span class="dot"></span>
            <span>${esc(status)}</span>
          </span>
        </td>
        <td>${esc(paygrade)}</td>
        <td class="text-right mono">${payout ? fmt(payout) : '—'}</td>
        <td class="text-right mono">${share ? fmt(share) : '—'}</td>
      </tr>
    `;
  }).join('');
}

/* ---------- Overview KPIs ---------- */
function updateOverview(){
  if(!ALL_ROWS.length){
    $('#kTotalMissions').textContent = '0';
    $('#kTotalAuec').textContent = '0';
    $('#kAvgPerMission').textContent = '0';
    $('#kBestAmount').textContent = '0';
    $('#kBestTitle').textContent = '—';
    $('#kLastPaid').innerHTML = '<span class="badge-dot"></span><span>Last paid mission: –</span>';
    $('#kBestBadge').innerHTML = '<span class="badge-dot"></span><span>Best mission earned: –</span>';
    return;
  }

  const byMission = new Map();
  for(const r of ALL_ROWS){
    const key = r.mission_id;
    if(!key) continue;
    if(!byMission.has(key)) byMission.set(key,r);
  }
  const missions = [...byMission.values()];
  const totalMissions = missions.length;
  const totalEarned   = missions.reduce((sum,m)=>sum + (m.final_share||0),0);
  const avgPer        = totalMissions ? totalEarned/totalMissions : 0;
  let best = null;
  for(const m of missions){
    const v = m.final_share || 0;
    if(!best || v > best.final_share) best = m;
  }

  $('#kTotalMissions').textContent = String(totalMissions);
  $('#kTotalAuec').textContent     = fmt(Math.round(totalEarned));
  $('#kAvgPerMission').textContent = fmt(Math.round(avgPer));
  $('#kBestAmount').textContent    = best ? fmt(Math.round(best.final_share||0)) : '0';
  $('#kBestTitle').textContent     = best ? (best.mission_title || '—') : '—';

  // last paid mission (by start_time where share>0)
  const paid = missions.filter(m=>m.final_share>0 && m.start_time);
  if(paid.length){
    paid.sort((a,b)=>new Date(b.start_time)-new Date(a.start_time));
    const last = paid[0];
    $('#kLastPaid').innerHTML =
      `<span class="badge-dot"></span><span>Last paid mission: ${fmtDateTime(last.start_time)}</span>`;
  }else{
    $('#kLastPaid').innerHTML =
      '<span class="badge-dot"></span><span>Last paid mission: –</span>';
  }
  if(best){
    $('#kBestBadge').innerHTML =
      `<span class="badge-dot"></span><span>Best mission earned ${fmt(Math.round(best.final_share||0))} aUEC</span>`;
  }else{
    $('#kBestBadge').innerHTML =
      '<span class="badge-dot"></span><span>Best mission earned: –</span>';
  }
}

/* ---------- Data loading ---------- */
/*
  We use:
  - v_missions_payout_live: mission_id,user_id,paygrade,final_share
  - missions: id,title,status,payout_auec,start_time

  One row per (mission,user) in v_missions_payout_live.
*/
async function loadLedger(){
  // 1) payouts for this user
  const { data:payouts, error:e1 } = await sb
    .from('v_missions_payout_live')
    .select('mission_id,user_id,paygrade,final_share')
    .eq('user_id', me);

  if(e1){
    console.error(e1);
    showToast('Failed to load earnings data',true);
    $('#tbody').innerHTML =
      `<tr><td colspan="6" style="padding:10px;color:var(--bad)">Failed to load earnings.</td></tr>`;
    return;
  }
  if(!payouts || !payouts.length){
    ALL_ROWS = [];
    updateOverview();
    applyFilters();
    return;
  }

  // 2) fetch missions meta
  const ids = [...new Set(payouts.map(p=>p.mission_id).filter(Boolean))];
  let missions = [];
  if(ids.length){
    const { data:ms, error:e2 } = await sb
      .from('missions')
      .select('id,title,status,payout_auec,start_time')
      .in('id', ids);
    if(e2){
      console.error(e2);
      showToast('Failed to load mission details',true);
    }else{
      missions = ms || [];
    }
  }
  const mapM = new Map(missions.map(m=>[m.id,m]));

  ALL_ROWS = payouts.map(p=>{
    const m = mapM.get(p.mission_id) || {};
    return {
      mission_id: p.mission_id,
      user_id: p.user_id,
      paygrade: p.paygrade,
      final_share: p.final_share || 0,
      mission_title: m.title || '',
      status: m.status || '',
      payout_auec: m.payout_auec || 0,
      start_time: m.start_time || null
    };
  });

  updateOverview();
  applyFilters();
}

/* ---------- Events ---------- */
document.addEventListener('DOMContentLoaded', async ()=>{
  const session = await requireAuth();
  if(!session) return;
  sb = getSupabase();
  me = session.user.id;

  // put handle / display name into subtitle if we can
  try{
    const { data: prof, error } = await sb
      .from('v_profiles_detailed')
      .select('handle,display_name')
      .eq('user_id', me)
      .maybeSingle();
    if(!error && prof){
      const handle = prof.handle || (prof.display_name && !prof.display_name.includes('@')
                    ? prof.display_name
                    : me.slice(0,8));
      $('#overviewHandle').textContent = `Reference-only ledger for ${handle}.`;
    }
  }catch(e){ console.warn(e); }

  // listeners
  $('#search').addEventListener('input',applyFilters);
  $('#statusFilter').addEventListener('change',applyFilters);
  document.querySelectorAll('.filter-pill').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.filter-pill').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      activeRange = btn.dataset.range || 'all';
      applyFilters();
    });
  });

  loadLedger();
});
</script>
</body>
</html>