<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Star Citizen Hauling Manifest (Offline)</title>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<style>
:root { --bg:#000; --panel:#0b0b0b; --border:#d6b44c; --card:#141414; --accent:#f2d675; --text:#f7f1d0; --muted:#c9b06a; }
body{background:var(--bg);color:var(--text);font-family:'Play','Segoe UI',Roboto,Helvetica,Arial,sans-serif;margin:0;padding:20px;letter-spacing:.25px;font-size:14px}
h1{font-weight:700;font-size:20px;color:var(--accent);text-shadow:0 0 8px rgba(242,214,117,.3);margin:0 0 12px;border-bottom:1px solid var(--border);padding-bottom:6px}
.container{display:flex;gap:14px;flex-wrap:wrap;align-items:flex-start}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:6px;padding:14px;flex:1;min-width:340px;box-shadow:0 0 10px rgba(214,180,76,.25)}
label{display:flex;flex-direction:column;gap:4px;margin-bottom:8px;color:var(--muted);font-size:13px}
select,input,textarea{background:#0a0a0a;border:1px solid var(--border);border-radius:4px;padding:7px;color:var(--text);font-family:'Play',sans-serif;font-size:13px}
button{padding:6px 10px;border-radius:4px;background:transparent;color:var(--text);border:1px solid var(--border);cursor:pointer;font-size:12px;transition:.2s;font-family:'Play',sans-serif}
button:hover{background:var(--accent);color:#000;text-shadow:none}
.kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin:10px 0 16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:4px;padding:10px;box-shadow:0 0 10px rgba(214,180,76,.1);text-align:center}
.card h3{margin:0;color:var(--muted);font-size:10px;text-transform:uppercase;letter-spacing:.6px}
.card .val{font-weight:700;font-size:18px;color:var(--accent);margin-top:4px}
.tableWrap{border:1px solid var(--border);border-radius:6px;overflow:auto;box-shadow:0 0 8px rgba(214,180,76,.2);max-height:70vh}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border-bottom:1px solid rgba(214,180,76,.3);padding:6px;text-align:left}
th{color:var(--accent);font-weight:500;background:#080808;text-transform:none;font-size:12px}
tr:nth-child(even){background:#111}
tr:hover{background:rgba(214,180,76,.08)}
.searchbar{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
.searchbar input,.searchbar select{flex:1;min-width:160px;font-size:13px}
.muted{color:var(--muted)}
.small{font-size:11px;color:var(--muted);margin-left:5px}
.sticky{position:sticky;top:16px;align-self:flex-start;height:fit-content}

/* simple test/diagnostic badge */
#diag{margin-top:12px;font-size:11px;color:var(--muted)}
#testLog{white-space:pre-wrap;background:#0a0a0a;border:1px solid var(--border);padding:8px;border-radius:6px;margin-top:6px;max-height:180px;overflow:auto}
</style>
</head>
<body>
<h1>Hauling Manifest – Contract Runner</h1>
<div class="kpis">
  <div class="card"><h3>Total Contracts</h3><div class="val" id="kpiCount">0</div></div>
  <div class="card"><h3>Total Payout</h3><div class="val" id="kpiPayout">0<span class="small"> aUEC</span></div></div>
  <div class="card"><h3>Total Quantity</h3><div class="val" id="kpiSCU">0<span class="small"> SCU</span></div></div>
  <div class="card"><h3>Avg Payout / SCU</h3><div class="val" id="kpiPerSCU">0<span class="small"> aUEC</span></div></div>
</div>

<div class="container">
  <div class="panel" style="flex:2;min-width:520px">
    <h2 style="margin:0 0 6px;color:var(--accent)">Manifest</h2>
    <div class="searchbar">
      <input id="q" placeholder="Search contract, commodity, origin/destination…" />
      <select id="sort">
        <option value="-created">Newest</</option>
        <option value="created">Oldest</option>
        <option value="-payout">Payout (high→low)</option>
        <option value="payout">Payout (low→high)</option>
        <option value="-quantity">SCU (high→low)</option>
        <option value="quantity">SCU (low→high)</option>
      </select>
    </div>
    <div class="tableWrap">
      <table>
        <thead>
          <tr><th>When</th><th>Contract name</th><th>Type</th><th>Commodity</th><th>Quantity</th><th>Payout</th><th>Origin</th><th>Destination</th><th>Actions</th></tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

  <div class="panel sticky" style="flex:1;min-width:300px">
    <h2 style="margin:0 0 6px;color:var(--accent)">Add / Edit Contract</h2>
    <form id="form" autocomplete="off">
      <label>Contract Name<input id="contractName" required></label>
      <label>Type<select id="contractType">
        <option value="">-- select --</option>
        <option value="Mining">Mining</option>
        <option value="Hauling">Hauling</option>
        <option value="Cargo">Cargo</option>
        <option value="Medical">Medical</option>
      </select></label>
      <label>Commodity<select id="commodity"></select></label>
      <label>Quantity (SCU)<input id="quantity" type="number" step="0.1"></label>
      <label>Payout (aUEC)<input id="payout" type="number" step="1"></label>
      <label>Origin<select id="origin" required></select></label>
      <label>Destination<select id="destination" required></select></label>
      <div style="display:flex;gap:6px;margin-top:10px">
        <button type="button" id="save">Save Entry</button>
        <button type="reset" id="reset">Reset</button>
      </div>
      <input type="hidden" id="rowId">
    </form>

    <div id="diag">
      <strong>Diagnostics</strong>
      <div id="testLog">(tests will run on load)</div>
    </div>
  </div>
</div>

<script>
// ===== Utilities =====
const $ = (s) => document.querySelector(s);
const byId = (id) => document.getElementById(id);
const STORE_KEY = 'sc-haul-v2';
let items = JSON.parse(localStorage.getItem(STORE_KEY) || '[]');
const uid = () => 'C' + Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
const fmtMoney = (n) => (Number(n) || 0).toLocaleString(undefined, { maximumFractionDigits: 0 });

// ===== Data (Origins/Destinations & Commodities) =====
const originList = `Ambitious Dream Station (CRU-L1), Anderson (HDMS-Anderson), ARC-L1 Wide Forest Station, ARC-L2 Lively Pathway Station, ARC-L3 Modern Express Station, ARC-L4 Faint Glen Station, ARC-L5 Yellow Core Station, ArcCorp Mining Area 045, ArcCorp Mining Area 048, ArcCorp Mining Area 056, ArcCorp Mining Area 061, ArcCorp Mining Area 141, ArcCorp Mining Area 157, Area18 (Riker Memorial Spaceport), Arid Reach, Ashland, Astor’s Clearing, Baijini Point, Beautiful Glen Station (CRU-L5), Benson Mining Outpost, Blackrock Exchange, Bloodshot Ridge, Bountiful Harvest Hydroponics, Brio’s Breaker Yard, Bud’s Growery, Bueno Ravine, Canard View, Casillo (HDPC-Casillo), Chawla’s Beach, Checkmate, Covalex Distribution Centre S1DC06, Covalex Distribution Centre S4DC05, CRU-L1 Ambitious Dream Station, CRU-L4 Shallow Fields Station, CRU-L5 Beautiful Glen Station, Cry-Astro Processing Plant 19-02, Cry-Astro Processing Plant 34-12, Cutter’s Rig, Deakins Research Outpost, Devlin Scrap & Salvage, Dudley & Daughters, Dunboro, Dupree Industrial Manufacturing Facility, Endgame, Endless Odyssey Station (MIC-L3), Everus Harbor, Faithful Dream Station (HUR-L2), Faint Glen Station (ARC-L4), Fallow Field, Farnesway (HDPC-Farnesway), Finn’s Folley, Frostbite, Frigid Knot, Gallete Family Farms, Gaslight, Goner’s Deal, Golden Riviera (The Golden Riviera), Grim HEX, Greycat Stanton I Production Complex-B, Greycat Stanton IV Production Complex A, Hadley (HDMS-Hadley), Harper’s Point, Hickes Research Outpost, High Course Station (HUR-L5), Humboldt Mines, HUR-L1 Green Glade Station, HUR-L2 Faithful Dream Station, HUR-L3 Thundering Express Station, HUR-L4 Melodic Fields Station, HUR-L5 High Course Station, Jackson’s Swap, Jumptown, Kabir’s Outpost, Kudre Ore, Last Landings, Lathan (HDMS-Lathan), Lively Pathway Station (ARC-L2), Lorville (Teasa Spaceport), Long Forest Station (MIC-L2), Loveridge Mineral Reserve, Ludlow, Magnus Gateway, Maker’s Point, Megumi Refueling, Melodic Fields Station (HUR-L4), MIC-L1 Shallow Frontier Station, MIC-L2 Long Forest Station, MIC-L3 Endless Odyssey Station, MIC-L4 Red Crossroads Station, MIC-L5 Modern Icarus Station, Modern Express Station (ARC-L3), Modern Icarus Station (MIC-L5), Moreland Hills, Necropolis (The Necropolis), New Babbage Interstellar Spaceport, Norgaard (HDMS-Norgaard), NT-999-XX, Nuen Waste Management, Oparei (HDMS-Oparei), Orbituary, Orinth (Reclamation & Disposal Orinth), Orison (August Dunlow Spaceport), Orphanage (The Orphanage), Outpost 54, Paradise Cove, Patch City, Pickers Field, Pinewood (HDMS-Pinewood), Private Property (PRIVATE PROPERTY), Pyro Gateway, Rappel, Raven’s Roost, Razor’s Edge, Rayari Anvik Research Outpost, Rayari Cantwell Research Outpost, Rayari Deltana Research Outpost, Rayari Kaltag Research Outpost, Rayari McGrath Research Outpost, Rat’s Nest, Riker Memorial Spaceport (Area18), Rod’s Fuel ’N Supplies, Rough Landing, Ruin Station, Rustville, Ryder (HDMS-Ryder), Sacren’s Plot, Sakura Sun Goldenrod Workcenter, Sakura Sun Magnolia Workcenter, Samson & Son’s Salvage Center, SCD-1 (Shubin Mining Facility SCD-1), Seer’s Canyon, Seraphim Station, Shady Glen Farms, Shallow Fields Station (CRU-L4), Shallow Frontier Station (MIC-L1), Shepherd’s Rest, Shubin Mining Facility SAL-2, Shubin Mining Facility SAL-5, Shubin Mining Facility SCD-1, Shubin Mining Facility SM0-10, Shubin Mining Facility SM0-13, Shubin Mining Facility SM0-18, Shubin Mining Facility SM0-22, Shubin Mining Facility SMCa-6, Shubin Mining Facility SMCa-8, S4DC05 (Covalex Distribution Centre S4DC05), S4LD01 (Microtech Logistics Depot S4LD01), S4LD13 (Microtech Logistics Depot S4LD13), Stanhope (HDMS-Stanhope), Starlight Service Station, Sunset Mesa, Teasa Spaceport (Lorville), Terra Gateway, Terra Mills HydroFarm, Thedus (HDMS-Thedus), Thundering Express Station (HUR-L3), Tram & Myers Mining, Port Tressler, Weeping Cove, Wide Forest Station (ARC-L1), Woodruff (HDMS-Woodruff), XenoThreat Security Station, Yellow Core Station (ARC-L5), Zephyr`.split(',');
const commodities = `AcryliPlex Composite, Agricium, Agricium (Ore), Agricultural Supplies, Altruciatoxin, Aluminum, Aluminum (Ore), Aluminium, Aluminium (Ore), Amioshi Plague, Ammonia, Aphorite, Apoxygenite, Argon, Astatine, Atlasium, Beryl, Beryl (Raw), Bexalite, Bexalite (Raw), Bioplastic, Blue Bilva, Borase, Borase (Ore), CK13-GID Seed Blend, Carbon, Carbon Silk, Chlorine, Cobalt, CompBoard, Construction Materials, Copper, Copper (Ore), Corundum, Corundum (Raw), DCSR2, Decari Pod, Degnous Root, Diamond, Diamond (Raw), Diamond Laminate, Diluthermex, Distilled Spirits, Dolivine, Dopple, Dymantium, DynaFlex, E-Tam, Elespo, Fireworks, Fluorine, Fotia Seedpod, Freeze, Fresh Food, Gasping Weevil Eggs, Glow, Gold, Gold (Ore), Golden Medmon, HLX99 Hyperprocessors, Hadanite, Heart of the woods, Helium, Hephaestanite, Hephaestanite (Ore), HexaPolyMesh Coating, Human Food Bars, Hydrogen, Hydrogen Fuel, Inert Materials, Iodine, Iron, Iron (Ore), Janalite, Jumping Limes, Kopion Horn, Laranite, Laranite (Ore), Lastaprene, Luminalia Gift, Lunes, Lycara, Mala, Marok Gem, Maze, MedPens, Medical Supplies, Mercury, Methane, Neograph, Neon, Nitrogen, Omnapoxy, Osoian Hides, Oxypen, Oza, Partillium, Pingala Seeds, Pitambu, Potassium, Pressurized Ice, Processed Food, Prota, Quantainium, Quantainium (Raw), Quantum Fuel, Quartz, Quartz (Raw), RS1 Odyssey Spacesuits, Ranta Dung, Raw Ice, Recycled Material Composite, Redfin Energy Modulators, Revenant Pod, Revenant Tree Pollen, Riccite, SLAM, Sarilus, Scrap, Ship Ammunition, Silicon, Silnex, Souvenirs, Steel, Stileron, Stims, Stone Bug Shell, Sunset Berries, Taranite, Taranite (Raw), Thermal Foam, Thrust, Tin, Titanium, Titanium (Ore), Tritium, Tungsten, Tungsten (Ore), Uncut SLAM, Waste, WiDoW, XaPyen, ZetaProlanide`.split(',');

function populateList(el, list) {
  if (!el) return;
  el.innerHTML = '';
  el.appendChild(new Option('-- select --', ''));
  list.forEach(v => { const t = v.trim(); if (t) el.appendChild(new Option(t, t)); });
}

// Populate dropdowns at startup
populateList(byId('origin'), originList);
populateList(byId('destination'), originList);
populateList(byId('commodity'), commodities);

// ===== KPIs =====
function renderKPIs(){
  const count = items.length;
  const totalPayout = items.reduce((s,it)=> s + (+it.payout||0), 0);
  const totalSCU = items.reduce((s,it)=> s + (+it.quantity||0), 0);
  const perSCU = totalSCU ? Math.round(totalPayout / totalSCU) : 0;
  byId('kpiCount').textContent = count.toLocaleString();
  byId('kpiPayout').innerHTML = fmtMoney(totalPayout) + "<span class='small'> aUEC</span>";
  byId('kpiSCU').innerHTML = (Number(totalSCU)||0).toLocaleString(undefined,{maximumFractionDigits:1}) + "<span class='small'> SCU</span>";
  byId('kpiPerSCU').innerHTML = fmtMoney(perSCU) + "<span class='small'> aUEC</span>";
}

// ===== Table =====
function renderTable(){
  const tb = byId('rows');
  const q = (byId('q')?.value || '').trim().toLowerCase();
  const sort = byId('sort')?.value || '-created';
  let arr = items.slice();
  if (q) {
    arr = arr.filter(it => `${it.contractName||''} ${it.contractType||''} ${it.commodity||''} ${it.origin||''} ${it.destination||''}`.toLowerCase().includes(q));
  }
  switch(sort){
    case 'created': arr.sort((a,b)=>(a.created||'').localeCompare(b.created||'')); break;
    case '-created': arr.sort((a,b)=>(b.created||'').localeCompare(a.created||'')); break;
    case 'payout': arr.sort((a,b)=>(+a.payout||0)-(+b.payout||0)); break;
    case '-payout': arr.sort((a,b)=>(+b.payout||0)-(+a.payout||0)); break;
    case 'quantity': arr.sort((a,b)=>(+a.quantity||0)-(+b.quantity||0)); break;
    case '-quantity': arr.sort((a,b)=>(+b.quantity||0)-(+a.quantity||0)); break;
  }
  tb.innerHTML = '';
  for (const it of arr){
    const tr = document.createElement('tr'); tr.dataset.id = it.id;
    tr.innerHTML = `
      <td class='muted'>${it.created? new Date(it.created).toLocaleString():''}</td>
      <td>${it.contractName||''}</td>
      <td>${it.contractType||''}</td>
      <td>${it.commodity||''}</td>
      <td>${it.quantity??''}</td>
      <td>${fmtMoney(it.payout)}</td>
      <td>${it.origin||''}</td>
      <td>${it.destination||''}</td>
      <td><button data-act='edit'>Edit</button> <button data-act='del'>Del</button></td>`;
    tb.appendChild(tr);
  }
  renderKPIs();
}

function render(){ renderTable(); }

// ===== Robust form reset to avoid TypeError =====
function resetForm(){
  const form = byId('form');
  if (form && typeof form.reset === 'function') {
    form.reset();
  } else {
    // manual fallback
    ['contractName','contractType','commodity','quantity','payout','origin','destination'].forEach(id=>{
      const el = byId(id);
      if(!el) return;
      if(el.tagName === 'SELECT') el.selectedIndex = 0; else el.value = '';
    });
  }
  byId('rowId').value = '';
}

// ===== Save / Reset / Row actions =====
function saveEntry(){
  const id = byId('rowId').value || uid();
  const ex = items.findIndex(x=>x.id===id);
  const created = (ex>=0 && items[ex].created) ? items[ex].created : new Date().toISOString();
  const entry = {
    id, created,
    contractName: byId('contractName').value.trim(),
    contractType: byId('contractType').value,
    commodity: byId('commodity').value,
    quantity: +byId('quantity').value || 0,
    payout: +byId('payout').value || 0,
    origin: byId('origin').value,
    destination: byId('destination').value
  };
  if (!entry.contractName || !entry.origin || !entry.destination){ alert('Fill required fields'); return; }
  if (ex>=0) items[ex] = entry; else items.unshift(entry);
  localStorage.setItem(STORE_KEY, JSON.stringify(items));
  resetForm();
  render();
}

byId('save').onclick = saveEntry;
byId('reset').onclick = () => { byId('rowId').value=''; };

byId('rows').onclick = (e) => {
  const btn = e.target.closest('button'); if (!btn) return;
  const id = e.target.closest('tr').dataset.id;
  const it = items.find(x=>x.id===id); if(!it) return;
  if (btn.dataset.act==='edit'){
    byId('contractName').value = it.contractName||'';
    byId('contractType').value = it.contractType||'';
    byId('commodity').value = it.commodity||'';
    byId('quantity').value = it.quantity||'';
    byId('payout').value = it.payout||'';
    byId('origin').value = it.origin||'';
    byId('destination').value = it.destination||'';
    byId('rowId').value = id;
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  if (btn.dataset.act==='del'){
    if (confirm('Delete this entry?')){
      items = items.filter(x=>x.id!==id);
      localStorage.setItem(STORE_KEY, JSON.stringify(items));
      render();
    }
  }
};

// Filters
byId('q')?.addEventListener('input', render);
byId('sort')?.addEventListener('change', render);

// ===== Minimal test cases (results shown in Diagnostics box) =====
function logTest(msg){ const el = byId('testLog'); if(el){ el.textContent += `\n${msg}`; } console.log(msg); }
function expect(name, cond){ logTest(`${cond? '✅':'❌'} ${name}`); }
function runTests(){
  // Test 1: dropdowns populated
  expect('Origin list populated', (byId('origin').options.length > 2));
  expect('Destination list populated', (byId('destination').options.length > 2));
  expect('Commodity list populated', (byId('commodity').options.length > 2));

  // Test 2: reset does not throw and clears rowId
  resetForm();
  expect('Reset clears rowId', byId('rowId').value === '');
}

// Initial draw
render();
runTests();
</script>
</body>
</html>
