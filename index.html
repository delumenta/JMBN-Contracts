
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Manifest</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png"
      href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png"
      sizes="32x32">

<style>
:root{
  --border:#d6b44c; --accent:#f2d675; --text:#f7f1d0; --muted:#c9b06a;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow-x:hidden;font-family:'Play',sans-serif;background:#000;color:var(--text)}
#goldDust{position:fixed;inset:0;z-index:0;width:100%;height:100%;pointer-events:none;background:#000}
/* HUD Parallax Grid */
.hud-grid{
  position:fixed;inset:0;z-index:1;pointer-events:none;
  background-image:
    linear-gradient(rgba(255,230,150,0.03) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,230,150,0.03) 1px, transparent 1px);
  background-size:80px 80px; animation:drift 80s linear infinite;
}
@keyframes drift{from{background-position:0 0}to{background-position:-200px -200px}}
/* Vignette */
body::after{
  content:"";position:fixed;inset:0;z-index:2;pointer-events:none;
  background:
    radial-gradient(1200px 800px at 50% 45%,rgba(0,0,0,0) 35%,rgba(0,0,0,.45) 70%,rgba(0,0,0,.75) 100%),
    linear-gradient(to bottom,rgba(0,0,0,.25),rgba(0,0,0,.55));
}

/* Layout */
.wrapper{position:relative;z-index:3;min-height:100%;display:grid;place-items:center;padding:28px}
.center{width:min(1100px,96vw)}
.brand{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.brand-logo{width:56px;height:56px;object-fit:contain;filter:drop-shadow(0 0 8px rgba(242,214,117,.35))}
.brand h1{margin:0;font-size:clamp(22px,3.6vw,36px);color:var(--accent);font-weight:700}
.sub{color:var(--muted);margin:4px 0 16px;font-size:clamp(12px,1.6vw,14px)}

/* Panels */
.panel{
  background:rgba(11,11,11,.9); border:1px solid var(--border); border-radius:16px;
  padding:16px; box-shadow:0 0 22px rgba(214,180,76,.22), inset 0 0 0 1px rgba(214,180,76,.12);
  backdrop-filter:blur(5px) saturate(1.05);
}

/* Member Card */
.member{
  display:grid; grid-template-columns:1fr 180px; gap:14px; align-items:center; margin-bottom:14px;
}
@media(max-width:800px){ .member{ grid-template-columns:1fr } }
.m-left h2{font-size:24px; margin:0 0 6px}
.pills{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
.pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--border);
  border-radius:999px;background:#0c0c0c;color:var(--accent);font-weight:700;font-size:12px}
.meta{color:var(--muted);font-size:13px;margin-top:6px}
.note{color:#c9b06a;font-size:12px;margin-top:6px}
.rank-img{
  width:160px; height:160px; object-fit:contain; border:1px solid var(--border); border-radius:12px;
  background:#0b0b0b; display:none; margin-left:auto;
}

/* Action Cards */
.grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:860px){.grid{grid-template-columns:1fr}}
.card{
  position:relative; overflow:hidden; border-radius:16px; padding:16px;
  border:1px solid var(--border); background:rgba(11,11,11,.85);
  box-shadow:0 0 18px rgba(214,180,76,.18), inset 0 0 0 1px rgba(214,180,76,.12);
}
.card h3{margin:0 0 6px; color:var(--accent)}
.card p{margin:0 0 12px; color:var(--muted); font-size:13px}
.card a{
  display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;
  text-decoration:none;border:1px solid var(--border);color:#000;background:var(--accent);
  font-weight:800; letter-spacing:.2px; transition:transform .15s ease, box-shadow .2s ease;
}
.card a:hover{transform:translateY(-1px);box-shadow:0 0 22px rgba(242,214,117,.35)}
.card::after{
  content:""; position:absolute; inset:0; border-radius:16px;
  background:linear-gradient(120deg,rgba(255,255,255,0) 30%,rgba(255,255,255,0.18) 50%,rgba(255,255,255,0) 70%);
  transform:translateX(-110%); transition:transform .6s ease;
}
.card:hover::after{transform:translateX(110%)}

.footer{color:var(--muted);font-size:12px;margin-top:16px}
.kv{display:inline-grid;grid-template-columns:auto auto;gap:4px 8px;margin-top:8px}
.kv .k{color:var(--muted)} .kv .v{color:var(--accent)}
</style>
</head>

<body>
<canvas id="goldDust"></canvas>
<div class="hud-grid"></div>

<div class="wrapper">
  <main class="center">
    <div class="brand">
      <img class="brand-logo" alt="JMBN"
        src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png/v1/fill/w_66,h_66,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/0_New_JMBN_Logo_Gold.png">
      <h1>JMBN Manifest System</h1>
    </div>
    <div class="sub">Offline-friendly • Linked manifests</div>

    <!-- Member Card -->
    <section class="panel member">
      <div class="m-left">
        <h2 id="mName">—</h2>
        <div class="pills">
          <span class="pill" id="mRank">Unranked</span>
          <span class="pill" id="mRole">Member</span>
          <span class="pill" id="mMissions">Missions: 0</span>
        </div>
        <div class="meta" id="mEmail">—</div>
        <div class="note">Rank name & image are pulled from <code>v_profiles_detailed</code> in Supabase.</div>
      </div>
      <img id="mRankImg" class="rank-img" alt="Rank">
    </section>

    <!-- Two Action Cards -->
    <section class="grid">
      <div class="card">
        <h3>Personal</h3>
        <p>Open your Contracts & personal manifests.</p>
        <a href="contracts.html">➜ Go to Contracts</a>
      </div>

      <div class="card">
        <h3>JMBN</h3>
        <p>Open Org Mission Logs, Attendance & Archives.</p>
        <a href="mission-log.html">➜ Go to Mission Log</a>
      </div>
    </section>

    <div class="footer">
      <div class="kv">
        <div class="k">Theme</div><div class="v">Play • Gold Accents</div>
        <div class="k">Links</div><div class="v">Relative URLs (GitHub Pages ready)</div>
      </div>
    </div>
  </main>
</div>

<!-- ===== Starfield background ===== -->
<script>
(function(){
  const c=document.getElementById('goldDust'),ctx=c.getContext('2d',{alpha:true});
  let W,H,DPR=Math.min(window.devicePixelRatio||1,2);
  const stars=[],shooting=[];
  const STARCOUNT=900,LAYERS=4,BASE_SPEED=0.05,MAX_SIZE=1.8,MIN_SIZE=0.2;

  function resize(){ W=c.width=innerWidth*DPR; H=c.height=innerHeight*DPR; c.style.width=innerWidth+'px'; c.style.height=innerHeight+'px'; }
  resize(); addEventListener('resize',resize);

  for(let i=0;i<STARCOUNT;i++){
    const l=(Math.random()*LAYERS|0)+1, d=l/LAYERS;
    stars.push({ x:Math.random()*W, y:Math.random()*H, z:d,
      r:(Math.random()*(MAX_SIZE-MIN_SIZE)+MIN_SIZE)*DPR*d, tw:Math.random()*6.28, spd:BASE_SPEED*d });
  }
  function addShooter(){
    const sx=Math.random()*W, sy=Math.random()*H*0.3, a=(Math.random()<0.5?1:-1)*(Math.random()*Math.PI/4+Math.PI/8);
    const d=Math.random(), v=3+d*4, len=60+d*80;
    shooting.push({x:sx,y:sy,vx:Math.cos(a)*v,vy:Math.sin(a)*v,l:len,d,life:1});
  }

  function draw(){
    ctx.setTransform(1,0,0,1,0,0); ctx.globalCompositeOperation='source-over';
    ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H);
    const t=Date.now()/1000; ctx.globalCompositeOperation='lighter';
    const swirlX=Math.sin(t/8)*0.5, swirlY=Math.cos(t/10)*0.5;

    for(const s of stars){
      s.x+=Math.cos(t*0.08+s.tw+swirlX)*s.spd*1.2;
      s.y+=Math.sin(t*0.06+s.tw+swirlY)*s.spd*1.2;
      if(s.x<0)s.x+=W; if(s.x>W)s.x-=W; if(s.y<0)s.y+=H; if(s.y>H)s.y-=H;
      const f=0.4+0.6*Math.abs(Math.sin(t*5+s.tw));
      ctx.beginPath(); ctx.fillStyle=`hsla(45,100%,${60+20*f}%,.8)`; ctx.arc(s.x,s.y,s.r,0,6.283); ctx.fill();
    }
    for(let i=shooting.length-1;i>=0;i--){
      const s=shooting[i]; s.x+=s.vx; s.y+=s.vy; s.life-=0.02;
      const g=ctx.createLinearGradient(s.x,s.y,s.x-s.vx*s.l,s.y-s.vy*s.l);
      g.addColorStop(0,`hsla(45,95%,${70+s.d*20}%,${s.life})`); g.addColorStop(1,`hsla(45,95%,${50+s.d*20}%,0)`);
      ctx.strokeStyle=g; ctx.lineWidth=(1.5+s.d*1.5)*DPR;
      ctx.beginPath(); ctx.moveTo(s.x,s.y); ctx.lineTo(s.x-s.vx*s.l,s.y-s.vy*s.l); ctx.stroke();
      if(s.life<=0||s.x>W||s.y>H) shooting.splice(i,1);
    }
    requestAnimationFrame(draw);
  }
  draw();
  (function loop(){ setTimeout(()=>{ if(Math.random()<0.85) addShooter(); loop(); }, 5000+Math.random()*5000); })();
})();
</script>

<!-- ===== Supabase Auth + Member Card fill from v_profiles_detailed ===== -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
(async () => {
  const $  = sel => document.querySelector(sel);   // ✅ accepts '#mName'
  const out = (sel, val) => { const el=$(sel); if(el) el.textContent = val ?? ''; };

  // session + fallback email
  const session = (typeof requireAuth==='function') ? await requireAuth() : null;
  if (!session) return;
  const emailFallback = session.user?.email || '';

  // fetch from view
  let row = {};
  try {
    const { data, error } = await sb
      .from('v_profiles_detailed')
      .select('user_id,handle,display_name,current_rank_name,current_rank_code,current_rank_image_url,ingame_role,missions_attended')
      .eq('user_id', session.user.id)
      .single();
    if (error) throw error;
    row = data || {};
  } catch (e) {
    console.warn('v_profiles_detailed_error:', e.message);
  }

  // derive values
  const handle   = row.handle || (emailFallback.split('@')[0] || 'Unknown');
  const email    = row.display_name || emailFallback;
  const role     = row.ingame_role || 'Member';

  const rankName = row.current_rank_name || 'Unranked';
  const rankCode = row.current_rank_code || '';         // e.g. 'ENS-O1'
  const paygrade = (rankCode.split('-')[1] || '');      // 'O1'
  const rankText = paygrade ? `${rankName}-${paygrade}` : rankName;

  const rankImg  = row.current_rank_image_url || '';
  const missions = Number.isFinite(row.missions_attended) ? row.missions_attended : 0;

  // fill UI  ✅ use '=' (not '|=')
  out('#mName',  handle);
  out('#mEmail', email);
  out('#mRole',  role);
  out('#mRank',  rankText);
  out('#mMissions', `Missions: ${missions}`);

  if (rankImg) {
    const img = $('#mRankImg');
    if (img) { img.src = rankImg; img.alt = rankText; img.style.display = 'block'; }
  }
})();
</script>
</body>
</html>
