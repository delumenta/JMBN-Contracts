<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Manifest</title>

<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  --bg:#000; --panel:#0b0b0b; --card:#111; --border:#d6b44c;
  --accent:#f2d675; --text:#f7f1d0; --muted:#c9b06a; --bad:#ff6b6b;
  --fs-base:14px; --fs-h1:clamp(20px,2.6vw,28px); --fs-h2:clamp(12px,1.6vw,14px)
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:
    radial-gradient(1200px 800px at 20% -10%, rgba(242,214,117,.07), transparent 60%),
    radial-gradient(800px 600px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text);font-family:'Play',system-ui,sans-serif;letter-spacing:.25px;
}

/* page spacing under sticky header */
main{padding:14px;max-width:1080px;margin:66px auto 24px}
.page-title{font-size:var(--fs-h1);font-weight:800;color:var(--accent);margin:0 0 10px}

/* cards */
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:880px){.grid{grid-template-columns:1fr}}

.card{
  position:relative;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;
  box-shadow:0 0 18px rgba(214,180,76,.18), inset 0 0 0 1px rgba(214,180,76,.12);
  overflow:hidden
}
.card::after{
  content:"";position:absolute;inset:0;border-radius:14px;
  background:linear-gradient(120deg,rgba(255,255,255,0) 30%,rgba(255,255,255,.18) 50%,rgba(255,255,255,0) 70%);
  transform:translateX(-100%);transition:transform .6s ease;pointer-events:none
}
.card:hover::after{transform:translateX(100%)}

/* member card */
.member{
  display:grid;grid-template-columns:1fr 120px;gap:12px;align-items:center;
}
.member .left .name{font-weight:900;font-size:18px;color:var(--accent)}
.member .left .row{display:flex;gap:10px;align-items:center;margin-top:6px}
.badge{border:1px solid var(--border);border-radius:999px;padding:3px 8px;font-size:11px;background:#0c0c0c;color:var(--muted)}
.rankline{display:flex;align-items:center;gap:8px;font-size:13px}
.rankimg{
  width:110px;height:110px;object-fit:contain;border-radius:10px;border:1px solid var(--border);
  background:#0c0c0c;display:block;justify-self:end
}
.small{font-size:12px;color:var(--muted);margin-top:6px}

/* action cards */
.action h3{margin:0 0 6px;color:var(--accent);font-size:16px}
.action p{margin:0 0 10px;color:var(--muted);font-size:13px;min-height:18px}
.action a{
  display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border-radius:10px;text-decoration:none;
  border:1px solid var(--border);background:var(--accent);color:#000;font-weight:800;width:fit-content
}

/* fade */
body{opacity:0;transition:opacity .3s ease}
body.ready{opacity:1}
</style>
</head>
<body>

<!-- shared header mount -->
<div id="header-mount"></div>
<script>
  (async () => {
    try{
      const res = await fetch('header.html', {cache:'no-cache'});
      const html = await res.text();
      document.getElementById('header-mount').outerHTML = html;
      requestAnimationFrame(()=>{
        const here=(location.pathname.split('/').pop()||'index.html').toLowerCase();
        document.querySelectorAll('.nav-btn').forEach(a=>{
          if((a.getAttribute('href')||'').toLowerCase()===here){
            a.classList.add('active'); a.setAttribute('aria-current','page');
          }
        });
      });
    }catch(e){ console.warn('Header load failed:', e); }
  })();
</script>

<main>
  <h1 class="page-title">Manifest</h1>

  <div class="grid">
    <!-- MEMBER CARD -->
    <section class="card member" id="memberCard">
      <div class="left">
        <div class="name" id="mName">Loading…</div>
        <div class="rankline">
          <span id="mRank">—</span>
          <span class="badge" id="mPaygrade" style="display:none"></span>
          <span class="badge" id="mRole">—</span>
        </div>
        <div class="row">
          <span class="small" id="mEmail"></span>
        </div>
        <div class="small">Tip: Your rank image is pulled from the <code>ranks.image_url</code> you set in Supabase.</div>
      </div>
      <img id="mRankImg" class="rankimg"
           src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png"
           alt="Rank">
    </section>

    <!-- ACTION: PERSONAL -->
    <section class="card action">
      <h3>Personal</h3>
      <p>Open your Contracts & personal manifests.</p>
      <a href="contracts.html">➜ Go to Contracts</a>
    </section>

    <!-- ACTION: JMBN -->
    <section class="card action">
      <h3>JMBN</h3>
      <p>Open the Org Mission Logs, Attendance & Archives.</p>
      <a href="mission-log.html">➜ Go to Mission Log</a>
    </section>
  </div>
</main>

<!-- Supabase auth -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>

<script>
/*
  Expects your existing auth.js to expose:
  - requireAuth() -> session
  - global `sb` (Supabase client)
  DB shape assumed (based on our earlier SQL):
    - public.profiles: id (uuid), full_name text, rank_code text, role text
    - public.ranks: code text, name text, paygrade text, image_url text
    - optional user_roles table → we try it; if not present we show profiles.role (or "Member")
*/
(async () => {
  const session = await requireAuth();  // redirects to auth.html if not logged in
  if (!session) return;
  document.body.classList.add('ready');

  const uid = session.user.id;
  const email = session.user.email || '';

  // 1) Profile
  let profile = null;
  try {
    const { data, error } = await sb.from('profiles')
      .select('full_name, rank_code, role')
      .eq('id', uid).single();
    if (error) throw error;
    profile = data;
  } catch (e) {
    console.warn('profiles load:', e.message);
  }

  // 2) Rank (if any)
  let rank = null;
  if (profile?.rank_code) {
    try {
      const { data, error } = await sb.from('ranks')
        .select('name, paygrade, image_url')
        .eq('code', profile.rank_code).single();
      if (error) throw error;
      rank = data;
    } catch (e) {
      console.warn('rank load:', e.message);
    }
  }

  // 3) Role (prefer user_roles if exists, else profiles.role, else "Member")
  let role = profile?.role || 'Member';
  try {
    const { data, error } = await sb.from('user_roles')
      .select('role').eq('user_id', uid).limit(1).maybeSingle?.();
    if (!error && data && data.role) role = data.role;
  } catch (e) {
    // table may not exist; ignore
  }

  // Fill UI
  const el = s => document.getElementById(s);
  el('mName').textContent   = profile?.full_name || session.user.user_metadata?.full_name || email.split('@')[0] || 'Unknown';
  el('mEmail').textContent  = email || '';
  el('mRole').textContent   = role;

  if (rank?.name) {
    el('mRank').textContent = rank.name;
  } else if (profile?.rank_code) {
    el('mRank').textContent = profile.rank_code;
  } else {
    el('mRank').textContent = 'Unranked';
  }

  if (rank?.paygrade) {
    const p = el('mPaygrade');
    p.style.display = '';
    p.textContent = rank.paygrade;
  }

  if (rank?.image_url) {
    el('mRankImg').src = rank.image_url;
    el('mRankImg').alt = rank.name || 'Rank';
  }
})();
</script>

</body>
</html>
