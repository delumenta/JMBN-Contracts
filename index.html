<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Manifest</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png"
      href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png"
      sizes="32x32">

<style>
:root{ --border:#d6b44c; --accent:#f2d675; --text:#f7f1d0; --muted:#c9b06a }
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow-x:hidden;font-family:'Play',sans-serif;background:#000;color:var(--text);transition:opacity .6s ease}
body{opacity:0}

/* Layout */
.wrapper{position:relative;z-index:3;min-height:100%;display:grid;place-items:center;padding:28px}
.center{width:min(980px,96vw)}

/* Brand */
.brand{display:flex;align-items:center;gap:12px;margin-bottom:8px}
.brand-logo{width:56px;height:56px;object-fit:contain;filter:drop-shadow(0 0 8px rgba(242,214,117,.35))}
.brand-text h1{margin:0;font-size:clamp(24px,3.6vw,36px);color:var(--accent);font-weight:700}
.brand-text .tagline{color:var(--muted);font-size:clamp(12px,1.6vw,14px)}

/* Card base */
.card{
  background:rgba(11,11,11,.85);
  border:1px solid var(--border);
  border-radius:14px;
  padding:16px;
  box-shadow:0 0 18px rgba(214,180,76,.18),inset 0 0 0 1px rgba(214,180,76,.12);
  backdrop-filter:blur(6px) brightness(1.1) saturate(1.05);
  position:relative;overflow:hidden;
}

/* Buttons */
.btn{
  display:inline-flex;align-items:center;justify-content:center;
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);border:1px solid var(--border);
  border-radius:10px;padding:6px 12px;font-family:'Play';
  font-size:13px;font-weight:700;cursor:pointer;text-decoration:none;
  transition:.2s;
}
.btn:hover{background:var(--accent);color:#000}
.btn.small{padding:4px 8px;font-size:12px;border-radius:8px}
.btn-row{display:flex;gap:6px;margin-top:8px}

/* Lists */
.list{display:flex;flex-direction:column;gap:8px;margin-top:6px}
.item{border:1px solid var(--border);border-radius:10px;padding:10px;background:#0f0f0f}
.item h4{margin:0 0 4px;color:var(--accent);font-size:15px}
.item .meta{font-size:12px;color:var(--muted)}
.empty{color:var(--muted);font-size:13px;padding:10px}

/* Grid */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:820px){.grid-2{grid-template-columns:1fr}}
.action h3{margin:0 0 6px;color:var(--accent);font-size:18px}
.action p{margin:0 0 10px;color:var(--muted);font-size:13px}
.action a{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:10px;text-decoration:none;border:1px solid var(--border);background:var(--accent);color:#000;font-weight:800;width:fit-content}

/* Footer */
.footer{color:var(--muted);font-size:12px;margin-top:16px;text-align:center}
</style>
</head>
<body>
<div class="wrapper">
  <main class="center">
    <!-- Brand -->
    <div class="brand">
      <img class="brand-logo" alt="JMBN"
        src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png/v1/fill/w_66,h_66,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/0_New_JMBN_Logo_Gold.png">
      <div class="brand-text">
        <h1>JMBN Manifest System</h1>
        <div class="tagline">Hilarity • Immersion • Teamwork</div>
      </div>
    </div>

    <!-- Member -->
    <section class="card" id="memberCard">
      <div id="mName" style="font-weight:900;color:var(--accent);font-size:20px">Loading…</div>
      <div class="meta" id="mRank">Unranked</div>
    </section>

    <!-- Announcements -->
    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0;color:var(--accent);font-size:18px">Announcements</h3>
        <button id="postAnnc" class="btn small" style="display:none">+ Post</button>
      </div>
      <div id="annc" class="list"><div class="empty">No announcements yet.</div></div>
    </section>

    <div class="footer">Theme: Play • Gold Accents · Links: Relative URLs</div>
  </main>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
(async () => {
  const sb = getSupabase();
  const session = await requireAuth();
  if (!session) return;

  const esc = s => { const d=document.createElement('div'); d.textContent=s??''; return d.innerHTML; };
  const timeAgo = iso => {
    if(!iso) return ''; const s=Math.floor((Date.now()-new Date(iso))/1000);
    const t=[[31536000,'y'],[2592000,'mo'],[604800,'w'],[86400,'d'],[3600,'h'],[60,'m'],[1,'s']];
    for(const [sec,l] of t){if(s>=sec)return Math.floor(s/sec)+l+' ago'} return 'just now';
  };

  // Load user info
  try {
    const { data } = await sb.from('v_profiles_detailed')
      .select('handle,display_name,current_rank_name')
      .eq('user_id', session.user.id).maybeSingle();
    const name = data?.display_name || data?.handle || session.user.email?.split('@')[0];
    document.getElementById('mName').textContent = name;
    document.getElementById('mRank').textContent = data?.current_rank_name || 'Unranked';
  } catch (e) { console.warn('profile:', e.message); }

  // Check if elevated
  let elevated = false;
  try {
    const { data } = await sb.rpc('is_elevated', { u: session.user.id });
    elevated = !!data;
  } catch {}

  if (elevated) document.getElementById('postAnnc').style.display='';

  // Load announcements
  async function loadAnnouncements(){
    const box=document.getElementById('annc');
    try{
      const { data, error } = await sb
        .from('announcements')
        .select('id,title,body,created_at,posted_by')
        .order('created_at',{ascending:false}).limit(10);
      if(error) throw error;
      if(!data.length){box.innerHTML='<div class="empty">No announcements yet.</div>';return;}

      // Map names
      const uids=[...new Set(data.map(a=>a.posted_by).filter(Boolean))];
      let names={};
      if(uids.length){
        const { data: profs } = await sb
          .from('v_profiles_detailed')
          .select('user_id,handle,display_name')
          .in('user_id',uids);
        (profs||[]).forEach(p=>names[p.user_id]=p.display_name||p.handle||p.user_id.slice(0,8));
      }

      box.innerHTML = data.map(a=>{
        const who=names[a.posted_by]||'Officer';
        const controls = elevated ? `
          <div class="btn-row">
            <button class="btn small" data-edit="${a.id}">Edit</button>
            <button class="btn small" data-del="${a.id}" style="background:#300;color:#f88;border-color:#a00">Delete</button>
          </div>` : '';
        return `<div class="item">
          <h4>${esc(a.title||'Announcement')}</h4>
          <div class="meta">Posted by ${esc(who)} • ${timeAgo(a.created_at)}</div>
          ${a.body?`<div class="meta" style="margin-top:6px;color:var(--text)">${esc(a.body)}</div>`:''}
          ${controls}
        </div>`;
      }).join('');

      // Bind edit/delete
      if(elevated){
        box.querySelectorAll('[data-edit]').forEach(b=>b.onclick=async()=>{
          const id=b.getAttribute('data-edit');
          const title=prompt('New title?'); if(!title) return;
          const body=prompt('New body?')||null;
          try{
            const {error}=await sb.from('announcements').update({title,body}).eq('id',id);
            if(error) throw error; await loadAnnouncements();
          }catch(e){alert('Failed: '+e.message);}
        });
        box.querySelectorAll('[data-del]').forEach(b=>b.onclick=async()=>{
          const id=b.getAttribute('data-del');
          if(!confirm('Delete this announcement?'))return;
          try{
            const {error}=await sb.from('announcements').delete().eq('id',id);
            if(error) throw error; await loadAnnouncements();
          }catch(e){alert('Failed: '+e.message);}
        });
      }

    }catch(e){
      console.warn('annc:',e.message);
      box.innerHTML='<div class="empty" style="color:#f99">Failed to load.</div>';
    }
  }
  await loadAnnouncements();

  // Post new announcement
  document.getElementById('postAnnc').onclick=async()=>{
    const title=prompt('Announcement title?'); if(!title)return;
    const body=prompt('Body (optional):')||null;
    try{
      const {error}=await sb.from('announcements')
        .insert({title,body,posted_by:session.user.id});
      if(error) throw error; await loadAnnouncements();
    }catch(e){alert('Failed: '+e.message);}
  };
})();
</script>
</body>
</html>