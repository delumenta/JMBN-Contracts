<!DOCTYPE html>
<html lang="en"><!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JMBN Org Hub</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">
<style>
:root{ --bg:#000; --panel:#0b0b0b; --card:#0c0c0c; --border:#d6b44c; --accent:#f2d675; --text:#f7f1d0; --muted:#c9b06a; --bad:#ff6b6b; }
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0; color:var(--text); background:#000; font-family:'Play',system-ui,sans-serif}

/* Background */
#goldDust{position:fixed;inset:0;z-index:0;width:100%;height:100%;pointer-events:none;background:#000}
.hud-grid{position:fixed;inset:0;z-index:1;pointer-events:none;background-image:
 linear-gradient(rgba(255,230,150,.03) 1px, transparent 1px),
 linear-gradient(90deg, rgba(255,230,150,.03) 1px, transparent 1px);
 background-size:80px 80px; animation:drift 80s linear infinite}
@keyframes drift{from{background-position:0 0}to{background-position:-200px -200px}}
body::after{content:"";position:fixed;inset:0;z-index:2;pointer-events:none;
 background:radial-gradient(1200px 800px at 50% 45%,rgba(0,0,0,0) 35%,rgba(0,0,0,.45) 70%,rgba(0,0,0,.75) 100%),
 linear-gradient(to bottom,rgba(0,0,0,.25),rgba(0,0,0,.55))}

/* Layout */
.wrapper{position:relative; z-index:3; min-height:100%; padding:22px}
.center{width:min(1180px,96vw); margin-inline:auto}

/* Brand */
.brand{display:flex; align-items:center; gap:12px; margin-bottom:12px}
.brand-logo{width:56px; height:56px; object-fit:contain; filter:drop-shadow(0 0 8px rgba(242,214,117,.35))}
.brand h1{margin:0; font-size:clamp(22px,3.6vw,36px); color:var(--accent); font-weight:700}
.tagline{color:var(--muted); font-size:13px; margin-top:2px}

/* Cards */
.card{background:rgba(11,11,11,.9); border:1px solid var(--border); border-radius:14px; padding:14px;
 box-shadow:0 0 18px rgba(214,180,76,.18), inset 0 0 0 1px rgba(214,180,76,.12); backdrop-filter:blur(6px) brightness(1.1) saturate(1.05); position:relative; overflow:hidden}
.card::after{content:"";position:absolute;inset:0;border-radius:14px;background:
 linear-gradient(120deg,rgba(255,255,255,0) 30%,rgba(255,255,255,.16) 50%,rgba(255,255,255,0) 70%);
 transform:translateX(-100%);transition:transform .6s ease;pointer-events:none}
.card:hover::after{transform:translateX(100%)}

/* Member */
.member{display:grid; grid-template-columns:1fr 130px; gap:14px; align-items:center; margin-bottom:14px}
.member .name{font-weight:900; font-size:20px; color:var(--accent)}
.badge{border:1px solid var(--border); border-radius:999px; padding:4px 10px; font-size:12px; background:#0c0c0c; color:var(--muted)}
.rankline{display:flex; flex-wrap:wrap; align-items:center; gap:8px; font-size:14px; margin-top:6px}
.rankimg{width:120px; height:120px; object-fit:contain; border-radius:10px; border:1px solid var(--border); background:#0c0c0c; display:block; justify-self:end}
.small{font-size:12px; color:var(--muted); margin-top:4px}

/* Grid */
.grid{display:grid; grid-template-columns:2fr 1fr; gap:14px}
@media(max-width:980px){.grid{grid-template-columns:1fr}}

/* KPIs */
.kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:14px}
.kpi{background:#0a0a0a; border:1px solid var(--border); border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:6px}
.kpi .lbl{color:var(--muted); font-size:12px}
.kpi .val{font-size:22px; font-weight:900; color:var(--accent)}
.kpi .sub{font-size:12px; color:var(--muted)}
.list{display:flex; flex-direction:column; gap:8px; margin-top:6px}
.item{border:1px solid var(--border); border-radius:10px; padding:10px; background:#0f0f0f}
.item h4{margin:0 0 4px; color:var(--accent); font-size:15px}
.item .meta{font-size:12px; color:var(--muted)}
.empty{color:var(--muted); font-size:13px; padding:10px}

/* Section headers + buttons */
.hsec{display:flex; align-items:center; justify-content:space-between; margin-bottom:8px}
.hsec h3{margin:0; color:var(--accent); font-size:16px}
.btn{padding:7px 11px; border-radius:10px; background:linear-gradient(180deg,#0c0c0c,#060606);
 color:var(--accent); border:1px solid var(--border); cursor:pointer; font-family:'Play'}
.btn:hover{background:var(--accent); color:#000}
.link{color:var(--accent); text-decoration:none; font-weight:700}
a.inline{color:var(--accent); text-decoration:underline}

/* Expandable text */
.expand{cursor:pointer}
.expand-body{display:none; margin-top:6px; color:var(--text); font-size:13px}
.expand.open + .expand-body{display:block}

/* Countdown pill */
.countdown{display:inline-block; border:1px solid var(--border); border-radius:999px; padding:2px 8px; font-size:12px; color:var(--muted)}
</style>
</head>
<body>

<canvas id="goldDust"></canvas>
<div class="hud-grid"></div>

<div class="wrapper">
  <main class="center">
    <!-- Brand -->
    <div class="brand">
      <img class="brand-logo" alt="JMBN"
        src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png/v1/fill/w_66,h_66,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/0_New_JMBN_Logo_Gold.png">
      <div>
        <h1>JMBN Org Hub</h1>
        <div class="tagline">Hilarity • Immersion • Teamwork</div>
      </div>
    </div>

    <!-- Member card -->
    <section class="card member" id="memberCard">
      <div>
        <div class="name" id="mName">Loading…</div>
        <div class="rankline">
          <span id="mRank">Unranked</span>
          <span class="badge" id="mCategory">—</span>
          <span class="badge" id="mRole">Member</span>
        </div>
        <div class="small" id="mEmail"></div>
      </div>
      <img id="mRankImg" class="rankimg" alt="Rank">
    </section>

    <!-- KPIs -->
    <section class="kpis">
      <div class="kpi" id="kpiJoined">
        <div class="lbl">Total Missions Joined</div>
        <div class="val">—</div>
        <div class="sub" id="kpiJoinedSub">All time</div>
      </div>
      <div class="kpi" id="kpiAvgHours">
        <div class="lbl">Avg Mission Hours</div>
        <div class="val">—</div>
        <div class="sub">Across your joined missions</div>
      </div>
      <div class="kpi" id="kpiRecent">
        <div class="lbl">Last 5 Missions Joined</div>
        <div class="sub" id="kpiRecentList">Loading…</div>
      </div>
    </section>

    <!-- Main grid -->
    <section class="grid">
      <!-- Left: Ongoing/Events -->
      <div class="card">
        <div class="hsec">
          <h3>Upcoming Events (Planned / Active)</h3>
          <div style="display:flex;gap:8px">
            <a class="btn" href="mission-log.html">Open Mission Log</a>
          </div>
        </div>
        <div id="events" class="list"><div class="empty">Loading…</div></div>
      </div>

      <!-- Right: Announcements -->
      <div class="card">
        <div class="hsec">
          <h3>Announcements</h3>
          <a class="link" href="#" id="postAnnc" style="display:none">Post</a>
        </div>
        <div id="annc" class="list"><div class="empty">No announcements yet.</div></div>
      </div>
    </section>

    <div class="footer" style="text-align:center;margin-top:16px;color:var(--muted);font-size:12px">
      Theme: Play • Gold · Links are relative (GitHub Pages ready)
    </div>
  </main>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
/* helpers */
const $ = s => document.querySelector(s);
const esc = s => { const d=document.createElement('div'); d.textContent = s ?? ''; return d.innerHTML; };
const timeAgo = (iso) => {
  if(!iso) return '';
  const s = Math.floor((Date.now() - new Date(iso)) / 1000);
  const t = [[31536000,'y'],[2592000,'mo'],[604800,'w'],[86400,'d'],[3600,'h'],[60,'m'],[1,'s']];
  for(const [sec, label] of t){ if(s >= sec) return Math.floor(s/sec)+label+' ago'; }
  return 'just now';
};
const fmt = n => (n||n===0) ? Number(n).toLocaleString() : '—';

/* tiny starfield */
(function(){
  const c=document.getElementById('goldDust'),ctx=c.getContext('2d',{alpha:true});
  let W,H,DPR=Math.min(devicePixelRatio||1,2),stars=[];
  function resize(){W=c.width=innerWidth*DPR;H=c.height=innerHeight*DPR;c.style.width=innerWidth+'px';c.style.height=innerHeight+'px'}
  resize(); addEventListener('resize',resize);
  for(let i=0;i<700;i++) stars.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.2+.2});
  (function draw(){ctx.clearRect(0,0,W,H);ctx.globalCompositeOperation='lighter';ctx.fillStyle='rgba(242,214,117,.8)';
    for(const s of stars){ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,6.283);ctx.fill()} requestAnimationFrame(draw)})();
})();

/* main */
(async () => {
  const session = await requireAuth(); if(!session) return;
  const sb = getSupabase();

  /* member card */
  let me={};
  try{
    const { data, error } = await sb
      .from('v_profiles_detailed')
      .select('handle,display_name,current_rank_name,current_rank_code,current_rank_image_url,current_rank_category,ingame_role')
      .eq('user_id', session.user.id)
      .maybeSingle();
    if(error) throw error; me=data||{};
  }catch(e){ console.warn('member view:', e.message); }

  const handle = me.handle || me.display_name || (session.user.email||'').split('@')[0] || 'Pilot';
  $('#mName').textContent = handle.charAt(0).toUpperCase() + handle.slice(1);
  $('#mRank').textContent = me.current_rank_code ? `${me.current_rank_name||'Unranked'} (${me.current_rank_code})` : (me.current_rank_name||'Unranked');
  $('#mCategory').textContent = me.current_rank_category || '—';
  $('#mRole').textContent = me.ingame_role || 'Member';
  $('#mEmail').textContent = session.user.email || '';
  const rankImg = me.current_rank_image_url || ( me.current_rank_code ? sb.storage.from('Ranks').getPublicUrl(`${me.current_rank_code}.png`).data.publicUrl : '' );
  if(rankImg){ const img=$('#mRankImg'); img.src=rankImg; img.alt=me.current_rank_name||'Rank'; }

  /* officer? */
  let elevated=false;
  try{ const { data } = await sb.rpc('is_elevated',{ u: session.user.id }); elevated=!!data; }catch(e){}
  if(elevated) $('#postAnnc').style.display='';

  /* KPIs: joined count, avg hours, last 5 joined */
  (async function loadKPIs(){
    try{
      const { data, error } = await sb
        .from('mission_attendees')
        .select('mission_id, joined_at, missions(id, title, hours, start_time)')
        .eq('user_id', session.user.id)
        .order('joined_at', { ascending:false });
      if(error) throw error;
      const rows = data || [];

      $('#kpiJoined .val').textContent = fmt(rows.length);

      const hours = rows.map(r => Number(r.missions?.hours)).filter(n => Number.isFinite(n));
      const avg = hours.length ? (hours.reduce((a,b)=>a+b,0)/hours.length) : null;
      $('#kpiAvgHours .val').textContent = avg!=null ? (Math.round(avg*10)/10) : '—';

      if(!rows.length){ $('#kpiRecentList').textContent = 'No missions yet.'; return; }
      const last5 = rows.slice(0,5).map(r => {
        const m = r.missions || {};
        const when = m.start_time ? new Date(m.start_time).toLocaleDateString() : '';
        return `<div>• <span title="${esc(m.title||'Untitled')}">${esc(m.title||'Untitled')}</span> <span class="small" style="color:var(--muted)">(${when})</span></div>`;
      }).join('');
      $('#kpiRecentList').innerHTML = last5;
    }catch(e){
      $('#kpiRecentList').textContent = 'Failed to load.';
      console.warn('kpis:', e.message);
    }
  })();

  /* Upcoming Events = only future-dated Planned/Active */
  async function loadEvents(){
    const box = $('#events');
    box.innerHTML = '<div class="empty">Loading…</div>';
    try{
      const nowISO = new Date().toISOString();
      const { data, error } = await sb
        .from('missions')
        .select('id,title,status,start_time')
        .in('status',['Planned','Active'])
        .gt('start_time', nowISO)
        .order('start_time',{ ascending:true })
        .limit(24);
      if(error) throw error;

      if(!data.length){ box.innerHTML = '<div class="empty">No upcoming missions.</div>'; return; }

      // RSVP counts
      const ids = data.map(m=>m.id);
      const { data: counts } = await sb
        .from('mission_attendees')
        .select('mission_id')
        .in('mission_id', ids);
      const tally = {};
      (counts||[]).forEach(a => { tally[a.mission_id] = (tally[a.mission_id]||0)+1; });

      box.innerHTML = data.map(m => {
        const t = new Date(m.start_time);
        return `
          <div class="item">
            <h4>${esc(m.title||'Untitled')}</h4>
            <div class="meta">
              ${esc(m.status)} • ${t.toLocaleString()} •
              <span class="countdown" data-ts="${t.toISOString()}">—</span> •
              <span class="small">RSVP: ${fmt(tally[m.id]||0)}</span>
              &nbsp; · &nbsp;
              <a class="inline" href="mission-log.html">Open Mission Log</a>
            </div>
          </div>`;
      }).join('');

      // live countdown
      function tick(){
        document.querySelectorAll('.countdown').forEach(el=>{
          const ts = new Date(el.getAttribute('data-ts')).getTime();
          const diff = ts - Date.now();
          if(diff <= 0){ el.textContent = 'Started'; return; }
          const d = Math.floor(diff/86400000);
          const h = Math.floor((diff%86400000)/3600000);
          const m = Math.floor((diff%3600000)/60000);
          el.textContent = `${d}d ${h}h ${m}m`;
        });
      }
      tick(); setInterval(tick, 60000);

    }catch(e){
      $('#events').innerHTML = `<div class="empty" style="color:var(--bad)">Failed: ${esc(e.message)}</div>`;
    }
  }
  loadEvents();

  /* Announcements with posted-by, timeAgo, expandable body, officer edit/delete */
  async function loadAnnouncements(){
    const box = $('#annc');
    try{
      const { data, error } = await sb
        .from('announcements')
        .select('id,title,body,created_at,posted_by')
        .order('created_at', { ascending:false })
        .limit(8);
      if(error) throw error;

      if(!data.length){ box.innerHTML = '<div class="empty">No announcements yet.</div>'; return; }

      const uids = [...new Set(data.map(a=>a.posted_by).filter(Boolean))];
      let names = {};
      if(uids.length){
        const { data: users } = await sb
          .from('v_profiles_detailed')
          .select('user_id,handle,display_name')
          .in('user_id', uids);
        (users||[]).forEach(u => names[u.user_id] = u.handle || u.display_name || u.user_id.slice(0,8));
      }

      box.innerHTML = data.map(a => {
        const who = names[a.posted_by] || 'Officer';
        const when = timeAgo(a.created_at);
        const body = a.body ? `<div class="expand-body">${esc(a.body)}</div>` : '';
        const controls = elevated ? `
          <span style="float:right;display:flex;gap:8px">
            <a href="#" class="inline edit" data-id="${a.id}">Edit</a>
            <a href="#" class="inline del" data-id="${a.id}">Delete</a>
          </span>` : '';
        return `
          <div class="item">
            <div class="expand"><h4 style="display:inline">${esc(a.title||'Announcement')}</h4></div>
            ${controls}
            <div class="meta">Posted by ${esc(who)} • ${when}</div>
            ${body}
          </div>`;
      }).join('');

      box.querySelectorAll('.expand').forEach(el=>{
        el.onclick = ()=> el.classList.toggle('open');
      });

      if(elevated){
        box.querySelectorAll('.edit').forEach(btn=>{
          btn.onclick = async (e)=>{
            e.preventDefault();
            const id = btn.getAttribute('data-id');
            const title = prompt('New title?'); if(!title) return;
            const body = prompt('New body (blank to clear)') || null;
            const { error } = await sb.from('announcements').update({ title, body }).eq('id', id);
            if(error){ alert('Update failed: '+error.message); return; }
            loadAnnouncements();
          };
        });
        box.querySelectorAll('.del').forEach(btn=>{
          btn.onclick = async (e)=>{
            e.preventDefault();
            const id = btn.getAttribute('data-id');
            if(!confirm('Delete this announcement?')) return;
            const { error } = await sb.from('announcements').delete().eq('id', id);
            if(error){ alert('Delete failed: '+error.message); return; }
            loadAnnouncements();
          };
        });
      }
    }catch(e){
      $('#annc').innerHTML = `<div class="empty" style="color:var(--bad)">Failed: ${esc(e.message)}</div>`;
    }
  }
  loadAnnouncements();

  // quick post (officers only)
  $('#postAnnc').onclick = async (ev)=>{
    ev.preventDefault();
    const title = prompt('Announcement title?'); if(!title) return;
    const body  = prompt('Body (optional):') || null;
    const { error } = await sb.from('announcements').insert({ title, body });
    if(error){ alert('Post failed: '+error.message); return; }
    loadAnnouncements();
  };

})();
</script>
</body>
</html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Manifest — Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png"
      href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png"
      sizes="32x32">
<style>
:root{
  --bg:#000; --panel:#0b0b0b; --card:#0c0c0c; --row:#0a0a0a;
  --border:#d6b44c; --accent:#f2d675; --text:#f7f1d0; --muted:#c9b06a; --bad:#ff6b6b;
  --fs-base:14px; --fs-small:11px; --fs-table:13px; --fs-h1:clamp(18px,2.2vw,22px); --fs-h2:clamp(14px,1.6vw,16px);
}
*{box-sizing:border-box}
body{
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text);font-family:'Play',system-ui,sans-serif; margin:0; padding:14px; letter-spacing:.25px; font-size:var(--fs-base)
}

/* ===== Brand ===== */
.brand{display:flex;align-items:center;gap:10px;margin:0 0 8px;border-bottom:1px solid var(--border);padding-bottom:6px}
.brand-logo{width:44px;height:44px;object-fit:contain;filter:drop-shadow(0 0 4px rgba(242,214,117,.25))}
.brand h1{font-weight:700;font-size:var(--fs-h1);color:var(--accent);margin:0}

/* ===== Shiny nav ===== */
.nav{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
.nav-btn{
  --ring:#d6b44c;
  position:relative;display:inline-flex;align-items:center;justify-content:center;
  padding:7px 14px;border:1px solid var(--ring);border-radius:999px;
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);text-decoration:none;font-weight:700;letter-spacing:.2px;
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.12);
  transition:transform .15s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
}
.nav-btn:hover{transform:translateY(-1px);box-shadow:0 0 12px rgba(214,180,76,.25), inset 0 0 0 1px rgba(214,180,76,.18);background:linear-gradient(180deg,#1a1a1a,#0a0a0a)}
.nav-btn.active{
  color:#000;
  background:
    radial-gradient(120% 120% at 80% -20%, rgba(255,255,255,.32), rgba(255,255,255,0) 40%),
    linear-gradient(180deg,#f2d675,#e7c760);
  border-color:var(--ring);
  box-shadow:0 0 20px rgba(214,180,76,.45), inset 0 1px 0 rgba(255,255,255,.25), inset 0 -1px 0 rgba(0,0,0,.12);
}
.nav-btn.active::after{
  content:"";position:absolute;inset:0;border-radius:inherit;
  background:linear-gradient(120deg,rgba(255,255,255,0) 30%,rgba(255,255,255,.32) 50%,rgba(255,255,255,0) 70%);
  transform:translateX(-120%); animation:shine 2.8s ease-in-out infinite; pointer-events:none;
}
@keyframes shine{0%{transform:translateX(-120%)}35%,100%{transform:translateX(120%)}}

/* ===== Layout ===== */
.grid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
@media(max-width:1060px){.grid{grid-template-columns:1fr}}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:0 0 18px rgba(214,180,76,.22), inset 0 0 0 1px rgba(214,180,76,.12)}
.panel h2{margin:0 0 8px;color:var(--accent);font-size:var(--fs-h2)}

/* ===== KPIs ===== */
.kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
@media(max-width:880px){.kpis{grid-template-columns:repeat(2,1fr)}}
.kpi{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;box-shadow:inset 0 0 0 1px rgba(214,180,76,.12)}
.kpi h3{margin:0;color:var(--muted);font-size:11px;text-transform:uppercase}
.kpi .val{font-weight:800;font-size:20px;color:var(--accent);margin-top:6px}
.kpi .sub{font-size:11px;color:var(--muted);margin-top:2px}

/* ===== Lists ===== */
.list{display:flex;flex-direction:column;gap:8px}
.card{background:var(--row);border:1px solid var(--border);border-radius:12px;padding:10px;display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
.title{font-weight:800;color:var(--accent)}
.sub{font-size:12px;color:var(--muted)}
.badge{border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:11px;color:var(--muted);background:#0c0c0c}

/* ===== Tables ===== */
.tableWrap{border:1px solid var(--border);border-radius:12px;overflow:auto;max-height:70vh;margin-top:8px;background:var(--panel)}
.table{width:100%;border-collapse:collapse;min-width:980px}
.table th,.table td{padding:10px;border-bottom:1px solid rgba(214,180,76,.25);text-align:left}
.table thead th{position:sticky;top:0;background:var(--panel);color:var(--accent);z-index:1}
.row-actions{display:flex;gap:6px;flex-wrap:wrap}
.btn{padding:7px 10px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(180deg,#0c0c0c,#060606);color:var(--accent);cursor:pointer}
.btn:hover{background:var(--accent);color:#000}
.btn.bad{border-color:var(--bad);color:var(--bad)}

/* ===== Toolbar ===== */
.toolbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
input[type="search"],select{background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:8px 10px;color:var(--text)}

/* ===== Attendance Modal ===== */
.attend-bg{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:50}
.attend{width:min(560px,95vw);background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 0 26px rgba(214,180,76,.25)}
.attend h3{margin:0 0 8px;color:var(--accent)}
.attend .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.attend .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
.hint{font-size:11px;color:#c9b06a}

/* sticky right */
.sticky{position:sticky;top:12px;height:fit-content}
</style>
</head>
<body>
  <div class="brand">
    <img class="brand-logo" src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" alt="JMBN">
    <h1>JMBN Manifest — Dashboard</h1>
  </div>

  <nav class="nav">
    <a class="nav-btn active" href="index.html">Manifest</a>
    <a class="nav-btn" href="hangar.html">Hangar</a>
    <a class="nav-btn" href="components.html">Components</a>
    <a class="nav-btn" href="contracts.html">Contracts</a>
    <a class="nav-btn" href="mission-log.html">Mission Log</a>
  </nav>

  <!-- ===== KPI STRIP ===== -->
  <div class="panel">
    <div class="kpis">
      <div class="kpi"><h3>Total Missions</h3><div class="val" id="kpiMissions">0</div><div class="sub">after filters</div></div>
      <div class="kpi"><h3>Total Payout</h3><div class="val" id="kpiPayout">0</div><div class="sub">aUEC (sum)</div></div>
      <div class="kpi"><h3>Planned</h3><div class="val" id="kpiPlanned">0</div><div class="sub">upcoming only</div></div>
      <div class="kpi"><h3>Active</h3><div class="val" id="kpiActive">0</div><div class="sub">right now</div></div>
    </div>
  </div>

  <div class="grid" style="margin-top:12px">
    <!-- LEFT: Ongoing & Upcoming -->
    <section class="panel">
      <h2>Ongoing & Upcoming Missions</h2>
      <div class="toolbar" style="margin:8px 0 6px">
        <input id="search" type="search" placeholder="Search title / type / tags / status…" />
        <select id="typeFilter"><option value="">All types</option><option>Hauling</option><option>Delivery</option><option>Rescue</option><option>Bounty</option><option>Salvage</option><option>Mining</option><option>Exploration</option></select>
        <select id="statusFilter"><option value="">Planned + Active</option><option>Planned</option><option>Active</option></select>
        <button class="btn" id="refresh">↻ Refresh</button>
        <a class="btn" href="mission-editor.html">＋ Open Mission Editor</a>
      </div>
      <div class="tableWrap">
        <table class="table">
          <thead><tr>
            <th>Mission</th><th>Type</th><th>Status</th><th>Origin</th><th>Destination</th>
            <th>Date</th><th>Hours</th><th>Payout</th><th>Tags</th><th>Actions</th>
          </tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>

    <!-- RIGHT: Last 5 joined + Quick Settings -->
    <aside class="panel sticky">
      <h2>Last 5 Missions Joined</h2>
      <div id="joined" class="list"></div>
      <div class="card" style="margin-top:10px">
        <div>
          <div class="title">Settings</div>
          <div class="sub">Used for attendance & highlighting</div>
        </div>
      </div>
      <div class="card">
        <div style="display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center">
          <div>
            <div class="sub" style="margin-bottom:6px">Your Callsign</div>
            <input id="callsign" placeholder="e.g., Derek / Vex" style="width:100%" />
            <div class="hint" style="margin-top:6px">Saved locally as <code>jmbn-callsign</code>.</div>
          </div>
          <button class="btn" id="saveName">Save</button>
        </div>
      </div>
    </aside>
  </div>

  <!-- ===== Attendance Modal ===== -->
  <div class="attend-bg" id="attendBg" role="dialog" aria-modal="true">
    <div class="attend">
      <h3 id="attendTitle">Attend Mission</h3>
      <div class="grid" style="grid-template-columns:1fr">
        <div>
          <label class="sub">Your Callsign</label>
          <input id="attendName" placeholder="e.g., Derek / Vex" />
        </div>
        <div>
          <label class="sub">Note (optional)</label>
          <input id="attendNote" placeholder="e.g., bringing C2 / medical" />
        </div>
      </div>
      <div class="hint" style="margin-top:8px">This demo records attendance locally in <code>jmbn-attendance</code>. Use the Mission Editor to update the official attendees list.</div>
      <div class="actions">
        <button class="btn" id="withdrawBtn">Withdraw</button>
        <button class="btn" id="attendBtn">I'm Going</button>
        <button class="btn bad" id="closeAttend">Close</button>
      </div>
    </div>
  </div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

// ===== Supabase config (same as mission pages) =====
const SUPABASE_URL  = 'https://fcegavhipeaeihxegsnw.supabase.co'
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjZWdhdmhpcGVhZWloeGVnc253Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMjk3NTcsImV4cCI6MjA3NzcwNTc1N30.i-ZjOlKc89-uA7fqOIvmAMv60-C2_NmKikRI_78Jei8'
const sb = createClient(SUPABASE_URL, SUPABASE_ANON)

// ===== DOM =====
const tbody = document.getElementById('tbody')
const joined = document.getElementById('joined')
const search = document.getElementById('search')
const fType = document.getElementById('typeFilter')
const fStatus = document.getElementById('statusFilter')
const refreshBtn = document.getElementById('refresh')

const kMissions = document.getElementById('kpiMissions')
const kPayout   = document.getElementById('kpiPayout')
const kPlanned  = document.getElementById('kpiPlanned')
const kActive   = document.getElementById('kpiActive')

const callsignEl = document.getElementById('callsign')
const saveNameBtn = document.getElementById('saveName')

// Attendance modal
const attendBg = document.getElementById('attendBg')
const attendTitle = document.getElementById('attendTitle')
const attendName = document.getElementById('attendName')
const attendNote = document.getElementById('attendNote')
const attendBtn = document.getElementById('attendBtn')
const withdrawBtn = document.getElementById('withdrawBtn')
const closeAttend = document.getElementById('closeAttend')
let attendId = null

// ===== Local store helpers =====
const esc=(s='')=>{const d=document.createElement('div');d.textContent=s;return d.innerHTML}
const fmtDate=iso=>iso?new Date(iso).toLocaleString():''
const fmtNum=n=> (n||n===0) ? Number(n).toLocaleString() : ''
const getName=()=> localStorage.getItem('jmbn-callsign')||''
const setName=v=> localStorage.setItem('jmbn-callsign', v||'')
const getAttendance=()=> JSON.parse(localStorage.getItem('jmbn-attendance')||'{}')
const setAttendance=m=> localStorage.setItem('jmbn-attendance', JSON.stringify(m))

// ===== Filters (spec: ignore start *time*, only compare the DATE part) =====
function isUpcomingOrToday(iso){
  if(!iso) return true; // if no date, keep in list
  const d=new Date(iso); const now=new Date();
  const day=(x)=> new Date(x.getFullYear(), x.getMonth(), x.getDate()).getTime()
  return day(d) >= day(now)
}

let cache=[]

function row(r){
  const myName = getName().trim()
  const attMap = getAttendance()
  const going = !!attMap[r.id]?.find?.(x=> x.name?.toLowerCase()===myName.toLowerCase())
  return `<tr>
    <td><b style="color:var(--accent)">${esc(r.title||'(untitled)')}</b></td>
    <td>${r.type?`<span class="badge">${esc(r.type)}</span>`:''}</td>
    <td>${r.status?`<span class="badge">${esc(r.status)}</span>`:''}</td>
    <td>${esc(r.origin||'')}</td>
    <td>${esc(r.destination||'')}</td>
    <td>${fmtDate(r.start_time)}</td>
    <td>${r.hours??''}</td>
    <td>${fmtNum(r.payout_auec)}</td>
    <td>${esc(r.tags||'')}</td>
    <td>
      <div class="row-actions">
        <button class="btn" data-act="attend" data-id="${r.id}">${going? 'Update RSVP' : "I'm going"}</button>
        <a class="btn" href="mission-editor.html?id=${encodeURIComponent(r.id)}">Edit</a>
      </div>
    </td>
  </tr>`
}

function render(){
  const q=(search.value||'').toLowerCase();
  const tf=(fType.value||'').toLowerCase();
  const sf=(fStatus.value||'');
  let rows = cache.filter(r=> ['Planned','Active'].includes(r.status||''))
                  .filter(r=> isUpcomingOrToday(r.start_time))
  if(tf) rows = rows.filter(r=> (r.type||'').toLowerCase()===tf)
  if(sf) rows = rows.filter(r=> (r.status||'')===sf)
  if(q)  rows = rows.filter(r=> `${r.title} ${r.type||''} ${r.status||''} ${r.tags||''} ${r.origin||''} ${r.destination||''}`.toLowerCase().includes(q))

  // KPIs
  const total = rows.length
  const sum = rows.reduce((s,r)=> s + (Number(r.payout_auec||0)||0), 0)
  const planned = rows.filter(r=>r.status==='Planned').length
  const active  = rows.filter(r=>r.status==='Active').length
  kMissions.textContent = total
  kPayout.textContent   = sum.toLocaleString()
  kPlanned.textContent  = planned
  kActive.textContent   = active

  tbody.innerHTML = rows.map(row).join('') || `<tr><td colspan="10" style="padding:12px;color:var(--muted)">No missions match the filters.</td></tr>`
}

function renderJoined(){
  const name = getName().trim().toLowerCase()
  if(!name){ joined.innerHTML = `<div class="sub">Set your callsign to see your recent missions.</div>`; return }
  const attMap = getAttendance()
  const mine = cache.filter(r=> (attMap[r.id]||[]).some(x=> (x.name||'').toLowerCase()===name))
                    .sort((a,b)=> new Date(b.start_time||b.created_at||0) - new Date(a.start_time||a.created_at||0))
                    .slice(0,5)
  joined.innerHTML = mine.length ? mine.map(r=>
    `<div class="card">
      <div>
        <div class="title">${esc(r.title||'(untitled)')}</div>
        <div class="sub">${esc(r.type||'')} • ${esc(r.status||'')} • ${fmtDate(r.start_time)}</div>
      </div>
      <a class="btn" href="mission-editor.html?id=${encodeURIComponent(r.id)}">Open</a>
    </div>`
  ).join('') : `<div class="sub">No recent missions with your name.</div>`
}

async function load(){
  const { data, error } = await sb.from('missions')
    .select('id,title,type,status,origin,destination,start_time,hours,payout_auec,tags,created_at')
    .order('created_at',{ascending:false})
  if(error){
    tbody.innerHTML = `<tr><td colspan="10" style="padding:12px;color:var(--muted)">Failed to load missions: ${esc(error.message)}</td></tr>`
    return
  }
  cache = data || []
  render(); renderJoined()
}

// ===== Attendance (local demo) =====
function openAttend(id){
  attendId = id
  const row = cache.find(r=>r.id===id)
  attendTitle.textContent = `RSVP: ${row?.title||id}`
  attendName.value = getName()
  attendNote.value = ''
  attendBg.style.display='flex'
}
function closeAttend(){ attendBg.style.display='none'; attendId=null }

attendBtn.onclick = ()=>{
  if(!attendId) return
  const name = (attendName.value||'').trim(); if(!name){ alert('Enter your callsign'); return }
  setName(name)
  const map = getAttendance(); const arr = map[attendId] || []
  // add/update entry
  const i = arr.findIndex(x=> (x.name||'').toLowerCase()===name.toLowerCase())
  const entry = { name, note: attendNote.value.trim(), at: new Date().toISOString() }
  if(i>=0) arr[i]=entry; else arr.push(entry)
  map[attendId]=arr; setAttendance(map)
  closeAttend(); renderJoined(); render()
}
withdrawBtn.onclick = ()=>{
  if(!attendId) return
  const name = (attendName.value||'').trim(); if(!name){ alert('Enter your callsign'); return }
  const map = getAttendance(); const arr = (map[attendId]||[]).filter(x=> (x.name||'').toLowerCase()!==name.toLowerCase())
  map[attendId]=arr; setAttendance(map)
  closeAttend(); renderJoined(); render()
}
closeAttend.onclick = closeAttend
attendBg.addEventListener('click', e=>{ if(e.target===attendBg) closeAttend() })

tbody.addEventListener('click', (e)=>{
  const b = e.target.closest('button'); if(!b) return
  if(b.dataset.act==='attend'){ openAttend(b.dataset.id) }
})

// ===== Wire-up =====
search.oninput = render; fType.onchange = render; fStatus.onchange = render; refreshBtn.onclick = load
callsignEl.value = getName(); saveNameBtn.onclick = ()=>{ setName(callsignEl.value); renderJoined(); render() }

await load()
</script>

<!-- highlight nav -->
<script>
(() => {
  const here = location.pathname.split('/').pop() || 'index.html';
  document.querySelectorAll('.nav-btn').forEach(a=>{ if(a.getAttribute('href')===here) a.classList.add('active') })
})();
</script>
</body>
</html>
