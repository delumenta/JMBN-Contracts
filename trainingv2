<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JMBN – Training</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--card:#0c0c0c;--border:#d6b44c;
  --accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;
}
*{box-sizing:border-box}
body{
  margin:0;padding:14px;background:
    radial-gradient(900px 700px at 20% -5%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(1000px 900px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text);
  font-family:'Play',system-ui,sans-serif;
}
.panel{
  background:var(--panel);border:1px solid var(--border);
  border-radius:12px;padding:14px;max-width:1100px;margin:20px auto;
  box-shadow:0 0 20px rgba(214,180,76,.15)
}
h1{margin:0 0 12px;text-align:center;color:var(--accent);}

/* certification cards */
.cert-card{
  background:var(--card);border:1px solid var(--border);
  border-radius:12px;padding:12px;margin-top:12px;
}
.cert-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.cert-header img{width:64px;height:64px;object-fit:contain;border-radius:8px;}
.cert-title{font-weight:700;color:var(--accent)}
.progress{height:8px;background:#111;border-radius:5px;overflow:hidden;margin-top:6px;}
.progress-bar{height:100%;background:var(--border);transition:width .4s ease;}
ul.events{list-style:none;margin:8px 0 0;padding:0;}
ul.events li{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,.05);}
ul.events li span.done{color:var(--accent);}
ul.events li span.pending{color:var(--muted);}

/* admin panel */
#adminPanel{margin-top:30px;background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:14px;}
#adminPanel h2{color:var(--accent);margin-top:0;}
select,button,input{
  background:#111;color:var(--text);border:1px solid var(--border);
  border-radius:6px;padding:6px 10px;font-family:'Play';
}
button:hover{background:var(--border);color:#000;cursor:pointer;}
.training-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid rgba(255,255,255,.05);}
</style>
</head>
<body>

<!-- header -->
<div id="header-container"></div>
<script>
(async()=>{
  const res = await fetch('header.html',{cache:'no-cache'});
  const html = await res.text();
  document.getElementById('header-container').outerHTML = html;
})();
</script>

<div class="panel">
  <h1>Training & Certifications</h1>
  <div id="certList"></div>

  <!-- Admin controls -->
  <div id="adminPanel" style="display:none;">
    <h2>Admin Panel</h2>
    <div>
      <label for="userSelect">Select User:</label>
      <select id="userSelect"></select>
    </div>
    <div id="adminUserTraining"></div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
let sb, session, me, isElevated=false;

const $ = s => document.querySelector(s);

document.addEventListener('DOMContentLoaded', async()=>{
  session = await requireAuth();
  if(!session) return;
  sb = getSupabase();
  me = session.user.id;

  const { data: elev } = await sb.rpc('is_elevated',{ u: me });
  isElevated = elev === true;
  if(isElevated) $('#adminPanel').style.display='block';

  loadCertifications(me);
  if(isElevated) loadAdminUsers();
});

/* ---------- MEMBER VIEW ---------- */
async function loadCertifications(uid){
  const { data: certs } = await sb.from('certifications')
    .select('certification_code,name,image_url,sort_order')
    .order('sort_order');

  const { data: reqs } = await sb.from('certification_requirements')
    .select('certification_code,event_code,training_events(title),sort_order')
    .order('sort_order');

  const { data: done } = await sb.from('user_training_events')
    .select('event_code')
    .eq('user_id', uid);

  const doneSet = new Set(done.map(d=>d.event_code));
  const list = $('#certList');
  list.innerHTML = '';

  for(const cert of certs){
    const events = reqs.filter(r=>r.certification_code===cert.certification_code);
    const total = events.length;
    const completed = events.filter(e=>doneSet.has(e.event_code)).length;
    const pct = Math.round((completed/total)*100);

    const evHTML = events.map(e=>`
      <li>
        <span>${e.training_events.title}</span>
        <span class="${doneSet.has(e.event_code)?'done':'pending'}">
          ${doneSet.has(e.event_code)?'✅ Completed':'⏳ Pending'}
        </span>
      </li>`).join('');

    list.innerHTML += `
      <div class="cert-card">
        <div class="cert-header">
          <div>
            <div class="cert-title">${cert.name}</div>
            <div class="progress"><div class="progress-bar" style="width:${pct}%"></div></div>
          </div>
          ${cert.image_url?`<img src="${cert.image_url}" alt="${cert.name}">`:''}
        </div>
        <ul class="events">${evHTML}</ul>
      </div>`;
  }
}

/* ---------- ADMIN PANEL ---------- */
async function loadAdminUsers(){
  const { data: users } = await sb.from('profiles').select('id,handle').order('handle');
  const sel = $('#userSelect');
  sel.innerHTML = users.map(u=>`<option value="${u.id}">${u.handle}</option>`).join('');
  sel.onchange = e => loadUserTraining(e.target.value);
  if(users.length) loadUserTraining(users[0].id);
}

async function loadUserTraining(uid){
  const { data: allEv } = await sb.from('training_events').select('event_code,title').order('sort_order');
  const { data: done } = await sb.from('user_training_events').select('event_code').eq('user_id', uid);
  const doneSet = new Set(done.map(d=>d.event_code));

  const panel = $('#adminUserTraining');
  panel.innerHTML = `
    <h3>Training Events for ${$('#userSelect').options[$('#userSelect').selectedIndex].text}</h3>
    ${allEv.map(e=>`
      <div class="training-row">
        <span>${e.title}</span>
        ${doneSet.has(e.event_code)
          ? `<button data-remove="${e.event_code}">Remove</button>`
          : `<button data-add="${e.event_code}">Mark Complete</button>`}
      </div>`).join('')}
  `;

  panel.querySelectorAll('button[data-add]').forEach(btn=>{
    btn.onclick = async()=>{
      await sb.from('user_training_events').insert({
        user_id: uid, event_code: btn.dataset.add, completed_at: new Date().toISOString()
      });
      loadUserTraining(uid);
    };
  });

  panel.querySelectorAll('button[data-remove]').forEach(btn=>{
    btn.onclick = async()=>{
      await sb.from('user_training_events').delete()
        .eq('user_id', uid)
        .eq('event_code', btn.dataset.remove);
      loadUserTraining(uid);
    };
  });
}
</script>
</body>
</html>
