<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Mission Editor</title>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{ --bg:#000; --panel:#0b0b0b; --border:#d6b44c; --accent:#f2d675; --text:#f7f1d0; --muted:#c9b06a }
*{box-sizing:border-box}
body{ background:#000; color:var(--text); font-family:'Play',sans-serif; margin:0; padding:18px }
.brand{display:flex;align-items:center;gap:10px;margin:0 0 10px;border-bottom:1px solid var(--border);padding-bottom:8px}
.brand-logo{width:44px;height:44px;object-fit:contain;filter:drop-shadow(0 0 4px rgba(242,214,117,.25))}
.brand h1{margin:0;color:var(--accent);font-size:22px}
.toolbar{display:flex;gap:10px;align-items:center;margin:10px 0 16px;flex-wrap:wrap}
.btn-cta{display:inline-flex;align-items:center;gap:10px;padding:9px 12px;border:1px solid var(--border);border-radius:12px;background:linear-gradient(180deg,#0c0c0c,#060606);color:var(--accent);text-decoration:none;font-weight:700}
.btn-cta:hover{background:linear-gradient(180deg,#f2d675,#e7c760);color:#000}
.ic{width:18px;height:18px;border:1px solid var(--border);border-radius:50%;display:grid;place-items:center;font-size:14px}
.subtle{color:var(--muted);font-size:12px}
.mode-chip{margin-left:auto;border:1px solid var(--border);border-radius:10px;padding:6px 10px;background:#0a0a0a;color:var(--accent);font-size:12px}
.wrap{display:grid;grid-template-columns:340px 1fr;gap:14px}
@media(max-width:980px){.wrap{grid-template-columns:1fr}}
.panel{background:#0b0b0b;border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:0 0 18px rgba(214,180,76,.14)}
.panel h3{margin:0 0 10px;color:var(--accent);font-size:16px}
.list-tools{display:flex;gap:8px;align-items:center;margin-bottom:8px}
input[type="search"]{width:100%;background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:8px 10px;color:var(--text)}
.list{display:flex;flex-direction:column;gap:8px;max-height:70vh;overflow:auto;padding-right:4px}
.item{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px;border:1px solid var(--border);border-radius:10px;background:#0a0a0a;cursor:pointer}
.item:hover{background:#111}
.item-title{font-weight:700}
.item-sub{font-size:12px;color:var(--muted)}
.badge{border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:11px;color:var(--muted)}
.small-btn{padding:6px 8px;border:1px solid var(--border);border-radius:8px;background:transparent;color:var(--accent);cursor:pointer}
.small-btn:hover{background:var(--accent);color:#000}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.form-grid.full{grid-template-columns:1fr}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
input,select,textarea{width:100%;background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:10px;color:var(--text);font-family:'Play'}
textarea{min-height:90px;resize:vertical}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
button{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:linear-gradient(180deg,#0c0c0c,#060606);color:var(--accent);cursor:pointer}
button:hover{background:var(--accent);color:#000}
button.danger{border-color:#ff6b6b;color:#ff6b6b}
.attach-item{display:grid;grid-template-columns:1fr 1fr auto;gap:10px;margin-bottom:8px}
.attach-item button{padding:6px 10px}
</style>
</head>
<body>

<!-- Header -->
<div class="brand">
  <img class="brand-logo" src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" alt="JMBN">
  <h1 style="margin-right:auto">JMBN Mission Editor</h1>
</div>

<!-- Toolbar -->
<div class="toolbar">
  <a class="btn-cta" href="mission-log.html" title="Go back"><span class="ic">‚Üê</span><span>Back to Mission Log</span></a>
  <span class="subtle">View missions on the left. Select to edit; Save, Update, or Delete on the right.</span>
  <span id="modeChip" class="mode-chip">Create</span>
</div>

<!-- Two Column Layout -->
<div class="wrap">
  <!-- LEFT: List -->
  <div class="panel">
    <h3>All Missions</h3>
    <div class="list-tools">
      <input id="search" type="search" placeholder="Search title / tags / status..." />
      <button id="refresh" class="small-btn">‚Üª</button>
      <button id="newBtn" class="small-btn">Ôºã New</button>
    </div>
    <div id="list" class="list"></div>
  </div>

  <!-- RIGHT: Editor -->
  <div class="panel">
    <h3>Mission Details</h3>

    <div class="form-grid full">
      <div><label>Mission Title</label><input id="title" placeholder="e.g., RW S2 ‚Äî 24-box Haul"></div>
    </div>

    <div class="form-grid">
      <div>
        <label>Type</label>
        <select id="type">
          <option></option><option>Hauling</option><option>Delivery</option><option>Rescue</option>
          <option>Bounty</option><option>Investigation</option><option>Salvage</option>
          <option>Mining</option><option>Exploration</option>
        </select>
      </div>
      <div>
        <label>Status</label>
        <select id="status">
          <option></option><option>Planned</option><option>Open</option><option>Closed</option>
          <option>Cancelled</option><option>Completed</option>
        </select>
      </div>
    </div>

    <div class="form-grid">
      <div><label>Origin</label><input id="origin"></div>
      <div><label>Destination</label><input id="destination"></div>
    </div>

    <div class="form-grid">
      <div><label>Date</label><input id="date" type="datetime-local"></div>
      <div><label>No. of Hours</label><input id="hours" type="number" step="0.1"></div>
    </div>

    <div class="form-grid">
      <div><label>Payout (aUEC)</label><input id="payout" type="number" step="1"></div>
      <div><label>Tags</label><input id="tags" placeholder="e.g., hauling, night"></div>
    </div>

    <div class="form-grid full">
      <div><label>Attendees</label><input id="attendees" placeholder="e.g., Vex, Kara"></div>
    </div>

    <div class="form-grid full">
      <div><label>Submitted By</label><input id="submittedBy" readonly></div>
    </div>

    <div class="form-grid full">
      <div>
        <label>Attachments</label>
        <div id="attachList"></div>
        <button id="addAttachBtn" class="small-btn" type="button">Add Attachment</button>
      </div>
    </div>

    <div class="form-grid full">
      <div><label>Notes / AAR</label><textarea id="notes"></textarea></div>
    </div>

    <div class="actions">
      <button id="clearFormBtn">Clear Form</button>
      <button id="saveNewBtn">üíæ Save New</button>
      <button id="updateBtn">‚úé Update Current</button>
      <button id="deleteBtn" class="danger">üóë Delete</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script type="module">
/* Initialize Supabase Client */
const sb = window.sb ?? (() => {
  const url = 'https://YOURPROJECT.supabase.co';       // üîß replace
  const key = 'YOUR_ANON_KEY';                        // üîß replace
  const { createClient } = supabase;
  const c = createClient(url, key);
  window.sb = c;
  return c;
})();

const $ = (id) => document.getElementById(id);
const listEl = $('list'), searchEl = $('search'), modeChip = $('modeChip'), attachList = $('attachList');
let currentId = null, cache = [];

/* Utility Helpers */
const esc = s => { const d = document.createElement('div'); d.textContent = s ?? ''; return d.innerHTML; };
const isoToLocalInput = iso => iso ? new Date(iso).toISOString().slice(0,16) : '';
const localInputToISO = v => v ? new Date(v).toISOString() : null;

/* Attachments */
function addAttachRow(name='',url=''){ const d=document.createElement('div');
  d.className='attach-item';
  d.innerHTML=`<input placeholder="Label" value="${esc(name)}">
               <input placeholder="URL (https://...)" value="${esc(url)}">
               <button type="button" onclick="this.parentElement.remove()">‚úï</button>`;
  attachList.appendChild(d);
}
const collectAttachments=()=>[...attachList.querySelectorAll('.attach-item')].map(e=>{
  const name=e.children[0].value.trim(),url=e.children[1].value.trim();
  if(!url) return null;
  try{new URL(url)}catch{return null;}
  return{name,url};
}).filter(Boolean);

function clearForm(){
  ['title','type','status','origin','destination','date','hours','payout','tags','attendees','notes'].forEach(i=>$(i).value='');
  attachList.innerHTML=''; addAttachRow(); currentId=null; modeChip.textContent='Create';
}
function payloadFromForm(){
  return {
    title:$('title').value.trim(),
    type:$('type').value||null,
    status:$('status').value||null,
    origin:$('origin').value||null,
    destination:$('destination').value||null,
    start_time:localInputToISO($('date').value),
    hours:Number($('hours').value||0),
    payout_auec:Number($('payout').value||0),
    tags:$('tags').value||null,
    attendees:$('attendees').value||null,
    notes:$('notes').value||null,
    attachments:collectAttachments()
  };
}

/* CRUD */
async function loadList(){
  const { data, error } = await sb.from('missions')
    .select('id,title,type,status,start_time,created_at,tags')
    .order('created_at',{ascending:false});
  if(error){ console.error(error); return; }
  cache = data || [];
  renderList(cache);
}
function renderList(rows){
  listEl.innerHTML='';
  if(!rows.length){ listEl.innerHTML='<div class="item"><div>No missions</div></div>'; return; }
  rows.forEach(r=>{
    const el=document.createElement('div');
    el.className='item';
    el.innerHTML=`<div><div class="item-title">${esc(r.title)}</div>
    <div class="item-sub">${esc(r.type||'')} ‚Ä¢ ${esc(r.status||'')} ‚Ä¢ ${r.start_time?new Date(r.start_time).toLocaleString():''}</div></div>
    <div style="display:flex;gap:6px;align-items:center">
    <span class="badge">${esc(r.id.slice(0,8))}</span>
    <button class="small-btn" onclick="openMission('${r.id}')">Open</button></div>`;
    listEl.appendChild(el);
  });
}
window.openMission=async function(id){
  const { data, error } = await sb.from('missions').select('*').eq('id',id).single();
  if(error){ alert('Failed: '+error.message); return; }
  currentId=id; fillForm(data); modeChip.textContent='Editing '+id.slice(0,8);
};
function fillForm(r){
  $('title').value=r.title||''; $('type').value=r.type||''; $('status').value=r.status||'';
  $('origin').value=r.origin||''; $('destination').value=r.destination||'';
  $('date').value=isoToLocalInput(r.start_time); $('hours').value=r.hours??'';
  $('payout').value=r.payout_auec??''; $('tags').value=r.tags||'';
  $('attendees').value=r.attendees||''; $('notes').value=r.notes||'';
  $('submittedBy').value=r.submitted_by||''; attachList.innerHTML='';
  if(Array.isArray(r.attachments)&&r.attachments.length)r.attachments.forEach(a=>addAttachRow(a.name,a.url));
  else addAttachRow();
}
async function saveNew(){
  const { data:{user} }=await sb.auth.getUser();
  if(!user){ alert('Please log in again'); return; }
  const payload=payloadFromForm();
  payload.submitted_by=user.id;
  $('submittedBy').value=user.email||user.id;
  const { data,error }=await sb.from('missions').insert(payload).select().single();
  if(error){ alert('Save failed: '+error.message); console.error(error); return; }
  alert('Saved ‚úì'); await loadList(); openMission(data.id);
}
async function updateCurrent(){
  if(!currentId){ alert('Select a mission'); return; }
  const payload=payloadFromForm();
  const { error }=await sb.from('missions').update(payload).eq('id',currentId);
  if(error){ alert('Update failed: '+error.message); return; }
  alert('Updated ‚úì'); await loadList();
}
async function deleteCurrent(){
  if(!currentId||!confirm('Delete this mission?'))return;
  const { error }=await sb.from('missions').delete().eq('id',currentId);
  if(error){ alert('Delete failed: '+error.message); return; }
  alert('Deleted üóë'); await loadList(); clearForm();
}

/* Bind UI */
function bindUI(){
  $('addAttachBtn').onclick=()=>addAttachRow();
  $('clearFormBtn').onclick=()=>clearForm();
  $('saveNewBtn').onclick=saveNew;
  $('updateBtn').onclick=updateCurrent;
  $('deleteBtn').onclick=deleteCurrent;
  $('refresh').onclick=loadList;
  $('newBtn').onclick=clearForm;
  $('search').oninput=()=>renderList(cache.filter(r=>(r.title||'').toLowerCase().includes(searchEl.value.toLowerCase())));
}

/* üîê Auth Guard + Role Lock */
document.addEventListener('DOMContentLoaded',async()=>{
  const { data:{ user } } = await sb.auth.getUser();
  if(!user){ location.href='index.html'; return; }

  // Check role
  const { data: prof } = await sb.from('v_profiles').select('roles').eq('user_id',user.id).single();
  const canPost=(prof?.roles||[]).some(r=>['admin','officer'].includes(r));

  if(!canPost){
    $('saveNewBtn').disabled=true;
    $('updateBtn').disabled=true;
    $('deleteBtn').disabled=true;
    document.querySelector('.subtle').innerText='View-only access (members cannot create missions)';
  }

  $('submittedBy').value=user.email||user.id;
  bindUI(); addAttachRow(); await loadList();
});
</script>
</body>
</html>
