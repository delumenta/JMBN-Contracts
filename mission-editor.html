
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Mission Editor</title>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  --bg:#000; --panel:#0b0b0b; --card:#0c0c0c; --border:#d6b44c;
  --accent:#f2d675; --text:#f7f1d0; --muted:#c9b06a;
}
*{box-sizing:border-box}
body{
  background:#000; color:var(--text); font-family:'Play',system-ui,sans-serif;
  margin:0; padding:24px; letter-spacing:.25px; line-height:1.5;
}
/* Header + Nav */
.brand{display:flex;align-items:center;gap:10px;margin:0 0 14px;border-bottom:1px solid var(--border);padding-bottom:8px}
.brand-logo{width:44px;height:44px;object-fit:contain;filter:drop-shadow(0 0 4px rgba(242,214,117,.25))}
.brand h1{font-weight:700;font-size:22px;color:var(--accent);margin:0}
/* Panels */
.panel{
  background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px;
  box-shadow:0 0 18px rgba(214,180,76,.18), inset 0 0 0 1px rgba(214,180,76,.10);
}
.panel + .panel{margin-top:14px}
.panel h3{margin:0 0 10px;color:var(--accent);font-size:16px}
/* Inputs + Buttons */
label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
input,select,textarea{
  width:100%;background:#0a0a0a;border:1px solid var(--border);border-radius:10px;
  padding:10px;color:var(--text);font-family:'Play';font-size:14px;
}
textarea{min-height:80px;resize:vertical}
button{
  padding:10px 14px;border-radius:10px;border:1px solid var(--border);
  color:var(--accent);background:linear-gradient(180deg,#0c0c0c,#060606);
  font-family:'Play';cursor:pointer;font-size:13px;transition:.2s
}
button:hover{background:var(--accent);color:#000}
button.primary{background:var(--accent);color:#000}
button.danger{border-color:#ff6b6b;color:#ff6b6b}
.actions{display:flex;gap:10px;flex-wrap:wrap}
/* Form layout */
.form-section{display:flex;flex-direction:column;gap:16px;max-width:920px}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.row2 > div{min-width:0}
/* Attachments */
.attach-item{display:grid;grid-template-columns:1fr 1fr auto;gap:10px;margin-bottom:8px}
.attach-item button{padding:6px 10px}
/* Mode chip */
.mode-chip{
  display:inline-flex;align-items:center;gap:8px;margin-left:auto;
  padding:6px 10px;border:1px solid var(--border);border-radius:10px;
  color:var(--accent);background:linear-gradient(180deg,#0c0c0c,#060606);
  font-size:12px;
}
.sub{color:var(--muted);font-size:12px}
</style>
</head>
<body>

<!-- Header -->
<div class="brand">
  <img src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" alt="JMBN" class="brand-logo">
  <h1 style="margin-right:auto">JMBN Mission Editor</h1>
  <span id="modeChip" class="mode-chip" title="Editor Mode">Create</span>
</div>

<!-- Panel: Mission Details -->
<div class="panel">
  <h3>Mission Details</h3>
  <div class="form-section">
    <div>
      <label>Mission Title</label>
      <input id="title" placeholder="e.g., RW S2 â€” 24-box Haul">
    </div>
    <div class="row2">
      <div>
        <label>Type</label>
        <select id="type">
          <option></option><option>Hauling</option><option>Delivery</option><option>Rescue</option>
          <option>Bounty</option><option>Investigation</option><option>Salvage</option>
          <option>Mining</option><option>Exploration</option>
        </select>
      </div>
      <div>
        <label>Status</label>
        <select id="status">
          <option></option><option>Planned</option><option>Active</option>
          <option>Success</option><option>Fail</option><option>Abort</option>
        </select>
      </div>
    </div>
    <div class="row2">
      <div><label>Origin</label><input id="origin" placeholder="e.g., Area18"></div>
      <div><label>Destination</label><input id="destination" placeholder="e.g., Everus Harbor"></div>
    </div>
    <div class="row2">
      <div><label>Date</label><input id="date" type="datetime-local"></div>
      <div><label>No. of Hours</label><input id="hours" type="number" step="0.1"></div>
    </div>
    <div class="row2">
      <div><label>Payout (aUEC)</label><input id="payout" type="number" step="1"></div>
      <div><label>Tags (comma separated)</label><input id="tags" placeholder="e.g., hauling, night"></div>
    </div>
    <div>
      <label>Attendees</label>
      <input id="attendees" placeholder="e.g., Vex, Kara">
    </div>
  </div>
</div>

<!-- Panel: Attachments -->
<div class="panel">
  <h3>Attachments</h3>
  <div id="attachList"></div>
  <div class="sub" style="margin:6px 0 10px">Add any links (screenshots, telemetry, clips, reports).</div>
  <button id="addAttachBtn">Add Attachment</button>
</div>

<!-- Panel: Notes -->
<div class="panel">
  <h3>Notes / AAR</h3>
  <textarea id="notes" placeholder="Summary, outcomes, lessons learned"></textarea>
</div>

<!-- Panel: Actions -->
<div class="panel">
  <h3>Actions</h3>
  <div class="actions" style="margin-top:6px">
    <button id="clearAllBtn">Clear All</button>
    <button id="saveSupabaseBtn" class="primary" title="Insert or update in Supabase">ðŸ’¾ Save</button>
    <button id="deleteBtn" class="danger" style="display:none" title="Delete this mission">ðŸ—‘ Delete</button>
    <button id="newBtn" style="margin-left:auto" title="Start a new mission form">ï¼‹ New</button>
  </div>
</div>

<!-- ===== Supabase + App Logic (ES module) ===== -->
<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  const SUPABASE_URL  = 'https://fcegavhipeaeihxegsnw.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjZWdhdmhpcGVhZWloeGVnc253Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMjk3NTcsImV4cCI6MjA3NzcwNTc1N30.i-ZjOlKc89-uA7fqOIvmAMv60-C2_NmKikRI_78Jei8';

  const sb = createClient(SUPABASE_URL, SUPABASE_ANON);

  const attachList = document.getElementById('attachList');
  const modeChip = document.getElementById('modeChip');

  const $  = (id) => document.getElementById(id);
  const val = (id) => $(id).value.trim();

  /* ---------- Edit-mode plumbing ---------- */
  const qs = new URLSearchParams(location.search);
  const editId = qs.get('id'); // if present, we're editing

  function isoToLocalInput(iso){
    if (!iso) return '';
    const d = new Date(iso);
    const pad = n => String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function setModeChip(text){
    modeChip.textContent = text;
    modeChip.title = text + (editId ? ` (${editId})` : '');
  }

  function setSaving(on){
    const btn = $('saveSupabaseBtn');
    btn.disabled = on;
    btn.textContent = on ? 'Savingâ€¦' : 'ðŸ’¾ Save';
  }

  function setEditMode(on){
    const delBtn = $('deleteBtn');
    const saveBtn = $('saveSupabaseBtn');
    if (on){
      saveBtn.textContent = 'âœŽ Update';
      delBtn.style.display = '';
      setModeChip('Editing');
    } else {
      saveBtn.textContent = 'ðŸ’¾ Save';
      delBtn.style.display = 'none';
      setModeChip('Create');
    }
  }

  function addAttachRow(name='', url=''){
    const div = document.createElement('div');
    div.className='attach-item';
    div.innerHTML = `
      <input placeholder="Label (e.g., Screenshot)" value="${name}">
      <input placeholder="URL (https://...)" value="${url}">
      <button type="button" onclick="this.parentElement.remove()">âœ•</button>`;
    attachList.appendChild(div);
  }

  function collectAttachments(){
    return [...attachList.querySelectorAll('.attach-item')].map(el=>{
      const label = el.children[0].value.trim();
      const url   = el.children[1].value.trim();
      if(!url) return null;
      try { new URL(url); } catch { return null; }
      const name = label || (url.split('/').pop() || 'link');
      return { name, url };
    }).filter(Boolean);
  }

  function clearInputs(){
    document.querySelectorAll('input,textarea,select').forEach(e=>{
      if(!e.closest('.attach-item')) e.value='';
    });
    attachList.innerHTML='';
    addAttachRow();
  }

  function buildSupabasePayload(){
    const dateLocal = val('date');
    const startISO = dateLocal ? new Date(dateLocal).toISOString() : null;
    return {
      title:       val('title'),
      type:        val('type'),
      status:      val('status'),
      origin:      val('origin'),
      destination: val('destination'),
      start_time:  startISO,
      hours:       Number(val('hours') || 0),
      payout_auec: Number(val('payout') || 0),
      tags:        val('tags'),
      attendees:   val('attendees'),
      notes:       val('notes'),
      attachments: collectAttachments()
    };
  }

  async function saveToSupabase(){
    const payload = buildSupabasePayload();
    if(!payload.title){ alert('Please enter a Mission Title.'); return; }
    try{
      setSaving(true);

      if (editId){
        const { error } = await sb.from('missions').update(payload).eq('id', editId);
        if (error) throw error;
        alert('Mission updated âœ…');
      } else {
        const { error } = await sb.from('missions').insert(payload);
        if (error) throw error;
        alert('Mission saved âœ…');
      }

      location.href = 'mission-log.html';
    }catch(err){
      console.error(err);
      alert('Save failed: ' + (err.message || err));
    }finally{
      setSaving(false);
    }
  }

  async function deleteMission(){
    if (!editId) return;
    if (!confirm('Delete this mission? This cannot be undone.')) return;
    try{
      const { error } = await sb.from('missions').delete().eq('id', editId);
      if (error) throw error;
      alert('Mission deleted ðŸ—‘');
      location.href = 'mission-log.html';
    }catch(err){
      console.error(err);
      alert('Delete failed: ' + (err.message || err));
    }
  }

  function startNew(){
    if (location.search) {
      location.href = location.pathname; // reload without id
    } else {
      setEditMode(false);
      clearInputs();
    }
  }

  async function loadForEdit(){
    if (!editId){ setEditMode(false); addAttachRow(); return; }
    setEditMode(true);
    try{
      const { data, error } = await sb.from('missions').select('*').eq('id', editId).single();
      if (error) throw error;

      $('#title').value       = data.title || '';
      $('#type').value        = data.type || '';
      $('#status').value      = data.status || '';
      $('#origin').value      = data.origin || '';
      $('#destination').value = data.destination || '';
      $('#date').value        = isoToLocalInput(data.start_time);
      $('#hours').value       = data.hours ?? '';
      $('#payout').value      = data.payout_auec ?? '';
      $('#tags').value        = data.tags || '';
      $('#attendees').value   = data.attendees || '';
      $('#notes').value       = data.notes || '';

      attachList.innerHTML = '';
      if (Array.isArray(data.attachments) && data.attachments.length){
        for (const a of data.attachments){
          addAttachRow(a.name||'', a.url||'');
        }
      } else {
        addAttachRow();
      }
    } catch(err){
      console.error(err);
      alert('Failed to load mission: ' + (err.message || err));
      setEditMode(false);
      addAttachRow();
    }
  }

  // Wire buttons
  $('addAttachBtn').addEventListener('click', ()=>addAttachRow());
  $('clearAllBtn').addEventListener('click', clearInputs);              // repurposed to clear form
  $('saveSupabaseBtn').addEventListener('click', saveToSupabase);
  $('deleteBtn').addEventListener('click', deleteMission);
  $('newBtn').addEventListener('click', startNew);

  // Init
  await loadForEdit();
</script>
</body>
</html>
