<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Mission Creator</title>

<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png"
  href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png"
  sizes="32x32">
<style>
:root{
  --bg:#000;--panel:#0b0b0b;--border:#d6b44c;
  --accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;
}
*{box-sizing:border-box}
body{
  background:#000;color:var(--text);font-family:'Play',system-ui,sans-serif;
  margin:0;padding:18px;
}

/* header */
.brand{display:flex;align-items:center;gap:10px;margin:0 0 8px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.brand-logo{width:44px;height:44px;object-fit:contain;filter:drop-shadow(0 0 4px rgba(242,214,117,.25))}
.brand h1{color:var(--accent);margin:0}

/* toolbar */
.toolbar{display:flex;align-items:center;gap:10px;margin:10px 0;flex-wrap:wrap}
.btn{padding:8px 14px;border:1px solid var(--border);border-radius:999px;
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);cursor:pointer;font-weight:700;font-family:'Play'}
.btn:hover{background:var(--accent);color:#000}
.btn-danger{border-color:var(--bad);color:var(--bad)}
.subtle{font-size:12px;color:var(--muted)}

/* layout */
.wrap{display:grid;grid-template-columns:340px 1fr;gap:16px}
@media(max-width:960px){.wrap{grid-template-columns:1fr}}

/* panels */
.panel{background:#0b0b0b;border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:0 0 18px rgba(214,180,76,.15)}
.panel h3{color:var(--accent);margin:0 0 8px}
.list{display:flex;flex-direction:column;gap:6px;max-height:75vh;overflow:auto}
.item{padding:10px;border:1px solid var(--border);border-radius:8px;background:#0a0a0a;cursor:pointer}
.item:hover{background:#111}
.item-title{font-weight:700}
.item-sub{font-size:12px;color:var(--muted)}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.form-grid.full{grid-template-columns:1fr}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:3px}
input,select,textarea{width:100%;background:#0a0a0a;border:1px solid var(--border);
  border-radius:8px;padding:9px;color:var(--text);font-family:'Play'}
textarea{resize:vertical;min-height:80px}
.actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
</style>
</head>
<body>

<!-- header -->
<div class="brand">
  <img class="brand-logo" src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" alt="JMBN">
  <h1 style="margin-right:auto">JMBN Mission Creator</h1>
</div>

<div class="toolbar">
  <a class="btn" href="mission-log.html">‚Üê Back to Mission Log</a>
  <span class="subtle">For Admins & Officers ‚Äî create, edit or delete missions.</span>
</div>

<div class="wrap">
  <!-- left: mission list -->
  <div class="panel">
    <h3>All Missions</h3>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <input id="search" placeholder="Search..." style="flex:1">
      <button id="refresh" class="btn">‚Üª</button>
      <button id="newBtn" class="btn">Ôºã New</button>
    </div>
    <div id="list" class="list"></div>
  </div>

  <!-- right: form -->
  <div class="panel">
    <h3 id="formTitle">New Mission</h3>

    <div class="form-grid full"><div><label>Title</label><input id="title" placeholder="e.g., RW S2 ‚Äî 24-box Haul"></div></div>

    <div class="form-grid">
      <div><label>Type</label>
        <select id="type"><option></option><option>Hauling</option><option>Delivery</option><option>Rescue</option><option>Salvage</option><option>Mining</option><option>Exploration</option></select>
      </div>
      <div><label>Status</label>
        <select id="status"><option></option><option>Planned</option><option>Active</option><option>Success</option><option>Fail</option><option>Abort</option></select>
      </div>
    </div>

    <div class="form-grid">
      <div><label>Origin</label><input id="origin"></div>
      <div><label>Destination</label><input id="destination"></div>
    </div>

    <div class="form-grid">
      <div><label>Date / Time</label><input id="date" type="datetime-local"></div>
      <div><label>Hours</label><input id="hours" type="number" step="0.1"></div>
    </div>

    <div class="form-grid">
      <div><label>Payout (aUEC)</label><input id="payout" type="number"></div>
      <div><label>Tags</label><input id="tags" placeholder="hauling, night"></div>
    </div>

    <div class="form-grid full">
      <div><label>Attendees</label><input id="attendees" placeholder="Vex, Kara"></div>
    </div>

    <div class="form-grid full">
      <div><label>Notes</label><textarea id="notes" placeholder="Mission summary, outcomes, lessons"></textarea></div>
    </div>

    <div class="actions">
      <button id="saveBtn" class="btn btn-primary">üíæ Save</button>
      <button id="updateBtn" class="btn">‚úé Update</button>
      <button id="deleteBtn" class="btn btn-danger">üóë Delete</button>
      <button id="clearBtn" class="btn">Clear</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script type="module">
const $=s=>document.querySelector(s);
let sb, session, user, elevated=false, currentId=null, cache=[];

/* ===== helpers ===== */
const toISO=v=>v?new Date(v).toISOString():null;
const isoToLocal=iso=>iso?new Date(iso).toISOString().slice(0,16):'';
function fillForm(r){
  $('#title').value=r?.title||'';
  $('#type').value=r?.type||'';
  $('#status').value=r?.status||'';
  $('#origin').value=r?.origin||'';
  $('#destination').value=r?.destination||'';
  $('#date').value=isoToLocal(r?.start_time);
  $('#hours').value=r?.hours||'';
  $('#payout').value=r?.payout_auec||'';
  $('#tags').value=r?.tags||'';
  $('#attendees').value=r?.attendees||'';
  $('#notes').value=r?.notes||'';
}
function collectForm(){
  return {
    title:$('#title').value.trim(),
    type:$('#type').value||null,
    status:$('#status').value||null,
    origin:$('#origin').value||null,
    destination:$('#destination').value||null,
    start_time:toISO($('#date').value),
    hours:Number($('#hours').value||0),
    payout_auec:Number($('#payout').value||0),
    tags:$('#tags').value||null,
    attendees:$('#attendees').value||null,
    notes:$('#notes').value||null
  };
}
function renderList(rows){
  const list=$('#list');
  list.innerHTML='';
  if(!rows.length){list.innerHTML='<div class="item">No missions found.</div>';return;}
  for(const r of rows){
    const el=document.createElement('div');
    el.className='item';
    el.innerHTML=`<div><div class="item-title">${r.title||'(untitled)'}</div>
    <div class="item-sub">${r.type||''} ‚Ä¢ ${r.status||''}</div></div>`;
    el.onclick=()=>openMission(r.id);
    list.appendChild(el);
  }
}

/* ===== CRUD ===== */
async function loadList(){
  const {data,error}=await sb.from('missions').select('id,title,type,status').order('created_at',{ascending:false});
  if(error){alert('Failed to load: '+error.message);return;}
  cache=data||[];renderList(cache);
}
async function openMission(id){
  const {data,error}=await sb.from('missions').select('*').eq('id',id).single();
  if(error){alert('Open failed: '+error.message);return;}
  currentId=id;fillForm(data);
  $('#formTitle').textContent=`Editing ${id.slice(0,8)}`;
}
async function saveMission(){
  const payload=collectForm();
  if(!payload.title){alert('Title required');return;}
  payload.submitted_by=user.id;
  const {error}=await sb.from('missions').insert(payload);
  if(error){alert('Save failed: '+error.message);return;}
  alert('Created ‚úì');loadList();fillForm(null);
}
async function updateMission(){
  if(!currentId){alert('No mission selected');return;}
  const payload=collectForm();
  const {error}=await sb.from('missions').update(payload).eq('id',currentId);
  if(error){alert('Update failed: '+error.message);return;}
  alert('Updated ‚úì');loadList();
}
async function deleteMission(){
  if(!currentId){alert('No mission selected');return;}
  if(!confirm('Delete mission?'))return;
  const {error}=await sb.from('missions').delete().eq('id',currentId);
  if(error){alert('Delete failed: '+error.message);return;}
  alert('Deleted ‚úì');currentId=null;fillForm(null);loadList();
}

/* ===== boot ===== */
document.addEventListener('DOMContentLoaded',async()=>{
  session=await window.requireAuth();
  if(!session)return;
  sb=window.sb;user=session.user;

  // check role via your function
  const {data:isElevated,error:rpcErr}=await sb.rpc('is_elevated',{u:user.id});
  if(rpcErr){console.warn(rpcErr);}
  elevated=!!isElevated;

  if(!elevated){
    alert('Access denied. Officers/Admin only.');
    location.href='mission-log.html';
    return;
  }

  // bind
  $('#newBtn').onclick=()=>{currentId=null;fillForm(null);$('#formTitle').textContent='New Mission';};
  $('#refresh').onclick=loadList;
  $('#saveBtn').onclick=saveMission;
  $('#updateBtn').onclick=updateMission;
  $('#deleteBtn').onclick=deleteMission;
  $('#clearBtn').onclick=()=>fillForm(null);
  $('#search').oninput=()=>{const q=$('#search').value.toLowerCase();renderList(cache.filter(r=>(r.title||'').toLowerCase().includes(q)));};

  loadList();
});
</script>
</body>
</html>
