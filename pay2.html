<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>JMBN – Earnings Admin (Weighted Ledger)</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png"
      href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png"
      sizes="32x32">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--sub:#0f0f0f;--row:#0a0a0a;
  --border:#d6b44c;--card:#141414;
  --accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;
  --fs-base:14px;--fs-small:11px;--fs-table:13px;--fs-h1:clamp(18px,2.2vw,22px);
}
*{box-sizing:border-box}
body{
  margin:0;padding:14px;
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text);
  font-family:'Play',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  font-size:var(--fs-base);letter-spacing:.25px;
}

/* Brand */
.brand{
  display:flex;align-items:center;gap:10px;
  margin:0 0 8px;padding-bottom:6px;
  border-bottom:1px solid var(--border)
}
.brand-logo{
  width:44px;height:44px;object-fit:contain;
  filter:drop-shadow(0 0 4px rgba(242,214,117,.25))
}
.brand h1{
  font-weight:700;font-size:var(--fs-h1);color:var(--accent);margin:0
}

/* Nav pills */
.nav{
  display:flex;align-items:center;gap:8px;flex-wrap:wrap;
  margin:6px 0 12px;
}
.nav-btn{
  --gold:#f2d675;--gold2:#e7c760;--ring:#d6b44c;
  position:relative;display:inline-flex;align-items:center;justify-content:center;
  padding:7px 14px;border-radius:999px;
  border:1px solid var(--ring);
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);text-decoration:none;font-weight:700;
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.12);
  transition:transform .15s ease,box-shadow .2s ease,background .2s ease,color .2s ease;
  font-size:12px;
}
.nav-btn:hover{
  transform:translateY(-1px);
  box-shadow:0 0 12px rgba(214,180,76,.25),inset 0 0 0 1px rgba(214,180,76,.18);
  background:linear-gradient(180deg,#1a1a1a,#0a0a0a);
}
.nav-btn.active{
  color:#000;background:linear-gradient(180deg,var(--gold),var(--gold2));
  border-color:var(--ring);box-shadow:0 0 20px rgba(214,180,76,.45);
}
.nav-btn.active::after{
  content:"";position:absolute;inset:0;border-radius:999px;
  background:linear-gradient(120deg,rgba(255,255,255,0) 30%,rgba(255,255,255,.3) 50%,rgba(255,255,255,0) 70%);
  transform:translateX(-120%);pointer-events:none;
  animation:shine 2.6s ease-in-out infinite;
}
@keyframes shine{0%{transform:translateX(-120%)}35%{transform:translateX(120%)}100%{transform:translateX(120%)}}

/* Layout */
.wrap{
  display:grid;
  grid-template-columns:minmax(360px,1.1fr) minmax(420px,1.2fr);
  gap:12px;
  margin-bottom:12px;
}
@media(max-width:980px){
  .wrap{grid-template-columns:1fr}
}
.panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
  box-shadow:0 0 18px rgba(214,180,76,.22),inset 0 0 0 1px rgba(214,180,76,.12);
}
.full-panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
  box-shadow:0 0 18px rgba(214,180,76,.22),inset 0 0 0 1px rgba(214,180,76,.12);
}
.rightSticky{position:sticky;top:14px;height:fit-content}

/* Titles */
.section-title{
  font-size:13px;color:var(--accent);margin:0 0 4px;font-weight:700;
  text-transform:uppercase;letter-spacing:.12em;
}
.small{font-size:var(--fs-small);color:var(--muted)}
.subtle{font-size:11px;color:var(--muted)}

/* Blocks */
.block{
  background:#0c0c0c;border-radius:12px;border:1px solid var(--border);
  padding:10px;margin-top:6px;
  box-shadow:0 0 10px rgba(214,180,76,.16),inset 0 0 0 1px rgba(214,180,76,.12);
}
.block-header{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:6px;
}
.block-header-title{font-size:12px;font-weight:700;color:var(--accent)}
.tag{
  border-radius:999px;border:1px solid var(--border);
  padding:2px 8px;font-size:10px;color:var(--muted);background:#050505;
}

/* Fields */
.field{
  display:flex;flex-direction:column;gap:4px;margin-bottom:8px;font-size:12px;color:var(--muted)
}
.field-row{
  display:grid;grid-template-columns:1fr 1fr;gap:8px;
}
input,select{
  background:#050505;border:1px solid var(--border);border-radius:8px;
  padding:7px 9px;color:var(--text);
  font-family:'Play';font-size:var(--fs-table);
}

/* Toggle switch */
.switch{
  position:relative;display:inline-flex;align-items:center;gap:6px;
  font-size:11px;color:var(--muted);cursor:pointer;
}
.switch-input{display:none}
.switch-track{
  width:34px;height:18px;border-radius:999px;
  background:#111;border:1px solid var(--border);
  position:relative;flex-shrink:0;
}
.switch-thumb{
  position:absolute;top:1px;left:1px;width:14px;height:14px;border-radius:50%;
  background:var(--accent);transition:transform .15s ease;
}
.switch-input:checked + .switch-track .switch-thumb{
  transform:translateX(14px);
}

/* Buttons */
button{
  padding:7px 11px;border-radius:10px;border:1px solid var(--border);
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);cursor:pointer;
  font-family:'Play';font-size:12px;font-weight:700;
  transition:.18s;
}
button:hover{
  background:var(--accent);color:#000;
  box-shadow:0 0 12px rgba(214,180,76,.35);
}
.btn-primary{background:var(--accent);color:#000}
.btn-danger{border-color:var(--bad);color:var(--bad)}
.btn-ghost{
  background:transparent;
  border-radius:999px;
}

/* KPI bar */
.kpis{
  display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:6px;
}
@media(max-width:720px){.kpis{grid-template-columns:1fr 1fr}}
@media(max-width:520px){.kpis{grid-template-columns:1fr}}
.kpi{
  background:linear-gradient(180deg,#0b0b0b,#080808);
  border-radius:10px;border:1px solid var(--border);
  padding:8px;
  box-shadow:0 0 14px rgba(214,180,76,.18),inset 0 0 0 1px rgba(214,180,76,.12);
}
.kpi-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:3px}
.kpi-value{font-size:18px;font-weight:700;color:var(--accent);line-height:1}
.kpi-sub{font-size:11px;color:var(--muted);margin-top:2px}
.mono{font-variant-numeric:tabular-nums}

/* Tables */
.tableWrap{
  margin-top:6px;
  border-radius:10px;
  border:1px solid var(--border);
  overflow:auto;
  max-height:52vh;
}
table{width:100%;border-collapse:collapse;font-size:var(--fs-table);min-width:780px;}
th,td{padding:7px 8px;border-bottom:1px solid rgba(214,180,76,.28);text-align:left}
th{
  font-size:11px;color:var(--accent);background:#080808;font-weight:500;
  text-transform:uppercase;letter-spacing:.09em;
  position:sticky;top:0;z-index:1;
}
tbody tr:nth-child(even){background:#111}
tbody tr:hover{background:rgba(214,180,76,.08)}
td input{width:100%;padding:4px 6px;font-size:12px}

/* Mission overrides search row */
.controls{
  display:flex;flex-wrap:wrap;gap:8px;margin:4px 0 6px;
}
.controls input[type="search"]{
  min-width:220px;
}

/* Pills */
.pill{
  display:inline-flex;align-items:center;gap:6px;
  padding:2px 8px;border-radius:999px;
  border:1px solid var(--border);
  background:#050505;font-size:11px;color:var(--muted);
}
.dot{width:7px;height:7px;border-radius:50%;background:var(--accent)}
.badge{
  display:inline-block;border-radius:999px;border:1px solid var(--border);
  padding:2px 7px;font-size:10px;color:var(--muted);background:#050505;
}
.text-right{text-align:right}
.text-center{text-align:center}
.nowrap{white-space:nowrap}
.hilite{color:var(--accent);}

/* Tiny helper */
hr.sep{
  border:none;border-top:1px dashed rgba(214,180,76,.4);
  margin:6px 0 4px;
}

/* Toast */
.toast{
  position:fixed;right:16px;bottom:16px;
  background:#111;border:1px solid var(--border);border-radius:10px;
  padding:8px 12px;font-size:12px;color:var(--text);
  box-shadow:0 0 18px rgba(214,180,76,.32);
  max-width:320px;z-index:40;
}
.toast.bad{border-color:var(--bad);color:#ffd0d0}

/* Modal */
.modal-backdrop{
  position:fixed;inset:0;
  background:rgba(0,0,0,.7);
  display:flex;align-items:center;justify-content:center;
  z-index:80;
}
.modal{
  background:#0b0b0b;
  border:1px solid var(--border);
  border-radius:12px;
  max-width:800px;width:95%;
  max-height:80vh;
  overflow:auto;
  box-shadow:0 0 25px rgba(214,180,76,.4);
  padding:12px;
}
.modal-header{
  display:flex;justify-content:space-between;align-items:flex-start;
  gap:12px;margin-bottom:6px;
}
.modal-title{
  font-size:14px;font-weight:700;color:var(--accent);
}
.modal-close{
  border:none;background:transparent;color:var(--accent);
  font-size:18px;line-height:1;cursor:pointer;padding:0 4px;
}
.modal-body{font-size:12px;}
.modal-body table{min-width:100%;font-size:12px;}
</style>
</head>
<body>

<!-- Header -->
<div class="brand">
  <img class="brand-logo" src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" alt="JMBN">
  <h1>JMBN Earnings Admin – Weighted Ledger Rules</h1>
</div>

<!-- Nav -->
<nav class="nav">
  <a class="nav-btn" href="index.html">Manifest</a>
  <a class="nav-btn" href="hangar.html">Hangar</a>
  <a class="nav-btn" href="components.html">Components</a>
  <a class="nav-btn" href="contracts.html">Contracts</a>
  <a class="nav-btn" href="mission-log.html">Mission Log</a>
  <a class="nav-btn" href="earnings-ledger.html">Earnings Ledger</a>
  <a class="nav-btn active" href="#">Earnings Admin</a>
</nav>

<div class="wrap">
  <!-- LEFT: Org rules & rounding -->
  <section class="panel">
    <div class="block-header">
      <div>
        <div class="section-title">Org Cut Rules</div>
        <div class="subtle">Top-level settings that the ledger will use as defaults.</div>
      </div>
      <span class="tag">ORG-LEVEL</span>
    </div>

    <div class="block">
      <div class="field-row">
        <div class="field">
          <span>Default Org Cut %</span>
          <input id="orgDefaultPct" type="number" min="0" max="100" step="0.5">
        </div>
        <div class="field">
          <span>Max Org Cut % (safety cap)</span>
          <input id="orgMaxPct" type="number" min="0" max="100" step="0.5">
        </div>
      </div>

      <div class="field-row">
        <div class="field">
          <span>Minimum Crew Payout (per head)</span>
          <input id="minCrewPayout" type="number" min="0" step="1000">
        </div>
        <div class="field">
          <span>Apply Min Payout Rule On</span>
          <select id="minCrewMode">
            <option value="afterOrg">After Org Cut</option>
            <option value="beforeOrg">Before Org Cut</option>
          </select>
        </div>
      </div>

      <label class="switch">
        <input id="allowMissionOverride" class="switch-input" type="checkbox">
        <span class="switch-track"><span class="switch-thumb"></span></span>
        <span>Allow per-mission org % overrides</span>
      </label>
    </div>

    <div class="block" style="margin-top:8px">
      <div class="block-header">
        <div class="block-header-title">Rounding Rules</div>
        <span class="tag">MATH</span>
      </div>

      <div class="field-row">
        <div class="field">
          <span>Share Calc Mode</span>
          <select id="shareMode">
            <option value="weight">By Weight / Weight-Sum</option>
            <option value="flat">Flat Split (ignore weight)</option>
          </select>
        </div>
        <div class="field">
          <span>Rounding Style</span>
          <select id="roundMode">
            <option value="nearest">Round to nearest</option>
            <option value="down">Always down</option>
            <option value="up">Always up</option>
            <option value="full">No rounding (full aUEC)</option>
          </select>
        </div>
      </div>

      <div class="field-row">
        <div class="field">
          <span>Rounding Granularity (aUEC)</span>
          <input id="roundStep" type="number" min="1" step="1">
        </div>
        <div class="field">
          <span>Handle Residuals</span>
          <select id="residualMode">
            <option value="highestWeight">Give remainder to highest weight</option>
            <option value="leader">Give remainder to mission leader</option>
            <option value="org">Send remainder to org pot</option>
          </select>
        </div>
      </div>
      <hr class="sep">
      <div class="subtle" id="rulesSummary"></div>
      <div style="display:flex;gap:6px;justify-content:flex-end;margin-top:6px">
        <button class="btn-ghost" id="resetOrgRules">Reset</button>
        <button class="btn-primary" id="saveOrgRules">Save Org Rules</button>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="kpi-label">Org Share (Typical)</div>
        <div class="kpi-value mono" id="kpiOrgShare">–</div>
        <div class="kpi-sub">On a 125k aUEC mission using current defaults</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">Crew Pool (Typical)</div>
        <div class="kpi-value mono" id="kpiCrewPool">–</div>
        <div class="kpi-sub">Distributed by weight after org cut</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">Min Payout Trigger</div>
        <div class="kpi-sub" id="kpiMinTrigger">–</div>
      </div>
    </div>
  </section>

  <!-- RIGHT: Paygrade weights -->
  <section class="panel rightSticky">
    <div class="block-header">
      <div>
        <div class="section-title">Paygrade Weights</div>
        <div class="subtle">These feed into the weighted ledger when splitting the crew pool.</div>
      </div>
      <span class="tag">RANK TABLE</span>
    </div>

    <div class="block">
      <div class="field">
        <span>Quick Filter (label / code)</span>
        <input id="pgSearch" type="search" placeholder="Filter by paygrade, label…">
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Code</th>
            <th>Label</th>
            <th class="text-right">Weight</th>
            <th class="text-right">Bonus %</th>
            <th class="text-right">Flat Add (aUEC)</th>
          </tr>
        </thead>
        <tbody id="pgRows"></tbody>
      </table>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
      <span class="subtle">Backed by <code>pay_grade_rules</code> in Supabase.</span>
      <div style="display:flex;gap:6px">
        <button class="btn-ghost" id="revertPg">Reload</button>
        <button class="btn-primary" id="savePg">Save Weights</button>
      </div>
    </div>
  </section>
</div>

<!-- BOTTOM: Mission-level overrides -->
<section class="full-panel">
  <div class="block-header">
    <div>
      <div class="section-title">Mission Overrides</div>
      <div class="subtle">
        Adjust org cut % and lock missions that must not be auto-recalculated.  
        The weighted ledger will respect these overrides.
      </div>
    </div>
    <span class="tag">PER-MISSION</span>
  </div>

  <div class="block" style="margin-bottom:6px">
    <div class="controls">
      <input id="missionSearch" type="search" placeholder="Search by mission ID / title …">
      <select id="missionStatus">
        <option value="">All Status</option>
        <option value="planned">Planned</option>
        <option value="success">Success</option>
        <option value="abort">Abort</option>
        <option value="failed">Failed</option>
      </select>
      <select id="missionOrgBand">
        <option value="">All Org %</option>
        <option value="0-10">0–10%</option>
        <option value="10-20">10–20%</option>
        <option value="20-30">20–30%</option>
        <option value="30+">30%+</option>
      </select>
      <button id="missionReset" class="btn-ghost">Reset Filters</button>
      <span class="small">Tip: lock once paid out to avoid retro changes.</span>
    </div>

    <div class="tableWrap" style="max-height:40vh">
      <table>
        <thead>
          <tr>
            <th>Mission</th>
            <th class="nowrap">Status</th>
            <th class="text-right nowrap">Payout (aUEC)</th>
            <th class="text-right nowrap">Default Org %</th>
            <th class="text-right nowrap">Crew Pool After Org</th>
            <th class="text-right nowrap">Override Org %</th>
            <th class="text-center">Locked</th>
            <th class="nowrap">Last Edited By</th>
            <th class="nowrap">Crew</th>
          </tr>
        </thead>
        <tbody id="missionRows"></tbody>
      </table>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:6px;margin-top:6px">
      <button class="btn-danger" id="clearOverrides">Clear All Overrides</button>
      <button class="btn-primary" id="saveOverrides">Save Overrides</button>
    </div>
  </div>

  <div class="subtle">
    <span class="pill">
      <span class="dot"></span>
      <span>Admin-only: restrict this page via Supabase RLS + <code>role = 'elevated'</code> or similar.</span>
    </span>
  </div>
</section>

<!-- Crew modal -->
<div id="crewModal" class="modal-backdrop" style="display:none">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title" id="crewMissionTitle">Mission Crew</div>
        <div class="subtle" id="crewMissionMeta"></div>
      </div>
      <button class="modal-close" id="crewModalClose" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <div class="subtle" id="crewSummary" style="margin-bottom:4px"></div>
      <div class="tableWrap" style="max-height:55vh;margin-top:4px">
        <table>
          <thead>
            <tr>
              <th>Handle</th>
              <th>Name</th>
              <th>Rank / PG</th>
              <th class="text-right">Weight</th>
              <th class="text-right">Final Share (aUEC)</th>
            </tr>
          </thead>
          <tbody id="crewRows"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast" style="display:none"></div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
const $  = s => document.querySelector(s);
const fmt = n => Number(n||0).toLocaleString('en-US',{maximumFractionDigits:0});

let sb, me;

/* Toast */
function showToast(msg, bad=false){
  const el = $('#toast');
  el.textContent = msg;
  el.className = 'toast' + (bad ? ' bad' : '');
  el.style.display = 'block';
  setTimeout(()=>{ el.style.display='none'; }, 3500);
}

/* ============== ORG RULES ============== */
const orgRulesDefault = {
  id: true,
  org_default_pct:20,
  org_max_pct:30,
  min_crew_payout:5000,
  min_crew_mode:'afterOrg',
  allow_mission_override:true,
  share_mode:'weight',
  round_mode:'nearest',
  round_step:10,
  residual_mode:'highestWeight'
};
let orgRules = {...orgRulesDefault};

function loadOrgRulesToUI(){
  $('#orgDefaultPct').value = orgRules.org_default_pct;
  $('#orgMaxPct').value = orgRules.org_max_pct;
  $('#minCrewPayout').value = orgRules.min_crew_payout;
  $('#minCrewMode').value = orgRules.min_crew_mode;
  $('#allowMissionOverride').checked = orgRules.allow_mission_override;
  $('#shareMode').value = orgRules.share_mode;
  $('#roundMode').value = orgRules.round_mode;
  $('#roundStep').value = orgRules.round_step;
  $('#residualMode').value = orgRules.residual_mode;
  updateOrgSummary();
  updateKpiPreview();
}
function readOrgRulesFromUI(){
  orgRules.org_default_pct = Number($('#orgDefaultPct').value||0);
  orgRules.org_max_pct = Number($('#orgMaxPct').value||0);
  orgRules.min_crew_payout = Number($('#minCrewPayout').value||0);
  orgRules.min_crew_mode = $('#minCrewMode').value;
  orgRules.allow_mission_override = $('#allowMissionOverride').checked;
  orgRules.share_mode = $('#shareMode').value;
  orgRules.round_mode = $('#roundMode').value;
  orgRules.round_step = Number($('#roundStep').value||1);
  orgRules.residual_mode = $('#residualMode').value;
}
function updateOrgSummary(){
  readOrgRulesFromUI();
  const r = orgRules;
  const shareModeText = r.share_mode === 'weight' ? 'weight' : 'flat split';
  const roundModeText = {
    nearest:'nearest',
    down:'down',
    up:'up',
    full:'no rounding'
  }[r.round_mode] || 'nearest';
  const residualText = {
    highestWeight:'highest weight',
    leader:'mission leader',
    org:'org pot'
  }[r.residual_mode] || 'highest weight';

  $('#rulesSummary').innerHTML = `
    Org takes <span class="hilite">${r.org_default_pct}%</span> by default (max
    <span class="hilite">${r.org_max_pct}%</span>).  
    Crew shares use <span class="hilite">${shareModeText}</span>,
    rounding <span class="hilite">${roundModeText}</span> to
    <span class="hilite">${r.round_step} aUEC</span> steps; residuals go to
    <span class="hilite">${residualText}</span>.
  `;
  $('#kpiMinTrigger').innerHTML = `
    Current min per head <span class="hilite">${fmt(r.min_crew_payout)} aUEC</span>
    • Applies <span class="hilite">${r.min_crew_mode === 'afterOrg' ? 'after' : 'before'}</span> org cut.
  `;
}
function updateKpiPreview(){
  const total = 125000;
  const orgPct = orgRules.org_default_pct;
  const orgTake = total * (orgPct/100);
  const crew = total - orgTake;
  $('#kpiOrgShare').textContent = fmt(Math.round(orgTake));
  $('#kpiCrewPool').textContent = fmt(Math.round(crew));
}

async function loadOrgRulesFromSupabase(){
  const { data, error } = await sb
    .from('org_settings')
    .select('*')
    .order('updated_at',{ascending:false})
    .limit(1)
    .maybeSingle();
  if(error){
    console.error(error);
    showToast('Failed to load org rules; using defaults',true);
    orgRules = {...orgRulesDefault};
  }else if(data){
    orgRules = {
      ...orgRulesDefault,
      ...{
        org_default_pct: data.org_default_pct ?? orgRulesDefault.org_default_pct,
        org_max_pct: data.org_max_pct ?? orgRulesDefault.org_max_pct,
        min_crew_payout: data.min_crew_payout ?? orgRulesDefault.min_crew_payout,
        min_crew_mode: data.min_crew_mode ?? orgRulesDefault.min_crew_mode,
        allow_mission_override: data.allow_mission_override ?? orgRulesDefault.allow_mission_override,
        share_mode: data.share_mode ?? orgRulesDefault.share_mode,
        round_mode: data.round_mode ?? orgRulesDefault.round_mode,
        round_step: data.round_step ?? orgRulesDefault.round_step,
        residual_mode: data.residual_mode ?? orgRulesDefault.residual_mode
      }
    };
  }
  loadOrgRulesToUI();
}

async function saveOrgRulesToSupabase(){
  readOrgRulesFromUI();
  const payload = { ...orgRules, updated_by: me };
  const { error } = await sb.from('org_settings').upsert(payload,{onConflict:'id'});
  if(error){
    console.error(error);
    showToast('Failed to save org rules',true);
  }else{
    showToast('Org rules saved');
    await loadOrgRulesFromSupabase();
  }
}

['orgDefaultPct','orgMaxPct','minCrewPayout','minCrewMode','shareMode',
 'roundMode','roundStep','residualMode'].forEach(id=>{
  $('#'+id).addEventListener('input',()=>{
    updateOrgSummary();
    updateKpiPreview();
  });
});
$('#allowMissionOverride').addEventListener('change',updateOrgSummary);
$('#resetOrgRules').addEventListener('click',()=>{
  orgRules = {...orgRulesDefault};
  loadOrgRulesToUI();
});
$('#saveOrgRules').addEventListener('click',saveOrgRulesToSupabase);

/* ============== PAYGRADE WEIGHTS ============== */
let paygrades = [];
let pgFiltered = [];

function renderPaygrades(){
  const tbody = $('#pgRows');
  if(!pgFiltered.length){
    tbody.innerHTML = `<tr><td colspan="5" class="subtle">No paygrades match filter.</td></tr>`;
    return;
  }
  tbody.innerHTML = pgFiltered.map(pg=>`
    <tr data-code="${pg.paygrade}">
      <td>${pg.paygrade}</td>
      <td>${pg.label || ''}</td>
      <td class="text-right">
        <input type="number" step="0.1" value="${pg.weight ?? 1}" data-field="weight">
      </td>
      <td class="text-right">
        <input type="number" step="0.5" value="${pg.default_bonus_pct ?? 0}" data-field="default_bonus_pct">
      </td>
      <td class="text-right">
        <input type="number" step="100" value="${pg.default_add_pay ?? 0}" data-field="default_add_pay">
      </td>
    </tr>
  `).join('');
}

function applyPgFilter(){
  const q = ($('#pgSearch').value||'').toLowerCase();
  pgFiltered = paygrades.filter(pg=>{
    if(!q) return true;
    const hay = ((pg.paygrade||'')+' '+(pg.label||'')).toLowerCase();
    return hay.includes(q);
  });
  renderPaygrades();
}

$('#pgSearch').addEventListener('input',applyPgFilter);

$('#pgRows').addEventListener('input',e=>{
  const input = e.target;
  const row = input.closest('tr[data-code]');
  if(!row) return;
  const code = row.dataset.code;
  const pg = paygrades.find(p=>p.paygrade===code);
  if(!pg) return;
  const field = input.dataset.field;
  pg[field] = Number(input.value||0);
});

$('#revertPg').addEventListener('click',loadPaygradesFromSupabase);
$('#savePg').addEventListener('click',savePaygradesToSupabase);

async function loadPaygradesFromSupabase(){
  const { data, error } = await sb
    .from('pay_grade_rules')
    .select('paygrade,label,weight,default_bonus_pct,default_add_pay')
    .order('weight',{ascending:false});
  if(error){
    console.error(error);
    showToast('Failed to load pay grades',true);
    paygrades = [];
  }else{
    paygrades = data || [];
  }
  applyPgFilter();
}

async function savePaygradesToSupabase(){
  if(!paygrades.length){
    showToast('No pay grades to save',true);
    return;
  }
  const { error } = await sb.from('pay_grade_rules').upsert(paygrades,{onConflict:'paygrade'});
  if(error){
    console.error(error);
    showToast('Failed to save pay grades',true);
  }else{
    showToast('Paygrade weights saved');
    await loadPaygradesFromSupabase();
  }
}

/* ============== MISSIONS & OVERRIDES ============== */
let missions = [];
let missionFiltered = [];

function renderMissions(){
  const tbody = $('#missionRows');
  if(!missionFiltered.length){
    tbody.innerHTML = `<tr><td colspan="9" class="subtle">No missions match filter.</td></tr>`;
    return;
  }
  tbody.innerHTML = missionFiltered.map(m=>{
    const effOrg = m.override_org_pct ?? m.default_org_pct ?? orgRules.org_default_pct;
    const payout = m.payout_auec || 0;
    const crewPool = payout ? Math.round(payout * (1 - effOrg/100)) : 0;
    const last = m.last_editor || '—';
    return `
      <tr data-id="${m.id}">
        <td>
          <div class="hilite" style="font-weight:700">${m.title || 'Untitled'}</div>
          <div class="subtle">ID: ${m.id}</div>
        </td>
        <td class="nowrap"><span class="badge">${m.status || ''}</span></td>
        <td class="text-right mono">${payout ? fmt(payout) : '—'}</td>
        <td class="text-right mono">${(m.default_org_pct ?? orgRules.org_default_pct).toFixed(1)}%</td>
        <td class="text-right mono">${payout ? fmt(crewPool) : '—'}</td>
        <td class="text-right">
          <input type="number" step="0.5" min="0" max="100"
                 value="${m.override_org_pct ?? ''}"
                 placeholder="—"
                 ${m.locked ? 'disabled' : ''}
                 data-field="override_org_pct">
        </td>
        <td class="text-center">
          <input type="checkbox" data-field="locked" ${m.locked ? 'checked' : ''}>
        </td>
        <td class="nowrap"><span class="subtle">${last}</span></td>
        <td class="nowrap text-center">
          <button class="btn-ghost btn-crew" data-id="${m.id}">View</button>
        </td>
      </tr>
    `;
  }).join('');
}

function applyMissionFilter(){
  const q = ($('#missionSearch').value||'').toLowerCase();
  const st = $('#missionStatus').value;
  const band = $('#missionOrgBand').value;
  missionFiltered = missions.filter(m=>{
    if(st && (m.status || '') !== st) return false;
    const effOrg = m.override_org_pct ?? m.default_org_pct ?? orgRules.org_default_pct;
    if(band){
      if(band==='0-10' && !(effOrg>=0 && effOrg<10)) return false;
      if(band==='10-20' && !(effOrg>=10 && effOrg<20)) return false;
      if(band==='20-30' && !(effOrg>=20 && effOrg<30)) return false;
      if(band==='30+'   && !(effOrg>=30)) return false;
    }
    if(!q) return true;
    const hay = (m.id + ' ' + (m.title||'')).toLowerCase();
    return hay.includes(q);
  });
  renderMissions();
}

$('#missionSearch').addEventListener('input',applyMissionFilter);
$('#missionStatus').addEventListener('change',applyMissionFilter);
$('#missionOrgBand').addEventListener('change',applyMissionFilter);
$('#missionReset').addEventListener('click',()=>{
  $('#missionSearch').value='';
  $('#missionStatus').value='';
  $('#missionOrgBand').value='';
  applyMissionFilter();
});

$('#missionRows').addEventListener('input',e=>{
  const input = e.target;
  const row = input.closest('tr[data-id]');
  if(!row) return;
  const id = row.dataset.id;
  const m = missions.find(x=>x.id===id);
  if(!m) return;
  const field = input.dataset.field;
  if(field === 'override_org_pct'){
    const v = input.value;
    m.override_org_pct = v === '' ? null : Number(v);
    if(!m.last_editor || m.last_editor==='—') m.last_editor = me?.slice(0,8) || 'ADMIN';
    applyMissionFilter(); // recompute crew pool
  }
});

$('#missionRows').addEventListener('change',e=>{
  const input = e.target;
  const row = input.closest('tr[data-id]');
  if(!row) return;
  const id = row.dataset.id;
  const m = missions.find(x=>x.id===id);
  if(!m) return;
  const field = input.dataset.field;
  if(field === 'locked'){
    m.locked = input.checked;
    if(m.locked && (!m.last_editor || m.last_editor==='—')) m.last_editor = me?.slice(0,8) || 'ADMIN';
    applyMissionFilter();
  }
});

$('#clearOverrides').addEventListener('click',async ()=>{
  if(!confirm('Clear ALL mission org % overrides?')) return;
  const { error } = await sb.from('mission_org_cut_overrides').delete().neq('mission_id',null);
  if(error){
    console.error(error);
    showToast('Failed to clear overrides',true);
  }else{
    showToast('All overrides cleared');
    await loadMissionsFromSupabase();
  }
});

$('#saveOverrides').addEventListener('click',saveOverridesToSupabase);

async function loadMissionsFromSupabase(){
  const { data: ms, error } = await sb
    .from('missions')
    .select('id,title,status,payout_auec,org_cut_percent,start_time')
    .order('start_time',{ascending:false})
    .limit(200);
  if(error){
    console.error(error);
    showToast('Failed to load missions',true);
    missions = [];
    applyMissionFilter();
    return;
  }
  const ids = ms.map(m=>m.id);
  let overrides = [];
  if(ids.length){
    const { data: ov, error: e2 } = await sb
      .from('mission_org_cut_overrides')
      .select('mission_id,org_cut_pct,locked,updated_by')
      .in('mission_id', ids);
    if(e2){
      console.error(e2);
      showToast('Failed to load mission overrides',true);
    }else{
      overrides = ov || [];
    }
  }
  const mapOv = {};
  overrides.forEach(o=>{ mapOv[o.mission_id] = o; });

  missions = ms.map(m=>{
    const ov = mapOv[m.id] || {};
    return {
      id: m.id,
      title: m.title,
      status: m.status,
      payout_auec: m.payout_auec ?? 0,
      default_org_pct: m.org_cut_percent ?? orgRules.org_default_pct,
      override_org_pct: ov.org_cut_pct ?? null,
      locked: ov.locked ?? false,
      last_editor: ov.updated_by ? ov.updated_by.slice(0,8) : '—'
    };
  });
  applyMissionFilter();
}

async function saveOverridesToSupabase(){
  if(!missions.length){
    showToast('No missions to save',true);
    return;
  }
  const ids = missions.map(m=>m.id);
  const { error: delErr } = await sb
    .from('mission_org_cut_overrides')
    .delete()
    .in('mission_id', ids);
  if(delErr){
    console.error(delErr);
    showToast('Failed to reset overrides',true);
    return;
  }
  const payload = missions
    .filter(m=>m.override_org_pct!=null || m.locked)
    .map(m=>({
      mission_id: m.id,
      org_cut_pct: m.override_org_pct,
      locked: m.locked,
      updated_by: me
    }));
  if(payload.length){
    const { error } = await sb.from('mission_org_cut_overrides').upsert(payload);
    if(error){
      console.error(error);
      showToast('Failed to save overrides',true);
      return;
    }
  }
  showToast('Mission overrides saved');
  await loadMissionsFromSupabase();
}

/* ============== CREW MODAL (v_missions_payout_live + v_profiles_detailed) ============== */
const crewModal = $('#crewModal');
$('#crewModalClose').addEventListener('click',()=>{ crewModal.style.display='none'; });
crewModal.addEventListener('click',e=>{
  if(e.target === crewModal) crewModal.style.display='none';
});

document.body.addEventListener('click',e=>{
  const btn = e.target.closest('.btn-crew');
  if(!btn) return;
  const id = btn.dataset.id;
  const m = missions.find(x=>x.id===id);
  if(m) openCrewModal(m);
});

async function openCrewModal(mission){
  $('#crewMissionTitle').textContent = mission.title || 'Mission Crew';
  const payout = mission.payout_auec || 0;
  $('#crewMissionMeta').innerHTML = `
    ID: <span class="hilite">${mission.id}</span> •
    Status: <span class="hilite">${mission.status || 'unknown'}</span> •
    Payout: <span class="hilite">${payout ? fmt(payout) : '—'} aUEC</span>
  `;
  $('#crewRows').innerHTML = `<tr><td colspan="5" class="subtle">Loading…</td></tr>`;
  $('#crewSummary').textContent = '';
  crewModal.style.display = 'flex';

  const { data: payouts, error } = await sb
    .from('v_missions_payout_live')
    .select('mission_id,user_id,paygrade,weight,final_share')
    .eq('mission_id', mission.id);

  if(error){
    console.error(error);
    $('#crewRows').innerHTML = `<tr><td colspan="5" class="subtle">Failed to load crew payouts.</td></tr>`;
    showToast('Failed to load crew payouts',true);
    return;
  }
  if(!payouts || !payouts.length){
    $('#crewRows').innerHTML = `<tr><td colspan="5" class="subtle">No payout rows for this mission yet.</td></tr>`;
    $('#crewSummary').textContent = 'No participants recorded.';
    return;
  }

  const userIds = [...new Set(payouts.map(p=>p.user_id).filter(Boolean))];
  let profiles = [];
  if(userIds.length){
    const { data: profs, error: e2 } = await sb
      .from('v_profiles_detailed')
      .select('user_id,handle,display_name,current_rank_code,current_rank_name')
      .in('user_id', userIds);
    if(e2){
      console.error(e2);
      showToast('Failed to load profile details',true);
    }else{
      profiles = profs || [];
    }
  }
  const profMap = {};
  profiles.forEach(p=>{ profMap[p.user_id] = p; });

  payouts.sort((a,b)=>(b.final_share||0)-(a.final_share||0));

  let totalShare = 0;
  const rows = payouts.map(p=>{
    const prof   = profMap[p.user_id] || {};
    const handle = prof.handle || p.user_id?.slice(0,8) || '—';
    const name   = prof.display_name || prof.handle || '—';
    const rank   = prof.current_rank_code || prof.current_rank_name || p.paygrade || '—';
    const w      = p.weight ?? 0;
    const share  = Number(p.final_share || 0);
    totalShare += share;
    return `
      <tr>
        <td>${handle}</td>
        <td>${name}</td>
        <td>${rank}</td>
        <td class="text-right mono">${w ? w.toFixed(3) : '—'}</td>
        <td class="text-right mono">${share ? fmt(Math.round(share)) : '—'}</td>
      </tr>
    `;
  }).join('');

  $('#crewRows').innerHTML = rows;
  $('#crewSummary').innerHTML = `
    Participants: <span class="hilite">${payouts.length}</span>
    • Total distributed: <span class="hilite">${fmt(Math.round(totalShare))} aUEC</span>
  `;
}

/* ============== INIT ============== */
document.addEventListener('DOMContentLoaded', async ()=>{
  const session = await requireAuth();
  if(!session) return;
  sb = getSupabase();
  me = session.user.id;

  await loadOrgRulesFromSupabase();
  await loadPaygradesFromSupabase();
  await loadMissionsFromSupabase();

  const here = location.pathname.split('/').pop();
  document.querySelectorAll('.nav-btn').forEach(a=>{
    if(a.getAttribute('href')===here){a.classList.add('active');}
  });
});
</script>

</body>
</html>
