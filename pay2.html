<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>JMBN ‚Äì Admin Console</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png"
      href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--sub:#0f0f0f;--row:#0a0a0a;
  --border:#d6b44c;--card:#141414;
  --accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;--ok:#5cd47c;
  --fs-base:14px;--fs-small:11px;--fs-h1:clamp(18px,2.2vw,22px);
}
*{box-sizing:border-box}
body{
  margin:0;padding:14px;
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text);
  font-family:'Play',system-ui,sans-serif;
  font-size:var(--fs-base);
  letter-spacing:.25px;
}

/* Brand fallback (in case header2.html fails) */
.brand{
  display:flex;align-items:center;gap:10px;
  margin:0 0 8px;padding-bottom:6px;
  border-bottom:1px solid var(--border);
}
.brand-logo{
  width:44px;height:44px;object-fit:contain;
  filter:drop-shadow(0 0 4px rgba(242,214,117,.25));
}
.brand h1{
  margin:0;font-size:var(--fs-h1);font-weight:700;color:var(--accent);
}

/* Layout */
.page{max-width:1200px;margin:0 auto;}
.grid{
  display:grid;
  grid-template-columns:minmax(320px,0.9fr) minmax(420px,1.1fr);
  gap:14px;
}
@media(max-width:980px){.grid{grid-template-columns:1fr}}

/* Panels */
.panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
  box-shadow:0 0 18px rgba(214,180,76,.22),inset 0 0 0 1px rgba(214,180,76,.12);
}
.panel .hd{
  display:flex;align-items:center;justify-content:space-between;
  padding:10px 12px;
  border-bottom:1px solid var(--border);
}
.panel .hd h3{
  margin:0;color:var(--accent);font-size:16px;font-weight:700;
  display:flex;align-items:center;gap:10px;
}
.panel .body{padding:10px 12px 12px}

/* Tags / pills / text */
.badge{
  display:inline-block;
  border:1px solid var(--border);
  border-radius:999px;
  padding:2px 7px;
  font-size:10px;
  color:var(--muted);
  background:#050505;
}
.pill{
  display:inline-block;
  border-radius:999px;
  border:1px solid var(--border);
  padding:4px 10px;
  font-size:12px;
  background:#050505;
  color:var(--accent);
}
.small{font-size:var(--fs-small);color:var(--muted)}

/* Inputs / buttons */
input[type="search"],select{
  width:100%;
  background:#0a0a0a;
  border:1px solid var(--border);
  border-radius:8px;
  padding:8px 10px;
  color:var(--text);
  font-family:'Play';
  font-size:var(--fs-base);
}
button{
  padding:8px 12px;
  border-radius:10px;
  border:1px solid var(--border);
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);
  cursor:pointer;
  font-family:'Play';
  font-size:12px;
  font-weight:700;
  transition:.18s;
}
button:hover{
  background:var(--accent);
  color:#000;
  box-shadow:0 0 12px rgba(214,180,76,.35);
}
.btn-danger{border-color:var(--bad);color:var(--bad)}
.btn-ok{border-color:var(--ok);color:var(--ok)}
.btn-ghost{
  background:transparent;
  border-radius:999px;
}

/* Member list */
.mlist{
  display:flex;
  flex-direction:column;
  gap:8px;
  max-height:70vh;
  overflow:auto;
}
.mrow{
  display:grid;
  grid-template-columns:auto 1fr auto;
  gap:10px;
  align-items:center;
  padding:8px;
  border-radius:10px;
  border:1px solid transparent;
  background:#0a0a0a;
  cursor:pointer;
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.08);
}
.mrow:hover{
  background:#111;
  border-color:rgba(214,180,76,.45);
}
.mrow.active{
  background:rgba(214,180,76,.16);
  border-color:var(--border);
}

/* Avatar ‚Äì frameless, no gold border */
.mavatar{
  width:38px;height:38px;
  display:grid;place-items:center;
  overflow:hidden;
  background:transparent;
  border:none;
}
.mavatar img{
  width:100%;height:100%;object-fit:contain;
  border:none;background:transparent;box-shadow:none;filter:none;
}

/* KPI cards */
.kpis{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
  margin:10px 0;
}
@media(max-width:720px){.kpis{grid-template-columns:1fr 1fr}}
@media(max-width:520px){.kpis{grid-template-columns:1fr}}
.kpi{
  background:linear-gradient(180deg,#0b0b0b,#080808);
  border-radius:10px;
  border:1px solid var(--border);
  padding:8px;
  box-shadow:0 0 14px rgba(214,180,76,.18),inset 0 0 0 1px rgba(214,180,76,.12);
  text-align:center;
}
.kpi h4{
  margin:0 0 4px;
  font-size:11px;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:.08em;
}
.kpi .val{
  font-size:18px;
  font-weight:700;
  color:var(--accent);
}

/* Progress bars */
.pb{
  display:grid;
  grid-template-columns:120px 1fr auto;
  gap:10px;
  align-items:center;
  margin:6px 0;
}
.pb .label{color:var(--muted);font-size:12px}
.bar{
  height:12px;background:#0a0a0a;
  border-radius:999px;border:1px solid var(--border);
  overflow:hidden;
}
.fill{
  height:100%;
  background:linear-gradient(180deg,var(--accent),#d6b44c);
}
.pb .val{
  font-variant-numeric:tabular-nums;
  color:var(--muted);
  font-size:12px;
}

/* Cert grid ‚Äì 6-up, logo + abbrev only */
.certGrid{
  display:grid;
  grid-template-columns:repeat(6,minmax(0,1fr));
  gap:10px;
}
@media(max-width:1100px){.certGrid{grid-template-columns:repeat(4,minmax(0,1fr))}}
@media(max-width:780px){ .certGrid{grid-template-columns:repeat(3,minmax(0,1fr))}}
@media(max-width:520px){ .certGrid{grid-template-columns:repeat(2,minmax(0,1fr))}}

.cert{
  background:transparent;
  border:none;
  padding:6px;
  text-align:center;
}
.cert.dim{opacity:.5;filter:grayscale(.5)}
.cert .thumb{
  height:72px;
  display:grid;place-items:center;
  margin-bottom:4px;
}
.cert .thumb img{
  max-height:60px;max-width:60px;
  width:auto;height:auto;object-fit:contain;
}
.cert .abbr{
  font-weight:700;
  letter-spacing:.5px;
  color:var(--accent);
  font-size:12px;
}
.cert .title,.cert .small,.cert .meta,[data-open]{display:none!important}

/* Timeline (no dots) */
.timeline{
  position:relative;
  margin-top:10px;
  padding-left:0;
}
.timeline::before{
  content:"";
  position:absolute;
  left:0;top:0;bottom:0;
  width:2px;
  background:linear-gradient(var(--border),transparent);
}
.titem{
  position:relative;
  padding:10px 8px;
  border-bottom:1px solid rgba(255,255,255,.06);
  display:grid;
  grid-template-columns:1fr auto;
  gap:10px;
}
.titem.done .tlabel{color:var(--accent)}
.tdot{display:none!important}

/* Missions list */
.list{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.item{
  border:1px solid var(--border);
  border-radius:10px;
  background:#0b0b0b;
  padding:10px;
  box-shadow:0 0 10px rgba(214,180,76,.18),inset 0 0 0 1px rgba(214,180,76,.08);
}
.item h4{margin:0 0 4px;color:var(--accent);font-size:14px}
.item .meta{font-size:12px;color:var(--muted)}
</style>
</head>
<body>

<!-- Shared header mount (header2.html) -->
<div id="header2-mount">
  <!-- Fallback if header2.html fails -->
  <div class="brand">
    <img class="brand-logo"
         src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png"
         alt="JMBN">
    <h1>JMBN Admin Console</h1>
  </div>
</div>

<div class="page">
  <div class="grid">

    <!-- LEFT: Members list -->
    <section class="panel">
      <div class="hd">
        <h3>Members</h3>
      </div>
      <div class="body">
        <input id="mSearch" type="search" placeholder="Search handle / name‚Ä¶">
        <div id="mList" class="mlist" style="margin-top:8px">Loading‚Ä¶</div>
      </div>
    </section>

    <!-- RIGHT: Inspector / dashboard -->
    <section class="panel">
      <div class="hd">
        <h3>Member Dashboard</h3>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <select id="rankTrack" title="Rank Track">
            <option value="">‚Äî Track ‚Äî</option>
            <option value="Officer">Officer</option>
            <option value="Enlisted">Enlisted</option>
            <option value="Warrant">Warrant</option>
          </select>
          <button id="btnForce" class="pill" title="Force set user's rank track">Force Track</button>

          <select id="rankCode" title="Rank Code">
            <option value="">‚Äî Select Rank ‚Äî</option>
          </select>
          <button id="btnSetRank" class="pill" title="Force set a specific rank code">Set Rank</button>

          <button id="btnPromote" class="pill" disabled>Run Promotion Check</button>
        </div>
      </div>

      <div class="body" id="inspector">
        <div class="small">Select a member to view their dashboard &amp; activity.</div>
      </div>
    </section>

  </div>
</div>

<!-- Supabase + auth -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>

<!-- Mount shared header2.html & highlight nav -->
<script>
async function mountHeader2(){
  const mount = document.getElementById('header2-mount');
  if(!mount) return;
  try{
    const res = await fetch('header2.html',{cache:'no-cache'});
    if(!res.ok) return;
    const html = await res.text();
    mount.innerHTML = html;

    // highlight this page in header nav if matching link exists
    const here = (location.pathname.split('/').pop() || 'index.html');
    const active = mount.querySelector(`.nav-btn[href="${here}"]`);
    if(active) active.classList.add('active');
  }catch(err){
    console.error('Failed to mount header2:', err);
  }
}
mountHeader2();
</script>

<script>
const $  = s => document.querySelector(s);
const esc = s => { const d=document.createElement('div'); d.textContent=s??''; return d.innerHTML; };
const setFill=(el,p)=>{const x=Math.max(0,Math.min(1,Number(p)||0));el.style.width=(x*100)+'%';};

let sb, me, isElev=false, MEMBERS=[], SELECTED=null, RANKS=[];

/* Boot */
document.addEventListener('DOMContentLoaded', async ()=>{
  const session = await requireAuth(); if(!session) return;
  sb = getSupabase(); me = session.user.id;

  try{
    const { data } = await sb.rpc('is_elevated',{ u: me });
    isElev = data===true;
  }catch{}

  if(!isElev){
    $('#inspector').innerHTML='<div class="small" style="color:#ff6b6b">Access denied ‚Äî not elevated.</div>';
    return;
  }

  await loadMembers();
  await loadRankOptions();

  $('#mSearch').oninput = renderMembers;
  $('#rankTrack').onchange = e => loadRankOptions(e.target.value);

  $('#btnForce').onclick = async ()=>{
    if(!SELECTED) return alert('Select a member first.');
    const track=$('#rankTrack').value; if(!track) return alert('Choose a track.');
    if(!confirm(`Force set ${SELECTED.handle||SELECTED.display_name||SELECTED.user_id.slice(0,8)} to ${track}?`)) return;
    const { error } = await sb.rpc('set_rank_track',{ p_user: SELECTED.user_id, p_track: track });
    if(error) return alert('Force set failed: '+error.message);
    alert('Track updated ‚úì');
    await openMember(SELECTED.user_id);
    await loadMembers();
  };

  $('#btnSetRank').onclick = async ()=>{
    if(!SELECTED) return alert('Select a member first.');
    const code=$('#rankCode').value; if(!code) return alert('Choose a rank.');
    if(!confirm(`Force set ${SELECTED.handle||SELECTED.display_name||SELECTED.user_id.slice(0,8)} to ${code}?`)) return;
    const { error } = await sb.rpc('set_rank_code',{ p_user: SELECTED.user_id, p_code: code });
    if(error) return alert('Set rank failed: '+error.message);
    alert('Rank updated ‚úì');
    await openMember(SELECTED.user_id);
    await loadMembers();
  };

  $('#btnPromote').onclick = async ()=>{
    if(!SELECTED) return;
    const { data, error } = await sb.rpc('request_promotion',{ p_user: SELECTED.user_id });
    if(error) return alert('Promotion failed: '+error.message);
    alert(data?.message || (data?.ok?'Promotion OK':'Not eligible yet'));
    await openMember(SELECTED.user_id);
  };
});

/* Ranks dropdown */
async function loadRankOptions(track=''){
  if(!RANKS.length){
    const { data, error } = await sb.from('ranks')
      .select('code,name,category,sort_order')
      .order('sort_order');
    if(error){ console.warn(error.message); return; }
    RANKS=data||[];
  }
  const want = (track||$('#rankTrack').value||'').toLowerCase();
  const items = RANKS.filter(r=>!want || (r.category||'').toLowerCase()===want);
  const sel = $('#rankCode');
  sel.innerHTML = '<option value="">‚Äî Select Rank ‚Äî</option>' +
    items.map(r=>`<option value="${r.code}">${r.code} ‚Äî ${esc(r.name)}</option>`).join('');
}

/* Members list */
async function loadMembers(){
  const { data, error } = await sb.from('v_profiles_detailed').select(`
    user_id,handle,display_name,
    current_rank_category,current_rank_name,current_rank_code,current_rank_image_url
  `).order('handle');

  if(error){
    $('#mList').textContent='Failed to load members: '+error.message;
    return;
  }
  MEMBERS=data||[];
  renderMembers();
}
function renderMembers(){
  const q=($('#mSearch').value||'').toLowerCase().trim();
  const list=$('#mList');
  const rows=q
    ? MEMBERS.filter(m=>(`${m.handle} ${m.display_name}`).toLowerCase().includes(q))
    : MEMBERS;
  if(!rows.length){ list.textContent='No matches.'; return; }
  list.innerHTML='';
  rows.forEach(m=>{
    const row=document.createElement('div');
    row.className='mrow';
    row.innerHTML=`
      <div class="mavatar">
        ${m.current_rank_image_url
          ? `<img src="${esc(m.current_rank_image_url)}" alt="rank">`
          : 'üë§'}
      </div>
      <div>
        <div><b>${esc(m.handle||'(no handle)')}</b>
          <span class="small">‚Ä¢ ${esc(m.display_name||'')}</span>
        </div>
        <div class="small">
          ${esc(m.current_rank_category||'Unrated')} ‚Äî ${esc(m.current_rank_name||'Unrated')}
        </div>
      </div>
      <div><button class="pill">Open</button></div>`;
    row.querySelector('button').onclick=()=>openMember(m.user_id,row);
    list.appendChild(row);
  });
}
function markActive(row){
  document.querySelectorAll('.mrow').forEach(x=>x.classList.remove('active'));
  row?.classList.add('active');
}

/* Dashboard for a member */
async function openMember(userId,rowEl){
  const res=MEMBERS.find(x=>x.user_id===userId); if(!res) return;
  SELECTED=res; markActive(rowEl); $('#btnPromote').disabled=false;

  // preselect UI
  $('#rankTrack').value=res.current_rank_category||'';
  await loadRankOptions(res.current_rank_category||'');
  if(res.current_rank_code) $('#rankCode').value = res.current_rank_code;

  // Dashboard layout
  $('#inspector').innerHTML = `
    <div id="summary"></div>

    <div class="kpis">
      <div class="kpi"><h4>Total Missions</h4><div class="val" id="k_mis">‚Äî</div></div>
      <div class="kpi"><h4>Total Hours</h4><div class="val" id="k_hrs">‚Äî</div></div>
      <div class="kpi"><h4>Owned Certs</h4><div class="val" id="k_cer">‚Äî</div></div>
    </div>

    <div class="pb">
      <div class="label">Missions</div>
      <div class="bar"><div id="pbMis" class="fill" style="width:0%"></div></div>
      <div class="val" id="vMis">‚Äî</div>
    </div>
    <div class="pb">
      <div class="label">Hours</div>
      <div class="bar"><div id="pbHrs" class="fill" style="width:0%"></div></div>
      <div class="val" id="vHrs">‚Äî</div>
    </div>
    <div class="pb">
      <div class="label">Certifications</div>
      <div class="bar"><div id="pbCer" class="fill" style="width:0%"></div></div>
      <div class="val" id="vCer">‚Äî</div>
    </div>

    <div class="panel" style="margin-top:12px">
      <div class="hd"><h3>Certifications</h3></div>
      <div class="body"><div id="certGrid" class="certGrid">Loading‚Ä¶</div></div>
    </div>

    <div class="panel" style="margin-top:12px">
      <div class="hd">
        <h3>Certification Timeline</h3>
        <div>
          <select id="certSelect"></select>
          <button id="btnReloadTL" class="btn-ghost">Load</button>
        </div>
      </div>
      <div class="body">
        <div id="tlHint" class="small">Pick a certification to manage completions.</div>
        <div id="timeline" class="timeline"></div>
      </div>
    </div>

    <div class="panel" style="margin-top:12px">
      <div class="hd">
        <h3>Missions <span id="misCount" class="badge">0</span></h3>
        <div><button id="misReload" class="pill">Reload</button></div>
      </div>
      <div class="body"><div id="misList" class="list">Loading‚Ä¶</div></div>
    </div>
  `;

  await Promise.all([
    loadProgress(userId),
    loadCerts(userId),
    loadMissions(userId)
  ]);

  $('#misReload').onclick = ()=> loadMissions(userId);
}

/* Progress */
async function loadProgress(uid){
  const [{ data: prog }, { data: up }] = await Promise.all([
    sb.from('v_user_rank_progress').select('*').eq('user_id', uid).maybeSingle(),
    sb.from('v_user_progress').select('*').eq('user_id', uid).maybeSingle()
  ]);

  const cur = esc(prog?.current_name||'(unranked)');
  const curPg = esc(prog?.current_paygrade||'‚Äî');
  const nxt = esc(prog?.next_name||'‚Äî');
  const nxtPg = esc(prog?.next_paygrade||'‚Äî');

  $('#summary').innerHTML = `
    <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
      <div>
        <div><b>Current:</b>
          <span style="color:var(--accent)">${cur}</span>
          <span class="pill">PG: ${curPg}</span>
        </div>
        <div class="small">
          Next: ${nxt} <span class="pill">PG: ${nxtPg}</span>
        </div>
      </div>
      <div class="small">
        Targets ‚Ä¢ M:${prog?.missions_target??0}
        ‚Ä¢ H:${prog?.hours_target??0}
        ‚Ä¢ C:${prog?.certification_target??0}
      </div>
    </div>`;

  const m=Number(up?.missions_attended||0),
        h=Number(up?.hours_total||0),
        c=Number(up?.certifications_total||0);
  const mt=Number(prog?.missions_target||0),
        ht=Number(prog?.hours_target||0),
        ct=Number(prog?.certification_target||0);

  $('#k_mis').textContent=String(m);
  $('#k_hrs').textContent=String(h);
  $('#k_cer').textContent=String(c);

  $('#vMis').textContent=`${m} / ${mt}`;
  $('#vHrs').textContent=`${h} / ${ht}`;
  $('#vCer').textContent=`${c} / ${ct}`;

  setFill($('#pbMis'), mt?Math.min(1,m/mt):1);
  setFill($('#pbHrs'), ht?Math.min(1,h/ht):1);
  setFill($('#pbCer'), ct?Math.min(1,c/ct):1);
}

/* Certifications */
async function loadCerts(uid){
  const [{ data: catalog }, { data: mine }, { data: reqs }] = await Promise.all([
    sb.from('certifications')
      .select('certification_code,name,image_url,sort_order,is_active')
      .order('sort_order'),
    sb.from('user_certifications')
      .select('certification_code')
      .eq('user_id', uid),
    sb.from('certification_requirements')
      .select('certification_code,event_code')
  ]);

  const owned = new Set((mine||[]).map(x=>x.certification_code));
  const grid=$('#certGrid'); grid.innerHTML='';
  const select=$('#certSelect'); select.innerHTML='';

  (catalog||[]).forEach(c=>{
    const div=document.createElement('div');
    div.className='cert'+(owned.has(c.certification_code)?'':' dim');
    div.innerHTML=`
      <div class="thumb">${c.image_url?`<img src="${esc(c.image_url)}" alt="">`:'üèÖ'}</div>
      <div class="abbr">${esc(c.certification_code)}</div>`;
    div.title = c.name || c.certification_code;
    div.style.cursor='pointer';
    div.onclick = ()=>{
      select.value=c.certification_code;
      loadTimeline(uid,c.certification_code);
      $('#tlHint').textContent=c.name || c.certification_code;
      $('#timeline').scrollIntoView({behavior:'smooth',block:'nearest'});
    };
    grid.appendChild(div);

    const opt=document.createElement('option');
    opt.value=c.certification_code;
    opt.textContent=`${c.certification_code} ‚Äî ${c.name}`;
    select.appendChild(opt);
  });

  $('#btnReloadTL').onclick = ()=> loadTimeline(uid, select.value);
}

/* Timeline */
async function loadTimeline(uid, certCode){
  const tl=$('#timeline'); tl.innerHTML='';
  if(!certCode){
    tl.innerHTML='<div class="small">Pick a certification.</div>';
    return;
  }

  const [{ data: reqs }, { data: recs }] = await Promise.all([
    sb.from('certification_requirements')
      .select('event_code, sort_order, training_events(title, description)')
      .eq('certification_code', certCode)
      .order('sort_order'),
    sb.from('user_training_events')
      .select('event_code, completed_at, approved_by, approved_at')
      .eq('user_id', uid)
  ]);
  const done=new Map((recs||[]).map(r=>[r.event_code,r]));

  if(!reqs?.length){
    tl.innerHTML='<div class="small">No requirements configured.</div>';
    return;
  }

  reqs.forEach(r=>{
    const rec=done.get(r.event_code);
    const ok=!!rec;
    const row=document.createElement('div');
    row.className='titem'+(ok?' done':'');
    row.innerHTML=`
      <div>
        <div class="tlabel">${esc(r.training_events?.title||r.event_code)}</div>
        <div class="small">${esc(r.training_events?.description||'')}</div>
        ${ok?`<div class="small">
          Completed: ${new Date(rec.approved_at||rec.completed_at).toLocaleString()}
          ${rec.approved_by?` ‚Ä¢ by ${esc(rec.approved_by.slice(0,8))}`:''}
        </div>`:''}
      </div>
      <div>
        ${ok
          ? `<button class="btn-danger" data-remove="${r.event_code}">Remove</button>`
          : `<button class="btn-ok" data-add="${r.event_code}">Grant</button>`}
      </div>`;
    tl.appendChild(row);
  });

  tl.querySelectorAll('button[data-add]').forEach(b=>{
    b.onclick=async ()=>{
      const { error } = await sb.from('user_training_events').insert({
        user_id: uid,
        event_code: b.dataset.add,
        completed_at: new Date().toISOString()
      });
      if(error) return alert('Grant failed: '+error.message);
      await Promise.all([loadTimeline(uid,certCode),loadProgress(uid)]);
    };
  });
  tl.querySelectorAll('button[data-remove]').forEach(b=>{
    b.onclick=async ()=>{
      const { error } = await sb.from('user_training_events')
        .delete().eq('user_id',uid).eq('event_code',b.dataset.remove);
      if(error) return alert('Remove failed: '+error.message);
      await Promise.all([loadTimeline(uid,certCode),loadProgress(uid)]);
    };
  });
}

/* Missions */
async function loadMissions(uid){
  const box = $('#misList');
  const count = $('#misCount');
  box.textContent = 'Loading‚Ä¶';
  try{
    let { data, error } = await sb
      .from('v_mission_attendees_detailed')
      .select('mission_id, attendance, missions(id,title,start_time)')
      .eq('user_id', uid)
      .order('missions.start_time', { ascending:false })
      .limit(20);

    if (error || (data && data.length && data[0].missions == null)) {
      const { data: bare, error: e2 } = await sb
        .from('v_mission_attendees_detailed')
        .select('mission_id, attendance')
        .eq('user_id', uid)
        .order('mission_id', { ascending:false })
        .limit(50);
      if (e2) throw e2;

      const ids = [...new Set((bare||[]).map(r=>r.mission_id))];
      let map = {};
      if (ids.length){
        const { data: mrows } = await sb
          .from('missions')
          .select('id,title,start_time')
          .in('id', ids);
        map = Object.fromEntries((mrows||[]).map(m=>[m.id, m]));
      }
      data = (bare||[]).map(r => ({ ...r, missions: map[r.mission_id] || null }))
                       .sort((a,b)=> new Date(b.missions?.start_time||0) - new Date(a.missions?.start_time||0))
                       .slice(0,20);
    }

    const attended = (data||[]).filter(r => r.attendance && r.attendance.toLowerCase() !== 'withdrawn');
    count.textContent = String(attended.length);

    if (!data || !data.length){
      box.innerHTML = '<div class="small">No missions found.</div>';
      return;
    }

    box.innerHTML = data.map(r=>{
      const m = r.missions || {};
      const when = m.start_time ? new Date(m.start_time).toLocaleString() : '';
      const att = r.attendance || '‚Äî';
      return `<div class="item">
        <h4>${esc(m.title || 'Untitled Mission')}</h4>
        <div class="meta">${when} ‚Ä¢ Attendance: ${esc(att)}</div>
      </div>`;
    }).join('');
  }catch(e){
    box.innerHTML = `<div class="small" style="color:#ff9c9c">
      Failed to load missions: ${esc(e.message||e)}
    </div>`;
    count.textContent = '0';
  }
}
</script>
</body>
</html>
