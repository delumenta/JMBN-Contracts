<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JMBN ‚Äì Progression</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png"
      href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png"
      sizes="32x32">

<style>
:root{
  --bg:#000;
  --panel:#0b0b0b;
  --card:#0c0c0c;
  --border:#d6b44c;
  --accent:#f2d675;
  --accent-soft:#c9b06a;
  --text:#f7f1d0;
  --muted:#c9b06a;
  --bad:#ff6b6b;
  --ok:#5cd47c;
  --fs:14px;
}

/* Reset / base */
*{box-sizing:border-box;margin:0;padding:0}
body{
  padding:14px;
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text);
  font-family:'Play',system-ui,sans-serif;
  font-size:var(--fs);
  letter-spacing:.25px;
}

/* Fallback brand (if header.html fails) */
.brand{
  display:flex;align-items:center;gap:10px;
  margin:0 0 8px;
  padding-bottom:6px;
  border-bottom:1px solid var(--border);
}
.brand-logo{
  width:44px;height:44px;object-fit:contain;
  border:none;background:transparent;box-shadow:none;
}
.brand h1{
  font-weight:700;
  font-size:clamp(18px,2.2vw,22px);
  color:var(--accent);
}

/* Panels */
.panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:18px;
  padding:14px 14px 16px;
  margin-top:10px;
  box-shadow:
    0 0 0 1px rgba(214,180,76,.25),
    0 18px 50px rgba(0,0,0,.95);
  position:relative;
  overflow:hidden;
}
.panel::before{
  content:"";
  position:absolute;
  inset:-40% 5% auto;
  background:radial-gradient(circle at 10% 0,rgba(242,214,117,.12),transparent 60%);
  opacity:.55;
  pointer-events:none;
}
.panel > *{position:relative;z-index:1}

/* Section titles */
.section-title{
  font-size:15px;
  color:var(--accent);
  letter-spacing:.22em;
  text-transform:uppercase;
  margin-bottom:4px;
}
.section-sub{
  font-size:12px;
  color:var(--muted);
}

/* Rank header small label */
.sub-label{
  font-size:11px;
  color:var(--muted);
  letter-spacing:.18em;
  text-transform:uppercase;
}

/* Top block layout */
.top-grid{
  display:grid;
  grid-template-columns:minmax(0,1.4fr) minmax(0,1fr);
  gap:16px;
  margin-top:12px;
}
@media(max-width:780px){
  .top-grid{grid-template-columns:1fr}
}

/* Current rank text area on the left */
.current-text{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.current-name{
  font-size:18px;
  font-weight:700;
}
.pg-pill{
  display:inline-flex;
  align-items:center;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  font-size:12px;
  background:#121212;
}

/* Cinematic transition card */
.rank-transition{
  background:radial-gradient(circle at top,rgba(242,214,117,.12),#050505 65%);
  border-radius:16px;
  border:1px solid rgba(214,180,76,.7);
  padding:16px 14px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
}
.rt-col{
  display:flex;
  flex-direction:column;
  align-items:center;
  width:90px;
  text-align:center;
}
.rt-label{
  font-size:11px;
  color:var(--muted);
  letter-spacing:.18em;
  text-transform:uppercase;
  margin-bottom:6px;
}
.rt-icon{
  width:64px;height:64px;
  margin-bottom:6px;
  object-fit:contain;
  border:none;background:transparent;box-shadow:none;
}
.rt-name{
  font-size:12px;
  color:var(--accent);
  line-height:1.3;
}
.rt-bar-wrap{
  flex:1;
  display:flex;
  flex-direction:column;
  align-items:stretch;
  gap:6px;
}
.rt-bar{
  position:relative;
  height:14px;
  background:#050505;
  border-radius:999px;
  border:1px solid rgba(214,180,76,.7);
  box-shadow:
    inset 0 0 6px rgba(0,0,0,.9),
    0 0 12px rgba(214,180,76,.45);
  overflow:hidden;
}
.rt-bar-fill{
  position:absolute;
  inset:0;
  width:0;
  background:
    linear-gradient(90deg,rgba(242,214,117,0.2),rgba(242,214,117,0.75)),
    repeating-linear-gradient(90deg,rgba(0,0,0,.1) 0,rgba(0,0,0,.1) 2px,transparent 2px,transparent 4px);
  transform-origin:left center;
  transition:width .6s ease-out;
}
.rt-bar-glo{
  position:absolute;
  inset:0;
  background:radial-gradient(circle at 35% 50%,rgba(242,214,117,.45),transparent 60%);
  mix-blend-mode:screen;
  opacity:.35;
  pointer-events:none;
}
.rt-bar-caption{
  font-size:11px;
  color:var(--muted);
  text-align:center;
}

/* Promotion button & note */
.promote-row{
  display:flex;
  align-items:center;
  gap:12px;
  margin-top:12px;
  flex-wrap:wrap;
}
.btn-main{
  padding:9px 18px;
  border-radius:999px;
  border:1px solid var(--border);
  background:radial-gradient(circle at top,rgba(242,214,117,.22),#060606);
  color:var(--accent);
  font-size:13px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:8px;
}
.btn-main:disabled{
  opacity:.4;
  cursor:not-allowed;
  background:#050505;
}
.btn-main:not(:disabled):hover{
  background:linear-gradient(180deg,#f2d675,#d6b44c);
  color:#000;
}
.note{
  font-size:12px;
  color:var(--muted);
}

/* Requirements bars */
.req-section{
  margin-top:16px;
}
.req-bars{
  margin-top:10px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.req-row{
  background:var(--card);
  border-radius:14px;
  border:1px solid rgba(214,180,76,.5);
  padding:10px 12px;
}
.req-label{
  font-size:11px;
  color:var(--muted);
  letter-spacing:.16em;
  text-transform:uppercase;
  margin-bottom:6px;
}
.req-bar{
  position:relative;
  height:13px;
  border-radius:999px;
  background:#050505;
  border:1px solid rgba(214,180,76,.6);
  overflow:hidden;
}
.req-fill{
  position:absolute;
  inset:0;
  width:0;
  background:linear-gradient(90deg,var(--accent),#cfa94b);
  transition:width .6s ease-out;
}
.req-val{
  margin-top:4px;
  font-size:12px;
  color:var(--muted);
  text-align:right;
  font-variant-numeric:tabular-nums;
}

/* Certifications grid */
.cert-section{
  margin-top:18px;
}
.certGrid{
  display:grid;
  grid-template-columns:repeat(6,minmax(0,1fr));
  gap:10px;
  margin-top:10px;
}
@media(max-width:1100px){.certGrid{grid-template-columns:repeat(5,1fr)}}
@media(max-width:900px){.certGrid{grid-template-columns:repeat(4,1fr)}}
@media(max-width:700px){.certGrid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:520px){.certGrid{grid-template-columns:repeat(2,1fr)}}
.cert{
  background:transparent;
  text-align:center;
  padding:4px 2px 10px;
  border-radius:8px;
  transition:transform .15s ease,opacity .15s ease,filter .15s ease;
}
.cert:hover{transform:scale(1.05)}
.cert.dim{opacity:.45;filter:grayscale(.6)}
.cert .thumb{
  width:64px;height:64px;
  display:grid;place-items:center;
  margin:0 auto 4px;
}
.cert .thumb img{
  width:auto;max-width:54px;max-height:100%;
  object-fit:contain;
}
.cert .title{
  font-weight:700;font-size:12px;
}
.cert .code{
  font-size:10px;color:var(--muted);margin-top:1px;
}

/* Timeline */
.timeline-section{
  margin-top:18px;
}
.timeline-controls{
  margin-top:10px;
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}
.timeline-select{
  background:#050505;
  border:1px solid var(--border);
  border-radius:999px;
  padding:8px 12px;
  color:var(--text);
  font-family:'Play';
  font-size:13px;
}
.btn-ghost{
  padding:8px 12px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#050505;
  color:var(--accent);
  cursor:pointer;
  font-family:'Play';
}
.btn-ghost:hover{
  background:radial-gradient(circle at top,var(--accent),#050505);
  color:#000;
}
.tl-hint{
  margin-top:6px;
  font-size:12px;
  color:var(--muted);
}

/* vertical line */
.timeline{
  position:relative;
  margin-top:8px;
  padding-left:32px;
}
.timeline::before{
  content:"";
  position:absolute;
  left:13px;top:0;bottom:0;
  width:2px;
  background:linear-gradient(to bottom,var(--border),transparent);
  box-shadow:0 0 8px rgba(214,180,76,.6);
}
.titem{
  position:relative;
  padding:10px 4px 12px;
  border-bottom:1px solid rgba(255,255,255,.04);
  display:grid;
  grid-template-columns:minmax(0,1.7fr) minmax(0,1fr);
  gap:8px;
}
.titem:last-child{border-bottom:none}
.tlabel{
  font-size:13px;
}
.tstatus{
  font-size:12px;
  text-align:right;
}
.tstatus.done{color:var(--ok)}
.tstatus.pending{color:var(--muted)}
</style>
</head>
<body>

<!-- Header mount point (replaced by header.html if available) -->
<div id="header-container">
  <div class="brand">
    <img class="brand-logo"
         src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png"
         alt="JMBN">
    <h1>JMBN ‚Äì Progression</h1>
  </div>
</div>

<script>
/* Inject shared header.html and set active nav */
(async () => {
  try{
    const r = await fetch('header.html',{cache:'no-cache'});
    if(!r.ok) return;
    const html = await r.text();
    const mount = document.getElementById('header-container');
    if(mount) mount.outerHTML = html;

    requestAnimationFrame(() => {
      const here = (location.pathname.split('/').pop() || 'progression.html').toLowerCase();
      document.querySelectorAll('.nav-btn').forEach(a=>{
        const href = (a.getAttribute('href')||'').toLowerCase();
        if (href === here) a.classList.add('active');
        if (/progress/.test(here) && /progress/.test(href)) a.classList.add('active');
      });
    });
  }catch(e){ console.warn('Header mount failed:', e); }
})();
</script>

<!-- Main panel -->
<div class="panel">
  <div>
    <div class="section-title">Rank Progression</div>
    <div class="section-sub">
      Track your journey from current paygrade to the next step in the JMBN ladder.
    </div>
  </div>

  <!-- Top: current text + cinematic bar -->
  <div class="top-grid">
    <!-- Left: current summary -->
    <div class="current-text">
      <div class="sub-label">Current Rank</div>
      <div id="curTextName" class="current-name">‚Äî</div>
      <div class="pg-pill" id="curTextPg">PG: ‚Äî</div>
    </div>

    <!-- Right: cinematic transition -->
    <div class="rank-transition">
      <div class="rt-col">
        <div class="rt-label">Current</div>
        <img id="curImg" class="rt-icon" alt="Current Rank">
        <div id="rtCurName" class="rt-name">‚Äî</div>
      </div>

      <div class="rt-bar-wrap">
        <div class="rt-bar">
          <div class="rt-bar-fill" id="rtBarFill"></div>
          <div class="rt-bar-glo"></div>
        </div>
        <div class="rt-bar-caption" id="rtBarCaption">Progress to next rank</div>
      </div>

      <div class="rt-col">
        <div class="rt-label">Next</div>
        <img id="nextImg" class="rt-icon" alt="Next Rank">
        <div id="rtNextName" class="rt-name">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- Promotion row -->
  <div class="promote-row">
    <button id="btnPromote" class="btn-main" disabled>
      <span>‚ñ≤</span><span>Request Promotion</span>
    </button>
    <div id="promoNote" class="note">
      Promotion is available when all targets are met.
    </div>
  </div>

  <!-- Requirements -->
  <div class="req-section">
    <div class="section-title">Requirements to Next Rank</div>
    <div class="section-sub">
      Live counters from missions, hours, and certifications.
    </div>

    <div class="req-bars">
      <div class="req-row">
        <div class="req-label">Missions</div>
        <div class="req-bar">
          <div id="pbMissions" class="req-fill"></div>
        </div>
        <div class="req-val" id="valMissions">0 / 0</div>
      </div>

      <div class="req-row">
        <div class="req-label">Hours</div>
        <div class="req-bar">
          <div id="pbHours" class="req-fill"></div>
        </div>
        <div class="req-val" id="valHours">0 / 0</div>
      </div>

      <div class="req-row">
        <div class="req-label">Certifications</div>
        <div class="req-bar">
          <div id="pbCerts" class="req-fill"></div>
        </div>
        <div class="req-val" id="valCerts">0 / 0</div>
      </div>
    </div>
  </div>

  <!-- Certifications -->
  <div class="cert-section">
    <div class="section-title">Certifications</div>
    <div class="section-sub">
      Gold badges are owned; dimmed badges are not yet earned.
    </div>
    <div id="certGrid" class="certGrid" style="margin-top:10px">‚Äî</div>
  </div>

  <!-- Certification timeline -->
  <div class="timeline-section">
    <div class="section-title">Certification Timeline</div>
    <div class="section-sub">
      Pick a certification to view its required trainings.
    </div>

    <div class="timeline-controls">
      <select id="certSelect" class="timeline-select">
        <option value="">‚Äî Select a Certification ‚Äî</option>
      </select>
      <button id="btnReloadTL" class="btn-ghost" type="button">Load</button>
    </div>
    <div id="tlHint" class="tl-hint">
      Pick a certification to view its required trainings.
    </div>

    <div id="timeline" class="timeline"></div>
  </div>
</div>

<!-- Supabase + auth -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
const $ = s => document.querySelector(s);

let sb, me;

/* Helpers */
function setFill(el,pct){
  const x=Math.max(0,Math.min(1,Number(pct)||0));
  el.style.width=(x*100)+'%';
}

async function fetchRankImage(code){
  if(!code) return '';
  try{
    return sb.storage.from('Ranks').getPublicUrl(`${code}.png`).data.publicUrl || '';
  }catch{
    return '';
  }
}

/* MAIN INIT */
document.addEventListener('DOMContentLoaded', async ()=>{
  const session = await requireAuth();
  if(!session) return;
  sb = getSupabase();
  me = session.user.id;

  await loadProgress();
  await loadCerts();

  $('#btnReloadTL').onclick = () => loadTimeline($('#certSelect').value);
  $('#certSelect').onchange = () => loadTimeline($('#certSelect').value);
});

/* Load rank + progress */
async function loadProgress(){
  const { data: prog } = await sb
    .from('v_user_rank_progress')
    .select('*')
    .eq('user_id',me)
    .maybeSingle();

  // Text summary
  $('#curTextName').textContent = prog?.current_name || '(Unranked)';
  $('#curTextPg').textContent   = `PG: ${prog?.current_paygrade || '‚Äî'}`;

  // Cinematic names
  $('#rtCurName').textContent   = prog?.current_name || '‚Äî';
  $('#rtNextName').textContent  = prog?.next_name || '‚Äî';

  // Icons
  const curImg = await fetchRankImage(prog?.current_code);
  const nxtImg = await fetchRankImage(prog?.next_code);
  if(curImg) $('#curImg').src  = curImg;
  if(nxtImg) $('#nextImg').src = nxtImg;

  // Progress numbers
  const { data: up } = await sb
    .from('v_user_progress')
    .select('*')
    .eq('user_id',me)
    .maybeSingle();

  const m  = Number(up?.missions_attended  || 0);
  const h  = Number(up?.hours_total        || 0);
  const c  = Number(up?.certifications_total || 0);
  const mt = Number(prog?.missions_target  || 0);
  const ht = Number(prog?.hours_target     || 0);
  const ct = Number(prog?.certification_target || 0);

  // Requirements bars
  $('#valMissions').textContent = `${m} / ${mt}`;
  $('#valHours').textContent    = `${h} / ${ht}`;
  $('#valCerts').textContent    = `${c} / ${ct}`;

  setFill($('#pbMissions'), mt ? m/mt : 1);
  setFill($('#pbHours'),    ht ? h/ht : 1);
  setFill($('#pbCerts'),    ct ? c/ct : 1);

  // Combined ratio for cinematic bar
  const ratios = [];
  if(mt) ratios.push(Math.min(1,m/mt));
  if(ht) ratios.push(Math.min(1,h/ht));
  if(ct) ratios.push(Math.min(1,c/ct));
  const overall = ratios.length ? ratios.reduce((a,b)=>a+b,0)/ratios.length : 1;
  setFill($('#rtBarFill'), overall);
  $('#rtBarCaption').textContent =
    prog?.next_name
      ? `Overall progress to ${prog.next_name}`
      : 'Overall progress';

  // Promotion button state + note
  const allMet =
    (mt ? m >= mt : true) &&
    (ht ? h >= ht : true) &&
    (ct ? c >= ct : true) &&
    !!prog?.next_code;

  const btn = $('#btnPromote');
  const note = $('#promoNote');

  btn.disabled = !allMet;
  note.textContent = !prog?.next_code
    ? 'You are at the highest rank or next rank is not configured.'
    : allMet
        ? 'All requirements met. You can request promotion.'
        : 'Promotion is available when all targets are met.';
}

/* Load certifications + owned state */
async function loadCerts(){
  const [catRes, mineRes] = await Promise.all([
    sb.from('certifications')
      .select('certification_code,name,image_url,sort_order')
      .order('sort_order',{ascending:true}),
    sb.from('user_certifications')
      .select('certification_code')
      .eq('user_id',me)
  ]);

  const cat  = catRes.data  || [];
  const mine = mineRes.data || [];
  const owned = new Set(mine.map(x=>x.certification_code));

  // Grid
  $('#certGrid').innerHTML = cat.map(c=>{
    const dim = owned.has(c.certification_code) ? '' : ' dim';
    return `
      <div class="cert${dim}">
        <div class="thumb">
          ${c.image_url ? `<img src="${c.image_url}" alt="">` : 'üèÖ'}
        </div>
        <div class="title">${c.name}</div>
        <div class="code">${c.certification_code}</div>
      </div>`;
  }).join('');

  // Select
  const sel = $('#certSelect');
  sel.innerHTML = '<option value="">‚Äî Select a Certification ‚Äî</option>' +
    cat.map(c => `<option value="${c.certification_code}">${c.certification_code} ‚Äî ${c.name}</option>`).join('');
}

/* Load timeline for a certification */
async function loadTimeline(code){
  const tl = $('#timeline');
  if(!code){
    tl.innerHTML = '';
    $('#tlHint').textContent = 'Pick a certification to view its required trainings.';
    return;
  }

  $('#tlHint').textContent = 'Training events required for this certification:';

  const [reqRes, doneRes] = await Promise.all([
    sb.from('certification_requirements')
      .select('event_code,sort_order,training_events(title,description)')
      .eq('certification_code',code)
      .order('sort_order',{ascending:true}),
    sb.from('user_training_events')
      .select('event_code,completed_at,approved_by')
      .eq('user_id',me)
  ]);

  const reqs = reqRes.data  || [];
  const done = doneRes.data || [];
  const map  = new Map(done.map(r=>[r.event_code,r]));

  if(!reqs.length){
    tl.innerHTML = '<div class="tl-hint">No requirement events configured for this certification yet.</div>';
    return;
  }

  tl.innerHTML = reqs.map(r=>{
    const rec = map.get(r.event_code);
    const ok  = !!rec;
    const statusClass = ok ? 'done' : 'pending';
    const statusText  = ok ? 'Completed' : 'Pending';
    return `
      <div class="titem">
        <div class="tlabel">
          ${r.training_events?.title || r.event_code}
        </div>
        <div class="tstatus ${statusClass}">
          ${statusText}
        </div>
      </div>`;
  }).join('');
}
</script>
</body>
</html>