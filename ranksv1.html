<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JMBN ‚Äì Progression</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png"
      href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png"
      sizes="32x32">

<style>
:root{
  --bg:#000;
  --panel:#050505;
  --panel-soft:#0b0b0b;
  --border:#d6b44c;
  --accent:#f2d675;
  --accent-soft:#c9b06a;
  --text:#f7f1d0;
  --muted:#c9b06a;
  --bad:#ff6b6b;
  --ok:#5cd47c;
  --fs-base:14px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text);
  font-family:'Play',system-ui,sans-serif;
  font-size:var(--fs-base);
  letter-spacing:.25px;
  padding:14px;
}

/* Fallback brand (used only if header.html fails) */
.brand{
  display:flex;align-items:center;gap:10px;
  margin:0 0 10px;padding-bottom:8px;
  border-bottom:1px solid var(--border);
}
.brand-logo{
  width:44px;height:44px;object-fit:contain;
  filter:drop-shadow(0 0 4px rgba(242,214,117,.35));
}
.brand h1{
  margin:0;
  font-weight:700;
  font-size:clamp(18px,2.2vw,22px);
  color:var(--accent);
}

/* Main panel shell */
.shell{
  max-width:960px;
  margin:0 auto;
}
.panel{
  background:
    radial-gradient(circle at top left,rgba(242,214,117,.06),rgba(0,0,0,1) 65%);
  border-radius:18px;
  border:1px solid rgba(214,180,76,.85);
  box-shadow:
    0 0 0 1px rgba(242,214,117,.18),
    0 24px 60px rgba(0,0,0,.9);
  padding:16px 16px 18px;
  position:relative;
  overflow:hidden;
}
.panel + .panel{margin-top:14px}
.panel::before{
  content:"";
  position:absolute;inset:-40%;
  background:
    radial-gradient(circle at 10% 0%,rgba(242,214,117,.13),transparent 55%);
  opacity:.45;
  pointer-events:none;
}
.panel > *{position:relative;z-index:1}

/* Section titles */
.section-title{
  font-size:13px;
  text-transform:uppercase;
  letter-spacing:.25em;
  color:var(--accent);
  margin-bottom:4px;
}
.section-sub{
  font-size:12px;
  color:var(--muted);
  margin-bottom:12px;
}

/* Rank header info row */
.rank-info{
  display:flex;
  flex-wrap:wrap;
  gap:10px 18px;
  align-items:flex-start;
  justify-content:space-between;
}
.rank-info-block{
  min-width:200px;
}
.rank-label{
  font-size:11px;
  letter-spacing:.18em;
  text-transform:uppercase;
  color:var(--accent-soft);
}
.rank-name{
  font-size:18px;
  margin-top:4px;
}
.pg-pill{
  display:inline-flex;align-items:center;
  border-radius:999px;
  border:1px solid var(--border);
  padding:4px 10px;
  font-size:11px;
  margin-top:6px;
  background:rgba(0,0,0,.8);
}

/* Rank transition bar */
.rank-transition{
  margin-top:16px;
  padding:16px 14px;
  border-radius:14px;
  border:1px solid rgba(214,180,76,.7);
  background:
    radial-gradient(circle at top,rgba(242,214,117,.06),rgba(0,0,0,.97));
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
}
.rt-col{
  display:flex;
  flex-direction:column;
  align-items:center;
  width:96px;
}
.rt-label{
  font-size:11px;
  color:var(--muted);
  letter-spacing:.18em;
  text-transform:uppercase;
  margin-bottom:6px;
}
.rt-icon{
  width:64px;height:64px;
  object-fit:contain;
  margin-bottom:6px;
}
.rt-name{
  font-size:12px;
  color:var(--accent);
  text-align:center;
  line-height:1.4;
}

/* Central bar */
.rt-bar-wrap{
  flex:1;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.rt-bar-shell{
  height:12px;
  border-radius:999px;
  border:1px solid var(--border);
  background:#060606;
  overflow:hidden;
}
.rt-bar-fill{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#f2d675,#f7f1d0,#d6b44c);
  box-shadow:0 0 10px rgba(242,214,117,.8);
  transition:width .45s ease-out;
}
.rt-bar-caption{
  font-size:11px;
  color:var(--muted);
  text-align:center;
}

/* Promote button + note */
.action-row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  justify-content:space-between;
  margin-top:14px;
}
.btn{
  padding:9px 16px;
  border-radius:999px;
  border:1px solid var(--border);
  background:radial-gradient(circle at top left,rgba(242,214,117,.24),#050505);
  color:var(--accent);
  font-family:'Play';
  font-size:13px;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:8px;
}
.btn[disabled]{
  opacity:.45;
  cursor:default;
}
.btn:not([disabled]):hover{
  background:radial-gradient(circle at top left,#f2d675,#cfa94b);
  color:#000;
}
.btn span.icon{
  width:18px;height:18px;
  border-radius:50%;
  border:1px solid var(--border);
  display:grid;place-items:center;
  font-size:13px;
}
.note{
  font-size:12px;
  color:var(--muted);
}

/* Requirements bars */
.req-row{
  display:grid;
  grid-template-columns:120px 1fr auto;
  gap:10px;
  align-items:center;
  margin:10px 0;
}
.req-label{
  font-size:12px;
  letter-spacing:.14em;
  text-transform:uppercase;
  color:var(--accent-soft);
}
.req-bar-shell{
  height:12px;
  border-radius:999px;
  border:1px solid rgba(214,180,76,.65);
  background:#050505;
  overflow:hidden;
}
.req-bar-fill{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#f2d675,#f7f1d0,#d6b44c);
  transition:width .35s ease-out;
}
.req-val{
  font-size:12px;
  color:var(--muted);
  font-variant-numeric:tabular-nums;
}

/* Certifications grid */
.certGrid{
  margin-top:10px;
  display:grid;
  grid-template-columns:repeat(6,minmax(0,1fr));
  gap:10px;
  justify-items:center;
}
@media(max-width:1100px){.certGrid{grid-template-columns:repeat(5,1fr)}}
@media(max-width:900px){.certGrid{grid-template-columns:repeat(4,1fr)}}
@media(max-width:700px){.certGrid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:520px){.certGrid{grid-template-columns:repeat(2,1fr)}}
.cert{
  text-align:center;
  padding:6px 4px 10px;
  border-radius:10px;
  background:rgba(0,0,0,.5);
  border:1px solid rgba(214,180,76,.4);
  transition:transform .15s ease,box-shadow .15s ease,opacity .15s ease,filter .15s ease;
}
.cert .thumb{
  width:64px;height:64px;
  display:grid;place-items:center;
  margin:0 auto 4px;
}
.cert .thumb img{
  max-width:54px;max-height:100%;object-fit:contain;
}
.cert .title{font-size:12px;font-weight:700}
.cert .code{font-size:10px;color:var(--muted);margin-top:1px}
.cert.dim{
  opacity:.45;
  filter:grayscale(.65);
}
.cert:not(.dim):hover{
  transform:translateY(-1px);
  box-shadow:0 0 18px rgba(242,214,117,.4);
}

/* Timeline */
.timeline-wrap{
  margin-top:10px;
  border-radius:14px;
  border:1px solid rgba(214,180,76,.65);
  background:#050505;
  padding:10px 10px 6px;
}
.timeline{
  position:relative;
  padding-left:26px;
}
.timeline::before{
  content:"";
  position:absolute;
  left:8px;top:0;bottom:0;
  width:2px;
  background:linear-gradient(to bottom,var(--border),transparent);
  opacity:.8;
}
.titem{
  position:relative;
  padding:8px 4px 10px;
  border-bottom:1px solid rgba(255,255,255,.06);
  display:grid;
  grid-template-columns:1fr auto;
  gap:8px;
}
.titem:last-child{border-bottom:none}
.tdot{
  position:absolute;
  left:-3px;top:14px;
  width:10px;height:10px;
  border-radius:50%;
  border:2px solid var(--border);
  background:#050505;
}
.titem.done .tdot{background:var(--accent);}
.t-main{
  font-size:13px;
}
.t-sub{
  font-size:11px;
  color:var(--muted);
}
.t-status{
  font-size:11px;
  align-self:center;
  color:var(--muted);
}
.titem.done .t-status{color:var(--ok);}
@media(max-width:520px){
  .rank-info{flex-direction:column}
}

/* Form-ish controls */
select{
  background:#050505;
  border-radius:999px;
  border:1px solid var(--border);
  padding:7px 11px;
  color:var(--text);
  font-family:'Play';
  font-size:13px;
}
select:focus{outline:none;box-shadow:0 0 0 1px rgba(242,214,117,.55);}
</style>
</head>
<body>

<!-- Header mount point -->
<div id="header-container">
  <div class="brand">
    <img class="brand-logo" src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" alt="JMBN">
    <h1>JMBN ‚Äì Progression</h1>
  </div>
</div>
<script>
/* Inject shared header.html and highlight nav */
(async () => {
  try{
    const r = await fetch('header.html',{cache:'no-cache'});
    if(!r.ok) return;
    const html = await r.text();
    const mount = document.getElementById('header-container');
    if(mount) mount.outerHTML = html;

    requestAnimationFrame(() => {
      const here = (location.pathname.split('/').pop() || 'progression.html').toLowerCase();
      document.querySelectorAll('.nav-btn').forEach(a=>{
        const href = (a.getAttribute('href')||'').toLowerCase();
        if(href === here) a.classList.add('active');
      });
    });
  }catch(e){ console.warn('Header mount failed:', e); }
})();
</script>

<div class="shell">

  <!-- RANK PROGRESSION PANEL -->
  <section class="panel">
    <div class="section-title">Rank Progression</div>
    <div class="section-sub">
      Track your journey from your current paygrade to the next step in the JMBN ladder.
    </div>

    <!-- Compact info row -->
    <div class="rank-info">
      <div class="rank-info-block">
        <div class="rank-label">Current Rank</div>
        <div id="curRankName" class="rank-name">‚Äî</div>
        <div id="curPg" class="pg-pill">PG: ‚Äî</div>
      </div>
      <div class="rank-info-block" style="text-align:right">
        <div class="rank-label">Next Rank</div>
        <div id="nextRankName" class="rank-name">‚Äî</div>
        <div id="nextPg" class="pg-pill">PG: ‚Äî</div>
      </div>
    </div>

    <!-- Cinematic transition bar -->
    <div class="rank-transition">
      <div class="rt-col">
        <div class="rt-label">Current</div>
        <img id="curImg" class="rt-icon" alt="Current Rank">
        <div id="rtCurName" class="rt-name">‚Äî</div>
      </div>

      <div class="rt-bar-wrap">
        <div class="rt-bar-shell">
          <div id="rtFill" class="rt-bar-fill"></div>
        </div>
        <div id="rtCaption" class="rt-bar-caption">Progress towards next rank</div>
      </div>

      <div class="rt-col">
        <div class="rt-label">Next</div>
        <img id="nextImg" class="rt-icon" alt="Next Rank">
        <div id="rtNextName" class="rt-name">‚Äî</div>
      </div>
    </div>

    <div class="action-row">
      <button id="btnPromote" class="btn" disabled>
        <span class="icon">‚¨Ü</span>
        <span>Request Promotion</span>
      </button>
      <div id="promoteNote" class="note">
        Promotion is available when all targets are met.
      </div>
    </div>
  </section>

  <!-- REQUIREMENTS -->
  <section class="panel">
    <div class="section-title">Requirements To Next Rank</div>

    <div class="req-row">
      <div class="req-label">Missions</div>
      <div class="req-bar-shell"><div id="pbMissions" class="req-bar-fill"></div></div>
      <div id="valMissions" class="req-val">0 / 0</div>
    </div>

    <div class="req-row">
      <div class="req-label">Hours</div>
      <div class="req-bar-shell"><div id="pbHours" class="req-bar-fill"></div></div>
      <div id="valHours" class="req-val">0 / 0</div>
    </div>

    <div class="req-row">
      <div class="req-label">Certifications</div>
      <div class="req-bar-shell"><div id="pbCerts" class="req-bar-fill"></div></div>
      <div id="valCerts" class="req-val">0 / 0</div>
    </div>
  </section>

  <!-- CERTIFICATIONS -->
  <section class="panel">
    <div class="section-title">Certifications</div>
    <div class="section-sub">
      Gold badges are owned; dimmed badges are not yet earned.
    </div>
    <div id="certGrid" class="certGrid">‚Äî</div>
  </section>

  <!-- CERTIFICATION TIMELINE -->
  <section class="panel">
    <div class="section-title">Certification Timeline</div>
    <div class="section-sub">
      Pick a certification to view its required trainings.
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px">
      <select id="certSelect">
        <option value="">‚Äî Select a Certification ‚Äî</option>
      </select>
      <button id="btnReloadTL" class="btn" style="padding-inline:14px">
        <span>Load</span>
      </button>
    </div>

    <div id="tlHint" class="note" style="margin-bottom:8px">
      Pick a certification to view its required trainings.
    </div>

    <div class="timeline-wrap">
      <div id="timeline" class="timeline"></div>
    </div>
  </section>

</div>

<!-- Supabase + auth helpers -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
const $ = s => document.querySelector(s);

let sb = null;
let me = null;

function clampPct(x){
  const v = Number(x)||0;
  return Math.max(0,Math.min(1,v));
}

/* Storage helper */
async function fetchRankImage(code){
  if(!code) return '';
  try{
    return sb.storage.from('Ranks').getPublicUrl(`${code}.png`).data.publicUrl || '';
  }catch{ return ''; }
}

/* Set width helper */
function setFill(sel,pct){
  const el = $(sel);
  if(!el) return;
  const v = clampPct(pct);
  el.style.width = (v*100)+'%';
}

/* MAIN LOADERS */
document.addEventListener('DOMContentLoaded', async () => {
  const session = await requireAuth();
  if(!session) return;
  sb = getSupabase();
  me = session.user.id;

  await Promise.all([
    loadProgression(),
    loadCertGrid()
  ]);
});

/* Rank & requirements */
async function loadProgression(){
  const { data: prog } = await sb
    .from('v_user_rank_progress')
    .select('*')
    .eq('user_id',me)
    .maybeSingle();

  // Names + PG pills
  $('#curRankName').textContent = prog?.current_name || '(Unranked)';
  $('#curPg').textContent       = `PG: ${prog?.current_paygrade || '‚Äî'}`;
  $('#nextRankName').textContent= prog?.next_name || '‚Äî';
  $('#nextPg').textContent      = `PG: ${prog?.next_paygrade || '‚Äî'}`;

  // Cinematic column labels
  $('#rtCurName').textContent   = prog?.current_name || '(Unranked)';
  $('#rtNextName').textContent  = prog?.next_name || '‚Äî';

  // Icons
  const curImg = await fetchRankImage(prog?.current_code);
  const nxtImg = await fetchRankImage(prog?.next_code);
  if(curImg) $('#curImg').src = curImg;
  if(nxtImg) $('#nextImg').src = nxtImg;

  // User totals
  const { data: up } = await sb
    .from('v_user_progress')
    .select('*')
    .eq('user_id',me)
    .maybeSingle();

  const m  = Number(up?.missions_attended||0);
  const h  = Number(up?.hours_total||0);
  const c  = Number(up?.certifications_total||0);
  const mt = Number(prog?.missions_target||0);
  const ht = Number(prog?.hours_target||0);
  const ct = Number(prog?.certification_target||0);

  $('#valMissions').textContent = `${m} / ${mt}`;
  $('#valHours').textContent    = `${h} / ${ht}`;
  $('#valCerts').textContent    = `${c} / ${ct}`;

  setFill('#pbMissions', mt ? m/mt : 1);
  setFill('#pbHours',    ht ? h/ht : 1);
  setFill('#pbCerts',    ct ? c/ct : 1);

  // Overall progression bar: average of available metrics
  const fracs = [];
  if(mt) fracs.push(clampPct(m/mt));
  if(ht) fracs.push(clampPct(h/ht));
  if(ct) fracs.push(clampPct(c/ct));
  const overall = fracs.length ? (fracs.reduce((s,x)=>s+x,0)/fracs.length) : 0;
  setFill('#rtFill', overall);
  $('#rtCaption').textContent = prog?.next_name
    ? `Overall progress towards ${prog.next_name}`
    : 'Overall progression';

  // Promotion availability
  const allMet =
    (mt?m>=mt:true) &&
    (ht?h>=ht:true) &&
    (ct?c>=ct:true) &&
    !!prog?.next_code;

  const btn = $('#btnPromote');
  const note = $('#promoteNote');

  btn.disabled = !allMet;

  if(!prog?.next_code){
    note.textContent = 'You are at the highest configured rank, or the next rank is not set.';
  }else if(allMet){
    note.textContent = 'All requirements met ‚Äî you can request promotion.';
  }else{
    note.textContent = 'Promotion is available when all targets are met.';
  }

  // TODO: wire /rpc for promotion if you want later
}

/* Certifications grid + select */
async function loadCertGrid(){
  const [{ data: cat }, { data: mine }] = await Promise.all([
    sb.from('certifications')
      .select('certification_code,name,image_url,sort_order')
      .order('sort_order',{ascending:true}),
    sb.from('user_certifications')
      .select('certification_code')
      .eq('user_id',me)
  ]);

  const owned = new Set((mine||[]).map(x=>x.certification_code));
  const grid = $('#certGrid');
  const sel  = $('#certSelect');

  grid.innerHTML = (cat||[]).map(c=>{
    const has  = owned.has(c.certification_code);
    const dim  = has ? '' : ' dim';
    const img  = c.image_url ? `<img src="${c.image_url}" alt="">` : 'üèÖ';
    return `<div class="cert${dim}">
      <div class="thumb">${img}</div>
      <div class="title">${c.name}</div>
      <div class="code">${c.certification_code}</div>
    </div>`;
  }).join('') || '<div class="note">No certifications configured.</div>';

  sel.innerHTML = '<option value="">‚Äî Select a Certification ‚Äî</option>' +
    (cat||[]).map(c =>
      `<option value="${c.certification_code}">${c.certification_code} ‚Äî ${c.name}</option>`
    ).join('');

  // timeline wiring
  $('#btnReloadTL').onclick = () => loadTimeline(sel.value);
  sel.onchange              = () => loadTimeline(sel.value);
}

/* Certification timeline */
async function loadTimeline(code){
  const tl = $('#timeline');
  if(!code){
    tl.innerHTML = '';
    $('#tlHint').textContent = 'Pick a certification to view its required trainings.';
    return;
  }
  $('#tlHint').textContent = `Training requirements for ${code}.`;

  const [{ data: reqs }, { data: done }] = await Promise.all([
    sb.from('certification_requirements')
      .select('event_code,sort_order,training_events(title,description)')
      .eq('certification_code',code)
      .order('sort_order',{ascending:true}),
    sb.from('user_training_events')
      .select('event_code,completed_at,approved_by')
      .eq('user_id',me)
  ]);

  const mapDone = new Map((done||[]).map(r=>[r.event_code,r]));
  tl.innerHTML = (reqs||[]).map(r=>{
    const rec = mapDone.get(r.event_code);
    const ok  = !!rec;
    const title = r.training_events?.title || r.event_code;
    const desc  = r.training_events?.description || '';
    return `<div class="titem${ok?' done':''}">
      <div class="tdot"></div>
      <div>
        <div class="t-main">${title}</div>
        <div class="t-sub">${desc}</div>
      </div>
      <div class="t-status">${ok ? 'Completed' : 'Pending'}</div>
    </div>`;
  }).join('') || '<div class="t-sub">No training requirements configured.</div>';
}
</script>
</body>
</html>