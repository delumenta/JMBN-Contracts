<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JMBN ‚Äì Progression</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png"
      href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png"
      sizes="32x32">

<style>
:root{
  --bg:#000;
  --panel:#0b0b0b;
  --card:#111;
  --border:#d6b44c;
  --accent:#f2d675;
  --accent-soft:#c9b06a;
  --text:#f7f1d0;
  --muted:#bfa96a;
  --bad:#ff6b6b;
  --ok:#5cd47c;
  --fs:14px;
}

/* Reset */
*{box-sizing:border-box;margin:0;padding:0}

/* Body */
body{
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.10), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.06), transparent 60%),
    #000;
  color:var(--text);
  font-family:'Play',system-ui,sans-serif;
  font-size:var(--fs);
  letter-spacing:.25px;
  padding:14px;
}

/* Fallback brand (if header.html fails) */
.brand{
  display:flex;
  align-items:center;
  gap:10px;
  margin:0 0 8px;
  padding-bottom:6px;
  border-bottom:1px solid var(--border);
}
.brand-logo{
  width:44px;height:44px;object-fit:contain;
  border:none;background:transparent;box-shadow:none;
}
.brand h1{
  margin:0;
  font-size:clamp(18px,2.1vw,22px);
  color:var(--accent);
}

/* Panels & layout */
.panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
  margin-top:10px;
  box-shadow:0 0 22px rgba(214,180,76,.24);
}
.section{
  background:var(--card);
  border-radius:12px;
  border:1px solid rgba(214,180,76,.45);
  padding:12px;
}
.section + .section{margin-top:10px}

.h{
  margin-bottom:8px;
  font-size:15px;
  color:var(--accent);
}
.small{
  font-size:12px;
  color:var(--muted);
}

/* Grid layout for main content */
.grid{
  display:grid;
  grid-template-columns: minmax(0,1.4fr) minmax(0,1fr);
  gap:12px;
}
@media(max-width:960px){
  .grid{grid-template-columns:1fr}
}

/* Rank strip ‚Äì single, centered bar with logo + name stacked */
.rankStrip{
  position:relative;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:14px;
  padding:12px 12px;
  border-radius:14px;
  background:
    radial-gradient(circle at top left,rgba(242,214,117,.18),rgba(0,0,0,1) 55%),
    radial-gradient(circle at bottom right,rgba(214,180,76,.14),rgba(0,0,0,1) 70%);
  border:1px solid rgba(214,180,76,.7);
  overflow:hidden;
}
.rankStrip::before{
  content:"";
  position:absolute;
  inset:-40%;
  background:
    radial-gradient(circle at 0% 0%,rgba(242,214,117,.28),transparent 60%);
  opacity:.34;
  pointer-events:none;
}
.rankStrip > *{position:relative;z-index:1}

/* Left: current rank block (logo + name under logo) */
.currentBlock{
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
  min-width:120px;
}
.rankLogoWrap{
  width:72px;height:72px;
  padding:6px;
  border-radius:50%;
  border:1px solid rgba(214,180,76,.8);
  display:grid;
  place-items:center;
  background:
    radial-gradient(circle at 50% 0%,rgba(242,214,117,.35),rgba(0,0,0,1));
  box-shadow:0 0 14px rgba(242,214,117,.65);
}
.rankLogoWrap img{
  width:100%;
  height:100%;
  object-fit:contain;
  border:none;
  background:transparent;
}
.currentName{
  font-size:13px;
  text-align:center;
  text-transform:uppercase;
  letter-spacing:.16em;
}
.paygradeTag{
  margin-top:2px;
  font-size:11px;
  padding:3px 10px;
  border-radius:999px;
  border:1px solid rgba(214,180,76,.75);
  background:#050505;
}

/* Middle: animated progress bar between ranks */
.rankPipe{
  flex:1;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.pipeLabelRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  font-size:11px;color:var(--muted);
}
.pipeLabelRow span strong{color:var(--accent-soft)}
.pipeTrack{
  position:relative;
  height:16px;
  border-radius:999px;
  border:1px solid rgba(214,180,76,.7);
  background:
    linear-gradient(90deg,#050505,#151515);
  overflow:hidden;
}
.pipeFill{
  position:absolute;
  inset:0;
  width:0%;
  border-radius:999px;
  background:
    linear-gradient(90deg,rgba(242,214,117,.2),rgba(242,214,117,.8),rgba(242,214,117,.2));
  box-shadow:0 0 18px rgba(242,214,117,.9);
  transform-origin:left center;
  transition:width .6s ease-out;
}
.pipeFill::after{
  content:"";
  position:absolute;
  inset:0;
  background:
    linear-gradient(120deg,transparent 0%,rgba(255,255,255,.85) 40%,transparent 80%);
  mix-blend-mode:screen;
  opacity:.45;
  animation:shine 2.8s linear infinite;
}
@keyframes shine{
  from{transform:translateX(-120%)}
  to{transform:translateX(120%)}
}

/* Right: next rank mini-block */
.nextBlock{
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:flex-end;
  gap:4px;
  min-width:110px;
}
.nextTitle{
  font-size:11px;
  color:var(--muted);
  text-transform:uppercase;
  letter-spacing:.16em;
}
.nextName{
  font-size:13px;
  color:var(--accent);
}
.nextPaygrade{
  font-size:11px;
  padding:3px 8px;
  border-radius:999px;
  border:1px solid rgba(214,180,76,.7);
}

/* Requirements ‚Äì compact 3-row layout */
.reqGrid{
  display:flex;
  flex-direction:column;
  gap:6px;
  margin-top:4px;
}
.reqRow{
  display:grid;
  grid-template-columns:94px minmax(0,1fr) auto;
  gap:8px;
  align-items:center;
}
.reqLabel{
  font-size:12px;
  color:var(--muted);
}
.reqBar{
  height:10px;
  border-radius:999px;
  border:1px solid rgba(214,180,76,.6);
  background:#050505;
  overflow:hidden;
}
.reqFill{
  height:100%;
  width:0%;
  border-radius:999px;
  background:linear-gradient(90deg,var(--accent),#e5c55a);
  transition:width .45s ease-out;
}
.reqVal{
  font-size:11px;
  color:var(--muted);
  font-variant-numeric:tabular-nums;
}

/* Promote panel */
.promoteRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-top:6px;
}
.promoteBtn{
  padding:8px 14px;
  border-radius:999px;
  border:1px solid rgba(214,180,76,.8);
  background:linear-gradient(180deg,#101010,#050505);
  color:var(--accent);
  font-size:12px;
  cursor:pointer;
}
.promoteBtn:hover:enabled{
  background:linear-gradient(180deg,#f2d675,#e5c55a);
  color:#000;
}
.promoteBtn:disabled{
  opacity:.45;
  cursor:not-allowed;
}

/* Certifications grid */
.certGrid{
  display:grid;
  grid-template-columns:repeat(6,minmax(0,1fr));
  gap:10px;
  margin-top:8px;
  justify-items:center;
}
@media(max-width:1100px){.certGrid{grid-template-columns:repeat(5,1fr)}}
@media(max-width:900px){.certGrid{grid-template-columns:repeat(4,1fr)}}
@media(max-width:700px){.certGrid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:520px){.certGrid{grid-template-columns:repeat(2,1fr)}}

.cert{
  text-align:center;
  padding:8px 4px 10px;
  border-radius:10px;
  transition:transform .14s ease,opacity .14s ease,filter .14s ease;
}
.cert:hover{transform:translateY(-2px)}
.cert.dim{opacity:.45;filter:grayscale(.6)}
.certThumb{
  width:64px;height:64px;
  margin:0 auto 4px;
  display:grid;
  place-items:center;
}
.certThumb img{
  max-width:56px;
  max-height:56px;
  object-fit:contain;
}
.certName{
  font-size:12px;
  font-weight:700;
}
.certCode{
  font-size:10px;
  color:var(--muted);
}

/* Timeline ‚Äì cleaner, less clustered */
.timelineWrap{
  margin-top:10px;
}
.timeline{
  position:relative;
  margin-top:8px;
  padding-left:20px;
}
.timeline::before{
  content:"";
  position:absolute;
  left:4px; top:0; bottom:0;
  width:2px;
  background:linear-gradient(to bottom,rgba(214,180,76,.9),rgba(214,180,76,.15));
  box-shadow:0 0 10px rgba(214,180,76,.7);
}
.titem{
  position:relative;
  padding:10px 6px 10px 12px;
  border-bottom:1px solid rgba(255,255,255,.05);
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:12px;
}
.titem:last-child{border-bottom:none}
.titem::before{
  content:"";
  position:absolute;
  left:-9px;
  top:14px;
  width:8px;height:8px;
  border-radius:50%;
  border:1px solid rgba(214,180,76,.9);
  background:#050505;
}
.titem.done::before{
  background:var(--ok);
  box-shadow:0 0 8px rgba(92,212,124,.8);
}
.tlabel{
  font-size:13px;
  font-weight:700;
}
.tstatus{
  font-size:11px;
  color:var(--muted);
  white-space:nowrap;
}
.tstatus.done{
  color:var(--ok);
}
.tstatus.pending{
  color:var(--muted);
}
.tstatus.bad{
  color:var(--bad);
}
@media(max-width:640px){
  .titem{
    flex-direction:column;
    align-items:flex-start;
  }
  .tstatus{white-space:normal}
}

/* Controls */
select,button{
  font-family:'Play',system-ui,sans-serif;
}
select{
  background:#0a0a0a;
  border-radius:8px;
  border:1px solid var(--border);
  padding:7px 8px;
  color:var(--text);
  font-size:12px;
}
button{
  border:none;
}

/* Footer text */
.footer-note{
  margin-top:8px;
  font-size:11px;
  color:var(--muted);
}
</style>
</head>
<body>

<!-- Header mount point (replaced by header.html if available) -->
<div id="header-container">
  <div class="brand">
    <img class="brand-logo"
         src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png"
         alt="JMBN">
    <h1>JMBN ‚Äì Progression</h1>
  </div>
</div>

<script>
/* Inject shared header and mark nav active */
(async () => {
  try{
    const res = await fetch('header.html',{cache:'no-cache'});
    if(!res.ok) return;
    const html = await res.text();
    const mount = document.getElementById('header-container');
    if(mount) mount.outerHTML = html;

    requestAnimationFrame(() => {
      const here = (location.pathname.split('/').pop() || 'progression.html').toLowerCase();
      document.querySelectorAll('.nav-btn').forEach(a=>{
        const href = (a.getAttribute('href')||'').toLowerCase();
        if(href === here) a.classList.add('active');
        if(/progress/.test(here) && /progress/.test(href)) a.classList.add('active');
      });
    });
  }catch(e){
    console.warn('Header load failed', e);
  }
})();
</script>

<div class="panel">
  <div class="grid">
    <!-- LEFT: Rank strip + requirements -->
    <div>
      <div class="section">
        <div class="h">Rank Progression</div>
        <div class="rankStrip">
          <!-- Current rank block -->
          <div class="currentBlock">
            <div class="rankLogoWrap">
              <img id="curImg" alt="Current Rank">
            </div>
            <div class="currentName" id="curName">UNRATED</div>
            <div class="paygradeTag" id="curPg">PG: ‚Äî</div>
          </div>

          <!-- Progress pipe -->
          <div class="rankPipe">
            <div class="pipeLabelRow">
              <span>From <strong id="pipeFrom">‚Äî</strong></span>
              <span>To <strong id="pipeTo">‚Äî</strong></span>
            </div>
            <div class="pipeTrack">
              <div class="pipeFill" id="pipeFill"></div>
            </div>
          </div>

          <!-- Next rank block -->
          <div class="nextBlock">
            <div class="nextTitle">Next Rank</div>
            <div class="nextName" id="nextName">‚Äî</div>
            <div class="nextPaygrade" id="nextPg">PG: ‚Äî</div>
          </div>
        </div>
      </div>

      <div class="section" style="margin-top:10px">
        <div class="h">Requirements</div>
        <div class="reqGrid">
          <div class="reqRow">
            <div class="reqLabel">Missions</div>
            <div class="reqBar"><div id="reqMissions" class="reqFill"></div></div>
            <div class="reqVal" id="reqMissionsVal">0 / 0</div>
          </div>
          <div class="reqRow">
            <div class="reqLabel">Hours</div>
            <div class="reqBar"><div id="reqHours" class="reqFill"></div></div>
            <div class="reqVal" id="reqHoursVal">0 / 0</div>
          </div>
          <div class="reqRow">
            <div class="reqLabel">Certifications</div>
            <div class="reqBar"><div id="reqCerts" class="reqFill"></div></div>
            <div class="reqVal" id="reqCertsVal">0 / 0</div>
          </div>
        </div>

        <div class="promoteRow">
          <div id="reqNote" class="small">
            Promotion is available when all targets are met.
          </div>
          <button id="btnPromote" class="promoteBtn" disabled>
            Request Promotion
          </button>
        </div>
      </div>
    </div>

    <!-- RIGHT: Certifications & timeline selector -->
    <div>
      <div class="section">
        <div class="h">Certifications</div>
        <div id="certGrid" class="certGrid">
          <div class="small">Loading certifications‚Ä¶</div>
        </div>
        <div class="small" style="margin-top:6px">
          Dim badges are not yet earned.
        </div>
      </div>

      <div class="section" style="margin-top:10px">
        <div class="h">Certification Timeline</div>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <select id="certSelect">
            <option value="">‚Äî Select a Certification ‚Äî</option>
          </select>
          <button id="btnReloadTL" class="promoteBtn" style="padding:6px 10px;border-radius:8px">
            Load
          </button>
        </div>
        <div id="tlHint" class="small" style="margin-top:8px">
          Pick a certification to view its required trainings.
        </div>
        <div class="timelineWrap">
          <div id="timeline" class="timeline"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer-note">
    Mission and hour counts are based on completed missions (Success / Fail / Abort) and recorded durations.
  </div>
</div>

<!-- Supabase + auth -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
const $ = s => document.querySelector(s);
let sb, me;

/* Helpers */
function clamp01(x){
  x = Number(x)||0;
  if(x<0) return 0;
  if(x>1) return 1;
  return x;
}
function setFill(sel,ratio){
  const el = $(sel);
  if(!el) return;
  el.style.width = (clamp01(ratio)*100) + '%';
}
async function fetchRankImage(code){
  if(!code) return '';
  try{
    const { data } = sb.storage.from('Ranks').getPublicUrl(`${code}.png`);
    return data.publicUrl || '';
  }catch(e){
    console.warn('rank image',e);
    return '';
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  const session = await requireAuth();
  if(!session) return;
  sb = getSupabase();
  me = session.user.id;

  async function loadProgress(){
    const { data: prog } = await sb
      .from('v_user_rank_progress')
      .select('*')
      .eq('user_id',me)
      .maybeSingle();

    const { data: up } = await sb
      .from('v_user_progress')
      .select('*')
      .eq('user_id',me)
      .maybeSingle();

    // Current / next rank text
    const curName = prog?.current_name || 'Unranked';
    const curCode = prog?.current_code || '‚Äî';
    const curPg   = prog?.current_paygrade || '‚Äî';
    const nextName = prog?.next_name || '‚Äî';
    const nextPg   = prog?.next_paygrade || '‚Äî';

    $('#curName').textContent = curName.toUpperCase();
    $('#curPg').textContent   = `PG: ${curPg}`;
    $('#pipeFrom').textContent = curCode || '‚Äî';
    $('#pipeTo').textContent   = prog?.next_code || '‚Äî';
    $('#nextName').textContent = nextName;
    $('#nextPg').textContent   = `PG: ${nextPg}`;

    // Images
    const [curImg, nxtImg] = await Promise.all([
      fetchRankImage(prog?.current_code),
      fetchRankImage(prog?.next_code)
    ]);
    if(curImg) $('#curImg').src = curImg;
    if(nxtImg) $('#nextImg').src = nxtImg || '';

    // Requirements data
    const m  = Number(up?.missions_attended || 0);
    const h  = Number(up?.hours_total || 0);
    const c  = Number(up?.certifications_total || 0);
    const mt = Number(prog?.missions_target || 0);
    const ht = Number(prog?.hours_target || 0);
    const ct = Number(prog?.certification_target || 0);

    $('#reqMissionsVal').textContent = `${m} / ${mt}`;
    $('#reqHoursVal').textContent    = `${h} / ${ht}`;
    $('#reqCertsVal').textContent    = `${c} / ${ct}`;

    setFill('#reqMissions', mt ? m/mt : 1);
    setFill('#reqHours',    ht ? h/ht : 1);
    setFill('#reqCerts',    ct ? c/ct : 1);

    // Combined progress for pipe (rough average)
    const parts = [];
    if(mt) parts.push(m/mt);
    if(ht) parts.push(h/ht);
    if(ct) parts.push(c/ct);
    const avg = parts.length ? parts.reduce((a,b)=>a+b,0)/parts.length : 1;
    setFill('#pipeFill', avg);

    const allMet =
      (!!prog?.next_code) &&
      (mt ? m>=mt : true) &&
      (ht ? h>=ht : true) &&
      (ct ? c>=ct : true);

    const noteEl = $('#reqNote');
    const btn    = $('#btnPromote');

    if(!prog?.next_code){
      noteEl.textContent = 'You are at the highest configured rank, or next rank is not set.';
      btn.disabled = true;
    }else if(allMet){
      noteEl.textContent = 'All requirements met. You may request promotion.';
      btn.disabled = false;
    }else{
      noteEl.textContent = 'Promotion is available when all targets are met.';
      btn.disabled = true;
    }

    // (Optional) you can wire btn click to open Discord / form later
    btn.onclick = () => {
      if(btn.disabled) return;
      alert('Promotion request flow not implemented yet. (Hook to Discord / form here.)');
    };
  }

  async function loadCerts(){
    const [catRes, mineRes] = await Promise.all([
      sb.from('certifications')
        .select('certification_code,name,image_url,sort_order')
        .order('sort_order',{ascending:true}),
      sb.from('user_certifications')
        .select('certification_code')
        .eq('user_id',me)
    ]);

    const cat  = catRes.data  || [];
    const mine = mineRes.data || [];
    const owned = new Set(mine.map(x=>x.certification_code));

    const grid = $('#certGrid');
    if(!cat.length){
      grid.innerHTML = '<div class="small">No certifications configured yet.</div>';
    }else{
      grid.innerHTML = cat.map(c=>{
        const isOwned = owned.has(c.certification_code);
        return `
          <div class="cert${isOwned?'':' dim'}">
            <div class="certThumb">
              ${c.image_url ? `<img src="${c.image_url}" alt="">` : 'üèÖ'}
            </div>
            <div class="certName">${c.name}</div>
            <div class="certCode">${c.certification_code}</div>
          </div>`;
      }).join('');
    }

    // Populate select
    const sel = $('#certSelect');
    sel.innerHTML =
      '<option value="">‚Äî Select a Certification ‚Äî</option>' +
      cat.map(c =>
        `<option value="${c.certification_code}">
           ${c.certification_code} ‚Äî ${c.name}
         </option>`
      ).join('');
  }

  /* Timeline with completion dates */
  async function loadTimeline(code){
    const tl = $('#timeline');
    const hint = $('#tlHint');
    tl.innerHTML = '';
    if(!code){
      hint.textContent = 'Pick a certification to view its required trainings.';
      return;
    }
    hint.textContent = 'Training events required for this certification:';

    const [reqRes, doneRes] = await Promise.all([
      sb.from('certification_requirements')
        .select('event_code,sort_order,training_events(title,description)')
        .eq('certification_code',code)
        .order('sort_order',{ascending:true}),
      sb.from('user_training_events')
        .select('event_code,completed_at,approved_by')
        .eq('user_id',me)
    ]);

    const reqs = reqRes.data  || [];
    const done = doneRes.data || [];
    const doneMap = new Map(done.map(r => [r.event_code, r]));

    if(!reqs.length){
      tl.innerHTML = '<div class="small">No requirement events configured for this certification yet.</div>';
      return;
    }

    tl.innerHTML = reqs.map(r=>{
      const rec = doneMap.get(r.event_code);
      let statusClass = 'pending';
      let statusText  = 'Pending';

      if(rec){
        if(rec.completed_at){
          const d = new Date(rec.completed_at);
          const dateStr = d.toLocaleDateString('en-SG',{
            day:'numeric',
            month:'short',
            year:'numeric'
          });
          statusClass = 'done';
          statusText  = `Completed on ${dateStr}`;
        }else{
          statusClass = 'done';
          statusText  = 'Completed';
        }
      }

      const title = r.training_events?.title || r.event_code;
      return `
        <div class="titem ${statusClass}">
          <div class="tlabel">${title}</div>
          <div class="tstatus ${statusClass}">${statusText}</div>
        </div>`;
    }).join('');
  }

  // Wire events
  $('#btnReloadTL').onclick = () => {
    loadTimeline($('#certSelect').value);
  };
  $('#certSelect').onchange = () => {
    loadTimeline($('#certSelect').value);
  };

  // Initial loads
  await loadProgress();
  await loadCerts();
});
</script>
</body>
</html>