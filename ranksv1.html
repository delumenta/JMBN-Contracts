<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Mission Log — mobiGlas Board</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--panel2:#0c0c0c;--glass:#0f0f0f;
  --border:#d6b44c;--accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;
  --fs-base:14px;--fs-small:11px;--fs-table:13px;--fs-h1:clamp(18px,2.2vw,22px);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--text);font-family:'Play',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
}

/* Header mount (shared) */
#header-container{margin:12px 12px 0}

/* App grid */
.app{
  display:grid;grid-template-columns:220px 1fr 360px;gap:12px;
  padding:12px;align-items:start;
}
@media(max-width:1240px){.app{grid-template-columns:240px 1fr}}
@media(max-width:1060px){.app{grid-template-columns:1fr}}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 0 10px rgba(214,180,76,.15)}
.panel-inner{padding:12px}

/* Left Dock (mobiGlas) */
.dock{
  position:sticky;top:12px;align-self:start;backdrop-filter:saturate(1.2) blur(4px);
  background:linear-gradient(180deg,#0b0b0b,#080808);
}
.dock h2{margin:0 0 10px;color:var(--accent);font-size:14px;letter-spacing:.6px}
.dock .dock-row{display:flex;flex-direction:column;gap:8px}
.dock .dock-btn{
  display:flex;align-items:center;gap:10px;
  padding:10px 12px;border:1px solid rgba(214,180,76,.35);border-radius:12px;
  background:linear-gradient(180deg,#0c0c0c,#060606);color:var(--accent);
  cursor:pointer;transition:.2s
}
.dock .dock-btn:hover{box-shadow:0 0 16px rgba(214,180,76,.25)}
.dock small{color:var(--muted);font-size:var(--fs-small)}
.dock .ongoing-list{margin-top:8px;display:flex;flex-direction:column;gap:6px}
.dock .ongoing-item{
  border:1px solid rgba(214,180,76,.35);border-radius:10px;background:#0c0c0c;padding:8px
}
.dock .ongoing-title{color:var(--accent);font-weight:700}
.dock .ongoing-meta{font-size:12px;color:var(--muted)}

/* Center – Controls + KPIs + Card Feed */
.controls{
  display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px
}
input,select{
  background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:9px;color:var(--text);font-size:var(--fs-table);font-family:'Play'
}
button,.small-btn{
  padding:8px 12px;border-radius:10px;background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);border:1px solid var(--border);cursor:pointer;font-family:'Play';transition:.2s
}
button:hover,.small-btn:hover{background:var(--accent);color:#000}

.kpis{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin:8px 0}
@media(max-width:880px){.kpis{grid-template-columns:1fr}}
.kpi{
  background:linear-gradient(180deg,#0b0b0b,#080808);border:1px solid var(--border);border-radius:12px;padding:12px;
  box-shadow:0 0 8px rgba(214,180,76,.12), inset 0 0 0 1px rgba(214,180,76,.08)
}
.kpi-title{font-size:12px;color:var(--muted);margin-bottom:6px}
.kpi-value{font-size:22px;font-weight:700;color:var(--accent);line-height:1}
.kpi-sub{font-size:12px;color:var(--muted);margin-top:4px}

.feed{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
@media(max-width:1240px){.feed{grid-template-columns:1fr}}
.card{
  display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;
  border:1px solid rgba(214,180,76,.35);border-radius:12px;background:#0c0c0c;padding:12px;
  transition:.2s;cursor:pointer
}
.card:hover{box-shadow:0 0 16px rgba(214,180,76,.25)}
.card h3{margin:0;color:var(--accent);font-size:16px}
.card .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px;color:var(--muted)}
.pill.res{color:#f2d675;border-color:#f2d675}
.pill.op{color:#7bd88f;border-color:#7bd88f}
.meta{font-size:12px;color:var(--muted)}
.mono{font-variant-numeric:tabular-nums}

/* Right – Inspector */
.inspector{
  position:sticky;top:12px;align-self:start;background:linear-gradient(180deg,#0b0b0b,#080808);
}
.inspector .empty{color:var(--muted);font-size:13px}
.hr{height:1px;background:linear-gradient(90deg,transparent,rgba(214,180,76,.4),transparent);margin:10px 0}

/* Attendance Modal (reuse) */
.modal-mask{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
.modal{background:#0b0b0b;border:1px solid var(--border);border-radius:12px;max-width:760px;width:92vw;padding:14px;box-shadow:0 0 22px rgba(214,180,76,.25)}
.modal h3{margin:0 0 10px;color:var(--accent);font-size:16px}
.modal .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
.modal .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:6px 10px}
.modal .chip .x{cursor:pointer;border:1px solid var(--border);border-radius:6px;background:transparent;color:var(--muted);padding:0 6px}
.modal .chip .x:hover{background:#111;color:#ff6b6b}
.modal .chip select{background:#0a0a0a;border:1px solid var(--border);border-radius:8px;padding:4px 8px;color:var(--text);font-family:'Play';font-size:12px}
.modal .list{display:flex;gap:8px;flex-wrap:wrap}
.chip[data-attendance="not_going"]{border-color:rgba(255,107,107,.6);color:#ff6b6b}

/* Utility */
.small{font-size:var(--fs-small);color:var(--muted)}
.nowrap{white-space:nowrap}
.hidden{display:none}
</style>
</head>
<body>
  <!-- Shared header -->
  <div id="header-container"></div>
  <script>
    (async () => {
      try{
        const res = await fetch('header.html',{cache:'no-cache'});
        const html = await res.text();
        document.getElementById('header-container').outerHTML = html;
        requestAnimationFrame(()=>{
          const here = (location.pathname.split('/').pop()||'mission-log.html').toLowerCase();
          document.querySelectorAll('.nav-btn').forEach(a=>{
            const href=(a.getAttribute('href')||'').toLowerCase();
            if(href===here){a.classList.add('active');a.setAttribute('aria-current','page');}
          });
        });
      }catch(e){console.warn('Header load failed:',e);}
    })();
  </script>

  <!-- App -->
  <div class="app">
    <!-- Left Dock -->
    <aside class="panel dock">
      <div class="panel-inner">
        <h2>mobiGlas</h2>
        <div class="dock-row">
          <button class="dock-btn" id="btnReset">
            <span>Reset Filters</span><small>Show all missions</small>
          </button>
          <button class="dock-btn" id="btnExport">
            <span>Export CSV</span><small>Filtered rows</small>
          </button>
        </div>

        <div class="hr"></div>
        <h2>Ongoing</h2>
        <div id="ongoingList" class="ongoing-list"></div>
        <div class="small" id="ongoingCount" style="margin-top:4px">(0)</div>
      </div>
    </aside>

    <!-- Center: Controls + KPIs + Feed -->
    <main class="panel">
      <div class="panel-inner">
        <!-- Controls -->
        <div class="controls">
          <input id="search" placeholder="Search contracts (title, type, status, tags, route)">
          <select id="catFilter">
            <option value="">All Categories</option>
            <option value="Resource">Resource</option>
            <option value="Operations">Operations</option>
          </select>
          <select id="statusFilter">
            <option value="">All Status</option>
            <option>planned</option>
            <option>active</option>
            <option>success</option>
            <option>fail</option>
            <option>abort</option>
          </select>
        </div>

        <!-- KPIs -->
        <div class="kpis">
          <div class="kpi">
            <div class="kpi-title">Total Missions</div>
            <div class="kpi-value" id="kpiCount">0</div>
            <div class="kpi-sub">after filters</div>
          </div>
          <div class="kpi">
            <div class="kpi-title">Resource : Ops</div>
            <div class="kpi-value" id="kpiMix">0 : 0</div>
            <div class="kpi-sub">derived from type</div>
          </div>
          <div class="kpi">
            <div class="kpi-title">Avg Payout (shown)</div>
            <div class="kpi-value mono" id="kpiAvg">-</div>
            <div class="kpi-sub">aUEC</div>
          </div>
        </div>

        <!-- Feed -->
        <div id="feed" class="feed"></div>
        <div id="feedEmpty" class="small hidden">No missions match your filters.</div>
      </div>
    </main>

    <!-- Right: Inspector -->
    <aside class="panel inspector">
      <div class="panel-inner" id="inspector">
        <h2 class="small" style="margin:0 0 6px;color:var(--accent)">Mission Details</h2>
        <div class="empty">Select a contract from the center feed to view its briefing.</div>
      </div>
    </aside>
  </div>

  <!-- Attendance Modal (reuse) -->
  <div id="attModalMask" class="modal-mask" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <h3 id="attTitle" style="margin-right:auto">Attendance</h3>
        <button class="small-btn" onclick="closeAttendance()">Close</button>
      </div>

      <div class="row">
        <button id="attIamGoing" class="small-btn">I’m going</button>
        <button id="attNotGoing" class="small-btn">Not going</button>
        <button id="attWithdraw" class="small-btn">Withdraw</button>
        <select id="attSelfRole" style="min-width:180px;background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:8px;color:var(--text)"></select>
        <span class="small">Pick <b>your role</b> (optional).</span>
      </div>

      <div id="attElevatedTools" class="row" style="display:none">
        <input id="attAddEmail" placeholder="Add by email (crew@example.com)" style="flex:1;min-width:260px;background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:8px;color:var(--text)">
        <select id="attAddRole" style="background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:8px;color:var(--text)">
          <option value="">Role (optional)</option>
        </select>
        <button id="attAddBtn" class="small-btn">Add</button>
        <span class="small">Admin/Owner can add/remove attendees.</span>
      </div>

      <div class="row">
        <strong class="small">Attendees:</strong>
        <div id="attList" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Supabase + Auth -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/auth.js"></script>

<script>
/* ===== Helpers ===== */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const esc=s=>{const d=document.createElement('div'); d.textContent=s??''; return d.innerHTML;};
const fmtDate = iso => {
  if(!iso) return '';
  const d = new Date(iso);
  return d.toLocaleString('en-SG', {
    day:'numeric', month:'long', year:'numeric',
    hour:'numeric', minute:'2-digit', hour12:true
  }).replace(/\s?([ap])m/i,'$1m');
};
const fmtNum=n=> (n||n===0) ? Number(n).toLocaleString() : '';

const RESOURCE_TYPES = new Set(['hauling','cargo','salvage','mining','delivery']);
function deriveCategory(type){
  const t=(type||'').toString().trim().toLowerCase();
  return RESOURCE_TYPES.has(t) ? 'Resource' : 'Operations';
}

/* ===== Roles (for Attendance) ===== */
let ROLES=[];
const DEFAULT_ROLES=[
  {label:'operations lead'},{label:'pilot'},{label:'copilot'},{label:'escort'},
  {label:'tactician'},{label:'fps'},{label:'gunner'},{label:'hauler'},
  {label:'miner'},{label:'salvager'},{label:'engineer'},{label:'medic'},
  {label:'recon'},{label:'runner'},{label:'logistics'},{label:'security'}
];
function roleOptionsHtml(placeholder){
  const items=(ROLES.length?ROLES:DEFAULT_ROLES).map(r=>`<option value="${r.label}">${r.label}</option>`).join('');
  return `<option value="">${placeholder}</option>`+items;
}
async function fetchRoles(sb){
  const { data, error } = await sb.from('mission_roles').select('label').order('sort_order',{ascending:true}).order('label',{ascending:true});
  ROLES=(error||!data||!data.length)?DEFAULT_ROLES:data;
}

/* ===== State ===== */
let sb=null, session=null;
let allMissions=[];        // raw rows
let filtered=[];           // view after filters
let selectedId=null;       // current inspector target

/* ===== UI Wiring ===== */
$('#btnReset').onclick = ()=>{
  $('#search').value=''; $('#catFilter').value=''; $('#statusFilter').value='';
  renderFiltered();
};
$('#btnExport').onclick = exportCSV;
$('#search').addEventListener('input', renderFiltered);
$('#catFilter').addEventListener('input', renderFiltered);
$('#statusFilter').addEventListener('input', renderFiltered);

/* ===== Boot ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  session = await requireAuth();
  if(!session) return;
  sb = getSupabase();
  await fetchRoles(sb);
  await loadMissions();
  await loadOngoing();
});

/* ===== Data Loads ===== */
async function loadMissions(){
  const { data, error } = await sb
    .from('missions')
    .select('id,title,type,status,origin,destination,start_time,hours,payout_auec,tags,attachments,notes,created_at,submitted_by')
    .order('created_at',{ascending:false});

  if(error){
    $('#feed').innerHTML='';
    $('#feedEmpty').classList.remove('hidden');
    $('#feedEmpty').textContent='Failed to load missions: '+(error.message||'');
    return;
  }
  allMissions=data||[];
  renderFiltered();
}

async function loadOngoing(){
  const { data: att, error: e1 } = await sb
    .from('mission_attendees')
    .select('mission_id')
    .eq('user_id', session.user.id)
    .eq('attendance','going');

  const list = $('#ongoingList');
  const count = $('#ongoingCount');

  if(e1){ list.innerHTML = `<div class="small" style="color:var(--bad)">Failed: ${esc(e1.message)}</div>`; count.textContent='(0)'; return; }
  const ids = (att||[]).map(a=>a.mission_id);
  if(!ids.length){ list.innerHTML = `<div class="small">No ongoing missions.</div>`; count.textContent='(0)'; return; }

  const { data: rows, error: e2 } = await sb
    .from('missions')
    .select('id,title,status,start_time,origin,destination')
    .in('id', ids)
    .in('status',['planned','active'])
    .order('start_time',{ascending:true});

  if(e2){ list.innerHTML = `<div class="small" style="color:var(--bad)">Failed: ${esc(e2.message)}</div>`; count.textContent='(0)'; return; }

  count.textContent = `(${rows?.length||0})`;
  list.innerHTML = (rows||[]).map(r=>`
    <div class="ongoing-item">
      <div class="ongoing-title">${esc(r.title||'(untitled)')}</div>
      <div class="ongoing-meta">
        ${esc(r.status||'')} • ${r.start_time?fmtDate(r.start_time):'TBA'}
        ${r.origin||r.destination?` • ${esc(r.origin||'')} → ${esc(r.destination||'')}`:''}
      </div>
      <div style="margin-top:6px">
        <button class="small-btn" onclick="openAttendance('${r.id}','${esc(r.title||'')}')">Attendance</button>
        <button class="small-btn" onclick="inspect('${r.id}')">Open</button>
      </div>
    </div>
  `).join('');
}
window.refreshOngoing = loadOngoing;

/* ===== Filtering + KPIs + Rendering ===== */
function getFiltered(){
  const q = ($('#search').value||'').toLowerCase();
  const cat = $('#catFilter').value||'';
  const st  = ($('#statusFilter').value||'').toLowerCase();
  let arr = allMissions.slice();

  if(cat) arr = arr.filter(m => deriveCategory(m.type)===cat);
  if(st)  arr = arr.filter(m => (m.status||'').toLowerCase()===st);
  if(q){
    arr = arr.filter(m => (
      `${m.title||''} ${m.type||''} ${m.status||''} ${m.tags||''} ${m.origin||''} ${m.destination||''}`
    ).toLowerCase().includes(q));
  }
  return arr;
}
function renderFiltered(){
  filtered = getFiltered();
  // KPIs
  $('#kpiCount').textContent = filtered.length.toLocaleString();
  const rCount = filtered.filter(x=>deriveCategory(x.type)==='Resource').length;
  const oCount = filtered.length - rCount;
  $('#kpiMix').textContent = `${rCount} : ${oCount}`;
  const payouts = filtered.map(m=>+m.payout_auec||0).filter(n=>n>0);
  const avg = payouts.length ? Math.round(payouts.reduce((a,b)=>a+b,0)/payouts.length) : 0;
  $('#kpiAvg').textContent = avg ? avg.toLocaleString() : '-';

  renderFeed(filtered);
  if(selectedId){
    const found = filtered.find(m=>m.id===selectedId) || allMissions.find(m=>m.id===selectedId);
    renderInspector(found||null);
  }
}
function renderFeed(rows){
  const el = $('#feed');
  const empty = $('#feedEmpty');
  if(!rows.length){ el.innerHTML=''; empty.classList.remove('hidden'); return; }
  empty.classList.add('hidden');

  el.innerHTML = rows.map(m => {
    const cat = deriveCategory(m.type);
    return `
      <article class="card" onclick="inspect('${m.id}')">
        <div>
          <h3>${esc(m.title||'(untitled)')}</h3>
          <div class="row" style="margin:6px 0 4px">
            ${cat?`<span class="pill ${cat==='Resource'?'res':'op'}">${cat}</span>`:''}
            ${m.type?`<span class="pill">${esc(m.type)}</span>`:''}
            ${m.status?`<span class="pill">${esc(m.status)}</span>`:''}
          </div>
          <div class="meta">
            ${m.origin||m.destination?`${esc(m.origin||'')} → ${esc(m.destination||'')} • `:''}
            ${m.start_time?fmtDate(m.start_time):'TBA'}
          </div>
        </div>
        <div class="mono" style="text-align:right">
          <div style="font-size:12px;color:var(--muted)">Payout</div>
          <div style="font-size:18px;color:var(--accent);font-weight:700">${fmtNum(m.payout_auec)}</div>
        </div>
      </article>
    `;
  }).join('');
}

/* ===== Inspector ===== */
function attachmentsHtml(arr){
  if(!Array.isArray(arr)||!arr.length) return '<span class="small">None</span>';
  return arr.map((a,i)=>{
    const name=a?.name?.trim()||`Attachment ${i+1}`;
    const url=a?.url||'#';
    return `<a href="${esc(url)}" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:underline">${esc(name)}</a>`;
  }).join('<br>');
}
function tagsHtml(s){
  if(!s) return '<span class="small">None</span>';
  return esc(s);
}
function renderInspector(m){
  const box = $('#inspector');
  if(!m){
    box.innerHTML = `<h2 class="small" style="margin:0 0 6px;color:var(--accent)">Mission Details</h2>
      <div class="empty">Select a contract from the center feed to view its briefing.</div>`;
    return;
  }
  selectedId = m.id;
  const cat = deriveCategory(m.type);
  box.innerHTML = `
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0;color:var(--accent);font-size:16px">${esc(m.title||'(untitled)')}</h2>
      <div class="row">
        ${cat?`<span class="pill ${cat==='Resource'?'res':'op'}">${cat}</span>`:''}
        ${m.type?`<span class="pill">${esc(m.type)}</span>`:''}
        ${m.status?`<span class="pill">${esc(m.status)}</span>`:''}
      </div>
    </div>
    <div class="hr"></div>
    <div class="small">
      <div><b>Route:</b> ${m.origin||m.destination?`${esc(m.origin||'')} → ${esc(m.destination||'')}`:'—'}</div>
      <div><b>Start:</b> ${m.start_time?fmtDate(m.start_time):'TBA'}</div>
      <div><b>Hours:</b> ${m.hours?esc(m.hours):'—'}</div>
      <div><b>Payout:</b> <span class="mono">${fmtNum(m.payout_auec)}</span> aUEC</div>
      <div style="margin-top:6px"><b>Tags:</b> ${tagsHtml(m.tags)}</div>
    </div>
    <div class="hr"></div>
    <div class="small"><b>Notes</b><br>${esc(m.notes||'—')}</div>
    <div class="hr"></div>
    <div class="small"><b>Attachments</b><br>${attachmentsHtml(m.attachments)}</div>
    <div class="hr"></div>
    <div class="row" style="gap:8px;flex-wrap:wrap">
      <button class="small-btn" onclick="openAttendance('${m.id}','${esc(m.title||'')}')">Attendance</button>
      <button class="small-btn" onclick="scrollToFeed()">Back to Feed</button>
    </div>
  `;
}
function inspect(id){
  const m = (filtered.find(x=>x.id===id) || allMissions.find(x=>x.id===id));
  renderInspector(m||null);
  // On mobile, scroll the inspector into view if stacked
  if(window.matchMedia('(max-width:1060px)').matches){ document.querySelector('.inspector').scrollIntoView({behavior:'smooth',block:'start'}); }
}
window.inspect = inspect;
function scrollToFeed(){ document.querySelector('main.panel').scrollIntoView({behavior:'smooth',block:'start'}); }

/* ===== Export CSV ===== */
function exportCSV(){
  const rows = getFiltered();
  const cols=['title','category','type','status','origin','destination','start_time','hours','payout_auec','tags','notes'];
  const csv=[
    cols.join(','),
    ...rows.map(r=>{
      const rec = {
        title:r.title||'',
        category:deriveCategory(r.type),
        type:r.type||'',
        status:r.status||'',
        origin:r.origin||'',
        destination:r.destination||'',
        start_time:r.start_time||'',
        hours:r.hours||'',
        payout_auec:r.payout_auec||'',
        tags:r.tags||'',
        notes:r.notes||''
      };
      return cols.map(k=>`"${String(rec[k]).replace(/"/g,'""')}"`).join(',');
    })
  ].join('\n');
  const blob = new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download='missions.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ===== Attendance (reused, wired to inspector buttons) ===== */
let ATT_MISSION_ID=null;
async function openAttendance(missionId,title=''){
  ATT_MISSION_ID = missionId;
  $('#attTitle').textContent = `Attendance — ${title || missionId.slice(0,8)}`;
  $('#attModalMask').style.display='flex';

  // Elevation
  const [{ data: elev }, { data: mission }] = await Promise.all([
    sb.rpc('is_elevated', { u: session.user.id }),
    sb.from('missions').select('submitted_by').eq('id', missionId).single()
  ]);
  const isOwner = mission?.submitted_by === session.user.id;
  $('#attElevatedTools').style.display = (elev || isOwner) ? 'flex' : 'none';

  // Role selects
  $('#attSelfRole').innerHTML = roleOptionsHtml('My role (optional)');
  $('#attAddRole').innerHTML  = roleOptionsHtml('Role (optional)');
  try{
    const { data: mine } = await sb
      .from('mission_attendees')
      .select('role_in_mission')
      .match({ mission_id: ATT_MISSION_ID, user_id: session.user.id })
      .limit(1);
    if(Array.isArray(mine)&&mine[0]) $('#attSelfRole').value = mine[0].role_in_mission||'';
  }catch(_){}

  // Buttons
  $('#attIamGoing').onclick = async ()=>{
    const role = ($('#attSelfRole').value||'').trim();
    await sb.from('mission_attendees').upsert({
      mission_id: ATT_MISSION_ID, user_id: session.user.id, attendance:'going', role_in_mission: role||null
    },{ onConflict:'mission_id,user_id' });
    await loadAttendees(); await refreshOngoing();
  };
  $('#attNotGoing').onclick = async ()=>{
    await sb.from('mission_attendees').upsert({
      mission_id: ATT_MISSION_ID, user_id: session.user.id, attendance:'not_going'
    },{ onConflict:'mission_id,user_id' });
    await loadAttendees(); await refreshOngoing();
  };
  $('#attWithdraw').onclick = async ()=>{
    await sb.from('mission_attendees').delete().match({ mission_id: ATT_MISSION_ID, user_id: session.user.id });
    await loadAttendees(); await refreshOngoing();
  };
  $('#attAddBtn').onclick = async ()=>{
    const email = $('#attAddEmail').value.trim();
    const role  = $('#attAddRole').value || null;
    if(!email){ alert('Enter an email'); return; }
    const { error } = await sb.rpc('add_attendee_by_email', {
      p_mission: ATT_MISSION_ID, p_email: email, p_role: role, p_attendance:'going'
    });
    if(error){ alert('Add failed: '+error.message); return; }
    $('#attAddEmail').value=''; $('#attAddRole').value='';
    await loadAttendees(); await refreshOngoing();
  };

  await loadAttendees();
}
function closeAttendance(){ $('#attModalMask').style.display='none'; ATT_MISSION_ID=null; }
window.openAttendance=openAttendance; window.closeAttendance=closeAttendance;

async function loadAttendees(){
  const list = $('#attList');
  list.innerHTML = '<span class="small">Loading…</span>';

  const { data, error } = await sb
    .from('v_mission_attendees_detailed')
    .select('*')
    .eq('mission_id', ATT_MISSION_ID)
    .order('joined_at',{ascending:true});

  if(error){ list.innerHTML = `<span class="small" style="color:var(--bad)">Load failed: ${esc(error.message)}</span>`; return; }
  if(!data?.length){ list.innerHTML = '<span class="small">No attendees yet.</span>'; return; }

  const [{ data: elev }, { data: mission }] = await Promise.all([
    sb.rpc('is_elevated', { u: session.user.id }),
    sb.from('missions').select('submitted_by').eq('id', ATT_MISSION_ID).single()
  ]);
  const canManageAll = (elev || mission?.submitted_by === session.user.id);

  list.innerHTML='';
  for(const a of data){
    const chip = document.createElement('div');
    chip.className='chip';
    chip.setAttribute('data-attendance',(a.attendance||'').toLowerCase());
    const options = ['<option value="">role</option>', ...(ROLES.length?ROLES:DEFAULT_ROLES).map(r=>`<option value="${r.label}">${r.label}</option>`)].join('');
    chip.innerHTML = `
      <span>${esc(a.attendee_name || a.user_id.slice(0,8))}</span>
      <select data-uid="${a.user_id}" ${ (canManageAll || a.user_id===session.user.id) ? '' : 'disabled' }>${options}</select>
      <span class="small" style="color:var(--muted)">${esc(a.attendance||'')}</span>
      ${ (canManageAll || a.user_id===session.user.id) ? `<button class="x" title="Remove" data-uid="${a.user_id}">x</button>` : '' }
    `;
    const sel = chip.querySelector('select'); if(sel) sel.value = a.role_in_mission || '';
    if(sel && (canManageAll || a.user_id===session.user.id)){
      sel.onchange = async (e)=>{
        const newRole = e.target.value || null;
        const targetUser = e.target.getAttribute('data-uid');
        const { error: upErr } = await sb.from('mission_attendees').update({ role_in_mission: newRole })
          .match({ mission_id: ATT_MISSION_ID, user_id: targetUser });
        if(upErr){ alert('Update failed: '+upErr.message); e.target.value=a.role_in_mission||''; return; }
        await loadAttendees();
      };
    }
    const x = chip.querySelector('.x');
    if(x) x.onclick = async ()=>{
      const targetUser = x.getAttribute('data-uid');
      const { error: delErr } = await sb.from('mission_attendees').delete().match({ mission_id: ATT_MISSION_ID, user_id: targetUser });
      if(delErr){ alert('Remove failed: '+delErr.message); return; }
      await loadAttendees(); await refreshOngoing();
    };
    list.appendChild(chip);
  }
}
</script>
</body>
</html>
