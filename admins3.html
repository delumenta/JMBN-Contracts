<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Member Roster</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--border:#d6b44c;--card:#141414;
  --accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;
  --fs-base:14px;--fs-small:11px;--fs-table:13px;--fs-h1:clamp(18px,2.2vw,22px);
}
*{box-sizing:border-box}
body{
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text); font-family:'Play',system-ui,sans-serif;
  margin:0; padding:14px; letter-spacing:.25px; font-size:var(--fs-base);
}

/* Header mount fallback visuals */
.brand{display:flex;align-items:center;gap:10px;margin:0 0 8px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.brand-logo{width:44px;height:44px;object-fit:contain;filter:drop-shadow(0 0 4px rgba(242,214,117,.25))}
.brand h1{font-weight:700;font-size:var(--fs-h1);color:var(--accent);margin:0}

/* Panel & table */
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:8px;box-shadow:0 0 18px rgba(214,180,76,.22)}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;align-items:center}
input[type="search"]{background:#0a0a0a;border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-size:var(--fs-table);min-width:260px}
.badge{border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:var(--accent);font-weight:700}
.tableWrap{border:1px solid var(--border);border-radius:12px;overflow:auto;max-height:70vh}
table{width:100%;border-collapse:collapse;font-size:var(--fs-table)}
th,td{border-bottom:1px solid rgba(214,180,76,.3);padding:10px;text-align:left;vertical-align:middle}
th{color:var(--accent);background:#080808;font-weight:600;position:sticky;top:0;z-index:1}
tr:nth-child(even){background:#111}
tr:hover{background:rgba(214,180,76,.08)}
.name{font-weight:700}

/* Rank cell — image beside rank text, NO frame/background */
.rankCell{display:flex;align-items:center;gap:12px}
.rankCell img{
  width:28px;height:28px;object-fit:contain;flex:0 0 28px;
  border:none;border-radius:0;background:transparent;box-shadow:none;
}

/* Role chips */
.roles{display:flex;flex-wrap:wrap;gap:8px}
.role-chip{
  border:1px solid var(--border);
  border-radius:999px;
  padding:4px 10px;
  font-size:12px;
  background:#0c0c0c;
  color:var(--muted);
}

/* Buttons */
.btn{padding:8px 12px;border-radius:10px;background:linear-gradient(180deg,#0c0c0c,#060606);color:var(--accent);border:1px solid var(--border);cursor:pointer;font-family:'Play'}
.btn:hover{background:var(--accent);color:#000}

/* Modal */
.modal-mask{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:50}
.modal{
  background:#0b0b0b;border:1px solid var(--border);border-radius:16px;
  max-width:760px;width:94vw;padding:20px 18px;box-shadow:0 0 28px rgba(214,180,76,.3)
}
.modal h3{margin:0 0 14px;color:var(--accent);font-size:18px;letter-spacing:.3px}
.modal .header-row{display:flex;align-items:center;gap:12px;margin-bottom:14px}
.modal .header-row .spacer{flex:1}

/* Rank card in modal — NO frame/background on image */
.rankCard{
  display:flex;gap:16px;align-items:center;border:1px solid var(--border);
  border-radius:14px;padding:14px;background:#0f0f0f
}
.rankCard img{
  width:70px;height:70px;object-fit:contain;
  border:none;border-radius:0;background:transparent;box-shadow:none;
}

.meta{font-size:13px;color:var(--muted);line-height:1.55}
.meta b{color:var(--accent)}

.divider{
  height:1px;background:linear-gradient(90deg,rgba(214,180,76,.15),rgba(214,180,76,.4),rgba(214,180,76,.15));
  border:none;margin:16px 0;
}

/* Section blocks inside modal */
.section{
  border:1px solid var(--border);
  border-radius:12px;
  padding:14px;
  background:#0f0f0f;
  margin-bottom:12px;
}
.section h4{
  margin:0 0 10px;
  color:var(--accent);
  font-size:14px;
  letter-spacing:.3px;
}
.section .body{font-size:13px;color:var(--text);line-height:1.6}
.section .muted{color:var(--muted)}

/* Certifications-only gallery in modal */
.certThumbs{
  display:flex;flex-wrap:wrap;gap:8px;align-items:center
}
.certThumbs img{
  width:56px;height:56px;object-fit:contain;display:block;
  border:none;background:transparent;box-shadow:none;border-radius:0;
}
</style>
</head>
<body>

  <!-- Header mount -->
  <div id="header-container">
    <div class="brand">
      <img class="brand-logo" src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png/v1/fill/w_66,h_66,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/0_New_JMBN_Logo_Gold.png" alt="JMBN">
      <h1>JMBN</h1>
    </div>
  </div>

  <script>
  (async () => {
    try {
      const res = await fetch('header.html', { cache: 'no-cache' });
      if(res.ok){
        const html = await res.text();
        document.getElementById('header-container').outerHTML = html;
        requestAnimationFrame(() => {
          const here = (location.pathname.split('/').pop() || 'index.html').toLowerCase();
          document.querySelectorAll('.nav-btn').forEach(a => {
            const href = (a.getAttribute('href')||'').toLowerCase();
            if (href === here) { a.classList.add('active'); a.setAttribute('aria-current','page'); }
            if(/member/.test(here) && /member/.test(href)){ a.classList.add('active'); a.setAttribute('aria-current','page'); }
          });
        });
      }
    } catch (e) { console.warn('Header load failed:', e); }
  })();
  </script>

  <div class="panel">
    <div class="controls">
      <input id="q" type="search" placeholder="Search handle, rank, or specialization…">
      <span id="count" class="badge">0 members</span>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width:23%">Handle</th>
            <th style="width:19%">Rank Category</th>
            <th style="width:20%">Current Rank</th>
            <th style="width:20%">Specialization</th>
            <th style="width:13%">Certifications</th>
            <th style="width:5%"></th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6" style="padding:12px;color:var(--muted)">Loading…</td></tr>
        </tbody>
      </table>
    </div>

    <div class="meta" style="padding-top:10px">
      Attendance counts only missions with status <b>Success / Fail / Abort</b>.
    </div>
  </div>

  <!-- Modal -->
  <div id="viewMask" class="modal-mask" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="header-row">
        <h3 id="viewTitle">Member</h3>
        <div class="spacer"></div>
        <button class="btn" onclick="closeView()">Close</button>
      </div>

      <div class="rankCard">
        <img id="rankImg" alt="Rank">
        <div class="meta">
          <div><b>Handle:</b> <span id="vHandle"></span></div>
          <div><b>Rank Category:</b> <span id="vRankCat"></span></div>
          <div><b>Current Rank:</b> <span id="vRankName"></span> <span id="vRankCode" class="meta"></span></div>
          <div><b>Specialization (role chips):</b> <span id="vRoles"></span></div>
          <div><b>Missions attended:</b> <span id="vAttended"></span></div>
        </div>
      </div>

      <hr class="divider">

      <div class="section">
        <h4>Certifications</h4>
        <div id="vCertThumbs" class="certThumbs"></div>
      </div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/auth.js"></script>

<script>
const $ = s => document.querySelector(s);
const esc = s => { const d=document.createElement('div'); d.textContent=s??''; return d.innerHTML; };
const toTitleCase = s => s ? s.replace(/\s+/g,' ').trim().toLowerCase().replace(/\b\w/g,c=>c.toUpperCase()) : '';

function normalizeRoles(r){
  const raw = r.ingame_role ?? null;
  if(!raw) return [];
  if(Array.isArray(raw)) return raw.map(toTitleCase).filter(Boolean);
  return String(raw).split(/[,;/]+/).map(s=>toTitleCase(s)).filter(Boolean);
}

let sb=null, ROWS=[];
const RANK_BUCKET='Ranks', CERT_BUCKET='Certifications';

function rankPublicUrlFromCode(code){
  if(!code) return '';
  return sb.storage.from(RANK_BUCKET).getPublicUrl(`${code}.png`).data.publicUrl;
}
function certPublicUrlFromCode(code){
  if(!code) return '';
  return sb.storage.from(CERT_BUCKET).getPublicUrl(`${code}.png`).data.publicUrl;
}

const tbody=$('#tbody'), countEl=$('#count'), q=$('#q');

function render(rows){
  if(!rows?.length){
    tbody.innerHTML=`<tr><td colspan="6" style="padding:12px;color:var(--muted)">No members found</td></tr>`;
    countEl.textContent='0 members';
    return;
  }

  tbody.innerHTML=rows.map(r=>{
    const handle=toTitleCase(r.handle||r.display_name||r.user_id?.slice(0,8)||'—');
    const rankCat=r.current_rank_category?toTitleCase(r.current_rank_category):'—';
    const rankName=r.current_rank_name?toTitleCase(r.current_rank_name):'Unrated';
    const imgUrl=r.current_rank_image_url||rankPublicUrlFromCode(r.current_rank_code);
    const roles=normalizeRoles(r);

    return `
    <tr>
      <td class="name">${esc(handle)}</td>
      <td>${esc(rankCat)}</td>
      <td>
        <div class="rankCell">
          ${imgUrl?`<img src="${imgUrl}" alt="${esc(r.current_rank_code||'Rank')}" loading="lazy" onerror="this.style.display='none'">`:''}
          <span>${esc(rankName)}</span>
        </div>
      </td>
      <td>${roles.length?`<div class="roles">${roles.map(x=>`<span class="role-chip">${esc(x)}</span>`).join('')}</div>`:`<span style="color:var(--muted)">—</span>`}</td>
      <td><span style="color:var(--muted)">—</span></td>
      <td><button class="btn" onclick="viewMember('${r.user_id}')">View</button></td>
    </tr>`;
  }).join('');

  countEl.textContent=`${rows.length} member${rows.length===1?'':'s'}`;
}

function filterRows(){
  const term=(q.value||'').toLowerCase().trim();
  if(!term) return ROWS;
  return ROWS.filter(r=>{
    const all=`${r.handle||''} ${r.display_name||''} ${r.current_rank_category||''} ${r.current_rank_name||''} ${r.current_rank_code||''} ${normalizeRoles(r).join(' ')}`.toLowerCase();
    return all.includes(term);
  });
}

function closeView(){ $('#viewMask').style.display='none'; }
window.closeView=closeView;

/** OPTION A: load certifications directly from public.user_certifications */
async function loadCertThumbs(userId){
  const box = $('#vCertThumbs');
  box.innerHTML = '';

  const { data, error } = await sb
    .from('user_certifications')
    .select('certification_code')
    .eq('user_id', userId);

  if (error) {
    console.warn('cert load:', error.message);
    box.innerHTML = ''; // show nothing if error
    return;
  }

  const codes = (data || []).map(r => (r.certification_code || '').trim()).filter(Boolean);
  if (!codes.length) { box.innerHTML = ''; return; }

  const imgs = codes.map(code => certPublicUrlFromCode(code)).filter(Boolean);
  box.innerHTML = imgs
    .map(src => `<img src="${esc(src)}" alt="" loading="lazy" onerror="this.style.display='none'">`)
    .join('');
}

function viewMember(userId){
  const r=ROWS.find(x=>x.user_id===userId);
  if(!r) return;
  const handle=toTitleCase(r.handle||r.display_name||r.user_id.slice(0,8));
  const attended=Number(r.missions_attended)||0;
  const rankCat=r.current_rank_category?toTitleCase(r.current_rank_category):'—';
  const rankName=r.current_rank_name?toTitleCase(r.current_rank_name):'Unrated';
  const roles=normalizeRoles(r);
  const imgUrl=r.current_rank_image_url||rankPublicUrlFromCode(r.current_rank_code);

  $('#viewTitle').textContent=`Member — ${handle}`;
  $('#vHandle').textContent=handle;
  $('#vRankCat').textContent=rankCat;
  $('#vRankName').textContent=rankName;
  $('#vRankCode').textContent=r.current_rank_code?`(${r.current_rank_code})`:''; // optional small code tag
  $('#vRoles').innerHTML=roles.length?roles.map(x=>`<span class="role-chip">${esc(x)}</span>`).join(' '):'—';
  $('#vAttended').textContent=attended;

  const imgEl=$('#rankImg');
  imgEl.src=imgUrl||''; imgEl.alt=r.current_rank_code||'Rank';
  imgEl.style.visibility=imgUrl?'visible':'hidden';
  imgEl.onerror=()=>{imgEl.style.visibility='hidden';};

  // Load ONLY certification images into modal
  loadCertThumbs(userId);

  $('#viewMask').style.display='flex';
}
window.viewMember=viewMember;

async function loadRoster(){
  const {data,error}=await sb
    .from('v_profiles_detailed')
    .select(`
      user_id,
      handle,
      display_name,
      current_rank_category,
      current_rank_name,
      current_rank_code,
      current_rank_image_url,
      ingame_role,
      missions_attended
    `)
    .order('current_rank_category',{ascending:true})
    .order('handle',{ascending:true});

  if(error){
    tbody.innerHTML=`<tr><td colspan="6" style="padding:12px;color:var(--bad)">Failed to load: ${esc(error.message)}</td></tr>`;
    countEl.textContent='0 members';
    return;
  }
  ROWS=data||[];
  render(filterRows());
}

q.addEventListener('input',()=>render(filterRows()));

document.addEventListener('DOMContentLoaded',async()=>{
  const session=await requireAuth(); if(!session) return;
  sb=getSupabase();
  loadRoster();
});
</script>
</body>
</html>
