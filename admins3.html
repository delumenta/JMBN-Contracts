<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Contracts</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
 --bg:#000;--panel:#0b0b0b;--border:#d6b44c;--card:#141414;
 --accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;
 --fs-base:14px;--fs-small:11px;
}
*{box-sizing:border-box}
body{
 background:
   radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
   radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
   #000;
 color:var(--text); font-family:'Play',system-ui,sans-serif;
 margin:0; padding:14px; font-size:var(--fs-base);
}

.brand{display:flex;align-items:center;gap:10px;margin:0 0 12px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.brand-logo{width:44px;height:44px;object-fit:contain;filter:drop-shadow(0 0 6px rgba(242,214,117,.3))}
.brand h1{font-size:20px;color:var(--accent);margin:0;letter-spacing:.25em;text-transform:uppercase}
.panel-title{color:var(--accent);font-size:14px;text-transform:uppercase;letter-spacing:.2em;margin-bottom:6px}

.btn{
 padding:8px 14px;border-radius:999px;cursor:pointer;font-family:'Play';font-size:12px;
 border:1px solid var(--border);background:radial-gradient(circle at top,var(--accent),#614c14);color:#000;
}
.btn-secondary{background:#0b0b0b;color:var(--accent);border:1px solid var(--border)}

.section-panel{border:1px solid var(--border);border-radius:14px;padding:14px;background:#0b0b0b;margin-bottom:14px;box-shadow:0 0 22px rgba(214,180,76,.2)}

.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.card{border:1px solid var(--border);border-radius:12px;background:#111;padding:12px;color:var(--text);box-shadow:0 0 16px rgba(0,0,0,.6)}
.card-header{font-size:13px;color:var(--accent);margin-bottom:6px;text-transform:uppercase;letter-spacing:.1em}
.card-line{font-size:12px;color:var(--muted);margin-bottom:3px}

.modal-mask{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:999}
.modal{width:95%;max-width:1000px;max-height:90vh;overflow:auto;background:#0b0b0b;border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 0 28px rgba(214,180,76,.3)}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.modal-title{color:var(--accent);font-size:14px;text-transform:uppercase;letter-spacing:.2em}

.upload-box{border:1px dashed var(--border);padding:10px;border-radius:12px;background:#111;margin-bottom:10px}
.preview{border:1px solid var(--border);border-radius:8px;overflow:hidden;width:220px;height:140px;background:#000;margin-bottom:8px}
.preview img{width:100%;height:100%;object-fit:cover}
.ocr-box{height:140px;background:#050505;border:1px solid var(--border);border-radius:8px;padding:8px;color:var(--muted);font-size:12px;white-space:pre-wrap;overflow:auto}

.contract-editor{border:1px solid var(--border);border-radius:12px;padding:12px;background:#111}
.cargo-card{border:1px solid var(--border);border-radius:12px;padding:10px;background:#0f0f0f;margin-bottom:10px}
.cargo-card h4{margin:0 0 6px;color:var(--accent);font-size:12px;text-transform:uppercase}

</style>
</head>
<body>
<div class="brand">
  <img class="brand-logo" src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" />
  <h1>JMBN // CONTRACTS</h1>
</div>

<button class="btn" id="openIntake">+ New Contract / Scan</button>

<div class="section-panel">
  <div class="panel-title">Saved Sessions</div>
  <div class="cards-grid" id="sessionsGrid">Loadingâ€¦</div>
</div>

<!-- Intake Modal -->
<div class="modal-mask" id="intakeMask">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">New Contract</div>
      <button class="btn-secondary" id="closeIntake">Close</button>
    </div>

    <div class="upload-box" id="pasteZone">
      <input type="file" id="screenshotInput" accept="image/*">
      <button class="btn" id="scanBtn">Scan Image</button>
      <div class="preview"><img id="previewImg" style="display:none;"></div>
      <div class="ocr-box" id="ocrOutput"></div>
      <div id="statusLine" style="color:var(--muted);font-size:12px">Paste with Ctrl+V</div>
    </div>

    <div class="contract-editor">
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:8px">
        <div><label>Contract Name</label><input id="contractName" type="text" style="width:100%"></div>
        <div><label>Type</label><select id="contractType" style="width:100%"><option value="hauling">Hauling</option></select></div>
        <div><label>Reward</label><input id="reward" type="number" style="width:100%"></div>
      </div>

      <div id="cargoList"></div>
      <button class="btn-secondary" id="addCargo">+ Add Cargo Type</button>
      <button class="btn" id="saveContract">Save Contract</button>
    </div>

  </div>
</div>

<script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
let sb=null;
let currentSession=null;
let activeModel={cargo:[]};

function $(id){return document.getElementById(id);}
// === JMBN CONTRACTS FULL JS MOUNTED ===
(async function(){
  const session = await requireAuth();
  if(!session){ return; }
  sb = getSupabase();

  // --- Session Auto-Create ---
  async function ensureSession(){
    if(currentSession) return currentSession;
    const { data, error } = await sb.from('sessions').insert({ submitted_by: session.user.id }).select().single();
    if(error){ console.error(error); return null; }
    currentSession = data;
    return data;
  }

  // --- Add Cargo Card ---
  function addCargoCard(data={ cargo_type:'', loading:[], offloading:[] }){
    const idx = activeModel.cargo.length;
    activeModel.cargo.push(data);

    const div = document.createElement('div');
    div.className = 'cargo-card';
    div.innerHTML = `
      <h4>Cargo Type</h4>
      <input data-idx="${idx}" data-field="type" placeholder="e.g. Waste" style="width:100%;margin-bottom:8px">
      <div><b>Loading</b></div>
      <div data-idx="${idx}" data-section="loading"></div>
      <button class="btn-secondary" data-idx="${idx}" data-add-load>+ Add Loading</button>
      <div style="height:6px"></div>
      <div><b>Offloading</b></div>
      <div data-idx="${idx}" data-section="offloading"></div>
      <button class="btn-secondary" data-idx="${idx}" data-add-off>+ Add Offloading</button>
    `;
    $('cargoList').appendChild(div);
  }

  function addLoading(idx){ addLoadOff(idx,'loading'); }
  function addOffloading(idx){ addLoadOff(idx,'offloading'); }

  function addLoadOff(idx, section){
    const container = document.querySelector(`[data-idx="${idx}"][data-section="${section}"]`);
    const entry = { location:'', scu:'' };
    activeModel.cargo[idx][section].push(entry);

    const row = document.createElement('div');
    row.style.marginBottom='6px';
    const rowIdx = activeModel.cargo[idx][section].length - 1;
    row.innerHTML = `
      <input placeholder="Location" data-idx="${idx}" data-sec="${section}" data-row="${rowIdx}" data-field="location" style="width:55%;margin-right:4px">
      <input placeholder="SCU" data-idx="${idx}" data-sec="${section}" data-row="${rowIdx}" data-field="scu" type="number" style="width:35%">
    `;
    container.appendChild(row);
  }

  $('cargoList').addEventListener('input', e=>{
    const idx = e.target.dataset.idx;
    const field = e.target.dataset.field;
    const sec = e.target.dataset.sec;
    const row = e.target.dataset.row;
    if(idx!==undefined && field){ activeModel.cargo[idx][field] = e.target.value; }
    if(idx!==undefined && sec && row!==undefined){
      activeModel.cargo[idx][sec][row][field] = e.target.value;
    }
  });

  $('cargoList').addEventListener('click', e=>{
    if(e.target.dataset.addLoad!==undefined){ addLoading(Number(e.target.dataset.idx)); }
    if(e.target.dataset.addOff!==undefined){ addOffloading(Number(e.target.dataset.idx)); }
  });

  $('addCargo').onclick = ()=> addCargoCard();

  // --- Save Contract ---
  $('saveContract').onclick = async ()=>{
    const sess = await ensureSession();
    if(!sess){ alert('Session create failed'); return; }

    const { data:contract, error } = await sb.from('contracts').insert({
      session_id: sess.id,
      submitted_by: session.user.id,
      contract_name: $('contractName').value,
      reward: Number($('reward').value||0),
      contract_type: $('contractType').value
    }).select().single();

    if(error){ console.error(error); alert('Save fail'); return; }

    // Cargo Types
    for(const c of activeModel.cargo){
      const { data:ct, error:errCT } = await sb.from('contract_cargo_types').insert({
        contract_id: contract.id,
        cargo_type: c.type || ''
      }).select().single();
      if(errCT) continue;

      // Loading
      for(const ld of c.loading){
        await sb.from('contract_loading').insert({
          cargo_type_id: ct.id,
          location: ld.location,
          scu: Number(ld.scu||0)
        });
      }
      // Offloading
      for(const ofd of c.offloading){
        await sb.from('contract_offloading').insert({
          cargo_type_id: ct.id,
          location: ofd.location,
          scu: Number(ofd.scu||0)
        });
      }
    }

    alert('Contract saved');
    location.reload();
  };

  // --- Load Sessions Cards ---
  async function loadSessions(){
    const { data:sessions } = await sb.from('sessions').select('*').eq('submitted_by', session.user.id).order('created_at',{ascending:false});
    const grid = $('sessionsGrid');
    if(!sessions.length){ grid.innerHTML='No sessions'; return; }

    grid.innerHTML='';
    for(const s of sessions){
      const { data:contracts } = await sb.from('contracts').select('*').eq('session_id', s.id);

      const card = document.createElement('div');
      card.className='card';
      card.innerHTML = `<div class='card-header'>Session ${s.id.slice(0,8)}</div>` +
        contracts.map(c=>`
          <div class='card-line'><b>${c.contract_name}</b> (${c.reward} aUEC)</div>
        `).join('');
      grid.appendChild(card);
    }
  }

  loadSessions();

})();



<script>
// === BEGIN JMBN CONTRACTS FULL JS (WRAPPED) ===
let sb=null;
let currentSession=null;
let activeModel={cargo:[]};
function $(id){return document.getElementById(id);}

(async function(){
  const session = await requireAuth();
  if(!session){ return; }
  sb = getSupabase();

  async function ensureSession(){
    if(currentSession) return currentSession;
    const { data, error } = await sb.from('sessions').insert({ submitted_by: session.user.id }).select().single();
    if(error){ console.error(error); return null; }
    currentSession = data;
    return data;
  }

  function addCargoCard(data={ cargo_type:'', loading:[], offloading:[] }){
    const idx = activeModel.cargo.length;
    activeModel.cargo.push(data);
    const div=document.createElement('div');
    div.className='cargo-card';
    div.innerHTML=`
      <h4>Cargo Type</h4>
      <input data-idx="${idx}" data-field="type" placeholder="e.g. Waste" style="width:100%;margin-bottom:8px">
      <div><b>Loading</b></div>
      <div data-idx="${idx}" data-section="loading"></div>
      <button class="btn-secondary" data-idx="${idx}" data-add-load>+ Add Loading</button>
      <div style="height:6px"></div>
      <div><b>Offloading</b></div>
      <div data-idx="${idx}" data-section="offloading"></div>
      <button class="btn-secondary" data-idx="${idx}" data-add-off>+ Add Offloading</button>`;
    $('cargoList').appendChild(div);
  }

  function addLoading(idx){ addLoadOff(idx,'loading'); }
  function addOffloading(idx){ addLoadOff(idx,'offloading'); }

  function addLoadOff(idx, section){
    const container=document.querySelector(`[data-idx="${idx}"][data-section="${section}"]`);
    const entry={ location:'', scu:'' };
    activeModel.cargo[idx][section].push(entry);
    const row=document.createElement('div');
    row.style.marginBottom='6px';
    const rowIdx = activeModel.cargo[idx][section].length - 1;
    row.innerHTML=`
      <input placeholder="Location" data-idx="${idx}" data-sec="${section}" data-row="${rowIdx}" data-field="location" style="width:55%;margin-right:4px">
      <input placeholder="SCU" data-idx="${idx}" data-sec="${section}" data-row="${rowIdx}" data-field="scu" type="number" style="width:35%">`;
    container.appendChild(row);
  }

  $('cargoList').addEventListener('input', e=>{
    const idx=e.target.dataset.idx;
    const field=e.target.dataset.field;
    const sec=e.target.dataset.sec;
    const row=e.target.dataset.row;
    if(idx!==undefined && field){ activeModel.cargo[idx][field]=e.target.value; }
    if(idx!==undefined && sec && row!==undefined){ activeModel.cargo[idx][sec][row][field]=e.target.value; }
  });

  $('cargoList').addEventListener('click', e=>{
    if(e.target.dataset.addLoad!==undefined){ addLoading(Number(e.target.dataset.idx)); }
    if(e.target.dataset.addOff!==undefined){ addOffloading(Number(e.target.dataset.idx)); }
  });

  $('addCargo').onclick=()=>addCargoCard();

  $('saveContract').onclick=async()=>{
    const sess=await ensureSession();
    if(!sess){ alert('Session create failed'); return; }

    const { data:contract, error } = await sb.from('contracts').insert({
      session_id:sess.id,
      submitted_by: session.user.id,
      contract_name: $('contractName').value,
      reward: Number($('reward').value||0),
      contract_type: $('contractType').value
    }).select().single();

    if(error){ console.error(error); alert('Save fail'); return; }

    for(const c of activeModel.cargo){
      const { data:ct, error:errCT } = await sb.from('contract_cargo_types').insert({
        contract_id: contract.id,
        cargo_type: c.type||''
      }).select().single();
      if(errCT) continue;
      for(const ld of c.loading){ await sb.from('contract_loading').insert({ cargo_type_id:ct.id, location:ld.location, scu:Number(ld.scu||0) }); }
      for(const ofd of c.offloading){ await sb.from('contract_offloading').insert({ cargo_type_id:ct.id, location:ofd.location, scu:Number(ofd.scu||0) }); }
    }

    alert('Contract saved');
    location.reload();
  };

  async function loadSessions(){
    const { data:sessions } = await sb.from('sessions').select('*').eq('submitted_by', session.user.id).order('created_at',{ascending:false});
    const grid=$('sessionsGrid');
    if(!sessions.length){ grid.innerHTML='No sessions'; return; }
    grid.innerHTML='';
    for(const s of sessions){
      const { data:contracts } = await sb.from('contracts').select('*').eq('session_id', s.id);
      const card=document.createElement('div');
      card.className='card';
      card.innerHTML=`<div class='card-header'>Session ${s.id.slice(0,8)}</div>`+
        contracts.map(c=>`<div class='card-line'><b>${c.contract_name}</b> (${c.reward} aUEC)</div>`).join('');
      grid.appendChild(card);
    }
  }

  loadSessions();
})();
// === END JMBN CONTRACTS FULL JS (WRAPPED) ===
</script>
</body>
</html>
