<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Mission Log — Contract Manager</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  --bg:#000; --border:#d6b44c; --accent:#f2d675; --text:#f7f1d0; --muted:#c9b06a; --bad:#ff6b6b;
  --stroke:#2a2313; --bezel:#0a0a07;
  --fs-base:14px; --fs-small:11px; --fs-table:13px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--text);font-family:'Play',sans-serif;background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;font-size:var(--fs-base);
}
#header-container{margin:12px 12px 0}

/* Panel */
.panel{background:linear-gradient(180deg,#0b0b0b,#080808);border:1px solid var(--border);border-radius:14px;box-shadow:0 0 10px rgba(214,180,76,.15);margin:12px}
.panel-inner{padding:12px}

/* Tabs */
.tabs{display:flex;gap:8px;margin:4px 0 10px}
.tab{
  padding:8px 12px;border:1px solid var(--stroke);border-radius:10px;background:linear-gradient(180deg,#131008,#0b0905);
  color:var(--accent);cursor:pointer;transition:.15s
}
.tab:hover{background:#181307}
.tab.active{outline:1px solid var(--border); box-shadow:0 0 0 1px rgba(214,180,76,.25) inset}

/* Controls & KPI */
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
input,select{
  background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:9px;color:var(--text);font-size:var(--fs-table)
}
button,.small-btn{
  padding:8px 12px;border-radius:10px;background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);border:1px solid var(--border);cursor:pointer;transition:.2s
}
button:hover,.small-btn:hover{background:var(--accent);color:#000}

.kpis{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin:8px 0}
@media(max-width:880px){.kpis{grid-template-columns:1fr}}
.kpi{
  background:linear-gradient(180deg,#0b0b0b,#080808);border:1px solid var(--border);border-radius:12px;padding:12px;
  box-shadow:0 0 8px rgba(214,180,76,.12), inset 0 0 0 1px rgba(214,180,76,.08)
}
.kpi-title{font-size:12px;color:var(--muted);margin-bottom:6px}
.kpi-value{font-size:22px;font-weight:700;color:var(--accent)}
.kpi-sub{font-size:12px;color:var(--muted);margin-top:4px}

/* Grid */
.mgrid{display:grid;grid-template-columns:360px 1fr;gap:12px}
@media(max-width:1100px){.mgrid{grid-template-columns:1fr}}
.mlist{
  min-height:420px;max-height:72vh;overflow:auto;border:1px solid var(--stroke);border-radius:10px;background:var(--bezel);
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.06)
}
.mitem{
  padding:10px 12px;border-bottom:1px solid rgba(214,180,76,.08);cursor:pointer;
  background:linear-gradient(180deg,#131008,#0b0905);transition:.12s
}
.mitem:hover{background:#191307}
.mitem.active{outline:1px solid var(--border)}
.mtitle{color:var(--accent);font-weight:700;margin-bottom:3px}
.mmeta{font-size:12px;color:var(--muted)}
.mchips{margin-top:6px;display:flex;gap:6px;flex-wrap:wrap}
.mchip{border:1px solid var(--stroke);border-radius:999px;padding:2px 8px;font-size:11px;color:var(--muted)}

/* Right column cards */
.rightcol{display:grid;gap:12px}
.inspector{
  border:1px solid var(--stroke);border-radius:10px;background:linear-gradient(180deg,#0b0b0b,#090909);
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.06);padding:12px
}
.inspector h2{color:var(--accent);margin:0 0 6px;font-size:16px}
.hr{height:1px;background:linear-gradient(90deg,transparent,rgba(214,180,76,.45),transparent);margin:10px 0}
.small{font-size:var(--fs-small);color:var(--muted)}
.pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px;color:var(--muted)}
.pill.res{color:#f2d675;border-color:#f2d675}
.pill.op{color:#7bd88f;border-color:#7bd88f}
.mono{font-variant-numeric:tabular-nums}

/* Button */
.btn-accept{
  padding:10px 14px;border-radius:10px;border:1px solid var(--border);
  background:linear-gradient(180deg,#1a1405,#0c0a04);
  color:var(--accent);font-weight:700;letter-spacing:.35px;
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.18);transition:.15s ease;
}
.btn-accept:hover{background:var(--accent);color:#000;box-shadow:0 0 14px rgba(214,180,76,.35)}

.ongoing-item{padding:8px 0;border-top:1px dashed rgba(214,180,76,.12);font-size:12px;color:var(--muted)}
.ongoing-item:first-child{border-top:none}
.ongoing-title{color:var(--accent);font-weight:700}
</style>
</head>
<body>

<!-- Header -->
<div id="header-container"></div>
<script>
(async()=>{
  try{
    const res=await fetch('header.html',{cache:'no-cache'});
    const html=await res.text();
    document.getElementById('header-container').outerHTML=html;
    requestAnimationFrame(()=>{
      const here=(location.pathname.split('/').pop()||'mission-log.html').toLowerCase();
      document.querySelectorAll('.nav-btn').forEach(a=>{
        const href=(a.getAttribute('href')||'').toLowerCase();
        if(href===here)a.classList.add('active');
      });
    });
  }catch(e){console.warn('Header load failed:',e);}
})();
</script>

<!-- Board -->
<section class="panel">
  <div class="panel-inner">
    <div class="tabs" id="tabs">
      <div class="tab active" data-scope="">GENERAL</div>
      <div class="tab" data-scope="history">HISTORY</div>
    </div>

    <div class="controls">
      <input id="search" placeholder="Search contracts (title, type, status, tags, route)">
      <select id="catFilter">
        <option value="">All Categories</option>
        <option value="Resource">Resource</option>
        <option value="Operations">Operations</option>
      </select>
      <select id="statusFilter">
        <option value="">All Status</option>
        <option>planned</option><option>active</option><option>success</option><option>fail</option><option>abort</option>
      </select>
      <button class="small-btn" id="btnExport">Export CSV</button>
    </div>

    <div class="kpis">
      <div class="kpi"><div class="kpi-title">Total Missions</div><div class="kpi-value" id="kpiCount">0</div><div class="kpi-sub">after filters</div></div>
      <div class="kpi"><div class="kpi-title">Resource : Ops</div><div class="kpi-value" id="kpiMix">0 : 0</div><div class="kpi-sub">derived from type</div></div>
      <div class="kpi"><div class="kpi-title">Avg Payout (shown)</div><div class="kpi-value mono" id="kpiAvg">-</div><div class="kpi-sub">aUEC</div></div>
    </div>

    <div class="mgrid">
      <!-- Left: list -->
      <div class="mlist" id="mList"></div>

      <!-- Right: details + ongoing -->
      <div class="rightcol">
        <div class="inspector" id="inspector">
          <h2>Mission Details</h2>
          <div class="small">Select a contract on the left to view its briefing.</div>
        </div>

        <div class="inspector" id="ongoingCard">
          <h2>Ongoing Missions</h2>
          <div id="ongoingSpace" class="small">None</div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Attendance Modal -->
<div id="attModalMask" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50">
  <div class="inspector" style="max-width:760px;width:92vw">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
      <h2 id="attTitle" style="margin-right:auto;color:var(--accent)">Attendance</h2>
      <button class="small-btn" onclick="closeAttendance()">Close</button>
    </div>
    <div class="hr"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
      <button id="attIamGoing" class="btn-accept">I’m going</button>
      <button id="attNotGoing" class="btn-accept">Not going</button>
      <button id="attWithdraw" class="btn-accept">Withdraw</button>
      <select id="attSelfRole" style="min-width:180px;background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:8px;color:var(--text)"></select>
      <span class="small">Pick <b>your role</b> (optional).</span>
    </div>
    <div id="attElevatedTools" style="display:none;gap:8px;flex-wrap:wrap;margin-bottom:10px">
      <input id="attAddEmail" placeholder="Add by email (crew@example.com)" style="flex:1;min-width:240px;background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:8px;color:var(--text)">
      <select id="attAddRole" style="background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:8px;color:var(--text)"><option value="">Role (optional)</option></select>
      <button id="attAddBtn" class="btn-accept">Add</button>
      <span class="small">Admin/Owner can add/remove attendees.</span>
    </div>
    <div class="hr"></div>
    <div>
      <strong class="small">Attendees:</strong>
      <div id="attList" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px" class="small">Loading…</div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>

<script>
/* ===== Utilities ===== */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const esc=s=>{const d=document.createElement('div');d.textContent=s??'';return d.innerHTML;};
const fmtDate=iso=>{if(!iso)return'';const d=new Date(iso);return d.toLocaleString('en-SG',{day:'numeric',month:'long',year:'numeric',hour:'numeric',minute:'2-digit',hour12:true}).replace(/\s?([ap])m/i,'$1m');};
const fmtNum=n=>(n||n===0)?Number(n).toLocaleString():'';

const RESOURCE_TYPES=new Set(['hauling','cargo','salvage','mining','delivery']);
const catOf=t=>RESOURCE_TYPES.has((t||'').toLowerCase())?'Resource':'Operations';

/* ===== State ===== */
let sb=null, session=null, allMissions=[], filtered=[], selectedId=null, currentScope="";
let ROLES=[], ATT_MISSION_ID=null;
const DEFAULT_ROLES=['operations lead','pilot','copilot','escort','tactician','fps','gunner','hauler','miner','salvager','engineer','medic','recon','runner','logistics','security'];

/* ===== Boot ===== */
document.getElementById('tabs').addEventListener('click',e=>{
  const t=e.target.closest('.tab'); if(!t) return;
  $$('#tabs .tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
  currentScope=t.dataset.scope||""; renderFiltered();
});
$('#search').addEventListener('input',renderFiltered);
$('#catFilter').addEventListener('input',renderFiltered);
$('#statusFilter').addEventListener('input',renderFiltered);
$('#btnExport').onclick=exportCSV;

document.addEventListener('DOMContentLoaded', async ()=>{
  session = await requireAuth(); if(!session) return;
  sb = getSupabase();
  await loadRoles();
  await loadMissions();
});

/* ===== Data ===== */
async function loadRoles(){
  try{
    const { data, error } = await sb.from('mission_roles').select('label').order('sort_order',{ascending:true}).order('label',{ascending:true});
    ROLES = error || !data?.length ? DEFAULT_ROLES.map(label=>({label})) : data;
  }catch{ ROLES = DEFAULT_ROLES.map(label=>({label})); }
}

async function loadMissions(){
  const { data, error } = await sb
    .from('missions')
    .select('id,title,type,status,origin,destination,start_time,hours,payout_auec,tags,attachments,notes,created_at,submitted_by')
    .order('created_at',{ascending:false});
  if(error){ $('#mList').innerHTML='<div class="small">Failed to load missions.</div>'; return; }
  allMissions = data||[];
  renderFiltered();
}

/* ===== Filter + KPIs ===== */
function getFiltered(){
  const q=($('#search').value||'').toLowerCase();
  const cat=$('#catFilter').value||'';
  const st=($('#statusFilter').value||'').toLowerCase();
  let arr=allMissions.slice();

  if(cat) arr = arr.filter(m=>catOf(m.type)===cat);
  if(st)  arr = arr.filter(m=>(m.status||'').toLowerCase()===st);
  if(q)   arr = arr.filter(m => (`${m.title||''} ${m.type||''} ${m.status||''} ${m.tags||''} ${m.origin||''} ${m.destination||''}`.toLowerCase().includes(q)));

  if(currentScope==='history') arr = arr.filter(m=>['success','fail','abort'].includes((m.status||'').toLowerCase()));
  return arr;
}

function renderFiltered(){
  filtered = getFiltered();
  $('#kpiCount').textContent = filtered.length.toLocaleString();
  const r = filtered.filter(x=>catOf(x.type)==='Resource').length;
  $('#kpiMix').textContent = `${r} : ${filtered.length-r}`;
  const payouts = filtered.map(m=>+m.payout_auec||0).filter(n=>n>0);
  const avg = payouts.length ? Math.round(payouts.reduce((a,b)=>a+b,0)/payouts.length) : 0;
  $('#kpiAvg').textContent = avg ? avg.toLocaleString() : '-';

  renderList(filtered);
  if(selectedId){
    const m = filtered.find(x=>x.id===selectedId) || allMissions.find(x=>x.id===selectedId);
    renderInspector(m||null);
  }
  loadOngoing();
}

/* ===== List ===== */
function listItemHtml(m){
  const cat=catOf(m.type);
  const route=(m.origin||m.destination)?`${esc(m.origin||'')} → ${esc(m.destination||'')}`:'—';
  return `<div class="mitem" data-id="${m.id}" onclick="inspect('${m.id}')">
    <div class="mtitle">${esc(m.title||'(untitled)')}</div>
    <div class="mmeta">${route} • ${m.start_time?fmtDate(m.start_time):'TBA'}</div>
    <div class="mchips">
      ${cat?`<span class="mchip">${cat}</span>`:''}
      ${m.type?`<span class="mchip">${esc(m.type)}</span>`:''}
      ${m.status?`<span class="mchip">${esc(m.status)}</span>`:''}
      ${m.payout_auec?`<span class="mchip mono">${fmtNum(m.payout_auec)} aUEC</span>`:''}
    </div>
  </div>`;
}
function renderList(rows){ $('#mList').innerHTML = rows.length ? rows.map(listItemHtml).join('') : '<div class="small">No missions found.</div>'; }

/* ===== Inspector ===== */
function renderInspector(m){
  const box=$('#inspector');
  if(!m){ box.innerHTML=`<h2>Mission Details</h2><div class="small">Select a contract on the left.</div>`; return; }
  selectedId=m.id;
  const cat=catOf(m.type);
  box.innerHTML=`
    <h2>${esc(m.title||'(untitled)')}</h2>
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin:4px 0 2px">
      ${cat?`<span class="pill ${cat==='Resource'?'res':'op'}">${cat}</span>`:''}
      ${m.type?`<span class="pill">${esc(m.type)}</span>`:''}
      ${m.status?`<span class="pill">${esc(m.status)}</span>`:''}
    </div>
    <div class="hr"></div>
    <div class="small">
      <div><b>Route:</b> ${m.origin||m.destination?`${esc(m.origin||'')} → ${esc(m.destination||'')}`:'—'}</div>
      <div><b>Start:</b> ${m.start_time?fmtDate(m.start_time):'TBA'}</div>
      <div><b>Hours:</b> ${m.hours?esc(m.hours):'—'}</div>
      <div><b>Payout:</b> <span class="mono">${fmtNum(m.payout_auec)}</span> aUEC</div>
      <div style="margin-top:6px"><b>Tags:</b> ${esc(m.tags||'—')}</div>
    </div>
    <div class="hr"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn-accept" onclick="openAttendance('${m.id}','${esc(m.title||'')}')">ATTENDANCE</button>
    </div>`;
  $$('.mitem').forEach(x=>x.classList.toggle('active',x.dataset.id===m.id));
}
function inspect(id){
  const m=(filtered.find(x=>x.id===id)||allMissions.find(x=>x.id===id));
  renderInspector(m||null);
  if(window.matchMedia('(max-width:1100px)').matches){ document.getElementById('inspector').scrollIntoView({behavior:'smooth',block:'start'}); }
}
window.inspect=inspect;

/* ===== Ongoing Card ===== */
async function loadOngoing(){
  if(!sb||!session) return;
  const space=$('#ongoingSpace'); space.textContent='Loading…';

  const { data: att, error: e1 } = await sb
    .from('mission_attendees')
    .select('mission_id')
    .eq('user_id', session.user.id)
    .eq('attendance','going');

  if(e1 || !att?.length){ space.textContent='None'; return; }

  const { data: rows, error: e2 } = await sb
    .from('missions')
    .select('id,title,status,start_time,origin,destination')
    .in('id', att.map(a=>a.mission_id))
    .in('status',['planned','active'])
    .order('start_time',{ascending:true});

  if(e2 || !rows?.length){ space.textContent='None'; return; }

  space.innerHTML = rows.map(r=>`
    <div class="ongoing-item">
      <div class="ongoing-title">${esc(r.title||'(untitled)')}</div>
      <div>${esc(r.status||'')} • ${r.start_time?fmtDate(r.start_time):'TBA'}
      ${r.origin||r.destination?` • ${esc(r.origin||'')} → ${esc(r.destination||'')}`:''}</div>
      <div style="margin-top:6px;display:flex;gap:6px;flex-wrap:wrap">
        <button class="btn-accept" onclick="inspect('${r.id}')">OPEN</button>
        <button class="btn-accept" onclick="openAttendance('${r.id}','${esc(r.title||'')}')">ATTENDANCE</button>
      </div>
    </div>
  `).join('');
}
window.refreshOngoing=loadOngoing;

/* ===== CSV ===== */
function exportCSV(){
  const rows=getFiltered();
  const cols=['title','category','type','status','origin','destination','start_time','hours','payout_auec','tags','notes'];
  const csv=[cols.join(','), ...rows.map(r=>{
    const rec={ title:r.title||'', category:catOf(r.type), type:r.type||'', status:r.status||'', origin:r.origin||'', destination:r.destination||'', start_time:r.start_time||'', hours:r.hours||'', payout_auec:r.payout_auec||'', tags:r.tags||'', notes:r.notes||'' };
    return cols.map(k=>`"${String(rec[k]).replace(/"/g,'""')}"`).join(',');
  })].join('\n');
  const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='missions.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ===== Attendance ===== */
function roleOptionsHtml(ph){ return `<option value="">${ph}</option>`+(ROLES.map(r=>`<option value="${r.label}">${r.label}</option>`).join('')); }

async function openAttendance(missionId,title=''){
  ATT_MISSION_ID=missionId;
  $('#attTitle').textContent=`Attendance — ${title||missionId.slice(0,8)}`;
  $('#attModalMask').style.display='flex';

  $('#attSelfRole').innerHTML=roleOptionsHtml('My role (optional)');
  $('#attAddRole').innerHTML=roleOptionsHtml('Role (optional)');

  const [{ data: elev }, { data: mission }] = await Promise.all([
    sb.rpc('is_elevated',{u:session.user.id}),
    sb.from('missions').select('submitted_by').eq('id', missionId).single()
  ]);
  const isOwner = mission?.submitted_by===session.user.id;
  $('#attElevatedTools').style.display = (elev || isOwner) ? 'flex' : 'none';

  try{
    const { data: mine } = await sb.from('mission_attendees').select('role_in_mission').match({ mission_id: ATT_MISSION_ID, user_id: session.user.id }).limit(1);
    if(mine?.[0]) $('#attSelfRole').value = mine[0].role_in_mission||'';
  }catch{}

  $('#attIamGoing').onclick=async()=>{
    const role=($('#attSelfRole').value||'').trim()||null;
    await sb.from('mission_attendees').upsert({mission_id:ATT_MISSION_ID,user_id:session.user.id,attendance:'going',role_in_mission:role},{onConflict:'mission_id,user_id'});
    await loadAttendees(); await refreshOngoing();
  };
  $('#attNotGoing').onclick=async()=>{
    await sb.from('mission_attendees').upsert({mission_id:ATT_MISSION_ID,user_id:session.user.id,attendance:'not_going'},{onConflict:'mission_id,user_id'});
    await loadAttendees(); await refreshOngoing();
  };
  $('#attWithdraw').onclick=async()=>{
    await sb.from('mission_attendees').delete().match({mission_id:ATT_MISSION_ID,user_id:session.user.id});
    await loadAttendees(); await refreshOngoing();
  };
  $('#attAddBtn').onclick=async()=>{
    const email=$('#attAddEmail').value.trim(); const role=$('#attAddRole').value||null;
    if(!email){ alert('Enter an email'); return; }
    const { error } = await sb.rpc('add_attendee_by_email',{p_mission:ATT_MISSION_ID,p_email:email,p_role:role,p_attendance:'going'});
    if(error){ alert('Add failed: '+error.message); return; }
    $('#attAddEmail').value=''; $('#attAddRole').value='';
    await loadAttendees(); await refreshOngoing();
  };

  await loadAttendees();
}
function closeAttendance(){ $('#attModalMask').style.display='none'; ATT_MISSION_ID=null; }
window.openAttendance=openAttendance; window.closeAttendance=closeAttendance;

async function loadAttendees(){
  const list=$('#attList'); list.textContent='Loading…';
  const { data, error } = await sb.from('v_mission_attendees_detailed').select('*').eq('mission_id',ATT_MISSION_ID).order('joined_at',{ascending:true});
  if(error){ list.innerHTML=`<span class="small" style="color:var(--bad)">Load failed: ${esc(error.message)}</span>`; return; }
  if(!data?.length){ list.textContent='No attendees yet.'; return; }

  const [{ data: elev }, { data: mission }] = await Promise.all([
    sb.rpc('is_elevated',{u:session.user.id}),
    sb.from('missions').select('submitted_by').eq('id', ATT_MISSION_ID).single()
  ]);
  const canManageAll=(elev || mission?.submitted_by===session.user.id);

  list.innerHTML='';
  for(const a of data){
    const chip=document.createElement('div');
    chip.style.cssText='display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:6px 10px';
    chip.setAttribute('data-attendance',(a.attendance||'').toLowerCase());
    const options=['<option value="">role</option>',...ROLES.map(r=>`<option value="${r.label}">${r.label}</option>`)].join('');
    chip.innerHTML=`
      <span>${esc(a.attendee_name || a.user_id.slice(0,8))}</span>
      <select data-uid="${a.user_id}" ${ (canManageAll || a.user_id===session.user.id) ? '' : 'disabled' } style="background:#0a0a0a;border:1px solid var(--border);border-radius:8px;padding:4px 8px;color:var(--text)">${options}</select>
      <span class="small" style="color:var(--muted)">${esc(a.attendance||'')}</span>
      ${ (canManageAll || a.user_id===session.user.id) ? `<button class="small-btn" data-uid="${a.user_id}" style="padding:2px 6px">x</button>` : '' }
    `;
    const sel=chip.querySelector('select'); sel.value=a.role_in_mission||'';
    if(sel && (canManageAll || a.user_id===session.user.id)){
      sel.onchange=async(e)=>{
        const newRole=e.target.value||null;
        const target=e.target.getAttribute('data-uid');
        const { error: upErr } = await sb.from('mission_attendees').update({role_in_mission:newRole}).match({mission_id:ATT_MISSION_ID,user_id:target});
        if(upErr){ alert('Update failed: '+upErr.message); e.target.value=a.role_in_mission||''; return; }
        await loadAttendees();
      };
    }
    const x=chip.querySelector('button.small-btn');
    if(x) x.onclick=async()=>{
      const target=x.getAttribute('data-uid');
      const { error: delErr } = await sb.from('mission_attendees').delete().match({mission_id:ATT_MISSION_ID,user_id:target});
      if(delErr){ alert('Remove failed: '+delErr.message); return; }
      await loadAttendees(); await refreshOngoing();
    };
    list.appendChild(chip);
  }
}
</script>
</body>
</html>