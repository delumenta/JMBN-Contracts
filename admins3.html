<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JMBN ‚Äì Progression</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--card:#0c0c0c;--border:#d6b44c;
  --accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;--ok:#5cd47c;
  --fs:14px;
}
*{box-sizing:border-box}
body{
  margin:0;padding:14px;background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text);font-family:'Play',system-ui,sans-serif;font-size:var(--fs);
  letter-spacing:.25px;
}

/* Header */
.brand{display:flex;align-items:center;gap:10px;margin:0 0 8px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.brand img.brand-logo{width:44px;height:44px;object-fit:contain;border:none;background:transparent;box-shadow:none}
.brand h1{font-weight:700;font-size:clamp(18px,2.2vw,22px);color:var(--accent);margin:0}

/* Containers */
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:10px;box-shadow:0 0 18px rgba(214,180,76,.20)}
.section{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:10px}
.h{margin:0 0 8px;color:var(--accent);font-size:16px}

/* Rank header */
.rankRow{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
.rankNow{display:flex;align-items:center;gap:10px}
.rankImg{width:46px;height:46px;object-fit:contain;border:none;background:transparent;box-shadow:none}
.badge{border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;background:#121212;color:var(--accent)}

/* Progress bars */
.pb{display:grid;grid-template-columns:120px 1fr auto;gap:10px;align-items:center;margin:8px 0}
.pb .label{color:var(--muted);font-size:12px}
.bar{height:12px;background:#0a0a0a;border:1px solid var(--border);border-radius:999px;overflow:hidden}
.fill{height:100%;background:linear-gradient(180deg,var(--accent),#d6b44c)}
.pb .val{font-variant-numeric:tabular-nums;color:var(--muted);font-size:12px}

/* Certifications grid */
.certGrid{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-top:10px;justify-items:center}
@media(max-width:1100px){.certGrid{grid-template-columns:repeat(5,1fr)}}
@media(max-width:900px){.certGrid{grid-template-columns:repeat(4,1fr)}}
@media(max-width:700px){.certGrid{grid-template-columns:repeat(3,1fr)}}
@media(max-width:520px){.certGrid{grid-template-columns:repeat(2,1fr)}}
.cert{background:transparent;text-align:center;padding:4px 2px 10px;border-radius:8px;transition:transform .15s ease, opacity .15s ease, filter .15s ease}
.cert:hover{transform:scale(1.05)}
.cert.dim{opacity:.45;filter:grayscale(.6)}
.cert .thumb{width:64px;height:64px;display:grid;place-items:center;margin:0 auto 4px}
.cert .thumb img{width:auto;max-width:54px;max-height:100%;object-fit:contain}
.cert .title{font-weight:700;font-size:12px}
.cert .code{font-size:10px;color:var(--muted);margin-top:1px}

/* Timeline ‚Äì fixed spacing */
.timeline{
  position:relative;
  margin-top:10px;
  padding-left:42px; /* increased gutter space */
}
.timeline::before{
  content:"";
  position:absolute;
  left:20px;
  top:0;bottom:0;
  width:2px;
  background:linear-gradient(var(--border),transparent);
}
.titem{
  position:relative;
  padding:12px 8px 12px 8px;
  padding-left:36px; /* keep text comfortably away from dots */
  border-bottom:1px solid rgba(255,255,255,.06);
  display:grid;
  grid-template-columns:1fr auto;
  gap:10px;
}
.tdot{
  position:absolute;
  left:14px;
  top:18px;
  width:9px;
  height:9px;
  border:2px solid var(--border);
  border-radius:50%;
  background:#1a1a1a;
  box-shadow:0 0 0 1px rgba(214,180,76,.1) inset;
}
.titem.done .tdot{background:var(--border);}
.tlabel{font-weight:700;margin-left:2px;}
.small{font-size:12px;color:var(--muted);}
@media(max-width:520px){
  .timeline{padding-left:48px;}
  .tdot{left:18px;top:18px;width:8px;height:8px;}
  .titem{padding-left:40px;}
}

/* Buttons */
button{
  padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);cursor:pointer;font-family:'Play'
}
button:hover{background:var(--accent);color:#000}
</style>
</head>
<body>

<div id="header-container">
  <div class="brand">
    <img class="brand-logo" src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" alt="JMBN">
    <h1>JMBN ‚Äì Progression</h1>
  </div>
</div>

<div class="panel">
  <div class="rankRow">
    <div class="rankNow">
      <img id="curImg" class="rankImg" alt="Rank">
      <div>
        <div class="h" style="margin:0">Rank Progression</div>
        <div style="font-size:12px;color:var(--muted)">
          Current: <b id="curRank">‚Äî</b> <span class="badge" id="curPg">PG: ‚Äî</span>
        </div>
      </div>
    </div>
    <div>
      <button class="badge" id="btnPromote" disabled
        style="cursor:pointer;background:linear-gradient(180deg,#0c0c0c,#060606);color:var(--accent)">
        Request Promotion
      </button>
    </div>
  </div>

  <div class="section">
    <h3 class="h">Next Rank</h3>
    <div style="display:flex;align-items:center;gap:10px">
      <img id="nextImg" class="rankImg" alt="Next">
      <div>
        <div id="nextName" style="font-weight:700;color:var(--accent)">‚Äî</div>
        <div class="badge" id="nextPg">PG: ‚Äî</div>
      </div>
    </div>
  </div>

  <div class="section">
    <h3 class="h">Requirements</h3>
    <div class="pb">
      <div class="label">Missions</div>
      <div class="bar"><div id="pbMissions" class="fill" style="width:0%"></div></div>
      <div class="val" id="valMissions">0 / 0</div>
    </div>
    <div class="pb">
      <div class="label">Hours</div>
      <div class="bar"><div id="pbHours" class="fill" style="width:0%"></div></div>
      <div class="val" id="valHours">0 / 0</div>
    </div>
    <div class="pb">
      <div class="label">Certifications</div>
      <div class="bar"><div id="pbCerts" class="fill" style="width:0%"></div></div>
      <div class="val" id="valCerts">0 / 0</div>
    </div>
    <div id="note" class="small" style="margin-top:8px">Promotion is available when all targets are met.</div>
  </div>

  <div class="section">
    <h3 class="h">Certifications</h3>
    <div id="certGrid" class="certGrid">‚Äî</div>
    <div class="small" style="margin-top:8px">Dim badges are not yet earned.</div>
  </div>

  <div class="section">
    <h3 class="h">Certification Timeline</h3>
    <div>
      <select id="certSelect"
        style="background:#0a0a0a;border:1px solid var(--border);border-radius:8px;padding:8px;color:var(--text);font-family:'Play'">
        <option value="">‚Äî Select a Certification ‚Äî</option>
      </select>
      <button id="btnReloadTL" style="margin-left:6px">Load</button>
    </div>
    <div id="tlHint" class="small" style="margin-top:8px">Pick a certification to view its required trainings.</div>
    <div id="timeline" class="timeline"></div>
  </div>
</div>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
const $ = s => document.querySelector(s);
let sb, me;

function setFill(sel,pct){
  const el=$(sel);const x=Math.max(0,Math.min(1,Number(pct)||0));
  el.style.width=(x*100)+'%';
}
async function fetchRankImage(code){
  if(!code) return '';
  try{return sb.storage.from('Ranks').getPublicUrl(`${code}.png`).data.publicUrl||'';}catch{return '';}
}
document.addEventListener('DOMContentLoaded', async ()=>{
  const session=await requireAuth();if(!session)return;
  sb=getSupabase();me=session.user.id;

  async function loadProgress(){
    const { data: prog } = await sb.from('v_user_rank_progress').select('*').eq('user_id',me).maybeSingle();
    $('#curRank').textContent=prog?.current_name||'(unranked)';
    $('#curPg').textContent=`PG: ${prog?.current_paygrade||'‚Äî'}`;
    $('#nextName').textContent=prog?.next_name||'‚Äî';
    $('#nextPg').textContent=`PG: ${prog?.next_paygrade||'‚Äî'}`;

    const curImg=await fetchRankImage(prog?.current_code);
    const nxtImg=await fetchRankImage(prog?.next_code);
    if(curImg)$('#curImg').src=curImg;
    if(nxtImg)$('#nextImg').src=nxtImg;

    const { data: up }=await sb.from('v_user_progress').select('*').eq('user_id',me).maybeSingle();
    const m=Number(up?.missions_attended||0),h=Number(up?.hours_total||0),c=Number(up?.certifications_total||0);
    const mt=Number(prog?.missions_target||0),ht=Number(prog?.hours_target||0),ct=Number(prog?.certification_target||0);
    $('#valMissions').textContent=`${m} / ${mt}`;
    $('#valHours').textContent=`${h} / ${ht}`;
    $('#valCerts').textContent=`${c} / ${ct}`;
    setFill('#pbMissions',mt?m/mt:1);
    setFill('#pbHours',ht?h/ht:1);
    setFill('#pbCerts',ct?c/ct:1);
  }

  async function loadCerts(){
    const [{data:cat},{data:mine}]=await Promise.all([
      sb.from('certifications').select('certification_code,name,image_url,sort_order').order('sort_order'),
      sb.from('user_certifications').select('certification_code').eq('user_id',me)
    ]);
    const owned=new Set((mine||[]).map(x=>x.certification_code));
    $('#certGrid').innerHTML=(cat||[]).map(c=>{
      const dim=!owned.has(c.certification_code)?' dim':'';
      return `<div class="cert${dim}">
        <div class="thumb">${c.image_url?`<img src="${c.image_url}" alt="">`:'üèÖ'}</div>
        <div class="title">${c.name}</div>
        <div class="code">${c.certification_code}</div>
      </div>`;
    }).join('');
    const sel=$('#certSelect');
    sel.innerHTML='<option value="">‚Äî Select a Certification ‚Äî</option>'+
      (cat||[]).map(c=>`<option value="${c.certification_code}">${c.certification_code} ‚Äî ${c.name}</option>`).join('');
  }

  async function loadTimeline(code){
    const tl=$('#timeline');tl.innerHTML='';
    if(!code){tl.innerHTML='<div class="small">Pick a certification.</div>';return;}
    const [{data:reqs},{data:done}]=await Promise.all([
      sb.from('certification_requirements')
        .select('event_code,sort_order,training_events(title,description)')
        .eq('certification_code',code).order('sort_order'),
      sb.from('user_training_events').select('event_code,completed_at,approved_by').eq('user_id',me)
    ]);
    const map=new Map((done||[]).map(r=>[r.event_code,r]));
    tl.innerHTML=(reqs||[]).map(r=>{
      const rec=map.get(r.event_code),ok=!!rec;
      return `<div class="titem${ok?' done':''}">
        <div class="tdot"></div>
        <div>
          <div class="tlabel">${r.training_events?.title||r.event_code}</div>
          <div class="small">${r.training_events?.description||''}</div>
          <div class="small">${ok?'Completed':'Pending'}</div>
        </div>
      </div>`;
    }).join('');
  }

  $('#btnReloadTL').onclick=()=>loadTimeline($('#certSelect').value);
  $('#certSelect').onchange=()=>loadTimeline($('#certSelect').value);
  await loadProgress();
  await loadCerts();
});
</script>
</body>
</html>