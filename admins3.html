<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>JMBN – Contracts (Hauling / Objective Scan)</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png"
      href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png"
      sizes="32x32">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--card:#141414;--row:#0a0a0a;
  --border:#d6b44c;--accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;
  --fs-base:14px;--fs-small:11px;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Play',system-ui,sans-serif;
  background:radial-gradient(circle at top,#202020 0,#000 55%);
  color:var(--text);
}
.page{
  min-height:100vh;
  padding:18px;
  max-width:1200px;
  margin:0 auto;
}

/* Brand */
.brand{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:10px;
  padding-bottom:8px;
  margin-bottom:12px;
  border-bottom:1px solid var(--border);
}
.brand-main{
  display:flex;
  align-items:center;
  gap:10px;
}
.brand-logo{
  width:44px;height:44px;object-fit:contain;
  filter:drop-shadow(0 0 5px rgba(242,214,117,.3));
}
.brand-title-wrap h1{
  margin:0 0 2px;
  font-size:clamp(18px,2.3vw,22px);
  letter-spacing:.12em;
  text-transform:uppercase;
  color:var(--accent);
}
.brand-subtitle{
  font-size:12px;
  color:var(--muted);
}
.brand-tag{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.18em;
  color:var(--muted);
  border:1px solid var(--border);
  padding:4px 8px;
  border-radius:999px;
}

/* Layout */
.grid{
  display:grid;
  grid-template-columns:minmax(0,1.1fr) minmax(0,1.1fr);
  gap:16px;
}
@media (max-width:900px){
  .grid{grid-template-columns:1fr;}
}
.panel{
  background:linear-gradient(135deg,rgba(214,180,76,.05),transparent);
  border:1px solid rgba(214,180,76,.4);
  border-radius:16px;
  padding:14px 14px 16px;
  box-shadow:0 0 20px rgba(0,0,0,.7);
}
.panel-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
.panel-title{
  font-size:14px;
  text-transform:uppercase;
  letter-spacing:.18em;
  color:var(--accent);
}
.panel-meta{
  font-size:11px;
  color:var(--muted);
}

/* Upload / paste */
.upload-box{
  border:1px dashed rgba(214,180,76,.55);
  border-radius:12px;
  padding:10px;
  background:rgba(5,5,5,.75);
  display:flex;
  flex-direction:column;
  gap:8px;
}
.upload-row{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
}
input[type="file"]{
  font-size:var(--fs-small);
  color:var(--muted);
}
.btn{
  appearance:none;
  border:none;
  outline:none;
  cursor:pointer;
  font-family:inherit;
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:.16em;
  padding:7px 14px;
  border-radius:999px;
  border:1px solid var(--border);
  background:radial-gradient(circle at top,var(--accent),#614c14);
  color:#000;
  box-shadow:0 0 12px rgba(242,214,117,.35);
  display:inline-flex;
  align-items:center;
  gap:6px;
}
.btn-secondary{
  background:transparent;
  color:var(--accent);
  box-shadow:none;
}
.btn:disabled{
  opacity:.4;
  cursor:default;
  box-shadow:none;
}
.status{
  font-size:11px;
  color:var(--muted);
}
.status-ok{color:var(--accent);}
.status-err{color:var(--bad);}

/* Preview + OCR */
.preview-wrap{
  display:flex;
  gap:10px;
  align-items:flex-start;
  margin-top:8px;
}
.preview{
  flex:0 0 190px;
  max-height:190px;
  border-radius:10px;
  border:1px solid rgba(214,180,76,.45);
  overflow:hidden;
  background:#000;
}
.preview img{
  width:100%;
  height:100%;
  object-fit:cover;
}
.ocr-raw{
  flex:1;
  min-height:90px;
  max-height:190px;
  background:#050505;
  border-radius:10px;
  border:1px solid rgba(214,180,76,.25);
  padding:8px;
  font-size:11px;
  color:var(--muted);
  white-space:pre-wrap;
  overflow:auto;
}

/* Form & KPIs */
.form-grid{
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:10px 12px;
}
@media (max-width:700px){
  .form-grid{grid-template-columns:1fr;}
}
.form-field{
  display:flex;
  flex-direction:column;
  gap:3px;
}
label{
  font-size:11px;
  text-transform:uppercase;
  letter-spacing:.16em;
  color:var(--muted);
}
input[type="text"],
input[type="number"],
input[type="datetime-local"],
select,
textarea{
  background:var(--card);
  border-radius:8px;
  border:1px solid rgba(214,180,76,.4);
  padding:7px 8px;
  font-size:var(--fs-base);
  color:var(--text);
  font-family:inherit;
}
input::placeholder,textarea::placeholder{color:#75653a;}
textarea{
  min-height:70px;
  resize:vertical;
}
.form-actions{
  margin-top:10px;
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}
.kpi-row{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-bottom:8px;
}
.kpi{
  flex:1 1 120px;
  min-width:0;
  border-radius:10px;
  padding:6px 8px;
  border:1px solid rgba(214,180,76,.5);
  background:radial-gradient(circle at top,rgba(242,214,117,.2),rgba(10,10,10,.9));
  font-size:11px;
}
.kpi-label{
  text-transform:uppercase;
  letter-spacing:.16em;
  color:var(--muted);
  margin-bottom:2px;
}
.kpi-value{
  font-size:13px;
}

/* Objectives table */
.table-wrap{
  margin-top:10px;
  border-radius:12px;
  border:1px solid rgba(214,180,76,.55);
  overflow:hidden;
  background:rgba(5,5,5,.9);
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:var(--fs-small);
}
thead{
  background:linear-gradient(90deg,rgba(214,180,76,.2),rgba(10,10,10,1));
}
th,td{
  padding:6px 8px;
  text-align:left;
}
th{
  text-transform:uppercase;
  letter-spacing:.14em;
  font-weight:700;
  color:var(--accent);
  border-bottom:1px solid rgba(214,180,76,.45);
}
tbody tr:nth-child(odd){background:var(--row);}
tbody tr:nth-child(even){background:#050505;}

.badge{
  display:inline-block;
  padding:2px 6px;
  border-radius:999px;
  border:1px solid rgba(214,180,76,.7);
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:.14em;
}
.badge-contract{color:var(--accent);}
</style>
</head>
<body>
<div class="page">
  <!-- Brand -->
  <header class="brand">
    <div class="brand-main">
      <img class="brand-logo" src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" alt="JMBN">
      <div class="brand-title-wrap">
        <h1>JMBN // CONTRACTS</h1>
        <div class="brand-subtitle">Objective Scanner • Hauling / Waste / Scrap</div>
      </div>
    </div>
    <div class="brand-tag">OPS // CONTRACT INTAKE</div>
  </header>

  <div class="grid">
    <!-- LEFT: screenshot intake -->
    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">Screenshot Intake</div>
        <div class="panel-meta">Paste (Ctrl+V) or upload contract screenshot</div>
      </div>

      <div class="upload-box" id="pasteZone">
        <div class="upload-row">
          <input type="file" id="screenshotInput" accept="image/*">
          <button class="btn" id="scanBtn">Scan Image</button>
          <button class="btn btn-secondary" id="clearBtn" type="button">Clear</button>
        </div>
        <div class="status" id="statusLine">
          Tip: Use <b>Win+Shift+S</b> in-game to snip the contract, then click this box and press <b>Ctrl+V</b>.
        </div>
      </div>

      <div class="preview-wrap">
        <div class="preview">
          <img id="previewImg" alt="Screenshot preview" style="display:none;">
        </div>
        <div class="ocr-raw" id="ocrOutput"></div>
      </div>
    </section>

    <!-- RIGHT: contract form -->
    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">Contract Edit</div>
        <div class="panel-meta">Auto-filled from contract text • Manually adjustable</div>
      </div>

      <div class="kpi-row">
        <div class="kpi">
          <div class="kpi-label">Contract Reward</div>
          <div class="kpi-value" id="kpiReward">—</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Availability</div>
          <div class="kpi-value" id="kpiAvail">—</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Contracted By</div>
          <div class="kpi-value" id="kpiContractor">—</div>
        </div>
      </div>

      <form id="contractForm">
        <div class="form-grid">
          <div class="form-field">
            <label for="contractId">Contract ID / Ref</label>
            <input id="contractId" type="text" placeholder="e.g. AUTO-SCAN-001">
          </div>
          <div class="form-field">
            <label for="missionName">Mission Name</label>
            <input id="missionName" type="text" placeholder="e.g. Waste Collection – CRU-L1 & CRU-L4">
          </div>

          <div class="form-field">
            <label for="reward">Reward (aUEC)</label>
            <input id="reward" type="number" min="0" step="1" placeholder="42000">
          </div>
          <div class="form-field">
            <label for="contractor">Contracted By</label>
            <input id="contractor" type="text" placeholder="e.g. Covalex Independent Contractors">
          </div>

          <div class="form-field">
            <label for="origin">Primary Origin</label>
            <input id="origin" type="text" placeholder="e.g. CRU-L1 Ambitious Dream Station">
          </div>
          <div class="form-field">
            <label for="destination">Primary Destination</label>
            <input id="destination" type="text" placeholder="e.g. Seraphim Station">
          </div>

          <div class="form-field">
            <label for="cargoType">Cargo Type</label>
            <input id="cargoType" type="text" placeholder="Waste / Scrap / Boxes">
          </div>
          <div class="form-field">
            <label for="requiredSCU">Required SCU (per leg)</label>
            <input id="requiredSCU" type="number" min="0" step="1" placeholder="2">
          </div>

          <div class="form-field">
            <label for="availability">Contract Availability</label>
            <input id="availability" type="text" placeholder="e.g. 2h 9m">
          </div>
          <div class="form-field">
            <label for="timestamp">Timestamp (logged)</label>
            <input id="timestamp" type="datetime-local">
          </div>
        </div>

        <div class="form-field" style="margin-top:8px;">
          <label for="notes">Notes</label>
          <textarea id="notes" placeholder="Multi-leg contract, number of stations, sharing rules, etc."></textarea>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn">Save (local only)</button>
          <button type="button" class="btn btn-secondary" id="resetBtn">Reset Form</button>
        </div>
      </form>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:16%;">Cargo</th>
              <th style="width:30%;">Origin</th>
              <th style="width:12%;">Req. SCU</th>
              <th style="width:30%;">Destination</th>
              <th>Leg</th>
            </tr>
          </thead>
          <tbody id="objectivesBody">
            <!-- Auto-filled from parsed objectives -->
          </tbody>
        </table>
      </div>
    </section>
  </div>
</div>

<!-- Tesseract.js -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
(function(){
  const screenshotInput = document.getElementById('screenshotInput');
  const scanBtn         = document.getElementById('scanBtn');
  const clearBtn        = document.getElementById('clearBtn');
  const pasteZone       = document.getElementById('pasteZone');
  const statusLine      = document.getElementById('statusLine');
  const previewImg      = document.getElementById('previewImg');
  const ocrOutput       = document.getElementById('ocrOutput');

  const rewardField     = document.getElementById('reward');
  const contractorField = document.getElementById('contractor');
  const availabilityFld = document.getElementById('availability');
  const originField     = document.getElementById('origin');
  const destField       = document.getElementById('destination');
  const cargoField      = document.getElementById('cargoType');
  const reqSCUField     = document.getElementById('requiredSCU');
  const tsField         = document.getElementById('timestamp');

  const kpiReward       = document.getElementById('kpiReward');
  const kpiAvail        = document.getElementById('kpiAvail');
  const kpiContractor   = document.getElementById('kpiContractor');
  const objectivesBody  = document.getElementById('objectivesBody');
  const contractForm    = document.getElementById('contractForm');
  const resetBtn        = document.getElementById('resetBtn');

  function setStatus(text,type){
    statusLine.textContent = text;
    statusLine.classList.remove('status-ok','status-err');
    if(type==='ok')  statusLine.classList.add('status-ok');
    if(type==='err') statusLine.classList.add('status-err');
  }

  function loadPreviewFromBlob(blob){
    const reader = new FileReader();
    reader.onload = e=>{
      previewImg.src = e.target.result;
      previewImg.style.display = 'block';
    };
    reader.readAsDataURL(blob);
  }

  // === Parsing helpers for your contract screenshot ===
  function parseHeader(text){
    const header = { reward:null, availability:null, contractor:null };

    // Reward 42,000
    let m = text.match(/Reward\s+([\d,]+)/i);
    if(m && m[1]) header.reward = m[1].replace(/,/g,'');

    // Contract Availability 2h 9m
    m = text.match(/Contract\s+Availability\s+([0-9hHmM\s]+)/i);
    if(m && m[1]) header.availability = m[1].trim();

    // Contracted By Covalex Independent Contractors
    m = text.match(/Contracted\s+By\s+(.+)/i);
    if(m && m[1]) header.contractor = m[1].trim();

    return header;
  }

  function parseObjectives(text){
    const cleaned = text.replace(/\r/g,''); // normalise line breaks
    const regex = /Collect\s+(\w+)\s+from\s+(.+?)\.\s*[\n\s]*Deliver\s+(\d+)\/(\d+)\s*SCU\s+to\s+(.+?)\./gi;
    const result = [];
    let m;
    let leg = 1;
    while((m = regex.exec(cleaned)) !== null){
      const cargoType   = m[1];                // Waste / Scrap
      const origin      = m[2].trim();
      const delivered   = parseInt(m[3],10);   // 0
      const required    = parseInt(m[4],10);   // 2 / 3
      const destination = m[5].trim();

      result.push({
        cargoType,
        origin,
        delivered,
        required,
        destination,
        leg: leg++
      });
    }
    return result;
  }

  function fillObjectivesTable(objectives){
    objectivesBody.innerHTML = '';
    objectives.forEach(obj=>{
      const tr  = document.createElement('tr');

      const tdC = document.createElement('td');
      tdC.textContent = obj.cargoType;
      tr.appendChild(tdC);

      const tdO = document.createElement('td');
      tdO.textContent = obj.origin;
      tr.appendChild(tdO);

      const tdS = document.createElement('td');
      tdS.textContent = obj.required;
      tr.appendChild(tdS);

      const tdD = document.createElement('td');
      tdD.textContent = obj.destination;
      tr.appendChild(tdD);

      const tdL = document.createElement('td');
      const badge = document.createElement('span');
      badge.className = 'badge badge-contract';
      badge.textContent = 'LEG ' + obj.leg;
      tdL.appendChild(badge);
      tr.appendChild(tdL);

      objectivesBody.appendChild(tr);
    });
  }

  function applyDetections(text){
    const header = parseHeader(text);
    const objectives = parseObjectives(text);

    // Header → form + KPIs
    if(header.reward){
      rewardField.value = header.reward;
      kpiReward.textContent = Number(header.reward).toLocaleString();
    } else {
      kpiReward.textContent = '—';
    }

    if(header.availability){
      availabilityFld.value = header.availability;
      kpiAvail.textContent  = header.availability;
    } else {
      kpiAvail.textContent = '—';
    }

    if(header.contractor){
      contractorField.value = header.contractor;
      kpiContractor.textContent = header.contractor;
    } else {
      kpiContractor.textContent = '—';
    }

    // Objectives
    fillObjectivesTable(objectives);

    if(objectives.length > 0){
      const first = objectives[0];
      cargoField.value  = first.cargoType;
      originField.value = first.origin;
      destField.value   = first.destination;
      reqSCUField.value = first.required;
    }

    // Default timestamp if empty
    if(!tsField.value){
      const now = new Date();
      const pad = n=>String(n).padStart(2,'0');
      tsField.value = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
    }
  }

  async function runOCROnBlob(blob){
    ocrOutput.textContent = '';
    setStatus('Scanning image…', 'ok');
    scanBtn.disabled = true;

    try{
      const { data:{ text } } = await Tesseract.recognize(blob,'eng',{
        logger:m=>{
          if(m.status === 'recognizing text'){
            const pct = Math.round((m.progress || 0)*100);
            setStatus(`Recognising text… ${pct}%`, 'ok');
          }
        }
      });
      const trimmed = text.trim();
      ocrOutput.textContent = trimmed;
      setStatus('Scan complete. Parsed values applied – please double-check.', 'ok');
      applyDetections(trimmed);
    }catch(err){
      console.error(err);
      setStatus('Error during OCR. Try a clearer / higher-res screenshot.', 'err');
    }finally{
      scanBtn.disabled = false;
    }
  }

  // === Handlers ===
  scanBtn.addEventListener('click',()=>{
    const file = screenshotInput.files && screenshotInput.files[0];
    if(!file){
      setStatus('No file selected. Either choose an image or paste with Ctrl+V.', 'err');
      return;
    }
    loadPreviewFromBlob(file);
    runOCROnBlob(file);
  });

  clearBtn.addEventListener('click',()=>{
    screenshotInput.value = '';
    previewImg.src = '';
    previewImg.style.display = 'none';
    ocrOutput.textContent = '';
    objectivesBody.innerHTML = '';
    setStatus('Cleared image and OCR output.', 'ok');
  });

  // Paste support: user can Ctrl+V an image directly
  pasteZone.addEventListener('click',()=>pasteZone.focus());
  window.addEventListener('paste',e=>{
    const items = e.clipboardData && e.clipboardData.items;
    if(!items) return;

    for(let i=0;i<items.length;i++){
      const item = items[i];
      if(item.type && item.type.startsWith('image/')){
        const blob = item.getAsFile();
        if(blob){
          e.preventDefault();
          loadPreviewFromBlob(blob);
          setStatus('Pasted image detected – scanning…', 'ok');
          runOCROnBlob(blob);
        }
        break;
      }
    }
  });

  // Form reset
  resetBtn.addEventListener('click',()=>{
    contractForm.reset();
    kpiReward.textContent     = '—';
    kpiAvail.textContent      = '—';
    kpiContractor.textContent = '—';
    objectivesBody.innerHTML  = '';
    setStatus('Form reset. Screenshot data remains until you clear it.', 'ok');
  });

  // Dummy submit (you can later wire to Supabase)
  contractForm.addEventListener('submit',e=>{
    e.preventDefault();
    setStatus('Saved (locally only for now). Hook this into Supabase when ready.', 'ok');
  });
})();
</script>
</body>
</html>
