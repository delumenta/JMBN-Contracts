<!-- ðŸ” Auth -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>

<script>
/* Active nav highlight */
(function(){
  const here=location.pathname.split('/').pop()||'components.html';
  document.querySelectorAll('.nav-btn').forEach(a=>{
    if(a.getAttribute('href')===here){a.classList.add('active');a.setAttribute('aria-current','page');}
  });
})();

/* === Config & helpers === */
const JSON_URL = 'data/components.js';   // your components JSON

const $  = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const uid = () => 'CMP-' + Math.random().toString(36).slice(2,8);
function esc(s=''){ const d=document.createElement('div'); d.textContent = s ?? ''; return d.innerHTML; }

let components = [];
let editId = null;

/* Map JSON entry -> internal shape */
function mapJsonComponent(c){
  // Clean size: "S  2" -> "S2"
  let size = c.size || '';
  if (size) size = size.replace(/\s+/g, '');

  // Normalise grade: "A" -> "Grade A"
  let grade = c.grade || '';
  if (grade && !/^grade/i.test(grade)) grade = 'Grade ' + grade;

  return {
    id: c.id || uid(),
    name: c.name || '',
    type: c.type || '',
    size,
    grade,
    class: c.class || '',
    manufacturer: c.manufacturer || '',
    buy: c.buy || '',
    notes: c.notes || ''
  };
}

/* === Load from JSON file === */
async function loadFromJSON(){
  try{
    const res = await fetch(JSON_URL, { cache:'no-cache' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const json = await res.json();
    if (!Array.isArray(json)) throw new Error('Expected array in ' + JSON_URL);

    components = json.map(mapJsonComponent);
    render();
    populateFilters();
    updateKPI();
    const ls = $('#lastSaved');
    if(ls) ls.textContent = 'Loaded from JSON';
  }catch(err){
    console.error('Failed to load components JSON:', err);
    components = [];
    render();
    populateFilters();
    updateKPI();
    const ls = $('#lastSaved');
    if(ls) ls.textContent = 'Error loading JSON';
    alert('Failed to load components from data/components.js');
  }
}

/* === Form helpers === */
function getForm(){
  return {
    id: editId || uid(),
    name: $('#compName').value.trim(),
    type: $('#compType').value,
    size: $('#compSize').value,
    grade: $('#compGrade').value,
    class: $('#compClass').value,
    manufacturer: $('#compManufacturer').value.trim(),
    buy: $('#compBuy').value.trim(),
    notes: $('#compNotes').value.trim()
  };
}

function clearForm(){
  editId = null;
  ['compName','compManufacturer','compBuy','compNotes'].forEach(id => $('#'+id).value = '');
  ['compType','compSize','compGrade','compClass'].forEach(id => $('#'+id).selectedIndex = 0);
  $('#saveComponent').textContent = 'Save Component';
}

function fillForm(c){
  editId = c.id;
  $('#compName').value = c.name || '';
  $('#compType').value = c.type || 'Quantum Drive';
  $('#compSize').value = c.size || 'S1';
  $('#compGrade').value = c.grade || 'Grade A';
  $('#compClass').value = c.class || 'Civilian';
  $('#compManufacturer').value = c.manufacturer || '';
  $('#compBuy').value = c.buy || '';
  $('#compNotes').value = c.notes || '';
  $('#saveComponent').textContent = 'Update Component';
}

/* === Save button (no local storage) === */
$('#saveComponent').onclick = () => {
  const c = getForm();
  if (!c.name){
    alert('Name is required');
    return;
  }
  const idx = components.findIndex(x => x.id === c.id);
  if (idx >= 0) components[idx] = c;
  else components.push(c);

  render();
  populateFilters();
  updateKPI();
  clearForm();

  const ls = $('#lastSaved');
  if(ls) ls.textContent = 'Modified (not persisted)';
};

/* Top "Save" button â€“ just info now */
$('#saveBtn').onclick = () => {
  alert('There is no local storage save.\nUse Export JSON to download your current list.');
};

/* Reset -> reload from JSON file */
$('#resetBtn').onclick = async () => {
  if (!confirm('Reset and reload from data/components.js? All unsaved edits will be lost.')) return;
  await loadFromJSON();
};

/* === Filters === */
function distinct(arr, key){
  return [...new Set(arr.map(x => x[key]).filter(Boolean))].sort();
}
function fillSelect(sel, values){
  const prev = sel.value;
  sel.innerHTML = '<option value="">All</option>' +
    values.map(v => `<option>${esc(v)}</option>`).join('');
  if (values.includes(prev)) sel.value = prev;
}

function populateFilters(){
  fillSelect($('#filterType'),  distinct(components,'type'));
  fillSelect($('#filterClass'), distinct(components,'class'));
  fillSelect($('#filterGrade'), distinct(components,'grade'));
  fillSelect($('#filterSize'),  distinct(components,'size'));
}

['search','filterType','filterClass','filterGrade','filterSize'].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener('input', render);
});

/* === Render table === */
function render(){
  const q  = ($('#search').value || '').toLowerCase().trim();
  const ft = $('#filterType').value;
  const fc = $('#filterClass').value;
  const fg = $('#filterGrade').value;
  const fs = $('#filterSize').value;

  let arr = components.slice();

  if (q){
    arr = arr.filter(c =>
      `${c.name} ${c.manufacturer} ${c.buy} ${c.notes}`.toLowerCase().includes(q)
    );
  }
  if (ft) arr = arr.filter(c => c.type  === ft);
  if (fc) arr = arr.filter(c => c.class === fc);
  if (fg) arr = arr.filter(c => c.grade === fg);
  if (fs) arr = arr.filter(c => c.size  === fs);

  $('#rows').innerHTML = arr.map(c => `
    <tr>
      <td><b style="color:var(--accent)">${esc(c.name)}</b></td>
      <td>${esc(c.type || '')}</td>
      <td>${esc(c.size || '')}</td>
      <td>${esc(c.grade || '')}</td>
      <td>${esc(c.class || '')}</td>
      <td>${esc(c.manufacturer || '')}</td>
      <td>${esc(c.buy || '')}</td>
      <td>${esc(c.notes || '')}</td>
      <td style="white-space:nowrap">
        <button data-act="edit" data-id="${c.id}">Edit</button>
        <button data-act="del"  data-id="${c.id}" style="border-color:var(--bad);color:var(--bad)">Del</button>
      </td>
    </tr>
  `).join('');

  $$('#rows button[data-act]').forEach(btn => {
    const id = btn.dataset.id;
    if (btn.dataset.act === 'edit'){
      btn.onclick = () => {
        const c = components.find(x => x.id === id);
        if (c) fillForm(c);
      };
    }
    if (btn.dataset.act === 'del'){
      btn.onclick = () => {
        if (!confirm('Delete this component?')) return;
        components = components.filter(x => x.id !== id);
        render();
        populateFilters();
        updateKPI();
      };
    }
  });
}

/* === KPIs === */
function updateKPI(){
  $('#kpiCount').textContent = String(components.length);
  const byType = {};
  components.forEach(c => { byType[c.type] = (byType[c.type] || 0) + 1; });
  const top = Object.entries(byType)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,3)
    .map(([k,v]) => `${k}: ${v}`)
    .join(' â€¢ ') || 'â€”';
  $('#kpiType').textContent = top;
}

/* === Export / Import === */
function exportJSON(){
  const blob = new Blob([JSON.stringify(components,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'jmbn-components.json';
  a.click();
  URL.revokeObjectURL(url);
}
function exportCSV(){
  const headers = ['name','type','size','grade','class','manufacturer','buy','notes'];
  const rows = components.map(c => headers.map(h => String(c[h] ?? '')));
  const csv = [
    headers.join(','),
    ...rows.map(r => '"' + r.map(s => s.replace(/"/g,'""')).join('","') + '"')
  ].join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'jmbn-components.csv';
  a.click();
  URL.revokeObjectURL(url);
}
$('#exportJSON').onclick = exportJSON;
$('#exportCSV').onclick = exportCSV;

function importJSON(){
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = 'application/json';
  inp.onchange = () => {
    const f = inp.files?.[0];
    if (!f) return;
    const r = new FileReader();
    r.onload = () => {
      try{
        const arr = JSON.parse(r.result);
        if (!Array.isArray(arr)) throw new Error('Expected an array');
        arr.forEach(x => { if (!x.id) x.id = uid(); });
        if (confirm('Merge with existing? (Cancel = Replace)')){
          const map = new Map(components.map(x => [x.id, x]));
          for (const x of arr){ map.set(x.id, x); }
          components = [...map.values()];
        }else{
          components = arr;
        }
        render();
        populateFilters();
        updateKPI();
        const ls = $('#lastSaved');
        if(ls) ls.textContent = 'Imported (not persisted)';
        alert('Import complete.');
      }catch(e){
        alert('Import failed: ' + e.message);
      }
    };
    r.readAsText(f);
  };
  inp.click();
}
$('#importJSON').onclick = importJSON;

/* Init (protected) */
document.addEventListener('DOMContentLoaded', async () => {
  const session = await requireAuth();   // redirects to auth.html if not logged in
  if (!session) return;
  await loadFromJSON();
});
</script>
