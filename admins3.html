<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Components</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png"
      href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png/v1/fill/w_66,h_66,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/0_New_JMBN_Logo_Gold.png">
<style>
:root{
  --bg:#000;--panel:#0b0b0b;--border:#d6b44c;--card:#141414;
  --accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;
  --fs-base:14px;--fs-small:11px;--fs-table:13px;--fs-h1:clamp(18px,2.2vw,22px);--fs-h2:clamp(14px,1.6vw,16px)
}
*{box-sizing:border-box}
body{
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text);font-family:'Play',sans-serif;margin:0;padding:14px;letter-spacing:.25px;font-size:var(--fs-base)
}

/* Header */
.brand{display:flex;align-items:center;gap:10px;margin:0 0 8px;border-bottom:1px solid var(--border);padding-bottom:6px}
.brand-logo{width:44px;height:44px;object-fit:contain;filter:drop-shadow(0 0 4px rgba(242,214,117,.25))}
.brand h1{font-weight:700;font-size:var(--fs-h1);color:var(--accent);margin:0}

/* Shiny pill nav */
.nav{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
.nav-btn{
  --gold:#f2d675;--gold2:#e7c760;--ring:#d6b44c;
  position:relative;display:inline-flex;align-items:center;justify-content:center;
  padding:7px 14px;border:1px solid var(--ring);border-radius:999px;
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);text-decoration:none;font-weight:700;
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.12);
  transition:transform .15s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
}
.nav-btn:hover{transform:translateY(-1px);box-shadow:0 0 12px rgba(214,180,76,.25), inset 0 0 0 1px rgba(214,180,76,.18);background:linear-gradient(180deg,#1a1a1a,#0a0a0a)}
.nav-btn.active{
  color:#000;background:linear-gradient(180deg,var(--gold),var(--gold2));
  border-color:var(--ring);box-shadow:0 0 20px rgba(214,180,76,.45);
}
.nav-btn.active::after{
  content:"";position:absolute;inset:0;background:linear-gradient(120deg,rgba(255,255,255,0) 30%,rgba(255,255,255,.3) 50%,rgba(255,255,255,0) 70%);
  border-radius:inherit;transform:translateX(-120%);animation:shine 2.8s ease-in-out infinite;pointer-events:none;
}
@keyframes shine{0%{transform:translateX(-120%)}35%{transform:translateX(120%)}100%{transform:translateX(120%)}}

/* Layout + table */
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:8px;box-shadow:0 0 18px rgba(214,180,76,.22)}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
button{padding:7px 11px;border-radius:10px;background:linear-gradient(180deg,#0c0c0c,#060606);color:var(--accent);border:1px solid var(--border);cursor:pointer;font-family:'Play';transition:.2s}
button:hover{background:var(--accent);color:#000}
.btn-primary{background:var(--accent);color:#000}
input,select{background:#0a0a0a;border:1px solid var(--border);border-radius:8px;padding:9px;color:var(--text);font-size:var(--fs-table);font-family:'Play'}
input[readonly]{opacity:.7}

/* KPI cards */
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:10px 0}
.kpi-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;text-align:center}
.kpi-card h3{margin:0;color:var(--muted);font-size:11px;text-transform:uppercase}
.kpi-card .val{font-weight:700;font-size:18px;color:var(--accent);margin-top:4px}
.kpi-card .sub{font-size:11px;color:var(--muted);margin-top:4px}

/* Form */
h2{margin:8px 0 4px;color:var(--accent);font-size:var(--fs-h2)}
.form-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:10px 0}
@media(max-width:980px){.form-grid{grid-template-columns:1fr 1fr}}
@media(max-width:640px){.form-grid{grid-template-columns:1fr}}
.form-grid label{display:flex;flex-direction:column;gap:4px;font-size:var(--fs-small);color:var(--muted)}

/* Table */
.tableWrap{border:1px solid var(--border);border-radius:12px;overflow:auto;max-height:70vh;margin-top:10px}
table{width:100%;border-collapse:collapse;font-size:var(--fs-table)}
th,td{border-bottom:1px solid rgba(214,180,76,.3);padding:8px;text-align:left}
th{color:var(--accent);background:#080808;font-weight:500;font-size:12px;position:sticky;top:0;z-index:1}
tr:nth-child(even){background:#111}
tr:hover{background:rgba(214,180,76,.08)}
.small{font-size:var(--fs-small);color:var(--muted)}
.badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:11px;color:var(--muted);background:#0c0c0c}
.actions-cell button{font-size:11px;padding:4px 8px;margin-right:4px}
.actions-cell button.delete{border-color:var(--bad);color:var(--bad)}
.actions-cell button.delete:hover{background:var(--bad);color:#000}
.muted{color:var(--muted);font-size:var(--fs-small);margin-top:4px}
</style>
</head>
<body>
  <div class="brand">
    <img class="brand-logo" src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png/v1/fill/w_66,h_66,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/0_New_JMBN_Logo_Gold.png" alt="JMBN">
    <h1>JMBN Components</h1>
  </div>

  <nav class="nav">
    <a class="nav-btn" href="index.html">Manifest</a>
    <a class="nav-btn" href="hangar.html">Hangar</a>
    <a class="nav-btn active" href="components.html">Components</a>
    <a class="nav-btn" href="contracts.html">Contracts</a>
    <a class="nav-btn" href="mission-log.html">Mission Log</a>
  </nav>

  <div class="panel">
    <div class="controls">
      <input id="search" placeholder="Search (name, manufacturer, type, notes)…">
      <select id="filterType"><option value="">All Types</option></select>
      <select id="filterClass"><option value="">All Classes</option></select>
      <select id="filterGrade"><option value="">All Grades</option></select>
      <select id="filterSize"><option value="">All Sizes</option></select>
      <button id="saveBtn">Save</button>
      <button id="resetBtn" style="border-color:var(--bad);color:var(--bad)">Reset (Factory)</button>
      <button id="exportJSON">Export JSON</button>
      <button id="exportCSV">Export CSV</button>
      <button class="btn-primary" id="importJSON">Import JSON</button>
      <input id="importFile" type="file" accept="application/json" style="display:none">
    </div>

    <div class="kpis">
      <div class="kpi-card">
        <h3>Total Components</h3>
        <div class="val" id="kpiCount">0</div>
        <div class="sub" id="kpiCountSub">after filters</div>
      </div>
      <div class="kpi-card">
        <h3>By Type</h3>
        <div class="val small" id="kpiType">—</div>
      </div>
      <div class="kpi-card">
        <h3>Last Saved</h3>
        <div class="val" id="lastSaved">Never</div>
        <div class="sub small">Local browser storage</div>
      </div>
    </div>

    <h2>Add / Edit Component</h2>
    <div class="form-grid">
      <label>Name *
        <input id="compName" placeholder="e.g., XL-1">
      </label>
      <label>Type
        <select id="compType">
          <option>Quantum Drive</option><option>Shield Generator</option><option>Power Plant</option><option>Cooler</option>
          <option>Computer</option><option>Radar</option><option>Weapon Mount</option><option>Missile Rack</option>
        </select>
      </label>
      <label>Size
        <select id="compSize">
          <option value="">—</option>
          <option>S1</option><option>S2</option><option>S3</option><option>S4</option><option>S5</option><option>S6</option><option>S7</option><option>S8</option>
        </select>
      </label>
      <label>Grade
        <select id="compGrade">
          <option value="">—</option>
          <option>Grade 1</option><option>Grade 2</option><option>Grade 3</option><option>Grade 4</option>
        </select>
      </label>
      <label>Class
        <select id="compClass">
          <option value="">—</option>
          <option>Civilian</option><option>Industrial</option><option>Stealth</option><option>Competition</option><option>Military</option>
        </select>
      </label>
      <label>Manufacturer
        <input id="compManufacturer" placeholder="e.g., Wei-Tek">
      </label>
      <label>Where to Buy
        <input id="compBuy" placeholder="e.g., HUR-L5 • Platinum Bay">
      </label>
      <label>Notes
        <input id="compNotes" placeholder="e.g., Best long-range QD, high fuel cost">
      </label>
      <label style="grid-column:1/-1">Internal ID
        <input id="compId" readonly placeholder="Auto-generated when saving">
      </label>
      <button class="btn-primary" id="saveComponent" style="grid-column:1/-1">Save Component</button>
    </div>
    <div class="muted">ℹ️ Factory list is built from <span class="badge">ship-items.json</span> (scunpacked). Reset will re-pull from GitHub.</div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Type</th>
            <th>Size</th>
            <th>Grade</th>
            <th>Class</th>
            <th>Manufacturer</th>
            <th>Where to Buy</th>
            <th>Notes</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

<script>
/* ===== Config ===== */
const STORE_KEY = 'jmbn-components-v2';   // bumped version since we changed structure
const SRC_URL = 'https://raw.githubusercontent.com/delumenta/scunpacked-data/refs/heads/master/ship-items.json';

const CATEGORY_MATCH = {
  "Quantum Drive": "QuantumDrive",
  "Shield Generator": "Shield",
  "Power Plant": "PowerPlant",
  "Cooler": "Cooler",
  "Computer": "Computer",
  "Radar": "Radar",
  "Weapon Mount": "WeaponMount",
  "Missile Rack": "MissileRack"
};

/* ===== DOM helpers ===== */
const $ = s => document.querySelector(s);
const rowsEl = $('#rows');
const searchEl = $('#search');
const filterTypeEl = $('#filterType');
const filterClassEl = $('#filterClass');
const filterGradeEl = $('#filterGrade');
const filterSizeEl = $('#filterSize');
const kpiCountEl = $('#kpiCount');
const kpiCountSubEl = $('#kpiCountSub');
const kpiTypeEl = $('#kpiType');
const lastSavedEl = $('#lastSaved');

/* Form fields */
const compNameEl = $('#compName');
const compTypeEl = $('#compType');
const compSizeEl = $('#compSize');
const compGradeEl = $('#compGrade');
const compClassEl = $('#compClass');
const compManufacturerEl = $('#compManufacturer');
const compBuyEl = $('#compBuy');
const compNotesEl = $('#compNotes');
const compIdEl = $('#compId');

/* State */
let factoryComponents = [];   // built from GitHub JSON
let components = [];          // active list (maybe user-modified)

/* Utility */
const uid = () => 'CMP-' + Math.random().toString(36).slice(2,10);
const esc = (s='') => {
  const d=document.createElement('div');
  d.textContent = s ?? '';
  return d.innerHTML;
};
const niceDateTime = ts => ts ? new Date(ts).toLocaleString() : 'Never';

/* ===== Data pipeline: build from ship-items.json ===== */
function buildFromRaw(raw) {
  const out = [];
  for (const item of raw) {
    const std = item.stdItem || {};
    const typeStr = std.Type || '';
    let matchedLabel = null;

    for (const [label, token] of Object.entries(CATEGORY_MATCH)) {
      if (typeStr.includes(token)) {
        matchedLabel = label;
        break;
      }
    }
    if (!matchedLabel) continue; // skip things we don't care about

    let name = item.name && item.name !== '<= PLACEHOLDER =>'
      ? item.name
      : (item.itemName || '');

    if (!name) continue;

    const manufacturer = item.manufacturer || std.Manufacturer || '';
    const sizeVal = item.size;
    const size = (sizeVal !== undefined && sizeVal !== null && sizeVal !== '')
      ? 'S' + sizeVal
      : '';

    const gradeVal = (item.grade !== undefined && item.grade !== null)
      ? item.grade
      : (std.Grade !== undefined && std.Grade !== null ? std.Grade : null);
    const grade = gradeVal !== null && gradeVal !== undefined && gradeVal !== ''
      ? 'Grade ' + gradeVal
      : '';

    // Class is not directly encoded; leave blank and let user set it
    const cls = '';

    out.push({
      id: uid(),
      name,
      type: matchedLabel,
      size,
      grade,
      class: cls,
      manufacturer,
      buy: '',
      notes: ''
    });
  }

  // Sort nicely
  out.sort((a,b) => {
    if (a.type !== b.type) return a.type.localeCompare(b.type);
    if (a.size !== b.size) return a.size.localeCompare(b.size);
    return a.name.localeCompare(b.name);
  });

  return out;
}

/* ===== Rendering ===== */
function render() {
  const q = (searchEl.value || '').toLowerCase();
  const ft = filterTypeEl.value || '';
  const fc = filterClassEl.value || '';
  const fg = filterGradeEl.value || '';
  const fs = filterSizeEl.value || '';

  const filtered = components.filter(c => {
    if (ft && c.type !== ft) return false;
    if (fc && c.class !== fc) return false;
    if (fg && c.grade !== fg) return false;
    if (fs && c.size !== fs) return false;

    if (!q) return true;
    const hay = [
      c.name, c.type, c.class, c.grade,
      c.size, c.manufacturer, c.buy, c.notes
    ].join(' ').toLowerCase();
    return hay.includes(q);
  });

  rowsEl.innerHTML = filtered.map(c => `
    <tr>
      <td>${esc(c.name)}</td>
      <td>${esc(c.type)}</td>
      <td>${esc(c.size)}</td>
      <td>${esc(c.grade)}</td>
      <td>${esc(c.class)}</td>
      <td>${esc(c.manufacturer)}</td>
      <td>${esc(c.buy)}</td>
      <td>${esc(c.notes)}</td>
      <td class="actions-cell">
        <button data-id="${esc(c.id)}" data-action="edit">Edit</button>
        <button data-id="${esc(c.id)}" data-action="delete" class="delete">Delete</button>
      </td>
    </tr>
  `).join('') || `<tr><td colspan="9" class="small" style="padding:10px;">No components match your filters.</td></tr>`;

  // KPIs
  kpiCountEl.textContent = filtered.length;
  kpiCountSubEl.textContent = components.length
    ? `${filtered.length} of ${components.length} visible`
    : 'No data loaded';

  const byType = {};
  for (const c of filtered) {
    byType[c.type] = (byType[c.type] || 0) + 1;
  }
  const typeStr = Object.entries(byType)
    .sort((a,b)=>a[0].localeCompare(b[0]))
    .map(([t,n])=>`${t}: ${n}`)
    .join(' • ');
  kpiTypeEl.textContent = typeStr || '—';
}

function refreshFilters() {
  const types = new Set();
  const classes = new Set();
  const grades = new Set();
  const sizes = new Set();

  for (const c of components) {
    if (c.type) types.add(c.type);
    if (c.class) classes.add(c.class);
    if (c.grade) grades.add(c.grade);
    if (c.size) sizes.add(c.size);
  }

  function refill(selectEl, values, labelAll) {
    const current = selectEl.value;
    selectEl.innerHTML = '';
    const optAll = document.createElement('option');
    optAll.value = '';
    optAll.textContent = labelAll;
    selectEl.appendChild(optAll);
    Array.from(values).sort().forEach(v => {
      const o = document.createElement('option');
      o.value = v;
      o.textContent = v;
      selectEl.appendChild(o);
    });
    if (Array.from(values).includes(current)) {
      selectEl.value = current;
    }
  }

  refill(filterTypeEl, types, 'All Types');
  refill(filterClassEl, classes, 'All Classes');
  refill(filterGradeEl, grades, 'All Grades');
  refill(filterSizeEl, sizes, 'All Sizes');
}

/* ===== Form helpers ===== */
function clearForm() {
  compNameEl.value = '';
  compTypeEl.value = 'Quantum Drive';
  compSizeEl.value = '';
  compGradeEl.value = '';
  compClassEl.value = '';
  compManufacturerEl.value = '';
  compBuyEl.value = '';
  compNotesEl.value = '';
  compIdEl.value = '';
}

function fillForm(c) {
  compNameEl.value = c.name || '';
  compTypeEl.value = c.type || 'Quantum Drive';
  compSizeEl.value = c.size || '';
  compGradeEl.value = c.grade || '';
  compClassEl.value = c.class || '';
  compManufacturerEl.value = c.manufacturer || '';
  compBuyEl.value = c.buy || '';
  compNotesEl.value = c.notes || '';
  compIdEl.value = c.id || '';
}

function upsertFromForm() {
  const name = compNameEl.value.trim();
  if (!name) {
    alert('Name is required.');
    return;
  }
  const id = compIdEl.value || uid();
  const existingIdx = components.findIndex(c => c.id === id);

  const obj = {
    id,
    name,
    type: compTypeEl.value || 'Quantum Drive',
    size: compSizeEl.value || '',
    grade: compGradeEl.value || '',
    class: compClassEl.value || '',
    manufacturer: compManufacturerEl.value.trim(),
    buy: compBuyEl.value.trim(),
    notes: compNotesEl.value.trim()
  };

  if (existingIdx >= 0) {
    components[existingIdx] = obj;
  } else {
    components.push(obj);
  }

  components.sort((a,b)=>{
    if (a.type !== b.type) return a.type.localeCompare(b.type);
    if (a.size !== b.size) return a.size.localeCompare(b.size);
    return a.name.localeCompare(b.name);
  });

  refreshFilters();
  render();
  compIdEl.value = id;
}

/* ===== Storage ===== */
function saveToLocal() {
  const payload = {
    savedAt: new Date().toISOString(),
    components
  };
  localStorage.setItem(STORE_KEY, JSON.stringify(payload));
  lastSavedEl.textContent = niceDateTime(payload.savedAt);
}

function loadFromLocal() {
  try {
    const raw = localStorage.getItem(STORE_KEY);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (!obj || !Array.isArray(obj.components)) return null;
    lastSavedEl.textContent = niceDateTime(obj.savedAt);
    return obj.components;
  } catch(e){
    console.warn('Failed to parse stored components', e);
    return null;
  }
}

/* ===== Import / Export ===== */
function exportJSON() {
  const blob = new Blob([JSON.stringify(components,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'jmbn_components.json';
  a.click();
  URL.revokeObjectURL(url);
}

function exportCSV() {
  if (!components.length) {
    alert('No components to export.');
    return;
  }
  const header = ['id','name','type','size','grade','class','manufacturer','buy','notes'];
  const lines = [header.join(',')];
  for (const c of components) {
    const row = header.map(k => {
      const val = (c[k] ?? '').toString().replace(/"/g,'""');
      return `"${val}"`;
    });
    lines.push(row.join(','));
  }
  const blob = new Blob([lines.join('\n')], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'jmbn_components.csv';
  a.click();
  URL.revokeObjectURL(url);
}

function importFromFile(file){
  const reader = new FileReader();
  reader.onload = e => {
    try{
      const parsed = JSON.parse(e.target.result);
      if (!Array.isArray(parsed)) throw new Error('Expected an array of components');
      components = parsed;
      refreshFilters();
      render();
    }catch(err){
      alert('Failed to parse JSON: ' + err.message);
    }
  };
  reader.readAsText(file);
}

/* ===== Initial load ===== */
async function bootstrap() {
  // Try local first
  const stored = loadFromLocal();
  if (stored && stored.length) {
    components = stored;
  } else {
    // Fetch fresh from GitHub
    try{
      const res = await fetch(SRC_URL);
      if (!res.ok) throw new Error('HTTP '+res.status);
      const raw = await res.json();
      factoryComponents = buildFromRaw(raw);
      components = factoryComponents.slice();
      lastSavedEl.textContent = 'Factory (not yet saved)';
    }catch(err){
      console.error('Failed to fetch ship-items.json', err);
      alert('Failed to load Star Citizen components from GitHub. Check console for details.');
      components = [];
    }
  }

  refreshFilters();
  render();
}

/* ===== Events ===== */
searchEl.addEventListener('input', render);
filterTypeEl.addEventListener('change', render);
filterClassEl.addEventListener('change', render);
filterGradeEl.addEventListener('change', render);
filterSizeEl.addEventListener('change', render);

$('#saveComponent').addEventListener('click', () => {
  upsertFromForm();
});

$('#saveBtn').addEventListener('click', () => {
  saveToLocal();
});

$('#resetBtn').addEventListener('click', async () => {
  if (!confirm('Reset to factory list from ship-items.json? This will discard unsaved changes.')) return;
  try{
    const res = await fetch(SRC_URL);
    if (!res.ok) throw new Error('HTTP '+res.status);
    const raw = await res.json();
    factoryComponents = buildFromRaw(raw);
    components = factoryComponents.slice();
    localStorage.removeItem(STORE_KEY);
    lastSavedEl.textContent = 'Factory (not yet saved)';
    refreshFilters();
    render();
    clearForm();
  }catch(err){
    console.error('Failed to reset from GitHub', err);
    alert('Failed to reset from GitHub.');
  }
});

$('#exportJSON').addEventListener('click', exportJSON);
$('#exportCSV').addEventListener('click', exportCSV);

$('#importJSON').addEventListener('click', () => {
  $('#importFile').click();
});
$('#importFile').addEventListener('change', e => {
  const file = e.target.files[0];
  if (file) importFromFile(file);
  e.target.value = '';
});

rowsEl.addEventListener('click', e => {
  const btn = e.target.closest('button');
  if (!btn) return;
  const id = btn.getAttribute('data-id');
  const action = btn.getAttribute('data-action');
  if (!id || !action) return;

  const idx = components.findIndex(c => c.id === id);
  if (idx < 0) return;

  if (action === 'edit') {
    fillForm(components[idx]);
    window.scrollTo({top:0,behavior:'smooth'});
  } else if (action === 'delete') {
    if (!confirm('Delete this component?')) return;
    components.splice(idx,1);
    refreshFilters();
    render();
    if (compIdEl.value === id) clearForm();
  }
});

/* Highlight nav active (defensive) */
(function(){
  const here=location.pathname.split('/').pop()||'components.html';
  document.querySelectorAll('.nav-btn').forEach(a=>{
    if(a.getAttribute('href')===here){a.classList.add('active');a.setAttribute('aria-current','page');}
  });
})();

/* Start */
bootstrap();
</script>
</body>
</html>
