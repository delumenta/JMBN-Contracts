<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>JMBN — Earnings Admin</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--row:#0a0a0a;--card:#111;
  --border:#d6b44c;--accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;--ok:#5cd47c;
  --fs:14px;
}
*{box-sizing:border-box}
html,body{margin:0;background:#000;color:var(--text);font-family:'Play',system-ui,sans-serif;font-size:var(--fs)}
.wrap{max-width:1180px;margin:18px auto;padding:0 14px}
a.btn,button.btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:linear-gradient(180deg,#0c0c0c,#060606);color:var(--accent);cursor:pointer;text-decoration:none}
.btn:hover{background:var(--accent);color:#000}
.btn.small{padding:6px 8px;border-radius:8px;font-size:12px}
.btn.bad{border-color:var(--bad);color:var(--bad)}
.btn.ok{border-color:var(--ok);color:var(--ok)}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:0 0 18px rgba(214,180,76,.18);margin-bottom:14px}
.hd{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border)}
.hd h3{margin:0;color:var(--accent);font-size:16px}
.body{padding:12px}

.inputs{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
input[type="number"],input[type="date"],select{
  background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:8px 10px;color:var(--text);font-family:'Play'
}
input.cut{width:82px;text-align:right}

.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table th{font-weight:700;color:var(--muted);font-size:12px;text-transform:uppercase;text-align:left;padding:0 10px}
.tr{display:grid;grid-template-columns:130px 1fr 130px 160px 140px 150px;gap:8px;align-items:center;background:var(--row);border:1px solid rgba(214,180,76,.35);border-radius:12px;padding:10px}
.tr.lock{opacity:.7;filter:saturate(.8)}
.cell{padding:0 2px}
.badge{border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:11px;color:var(--accent);background:#121212}
.sumgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
.card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center}
.card h4{margin:0 0 6px;color:var(--muted);font-size:11px;text-transform:uppercase}
.val{font-size:18px;color:var(--accent);font-weight:700}
.dim{color:#9b8a52}
.note{font-size:12px;color:var(--muted)}
.k{font-variant-numeric:tabular-nums}
.locktag{font-size:11px;border:1px dashed var(--border);border-radius:8px;padding:2px 6px;color:var(--muted)}
hr.sep{border:0;border-top:1px solid rgba(214,180,76,.35);margin:8px 0}
</style>
</head>
<body>
<div class="wrap">

  <div class="panel">
    <div class="hd">
      <h3>Earnings Admin</h3>
      <a href="admin.html" class="btn small">↩ Back to Admin</a>
    </div>
    <div class="body">
      <!-- Global -->
      <div class="panel" style="margin-bottom:12px">
        <div class="hd"><h3>Org Cut</h3><div class="note">Global % used unless a mission override exists, or a mission is snapshotted.</div></div>
        <div class="body inputs">
          <span>Default %</span>
          <input id="globalCut" class="cut" type="number" step="0.1" min="0" max="100" value="12.5"/>
          <button id="saveGlobal" class="btn small">Save</button>
          <span id="globalSaved" class="note"></span>
        </div>
      </div>

      <!-- Filters -->
      <div class="panel">
        <div class="hd"><h3>Mission Ledger</h3>
          <div class="inputs">
            <input id="from" type="date"/>
            <input id="to" type="date"/>
            <select id="status">
              <option value="all">All Status</option>
              <option value="planned">Planned</option>
              <option value="success">Success</option>
              <option value="abort">Abort</option>
            </select>
            <button id="reload" class="btn small">Reload</button>
          </div>
        </div>
        <div class="body">
          <div class="note">Use <b>+ / –</b> to adjust a mission’s override (auto-saves). Type a value then press <b>Save</b>.</div>
          <div style="height:8px"></div>

          <div class="sumgrid" id="summary">
            <div class="card"><h4>Org Earned</h4><div class="val k" id="vOrg">–</div></div>
            <div class="card"><h4>Member Share</h4><div class="val k" id="vMem">–</div></div>
            <div class="card"><h4>Missions</h4><div class="val k" id="vCnt">–</div></div>
          </div>

          <hr class="sep">

          <div style="display:grid;grid-template-columns:130px 1fr 130px 160px 140px 150px;gap:8px;margin:0 0 6px 0">
            <div class="note">Date</div><div class="note">Title</div><div class="note">Payout</div>
            <div class="note">Cut % (Override)</div><div class="note">Org Earned</div><div class="note">Actions</div>
          </div>
          <div id="rows">Loading…</div>
        </div>
      </div>

      <!-- Recent -->
      <div class="panel">
        <div class="hd"><h3>Last 4 Missions (Org)</h3><div class="badge" id="lastCount">0</div></div>
        <div class="body" id="lastList" class="note">–</div>
      </div>
    </div>
  </div>

</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
const $ = s => document.querySelector(s);
const esc = s => { const d=document.createElement('div'); d.textContent=s??''; return d.innerHTML; };
const fmt = n => (n==null ? '–' : Number(n).toLocaleString());

let sb, me;
let GLOBAL_CUT = 12.5; // fallback
let MISSIONS = [];     // rows from DB (+ overrides merged)

document.addEventListener('DOMContentLoaded', async () => {
  const session = await requireAuth(); if(!session) return;
  sb = getSupabase(); me = session.user.id;

  // default dates: last 30 days
  const today = new Date();
  const toISO = d => d.toISOString().slice(0,10);
  $('#to').value = toISO(today);
  const from = new Date(today); from.setDate(from.getDate()-30);
  $('#from').value = toISO(from);

  $('#reload').onclick = loadAll;
  $('#saveGlobal').onclick = saveGlobalCut;

  await loadGlobalCut();
  await loadAll();
});

/* ---------- Loaders ---------- */

async function loadGlobalCut(){
  const { data, error } = await sb.from('org_settings').select('org_cut_pct').limit(1).maybeSingle();
  if(!error && data && typeof data.org_cut_pct === 'number'){
    GLOBAL_CUT = data.org_cut_pct;
  }
  $('#globalCut').value = GLOBAL_CUT;
}

async function saveGlobalCut(){
  const val = Number($('#globalCut').value);
  if(Number.isNaN(val) || val<0 || val>100) return alert('Enter 0–100');
  const { error } = await sb.from('org_settings').update({
    org_cut_pct: val, updated_by: me, updated_at: new Date().toISOString()
  }).neq('id', null); // update the single row
  if(error){ alert('Save failed: '+error.message); return; }
  GLOBAL_CUT = val;
  $('#globalSaved').textContent = 'Saved ✓';
  setTimeout(()=>$('#globalSaved').textContent='',1500);
}

async function loadAll(){
  $('#rows').textContent = 'Loading…';

  // 1) missions in range
  const from = $('#from').value, to = $('#to').value;
  let q = sb.from('missions')
    .select('id,title,start_time,payout_auec,status,org_cut_percent')
    .gte('start_time', new Date(from).toISOString())
    .lte('start_time', new Date(new Date(to).getTime()+86400000-1).toISOString()) // end of day
    .order('start_time', { ascending: false });

  const s = $('#status').value;
  if(s !== 'all') q = q.eq('status', s);

  const { data: missions, error } = await q;
  if(error){ $('#rows').textContent = 'Failed to load missions: '+error.message; return; }

  // 2) fetch overrides for these mission ids
  const ids = missions.map(m=>m.id);
  let overridesMap = {};
  if(ids.length){
    const { data: ovs } = await sb.from('mission_org_cut_overrides')
      .select('mission_id, org_cut_pct')
      .in('mission_id', ids);
    overridesMap = Object.fromEntries((ovs||[]).map(r=>[r.mission_id, r.org_cut_pct]));
  }

  // 3) merge & render
  MISSIONS = missions.map(m => ({
    ...m,
    override_pct: overridesMap[m.id] ?? null
  }));
  renderRows();
  renderSummary();

  // 4) last 4 org missions, newest first
  const last = [...MISSIONS].slice(0,4);
  $('#lastCount').textContent = String(last.length);
  $('#lastList').innerHTML = last.length ? last.map(r=>{
    const dt = new Date(r.start_time).toLocaleString();
    const eff = effectiveCut(r);
    const orgEarn = Math.round(Number(r.payout_auec||0) * (eff/100));
    return `<div style="margin:8px 0">
      <div><b>${esc(r.title)}</b> <span class="note">(${dt})</span></div>
      <div class="note">Payout: <span class="k">${fmt(r.payout_auec)}</span> • Cut: ${eff}% • Org: <span class="k">${fmt(orgEarn)}</span></div>
    </div>`;
  }).join('') : '<div class="note">–</div>';
}

/* ---------- Rendering ---------- */

function effectiveCut(row){
  // Use snapshot if present (mission finalized)
  if(row.org_cut_percent != null) return Number(row.org_cut_percent);
  // else use override if any; else global
  return row.override_pct != null ? Number(row.override_pct) : Number(GLOBAL_CUT);
}

function renderRows(){
  if(!MISSIONS.length){ $('#rows').innerHTML = '<div class="note">No missions in this range.</div>'; return; }

  $('#rows').innerHTML = MISSIONS.map(r=>{
    const dt = new Date(r.start_time).toLocaleDateString();
    const eff = effectiveCut(r);
    const payout = Number(r.payout_auec||0);
    const org = Math.round(payout * (eff/100));

    const locked = r.org_cut_percent != null; // snapshotted on success
    const ov = r.override_pct;

    return `<div class="tr ${locked?'lock':''}" data-id="${r.id}">
      <div class="cell">${dt}</div>
      <div class="cell"><b>${esc(r.title)}</b> <span class="badge">${esc(r.status||'')}</span></div>
      <div class="cell k">${fmt(payout)}</div>

      <div class="cell">
        ${locked ? `<div><b>${eff.toFixed(1)}%</b> <span class="locktag">locked</span></div>`
                 : `
          <div style="display:flex;gap:6px;align-items:center">
            <button class="btn small" data-step="-0.5">–</button>
            <input class="cut" type="number" step="0.1" min="0" max="100" value="${ov ?? ''}" placeholder="${GLOBAL_CUT}">
            <button class="btn small" data-step="+0.5">+</button>
            <button class="btn small ok" data-save>Save</button>
          </div>
          <div class="note">Effective: <b>${eff.toFixed(1)}%</b> ${ov!=null?'<span class="dim">(override)</span>':'<span class="dim">(global)</span>'}</div>
        `}
      </div>

      <div class="cell k">${fmt(org)}</div>

      <div class="cell">
        ${locked ? '<span class="note">Snapshot: '+eff.toFixed(1)+'%</span>'
                 : '<span class="note">Override only (no history change)</span>'}
      </div>
    </div>`;
  }).join('');

  // wire controls
  document.querySelectorAll('.tr').forEach(row=>{
    const id = row.dataset.id;
    const minus = row.querySelector('[data-step="-0.5"]');
    const plus  = row.querySelector('[data-step="+0.5"]');
    const save  = row.querySelector('[data-save]');
    const input = row.querySelector('input.cut');
    if(!input) return; // locked rows

    const bump = (delta)=>{
      const cur = input.value==='' ? (MISSIONS.find(m=>m.id===id).override_pct ?? GLOBAL_CUT) : Number(input.value);
      const next = Math.max(0, Math.min(100, Number(cur)+delta));
      input.value = next.toFixed(1);
      doSave();
    };
    const doSave = async ()=>{
      const val = input.value==='' ? null : Number(input.value);
      await saveOverride(id, val);
    };

    minus?.addEventListener('click', ()=>bump(-0.5));
    plus?.addEventListener('click',  ()=>bump(+0.5));
    save?.addEventListener('click',  doSave);
    input?.addEventListener('keydown', e=>{ if(e.key==='Enter') doSave(); });
  });
}

function renderSummary(){
  const totals = MISSIONS.reduce((a,r)=>{
    const eff = effectiveCut(r);
    const payout = Number(r.payout_auec||0);
    const org = Math.round(payout * (eff/100));
    a.org += org;
    a.mem += (payout - org);
    a.cnt += 1;
    return a;
  },{org:0,mem:0,cnt:0});
  $('#vOrg').textContent = fmt(totals.org);
  $('#vMem').textContent = fmt(totals.mem);
  $('#vCnt').textContent = fmt(totals.cnt);
}

/* ---------- Save override ---------- */

async function saveOverride(missionId, valueOrNull){
  // Upsert null → delete row; else upsert value
  if(valueOrNull===null){
    const { error } = await sb.from('mission_org_cut_overrides')
      .delete().eq('mission_id', missionId);
    if(error){ alert('Delete override failed: '+error.message); return; }
  }else{
    const { error } = await sb.from('mission_org_cut_overrides')
      .upsert({
        mission_id: missionId,
        org_cut_pct: Number(valueOrNull),
        updated_by: me,
        updated_at: new Date().toISOString()
      }, { onConflict: 'mission_id' });
    if(error){ alert('Save override failed: '+error.message); return; }
  }

  // refresh the single row in memory and re-render
  const idx = MISSIONS.findIndex(m=>m.id===missionId);
  if(idx>-1){
    const { data } = await sb.from('mission_org_cut_overrides')
      .select('org_cut_pct').eq('mission_id', missionId).maybeSingle();
    MISSIONS[idx].override_pct = data ? data.org_cut_pct : null;
    renderRows();
    renderSummary();
  }
}
</script>
</body>
</html>