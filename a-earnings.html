<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN — Earnings Admin</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  --bg:#000; --panel:#0b0b0b; --sub:#0f0f0f; --row:#0a0a0a;
  --border:#d6b44c; --accent:#f2d675; --text:#f7f1d0; --muted:#c9b06a; --bad:#ff6b6b; --ok:#5cd47c;
  --fs:14px;
}
*{box-sizing:border-box}
html,body{margin:0;background:#000;color:var(--text);font-family:'Play',system-ui,sans-serif;font-size:var(--fs)}
a{color:var(--accent);text-decoration:none}

.wrap{max-width:1180px;margin:18px auto;padding:0 14px 60px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:0 0 18px rgba(214,180,76,.18);margin-bottom:14px}
.hd{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border)}
.hd h3{margin:0;font-size:16px;color:var(--accent)}
.body{padding:12px}
.small{color:var(--muted);font-size:12px}
.badge{border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:11px;color:var(--accent);background:#111}

input,select,button{font-family:'Play'}
input[type="number"], input[type="text"], select{
  background:#0a0a0a;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px
}
button{
  border:1px solid var(--border);background:linear-gradient(180deg,#0c0c0c,#060606);color:var(--accent);
  border-radius:10px;padding:8px 12px;cursor:pointer
}
button:hover{background:var(--accent);color:#000}
.btn-ok{border-color:var(--ok);color:var(--ok)}
.btn-bad{border-color:var(--bad);color:var(--bad)}
.pill{border-radius:999px;padding:6px 10px}

.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media(max-width:900px){.grid3{grid-template-columns:1fr}}

.kpi{border:1px solid var(--border);border-radius:12px;padding:10px;background:#0c0c0c;text-align:center}
.kpi h4{margin:0 0 6px;color:var(--muted);font-size:11px;text-transform:uppercase}
.kpi .v{font-size:18px;color:var(--accent);font-weight:700}

.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.table th{font-size:12px;color:var(--muted);font-weight:400;text-align:left;padding:4px 8px}
.row{display:grid;grid-template-columns:140px 1fr 120px 240px 120px 160px;gap:10px;align-items:center;
  background:#0a0a0a;border:1px solid rgba(214,180,76,.35);border-radius:10px;padding:8px}
@media(max-width:1050px){.row{grid-template-columns:130px 1fr 120px 220px 110px 140px}}
@media(max-width:860px){.row{grid-template-columns:1fr}}
.cell{padding:4px 6px}
.meta{display:flex;align-items:center;gap:8px}
.tag{font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:999px;color:var(--accent);background:#121212}
.tag.dim{opacity:.7}
.note{font-size:11px;color:var(--muted)}

.cutCtrl{display:flex;align-items:center;gap:6px}
.cutCtrl button{width:32px;height:32px;padding:0}
.cutCtrl input{width:90px;text-align:center}

.right{display:flex;gap:8px;align-items:center;justify-content:flex-end}
.lock{opacity:.8}
.lock .note{color:#a7a07b}

.alert{border:1px solid var(--bad);background:#240e0e;color:#ffbcbc;border-radius:10px;padding:8px 10px}
.ok{border:1px solid var(--ok);background:#102014;color:#adffcb;border-radius:10px;padding:8px 10px}
</style>
</head>
<body>

<div class="wrap">
  <div style="margin-bottom:8px"><a href="admin.html" class="badge">← Back to Admin</a></div>

  <!-- Global cut -->
  <div class="panel">
    <div class="hd"><h3>Org Cut</h3><span class="small">Global % applies unless a mission override exists, or the mission has a snapshot.</span></div>
    <div class="body">
      <div class="meta" style="gap:12px;flex-wrap:wrap">
        <div class="small">Default %</div>
        <input id="gCut" type="number" step="0.1" min="0" max="100" style="width:110px" />
        <button id="gSave">Save</button>
        <span class="small" id="gStamp">—</span>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="panel">
    <div class="hd"><h3>Mission Ledger</h3>
      <div class="meta" style="gap:8px;flex-wrap:wrap">
        <input id="fFrom" type="date">
        <input id="fTo" type="date">
        <select id="fStatus">
          <option value="">All Status</option>
          <option value="planned">Planned</option>
          <option value="success">Success</option>
          <option value="abort">Abort</option>
          <option value="failed">Failed</option>
        </select>
        <button id="btnReload">Reload</button>
      </div>
    </div>
    <div class="body">
      <div class="grid3" style="margin-bottom:10px">
        <div class="kpi"><h4>ORG EARNED</h4><div class="v" id="kOrg">–</div></div>
        <div class="kpi"><h4>MEMBER SHARE</h4><div class="v" id="kMem">–</div></div>
        <div class="kpi"><h4>MISSIONS</h4><div class="v" id="kMis">–</div></div>
      </div>

      <div class="small" style="margin-bottom:8px">Use <b>– / +</b> to nudge a mission’s override. Type a value then press <b>Save</b>. Values are in <b>%</b>.</div>

      <div id="list">Loading…</div>
    </div>
  </div>

  <!-- Last 4 -->
  <div class="panel">
    <div class="hd"><h3>Last 4 Missions (Org)</h3><span class="badge" id="lastCount">0</span></div>
    <div class="body" id="last4">—</div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
const $ = s => document.querySelector(s);
const fmt = n => (n==null || isNaN(n)) ? '–' : Number(n).toLocaleString();
const clampPct = v => Math.max(0, Math.min(100, Number(v)||0));

let sb, me, GLOBAL = 0, MISSIONS=[], OV={}, NOW = new Date();

// ---------- boot ----------
document.addEventListener('DOMContentLoaded', async () => {
  const session = await requireAuth(); if(!session) return;
  sb = getSupabase(); me = session.user.id;

  setDefaultDates();
  await loadGlobal();
  await loadLedger();

  $('#gSave').onclick = saveGlobal;
  $('#btnReload').onclick = loadLedger;
});

function setDefaultDates(){
  const to = new Date(); const from = new Date(); from.setMonth(from.getMonth()-1);
  $('#fFrom').value = from.toISOString().slice(0,10);
  $('#fTo').value   = to.toISOString().slice(0,10);
}

// ---------- global ----------
async function loadGlobal(){
  const { data, error } = await sb.from('org_settings')
    .select('org_cut_pct, updated_at').order('updated_at', { ascending:false }).limit(1).maybeSingle();
  if(error){ $('#gStamp').textContent = 'Failed to load global'; return; }
  GLOBAL = Number(data?.org_cut_pct||0);
  $('#gCut').value = String(GLOBAL);
  $('#gStamp').textContent = data?.updated_at ? `Updated ${new Date(data.updated_at).toLocaleString()}` : '';
}

async function saveGlobal(){
  const val = clampPct($('#gCut').value);
  $('#gCut').value = String(val);
  const note = `Set by ${me.slice(0,8)}`;
  const { error } = await sb.from('org_settings').insert({ org_cut_pct: val, note });
  if(error){ return alert('Saving global failed: '+error.message); }
  await loadGlobal(); // refresh
  // Recompute totals using new GLOBAL (affects only missions without override & without snapshot)
  renderList();
}

// ---------- ledger ----------
async function loadLedger(){
  $('#list').textContent = 'Loading…';
  const from = $('#fFrom').value ? new Date($('#fFrom').value) : null;
  const to   = $('#fTo').value ? new Date($('#fTo').value) : null;
  const status = $('#fStatus').value;

  // missions for window
  let q = sb.from('missions')
     .select('id,title,start_time,payout_auec,status,org_cut_percent')
     .order('start_time',{ascending:false});
  if(from) q = q.gte('start_time', from.toISOString());
  if(to){  // inclusive through end-of-day
    const end = new Date(to); end.setDate(end.getDate()+1);
    q = q.lt('start_time', end.toISOString());
  }
  if(status) q = q.eq('status', status);
  const { data: rows, error } = await q;

  if(error){ $('#list').innerHTML = `<div class="alert">${error.message}</div>`; return; }
  MISSIONS = rows || [];

  // pull overrides for listed missions
  let ov = {};
  if(MISSIONS.length){
    const ids = MISSIONS.map(m=>m.id);
    const { data: orows } = await sb.from('mission_org_cut_overrides')
      .select('mission_id, org_cut_pct, updated_at, updated_by, reason')
      .in('mission_id', ids);
    (orows||[]).forEach(r=> ov[r.mission_id] = r);
  }
  OV = ov;

  renderList();
  renderLast4();
}

function effectiveCut(m){
  const o = OV[m.id]?.org_cut_pct;
  const snap = m.org_cut_percent; // snapshot frozen when mission first hit 'success'
  return (o!=null) ? Number(o) : (snap!=null ? Number(snap) : Number(GLOBAL));
}

function rowBadgeSet(m){
  const bag = [];
  if(OV[m.id]) bag.push(`<span class="tag">override</span>`);
  if(m.org_cut_percent!=null) bag.push(`<span class="tag dim">snapshot</span>`);
  if(m.status) bag.push(`<span class="tag dim">${m.status}</span>`);
  return bag.join(' ');
}

function renderList(){
  if(!MISSIONS.length){ 
    $('#list').innerHTML = `<div class="small">No missions in this window.</div>`;
    $('#kOrg').textContent = '–'; $('#kMem').textContent = '–'; $('#kMis').textContent = '0';
    return;
  }
  let totOrg=0, totPayout=0;

  const rows = MISSIONS.map(m=>{
    const eff = effectiveCut(m);
    const payout = Number(m.payout_auec||0);
    const orgEarn = payout * eff/100;
    totOrg += orgEarn; totPayout += payout;

    const oVal = (OV[m.id]?.org_cut_pct!=null) ? OV[m.id].org_cut_pct : '';
    const lockHint = (m.org_cut_percent!=null)
      ? `<div class="note">Effective uses <b>${eff}%</b> (${OV[m.id]?'override':'snapshot'}`).concat(`) — global changes won’t alter this.</div>`)
      : `<div class="note">Effective uses <b>${eff}%</b> (${OV[m.id]?'override':'global'})</div>`;

    return `
      <div class="row" data-id="${m.id}">
        <div class="cell small">${new Date(m.start_time).toLocaleString()}</div>
        <div class="cell">
          <div>${escapeHtml(m.title||'Untitled')}</div>
          <div class="meta" style="margin-top:4px">${rowBadgeSet(m)}</div>
        </div>
        <div class="cell"><b>${fmt(payout)}</b></div>

        <div class="cell">
          <div class="cutCtrl">
            <button data-minus>-</button>
            <input type="number" step="0.1" min="0" max="100" placeholder="override" value="${oVal!==''?oVal:''}">
            <button data-plus>+</button>
            <button class="btn-ok" data-save>Save</button>
          </div>
          ${lockHint}
        </div>

        <div class="cell"><b>${fmt(orgEarn)}</b></div>

        <div class="cell right">
          <button class="btn-bad" data-clear ${OV[m.id]?'':'disabled'}>Clear Override</button>
        </div>
      </div>`;
  }).join('');

  $('#list').innerHTML = `
    <div class="table">
      <div class="row" style="background:transparent;border-color:transparent">
        <div class="cell small">Date</div>
        <div class="cell small">Title</div>
        <div class="cell small">Payout</div>
        <div class="cell small">Cut % (Override) &amp; Effective</div>
        <div class="cell small">Org Earned</div>
        <div class="cell small">Actions</div>
      </div>
      ${rows}
    </div>`;

  // KPI
  $('#kOrg').textContent = fmt(totOrg);
  $('#kMem').textContent = fmt(totPayout - totOrg);
  $('#kMis').textContent = String(MISSIONS.length);

  // wire controls
  $('#list').querySelectorAll('.row').forEach(row=>{
    const id = row.dataset.id;
    const inp = row.querySelector('input[type="number"]');
    row.querySelector('[data-minus]').onclick = ()=>{ inp.value = String(clampPct((Number(inp.value)||0) - 0.5)); };
    row.querySelector('[data-plus]').onclick  = ()=>{ inp.value = String(clampPct((Number(inp.value)||0) + 0.5)); };
    row.querySelector('[data-save]').onclick  = ()=> saveOverride(id, inp.value);
    const clr = row.querySelector('[data-clear]');
    if(clr) clr.onclick = ()=> clearOverride(id);
  });
}

async function saveOverride(missionId, val){
  const pct = clampPct(val);
  if(isNaN(pct)) return alert('Enter a number between 0 and 100.');
  const payload = { mission_id: missionId, org_cut_pct: pct, updated_by: me };
  const { error } = await sb.from('mission_org_cut_overrides').upsert(payload).select().maybeSingle();
  if(error){
    return alert('Save override failed: ' + error.message);
  }
  // refresh OV + list (efficiently)
  OV[missionId] = { mission_id: missionId, org_cut_pct: pct, updated_by: me, updated_at: new Date().toISOString() };
  renderList();
}

async function clearOverride(missionId){
  if(!confirm('Remove this mission’s override?')) return;
  const { error } = await sb.from('mission_org_cut_overrides').delete().eq('mission_id', missionId);
  if(error){ return alert('Clear failed: ' + error.message); }
  delete OV[missionId];
  renderList();
}

// ---------- last 4 ----------
async function renderLast4(){
  // last 4 by start_time (any status)
  const { data, error } = await sb.from('missions')
    .select('id,title,start_time,payout_auec,status,org_cut_percent')
    .order('start_time',{ascending:false}).limit(4);
  if(error || !data?.length){ $('#last4').innerHTML='—'; $('#lastCount').textContent='0'; return; }

  const ids = data.map(m=>m.id);
  const { data: over } = await sb.from('mission_org_cut_overrides')
    .select('mission_id, org_cut_pct').in('mission_id', ids);
  const map = Object.fromEntries((over||[]).map(r=>[r.mission_id, r.org_cut_pct]));

  $('#lastCount').textContent = String(data.length);
  $('#last4').innerHTML = data.map(m=>{
    const eff = (map[m.id]!=null) ? map[m.id] : (m.org_cut_percent!=null ? m.org_cut_percent : GLOBAL);
    const payout = Number(m.payout_auec||0);
    const orgEarn = payout * eff/100;
    return `
      <div class="row" style="grid-template-columns:180px 1fr 120px 160px 120px">
        <div class="cell small">${new Date(m.start_time).toLocaleString()}</div>
        <div class="cell">${escapeHtml(m.title||'Untitled')} <span class="tag dim">${m.status||''}</span></div>
        <div class="cell"><b>${fmt(payout)}</b></div>
        <div class="cell small">Cut: <b>${eff}%</b> ${m.org_cut_percent!=null?'<span class="tag dim">snapshot</span>':(map[m.id]!=null?'<span class="tag">override</span>':'<span class="tag dim">global</span>')}</div>
        <div class="cell"><b>${fmt(orgEarn)}</b></div>
      </div>`;
  }).join('');
}

// util
function escapeHtml(s){ const d=document.createElement('div'); d.textContent = s??''; return d.innerHTML; }
</script>
</body>
</html>