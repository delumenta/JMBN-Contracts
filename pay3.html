<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JMBN — Earnings Ledger</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--card:#0c0c0c;--row:#0a0a0a;
  --border:#d6b44c;--accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;--ok:#7CFC9A;
  --fs:14px
}
*{box-sizing:border-box}
html,body{margin:0;background:#000;color:var(--text);font-family:'Play',system-ui,sans-serif;font-size:var(--fs);letter-spacing:.25px}

/* Shell */
.wrap{max-width:1180px;margin:22px auto;padding:0 14px}
.brand{display:flex;align-items:center;gap:10px;margin:0 0 14px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.brand img{width:44px;height:44px;object-fit:contain}
.brand h1{margin:0;color:var(--accent);font-size:clamp(18px,2.6vw,24px)}

/* KPIs ribbon */
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:14px}
@media(max-width:980px){.kpis{grid-template-columns:1fr}}
.kpi{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;
  box-shadow:0 0 18px rgba(214,180,76,.18)}
.kpi .t{color:var(--muted);font-size:12px}
.kpi .v{font-weight:800;font-size:20px;margin-top:4px}
.kpi small{color:var(--muted)}
.mono{font-variant-numeric:tabular-nums}

/* Main layout: ledger (left) + analyzer (right) */
.main{display:grid;grid-template-columns:420px 1fr;gap:14px}
@media(max-width:1080px){.main{grid-template-columns:1fr}}
.card{
  background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;
  box-shadow:0 0 18px rgba(214,180,76,.18)
}
.card h3{margin:0 0 8px;color:var(--accent);font-size:16px}

/* Ledger timeline */
.ledger{
  position:relative;padding-left:28px; /* space for line/dots */
}
.ledger::before{
  content:"";position:absolute;left:12px;top:0;bottom:0;width:2px;background:linear-gradient(var(--border),transparent);
}
.daygroup{margin:8px 0 12px}
.dayhead{font-size:12px;color:var(--muted);margin:0 0 6px}
.row{
  position:relative;background:var(--card);border:1px solid var(--border);border-radius:10px;
  padding:10px;margin:10px 0 10px 0;display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;
}
.row::before{
  content:"";position:absolute;left:-18px;top:14px;width:10px;height:10px;border:2px solid var(--border);border-radius:50%;background:#1a1a1a;
}
.row:hover{box-shadow:0 0 10px rgba(214,180,76,.25)}
.title{font-weight:800}
.sub{font-size:12px;color:var(--muted)}
.pill{border:1px solid var(--border);border-radius:999px;background:#0c0c0c;color:var(--muted);font-size:11px;padding:2px 8px;margin-left:6px}
.money{font-weight:800}
.right{text-align:right}
.click{cursor:pointer}

/* Analyzer (right pane) */
.split{display:grid;grid-template-columns:1fr;gap:12px}
.box{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px}
.box h4{margin:0 0 6px;color:var(--accent);font-size:14px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:680px){.grid2{grid-template-columns:1fr}}

.label{color:var(--muted);font-size:12px}
.value{font-weight:800}
hr.sep{border:0;border-top:1px solid rgba(255,255,255,.08);margin:8px 0}
.badge{border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:11px;background:#0c0c0c;color:var(--muted)}
.formula{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;line-height:1.5}

/* Tiny table inside analyzer */
.mini{margin-top:6px;border:1px solid var(--border);border-radius:8px;overflow:hidden}
.mini header,.mini .r{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
.mini header{background:#121212;color:var(--accent);padding:8px;font-size:12px}
.mini .r{padding:8px;border-top:1px solid rgba(255,255,255,.08)}
</style>
</head>
<body>
<div class="wrap">
  <div class="brand">
    <img src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" alt="JMBN">
    <h1>JMBN — Earnings Ledger</h1>
  </div>

  <!-- KPIs ribbon -->
  <section class="kpis">
    <div class="kpi">
      <div class="t">Org cut (lifetime)</div>
      <div class="v mono" id="orgTotal">—</div>
      <small id="orgThisMonth">MTD: —</small>
    </div>
    <div class="kpi">
      <div class="t">You — lifetime earned</div>
      <div class="v mono" id="youTotal">—</div>
      <small id="youMissions">from — missions</small>
    </div>
    <div class="kpi">
      <div class="t">Your last 4 missions (total)</div>
      <div class="v mono" id="youLast4">—</div>
      <small id="youLast4Hint">latest four final shares</small>
    </div>
  </section>

  <section class="main">
    <!-- LEFT: Ledger timeline -->
    <div class="card">
      <h3>Mission Ledger</h3>
      <div id="ledger" class="ledger"></div>
    </div>

    <!-- RIGHT: Analyzer + Rank/Weight -->
    <div class="split">
      <div class="box" id="analyzer">
        <h4>Analyzer</h4>
        <div class="label">Select a mission on the left to see the breakdown.</div>
        <hr class="sep">
        <div class="grid2">
          <div>
            <div class="label">Mission</div>
            <div class="value" id="aTitle">—</div>
            <div class="label" id="aDate">—</div>
          </div>
          <div class="right">
            <div class="label">Your Final</div>
            <div class="value mono" id="aFinal">—</div>
            <div class="label">Org Cut Source: <span class="badge" id="aCutSrc">—</span></div>
          </div>
        </div>
        <hr class="sep">
        <div class="grid2">
          <div class="mini">
            <header><div>Step</div><div>Value</div></header>
            <div class="r"><div>Mission payout</div><div class="mono" id="aPayout">—</div></div>
            <div class="r"><div>Org cut %</div><div class="mono" id="aPct">—</div></div>
            <div class="r"><div>Org cut value</div><div class="mono" id="aCut">—</div></div>
            <div class="r"><div>Pool after cut</div><div class="mono" id="aPool">—</div></div>
          </div>
          <div class="mini">
            <header><div>Split</div><div>Value</div></header>
            <div class="r"><div>Total weight (party)</div><div class="mono" id="aTWeight">—</div></div>
            <div class="r"><div>Your weight</div><div class="mono" id="aWeight">—</div></div>
            <div class="r"><div>Base share</div><div class="mono" id="aBase">—</div></div>
            <div class="r"><div>Override (+/−)</div><div class="mono" id="aAdj">—</div></div>
          </div>
        </div>
        <hr class="sep">
        <div class="formula" id="aFormula">
          final_share = base_share + override
        </div>
      </div>

      <div class="box" id="rankbox">
        <h4>Your Rank & Weight</h4>
        <div class="grid2">
          <div>
            <div class="label">Handle</div>
            <div class="value" id="pHandle">—</div>
            <div class="label">Current rank</div>
            <div class="value" id="pRank">—</div>
          </div>
          <div class="right">
            <div class="label">Current weight</div>
            <div class="value mono" id="pWeight">—</div>
            <div class="label">Last mission used</div>
            <div class="value" id="pWeightHint">—</div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
(function(){
  const $ = s => document.querySelector(s);
  const fmt0 = n => (n===null||n===undefined)?'—':Number(n).toLocaleString('en-US',{maximumFractionDigits:0});
  const fmt2 = n => (n===null||n===undefined)?'—':Number(n).toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:2});
  const pct = n => (n===null||n===undefined)?'—':(Number(n)*100).toFixed(1)+'%';
  const dateOnly = iso => new Date(iso).toLocaleDateString();

  let sb, me;
  let rows = [];   // cache of v_missions_payout_live for ledger & analyzer

  async function boot(){
    const session = await requireAuth(); if(!session) return;
    sb = getSupabase(); me = session.user.id;

    await Promise.all([
      loadKPIs(),
      loadLedger(),
      loadProfileWeight()
    ]);
  }

  /* ---------- KPIs ---------- */
  async function loadKPIs(){
    try{
      // Your lifetime summary
      const { data: sum } = await sb
        .from('v_missions_payout_summary')
        .select('*')
        .eq('user_id', me)
        .maybeSingle();
      $('#youTotal').textContent    = sum ? fmt2(sum.total_earned) : '0';
      $('#youMissions').textContent = sum ? `from ${fmt0(sum.missions_count)} missions` : 'from 0 missions';

      // Org totals (lifetime + MTD)
      const { data: missions } = await sb
        .from('missions')
        .select('id,payout_auec,created_at')
        .neq('payout_auec',0)
        .order('created_at', {ascending:false});
      const { data: cuts } = await sb
        .from('v_mission_org_cut_effective')
        .select('mission_id, org_cut_pct');

      const cutMap = new Map((cuts||[]).map(c => [c.mission_id, Number(c.org_cut_pct||0)]));
      const now = new Date();
      const thisKey = now.getUTCFullYear()+'-'+String(now.getUTCMonth()+1).padStart(2,'0');
      let life=0, mtd=0;
      for(const m of (missions||[])){
        const take = Number(m.payout_auec||0) * (cutMap.get(m.id)||0);
        life += take;
        const d = new Date(m.created_at);
        const key = d.getUTCFullYear()+'-'+String(d.getUTCMonth()+1).padStart(2,'0');
        if(key===thisKey) mtd += take;
      }
      $('#orgTotal').textContent = fmt2(life);
      $('#orgThisMonth').textContent = 'MTD: ' + fmt2(mtd);

      // Your last 4 missions total
      const { data: last4 } = await sb
        .from('v_missions_payout_live')
        .select('final_share')
        .eq('user_id', me)
        .order('mission_date', {ascending:false})
        .limit(4);
      const lsum = (last4||[]).reduce((a,b)=>a+Number(b.final_share||0),0);
      $('#youLast4').textContent = fmt2(lsum);
    }catch(e){
      console.warn('kpis:', e.message);
    }
  }

  /* ---------- Ledger (left) ---------- */
  async function loadLedger(){
    try{
      const { data, error } = await sb
        .from('v_missions_payout_live')
        .select('*')
        .eq('user_id', me)
        .order('mission_date', { ascending:false })
        .limit(25);
      if(error) throw error;
      rows = data||[];

      // Group by day for headings
      const groups = new Map();
      for(const r of rows){
        const k = dateOnly(r.mission_date);
        if(!groups.has(k)) groups.set(k, []);
        groups.get(k).push(r);
      }

      const html = [];
      for(const [day, list] of groups){
        html.push(`<div class="daygroup">
          <div class="dayhead">${day}</div>
          ${list.map(r => rowHTML(r)).join('')}
        </div>`);
      }
      $('#ledger').innerHTML = html.join('');

      // bind clicks
      for(const el of document.querySelectorAll('.row.click')){
        el.addEventListener('click', () => {
          const id = el.dataset.mid;
          const r = rows.find(x => x.mission_id===id);
          if(r) renderAnalyzer(r);
        });
      }

      // preselect newest if present
      if(rows[0]) renderAnalyzer(rows[0]);

    }catch(e){
      console.warn('ledger:', e.message);
    }
  }

  function rowHTML(r){
    const tag = (r.org_cut_pct!=null) ? `${(Number(r.org_cut_pct)*100).toFixed(0)}% org` : 'org n/a';
    return `<div class="row click" data-mid="${r.mission_id}">
      <div>
        <div class="title">${r.title || '—'}</div>
        <div class="sub">
          Pool: <span class="mono">${fmt2(r.pool_after_cut)}</span>
          <span class="pill">${tag}</span>
          <span class="pill">weight ${fmt2(r.weight)}</span>
        </div>
      </div>
      <div class="right">
        <div class="label">Final</div>
        <div class="money mono">${fmt2(r.final_share)}</div>
      </div>
    </div>`;
  }

  /* ---------- Analyzer (right) ---------- */
  function renderAnalyzer(r){
    $('#aTitle').textContent = r.title || '—';
    $('#aDate').textContent  = dateOnly(r.mission_date);

    $('#aFinal').textContent = fmt2(r.final_share);
    $('#aCutSrc').textContent= r.org_cut_source || '—';

    $('#aPayout').textContent= fmt2(r.payout_auec);
    $('#aPct').textContent   = pct(r.org_cut_pct);
    $('#aCut').textContent   = fmt2(r.org_cut_value);
    $('#aPool').textContent  = fmt2(r.pool_after_cut);

    $('#aTWeight').textContent = fmt2(r.total_weight);
    $('#aWeight').textContent  = fmt2(r.weight);
    $('#aBase').textContent    = fmt2(r.base_share);
    $('#aAdj').textContent     = fmt2(r.add_pay_override);

    $('#aFormula').innerHTML =
      `final_share = base_share + override<br>
       = <b>${fmt2(r.base_share)}</b> + <b>${fmt2(r.add_pay_override)}</b>
       = <b>${fmt2(r.final_share)}</b>`;
  }

  /* ---------- Profile weight box (no paygrade text, just weight) ---------- */
  async function loadProfileWeight(){
    try{
      // Handle + rank name (from v_profiles_detailed)
      let prof = {};
      try{
        const { data } = await sb
          .from('v_profiles_detailed')
          .select('handle,display_name,current_rank_name')
          .eq('user_id', me)
          .maybeSingle();
        prof = data || {};
      }catch(_){}
      $('#pHandle').textContent = prof.handle || prof.display_name || '—';
      $('#pRank').textContent   = prof.current_rank_name || 'Unranked';

      // Weight from the latest mission row (closest to “current”)
      const { data: one } = await sb
        .from('v_missions_payout_live')
        .select('weight, mission_date')
        .eq('user_id', me)
        .order('mission_date', {ascending:false})
        .limit(1);
      const w = one?.[0]?.weight;
      const d = one?.[0]?.mission_date;
      $('#pWeight').textContent = (w==null)?'—':fmt2(w);
      $('#pWeightHint').textContent = d ? dateOnly(d) : 'no missions yet';
    }catch(e){
      console.warn('profile weight:', e.message);
    }
  }

  boot();
})();
</script>
</body>
</html>