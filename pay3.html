<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JMBN — Earnings & Payouts</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  --bg:#000; --panel:#0b0b0b; --card:#0c0c0c;
  --border:#d6b44c; --accent:#f2d675; --text:#f7f1d0; --muted:#c9b06a; --bad:#ff6b6b;
}
*{box-sizing:border-box}
html,body{margin:0;background:#000;color:var(--text);font-family:'Play',system-ui,sans-serif}
.wrap{max-width:1160px;margin:20px auto;padding:0 14px}

/* Header */
.brand{display:flex;align-items:center;gap:10px;margin:6px 0 16px}
.brand img{width:38px;height:38px;object-fit:contain;filter:drop-shadow(0 0 6px rgba(242,214,117,.35))}
.brand h1{margin:0;font-size:22px;color:var(--accent);font-weight:700}

/* Card */
.card{
  background:rgba(11,11,11,.9);
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
  box-shadow:0 0 14px rgba(214,180,76,.18), inset 0 0 0 1px rgba(214,180,76,.12);
}

/* KPI layout you asked for */
.kpis{
  display:grid;
  grid-template-columns:minmax(320px, 1.15fr) minmax(360px, 1fr);
  gap:16px;
  margin-bottom:16px;
}
.kpis-right{
  display:grid;
  grid-template-rows:1fr 1fr;
  gap:16px;
}
.kpi h3{margin:0 0 6px;color:var(--accent);font-size:14px}
.kpi-num{font-size:28px;font-weight:900;line-height:1}
.kpi-sub{margin-top:2px;font-size:12px;color:var(--muted)}

/* Table */
.table{width:100%;border-collapse:separate;border-spacing:0;margin-top:10px}
.table th,.table td{padding:10px 12px;border-bottom:1px solid rgba(214,180,76,.25);font-size:13px}
.table th{color:var(--accent);text-align:left;background:rgba(214,180,76,.05)}
.table tr:hover td{background:rgba(214,180,76,.06)}
.table .num{text-align:right;font-feature-settings:"tnum" 1;}

/* Little badges */
.badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:11px;color:var(--muted)}

/* Footer / helper */
.note{font-size:12px;color:var(--muted);margin:10px 2px}

/* Mobile */
@media (max-width: 720px){
  .kpis{grid-template-columns:1fr}
  .kpis-right{grid-template-rows:auto;grid-auto-rows:auto}
  .kpi-num{font-size:24px}
}

/* CTA */
.btn{
  display:inline-flex;align-items:center;gap:8px;
  padding:8px 12px;border-radius:10px;border:1px solid var(--border);
  background:var(--accent);color:#000;font-weight:800;text-decoration:none;font-size:13px
}
.btn:hover{filter:brightness(1.05)}
</style>
</head>
<body>
<div class="wrap">
  <!-- Brand -->
  <div class="brand">
    <img alt="JMBN" src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png/v1/fill/w_66,h_66,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/0_New_JMBN_Logo_Gold.png">
    <h1>JMBN — Earnings & Payouts</h1>
  </div>

  <!-- KPI ROW -->
  <section class="kpis">
    <!-- Left: Org cut (single large card) -->
    <article class="card kpi">
      <h3>Org cut (lifetime)</h3>
      <div class="kpi-num" id="orgLifetime">0</div>
      <div class="kpi-sub">MTD: <span id="orgMTD">0</span></div>
    </article>

    <!-- Right: two stacked cards -->
    <div class="kpis-right">
      <article class="card kpi">
        <h3>You — lifetime earned</h3>
        <div class="kpi-num" id="youLifetime">0</div>
        <div class="kpi-sub"><span id="youMissionsCount">0</span> missions</div>
      </article>
      <article class="card kpi">
        <h3>Latest mission</h3>
        <div class="kpi-num" id="lastMissionPayout">0</div>
        <div class="kpi-sub" id="lastMissionTitle">—</div>
      </article>
    </div>
  </section>

  <!-- Latest 10 -->
  <section class="card">
    <h3 style="margin:0 0 8px;color:var(--accent)">Your latest 10 mission payouts</h3>
    <table class="table" id="latestTable">
      <thead>
        <tr>
          <th style="width:120px">Date</th>
          <th>Mission</th>
          <th class="num">Pool (after org)</th>
          <th class="num">Base share</th>
          <th class="num">Adj. (+/−)</th>
          <th class="num">Final</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="note">Tip: tap a row to reveal the formula breakdown for that mission.</div>
  </section>

  <!-- How base pay is calculated -->
  <section class="card" style="margin-top:16px">
    <h3 style="margin:0 0 8px;color:var(--accent)">How base pay is calculated</h3>
    <ol style="margin:0 0 8px;padding-left:18px;color:var(--text);font-size:13px;line-height:1.5">
      <li><b>Org cut:</b> we take <span class="badge">org_cut_pct</span> from the mission payout.</li>
      <li><b>Weighted split by paygrade:</b> each attendee’s weight comes from <span class="badge">pay_grade_rules</span> via current rank.<br>
        <span class="badge">base_share</span> = <span class="badge">pool_after_org</span> × (<span class="badge">your_weight</span> ÷ <span class="badge">total_weight</span>)</li>
      <li><b>Overrides (optional):</b> per-user <span class="badge">+/− aUEC</span> adjustments.</li>
      <li><b>Final:</b> <span class="badge">base_share</span> + <span class="badge">add_pay_override</span>.</li>
    </ol>
    <div class="note">Org cut comes from <span class="badge">v_mission_org_cut_effective</span> (mission override → else global from <span class="badge">org_cut_settings</span>).</div>
  </section>

  <!-- Lifetime summary -->
  <section class="card" style="margin-top:16px">
    <h3 style="margin:0 0 8px;color:var(--accent)">Your lifetime summary</h3>
    <table class="table" id="lifetimeTable">
      <thead>
        <tr><th>Metric</th><th class="num">Value</th></tr>
      </thead>
      <tbody>
        <tr><td>Total Base</td><td class="num" id="sumBase">0</td></tr>
        <tr><td>Total Overrides</td><td class="num" id="sumAdj">0</td></tr>
        <tr><td><b>Total Earned</b></td><td class="num" id="sumTotal"><b>0</b></td></tr>
      </tbody>
    </table>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
      <a class="btn" id="exportCSV" href="#" download="latest-10-missions.csv">Export last 10</a>
    </div>
  </section>

  <div class="note" style="margin:14px 2px">Theme: Play • Gold Accents</div>
</div>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
(function(){
  const fmt = new Intl.NumberFormat('en-US', {maximumFractionDigits: 2});
  const money = n => fmt.format(Number(n||0));

  const $ = sel => document.querySelector(sel);
  const tbody = $('#latestTable tbody');

  // CSV export helper
  function toCSV(rows){
    if(!rows || !rows.length) return '';
    const headers = Object.keys(rows[0]);
    const esc = v => `"${String(v??'').replaceAll('"','""')}"`;
    return [headers.join(','), ...rows.map(r=>headers.map(h=>esc(r[h])).join(','))].join('\n');
  }

  // Row detail toggle
  function attachToggle(tr, detailHtml){
    tr.style.cursor = 'pointer';
    tr.addEventListener('click', ()=>{
      const open = tr.nextSibling && tr.nextSibling.classList && tr.nextSibling.classList.contains('detail');
      if(open){ tr.nextSibling.remove(); return; }
      const d = document.createElement('tr');
      d.className = 'detail';
      const td = document.createElement('td');
      td.colSpan = 6;
      td.style.background = 'rgba(214,180,76,.05)';
      td.style.fontSize = '12px';
      td.style.lineHeight = '1.5';
      td.innerHTML = detailHtml;
      d.appendChild(td);
      tr.after(d);
    });
  }

  (async function main(){
    const session = await requireAuth();
    if(!session) return;
    const sb = getSupabase();
    const uid = session.user.id;

    // --- ORG KPI ---
    try{
      const { data: orgTot } = await sb.from('v_org_earnings_total').select('*').maybeSingle();
      $('#orgLifetime').textContent = money(orgTot?.org_total_earnings ?? orgTot?.total ?? 0);
    }catch(e){ console.warn('org total', e.message); }

    try{
      const { data: orgM } = await sb.from('v_org_earnings_monthly').select('*').order('month',{ascending:false}).limit(1);
      const mtd = orgM?.[0]?.org_month_earnings ?? orgM?.[0]?.total ?? 0;
      $('#orgMTD').textContent = money(mtd);
    }catch(e){ console.warn('org mtd', e.message); }

    // --- USER LIFETIME KPI / SUMMARY ---
    let life = null;
    try{
      const { data } = await sb.from('v_user_total_earnings').select('*').eq('user_id', uid).maybeSingle();
      life = data || {};
      $('#youLifetime').textContent = money(life.total_earned ?? life.total ?? 0);
      $('#youMissionsCount').textContent = life.missions_count ?? life.count ?? 0;
      $('#sumBase').textContent  = money(life.total_base ?? 0);
      $('#sumAdj').textContent   = money(life.total_overrides ?? 0);
      $('#sumTotal').textContent = money(life.total_earned ?? 0);
    }catch(e){ console.warn('user lifetime', e.message); }

    // --- LATEST 10 MISSIONS (per user) ---
    let latestRows = [];
    try{
      const { data, error } = await sb
        .from('v_mission_payout_with_overrides')
        .select('*')
        .eq('user_id', uid)
        .order('mission_date', { ascending:false })
        .limit(10);
      if(error) throw error;
      latestRows = data || [];
    }catch(e){
      console.warn('latest 10 payouts', e.message);
    }

    // Render table
    tbody.innerHTML = '';
    const csvRows = [];
    for(const r of latestRows){
      // flexible field detection
      const date = r.mission_date || r.start_time || r.created_at;
      const title = r.mission_title || r.title || 'Untitled';
      const pool  = r.pool_after_org ?? r.net_pool_auec ?? r.pool_after_cut ?? 0;
      const base  = r.base_share ?? r.base_auec ?? 0;
      const adj   = r.add_pay_override ?? r.adjust_auec ?? 0;
      const final = r.final_share ?? r.final_auec ?? (Number(base)+Number(adj));

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${ date ? new Date(date).toLocaleDateString() : '—' }</td>
        <td>${ title }</td>
        <td class="num">${ money(pool) }</td>
        <td class="num">${ money(base) }</td>
        <td class="num">${ money(adj) }</td>
        <td class="num"><b>${ money(final) }</b></td>
      `;
      tbody.appendChild(tr);

      // detail line (formula)
      const yourW = r.user_weight ?? r.weight ?? '—';
      const totW  = r.total_weight ?? r.sum_weights ?? '—';
      const orgCut = (r.org_cut_pct ?? r.org_pct ?? 0) * 100;
      attachToggle(tr, `
        <div><b>Formula:</b></div>
        <div>Org cut: <span class="badge">${orgCut.toFixed ? orgCut.toFixed(2) : orgCut}%</span></div>
        <div>Pool after org = payout × (1 − org_cut_pct)</div>
        <div>Base = pool_after_org × (your_weight ÷ total_weight)</div>
        <div>Final = base + add_pay_override</div>
        <div style="margin-top:6px">Your weight: <span class="badge">${yourW}</span> • Total weight: <span class="badge">${totW}</span></div>
      `);

      // for CSV
      csvRows.push({
        date: date ? new Date(date).toISOString().slice(0,10) : '',
        mission: title,
        pool_after_org: pool,
        base_share: base,
        adj_auec: adj,
        final: final
      });
    }

    // Latest mission KPI (top-right, second card)
    if(latestRows.length){
      const r0 = latestRows[0];
      const d0 = r0.mission_date || r0.start_time || r0.created_at;
      const t0 = r0.mission_title || r0.title || 'Untitled';
      const f0 = r0.final_share ?? r0.final_auec ?? (Number(r0.base_share||0)+Number(r0.add_pay_override||0));
      $('#lastMissionPayout').textContent = money(f0);
      $('#lastMissionTitle').textContent = `${t0}${d0? ' • ' + new Date(d0).toLocaleDateString() : ''}`;
    }else{
      $('#lastMissionPayout').textContent = '0';
      $('#lastMissionTitle').textContent = 'No missions yet';
    }

    // CSV export
    $('#exportCSV').addEventListener('click', (e)=>{
      e.preventDefault();
      const csv = toCSV(csvRows);
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'latest-10-missions.csv';
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 500);
    });
  })();
})();
</script>
</body>
</html>