<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JMBN – Rank Progression</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--card:#0c0c0c;--border:#d6b44c;
  --accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;
  --fs-base:14px;--fs-small:11px;--fs-h1:clamp(18px,2.2vw,22px);
}
*{box-sizing:border-box}
body{
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text); font-family:'Play',system-ui,sans-serif;
  margin:0; padding:14px; letter-spacing:.25px; font-size:var(--fs-base);
}

/* panels */
.panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px;margin-top:10px;box-shadow:0 0 18px rgba(214,180,76,.18)}
.section{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:10px}
.h{margin:0 0 8px;color:var(--accent);font-size:16px}

/* top row (current + button) */
.rankRow{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
.rankNow{display:flex;align-items:center;gap:10px}
.rankImg{width:50px;height:50px;border-radius:12px;border:1px solid var(--border);background:#111;object-fit:contain}

/* small pill */
.pill{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;border:1px solid var(--border);border-radius:999px;background:#0e0e0e;color:var(--accent);font-size:12px}

/* button */
.btn{padding:10px 14px;border-radius:12px;background:linear-gradient(180deg,#0c0c0c,#060606);color:var(--accent);border:1px solid var(--border);cursor:pointer;font-family:'Play';font-weight:700}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.btn:hover:not([disabled]){background:var(--accent);color:#000}

/* requirement bars */
.reqRow{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;margin:8px 0}
.barWrap{height:14px;background:#0a0a0a;border:1px solid var(--border);border-radius:999px;overflow:hidden;min-width:220px}
.fill{height:100%;background:linear-gradient(180deg,var(--accent),#d6b44c);width:0%}
.val{font-variant-numeric:tabular-nums;color:var(--muted);font-size:12px}

/* history */
.historyList{font-size:12px;color:var(--muted)}

/* certifications grid (no inner boxes) */
.certGrid{
  display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
  gap:22px;margin-top:10px
}
.cert{
  display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
  text-align:center;min-height:220px;padding:10px 8px;border-radius:14px;
  transition:transform .15s ease, box-shadow .2s ease, filter .2s ease, opacity .2s ease;
  background:transparent; /* no box */
}
.cert .thumb{
  width:128px;height:128px;border-radius:14px;background:#111;border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;overflow:hidden
}
.cert img{max-width:100%;max-height:100%;display:block}
.cert .title{margin-top:10px;font-weight:700}
.cert .code{margin-top:4px;font-size:12px;color:var(--muted)}

/* owned (bright + hover lift) */
.cert.owned{opacity:1;filter:none}
.cert.owned:hover{transform:translateY(-2px);box-shadow:0 0 14px rgba(214,180,76,.25)}

/* not owned (dim) */
.cert.dim{opacity:.55;filter:grayscale(.7) contrast(.9)}

/* header mount fallback (keeps layout stable before header.html loads) */
.brand{display:flex;align-items:center;gap:10px;margin:0 0 8px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.brand-logo{width:44px;height:44px;object-fit:contain;filter:drop-shadow(0 0 4px rgba(242,214,117,.25))}
.brand h1{font-weight:700;font-size:var(--fs-h1);color:var(--accent);margin:0}
.nav{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
.nav-btn{
  --gold:#f2d675;--gold2:#e7c760;--ring:#d6b44c;
  position:relative;display:inline-flex;align-items:center;justify-content:center;
  padding:7px 14px;border:1px solid var(--ring);border-radius:999px;
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);text-decoration:none;font-weight:700;
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.12);
  transition:transform .15s ease, box-shadow .2s ease, background .2s ease;
}
.nav-btn.active{color:#000;background:linear-gradient(180deg,var(--gold),var(--gold2));border-color:var(--ring);box-shadow:0 0 20px rgba(214,180,76,.45)}
</style>
</head>
<body>

<!-- Header (injected) -->
<div id="header-container"></div>
<script>
(async () => {
  try {
    const res = await fetch('header.html', { cache: 'no-cache' });
    const html = await res.text();
    document.getElementById('header-container').outerHTML = html;
    requestAnimationFrame(() => {
      const here = (location.pathname.split('/').pop() || 'rank-progression.html').toLowerCase();
      document.querySelectorAll('.nav-btn').forEach(a => {
        const href = (a.getAttribute('href')||'').toLowerCase();
        if (href === here) a.classList.add('active');
      });
    });
  } catch {}
})();
</script>

<!-- Content -->
<div class="panel">
  <!-- top -->
  <div class="rankRow">
    <div class="rankNow">
      <img id="curImg" class="rankImg" alt="Rank">
      <div>
        <div class="h" style="margin:0">Rank Progression</div>
        <div style="font-size:12px;color:var(--muted)">
          Current: <b id="curRank">—</b>
          <span class="pill" id="curPg">PG: —</span>
        </div>
      </div>
    </div>
    <div>
      <button class="btn" id="btnPromote" disabled>Request Promotion</button>
    </div>
  </div>

  <!-- next -->
  <div class="section">
    <h3 class="h">Next Rank</h3>
    <div style="display:flex;align-items:center;gap:12px">
      <img id="nextImg" class="rankImg" alt="Next">
      <div>
        <div id="nextName" style="font-weight:700;color:var(--accent)">—</div>
        <span class="pill" id="nextPg">PG: —</span>
      </div>
    </div>
  </div>

  <!-- requirements -->
  <div class="section">
    <h3 class="h">Requirements</h3>

    <div class="reqRow">
      <div class="barWrap"><div id="pbMissions" class="fill"></div></div>
      <div class="val" id="valMissions">0 / 0</div>
    </div>

    <div class="reqRow">
      <div class="barWrap"><div id="pbHours" class="fill"></div></div>
      <div class="val" id="valHours">0 / 0</div>
    </div>

    <div class="reqRow">
      <div class="barWrap"><div id="pbCerts" class="fill"></div></div>
      <div class="val" id="valCerts">0 / 0</div>
    </div>

    <div style="margin-top:6px;color:var(--muted);font-size:12px" id="note">
      Promotion is available when all targets are met.
    </div>
  </div>

  <!-- history -->
  <div class="section">
    <h3 class="h">History</h3>
    <div id="history" class="historyList">No changes yet.</div>
  </div>

  <!-- certifications -->
  <div class="section">
    <h3 class="h">Certifications</h3>
    <div id="certGrid" class="certGrid"></div>
    <div style="margin-top:8px;color:var(--muted);font-size:12px">Dim badges are not yet earned.</div>
  </div>
</div>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
const $ = s => document.querySelector(s);
let sb=null, me=null;

/* helpers */
function setFill(sel, pct){
  const el = $(sel);
  const x = Math.max(0, Math.min(1, Number(pct)||0));
  el.style.width = (x*100) + '%';
}

/* MAIN: load rank/targets from v_user_rank_progress only */
async function loadProgress(){
  const { data: prog, error } = await sb
    .from('v_user_rank_progress')
    .select('*')
    .eq('user_id', me)
    .maybeSingle();

  if (error) { console.error(error); }

  // current
  const curCode = prog?.current_code || null;
  $('#curRank').textContent = prog?.current_name || '(unranked)';
  $('#curPg').textContent   = `PG: ${prog?.current_paygrade || '—'}`;

  let curImg = '';
  if (curCode) {
    curImg = sb.storage.from('Ranks').getPublicUrl(`${curCode}.png`).data.publicUrl;
  }
  $('#curImg').src = curImg || '';
  $('#curImg').style.visibility = curImg ? 'visible' : 'hidden';

  // next
  const nextCode = prog?.next_code || null;
  $('#nextName').textContent = prog?.next_name || '—';
  $('#nextPg').textContent   = `PG: ${prog?.next_paygrade || '—'}`;

  let nextImg = '';
  if (nextCode) {
    nextImg = sb.storage.from('Ranks').getPublicUrl(`${nextCode}.png`).data.publicUrl;
  }
  $('#nextImg').src = nextImg || '';
  $('#nextImg').style.visibility = nextImg ? 'visible' : 'hidden';

  // numbers
  const m  = Number(prog?.missions_attended || 0);
  const mt = Number(prog?.missions_target   || 0);
  const h  = Number(prog?.hours_total       || 0);
  const ht = Number(prog?.hours_target      || 0);
  const c  = Number(prog?.certifications_total || 0);
  const ct = Number(prog?.certification_target  || 0);

  $('#valMissions').textContent = `${m} / ${mt}`;
  $('#valHours').textContent    = `${h} / ${ht}`;
  $('#valCerts').textContent    = `${c} / ${ct}`;

  const pm = mt ? Math.min(1, m/mt) : 1;
  const ph = ht ? Math.min(1, h/ht) : 1;
  const pc = ct ? Math.min(1, c/ct) : 1;

  setFill('#pbMissions', pm);
  setFill('#pbHours',    ph);
  setFill('#pbCerts',    pc);

  const canPromote = (!!nextCode) && pm>=1 && ph>=1 && pc>=1;
  $('#btnPromote').disabled = !canPromote;

  if(!nextCode){
    $('#note').textContent = 'You are at the highest rank or next rank is not configured.';
  }else if(!canPromote){
    $('#note').textContent = 'Promotion is available when all targets are met.';
  }else{
    $('#note').textContent = 'All requirements met. You can request promotion.';
  }
}

/* load promotion history (optional) */
async function loadHistory(){
  const { data, error } = await sb
    .from('rank_changes')
    .select('from_rank_code,to_rank_code,changed_by,created_at,reason')
    .eq('user_id', me)
    .order('created_at', { ascending:false })
    .limit(10);
  if(error){ $('#history').textContent = 'Failed to load history.'; return; }
  if(!data?.length){ $('#history').textContent = 'No changes yet.'; return; }

  $('#history').innerHTML = data.map(r=>{
    const when = new Date(r.created_at).toLocaleString();
    const who = r.changed_by?.slice(0,8) || 'system';
    const from = r.from_rank_code || '—';
    const to   = r.to_rank_code || '—';
    const why  = r.reason || '';
    return `<div>• ${when}: ${from} → <b style="color:var(--accent)">${to}</b> by ${who} ${why?`<span style="color:var(--muted)">— ${why}</span>`:''}</div>`;
  }).join('');
}

/* certifications: from v_user_certifications (code, name, image_url, owned bool) */
async function loadCerts(){
  const { data, error } = await sb
    .from('v_user_certifications')
    .select('certification_code,name,image_url,owned,sort_order')
    .eq('user_id', me)
    .order('sort_order',{ascending:true});

  const grid = $('#certGrid');
  if(error){ grid.textContent = 'Failed to load certifications.'; return; }
  if(!data?.length){ grid.textContent = '—'; return; }

  grid.innerHTML = data.map(row=>{
    const owned = !!row.owned;
    const cls = owned ? 'cert owned' : 'cert dim';
    const img = row.image_url || '';
    const code = row.certification_code || '';
    const name = row.name || code || 'Certification';
    return `
      <div class="${cls}" title="${owned?'Obtained':'Not earned'}">
        <div class="thumb">${img?`<img src="${img}" alt="${name}">`:''}</div>
        <div class="title">${name}</div>
        <div class="code">${code}</div>
      </div>`;
  }).join('');
}

/* request promotion RPC (server will validate) */
async function promote(){
  try{
    const { data, error } = await sb.rpc('request_promotion', { p_user: me });
    if(error){ alert('Promotion failed: ' + error.message); return; }
    if(!data?.ok){ alert(data?.message || 'Not eligible.'); return; }
    alert('Promoted to ' + (data.to || 'next rank') + '!');
    await loadProgress();
    await loadHistory();
  }catch(e){ alert('Promotion failed.'); }
}

/* init */
document.addEventListener('DOMContentLoaded', async () => {
  const session = await requireAuth();
  if(!session) return;
  sb = getSupabase();
  me = session.user.id;

  $('#btnPromote').onclick = promote;

  await loadProgress();
  await loadHistory();
  await loadCerts();
});
</script>

</body>
</html>