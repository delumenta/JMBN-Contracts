<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JMBN Rank Progression</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--card:#0c0c0c;--border:#d6b44c;
  --accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;
  --fs-base:14px;--fs-small:11px;--fs-h1:clamp(18px,2.2vw,22px);
}
*{box-sizing:border-box}
body{
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text); font-family:'Play',system-ui,sans-serif;
  margin:0; padding:14px; letter-spacing:.25px; font-size:var(--fs-base);
}

/* Panels & sections */
.panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:14px;margin-top:8px;box-shadow:0 0 18px rgba(214,180,76,.22)}
.section{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px;margin-top:12px}

/* Remove outer box only on Certifications section */
.section:last-of-type{
  border:none;
  box-shadow:none;
  background:transparent;
  padding:0;
}

/* Titles */
.h{margin:0 0 8px;color:var(--accent);font-size:16px}
.badge{border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;background:#121212;color:var(--accent);display:inline-block}

/* Header row */
.rankRow{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
.rankNow{display:flex;align-items:center;gap:10px}
.rankImg{width:48px;height:48px;border-radius:12px;border:1px solid var(--border);background:#111;object-fit:contain}

/* Progress bars */
.pb{display:grid;grid-template-columns:120px 1fr auto;gap:10px;align-items:center;margin:8px 0}
.pb .label{color:var(--muted);font-size:12px}
.bar{height:14px;background:#0a0a0a;border:1px solid var(--border);border-radius:999px;overflow:hidden}
.fill{height:100%;background:linear-gradient(180deg,var(--accent),#d6b44c)}
.pb .val{font-variant-numeric:tabular-nums;color:var(--muted);font-size:12px}

/* Button */
.btn{padding:10px 14px;border-radius:12px;background:linear-gradient(180deg,#0c0c0c,#060606);color:var(--accent);border:1px solid var(--border);cursor:pointer;font-family:'Play';font-weight:700}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.btn:hover:not([disabled]){background:var(--accent);color:#000}

/* Certifications grid & cards */
.certs{margin-top:8px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:14px;justify-items:center;text-align:center}
.cert{
  background:transparent;   /* remove box */
  border:none;              /* remove border */
  border-radius:0;          /* reset radius */
  padding:6px;              /* light padding for spacing */
  display:flex;flex-direction:column;align-items:center;justify-content:flex-start;text-align:center;
  transition:transform .15s ease, box-shadow .25s ease, filter .2s ease, opacity .2s ease;
  box-shadow:none;
}
.cert .thumb{
  width:100px;height:100px;
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
  background:transparent;
}
.cert .thumb img{max-width:100%;max-height:100%;display:block}

/* Dim when not owned */
.cert.dim{opacity:.55;filter:grayscale(.65) contrast(.9)}

/* Owned hover “lift” */
.cert.owned:hover{
  transform:translateY(-3px) scale(1.03);
  filter:saturate(1.2) brightness(1.1);
}
.cert.owned{opacity:1;filter:none}

/* Titles */
.cert .title{font-weight:700;margin-top:8px}
.cert .code{font-size:12px;color:var(--muted);margin-top:4px}
</style>
</head>
<body>
  <div id="header-container"></div>
  <script>
  (async () => {
    try {
      const res = await fetch('header.html', { cache: 'no-cache' });
      const html = await res.text();
      document.getElementById('header-container').outerHTML = html;
      requestAnimationFrame(() => {
        const here = (location.pathname.split('/').pop() || 'rank-progression.html').toLowerCase();
        document.querySelectorAll('.nav-btn').forEach(a => {
          const href = (a.getAttribute('href')||'').toLowerCase();
          if (href === here || href.includes('progression')) a.classList.add('active');
        });
      });
    } catch {}
  })();
  </script>

  <div class="panel">
    <div class="rankRow">
      <div class="rankNow">
        <img id="curImg" class="rankImg" alt="Rank">
        <div>
          <div class="h" style="margin:0">Rank Progression</div>
          <div style="font-size:12px;color:var(--muted)">
            Current: <b id="curRank">—</b>
            <span class="badge" id="curPg">PG: —</span>
          </div>
        </div>
      </div>
      <div>
        <button class="btn" id="btnPromote" disabled>Request Promotion</button>
      </div>
    </div>

    <div class="section">
      <h3 class="h">Next Rank</h3>
      <div style="display:flex;align-items:center;gap:10px">
        <img id="nextImg" class="rankImg" alt="Next">
        <div>
          <div id="nextName" style="font-weight:700;color:var(--accent)">—</div>
          <div class="badge" id="nextPg">PG: —</div>
        </div>
      </div>
    </div>

    <div class="section">
      <h3 class="h">Requirements</h3>
      <div class="pb">
        <div class="label">Missions</div>
        <div class="bar"><div id="pbMissions" class="fill" style="width:0%"></div></div>
        <div class="val" id="valMissions">0 / 0</div>
      </div>
      <div class="pb">
        <div class="label">Hours</div>
        <div class="bar"><div id="pbHours" class="fill" style="width:0%"></div></div>
        <div class="val" id="valHours">0 / 0</div>
      </div>
      <div class="pb">
        <div class="label">Certifications</div>
        <div class="bar"><div id="pbCerts" class="fill" style="width:0%"></div></div>
        <div class="val" id="valCerts">0 / 0</div>
      </div>
      <div style="margin-top:8px;color:var(--muted);font-size:12px" id="note">Promotion is available when all targets are met.</div>
    </div>

    <div class="section">
      <h3 class="h">History</h3>
      <div id="history" style="font-size:12px;color:var(--muted)">No changes yet.</div>
    </div>

    <div class="section certs">
      <h3 class="h">Certifications</h3>
      <div id="certGrid" class="grid"></div>
      <div style="font-size:12px;color:var(--muted);margin-top:6px">Dim badges are not yet earned.</div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/auth.js"></script>
  <script>
    const $ = s => document.querySelector(s);
    let session=null, sb=null, me=null;

    async function loadCerts(){
      const { data, error } = await sb
        .from('v_user_certifications')
        .select('certification_code,name,image_url,is_active,owned')
        .order('sort_order',{ascending:true});
      if(error){ $('#certGrid').innerHTML = '<div style="color:var(--bad)">Failed to load certifications.</div>'; return; }

      $('#certGrid').innerHTML = data.map(row=>{
        const cls = row.owned ? 'cert owned' : 'cert dim';
        return `
          <div class="${cls}">
            <div class="thumb">
              <img src="${row.image_url || ''}" alt="${row.name||row.certification_code}">
            </div>
            <div class="title">${row.name || row.certification_code}</div>
            <div class="code">${row.certification_code}</div>
          </div>`;
      }).join('');
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      session = await requireAuth();
      if(!session) return;
      sb = getSupabase();
      me = session.user.id;
      await loadCerts();
    });
  </script>
</body>
</html>