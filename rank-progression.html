<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JMBN Rank Progression</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--card:#0c0c0c;--border:#d6b44c;
  --accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;
  --fs-base:14px;--fs-small:11px;--fs-h1:clamp(18px,2.2vw,22px);
}
*{box-sizing:border-box}
body{
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text); font-family:'Play',system-ui,sans-serif;
  margin:0; padding:14px; letter-spacing:.25px; font-size:var(--fs-base);
}

/* Panel + sections */
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:8px;box-shadow:0 0 18px rgba(214,180,76,.22)}
.section{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:10px}
.h{margin:0 0 8px;color:var(--accent);font-size:16px}

/* Rank header row */
.rankRow{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
.rankNow{display:flex;align-items:center;gap:10px}
.rankImg{width:46px;height:46px;border-radius:10px;border:1px solid var(--border);background:#111;object-fit:contain}
.badge-pg{border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;background:#121212;color:var(--accent)}

/* Progress bars */
.pb{display:grid;grid-template-columns:140px 1fr auto;gap:10px;align-items:center;margin:8px 0}
.pb .label{color:var(--muted);font-size:12px}
.bar{height:12px;background:#0a0a0a;border:1px solid var(--border);border-radius:999px;overflow:hidden}
.fill{height:100%;background:linear-gradient(180deg,var(--accent),#d6b44c)}
.pb .val{font-variant-numeric:tabular-nums;color:var(--muted);font-size:12px}

/* Button */
.btn{padding:8px 12px;border-radius:10px;background:linear-gradient(180deg,#0c0c0c,#060606);color:var(--accent);border:1px solid var(--border);cursor:pointer;font-family:'Play'}
.btn[disabled]{opacity:.5;cursor:not-allowed}
.btn:hover:not([disabled]){background:var(--accent);color:#000}

/* Certifications grid */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-top:8px}
.cert{
  display:flex;flex-direction:column;align-items:center;justify-content:flex-start;gap:8px;
  min-height:170px;background:transparent;border:none;border-radius:14px;padding:10px;text-align:center;
  transition:transform .25s ease, box-shadow .25s ease, filter .25s ease, scale .25s ease;
}
.thumb{width:98px;height:98px;border-radius:12px;background:#111;display:flex;align-items:center;justify-content:center;overflow:hidden;border:1px solid rgba(214,180,76,.2)}
.thumb img{max-width:100%;max-height:100%;display:block;border-radius:12px}

/* Dim (locked) badges */
.cert.dim{opacity:.55;filter:grayscale(.65) contrast(.9)}

/* Owned (unlocked) badges */
.cert.owned{opacity:1;filter:none;box-shadow:0 0 12px rgba(214,180,76,.25)}
.cert.owned:hover{
  transform:translateY(-4px) scale(1.05);
  box-shadow:0 0 22px rgba(242,214,117,.35), 0 0 40px rgba(242,214,117,.15), inset 0 0 12px rgba(242,214,117,.1);
  filter:saturate(1.2) brightness(1.1);
}

.title{font-weight:700}
.hint{font-size:12px;color:var(--muted)}
.note{color:var(--muted);font-size:12px;margin-top:8px}
</style>
</head>
<body>
  <!-- Shared header loader -->
  <div id="header-container"></div>
  <script>
  (async () => {
    try {
      const res = await fetch('header.html', { cache: 'no-cache' });
      const html = await res.text();
      document.getElementById('header-container').outerHTML = html;
      // highlight current tab ("Progression")
      requestAnimationFrame(() => {
        const here = (location.pathname.split('/').pop() || 'rank-progression.html').toLowerCase();
        document.querySelectorAll('.nav-btn').forEach(a => {
          const href = (a.getAttribute('href')||'').toLowerCase();
          if (href === here || href.includes('rank') || href.includes('progression')) a.classList.add('active');
        });
      });
    } catch {}
  })();
  </script>

  <div class="panel">
    <div class="rankRow">
      <div class="rankNow">
        <img id="curImg" class="rankImg" alt="Rank">
        <div>
          <div class="h" style="margin:0">Rank Progression</div>
          <div style="font-size:12px;color:var(--muted)">
            Current: <b id="curRank">—</b>
            <span class="badge-pg" id="curPg">PG: —</span>
          </div>
        </div>
      </div>
      <div><button class="btn" id="btnPromote" disabled>Request Promotion</button></div>
    </div>

    <div class="section">
      <h3 class="h">Next Rank</h3>
      <div style="display:flex;align-items:center;gap:10px">
        <img id="nextImg" class="rankImg" alt="Next">
        <div>
          <div id="nextName" class="title" style="color:var(--accent)">—</div>
          <div class="badge-pg" id="nextPg">PG: —</div>
        </div>
      </div>
    </div>

    <div class="section">
      <h3 class="h">Requirements</h3>
      <div class="pb">
        <div class="label">Missions</div>
        <div class="bar"><div id="pbMissions" class="fill" style="width:0%"></div></div>
        <div class="val" id="valMissions">0 / 0</div>
      </div>
      <div class="pb">
        <div class="label">Hours</div>
        <div class="bar"><div id="pbHours" class="fill" style="width:0%"></div></div>
        <div class="val" id="valHours">0 / 0</div>
      </div>
      <div class="pb">
        <div class="label">Certifications</div>
        <div class="bar"><div id="pbCerts" class="fill" style="width:0%"></div></div>
        <div class="val" id="valCerts">0 / 0</div>
      </div>
      <div class="note" id="note">Promotion is available when all targets are met.</div>
    </div>

    <div class="section">
      <h3 class="h">History</h3>
      <div id="history" class="hint">No changes yet.</div>
    </div>

    <div class="section">
      <h3 class="h">Certifications</h3>
      <div id="certGrid" class="grid"></div>
      <div class="hint">Dim badges are not yet earned.</div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/auth.js"></script>
  <script>
  const $ = s => document.querySelector(s);

  let sb=null, session=null, me=null;

  function setFill(sel, pct){
    const el = $(sel);
    const x = Math.max(0, Math.min(1, Number(pct)||0));
    el.style.width = (x*100) + '%';
  }

  function safeCap(s){ return (s||'').replace(/\b\w/g, c => c.toUpperCase()); }

  // --- Rank + targets + progress
  async function loadProgress(){
    const { data: prog } = await sb
      .from('v_user_rank_progress')
      .select('*')
      .eq('user_id', me)
      .maybeSingle();

    const curName = prog?.current_name || '(unranked)';
    const curCode = prog?.current_code || null;
    const curPg   = prog?.current_paygrade || '—';
    $('#curRank').textContent = curName;
    $('#curPg').textContent = `PG: ${curPg}`;

    // Rank image: storage Ranks/<code>.png unless v has direct url (not included here)
    const curImgUrl = curCode ? sb.storage.from('Ranks').getPublicUrl(`${curCode}.png`).data.publicUrl : '';
    $('#curImg').src = curImgUrl || '';
    $('#curImg').style.visibility = curImgUrl ? 'visible' : 'hidden';

    const nextCode = prog?.next_code || null;
    const nextName = prog?.next_name || null;
    const nextPg   = prog?.next_paygrade || '—';
    $('#nextName').textContent = nextName || '—';
    $('#nextPg').textContent = `PG: ${nextPg}`;

    const nextImg = nextCode ? sb.storage.from('Ranks').getPublicUrl(`${nextCode}.png`).data.publicUrl : '';
    $('#nextImg').src = nextImg || '';
    $('#nextImg').style.visibility = nextImg ? 'visible' : 'hidden';

    // Progress totals
    const { data: up } = await sb
      .from('v_user_progress')
      .select('*')
      .eq('user_id', me)
      .maybeSingle();

    const missions = Number(up?.missions_attended || 0);
    const hours    = Number(up?.hours_total || 0);
    const certs    = Number(up?.certifications_total || 0);

    const mT = Number(prog?.missions_target || 0);
    const hT = Number(prog?.hours_target || 0);
    const cT = Number(prog?.certification_target || 0);

    $('#valMissions').textContent = `${missions} / ${mT}`;
    $('#valHours').textContent    = `${hours} / ${hT}`;
    $('#valCerts').textContent    = `${certs} / ${cT}`;

    setFill('#pbMissions', mT ? Math.min(1, missions/mT) : 1);
    setFill('#pbHours',    hT ? Math.min(1, hours/hT)    : 1);
    setFill('#pbCerts',    cT ? Math.min(1, certs/cT)    : 1);

    const allMet = (!!nextCode) &&
      (mT ? missions >= mT : true) &&
      (hT ? hours    >= hT : true) &&
      (cT ? certs    >= cT : true);

    $('#btnPromote').disabled = !allMet;
    $('#note').textContent = !nextCode
      ? 'You are at the highest rank or next rank is not configured.'
      : (allMet ? 'All requirements met. You can request promotion.' : 'Promotion is available when all targets are met.');
  }

  async function loadHistory(){
    const { data, error } = await sb
      .from('rank_changes')
      .select('from_rank_code,to_rank_code,changed_by,created_at,reason')
      .eq('user_id', me)
      .order('created_at', { ascending:false })
      .limit(10);

    if(error || !data?.length){
      $('#history').textContent = 'No changes yet.';
      return;
    }
    $('#history').innerHTML = data.map(r=>{
      const when = new Date(r.created_at).toLocaleString();
      const who  = r.changed_by?.slice(0,8) || 'system';
      const from = r.from_rank_code || '—';
      const to   = r.to_rank_code   || '—';
      const why  = r.reason || '';
      return `<div>• ${when}: ${from} → <b style="color:var(--accent)">${to}</b> by ${who} ${why?`<span class="hint">— ${why}</span>`:''}</div>`;
    }).join('');
  }

  // --- Certifications list (catalog + owned)
  async function loadCertifications(){
    const grid = $('#certGrid');
    grid.innerHTML = '<div class="hint">Loading…</div>';

    const { data, error } = await sb
      .from('v_user_certifications')
      .select('*')
      .order('sort_order', { ascending: true });

    if (error){ grid.innerHTML = `<div class="hint">Failed to load certifications.</div>`; return; }

    // Prefer those rows with user_id = me (they exist if owned); the view duplicates each row
    const rows = data
      .filter(r => r.is_active)
      .map(r => ({
        code: r.certification_code,
        name: r.name,
        img:  r.image_url,
        owned: (r.user_id === me) || !!r.owned // view may already expose owned
      }));

    // dedupe by code, prefer owned=true if there’s both versions
    const map = new Map();
    for (const r of rows){
      const prev = map.get(r.code);
      if (!prev || (r.owned && !prev.owned)) map.set(r.code, r);
    }
    const final = Array.from(map.values());

    grid.innerHTML = final.map(r=>{
      const cls = r.owned ? 'cert owned' : 'cert dim';
      // Fallback to storage path if image_url missing
      const img = r.img || sb.storage.from('certification').getPublicUrl(`${r.code}.png`).data.publicUrl || '';
      const alt = r.name || r.code;
      const hint = r.owned ? 'Obtained' : 'Not earned';
      return `
        <div class="${cls}" title="${safeCap(r.name)}">
          <div class="thumb"><img src="${img}" alt="${alt}" loading="lazy"></div>
          <div class="title">${safeCap(r.name)}</div>
          <div class="hint">${hint}</div>
        </div>
      `;
    }).join('');
  }

  async function promote(){
    const { data, error } = await sb.rpc('request_promotion', { p_user: me });
    if(error){ alert('Promotion failed: ' + error.message); return; }
    if(!data?.ok){ alert(data?.message || 'Not eligible.'); return; }
    alert('Promoted to ' + (data.to || 'next rank') + '!');
    await loadProgress();
    await loadHistory();
  }

  document.addEventListener('DOMContentLoaded', async ()=>{
    session = await requireAuth();   // from js/auth.js
    if(!session) return;
    sb = getSupabase();
    me = session.user.id;

    $('#btnPromote').onclick = promote;

    await loadProgress();
    await loadHistory();
    await loadCertifications();
  });
  </script>
</body>
</html>
