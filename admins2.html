<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Contracts</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--border:#d6b44c;--card:#141414;
  --accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;
  --fs-base:14px;--fs-small:11px;--fs-table:13px;--fs-h1:clamp(18px,2.2vw,22px);
}
*{box-sizing:border-box}
body{
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text); font-family:'Play',system-ui,sans-serif;
  margin:0; padding:14px; letter-spacing:.25px; font-size:var(--fs-base);
}

/* Header mount fallback visuals */
.brand{
  display:flex;align-items:center;gap:10px;
  margin:0 0 8px;padding-bottom:6px;
  border-bottom:1px solid var(--border)
}
.brand-logo{
  width:44px;height:44px;object-fit:contain;
  filter:drop-shadow(0 0 4px rgba(242,214,117,.25))
}
.brand h1{
  font-weight:700;font-size:var(--fs-h1);
  color:var(--accent);margin:0
}

/* Panel */
.panel{
  background:var(--panel);border:1px solid var(--border);
  border-radius:12px;padding:12px;margin-top:8px;
  box-shadow:0 0 18px rgba(214,180,76,.22)
}

/* Controls */
.controls{
  display:flex;gap:10px;flex-wrap:wrap;
  margin-bottom:10px;align-items:center
}
input[type="search"]{
  background:#0a0a0a;border:1px solid var(--border);
  border-radius:8px;padding:9px 12px;
  color:var(--text);font-size:var(--fs-table);
  min-width:260px
}
.badge{
  border:1px solid var(--border);padding:6px 10px;
  border-radius:999px;color:var(--accent);font-weight:700;
  font-size:12px
}

/* Table */
.tableWrap{
  border:1px solid var(--border);border-radius:12px;
  overflow:auto;max-height:70vh;
  background:#050505;
}
table{
  width:100%;border-collapse:collapse;
  font-size:var(--fs-table)
}
th,td{
  border-bottom:1px solid rgba(214,180,76,.3);
  padding:10px;text-align:left;vertical-align:middle
}
th{
  color:var(--accent);background:#080808;
  font-weight:600;position:sticky;top:0;z-index:1;
  font-size:12px
}
tr:nth-child(even){background:#111}
tr:hover{background:rgba(214,180,76,.08)}
.name{font-weight:700}

/* Pills & labels */
.pill{
  display:inline-block;border-radius:999px;
  padding:3px 10px;font-size:11px;
  border:1px solid var(--border);
  background:#0c0c0c;color:var(--muted)
}
.status-pill{
  border-color:var(--border);
  color:var(--accent);
}
.status-pill[data-status="Open"]{color:#7af59d;border-color:#7af59d}
.status-pill[data-status="In Progress"]{color:#ffd86b;border-color:#ffd86b}
.status-pill[data-status="Completed"]{color:#7af59d;border-color:#7af59d}
.status-pill[data-status="Cancelled"]{color:var(--bad);border-color:var(--bad)}

/* Buttons */
.btn{
  padding:7px 11px;border-radius:10px;
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);border:1px solid var(--border);
  cursor:pointer;font-family:'Play';
  font-size:12px;transition:.2s
}
.btn:hover{background:var(--accent);color:#000}

/* Meta */
.meta{
  font-size:12px;color:var(--muted);
  padding-top:10px;line-height:1.5
}
.meta b{color:var(--accent)}

/* Modal */
.modal-mask{
  position:fixed;inset:0;background:rgba(0,0,0,.7);
  display:none;align-items:center;justify-content:center;z-index:50
}
.modal{
  background:#0b0b0b;border:1px solid var(--border);border-radius:16px;
  max-width:840px;width:94vw;padding:18px 18px 16px;
  box-shadow:0 0 28px rgba(214,180,76,.3)
}
.modal h3{
  margin:0 0 10px;color:var(--accent);
  font-size:18px;letter-spacing:.3px
}
.modal .header-row{
  display:flex;align-items:center;gap:12px;margin-bottom:6px
}
.modal .header-row .spacer{flex:1}

/* Contract header card */
.contractCard{
  border:1px solid var(--border);border-radius:14px;
  padding:14px;background:#101010;
  display:grid;grid-template-columns:minmax(0,2.2fr) minmax(0,1.2fr);
  gap:12px
}
@media(max-width:720px){
  .contractCard{grid-template-columns:1fr}
}
.contractTitle{
  font-size:16px;font-weight:700;color:var(--accent);
  margin-bottom:4px
}
.contractSub{
  font-size:12px;color:var(--muted);margin-bottom:6px
}
.metaList{
  font-size:13px;color:var(--text);line-height:1.55
}
.metaList b{color:var(--accent)}

/* Sections inside modal */
.divider{
  height:1px;
  background:linear-gradient(90deg,rgba(214,180,76,.15),rgba(214,180,76,.4),rgba(214,180,76,.15));
  border:none;margin:14px 0;
}
.section{
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
  background:#0f0f0f;
  margin-bottom:10px;
}
.section h4{
  margin:0 0 8px;
  color:var(--accent);
  font-size:14px;
  letter-spacing:.3px;
}
.section .body{
  font-size:13px;color:var(--text);line-height:1.6;
  white-space:pre-wrap;word-break:break-word;
}
.section .muted{color:var(--muted)}

/* Simple grid in modal */
.grid-two{
  display:grid;grid-template-columns:1fr 1fr;gap:8px;
  font-size:13px;color:var(--text)
}
@media(max-width:640px){.grid-two{grid-template-columns:1fr}}
.grid-two b{color:var(--accent)}
.mono{font-variant-numeric:tabular-nums}

/* Small util */
.nowrap{white-space:nowrap}
</style>
</head>
<body>

  <!-- Header mount -->
  <div id="header-container">
    <div class="brand">
      <img class="brand-logo" src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png/v1/fill/w_66,h_66,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/0_New_JMBN_Logo_Gold.png" alt="JMBN">
      <h1>JMBN Contracts</h1>
    </div>
  </div>

  <script>
  // Inject shared header + nav
  (async () => {
    try {
      const res = await fetch('header.html', { cache: 'no-cache' });
      if(res.ok){
        const html = await res.text();
        document.getElementById('header-container').outerHTML = html;
        requestAnimationFrame(() => {
          const here = (location.pathname.split('/').pop() || 'contracts.html').toLowerCase();
          document.querySelectorAll('.nav-btn').forEach(a => {
            const href = (a.getAttribute('href')||'').toLowerCase();
            if (href === here) {
              a.classList.add('active');
              a.setAttribute('aria-current','page');
            }
          });
        });
      }
    } catch (e) {
      console.warn('Header load failed:', e);
    }
  })();
  </script>

  <div class="panel">
    <div class="controls">
      <input id="q" type="search" placeholder="Search title, origin, destination, commodity, or tags…">
      <span id="count" class="badge">0 contracts</span>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width:22%">Title</th>
            <th style="width:13%">Category</th>
            <th style="width:13%">Type</th>
            <th style="width:12%">Commodity</th>
            <th style="width:16%">Route</th>
            <th style="width:8%">Payout</th>
            <th style="width:9%">Status</th>
            <th style="width:12%">Posted By</th>
            <th style="width:5%" class="nowrap">View</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="9" style="padding:12px;color:var(--muted)">Loading…</td></tr>
        </tbody>
      </table>
    </div>

    <div class="meta">
      Contracts are read from the <b>contracts</b> table (or view).  
      Adjust the <code>loadContracts()</code> query in the script if your table name or columns differ.
    </div>
  </div>

  <!-- Modal -->
  <div id="viewMask" class="modal-mask" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="header-row">
        <h3 id="viewTitle">Contract</h3>
        <div class="spacer"></div>
        <button class="btn" type="button" onclick="closeView()">Close</button>
      </div>

      <div class="contractCard">
        <div>
          <div class="contractTitle" id="vTitle"></div>
          <div class="contractSub" id="vSubline"></div>
          <div class="metaList">
            <div><b>Category:</b> <span id="vCategory"></span></div>
            <div><b>Type:</b> <span id="vType"></span></div>
            <div><b>Status:</b> <span id="vStatus"></span></div>
            <div><b>Priority:</b> <span id="vPriority"></span></div>
          </div>
        </div>
        <div>
          <div class="grid-two">
            <div><b>Origin</b><br><span id="vOrigin"></span></div>
            <div><b>Destination</b><br><span id="vDestination"></span></div>
            <div><b>Commodity</b><br><span id="vCommodity"></span></div>
            <div><b>Quantity</b><br><span id="vQuantity" class="mono"></span></div>
            <div><b>Payout</b><br><span id="vPayout" class="mono"></span></div>
            <div><b>Tags</b><br><span id="vTags"></span></div>
          </div>
        </div>
      </div>

      <hr class="divider">

      <div class="section">
        <h4>Route & Timing</h4>
        <div class="body">
          <div class="grid-two">
            <div>
              <b>Created At</b><br>
              <span id="vCreated"></span>
            </div>
            <div>
              <b>Expires At</b><br>
              <span id="vExpires"></span>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <h4>Posted By</h4>
        <div class="body">
          <div><b>Posted By:</b> <span id="vPostedBy"></span></div>
          <div><b>Internal ID:</b> <span id="vId" class="mono"></span></div>
        </div>
      </div>

      <div class="section">
        <h4>Notes / Conditions</h4>
        <div class="body" id="vNotes"></div>
      </div>
    </div>
  </div>

  <!-- Supabase & Auth -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/auth.js"></script>

<script>
/* ---------- Utilities ---------- */
const $  = s => document.querySelector(s);
const esc = s => { const d=document.createElement('div'); d.textContent=s??''; return d.innerHTML; };
const toTitleCase = s => s ? s.replace(/\s+/g,' ').trim().toLowerCase().replace(/\b\w/g,c=>c.toUpperCase()) : '';
const fmtNum = n => (n||n===0) ? Number(n).toLocaleString() : '';
const fmtAuec = n => n||n===0 ? fmtNum(n)+' aUEC' : '—';
const fmtDate = iso => {
  if(!iso) return '—';
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return '—';
  return d.toLocaleString();
};

/* ---------- State ---------- */
let sb = null;
let ROWS = [];

const tbody   = $('#tbody');
const countEl = $('#count');
const q       = $('#q');

/* ---------- Render ---------- */
function statusPill(status){
  if(!status) return '<span class="pill status-pill" data-status="">—</span>';
  const s = String(status).trim();
  return `<span class="pill status-pill" data-status="${esc(s)}">${esc(s)}</span>`;
}

function render(rows){
  if(!rows?.length){
    tbody.innerHTML = `<tr><td colspan="9" style="padding:12px;color:var(--muted)">No contracts found</td></tr>`;
    countEl.textContent = '0 contracts';
    return;
  }

  tbody.innerHTML = rows.map(r=>{
    const title   = r.title ? r.title : '(untitled)';
    const category= r.category || '—';
    const type    = r.type || '—';
    const commodity = r.commodity || '—';
    const route   = (r.origin || r.destination)
      ? `${r.origin || '—'} → ${r.destination || '—'}`
      : '—';
    const payout  = fmtNum(r.payout_auec);
    const status  = r.status || '';
    const posted  = r.posted_by || '—';

    return `
      <tr>
        <td class="name">${esc(title)}</td>
        <td>${esc(category)}</td>
        <td>${esc(type)}</td>
        <td>${esc(commodity)}</td>
        <td>${esc(route)}</td>
        <td class="mono nowrap">${payout ? payout : '—'}</td>
        <td>${statusPill(status)}</td>
        <td>${esc(posted)}</td>
        <td><button class="btn" type="button" onclick="viewContract('${r.id}')">View</button></td>
      </tr>`;
  }).join('');

  countEl.textContent = `${rows.length} contract${rows.length===1?'':'s'}`;
}

/* ---------- Filter + apply ---------- */
function filterRows(){
  const term = (q.value || '').toLowerCase().trim();
  if(!term) return ROWS;
  return ROWS.filter(r=>{
    const all = [
      r.title, r.category, r.type, r.status,
      r.origin, r.destination, r.commodity,
      r.tags, r.posted_by
    ].map(x=>x||'').join(' ').toLowerCase();
    return all.includes(term);
  });
}

function applyAndRender(){
  const filtered = filterRows();
  // basic sort: open first, then by created_at desc
  const order = { 'Open':1, 'In Progress':2, 'Completed':3, 'Cancelled':4 };
  filtered.sort((a,b)=>{
    const sa = order[a.status] || 99;
    const sb2= order[b.status] || 99;
    if(sa !== sb2) return sa - sb2;
    const ca = a.created_at || '';
    const cb = b.created_at || '';
    return (cb || '').localeCompare(ca || '');
  });
  render(filtered);
}

/* ---------- Modal ---------- */
function closeView(){ $('#viewMask').style.display='none'; }
window.closeView = closeView;

function viewContract(id){
  const r = ROWS.find(x=>String(x.id)===String(id));
  if(!r) return;

  $('#viewTitle').textContent = `Contract — ${r.title || '(untitled)'}`;
  $('#vTitle').textContent    = r.title || '(untitled)';
  $('#vSubline').textContent  = r.route_label || ''; // optional custom label if you ever add it

  $('#vCategory').textContent = r.category || '—';
  $('#vType').textContent     = r.type || '—';
  $('#vStatus').innerHTML     = statusPill(r.status || '').replace('pill','pill'); // reuse styles
  $('#vPriority').textContent = r.priority || '—';

  $('#vOrigin').textContent      = r.origin || '—';
  $('#vDestination').textContent = r.destination || '—';
  $('#vCommodity').textContent   = r.commodity || '—';
  $('#vQuantity').textContent    = r.quantity ? fmtNum(r.quantity) : '—';
  $('#vPayout').textContent      = fmtAuec(r.payout_auec);
  $('#vTags').textContent        = r.tags || '—';

  $('#vCreated').textContent  = fmtDate(r.created_at);
  $('#vExpires').textContent  = fmtDate(r.expires_at);

  $('#vPostedBy').textContent = r.posted_by || '—';
  $('#vId').textContent       = r.id || '—';

  $('#vNotes').textContent    = r.notes || '—';

  $('#viewMask').style.display = 'flex';
}
window.viewContract = viewContract;

/* ---------- Data load ---------- */
/*
  Adjust the select() list if your table has different columns.
  Expected columns (recommended):
  id (uuid or text),
  title, category, type, status,
  commodity, quantity, origin, destination,
  payout_auec, priority, tags, notes,
  posted_by, created_at, expires_at, route_label (optional).
*/
async function loadContracts(){
  try{
    const { data, error } = await sb
      .from('contracts')
      .select(`
        id,
        title,
        category,
        type,
        status,
        commodity,
        quantity,
        origin,
        destination,
        payout_auec,
        priority,
        tags,
        notes,
        posted_by,
        created_at,
        expires_at,
        route_label
      `)
      .order('created_at',{ascending:false});

    if(error){
      console.warn(error);
      tbody.innerHTML = `<tr><td colspan="9" style="padding:12px;color:var(--bad)">Failed to load: ${esc(error.message)}</td></tr>`;
      countEl.textContent = '0 contracts';
      return;
    }

    ROWS = data || [];
    applyAndRender();
  }catch(e){
    tbody.innerHTML = `<tr><td colspan="9" style="padding:12px;color:var(--bad)">Unexpected error loading contracts.</td></tr>`;
    countEl.textContent = '0 contracts';
    console.warn('loadContracts error:', e);
  }
}

/* ---------- Events ---------- */
q.addEventListener('input', applyAndRender);

/* ---------- Bootstrap with auth ---------- */
document.addEventListener('DOMContentLoaded', async () => {
  const session = await requireAuth(); // from js/auth.js
  if(!session) return;
  sb = getSupabase();                 // from js/auth.js
  loadContracts();
});
</script>
</body>
</html>
