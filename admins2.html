<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN — Member Roster</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  --bg:#000; --border:#d6b44c; --accent:#f2d675; --text:#f7f1d0; --muted:#c9b06a; --bad:#ff6b6b;
  --stroke:#2a2313; --bezel:#0a0a07;
  --fs-base:14px; --fs-small:11px; --fs-table:13px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--text);font-family:'Play',system-ui,sans-serif;
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  font-size:var(--fs-base);
}

/* Header mount */
#header-container{margin:12px 12px 0}

/* Panel shell */
.panel{background:linear-gradient(180deg,#0b0b0b,#080808);border:1px solid var(--border);border-radius:14px;box-shadow:0 0 10px rgba(214,180,76,.15);margin:12px}
.panel-inner{padding:12px}

/* Controls & KPI */
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;align-items:center}
input[type="search"], select{
  background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:9px 12px;color:var(--text);font-size:var(--fs-table)
}
.badge{border:1px solid var(--border);border-radius:999px;padding:6px 10px;color:var(--accent);font-weight:700}

/* Grid */
.mgrid{display:grid;grid-template-columns:360px 1fr;gap:12px}
@media(max-width:1100px){.mgrid{grid-template-columns:1fr}}

/* Left list */
.mlist{
  min-height:420px;max-height:72vh;overflow:auto;border:1px solid var(--stroke);border-radius:10px;background:var(--bezel);
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.06)
}
.mitem{
  padding:10px 12px;border-bottom:1px solid rgba(214,180,76,.08);cursor:pointer;
  background:linear-gradient(180deg,#131008,#0b0905);transition:.12s
}
.mitem:hover{background:#191307}
.mitem.active{outline:1px solid var(--border)}
.mtitle{color:var(--accent);font-weight:700;margin:0 0 2px}
.mmeta{font-size:12px;color:var(--muted)}
.mchips{margin-top:6px;display:flex;gap:6px;flex-wrap:wrap}
.mchip{border:1px solid var(--stroke);border-radius:999px;padding:2px 8px;font-size:11px;color:var(--muted)}

/* Right Inspector */
.inspector{
  border:1px solid var(--stroke);border-radius:10px;background:linear-gradient(180deg,#0b0b0b,#090909);
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.06);padding:12px;min-height:420px
}
.inspector h2{color:var(--accent);margin:0 0 6px;font-size:16px}
.hr{height:1px;background:linear-gradient(90deg,transparent,rgba(214,180,76,.45),transparent);margin:10px 0}
.small{font-size:var(--fs-small);color:var(--muted)}
.mono{font-variant-numeric:tabular-nums}

/* Rank row (no frame around image) */
.rankRow{display:flex;align-items:center;gap:12px;margin:4px 0 8px}
.rankRow img{width:36px;height:36px;object-fit:contain;border:none;background:transparent;border-radius:0;box-shadow:none}

/* Role chips */
.roles{display:flex;flex-wrap:wrap;gap:8px}
.role-chip{border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;color:var(--muted);background:#0c0c0c}

/* Cert gallery (images only) */
.certWrap{display:flex;flex-wrap:wrap;gap:8px}
.certWrap img{width:56px;height:56px;object-fit:contain;display:block;border:none;background:transparent;border-radius:0;box-shadow:none}
</style>
</head>
<body>

<!-- Shared Header -->
<div id="header-container"></div>
<script>
(async()=>{
  try{
    const res=await fetch('header.html',{cache:'no-cache'});
    if(res.ok){
      const html=await res.text();
      document.getElementById('header-container').outerHTML=html;
      requestAnimationFrame(()=>{
        const here=(location.pathname.split('/').pop()||'member.html').toLowerCase();
        document.querySelectorAll('.nav-btn').forEach(a=>{
          const href=(a.getAttribute('href')||'').toLowerCase();
          if(href===here || (/member/.test(here)&&/member/.test(href))) a.classList.add('active');
        });
      });
    }
  }catch(e){ console.warn('Header load failed:',e); }
})();
</script>

<!-- Main Panel -->
<section class="panel">
  <div class="panel-inner">

    <!-- Controls -->
    <div class="controls">
      <input id="q" type="search" placeholder="Search handle, rank, specialization…">
      <span id="count" class="badge">0 members</span>
    </div>

    <!-- Two-pane -->
    <div class="mgrid">
      <!-- Left list -->
      <div id="mList" class="mlist">
        <div class="small" style="padding:10px">Loading…</div>
      </div>

      <!-- Right inspector -->
      <div id="inspector" class="inspector">
        <h2>Member Details</h2>
        <div class="small">Select a member on the left to view their profile.</div>
      </div>
    </div>
  </div>
</section>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>

<script>
/* ===== Helpers ===== */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const esc=s=>{const d=document.createElement('div');d.textContent=s??'';return d.innerHTML;};
const titleCase=s=>s?String(s).toLowerCase().replace(/\s+/g,' ').trim().replace(/\b\w/g,c=>c.toUpperCase()):'';
const rolesNorm=v=>{
  if(!v) return [];
  if(Array.isArray(v)) return v.map(titleCase).filter(Boolean);
  return String(v).split(/[,/;]+/).map(titleCase).filter(Boolean);
};

/* ===== State ===== */
let sb=null, session=null;
let ROWS=[], FILTERED=[], selectedId=null;

const RANK_BUCKET='Ranks', CERT_BUCKET='Certifications';
const rankUrl=code=> code ? sb.storage.from(RANK_BUCKET).getPublicUrl(`${code}.png`).data.publicUrl : '';
const certUrl=code=> code ? sb.storage.from(CERT_BUCKET).getPublicUrl(`${code}.png`).data.publicUrl : '';

/* ===== UI Wiring ===== */
$('#q').addEventListener('input', ()=>{ applyFilter(); renderList(); if(selectedId) renderInspector(ROWS.find(r=>r.user_id===selectedId)||null); });

/* ===== Boot ===== */
document.addEventListener('DOMContentLoaded', async ()=>{
  session=await requireAuth(); if(!session) return;
  sb=getSupabase();
  await loadRoster();
});

/* ===== Data ===== */
async function loadRoster(){
  const { data, error } = await sb
    .from('v_profiles_detailed')
    .select(`
      user_id,
      handle,
      display_name,
      current_rank_category,
      current_rank_name,
      current_rank_code,
      current_rank_image_url,
      ingame_role,
      missions_attended
    `)
    .order('current_rank_category',{ascending:true})
    .order('handle',{ascending:true});

  if(error){
    $('#mList').innerHTML = `<div class="small" style="padding:10px;color:var(--bad)">Failed to load: ${esc(error.message)}</div>`;
    $('#count').textContent='0 members';
    return;
  }
  ROWS=data||[];
  applyFilter();
  renderList();
}

/* ===== Filter ===== */
function applyFilter(){
  const q=($('#q').value||'').toLowerCase().trim();
  FILTERED = !q ? ROWS.slice() : ROWS.filter(r=>{
    const text = `${r.handle||''} ${r.display_name||''} ${r.current_rank_category||''} ${r.current_rank_name||''} ${r.current_rank_code||''} ${rolesNorm(r.ingame_role).join(' ')}`.toLowerCase();
    return text.includes(q);
  });
  $('#count').textContent = `${FILTERED.length} member${FILTERED.length===1?'':'s'}`;
}

/* ===== List ===== */
function itemHtml(r){
  const handle=titleCase(r.handle||r.display_name||r.user_id?.slice(0,8)||'(unknown)');
  const rankCat=r.current_rank_category?titleCase(r.current_rank_category):'—';
  const rankName=r.current_rank_name?titleCase(r.current_rank_name):'Unrated';
  const chips = rolesNorm(r.ingame_role);
  return `
  <div class="mitem" data-id="${r.user_id}" onclick="inspect('${r.user_id}')">
    <div class="mtitle">${esc(handle)}</div>
    <div class="mmeta">${esc(rankCat)} • ${esc(rankName)}</div>
    ${chips.length?`<div class="mchips">${chips.slice(0,4).map(c=>`<span class="mchip">${esc(c)}</span>`).join('')}${chips.length>4?`<span class="mchip">+${chips.length-4}</span>`:''}</div>`:''}
  </div>`;
}
function renderList(){
  const list=$('#mList');
  if(!FILTERED.length){ list.innerHTML='<div class="small" style="padding:10px">No members found.</div>'; return; }
  list.innerHTML = FILTERED.map(itemHtml).join('');
  if(selectedId){
    const el=list.querySelector(`.mitem[data-id="${selectedId}"]`);
    if(el) el.classList.add('active');
  }
}
window.inspect=id=>{
  const r = FILTERED.find(x=>x.user_id===id) || ROWS.find(x=>x.user_id===id);
  renderInspector(r||null);
  selectedId=id;
  $$('.mitem').forEach(x=>x.classList.toggle('active', x.dataset.id===id));
  if(window.matchMedia('(max-width:1100px)').matches){
    document.getElementById('inspector').scrollIntoView({behavior:'smooth',block:'start'});
  }
};

/* ===== Inspector ===== */
async function renderInspector(r){
  const box=$('#inspector');
  if(!r){ box.innerHTML=`<h2>Member Details</h2><div class="small">Select a member on the left to view their profile.</div>`; return; }

  const handle=titleCase(r.handle||r.display_name||r.user_id.slice(0,8));
  const rankCat=r.current_rank_category?titleCase(r.current_rank_category):'—';
  const rankName=r.current_rank_name?titleCase(r.current_rank_name):'Unrated';
  const img = r.current_rank_image_url || rankUrl(r.current_rank_code);
  const roles = rolesNorm(r.ingame_role);
  const attended = Number(r.missions_attended)||0;

  // Load cert images (owned only)
  let certImgs=[];
  try{
    const { data: certs } = await sb
      .from('v_user_certifications')
      .select('certification_code,image_url,owned')
      .eq('user_id', r.user_id);
    certImgs = (certs||[])
      .filter(c=>c.owned)
      .map(c=> c.image_url || certUrl(c.certification_code))
      .filter(Boolean);
  }catch{}

  box.innerHTML = `
    <h2>${esc(handle)}</h2>
    <div class="rankRow">
      ${img?`<img src="${esc(img)}" alt="${esc(r.current_rank_code||'Rank')}" onerror="this.style.display='none'">`:''}
      <div>
        <div class="small">Rank Category</div>
        <div style="margin-bottom:2px"><b>${esc(rankCat)}</b></div>
        <div class="small">Current Rank</div>
        <div>${esc(rankName)} ${r.current_rank_code?`<span class="small" style="color:var(--muted)">(${esc(r.current_rank_code)})</span>`:''}</div>
      </div>
    </div>

    <div class="hr"></div>

    <div class="small">Roles / Specialization</div>
    ${roles.length?`<div class="roles" style="margin-top:6px">${roles.map(x=>`<span class="role-chip">${esc(x)}</span>`).join('')}</div>`:`<div style="color:var(--muted);margin-top:6px">—</div>`}

    <div class="hr"></div>

    <div class="small">Missions attended</div>
    <div style="margin-top:4px;font-weight:700">${attended.toLocaleString()}</div>

    <div class="hr"></div>

    <div class="small">Certifications</div>
    <div class="certWrap" style="margin-top:6px">
      ${certImgs.length? certImgs.map(u=>`<img src="${esc(u)}" alt="" loading="lazy" onerror="this.style.display='none'">`).join('') : ''}
    </div>
  `;
}
</script>
</body>
</html>