<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Mission Log — Contract Manager</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  /* JMBN palette */
  --bg:#000; --border:#d6b44c; --accent:#f2d675; --accent2:#e7c760;
  --text:#f7f1d0; --muted:#c9b06a; --bad:#ff6b6b;

  /* Bezel lines */
  --stroke:#2e2612;   /* inner edge (warm) */
  --bezel:#0b0b0b;    /* panel base */

  --fs-base:14px; --fs-small:11px; --fs-table:13px; --fs-h1:clamp(18px,2.2vw,22px);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;color:var(--text);font-family:'Play',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  font-size:var(--fs-base);
}

/* Shared header mount */
#header-container{margin:12px 12px 0}

/* Main panel */
.panel{background:linear-gradient(180deg,#0b0b0b,#080808);border:1px solid var(--border);border-radius:14px;box-shadow:0 0 10px rgba(214,180,76,.15);margin:12px}
.panel-inner{padding:12px}

/* Tabs (GENERAL + HISTORY only) */
.tabs{display:flex;gap:8px;margin:4px 0 10px}
.tab{
  padding:8px 12px;border:1px solid var(--border);border-radius:8px;
  background:linear-gradient(180deg,#0e0e0e,#0a0a0a);
  color:var(--accent);letter-spacing:.35px;cursor:pointer;transition:.15s;
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.14);
}
.tab:hover{filter:brightness(1.08)}
.tab.active{box-shadow:0 0 0 1px rgba(214,180,76,.35), inset 0 0 0 1px rgba(214,180,76,.25)}

/* Controls & KPI */
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
input,select{
  background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:9px;color:var(--text);font-size:var(--fs-table);font-family:'Play'
}
button,.small-btn{
  padding:8px 12px;border-radius:10px;background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);border:1px solid var(--border);cursor:pointer;font-family:'Play';transition:.2s
}
button:hover,.small-btn:hover{background:var(--accent);color:#000}

.kpis{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin:8px 0}
@media(max-width:880px){.kpis{grid-template-columns:1fr}}
.kpi{
  background:linear-gradient(180deg,#0b0b0b,#080808);border:1px solid var(--border);border-radius:12px;padding:12px;
  box-shadow:0 0 8px rgba(214,180,76,.12), inset 0 0 0 1px rgba(214,180,76,.08)
}
.kpi-title{font-size:12px;color:var(--muted);margin-bottom:6px}
.kpi-value{font-size:22px;font-weight:700;color:var(--accent);line-height:1}
.kpi-sub{font-size:12px;color:var(--muted);margin-top:4px}

/* Two-pane */
.mgrid{display:grid;grid-template-columns:360px 1fr;gap:12px}
@media(max-width:1100px){.mgrid{grid-template-columns:1fr}}
.mlist{
  min-height:420px;max-height:72vh;overflow:auto;border:1px solid var(--stroke);border-radius:10px;background:var(--bezel);
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.06)
}
.mitem{
  padding:10px 12px;border-bottom:1px solid rgba(214,180,76,.08);cursor:pointer;
  background:linear-gradient(180deg,#0d0d0d,#0a0a0a);transition:.12s
}
.mitem:hover{background:#131313}
.mitem.active{outline:1px solid var(--border)}
.mtitle{color:var(--accent);font-weight:700;margin-bottom:3px}
.mmeta{font-size:12px;color:var(--muted)}
.mchips{margin-top:6px;display:flex;gap:6px;flex-wrap:wrap}
.mchip{
  border:1px solid var(--stroke);border-radius:999px;padding:2px 8px;font-size:11px;color:var(--muted)
}

/* Inspector */
.inspector{
  min-height:420px;border:1px solid var(--stroke);border-radius:10px;background:linear-gradient(180deg,#0c0c0c,#090909);
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.06);padding:12px
}
.inspector h2{color:var(--accent);margin:0 0 6px;font-size:16px}
.hr{height:1px;background:linear-gradient(90deg,transparent,rgba(214,180,76,.35),transparent);margin:10px 0}
.small{font-size:var(--fs-small);color:var(--muted)}
.pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px;color:var(--muted)}
.pill.res{color:#f2d675;border-color:#f2d675}
.pill.op{color:#7bd88f;border-color:#7bd88f}
.mono{font-variant-numeric:tabular-nums}
.nowrap{white-space:nowrap}

/* GOLD CTA — used by Accept, Attendance, Open */
.btn-cta{
  padding:10px 14px;border-radius:8px;border:1px solid var(--border);
  background:linear-gradient(180deg,var(--accent),var(--accent2));
  color:#000;font-weight:700;letter-spacing:.35px;transition:.15s;
  box-shadow:0 0 12px rgba(214,180,76,.25), inset 0 0 0 1px rgba(0,0,0,.15);
}
.btn-cta:hover{filter:brightness(1.05)}

/* Ongoing strip */
.ongoing-head{padding:8px 12px;color:var(--muted);background:#111;border-top:1px solid rgba(214,180,76,.12)}
.ongoing-item{padding:8px 12px;border-top:1px dashed rgba(214,180,76,.1);font-size:12px;color:var(--muted)}
.ongoing-title{color:var(--accent);font-weight:700}

/* Attendance Modal */
.modal-mask{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
.modal{background:#0b0b0b;border:1px solid var(--border);border-radius:12px;max-width:760px;width:92vw;padding:14px;box-shadow:0 0 22px rgba(214,180,76,.25)}
.modal h3{margin:0 0 10px;color:var(--accent);font-size:16px}
.modal .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
.modal .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:999px;padding:6px 10px}
.modal .chip .x{cursor:pointer;border:1px solid var(--border);border-radius:6px;background:transparent;color:var(--muted);padding:0 6px}
.modal .chip .x:hover{background:#111;color:#ff6b6b}
.modal .chip select{background:#0a0a0a;border:1px solid var(--border);border-radius:8px;padding:4px 8px;color:var(--text);font-family:'Play';font-size:12px}
.modal .list{display:flex;gap:8px;flex-wrap:wrap}
.chip[data-attendance="not_going"]{border-color:rgba(255,107,107,.6);color:#ff6b6b}
</style>
</head>
<body>
  <!-- Shared Header -->
  <div id="header-container"></div>
  <script>
    (async () => {
      try{
        const res = await fetch('header.html',{cache:'no-cache'});
        const html = await res.text();
        document.getElementById('header-container').outerHTML = html;
        requestAnimationFrame(()=>{
          const here = (location.pathname.split('/').pop()||'mission-log.html').toLowerCase();
          document.querySelectorAll('.nav-btn').forEach(a=>{
            const href=(a.getAttribute('href')||'').toLowerCase();
            if(href===here){a.classList.add('active');a.setAttribute('aria-current','page');}
          });
        });
      }catch(e){console.warn('Header load failed:',e);}
    })();
  </script>

  <!-- Contract Manager Board -->
  <section class="panel">
    <div class="panel-inner">
      <!-- Tabs (GENERAL + HISTORY) -->
      <div class="tabs" id="tabs">
        <div class="tab active" data-scope="">GENERAL</div>
        <div class="tab" data-scope="history">HISTORY</div>
      </div>

      <!-- Controls -->
      <div class="controls">
        <input id="search" placeholder="Search contracts (title, type, status, tags, route)">
        <select id="catFilter">
          <option value="">All Categories</option>
          <option value="Resource">Resource</option>
          <option value="Operations">Operations</option>
        </select>
        <select id="statusFilter">
          <option value="">All Status</option>
          <option>planned</option>
          <option>active</option>
          <option>success</option>
          <option>fail</option>
          <option>abort</option>
        </select>
        <button class="small-btn" id="btnExport">Export CSV</button>
      </div>

      <!-- KPIs -->
      <div class="kpis">
        <div class="kpi">
          <div class="kpi-title">Total Missions</div>
          <div class="kpi-value" id="kpiCount">0</div>
          <div class="kpi-sub">after filters</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">Resource : Ops</div>
          <div class="kpi-value" id="kpiMix">0 : 0</div>
          <div class="kpi-sub">derived from type</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">Avg Payout (shown)</div>
          <div class="kpi-value mono" id="kpiAvg">-</div>
          <div class="kpi-sub">aUEC</div>
        </div>
      </div>

      <!-- Two Pane -->
      <div class="mgrid">
        <!-- Left: Mission List + Ongoing -->
        <div class="mlist" id="mList"></div>

        <!-- Right: Inspector -->
        <div class="inspector" id="inspector">
          <h2>Mission Details</h2>
          <div class="small">Select a contract on the left to view its briefing.</div>
        </div>
      </div>

      <div id="feedEmpty" class="small" style="display:none;margin-top:8px">No missions match your filters.</div>
    </div>
  </section>

  <!-- Attendance Modal -->
  <div id="attModalMask" class="modal-mask" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
        <h3 id="attTitle" style="margin-right:auto">Attendance</h3>
        <button class="small-btn" onclick="closeAttendance()">Close</button>
      </div>

      <div class="row">
        <button id="attIamGoing" class="btn-cta">I’m going</button>
        <button id="attNotGoing" class="btn-cta">Not going</button>
        <button id="attWithdraw" class="btn-cta">Withdraw</button>
        <select id="attSelfRole" style="min-width:180px;background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:8px;color:var(--text)"></select>
        <span class="small">Pick <b>your role</b> (optional).</span>
      </div>

      <div id="attElevatedTools" class="row" style="display:none">
        <input id="attAddEmail" placeholder="Add by email (crew@example.com)" style="flex:1;min-width:260px;background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:8px;color:var(--text)">
        <select id="attAddRole" style="background:#0a0a0a;border:1px solid var(--border);border-radius:10px;padding:8px;color:var(--text)">
          <option value="">Role (optional)</option>
        </select>
        <button id="attAddBtn" class="btn-cta">Add</button>
        <span class="small">Admin/Owner can add/remove attendees.</span>
      </div>

      <div class="row">
        <strong class="small">Attendees:</strong>
        <div id="attList" class="list"></div>
      </div>
    </div>
  </div>

  <!-- Supabase & Auth -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="js/auth.js"></script>

<script>
/* ========= Helpers ========= */
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const esc=s=>{const d=document.createElement('div'); d.textContent=s??''; return d.innerHTML;};
const fmtDate = iso => {
  if(!iso) return '';
  const d = new Date(iso);
  return d.toLocaleString('en-SG', {
    day:'numeric', month:'long', year:'numeric',
    hour:'numeric', minute:'2-digit', hour12:true
  }).replace(/\s?([ap])m/i,'$1m');
};
const fmtNum=n=> (n||n===0) ? Number(n).toLocaleString() : '';

const RESOURCE_TYPES = new Set(['hauling','cargo','salvage','mining','delivery']);
function deriveCategory(type){
  const t=(type||'').toString().trim().toLowerCase();
  return RESOURCE_TYPES.has(t) ? 'Resource' : 'Operations';
}

/* ========= Roles (Attendance) ========= */
let ROLES=[];
const DEFAULT_ROLES=[
  {label:'operations lead'},{label:'pilot'},{label:'copilot'},{label:'escort'},
  {label:'tactician'},{label:'fps'},{label:'gunner'},{label:'hauler'},
  {label:'miner'},{label:'salvager'},{label:'engineer'},{label:'medic'},
  {label:'recon'},{label:'runner'},{label:'logistics'},{label:'security'}
];
function roleOptionsHtml(placeholder){
  const items=(ROLES.length?ROLES:DEFAULT_ROLES).map(r=>`<option value="${r.label}">${r.label}</option>`).join('');
  return `<option value="">${placeholder}</option>`+items;
}
async function fetchRoles(sb){
  const { data, error } = await sb.from('mission_roles').select('label').order('sort_order',{ascending:true}).order('label',{ascending:true});
  ROLES=(error||!data||!data.length)?DEFAULT_ROLES:data;
}

/* ========= State ========= */
let sb=null, session=null;
let allMissions=[];      // raw
let filtered=[];         // after filters
let selectedId=null;     // inspector target
let currentScope="";     // "", history

/* ========= Tabs ========= */
document.getElementById('tabs').addEventListener('click',(e)=>{
  const t=e.target.closest('.tab'); if(!t) return;
  $$('#tabs .tab').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  currentScope=t.dataset.scope||"";
  renderFiltered();
});

/* ========= Controls ========= */
$('#search').addEventListener('input', renderFiltered);
$('#catFilter').addEventListener('input', renderFiltered);