<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Operations Log</title>

<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png"
      href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png"
      sizes="32x32">

<style>
:root{
  --bg:#000;
  --panel:#0b0b0b;
  --panel-soft:#101010;
  --row:#0a0a0a;
  --border:#d6b44c;
  --accent:#f2d675;
  --accent-soft:#c9b06a;
  --text:#f7f1d0;
  --muted:#b9a76a;
  --bad:#ff6b6b;
  --good:#37d996;
  --fs-base:14px;
  --fs-small:11px;
  --fs-table:13px;
  --fs-h1:clamp(18px,2.2vw,22px);
}
*{box-sizing:border-box}
body{
  margin:0;
  padding:14px;
  font-family:'Play',system-ui,sans-serif;
  font-size:var(--fs-base);
  color:var(--text);
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
}

/* Brand */
.brand{
  display:flex;align-items:center;gap:10px;
  margin:0 0 8px;
  border-bottom:1px solid var(--border);
  padding-bottom:6px;
}
.brand-logo{
  width:44px;height:44px;object-fit:contain;
  filter:drop-shadow(0 0 4px rgba(242,214,117,.25));
}
.brand h1{
  margin:0;color:var(--accent);font-size:var(--fs-h1);font-weight:700;
}
.brand-sub{
  font-size:var(--fs-small);color:var(--muted);margin-left:auto;
}

/* Nav */
.nav{
  display:flex;align-items:center;gap:8px;flex-wrap:wrap;
  margin:6px 0 12px;
}
.nav-btn{
  --ring:#d6b44c;
  position:relative;
  display:inline-flex;align-items:center;justify-content:center;
  padding:7px 14px;
  border-radius:999px;
  border:1px solid var(--ring);
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);
  text-decoration:none;
  font-weight:700;
  letter-spacing:.2px;
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.12);
  transition:transform .15s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
}
.nav-btn:hover{
  transform:translateY(-1px);
  box-shadow:0 0 12px rgba(214,180,76,.25), inset 0 0 0 1px rgba(214,180,76,.18);
  background:linear-gradient(180deg,#1a1a1a,#0a0a0a);
}
.nav-btn.active{
  color:#000;
  background:
    radial-gradient(120% 120% at 80% -20%, rgba(255,255,255,.32), rgba(255,255,255,0) 40%),
    linear-gradient(180deg,#f2d675,#e7c760);
  box-shadow:0 0 20px rgba(214,180,76,.45),
             inset 0 1px 0 rgba(255,255,255,.25),
             inset 0 -1px 0 rgba(0,0,0,.12);
}

/* Layout */
.grid{
  display:grid;
  grid-template-columns:minmax(250px,280px) minmax(0,1fr);
  gap:12px;
}
@media(max-width:880px){
  .grid{grid-template-columns:1fr}
}

/* Panels */
.panel{
  background:var(--panel);
  border-radius:12px;
  border:1px solid var(--border);
  box-shadow:
    0 0 18px rgba(214,180,76,.18),
    inset 0 0 0 1px rgba(214,180,76,.08);
}
.panel-inner{padding:12px}

/* Sidebar / console */
.console-header{
  display:flex;align-items:center;justify-content:space-between;
  gap:8px;margin-bottom:8px;
}
.console-title{
  font-size:12px;text-transform:uppercase;color:var(--muted);letter-spacing:.16em;
}
.console-pill{
  font-size:11px;color:var(--accent-soft);
  border-radius:999px;
  border:1px solid rgba(214,180,76,.6);
  padding:3px 10px;
  background:#050505;
}

input[type="search"], select{
  width:100%;
  background:#050505;
  border:1px solid var(--border);
  border-radius:10px;
  padding:8px 10px;
  color:var(--text);
  font-family:'Play';
  font-size:var(--fs-table);
}
select{min-width:0}
.field-label{
  font-size:var(--fs-small);color:var(--muted);
  margin:10px 0 4px;
  text-transform:uppercase;letter-spacing:.16em;
}

/* Toggle + Export */
.view-toggle-wrap{
  display:flex;align-items:center;justify-content:space-between;
  gap:6px;margin-top:10px;margin-bottom:6px;
}
.toggle-group{
  display:inline-flex;background:#050505;border-radius:999px;
  padding:2px;border:1px solid var(--border);
}
.toggle-btn{
  border-radius:999px;border:none;background:transparent;
  color:var(--muted);padding:4px 10px;font-size:11px;
  cursor:pointer;font-family:'Play';
}
.toggle-btn.active{
  background:linear-gradient(180deg,#f2d675,#e7c760);
  color:#000;
}
.icon-btn{
  border-radius:10px;
  border:1px solid var(--border);
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);
  padding:6px 10px;
  font-size:11px;
  cursor:pointer;
  display:inline-flex;align-items:center;gap:5px;
}
.icon-btn span{font-size:13px}
.icon-btn:hover{background:var(--accent);color:#000}

/* KPIs */
.kpi-grid{
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:7px;
  margin-top:8px;
}
@media(max-width:880px){
  .kpi-grid{grid-template-columns:repeat(2,minmax(0,1fr))}
}
.kpi{
  background:#101010;
  border-radius:10px;
  border:1px solid rgba(214,180,76,.7);
  padding:8px;
  box-shadow:0 0 12px rgba(214,180,76,.15);
}
.kpi-title{
  font-size:10px;color:var(--muted);
  text-transform:uppercase;letter-spacing:.14em;
}
.kpi-value{
  margin-top:4px;font-size:18px;font-weight:700;color:var(--accent);
}
.kpi-sub{
  margin-top:2px;font-size:10px;color:var(--muted);
}

/* Quick tags */
.tag-cloud{
  margin-top:8px;display:flex;flex-wrap:wrap;gap:6px;
}
.chip{
  font-size:11px;color:var(--accent-soft);
  border-radius:999px;
  border:1px dashed rgba(214,180,76,.7);
  padding:3px 9px;
  background:rgba(12,12,12,.9);
  cursor:pointer;
}
.chip:hover{
  background:rgba(214,180,76,.12);
}

/* Main timeline view */
.main-panel{
  position:relative;
  overflow:hidden;
}
.main-header{
  display:flex;align-items:center;justify-content:space-between;
  gap:8px;margin-bottom:8px;
}
.main-title{
  font-size:12px;text-transform:uppercase;letter-spacing:.16em;
  color:var(--muted);
}
.main-sub{font-size:var(--fs-small);color:var(--muted);}

.timeline{
  position:relative;
  padding-left:18px;
  margin-left:2px;
}
.timeline::before{
  content:"";
  position:absolute;top:0;bottom:0;left:3px;
  width:2px;
  background:linear-gradient(to bottom,
    rgba(214,180,76,.7),
    rgba(214,180,76,.1));
  box-shadow:0 0 8px rgba(214,180,76,.7);
}
.day-group{margin-bottom:12px}
.day-header{
  display:inline-flex;align-items:center;gap:6px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid rgba(214,180,76,.8);
  background:#050505;
  font-size:11px;color:var(--accent-soft);
  margin-bottom:6px;
}
.day-header span:nth-child(1){
  font-size:14px;
}
.day-header span:nth-child(2){
  text-transform:uppercase;letter-spacing:.16em;font-size:10px;
}

.op-card{
  position:relative;
  margin:4px 0 8px;
  margin-left:8px;
  padding:10px 11px;
  border-radius:12px;
  border:1px solid rgba(214,180,76,.6);
  background:
    radial-gradient(900px 400px at 110% -10%,rgba(242,214,117,.06),transparent 55%),
    #050505;
  box-shadow:
    0 0 14px rgba(214,180,76,.20),
    inset 0 0 0 1px rgba(214,180,76,.10);
  cursor:pointer;
  transition:transform .15s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
}
.op-card::before{
  content:"";
  position:absolute;
  width:8px;height:8px;
  border-radius:50%;
  border:2px solid #000;
  background:var(--accent);
  left:-13px;top:14px;
  box-shadow:0 0 10px rgba(242,214,117,.8);
}
.op-card:hover{
  transform:translateY(-1px);
  box-shadow:
    0 0 20px rgba(214,180,76,.35),
    inset 0 0 0 1px rgba(214,180,76,.14);
  border-color:#f2d675;
  background:
    radial-gradient(900px 400px at 90% -10%,rgba(242,214,117,.12),transparent 60%),
    #060606;
}
.op-main{
  display:flex;align-items:flex-start;justify-content:space-between;gap:8px;
}
.op-title{
  font-size:14px;font-weight:700;color:var(--accent);
  margin-bottom:2px;
}
.op-meta{
  font-size:11px;color:var(--muted);
}
.badge{
  display:inline-flex;align-items:center;gap:4px;
  border-radius:999px;
  padding:2px 7px;
  font-size:10px;
  border:1px solid rgba(214,180,76,.8);
  background:#101010;
  color:var(--accent-soft);
}
.badge-type{margin-right:4px}
.badge-status{
  border-color:rgba(55,217,150,.8);
  color:var(--good);
}
.badge-status.bad-ops{
  border-color:rgba(255,107,107,.8);
  color:var(--bad);
}
.op-right{
  text-align:right;font-size:11px;color:var(--muted);
}
.op-right strong{color:var(--accent-soft)}
.op-tags{
  margin-top:5px;font-size:11px;color:var(--muted);
  display:flex;flex-wrap:wrap;gap:5px;
}
.op-tag-pill{
  border-radius:999px;border:1px dashed rgba(214,180,76,.5);
  padding:2px 7px;
}
.op-footer{
  margin-top:6px;
  display:flex;align-items:center;justify-content:space-between;
  gap:6px;font-size:11px;color:var(--muted);
}
.mono{font-variant-numeric:tabular-nums}

/* Table view */
.table-wrap{
  margin-top:4px;
  border-radius:10px;
  border:1px solid var(--border);
  background:var(--panel-soft);
  overflow:auto;
  box-shadow:0 0 16px rgba(214,180,76,.12);
}
table{
  width:100%;
  border-collapse:collapse;
  min-width:1100px;
  font-size:var(--fs-table);
}
th,td{
  padding:7px 9px;
  border-bottom:1px solid rgba(214,180,76,.25);
  vertical-align:top;
}
thead th{
  text-align:left;
  font-weight:600;
  color:var(--accent);
  background:#080808;
  position:sticky;top:0;z-index:1;
}
tbody tr:nth-child(even){background:#101010}
tbody tr:hover{background:rgba(214,180,76,.10)}
.nowrap{white-space:nowrap}
.small{font-size:var(--fs-small);color:var(--muted)}
.link-btn{
  border:none;background:transparent;padding:0;margin:0;
  color:var(--accent);text-decoration:underline;cursor:pointer;
  font-size:var(--fs-table);
}

/* Modal */
.modal-bg{
  position:fixed;inset:0;
  background:rgba(0,0,0,.75);
  display:none;
  align-items:center;justify-content:center;
  z-index:20;
}
.modal{
  width:min(720px,95vw);
  background:
    radial-gradient(900px 400px at 110% -10%,rgba(242,214,117,.06),transparent 50%),
    #0b0b0b;
  border-radius:14px;
  border:1px solid var(--border);
  box-shadow:0 14px 36px rgba(0,0,0,.6),
             0 0 26px rgba(214,180,76,.25),
             inset 0 0 0 1px rgba(214,180,76,.08);
}
.modal-head{
  padding:12px 14px;
  border-bottom:1px solid rgba(214,180,76,.35);
  display:flex;align-items:center;justify-content:space-between;
}
.modal-title{font-weight:700;color:var(--accent)}
.modal-body{
  padding:10px 14px;
  max-height:70vh;overflow:auto;
  font-size:var(--fs-table);
}
.modal-footer{
  padding:8px 14px;
  border-top:1px solid rgba(214,180,76,.35);
  display:flex;justify-content:flex-end;gap:8px;
}
.modal-close{
  border-radius:999px;border:1px solid var(--border);
  background:#050505;color:var(--accent);
  padding:4px 9px;font-size:12px;cursor:pointer;
}
.modal-close:hover{background:var(--accent);color:#000}
.att-title{font-weight:600;margin-bottom:4px}
.att-meta{font-size:var(--fs-small);color:var(--muted);margin-bottom:6px}
.att-table{
  width:100%;border-collapse:collapse;font-size:var(--fs-table);margin-top:4px;
}
.att-table th,.att-table td{
  padding:6px 8px;border-bottom:1px solid rgba(214,180,76,.25);
}

/* Utils */
.subtle{font-size:var(--fs-small);color:var(--muted)}
.hidden{display:none !important}
</style>
</head>
<body>

<!-- Brand -->
<div class="brand">
  <img class="brand-logo" src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" alt="JMBN">
  <h1>JMBN Operations Log</h1>
  <div class="brand-sub">Ops · Flight Hours · Crew Utilisation</div>
</div>

<!-- Nav -->
<nav class="nav">
  <a class="nav-btn" href="index.html">Manifest</a>
  <a class="nav-btn" href="hangar.html">Hangar</a>
  <a class="nav-btn" href="components.html">Components</a>
  <a class="nav-btn" href="contracts.html">Contracts</a>
  <a class="nav-btn" href="mission-log.html">Mission Log</a>
  <a class="nav-btn active" href="operations-log.html">Operations Log</a>
</nav>

<div class="grid">
  <!-- Sidebar / ops console -->
  <aside class="panel">
    <div class="panel-inner">
      <div class="console-header">
        <div class="console-title">Ops Console</div>
        <div class="console-pill">CI &nbsp;·&nbsp; Ledger Feed</div>
      </div>

      <label class="field-label" for="search">Search</label>
      <input id="search" type="search" placeholder="Title / type / lead / ship / tag…">

      <label class="field-label" for="filterType">Type</label>
      <select id="filterType">
        <option value="">All Types</option>
        <option>Hauling</option><option>Combat</option><option>Rescue</option>
        <option>Mining</option><option>Exploration</option><option>Support</option>
      </select>

      <label class="field-label" for="filterStatus">Status</label>
      <select id="filterStatus">
        <option value="">All Status</option>
        <option>Planned</option><option>Active</option>
        <option>Completed</option><option>Cancelled</option>
      </select>

      <label class="field-label" for="filterLead">Lead</label>
      <select id="filterLead">
        <option value="">All Leads</option>
      </select>

      <!-- KPIs -->
      <div class="field-label" style="margin-top:12px;">Ops Snapshot</div>
      <div class="kpi-grid">
        <div class="kpi">
          <div class="kpi-title">Total Ops</div>
          <div class="kpi-value" id="kTotalOps">0</div>
          <div class="kpi-sub" id="kTotalOpsSub">after filters</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">Flight Hours</div>
          <div class="kpi-value" id="kTotalHours">0</div>
          <div class="kpi-sub">sum of ops</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">Payout (aUEC)</div>
          <div class="kpi-value" id="kTotalPayout">0</div>
          <div class="kpi-sub">visible ops only</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">Avg Crew</div>
          <div class="kpi-value" id="kAvgCrew">0</div>
          <div class="kpi-sub">per op (crew data)</div>
        </div>
      </div>

      <!-- Quick tags -->
      <div class="field-label" style="margin-top:12px;">Quick Filters</div>
      <div class="tag-cloud">
        <button type="button" class="chip" data-chip="night">Night Ops</button>
        <button type="button" class="chip" data-chip="org">Org Run</button>
        <button type="button" class="chip" data-chip="medical">Medical</button>
        <button type="button" class="chip" data-chip="cargo">Cargo</button>
        <button type="button" class="chip" data-chip="escort">Escort</button>
      </div>

      <!-- Toggle + export -->
      <div class="view-toggle-wrap">
        <div class="toggle-group">
          <button class="toggle-btn active" data-view="timeline">Timeline</button>
          <button class="toggle-btn" data-view="table">Table</button>
        </div>
        <div style="display:flex;gap:4px;">
          <button id="exportJSON" class="icon-btn" type="button">
            <span>⇩</span><span>JSON</span>
          </button>
          <button id="exportCSV" class="icon-btn" type="button">
            <span>⇩</span><span>CSV</span>
          </button>
        </div>
      </div>

      <div class="subtle">
        Click any operation card to open crew details.<br>
        Exports respect current filters.
      </div>
    </div>
  </aside>

  <!-- Main panel -->
  <section class="panel main-panel">
    <div class="panel-inner">
      <div class="main-header">
        <div>
          <div class="main-title">Operations Timeline</div>
          <div class="main-sub">Group by day · see crew & payout at a glance</div>
        </div>
        <div class="subtle" id="opsCountLabel"></div>
      </div>

      <!-- Timeline view -->
      <div id="timelineView" class="timeline"></div>

      <!-- Table view -->
      <div id="tableView" class="hidden">
        <div class="subtle" style="margin-bottom:4px;">Classic table view for export or copy-paste.</div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Operation</th>
                <th>Type</th>
                <th>Status</th>
                <th>Lead</th>
                <th class="nowrap">Start Time</th>
                <th class="nowrap">Hours</th>
                <th>Ships</th>
                <th class="nowrap">Crew</th>
                <th class="nowrap">Payout (aUEC)</th>
                <th>Tags</th>
                <th>Attendees</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Attendance Modal -->
<div class="modal-bg" id="attModalBg">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title" id="attTitle">Operation</div>
      <button type="button" class="modal-close" id="attClose">✕</button>
    </div>
    <div class="modal-body">
      <div class="att-title" id="attSummary"></div>
      <div class="att-meta" id="attMeta"></div>
      <table class="att-table" id="attTable"></table>
    </div>
    <div class="modal-footer">
      <!-- later: I'm going / Withdraw for authenticated users -->
      <button type="button" class="modal-close" id="attClose2">Close</button>
    </div>
  </div>
</div>

<script>
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const esc = (s='') => {
  const d=document.createElement('div'); d.textContent=s ?? ''; return d.innerHTML;
};
const fmtNum = n => (n||n===0) ? Number(n).toLocaleString('en-US') : '';
const fmtDateTime = iso => iso ? new Date(iso).toLocaleString() : '';
const fmtDay = iso => {
  if(!iso) return 'Unknown';
  const d = new Date(iso);
  return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
};
const fmtTime = iso => {
  if(!iso) return '';
  const d = new Date(iso);
  return d.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
};
const parseNum = v => {
  if(v==null) return 0;
  const n = Number(String(v).replace(/[^\d.-]/g,''));
  return Number.isFinite(n) ? n : 0;
};

/* Demo data (swap for Supabase later) */
let operations = [
  {
    id:'OP-001',
    title:'RW S2 — Cargo Loop Shakedown',
    type:'Hauling',
    status:'Completed',
    lead:'Vex',
    start_time:'2025-11-20T13:00:00Z',
    hours:2.5,
    ships:['Carrack','Cutlass Black'],
    crew_count:6,
    payout_auec:480000,
    tags:'cargo, org, night, escort',
    notes:'Smooth run, minor pirate contact avoided.',
    attendees:[
      { name:'Vex', role:'Lead', ship:'Carrack', ci:12, status:'Confirmed' },
      { name:'Kara', role:'XO', ship:'Carrack', ci:10, status:'Confirmed' },
      { name:'Malik', role:'Escort', ship:'Cutlass Black', ci:8, status:'Confirmed' },
      { name:'Jes', role:'Logistics', ship:'Carrack', ci:7, status:'Confirmed' },
      { name:'Johnny', role:'Gunner', ship:'Cutlass Black', ci:7, status:'Confirmed' },
      { name:'Rook', role:'Support', ship:'Carrack', ci:6, status:'Confirmed' }
    ]
  },
  {
    id:'OP-002',
    title:'Medical Evac — Jumptown Spillover',
    type:'Rescue',
    status:'Completed',
    lead:'Kara',
    start_time:'2025-11-22T16:30:00Z',
    hours:1.8,
    ships:['Cutlass Red'],
    crew_count:3,
    payout_auec:150000,
    tags:'medical, org',
    notes:'3 evac cycles, no hostiles.',
    attendees:[
      { name:'Kara', role:'Lead', ship:'Cutlass Red', ci:10, status:'Confirmed' },
      { name:'Malik', role:'Pilot', ship:'Cutlass Red', ci:8, status:'Confirmed' },
      { name:'Vex', role:'Overwatch', ship:'Pisces', ci:6, status:'Confirmed' }
    ]
  },
  {
    id:'OP-003',
    title:'VTAC Patrol — Pyro Staging Scan',
    type:'Combat',
    status:'Planned',
    lead:'Malik',
    start_time:'2025-11-25T20:00:00Z',
    hours:3.2,
    ships:['Perseus','Gladius','Gladius'],
    crew_count:5,
    payout_auec:0,
    tags:'escort, night',
    notes:'Planned VTAC run, pending roster.',
    attendees:[]
  }
];

/* Elements */
const tbody = $('#tbody');
const qInput = $('#search');
const fType = $('#filterType');
const fStatus = $('#filterStatus');
const fLead = $('#filterLead');
const timelineView = $('#timelineView');
const tableView = $('#tableView');
const opsCountLabel = $('#opsCountLabel');

/* Build lead filter */
function buildLeadFilter(){
  const leads = [...new Set(operations.map(o=>o.lead).filter(Boolean))].sort();
  fLead.innerHTML = '<option value="">All Leads</option>' +
    leads.map(l=>`<option>${esc(l)}</option>`).join('');
}

/* Filtering */
function getFiltered(){
  const q = (qInput.value||'').toLowerCase();
  const t = fType.value || '';
  const s = fStatus.value || '';
  const lead = fLead.value || '';
  let arr = operations.slice();
  if(t) arr = arr.filter(o => (o.type||'')===t);
  if(s) arr = arr.filter(o => (o.status||'')===s);
  if(lead) arr = arr.filter(o => (o.lead||'')===lead);
  if(q){
    arr = arr.filter(o =>
      `${o.title} ${o.type} ${o.status} ${o.lead} ${(o.ships||[]).join(' ')} ${o.tags||''}`.toLowerCase().includes(q)
    );
  }
  return arr.sort((a,b)=> new Date(b.start_time||0) - new Date(a.start_time||0));
}

/* KPIs */
function updateKPIs(arr){
  const count = arr.length;
  let totalHours = 0, totalPayout = 0, crewSum = 0, crewOps = 0;
  for(const o of arr){
    totalHours += Number(o.hours||0);
    totalPayout += parseNum(o.payout_auec);
    if(o.crew_count){
      crewSum += o.crew_count;
      crewOps++;
    }
  }
  const avgCrew = crewOps ? crewSum / crewOps : 0;
  $('#kTotalOps').textContent = fmtNum(count);
  $('#kTotalOpsSub').textContent = count ? 'after filters' : 'no ops in view';
  $('#kTotalHours').textContent = totalHours ? totalHours.toFixed(1) : '0';
  $('#kTotalPayout').textContent = fmtNum(totalPayout);
  $('#kAvgCrew').textContent = avgCrew ? avgCrew.toFixed(1) : '0';
  opsCountLabel.textContent = count ? `${count} operation${count>1?'s':''} in view` : 'No operations in view';
}

/* Timeline render */
function groupByDay(arr){
  const map = new Map();
  for(const o of arr){
    const key = fmtDay(o.start_time);
    if(!map.has(key)) map.set(key,[]);
    map.get(key).push(o);
  }
  return map;
}

function statusIsGood(status){
  return status === 'Completed';
}
function statusIsBad(status){
  return status === 'Cancelled';
}

function renderTimeline(arr){
  if(!arr.length){
    timelineView.innerHTML = `<div class="subtle">No operations found for current filters.</div>`;
    return;
  }
  const dayMap = groupByDay(arr);
  let html = '';
  for(const [day,ops] of dayMap){
    const d = ops[0]?.start_time ? new Date(ops[0].start_time) : null;
    const weekday = d ? d.toLocaleDateString(undefined,{weekday:'short'}) : '';
    html += `<div class="day-group">
      <div class="day-header">
        <span>◎</span>
        <span>${esc(weekday || 'Day')}</span>
        <span>${esc(day)}</span>
      </div>`;
    for(const o of ops){
      html += opCardHtml(o);
    }
    html += `</div>`;
  }
  timelineView.innerHTML = html;

  // wire cards
  $$('#timelineView .op-card').forEach(card=>{
    card.addEventListener('click',()=>{
      openAttendees(card.dataset.id);
    });
  });
}

function opCardHtml(o){
  const ships = (o.ships||[]).join(', ');
  const crew = o.crew_count ?? (o.attendees?.length ?? '');
  const tags = (o.tags||'').split(',').map(t=>t.trim()).filter(Boolean);
  const good = statusIsGood(o.status);
  const bad = statusIsBad(o.status);
  return `
    <article class="op-card" data-id="${esc(o.id)}">
      <div class="op-main">
        <div>
          <div class="op-title">${esc(o.title||'(untitled operation)')}</div>
          <div class="op-meta">
            <span class="badge badge-type">${esc(o.type||'Unknown')}</span>
            <span class="badge badge-status${bad?' bad-ops':''}${good&&!bad?' good-ops':''}">
              ${esc(o.status||'—')}
            </span>
            &nbsp;•&nbsp;
            Lead: <strong>${esc(o.lead||'-')}</strong>
          </div>
        </div>
        <div class="op-right">
          <div class="mono"><strong>${fmtTime(o.start_time)}</strong></div>
          <div class="mono">${o.hours ?? 0} hrs</div>
          <div class="mono">Crew: <strong>${crew ?? 0}</strong></div>
        </div>
      </div>
      <div class="op-footer">
        <div>
          <span class="mono">Ships: ${esc(ships||'-')}</span>
        </div>
        <div class="mono">Payout: <strong>${fmtNum(o.payout_auec)||'-'}</strong> aUEC</div>
      </div>
      ${tags.length ? `
      <div class="op-tags">
        ${tags.map(t=>`<span class="op-tag-pill">${esc(t)}</span>`).join('')}
      </div>`:''}
      ${o.notes ? `<div class="subtle" style="margin-top:4px;">${esc(o.notes)}</div>`:''}
    </article>
  `;
}

/* Table render */
function renderTable(arr){
  if(!arr.length){
    tbody.innerHTML = `<tr><td colspan="12" class="small">No operations found.</td></tr>`;
    return;
  }
  tbody.innerHTML = arr.map(o=>rowHtml(o)).join('');
  $$('#tbody button[data-id]').forEach(btn=>{
    btn.onclick = () => openAttendees(btn.dataset.id);
  });
}
function rowHtml(o){
  const ships = (o.ships||[]).join(', ');
  const crew = o.crew_count ?? (o.attendees?.length ?? '');
  return `
    <tr>
      <td>${esc(o.title||'(untitled)')}</td>
      <td>${o.type ? `<span class="badge">${esc(o.type)}</span>` : ''}</td>
      <td>${o.status ? `<span class="badge">${esc(o.status)}</span>` : ''}</td>
      <td>${esc(o.lead||'')}</td>
      <td class="nowrap mono">${fmtDateTime(o.start_time)}</td>
      <td class="mono">${o.hours ?? ''}</td>
      <td>${esc(ships)}</td>
      <td class="mono">${crew ?? ''}</td>
      <td class="mono">${fmtNum(o.payout_auec)}</td>
      <td>${esc(o.tags||'')}</td>
      <td>
        ${Array.isArray(o.attendees)&&o.attendees.length
          ? `<button class="link-btn" data-id="${esc(o.id)}">
               View (${o.attendees.length})
             </button>`
          : '<span class="small">—</span>'}
      </td>
      <td>${esc(o.notes||'')}</td>
    </tr>
  `;
}

/* Combined render */
function render(){
  const arr = getFiltered();
  updateKPIs(arr);
  renderTimeline(arr);
  renderTable(arr);
}

/* Attendance modal */
const attBg = $('#attModalBg');
const attTitle = $('#attTitle');
const attSummary = $('#attSummary');
const attMeta = $('#attMeta');
const attTable = $('#attTable');

function closeModal(){ attBg.style.display='none'; }
$('#attClose').onclick = closeModal;
$('#attClose2').onclick = closeModal;
attBg.addEventListener('click', e=>{ if(e.target===attBg) closeModal(); });

function openAttendees(id){
  const op = operations.find(o => o.id===id);
  if(!op) return;
  attTitle.textContent = op.title || 'Operation';
  attSummary.textContent = `${op.type||''} • ${op.status||''} • Lead: ${op.lead||'-'}`;
  attMeta.textContent = `${fmtDateTime(op.start_time)} · ${op.hours||0} hrs · Payout: ${fmtNum(op.payout_auec)||'-'} aUEC`;
  if(!Array.isArray(op.attendees) || !op.attendees.length){
    attTable.innerHTML = `<tr><td class="small">No crew list recorded for this operation yet.</td></tr>`;
  } else {
    const rows = op.attendees.map(a=>`
      <tr>
        <td>${esc(a.name||'')}</td>
        <td>${esc(a.role||'')}</td>
        <td>${esc(a.ship||'')}</td>
        <td class="mono">${a.ci ?? ''}</td>
        <td>${esc(a.status||'')}</td>
      </tr>
    `).join('');
    attTable.innerHTML = `
      <thead><tr>
        <th>Name</th><th>Role</th><th>Ship</th><th class="nowrap">CI</th><th>Status</th>
      </tr></thead>
      <tbody>${rows}</tbody>`;
  }
  attBg.style.display='flex';
}

/* Export */
$('#exportJSON').onclick = () => {
  const arr = getFiltered();
  const blob = new Blob([JSON.stringify(arr,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'jmbn-operations-log.json';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
};

$('#exportCSV').onclick = () => {
  const arr = getFiltered();
  if(!arr.length){ alert('Nothing to export.'); return; }
  const headers = [
    'id','title','type','status','lead','start_time','hours',
    'ships','crew_count','payout_auec','tags','notes'
  ];
  const lines = [];
  lines.push(headers.join(','));
  for(const o of arr){
    const ships = (o.ships||[]).join(' / ');
    const row = [
      o.id, o.title, o.type, o.status, o.lead,
      o.start_time, o.hours,
      ships, o.crew_count, o.payout_auec,
      o.tags, o.notes
    ].map(v=>{
      const s = v==null ? '' : String(v);
      return `"${s.replace(/"/g,'""')}"`;
    }).join(',');
    lines.push(row);
  }
  const blob = new Blob([lines.join('\n')],{type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'jmbn-operations-log.csv';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
};

/* View toggle */
let currentView = 'timeline';
$$('.toggle-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const target = btn.dataset.view;
    if(target === currentView) return;
    currentView = target;
    $$('.toggle-btn').forEach(b=>b.classList.toggle('active', b===btn));
    if(currentView==='timeline'){
      timelineView.classList.remove('hidden');
      tableView.classList.add('hidden');
    }else{
      tableView.classList.remove('hidden');
      timelineView.classList.add('hidden');
    }
  });
});

/* Quick tag chips */
$$('.chip').forEach(chip=>{
  chip.addEventListener('click',()=>{
    const tag = chip.dataset.chip || '';
    if(!tag) return;
    const base = qInput.value || '';
    const parts = base.toLowerCase().split(' ').filter(Boolean);
    if(!parts.includes(tag.toLowerCase())){
      qInput.value = (base + ' ' + tag).trim();
    }
    render();
  });
});

/* Nav highlight & init */
(function(){
  const here = location.pathname.split('/').pop() || 'operations-log.html';
  document.querySelectorAll('.nav-btn').forEach(a=>{
    if(a.getAttribute('href')===here){ a.classList.add('active'); }
  });
})();

buildLeadFilter();
render();
[qInput,fType,fStatus,fLead].forEach(el=>{
  el.addEventListener('input', render);
  el.addEventListener('change', render);
});
</script>
</body>
</html>