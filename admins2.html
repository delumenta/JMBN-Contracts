<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>JMBN – Admin Console</title>

<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png">

<style>
:root{
  --bg:#000; --panel:#0b0b0b; --sub:#0f0f0f; --row:#0a0a0a;
  --border:#d6b44c; --accent:#f2d675; --text:#f7f1d0; --muted:#c9b06a; --bad:#ff6b6b; --ok:#5cd47c;
  --fs:14px;
}
*{box-sizing:border-box}
html,body{margin:0;background:#000;color:var(--text);font-family:'Play',system-ui,sans-serif;font-size:var(--fs)}

/* Fallback header */
.brand{display:flex;align-items:center;gap:10px;margin:12px 16px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.brand img{width:44px;height:44px;object-fit:contain}
.brand h1{margin:0;color:var(--accent);font-size:22px}

.wrap{max-width:1200px;margin:0 auto;padding:0 16px 40px}
.grid{display:grid;grid-template-columns:340px 1fr;gap:16px}
@media(max-width:980px){.grid{grid-template-columns:1fr}}

.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:0 0 18px rgba(214,180,76,.18)}
.panel .hd{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--border)}
.panel .hd h3{margin:0;color:var(--accent);font-size:16px}
.panel .body{padding:12px}

input[type="search"],select{
  width:100%;background:#0a0a0a;border:1px solid var(--border);border-radius:8px;padding:9px;color:var(--text);font-family:'Play'
}
button{
  padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);cursor:pointer;font-family:'Play'
}
button:hover{background:var(--accent);color:#000}
.pill{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:4px 10px;font-size:12px;background:#121212;color:var(--accent)}
.btn-danger{border-color:var(--bad);color:var(--bad)}
.btn-ok{border-color:var(--ok);color:var(--ok)}

/* Members list */
.mlist{display:flex;flex-direction:column;gap:8px;max-height:70vh;overflow:auto}
.mrow{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:8px;border:1px solid transparent;border-radius:10px;background:#0a0a0a;cursor:pointer}
.mrow:hover{background:#111;border-color:rgba(214,180,76,.35)}
.mrow.active{background:rgba(214,180,76,.12);border-color:var(--border)}

/* Frameless rank/logo avatar */
.mavatar{
  width:38px;height:38px;
  display:grid;place-items:center;overflow:hidden;
  border:none;
  border-radius:0;
  background:transparent;
}
.mavatar img{
  width:100%;height:100%;
  object-fit:contain;
  border:none !important;
  background:transparent !important;
  box-shadow:none !important;
  filter:none !important;
}

/* KPIs + bars */
.kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.kpi{background:#0c0c0c;border:1px solid var(--border);border-radius:12px;padding:10px;text-align:center}
.kpi h4{margin:0 0 6px;color:var(--muted);font-size:11px;text-transform:uppercase}
.kpi .val{font-size:18px;font-weight:700;color:var(--accent)}
.pb{display:grid;grid-template-columns:120px 1fr auto;gap:10px;align-items:center;margin:6px 0}
.pb .label{color:var(--muted);font-size:12px}
.bar{height:12px;background:#0a0a0a;border:1px solid var(--border);border-radius:999px;overflow:hidden}
.fill{height:100%;background:linear-gradient(180deg,var(--accent),#d6b44c)}
.pb .val{font-variant-numeric:tabular-nums;color:var(--muted);font-size:12px}

/* Certifications grid — smaller images */
.certGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.cert{background:#0a0a0a;border:1px solid var(--border);border-radius:12px;padding:10px}
.cert .thumb{height:120px;border:1px solid var(--border);border-radius:10px;background:#101010;display:grid;place-items:center;margin-bottom:8px;padding:8px}
.cert .thumb img{width:auto;max-width:110px;max-height:100%;object-fit:contain}
.cert .title{font-weight:700}
.cert.dim{opacity:.6;filter:grayscale(.5)}
.small{font-size:12px;color:var(--muted)}

/* Timeline */
.timeline{position:relative;margin-top:10px;padding-left:24px}
.timeline::before{content:"";position:absolute;left:10px;top:0;bottom:0;width:2px;background:linear-gradient(var(--border),transparent)}
.titem{position:relative;padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.06);display:grid;grid-template-columns:1fr auto;gap:10px}
.tdot{position:absolute;left:6px;top:16px;width:10px;height:10px;border-radius:50%;background:#222;border:2px solid var(--border)}
.titem.done .tdot{background:var(--border)}
.tlabel{font-weight:700}
</style>
</head>
<body>

<!-- Header mount -->
<div id="header-container">
  <div class="brand"><img src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" alt=""><h1>JMBN Admin Console</h1></div>
</div>
<script>
(async()=>{try{
  const r=await fetch('header.html',{cache:'no-cache'});
  if(r.ok){document.getElementById('header-container').outerHTML=await r.text();}
}catch{}})();
</script>

<div class="wrap">
  <div class="grid">

    <!-- LEFT -->
    <div class="panel">
      <div class="hd"><h3>Members</h3></div>
      <div class="body">
        <input id="mSearch" type="search" placeholder="Search handle / name…">
        <div id="mList" class="mlist" style="margin-top:8px">Loading…</div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="panel">
      <div class="hd">
        <h3>Dashboard</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="rankTrack" title="Rank Track">
            <option value="">— Track —</option>
            <option value="Officer">Officer</option>
            <option value="Enlisted">Enlisted</option>
            <option value="Warrant">Warrant</option>
          </select>
          <button id="btnForce" class="pill" title="Force set user's rank track">Force Set Track</button>

          <select id="rankCode" title="Rank Code">
            <option value="">— Select Rank —</option>
          </select>
          <button id="btnSetRank" class="pill" title="Force set a specific rank code">Set Rank</button>

          <button id="btnPromote" class="pill" disabled>Run Promotion Check</button>
        </div>
      </div>

      <div class="body" id="inspector">
        <div class="small">Select a member to view and edit their progression & certifications.</div>
      </div>
    </div>

  </div>
</div>

<!-- libs -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
const $ = s => document.querySelector(s);
const esc = s => { const d=document.createElement('div'); d.textContent=s??''; return d.innerHTML; };
const setFill=(el,p)=>{const x=Math.max(0,Math.min(1,Number(p)||0));el.style.width=(x*100)+'%';};

let sb, me, isElev=false, MEMBERS=[], SELECTED=null, RANKS=[];

/* Boot */
document.addEventListener('DOMContentLoaded', async ()=>{
  const session = await requireAuth(); if(!session) return;
  sb = getSupabase(); me = session.user.id;

  try{ const { data } = await sb.rpc('is_elevated',{ u: me }); isElev = data===true; }catch{}
  if(!isElev){ $('#inspector').innerHTML='<div class="small" style="color:#ff6b6b">Access denied — not elevated.</div>'; return; }

  await loadMembers();
  await loadRankOptions();

  $('#mSearch').oninput = renderMembers;
  $('#rankTrack').onchange = e => loadRankOptions(e.target.value);

  $('#btnForce').onclick = async ()=>{
    if(!SELECTED) return alert('Select a member first.');
    const track=$('#rankTrack').value; if(!track) return alert('Choose a track.');
    if(!confirm(`Force set ${SELECTED.handle||SELECTED.display_name||SELECTED.user_id.slice(0,8)} to ${track}?`)) return;
    const { error } = await sb.rpc('set_rank_track',{ p_user: SELECTED.user_id, p_track: track });
    if(error) return alert('Force set failed: '+error.message);
    alert('Track updated ✓'); await openMember(SELECTED.user_id); await loadMembers();
  };

  $('#btnSetRank').onclick = async ()=>{
    if(!SELECTED) return alert('Select a member first.');
    const code=$('#rankCode').value; if(!code) return alert('Choose a rank.');
    if(!confirm(`Force set ${SELECTED.handle||SELECTED.display_name||SELECTED.user_id.slice(0,8)} to ${code}?`)) return;
    const { error } = await sb.rpc('set_rank_code',{ p_user: SELECTED.user_id, p_code: code });
    if(error) return alert('Set rank failed: '+error.message);
    alert('Rank updated ✓'); await openMember(SELECTED.user_id); await loadMembers();
  };

  $('#btnPromote').onclick = async ()=>{
    if(!SELECTED) return;
    const { data, error } = await sb.rpc('request_promotion',{ p_user: SELECTED.user_id });
    if(error) return alert('Promotion failed: '+error.message);
    alert(data?.message || (data?.ok?'Promotion OK':'Not eligible yet'));
    await openMember(SELECTED.user_id);
  };
});

/* The rest remains identical — ranks, member list, progress, certs, timeline */
</script>
</body>
</html>
