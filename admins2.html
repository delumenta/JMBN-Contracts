<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JMBN – Progression</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  --bg:#000;
  --line:#d6b44c;        /* border gold */
  --accent:#f2d675;      /* highlight gold */
  --text:#f7f1d0;        /* main text */
  --muted:#c9b06a;       /* secondary text */
  --ink:#0c0c0c;         /* deep panel black */
  --fs:14px;
}
*{box-sizing:border-box}
html,body{margin:0}
body{
  font-family:'Play',system-ui,sans-serif;
  font-size:var(--fs); color:var(--text);
  background:
    radial-gradient(1200px 900px at 10% -15%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  padding:14px;
}

/* ===== Background HUD grid (subtle) ===== */
.hud-grid{
  position:fixed; inset:0; z-index:-1; pointer-events:none; opacity:.4;
  background-image:
     linear-gradient(rgba(214,180,76,.08) 1px, transparent 1px),
     linear-gradient(90deg, rgba(214,180,76,.08) 1px, transparent 1px);
  background-size:80px 80px;
  animation:drift 90s linear infinite;
}
@keyframes drift{from{background-position:0 0}to{background-position:-160px -160px}}
body::after{
  content:""; position:fixed; inset:0; pointer-events:none; z-index:-1;
  background: radial-gradient(900px 600px at 50% 45%, rgba(0,0,0,.0) 30%, rgba(0,0,0,.55) 75%, rgba(0,0,0,.85) 100%);
}

/* ===== Fallback header if header.html fails ===== */
.brand{
  display:flex; align-items:center; gap:10px;
  padding-bottom:10px; margin:0 0 12px;
  border-bottom:1px solid var(--line);
}
.brand h1{margin:0; color:var(--accent); font-weight:700; font-size:clamp(18px,2.2vw,22px)}

/* Black-frame logo (hide baked golden rim) */
.brand-logo-wrap{position:relative; width:44px; height:44px; border-radius:12px; overflow:hidden; background:#000; display:grid; place-items:center}
.brand-logo{width:100%; height:100%; object-fit:cover}
.brand-logo-wrap::after{content:""; position:absolute; inset:0; border-radius:12px; box-shadow: inset 0 0 0 6px #000; pointer-events:none}

/* ===== Layout ===== */
.shell{max-width:1180px; margin:0 auto}
.grid{
  display:grid; grid-template-columns:360px 1fr; gap:20px;
}
@media(max-width:1020px){ .grid{grid-template-columns:1fr} }

/* Left rail – clean, sticky, no boxes */
.rail{position:sticky; top:14px; height:fit-content}
.block-title{color:var(--accent); font-weight:700; font-size:16px; margin:0 0 10px}

.row{
  display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:12px;
  padding:10px 4px;
  border-bottom:1px solid rgba(214,180,76,.28);
}
.row:last-child{border-bottom:none}
.row:hover{background:rgba(214,180,76,.06)}
.kv{display:flex; flex-direction:column}
.k{color:var(--muted); font-size:12px}
.v{font-weight:700; color:var(--text)}

/* Rank glyph – preserve inner gold, mask outer ring */
.rankImg{
  width:50px; height:50px; border-radius:12px;
  background:#000; object-fit:contain; display:block;
  box-shadow: inset 0 0 0 6px #000; /* masks baked rim */
}

/* Chips / buttons */
.pill{
  display:inline-flex; align-items:center; gap:6px;
  padding:6px 12px; border:1px solid var(--line);
  border-radius:999px; background:linear-gradient(180deg,#111,#060606);
  color:var(--accent); font-weight:700; font-size:12px;
}
.btn{cursor:pointer; transition:filter .18s ease, transform .06s ease}
.btn:hover{filter:brightness(1.08)}
.btn:active{transform:translateY(1px)}

/* Progress lines – long sleek rails */
.group-title{margin:18px 0 8px; color:var(--accent); font-weight:700}
.pb{
  display:grid; grid-template-columns:110px 1fr auto; gap:12px; align-items:center;
  padding:8px 2px; border-bottom:1px solid rgba(214,180,76,.28);
}
.pb:last-child{border-bottom:none}
.pb .label{color:var(--muted); font-size:12px}
.track{height:12px; border-radius:999px; background:#0a0a0a; box-shadow:inset 0 0 0 1px rgba(214,180,76,.25); overflow:hidden}
.fill{height:100%; width:0%; background:linear-gradient(180deg,var(--accent),#d6b44c)}
.pb .val{font-size:12px; color:var(--muted); font-variant-numeric:tabular-nums}

/* Right – section ribbons + timeline */
.section{position:relative; padding-top:6px}
.ribbon{
  position:sticky; top:0; z-index:5;
  display:flex; align-items:center; gap:10px;
  padding:8px 0; background:linear-gradient(180deg, rgba(0,0,0,.9), rgba(0,0,0,.75));
  border-bottom:1px solid var(--line);
  backdrop-filter:saturate(1.2) blur(2px);
}
.ribbon h2{margin:0; font-size:18px; color:var(--accent); font-weight:700}

.sep{height:1px; background:linear-gradient(90deg, transparent, rgba(214,180,76,.45), transparent); margin:14px 0; border-radius:999px}

/* Timeline */
.timeline{position:relative; padding-left:18px; margin-top:6px}
.timeline::before{
  content:""; position:absolute; left:7px; top:0; bottom:0;
  width:2px; background:linear-gradient(180deg, rgba(214,180,76,.35), transparent);
}
.ti{
  position:relative; padding:10px 0 10px 10px;
  border-bottom:1px dashed rgba(214,180,76,.28);
}
.ti:last-child{border-bottom:none}
.ti::before{
  content:""; position:absolute; left:-2px; top:16px;
  width:10px; height:10px; border-radius:50%;
  background:var(--accent); box-shadow:0 0 10px rgba(242,214,117,.65);
}
.ti .when{color:var(--muted); font-size:12px}
.ti .chg{color:var(--text)}
.ti .chg b{color:var(--accent)}

/* Certifications – compact pill rows with thumbnails */
.certList{display:flex; flex-direction:column; gap:6px; margin-top:8px}
.cert{
  display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:12px;
  padding:8px 4px; border-bottom:1px solid rgba(214,180,76,.28);
}
.cert:last-child{border-bottom:none}
.thumb{width:34px; height:34px; display:grid; place-items:center; border-radius:10px; background:#0b0b0b; box-shadow:inset 0 0 0 1px rgba(214,180,76,.25)}
.thumb img{max-width:90%; max-height:90%}
.owned .name{color:var(--accent)}
.dim{opacity:.55; filter:grayscale(.55)}
.note{margin-top:6px; color:var(--muted); font-size:12px}
.small{font-size:12px; color:var(--muted)}
.mono{font-variant-numeric:tabular-nums}
</style>
</head>
<body>
<div class="hud-grid"></div>

<!-- Fallback header; replaced by header.html if available -->
<div id="header-container" class="brand shell">
  <div class="brand-logo-wrap">
    <img class="brand-logo" src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" alt="JMBN">
  </div>
  <h1>Rank Progression</h1>
</div>
<script>
(async () => {
  try {
    const res = await fetch('header.html', { cache: 'no-cache' });
    if (res.ok) {
      const html = await res.text();
      document.getElementById('header-container').outerHTML = html;
      requestAnimationFrame(() => {
        const here = (location.pathname.split('/').pop() || 'rank-progression.html').toLowerCase();
        document.querySelectorAll('.nav-btn').forEach(a=>{
          const href=(a.getAttribute('href')||'').toLowerCase();
          if(href===here || (here==='' && href==='index.html')) a.classList.add('active');
        });
      });
    }
  } catch {}
})();
</script>

<div class="shell">
  <div class="grid">
    <!-- LEFT RAIL -->
    <aside class="rail">
      <div class="block-title">Overview</div>

      <div class="row">
        <img id="curImg" class="rankImg" alt="Current Rank">
        <div class="kv">
          <div class="k">Current Rank</div>
          <div class="v" id="curRank">—</div>
        </div>
        <span class="pill" id="curPg">PG: —</span>
      </div>

      <div class="row">
        <img id="nextImg" class="rankImg" alt="Next Rank">
        <div class="kv">
          <div class="k">Next Rank</div>
          <div class="v" id="nextName">—</div>
        </div>
        <span class="pill" id="nextPg">PG: —</span>
      </div>

      <div class="row" style="justify-content:flex-end">
        <button class="pill btn" id="btnPromote" disabled title="Becomes available when all targets are met">
          Request Promotion
        </button>
      </div>

      <div class="group-title">Requirements</div>

      <div class="pb">
        <div class="label">Missions</div>
        <div class="track"><div id="pbMissions" class="fill"></div></div>
        <div class="val mono" id="valMissions">0 / 0</div>
      </div>

      <div class="pb">
        <div class="label">Hours</div>
        <div class="track"><div id="pbHours" class="fill"></div></div>
        <div class="val mono" id="valHours">0 / 0</div>
      </div>

      <div class="pb">
        <div class="label">Certifications</div>
        <div class="track"><div id="pbCerts" class="fill"></div></div>
        <div class="val mono" id="valCerts">0 / 0</div>
      </div>

      <div class="note" id="note">Promotion is available when all targets are met.</div>
    </aside>

    <!-- RIGHT CONTENT -->
    <main>
      <section class="section">
        <div class="ribbon"><h2>History</h2></div>
        <div class="timeline" id="history">
          <div class="small">Loading…</div>
        </div>
      </section>

      <div class="sep"></div>

      <section class="section">
        <div class="ribbon"><h2>Certifications</h2></div>
        <div class="certList" id="certList">—</div>
        <div class="note">Dim rows are not yet earned.</div>
      </section>
    </main>
  </div>
</div>

<!-- Supabase + App -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
const $ = s => document.querySelector(s);
let session=null, sb=null, me=null;

function setFill(sel, pct){
  const el = $(sel);
  const x  = Math.max(0, Math.min(1, Number(pct)||0));
  if(el) el.style.width = (x*100) + '%';
}
async function fetchRankImage(code){
  if(!code) return '';
  try{
    return sb.storage.from('Ranks').getPublicUrl(`${code}.png`).data.publicUrl || '';
  }catch{ return ''; }
}

/* Load progression + bars */
async function loadProgress(){
  const { data: prog } = await sb
    .from('v_user_rank_progress')
    .select('*')
    .eq('user_id', me)
    .maybeSingle();

  $('#curRank').textContent  = prog?.current_name || '(unranked)';
  $('#curPg').textContent    = `PG: ${prog?.current_paygrade || '—'}`;
  $('#nextName').textContent = prog?.next_name || '—';
  $('#nextPg').textContent   = `PG: ${prog?.next_paygrade || '—'}`;

  const curImg = await fetchRankImage(prog?.current_code);
  const nxtImg = await fetchRankImage(prog?.next_code);
  if (curImg){ $('#curImg').src = curImg; $('#curImg').style.visibility='visible'; } else { $('#curImg').style.visibility='hidden'; }
  if (nxtImg){ $('#nextImg').src = nxtImg; $('#nextImg').style.visibility='visible'; } else { $('#nextImg').style.visibility='hidden'; }

  const { data: up } = await sb
    .from('v_user_progress')
    .select('*')
    .eq('user_id', me)
    .maybeSingle();

  const m = Number(up?.missions_attended || 0);
  const h = Number(up?.hours_total || 0);
  const c = Number(up?.certifications_total || 0);

  const mt = Number(prog?.missions_target || 0);
  const ht = Number(prog?.hours_target || 0);
  const ct = Number(prog?.certification_target || 0);

  $('#valMissions').textContent = `${m} / ${mt}`;
  $('#valHours').textContent    = `${h} / ${ht}`;
  $('#valCerts').textContent    = `${c} / ${ct}`;

  setFill('#pbMissions', mt ? Math.min(1, m/mt) : 1);
  setFill('#pbHours',    ht ? Math.min(1, h/ht) : 1);
  setFill('#pbCerts',    ct ? Math.min(1, c/ct) : 1);

  const allMet = (!!prog?.next_code) && (!mt || m>=mt) && (!ht || h>=ht) && (!ct || c>=ct);
  $('#btnPromote').disabled = !allMet;
  $('#note').textContent = !prog?.next_code
    ? 'You are at the highest rank or next rank is not configured.'
    : allMet ? 'All requirements met. You can request promotion.'
             : 'Promotion is available when all targets are met.';
}

/* History timeline */
async function loadHistory(){
  const { data, error } = await sb
    .from('rank_changes')
    .select('from_rank_code,to_rank_code,changed_by,created_at,reason')
    .eq('user_id', me)
    .order('created_at', { ascending:false })
    .limit(16);

  const host = $('#history');
  if(error){ host.innerHTML = '<div class="small">Failed to load history.</div>'; return; }
  if(!data?.length){ host.innerHTML = '<div class="small">No changes yet.</div>'; return; }

  host.innerHTML = data.map(r=>{
    const when = new Date(r.created_at).toLocaleString();
    const who  = r.changed_by?.slice(0,8) || 'system';
    const from = r.from_rank_code || '—';
    const to   = r.to_rank_code || '—';
    const why  = r.reason ? ` — <span class="small">${r.reason}</span>` : '';
    return `<div class="ti">
              <div class="when">${when}</div>
              <div class="chg">${from} <span style="color:var(--accent)">→</span> <b>${to}</b> • by ${who}${why}</div>
            </div>`;
  }).join('');
}

/* Certifications */
async function loadCerts(){
  const { data, error } = await sb
    .from('v_user_certifications')
    .select('certification_code,name,image_url,owned,sort_order,user_id')
    .or(`user_id.eq.${me},user_id.is.null`)
    .order('sort_order', { ascending:true });

  const host = $('#certList');
  if (error){ host.textContent = 'Failed to load certifications.'; return; }
  if (!data?.length){ host.textContent = '—'; return; }

  host.innerHTML = data.map(row=>{
    const owned = !!row.owned;
    const img   = row.image_url || '';
    const code  = row.certification_code || '';
    const name  = row.name || code || 'Certification';
    return `
      <div class="cert ${owned?'owned':'dim'}" title="${owned?'Obtained':'Not earned'}">
        <div class="thumb">${img?`<img src="${img}" alt="${name}">`:''}</div>
        <div class="name">${name}<div class="small">${code}</div></div>
        <div>${owned?'<span class="pill">Owned</span>':''}</div>
      </div>`;
  }).join('');
}

/* Promotion */
async function promote(){
  const { data, error } = await sb.rpc('request_promotion', { p_user: me });
  if(error){ alert('Promotion failed: ' + error.message); return; }
  if(!data?.ok){ alert(data?.message || 'Not eligible.'); return; }
  alert('Promoted to ' + (data.to || 'next rank') + '!');
  await loadProgress(); await loadHistory();
}

/* Boot */
document.addEventListener('DOMContentLoaded', async ()=>{
  session = await requireAuth();
  if(!session) return;
  sb = getSupabase();
  me = session.user.id;

  $('#btnPromote').onclick = promote;

  await loadProgress();
  await loadHistory();
  await loadCerts();
});
</script>
</body>
</html>
