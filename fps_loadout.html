<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN FPS Loadouts</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png"
      href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png"
      sizes="32x32">
<style>
:root{
  --bg:#000;--panel:#0b0b0b;--border:#d6b44c;--card:#141414;
  --accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;
  --fs-base:14px;--fs-small:11px;--fs-table:13px;--fs-h1:clamp(18px,2.2vw,22px);--fs-h2:clamp(14px,1.6vw,16px)
}
*{box-sizing:border-box}
body{
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text);font-family:'Play',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  margin:0;padding:14px;letter-spacing:.25px;font-size:var(--fs-base)
}

/* Brand */
.brand{display:flex;align-items:center;gap:10px;margin:0 0 8px;border-bottom:1px solid var(--border);padding-bottom:6px}
.brand-logo{width:44px;height:44px;object-fit:contain;filter:drop-shadow(0 0 4px rgba(242,214,117,.25))}
.brand h1{font-weight:700;font-size:var(--fs-h1);color:var(--accent);margin:0}

/* Shiny nav */
.nav{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
.nav-btn{
  --ring:#d6b44c;
  position:relative;display:inline-flex;align-items:center;justify-content:center;
  padding:7px 14px;border:1px solid var(--ring);border-radius:999px;
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);text-decoration:none;font-weight:700;letter-spacing:.2px;
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.12);
  transition:transform .15s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
}
.nav-btn:hover{transform:translateY(-1px);box-shadow:0 0 12px rgba(214,180,76,.25), inset 0 0 0 1px rgba(214,180,76,.18);background:linear-gradient(180deg,#1a1a1a,#0a0a0a)}
.nav-btn.active{color:#000;background:linear-gradient(180deg,#f2d675,#e7c760);border-color:var(--ring);box-shadow:0 0 20px rgba(214,180,76,.45)}

/* Panels + controls */
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:8px;box-shadow:0 0 18px rgba(214,180,76,.22)}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
button{padding:7px 11px;border-radius:10px;background:linear-gradient(180deg,#0c0c0c,#060606);color:var(--accent);border:1px solid var(--border);cursor:pointer;font-family:'Play';transition:.2s}
button:hover{background:var(--accent);color:#000}
.btn-primary{background:var(--accent);color:#000}
input,select,textarea{background:#0a0a0a;border:1px solid var(--border);border-radius:8px;padding:9px;color:var(--text);font-size:var(--fs-table);font-family:'Play'}
textarea{resize:vertical}

/* Table */
.tableWrap{border:1px solid var(--border);border-radius:12px;overflow:auto;max-height:70vh;margin-top:10px}
table{width:100%;border-collapse:collapse;font-size:var(--fs-table)}
th,td{border-bottom:1px solid rgba(214,180,76,.3);padding:8px;text-align:left}
th{color:var(--accent);background:#080808;font-weight:500;font-size:12px}
tr:nth-child(even){background:#111}
tr:hover{background:rgba(214,180,76,.08)}
.small{font-size:var(--fs-small);color:var(--muted)}
.badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px;color:var(--muted)}

/* Modal */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:10}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;width:95%;max-width:520px;box-shadow:0 0 25px rgba(214,180,76,.3)}
.modal h2{color:var(--accent);margin:0 0 8px}
.modal .form-grid{display:grid;gap:8px}
.modal .form-grid.two{grid-template-columns:1fr 1fr}
@media(max-width:640px){.modal .form-grid.two{grid-template-columns:1fr}}
.modal-buttons{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
</style>
</head>
<body>
  <!-- Brand -->
  <div class="brand">
    <img class="brand-logo" src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png/v1/fill/w_66,h_66,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/0_New_JMBN_Logo_Gold.png" alt="JMBN">
    <h1>JMBN FPS Loadouts</h1>
  </div>

  <!-- Navigation -->
  <nav class="nav">
    <a class="nav-btn" href="index.html">Manifest</a>
    <a class="nav-btn" href="hangar.html">Hangar</a>
    <a class="nav-btn" href="components.html">Components</a>
    <a class="nav-btn" href="contracts.html">Contracts</a>
    <a class="nav-btn" href="mission-log.html">Mission Log</a>
    <a class="nav-btn active" href="fps-loadout.html">FPS Loadouts</a>
  </nav>

  <div class="panel">
    <div class="controls">
      <input id="search" placeholder="Search loadouts…">
      <select id="branchFilter"><option value="">All Branches</option><option>Navy</option><option>Engineering</option><option>Combat</option><option>Medic</option><option>Cargo</option></select>
      <button id="addBtn" class="btn-primary">Add Loadout</button>
      <button id="seedBtn">Seed Demo</button>
      <button id="saveBtn">Save</button>
      <button id="resetBtn" style="border-color:var(--bad);color:var(--bad)">Clear All</button>
      <button id="exportJSON">Export JSON</button>
      <button id="importJSON" class="btn-primary">Import JSON</button>
      <button id="shareLink">Copy Share Link</button>
      <button id="dlStatic">Download Static HTML</button>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th>Loadout Title</th>
            <th>Rank</th>
            <th>Branch</th>
            <th>Armor</th>
            <th>Tags</th>
            $1<th>Gear</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal for add/edit -->
  <div class="modal-bg" id="modal-bg">
    <div class="modal">
      <h2 id="modalTitle">New Loadout</h2>
      <input type="hidden" id="loId">
      <div class="form-grid">
        <input id="loTitle" placeholder="Loadout Title *">
        <div class="form-grid two">
          <input id="loRank" placeholder="Rank (e.g., Junior Rate)">
          <select id="loBranch">
            <option value="">Branch</option>
            <option>Navy</option><option>Engineering</option><option>Combat</option><option>Medic</option><option>Cargo</option>
          </select>
        </div>
        <input id="loArmor" placeholder="Armor (e.g., Heavy / Medium / Light)">
        <input id="loTags" placeholder="Tags (comma separated)">
        <textarea id="loNotes" rows="3" placeholder="Notes"></textarea>
      </div>
      <div class="modal-buttons">
        <button id="cancelModal">Cancel</button>
        <button id="saveModal" class="btn-primary">Save</button>
      </div>
    </div>
  </div>

  <!-- Gear Modal -->
  <div class="modal-bg" id="gear-bg">
    <div class="modal" style="max-width:680px">
      <h2>Loadout Gear</h2>
      <div class="form-grid two">
        <input id="gType" placeholder="Type (e.g., Armor / Utility)">
        <input id="gItem" placeholder="Item (e.g., Pembroke, Multi-Tool)">
      </div>
      <textarea id="gNotes" rows="2" placeholder="Notes (optional)"></textarea>
      <div class="modal-buttons">
        <button id="gAdd" class="btn-primary">Add Gear</button>
        <button id="gClose">Close</button>
      </div>
      <div class="tableWrap" style="margin-top:10px">
        <table>
          <thead><tr><th>Type</th><th>Item</th><th>Notes</th><th>Actions</th></tr></thead>
          <tbody id="gearRows"></tbody>
        </table>
      </div>
    </div>
  </div>
  <script id="embeddedLoadouts" type="application/json">[]</script>
<script>
(function(){
  // highlight current nav
  const here=location.pathname.split('/').pop()||'fps-loadout.html';
  document.querySelectorAll('.nav-btn').forEach(a=>{ if(a.getAttribute('href')===here){ a.classList.add('active'); }});
})();

const STORE='jmbn-fps-loadouts-v2';
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
const uid=()=> 'LD-'+Math.random().toString(36).slice(2,8);
let loadouts=[];

function esc(s=''){const d=document.createElement('div');d.textContent=s??'';return d.innerHTML;}

/* Load & Save */
function load(){ const raw=localStorage.getItem(STORE); loadouts = raw? JSON.parse(raw):[]; render(); }
function save(){ localStorage.setItem(STORE, JSON.stringify(loadouts)); }
$('#saveBtn').onclick=save;
$('#resetBtn').onclick=()=>{ if(confirm('Clear ALL loadouts?')){ loadouts=[]; save(); render(); }};

/* Modal logic */
const modalBG=$('#modal-bg');
$('#addBtn').onclick=()=>openModal();
$('#cancelModal').onclick=()=>closeModal();
$('#saveModal').onclick=()=>{
  const id=$('#loId').value || uid();
  const title=$('#loTitle').value.trim(); if(!title){ alert('Loadout Title is required'); return; }
  const obj={
    id,
    title,
    rank: $('#loRank').value.trim(),
    branch: $('#loBranch').value,
    armor: $('#loArmor').value.trim(),
    tags: $('#loTags').value.trim(),
    notes: $('#loNotes').value.trim()
  };
  const i=loadouts.findIndex(x=>x.id===id);
  if(i>=0) loadouts[i]=obj; else loadouts.push(obj);
  save(); render(); closeModal(); clearForm();
};
function openModal(data=null){
  $('#modalTitle').textContent = data? 'Edit Loadout' : 'New Loadout';
  if(data){ fillForm(data); }
  modalBG.style.display='flex';
}
function closeModal(){ modalBG.style.display='none'; }
function clearForm(){ ['loId','loTitle','loRank','loArmor','loTags','loNotes'].forEach(id=>{ $('#'+id).value=''; }); $('#loBranch').value=''; }
function fillForm(d){
  $('#loId').value=d.id; $('#loTitle').value=d.title||''; $('#loRank').value=d.rank||''; $('#loBranch').value=d.branch||''; $('#loArmor').value=d.armor||''; $('#loTags').value=d.tags||''; $('#loNotes').value=d.notes||'';
}

/* Render */
function render(){
  const q=($('#search').value||'').toLowerCase();
  const bf=$('#branchFilter').value||'';
  let arr=loadouts.slice();
  if(q) arr=arr.filter(x=>`${x.title} ${x.rank} ${x.branch} ${x.armor} ${x.tags} ${x.notes}`.toLowerCase().includes(q));
  if(bf) arr=arr.filter(x=>x.branch===bf);
  $('#rows').innerHTML = arr.map(r=>row(r)).join('');
  $$('#rows button[data-act]').forEach(b=>{
    const id=b.dataset.id;
    if(b.dataset.act==='edit') b.onclick=()=>{ const d=loadouts.find(x=>x.id===id); if(d) openModal(d); };
    if(b.dataset.act==='del') b.onclick=()=>{ if(confirm('Delete this loadout?')){ loadouts = loadouts.filter(x=>x.id!==id); save(); render(); } };
    if(b.dataset.act==='dup') b.onclick=()=>{ const d=loadouts.find(x=>x.id===id); if(!d) return; const c={...d, id:uid(), title:d.title+' (copy)'}; loadouts.push(c); save(); render(); };
  });
}
function row(r){
  const gcount = Array.isArray(r.gear)? r.gear.length : 0;
  return `
    <tr>
      <td><b style=\"color:var(--accent)\">${esc(r.title)}</b></td>
      <td>${esc(r.rank||'')}</td>
      <td>${esc(r.branch||'')}</td>
      <td>${esc(r.armor||'')}</td>
      <td>${esc(r.tags||'')}</td>
      <td style=\"max-width:360px\"><span class=\"small\">${esc(r.notes||'')}</span></td>
      <td>
        <span class=\"badge\">${gcount} item${gcount===1?'':'s'}</span>
        <button data-act=\"gear\" data-id=\"${r.id}\">Manage Gear</button>
      </td>
      <td style=\"white-space:nowrap\">
        <button data-act=\"edit\" data-id=\"${r.id}\">Edit</button>
        <button data-act=\"dup\"  data-id=\"${r.id}\">Duplicate</button>
        <button data-act=\"del\"  data-id=\"${r.id}\" style=\"border-color:var(--bad);color:var(--bad)\">Del</button>
      </td>
    </tr>`;
}

/* Search/filters */
$('#search').addEventListener('input', render);
$('#branchFilter').addEventListener('input', render);

/* Export / Import */
$('#exportJSON').onclick=()=>{
  const blob=new Blob([JSON.stringify(loadouts,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='jmbn-fps-loadouts.json';a.click();URL.revokeObjectURL(url);
};
$('#importJSON').onclick=()=>{
  const inp=document.createElement('input');inp.type='file';inp.accept='application/json';
  inp.onchange=()=>{
    const f=inp.files?.[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{
      try{
        const arr=JSON.parse(r.result);
        if(!Array.isArray(arr)) throw new Error('Invalid JSON (expected an array)');
        if(confirm('Merge with existing? Click Cancel to REPLACE.')){
          const map=new Map(loadouts.map(x=>[x.id,x])); arr.forEach(x=>{ if(!x.id) x.id=uid(); map.set(x.id,x); }); loadouts=[...map.values()];
        }else{ loadouts = arr.map(x=>({...x, id:x.id||uid()})); }
        save(); render(); alert('Import complete.');
      }catch(e){ alert('Import failed: '+e.message); }
    };
    r.readAsText(f);
  };
  inp.click();
};

// Seed demo
$('#seedBtn').onclick=()=>{
  if(!confirm('Add demo loadouts?')) return;
  const demo=[
    {id:uid(), title:'Boarding – Heavy Breach', rank:'Junior Rate', branch:'Combat', armor:'Heavy', tags:'breach, shield, grenade', notes:'For forced entry and CQB', gear:[{type:'Armor',item:'Heavy Security Set',notes:'Full helmet + heavy core'},{type:'Utility',item:'Multi-Tool',notes:'Tractor attachment'},{type:'Med',item:'MedPen x3',notes:''}]},
    {id:uid(), title:'Field Medic – Rapid Response', rank:'Junior Rate', branch:'Medic', armor:'Medium', tags:'med, rescue', notes:'CSAR kit', gear:[{type:'Armor',item:'Medium Paramed Set',notes:''},{type:'Med',item:'Medical Gun',notes:'Refill canisters'},{type:'Utility',item:'Beacon',notes:'Signal team'}]},
    {id:uid(), title:'Engineering – EVA Patch', rank:'Junior Rate', branch:'Engineering', armor:'Light', tags:'eva, repair', notes:'For exterior patchwork', gear:[{type:'Armor',item:'Light EVA Suit',notes:''},{type:'Tool',item:'Multi-Tool',notes:'Cutter + Tractor'},{type:'Utility',item:'O2 Refill',notes:''}]}
  ];
  // Merge without duplicates by title
  const titles=new Set(loadouts.map(x=>x.title.toLowerCase()));
  demo.forEach(d=>{ if(!titles.has(d.title.toLowerCase())) loadouts.push(d); });
  save(); render();
};

/* ===== Gear Modal Logic ===== */
let gearFor=null; // holds loadout id currently editing
const gBG=$('#gear-bg');
const gRows=$('#gearRows');
function openGear(id){
  gearFor=id; renderGear(); gBG.style.display='flex';
}
function closeGear(){ gBG.style.display='none'; }
$('#gClose').onclick=closeGear;
function renderGear(){
  const lo=loadouts.find(x=>x.id===gearFor); if(!lo) return; lo.gear=Array.isArray(lo.gear)?lo.gear:[];
  gRows.innerHTML = lo.gear.length? lo.gear.map((g,i)=>`
    <tr>
      <td>${esc(g.type||'')}</td>
      <td>${esc(g.item||'')}</td>
      <td>${esc(g.notes||'')}</td>
      <td><button data-i=\"${i}\" data-act=\"gedit\">Edit</button> <button data-i=\"${i}\" data-act=\"gdel\" style=\"border-color:var(--bad);color:var(--bad)\">Del</button></td>
    </tr>`).join('') : `<tr><td colspan=\"4\" class=\"small\">No gear yet — add some above.</td></tr>`;
  // bind actions
  Array.from(gRows.querySelectorAll('button[data-act]')).forEach(b=>{
    const i=Number(b.dataset.i); const lo=loadouts.find(x=>x.id===gearFor); if(!lo) return;
    if(b.dataset.act==='gdel') b.onclick=()=>{ if(confirm('Delete this item?')){ lo.gear.splice(i,1); save(); renderGear(); render(); } };
    if(b.dataset.act==='gedit') b.onclick=()=>{
      const it=lo.gear[i]; if(!it) return;
      const t=prompt('Type', it.type||''); const n=prompt('Item', it.item||''); const s=prompt('Notes', it.notes||'');
      lo.gear[i]={type:t||'', item:n||'', notes:s||''}; save(); renderGear(); render();
    };
  });
}
$('#gAdd').onclick=()=>{
  const lo=loadouts.find(x=>x.id===gearFor); if(!lo) return;
  const type=$('#gType').value.trim(); const item=$('#gItem').value.trim(); const notes=$('#gNotes').value.trim();
  if(!type && !item){ alert('Please enter at least a Type or Item'); return; }
  lo.gear=Array.isArray(lo.gear)?lo.gear:[]; lo.gear.push({type,item,notes});
  $('#gType').value=''; $('#gItem').value=''; $('#gNotes').value='';
  save(); renderGear(); render();
};

// ===== Share Link (URL-embedded data) =====
function makeShareLink(){
  try{
    const json=JSON.stringify(loadouts);
    const b64=btoa(unescape(encodeURIComponent(json)));
    const url=location.origin + location.pathname + '#data=' + b64;
    navigator.clipboard.writeText(url).then(()=>alert('Share link copied to clipboard!'));
  }catch(e){ alert('Failed to make link: '+e.message); }
}
$('#shareLink').onclick=makeShareLink;

// ===== Download static HTML with embedded JSON =====
function downloadStatic(){
  try{
    // Put current data into the embedded script tag
    const tag=document.getElementById('embeddedLoadouts');
    tag.textContent = JSON.stringify(loadouts);
    // Serialize full HTML
    const html='<!DOCTYPE html>' + document.documentElement.outerHTML;
    const blob=new Blob([html],{type:'text/html'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download='fps-loadout.static.html';
    a.click();
    URL.revokeObjectURL(a.href);
  }catch(e){ alert('Failed to build static HTML: '+e.message); }
}
$('#dlStatic').onclick=downloadStatic;

// ===== Load order: hash > ?source > embedded > localStorage =====
(function(){
  const h=location.hash||''; if(h.startsWith('#data=')){
    try{ const b64=h.slice(6); const json=decodeURIComponent(escape(atob(b64))); loadouts=JSON.parse(json); render(); return; }catch(e){ console.warn('Failed to parse shared data:', e); }
  }
})();

(async function(){
  const params=new URLSearchParams(location.search); const src=params.get('source');
  if(src){
    try{ const res=await fetch(src,{cache:'no-cache'}); if(!res.ok) throw new Error(res.status+' '+res.statusText); const arr=await res.json(); if(Array.isArray(arr)){ loadouts=arr; render(); return; } }catch(e){ console.warn('Remote source failed:', e); }
  }
  // Embedded JSON
  try{
    const tag=document.getElementById('embeddedLoadouts');
    if(tag && tag.textContent && tag.textContent.trim() !== '[]'){
      const arr=JSON.parse(tag.textContent); if(Array.isArray(arr)){ loadouts=arr; render(); return; }
    }
  }catch(e){ console.warn('Embedded JSON parse failed:', e); }
  // Fallback to localStorage
  load();
})();

// Boot placeholder (load() is called in the loader above if nothing else supplied)
// (no-op)

load();
</script>
</body>
</html>
