<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN • Elevation Diagnostics</title>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--b:#d6b44c;--a:#f2d675;--t:#f7f1d0;--m:#c9b06a;--bad:#ff6b6b;--ok:#38d39f}
*{box-sizing:border-box} body{background:#000;color:var(--t);font-family:'Play',system-ui,sans-serif;margin:0;padding:18px}
h1{margin:0 0 12px;color:var(--a);font-size:22px}
.panel{background:#0b0b0b;border:1px solid var(--b);border-radius:12px;padding:12px;margin-bottom:12px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{padding:8px 12px;border:1px solid var(--b);border-radius:10px;background:linear-gradient(180deg,#0c0c0c,#060606);color:var(--a);cursor:pointer}
.btn:hover{background:var(--a);color:#000}
.kv{display:grid;grid-template-columns:160px 1fr;gap:6px 10px}
.k{color:var(--m)}
.bad{color:var(--bad)}
.ok{color:var(--ok)}
pre{background:#0a0a0a;border:1px solid #333;border-radius:8px;padding:10px;overflow:auto;max-height:40vh}
.pill{display:inline-block;border:1px solid var(--b);border-radius:999px;padding:3px 10px}
footer{color:#777;font-size:12px;margin-top:10px}
</style>
</head>
<body>
  <h1>Elevation Diagnostics</h1>

  <div class="panel">
    <div class="row">
      <button id="login"  class="btn">Sign in with GitHub</button>
      <button id="logout" class="btn" style="display:none">Sign out</button>
      <div id="who" style="margin-left:auto;color:#c9b06a">Not signed in</div>
    </div>
    <div class="row">
      <button id="run" class="btn">Run checks</button>
      <span class="pill" id="verdict">Elevated: ?</span>
    </div>
  </div>

  <div class="panel">
    <div class="kv">
      <div class="k">User ID</div><div id="uid">—</div>
      <div class="k">Email</div><div id="email">—</div>
      <div class="k">profiles.role</div><div id="pRole">—</div>
      <div class="k">user_roles → roles</div><div id="urRoles">—</div>
      <div class="k">is_elevated()</div><div id="rpc">—</div>
      <div class="k">Overall</div><div id="overall">—</div>
    </div>
  </div>

  <div class="panel">
    <div style="margin-bottom:6px;color:var(--m)">Raw payloads (for debugging)</div>
    <pre id="dump">Run checks to populate…</pre>
  </div>

  <footer>Tip: If <span class="ok">is_elevated() = true</span> but UI says not elevated, your front end is probably reading <code>profiles.role</code> (member) instead of the join/RPC. Sync the profile or switch UI to the RPC.</footer>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

/* === Your project config (same as before) === */
const SUPABASE_URL  = 'https://fcegavhipeaeihxegsnw.supabase.co'
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjZWdhdmhpcGVhZWloeGVnc253Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMjk3NTcsImV4cCI6MjA3NzcwNTc1N30.i-ZjOlKc89-uA7fqOIvmAMv60-C2_NmKikRI_78Jei8'
const sb = createClient(SUPABASE_URL, SUPABASE_ANON)

/* === UI refs === */
const ui = {
  login:  document.getElementById('login'),
  logout: document.getElementById('logout'),
  who:    document.getElementById('who'),
  run:    document.getElementById('run'),
  verdict:document.getElementById('verdict'),
  uid:    document.getElementById('uid'),
  email:  document.getElementById('email'),
  pRole:  document.getElementById('pRole'),
  urRoles:document.getElementById('urRoles'),
  rpc:    document.getElementById('rpc'),
  overall:document.getElementById('overall'),
  dump:   document.getElementById('dump'),
}

function setVerdict(ok){
  ui.verdict.textContent = 'Elevated: ' + (ok ? 'YES' : 'NO')
  ui.verdict.style.borderColor = ok ? 'var(--ok)' : 'var(--bad)'
  ui.verdict.style.color = ok ? 'var(--ok)' : 'var(--bad)'
}

/* === Auth wiring === */
async function refreshWho(){
  const { data:{ session } } = await sb.auth.getSession()
  if(!session){
    ui.who.textContent = 'Not signed in'
    ui.login.style.display = ''
    ui.logout.style.display = 'none'
    setVerdict(false)
    return null
  }
  ui.who.textContent = `Signed in: ${session.user.email}`
  ui.login.style.display = 'none'
  ui.logout.style.display = ''
  return session
}

ui.login.onclick = async () => {
  const { error } = await sb.auth.signInWithOAuth({ provider:'github' })
  if(error) alert(error.message)
}

ui.logout.onclick = async () => {
  await sb.auth.signOut()
  setVerdict(false)
  ui.uid.textContent = '—'
  ui.email.textContent = '—'
  ui.pRole.textContent = '—'
  ui.urRoles.textContent = '—'
  ui.rpc.textContent = '—'
  ui.overall.textContent = '—'
  ui.dump.textContent = 'Run checks to populate…'
  await refreshWho()
}
sb.auth.onAuthStateChange(refreshWho)
await refreshWho()

/* === Main diagnostic === */
ui.run.onclick = async () => {
  const { data:{ session } } = await sb.auth.getSession()
  if(!session){ alert('Please sign in first.'); return }

  const uid = session.user.id
  ui.uid.textContent = uid
  ui.email.textContent = session.user.email || '—'

  // 1) profiles.role (make sure to use profiles.user_id)
  const { data: prof, error: profErr } = await sb
    .from('profiles')
    .select('role, handle')
    .eq('user_id', uid)
    .single()

  ui.pRole.textContent = profErr ? `— (error: ${profErr.message})` : (prof?.role || '—')

  // 2) user_roles → roles (list the mapped role names)
  // prefer a single select with embedded relation if FK exists:
  let urPretty = '—'
  try {
    const { data: ur } = await sb
      .from('user_roles')
      .select('role_id, roles(name)')
      .eq('user_id', uid)
    urPretty = (ur && ur.length)
      ? ur.map(x => x.roles?.name || `id:${x.role_id}`).join(', ')
      : '(none)'
  } catch(e){
    urPretty = '(query failed)'
  }
  ui.urRoles.textContent = urPretty

  // 3) RPC is_elevated(u)
  const { data: rpcData, error: rpcErr } = await sb.rpc('is_elevated', { u: uid })
  const rpcVal = (rpcErr ? `error: ${rpcErr.message}` : (rpcData === true ? 'true' : 'false'))
  ui.rpc.innerHTML = rpcErr
    ? `<span class="bad">${rpcVal}</span>`
    : (rpcData ? `<span class="ok">true</span>` : `<span class="bad">false</span>`)

  // 4) Overall + mismatch hints
  const elevated = rpcData === true
  setVerdict(elevated)

  let note = ''
  const pRoleLower = (prof?.role || '').toString().toLowerCase()
  if(elevated && (pRoleLower !== 'admin' && pRoleLower !== 'officer')) {
    note = ' (RPC says elevated but profiles.role is not admin/officer — update profile or switch UI to use RPC)'
  }
  if(!elevated && (pRoleLower === 'admin' || pRoleLower === 'officer')) {
    note = ' (profiles.role says admin/officer but user_roles has no elevated entry — add role mapping)'
  }
  ui.overall.textContent = (elevated ? 'Elevated' : 'Not elevated') + note

  // dump
  ui.dump.textContent = JSON.stringify({
    user:{ id: uid, email: session.user.email },
    profiles: profErr ? {error: profErr.message} : prof,
    user_roles_roles: urPretty,
    is_elevated: rpcErr ? {error: rpcErr.message} : rpcData
  }, null, 2)
}
</script>
</body>
</html>