<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Hangar</title>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--border:#d6b44c;--card:#141414;
  --accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;
  --fs-base:14px;--fs-small:11px;--fs-table:13px;--fs-h1:clamp(18px,2.2vw,22px);--fs-h2:clamp(14px,1.6vw,16px)
}
*{box-sizing:border-box}
body{
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text); font-family:'Play','Segoe UI',Roboto,Helvetica,Arial,sans-serif;
  margin:0; padding:14px; letter-spacing:.25px; font-size:var(--fs-base)
}

/* === Brand === */
.brand{display:flex;align-items:center;gap:10px;margin:0 0 8px;border-bottom:1px solid var(--border);padding-bottom:6px}
.brand-logo{width:44px;height:44px;object-fit:contain;filter:drop-shadow(0 0 4px rgba(242,214,117,.25))}
.brand h1{font-weight:700;font-size:var(--fs-h1);color:var(--accent);margin:0}

/* === Shiny Button Nav (light-gold text) === */
.nav{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
.nav-btn{
  --gold:#f2d675;--gold2:#e7c760;--ring:#d6b44c;
  position:relative;display:inline-flex;align-items:center;justify-content:center;
  padding:7px 14px;border:1px solid var(--ring);border-radius:999px;
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);text-decoration:none;font-weight:700;
  letter-spacing:.2px;box-shadow:inset 0 0 0 1px rgba(214,180,76,.12);
  transition:transform .15s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
}
.nav-btn:hover{
  transform:translateY(-1px);
  box-shadow:0 0 12px rgba(214,180,76,.25), inset 0 0 0 1px rgba(214,180,76,.18);
  background:linear-gradient(180deg,#1a1a1a,#0a0a0a);
  color:var(--accent);
}
.nav-btn.active{
  color:#000;
  background:
    radial-gradient(120% 120% at 80% -20%, rgba(255,255,255,.32), rgba(255,255,255,0) 40%),
    linear-gradient(180deg,var(--gold),var(--gold2));
  border-color:var(--ring);
  box-shadow:
    0 0 20px rgba(214,180,76,.45),
    inset 0 1px 0 rgba(255,255,255,.25),
    inset 0 -1px 0 rgba(0,0,0,.12);
}
.nav-btn.active::after{
  content:"";position:absolute;inset:0;
  background:linear-gradient(120deg,rgba(255,255,255,0) 30%,rgba(255,255,255,.32) 50%,rgba(255,255,255,0) 70%);
  border-radius:inherit;transform:translateX(-120%);
  animation:shine 2.8s ease-in-out infinite;pointer-events:none;
}
@keyframes shine{
  0%{transform:translateX(-120%);}
  35%{transform:translateX(120%);}
  100%{transform:translateX(120%);}
}

/* === Layout === */
.wrap{display:grid;grid-template-columns:minmax(640px,1fr) 400px;gap:12px}
@media (max-width:1060px){.wrap{grid-template-columns:1fr}}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:0 0 18px rgba(214,180,76,.22), inset 0 0 0 1px rgba(214,180,76,.12)}
.rightSticky{position:sticky;top:12px;height:fit-content}

/* === Controls === */
/* equal widths for six items (Search, All roles, All sizes, Any selection, Export, Import) */
.controls{
  display:grid;
  grid-template-columns: repeat(6, 1fr);
  gap:8px;margin:6px 0 8px
}
@media(max-width:980px){
  .controls{grid-template-columns:repeat(2, 1fr)}
}
.controls input,.controls select{
  background:#0a0a0a;border:1px solid var(--border);border-radius:8px;padding:9px;color:var(--text);font-size:var(--fs-table);font-family:'Play',sans-serif;width:100%;
}
button{
  padding:9px 10px;border-radius:8px;background:linear-gradient(180deg,#0c0c0c,#060606);color:var(--accent);border:1px solid var(--border);cursor:pointer;font-size:calc(var(--fs-base) - 1px);transition:.2s;font-family:'Play',sans-serif;width:100%;
}
button:hover{background:var(--accent);color:#000}
.btn-primary{background:var(--accent);color:#000}

/* === List === */
.list{display:flex;flex-direction:column;gap:8px}
.row{display:grid;grid-template-columns:1.2fr 1fr auto;gap:8px;align-items:center;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:9px}
@media(max-width:880px){.row{grid-template-columns:1fr;align-items:flex-start}}
.shipTitle{font-weight:800;color:var(--accent);font-size:16px;line-height:1.1}
.shipSub{color:var(--muted);font-size:12px;margin-top:2px}
.badgebar{display:flex;gap:6px;flex-wrap:wrap}
.badge{border:1px solid var(--border);border-radius:999px;padding:3px 8px;font-size:11px;color:var(--muted);background:#0c0c0c}

/* === Actions in ONE ROW (4 equal buttons) === */
.actions{
  display:grid;
  grid-template-columns: repeat(4, 1fr);
  gap:6px;
}
.actions button{
  width:100%;
  padding:8px 0;
  border-radius:8px;
  border:1px solid var(--border);
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);
  font-size:12px;
  cursor:pointer;
  transition:.2s;
}
.actions button:hover{
  background:var(--accent);
  color:#000;
}
.actions button.btn-primary{
  background:var(--accent);
  color:#000;
}
.actions button.delete{
  border-color:var(--bad);
  color:var(--bad);
}
.actions button.delete:hover{
  background:var(--bad);
  color:#000;
}

/* === Editor === */
.formHead h2{margin:0;color:var(--accent);font-size:var(--fs-h2)}
.block{background:#0c0c0c;border:1px solid var(--border);border-radius:12px;padding:10px;margin-top:8px}
label{display:flex;flex-direction:column;gap:4px;margin-bottom:8px;color:var(--muted);font-size:var(--fs-table)}
input,select,textarea{background:#0a0a0a;border:1px solid var(--border);border-radius:8px;padding:9px;color:var(--text);font-size:var(--fs-table);font-family:'Play',sans-serif}
textarea{min-height:70px;resize:vertical}

/* === LOADOUT MODAL (components-only) === */
.lo-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(2px)}
.lo-modal{width:min(920px,95vw);background:#0b0b0b;border:1px solid var(--border);border-radius:12px;box-shadow:0 0 22px rgba(214,180,76,.28), inset 0 0 0 1px rgba(214,180,76,.12);font-family:'Play',system-ui,sans-serif;color:#f7f1d0}
.lo-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(214,180,76,.35)}
.lo-title{font-weight:800;color:#f2d675}
.lo-body{display:grid;grid-template-columns:1fr 360px;gap:10px;padding:12px}
@media(max-width:860px){.lo-body{grid-template-columns:1fr}}
.lo-card{background:#0c0c0c;border:1px solid var(--border);border-radius:10px;padding:10px}
.lo-list{display:flex;flex-direction:column;gap:8px;max-height:56vh;overflow:auto}
.lo-row{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:8px;align-items:center;background:#0b0b0b;border:1px solid rgba(214,180,76,.35);border-radius:10px;padding:8px}
@media(max-width:720px){.lo-row{grid-template-columns:1fr}}
.lo-k{display:block;font-size:11px;color:#c9b06a}
.lo-v{font-weight:800}
.lo-actions{display:flex;gap:6px;justify-content:flex-end}
.lo-field{display:flex;flex-direction:column;gap:4px;margin-bottom:8px}
.lo-input,.lo-select,.lo-text{background:#0a0a0a;border:1px solid var(--border);border-radius:8px;padding:9px;color:#f7f1d0;font-family:inherit}
.lo-text{min-height:68px;resize:vertical}
.lo-btn{padding:8px 12px;border-radius:10px;background:linear-gradient(180deg,#0c0c0c,#060606);color:#f7f1d0;border:1px solid var(--border);cursor:pointer}
.lo-btn:hover{background:#f2d675;color:#000}
.lo-btn.primary{background:#f2d675;color:#000}
.lo-tagbar{display:none}
.lo-empty{border:1px dashed rgba(214,180,76,.5);border-radius:10px;padding:16px;text-align:center;color:#c9b06a}

/* === Mini Picker === */
.lo-pick{display:none;position:fixed;inset:0;z-index:1100;align-items:center;justify-content:center;background:rgba(0,0,0,.7)}
.lo-pick-card{width:min(860px,94vw);background:#0b0b0b;border:1px solid var(--border);border-radius:10px;padding:10px}
.lo-pick-grid{display:grid;grid-template-columns:260px 1fr;gap:10px}
@media(max-width:880px){.lo-pick-grid{grid-template-columns:1fr}}
.lo-pick-list{max-height:56vh;overflow:auto;display:flex;flex-direction:column;gap:8px}
.lo-pi{border:1px solid rgba(214,180,76,.35);border-radius:10px;padding:8px;display:grid;grid-template-columns:1fr auto;gap:8px}
.lo-meta{font-size:12px;color:#c9b06a}
</style>
</head>

<body>
  <div class="brand">
    <img src="https://static.wixstatic.com/media/b6db55_17d1c3c1572f401b948fa21101b18467~mv2.png/v1/fill/w_66,h_66,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/0_New_JMBN_Logo_Gold.png" alt="JMBN" class="brand-logo">
    <h1>JMBN Hangar</h1>
  </div>

  <nav class="nav">
    <a class="nav-btn" href="index.html">Manifest</a>
    <a class="nav-btn" href="hangar.html">Hangar</a>
    <a class="nav-btn" href="components.html">Components</a>
    <a class="nav-btn" href="contracts.html">Contracts</a>
    <!-- Loadouts link removed -->
  </nav>

  <div class="wrap">
    <!-- LEFT: Hangar list -->
    <div class="panel">
      <div class="controls">
        <input id="q" placeholder="Search ship or mfrâ€¦ (e.g., Cutlass, RSI)">
        <select id="fRole">
          <option value="">All roles</option>
          <option>Medical</option><option>Stealth</option><option>Combat</option><option>Cargo</option><option>Exploration</option><option>Capital</option><option>Support</option><option>Salvage</option>
        </select>
        <select id="fSize">
          <option value="">All sizes</option>
          <option>Solo</option><option>Small</option><option>Medium</option><option>Large</option><option>Capital</option>
        </select>
        <select id="fSel"><option value="">Any selection</option><option value="1">Selected only</option><option value="0">Unselected only</option></select>
        <button id="export" title="Export hangar JSON">Export</button>
        <button id="import" title="Import hangar JSON">Import</button>
        <input type="file" id="file" accept="application/json" style="display:none">
      </div>
      <div id="list" class="list"></div>
      <p class="small" style="margin-top:6px;color:#c9b06a">Selected ships are also saved as <code>jmbn-hangar-selected</code> for the Loadouts page.</p>
    </div>

    <!-- RIGHT: Editor -->
    <div class="panel rightSticky">
      <div class="formHead"><h2>Add / Edit Ship</h2></div>
      <div class="block">
        <input type="hidden" id="key">

        <label>Ship Name <input id="name" placeholder="e.g., Cutlass Black" required></label>

        <label>Manufacturer
          <select id="mfr">
            <option value="">-- select --</option>
            <option>Aegis Dynamics</option><option>Anvil Aerospace</option><option>Aopoa</option><option>Argo Astronautics</option>
            <option>Banu Souli</option><option>Consolidated Outland</option><option>Crusader Industries</option><option>Drake Interplanetary</option>
            <option>Esperia Inc.</option><option>Gatac Manufacture</option><option>Kruger Intergalactic</option>
            <option>Musashi Industrial & Starflight Concern</option><option>Origin Jumpworks GmbH</option><option>Roberts Space Industries</option>
          </select>
        </label>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <label>Role
            <select id="role"><option value=""></option><option>Medical</option><option>Stealth</option><option>Combat</option><option>Cargo</option><option>Exploration</option><option>Capital</option><option>Support</option><option>Salvage</option></select>
          </label>
          <label>Size
            <select id="size"><option value=""></option><option>Solo</option><option>Small</option><option>Medium</option><option>Large</option><option>Capital</option></select>
          </label>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <label>Pilot Weapons
            <select id="pilot"><option value=""></option><option>Yes</option><option>No</option></select>
          </label>
          <label>Medical Bay
            <select id="med"><option value=""></option><option>Yes</option><option>No</option></select>
          </label>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <label>SCU <input id="scu" type="number" min="0" placeholder="e.g., 46"></label>
          <label>Tractor Beam
            <select id="tractor"><option value=""></option><option>Yes</option><option>No</option><option>Planned</option></select>
          </label>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
          <button id="save" class="btn-primary">Save Ship</button>
          <button id="reset">Reset</button>
          <button id="del" style="border-color:var(--bad);color:var(--bad)">Delete</button>
        </div>
      </div>
      <div class="block">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="seed">Seed Demo Ships</button>
          <button id="clearAll" style="border-color:var(--bad);color:var(--bad)">Clear Hangar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== LOADOUT MODAL (components only) ===== -->
  <div class="lo-backdrop" id="loBackdrop" role="dialog" aria-modal="true" aria-label="Edit Loadout">
    <div class="lo-modal">
      <div class="lo-head">
        <div>
          <div class="lo-title" id="loShipTitle">Ship</div>
          <div style="font-size:12px;color:#c9b06a" id="loShipSub"></div>
          <div class="lo-tagbar" id="loTags"></div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="lo-btn" id="loClose">âœ•</button>
        </div>
      </div>

      <div class="lo-body">
        <!-- Left: Components on this ship -->
        <div class="lo-card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <strong>Components</strong>
            <button class="lo-btn primary" id="loAdd">Add Component</button>
          </div>
          <div id="loList" class="lo-list"></div>
        </div>

        <!-- Right: Component Editor only -->
        <div class="lo-card">
          <div style="margin-bottom:6px"><strong>Component Editor</strong></div>
          <input type="hidden" id="loCompIdx">
          <div class="lo-field">Type
            <select class="lo-select" id="loCType">
              <option>Quantum Drive</option><option>Shield Generator</option><option>Power Plant</option><option>Cooler</option>
              <option>Computer</option><option>Radar</option><option>Weapon Mount</option><option>Missile Rack</option>
            </select>
          </div>
          <div class="lo-field">Component Name <input class="lo-input" id="loCName" placeholder="e.g., Atlas"></div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div class="lo-field">Manufacturer <input class="lo-input" id="loCMfr" placeholder="e.g., Wen/Cassel Propulsic"></div>
            <div class="lo-field">Where to Buy <input class="lo-input" id="loCBuy" placeholder="e.g., Area18, Lorville, Grim HEX"></div>
          </div>
          <div class="lo-field">Notes <textarea class="lo-text" id="loCNotes" placeholder="Why this pick / patch notes"></textarea></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="lo-btn" id="loPick">Pick from Components</button>
            <button class="lo-btn primary" id="loSaveComp">Save Component</button>
            <button class="lo-btn" id="loClearComp">Clear</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mini Picker -->
  <div class="lo-pick" id="loPickBack">
    <div class="lo-pick-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div class="lo-title">Pick Component</div>
        <button class="lo-btn" id="loPickClose">âœ•</button>
      </div>
      <div class="lo-pick-grid">
        <div class="lo-card">
          <div class="lo-field">Component Type
            <select class="lo-select" id="loPType"><option value="">All</option>
              <option>Quantum Drive</option><option>Shield Generator</option><option>Power Plant</option><option>Cooler</option>
              <option>Computer</option><option>Radar</option><option>Weapon Mount</option><option>Missile Rack</option>
            </select>
          </div>
          <div class="lo-field">Search <input class="lo-input" id="loPSearch" placeholder="Name, mfr, tagsâ€¦"></div>
          <div class="lo-field">Source <select class="lo-select" id="loPSource"></select></div>
          <div style="font-size:11px;color:#c9b06a">Sources are localStorage keys saved by <b>components.html</b>.</div>
        </div>
        <div class="lo-card">
          <div id="loPList" class="lo-pick-list"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* === Highlight current nav === */
(function(){
  const here = location.pathname.split('/').pop() || 'index.html';
  document.querySelectorAll('.nav-btn').forEach(a=>{
    const href = a.getAttribute('href');
    if (href === here || (here === '' && href === 'index.html')) {
      a.classList.add('active');
      a.setAttribute('aria-current','page');
    }
  });
})();

/* ===== Hangar storage ===== */
const HANGAR_KEY='jmbn-hangar-v1';
const HANGAR_SEL='jmbn-hangar-selected';
const LOADOUT_KEY='jmbn-loadouts-v6';
const $=s=>document.querySelector(s);
const list=$('#list');

function uid(){return 'H'+Math.random().toString(36).slice(2,8);}
function esc(s=''){const d=document.createElement('div');d.textContent=s??'';return d.innerHTML;}

let hangar = JSON.parse(localStorage.getItem(HANGAR_KEY)||'[]');
persist(); render();

/* ===== Filters ===== */
['q','fRole','fSize','fSel'].forEach(id=>{
  const el=document.getElementById(id);
  el?.addEventListener('input',render,{passive:true});
  el?.addEventListener('change',render);
});

/* ===== Editor ===== */
const f={ key:$('#key'), name:$('#name'), mfr:$('#mfr'), role:$('#role'), size:$('#size'), pilot:$('#pilot'), med:$('#med'),
          scu:$('#scu'), tractor:$('#tractor'),
          save:$('#save'), reset:$('#reset'), del:$('#del') };

f.save.onclick=()=>{
  const key=f.key.value||uid();
  const s={
    key,
    name:f.name.value.trim(),
    mfr:f.mfr.value,
    role:f.role.value,
    size:f.size.value,
    pilot:f.pilot.value,
    med:f.med.value,
    scu: f.scu.value ? Number(f.scu.value) : null,
    tractor: f.tractor.value,
    selected: (hangar.find(x=>x.key===key)?.selected)===true
  };
  if(!s.name){ alert('Ship name required'); return; }
  const i=hangar.findIndex(x=>x.key===key);
  if(i>=0){ hangar[i]=s; } else { hangar.push(s); }
  persist(); render(); fillForm(s);
};
f.reset.onclick=()=>clearForm();
f.del.onclick=()=>{
  const key=f.key.value; if(!key) return;
  if(!confirm('Delete this ship?')) return;
  hangar=hangar.filter(x=>x.key!==key); persist(); clearForm(); render();
};

function fillForm(s){
  f.key.value=s.key; f.name.value=s.name||''; f.mfr.value=s.mfr||'';
  f.role.value=s.role||''; f.size.value=s.size||'';
  f.pilot.value=s.pilot||''; f.med.value=s.med||'';
  f.scu.value=(s.scu??''); f.tractor.value=s.tractor||'';
}
function clearForm(){
  f.key.value=''; f.name.value=''; f.mfr.value='';
  f.role.value=''; f.size.value='';
  f.pilot.value=''; f.med.value='';
  f.scu.value=''; f.tractor.value='';
}

/* ===== Seed / Clear / Import / Export ===== */
$('#seed').onclick=()=>{
  if(!confirm('Add demo ships?')) return;
  const demo=[
    s('Cutlass Black','Drake Interplanetary','Cargo','Small','Yes','No',46,'Yes'),
    s('Carrack','Anvil Aerospace','Exploration','Large','No','Yes',456,'Planned'),
    s('Constellation Taurus','Roberts Space Industries','Cargo','Medium','Yes','No',174,'No'),
    s('Freelancer MAX','Musashi Industrial & Starflight Concern','Cargo','Medium','Yes','No',122,'Yes'),
    s('C2 Hercules','Crusader Industries','Cargo','Large','No','No',696,'No'),
    s('Cutlass Red','Drake Interplanetary','Medical','Small','Yes','Yes',34,'Yes'),
  ];
  for(const x of demo){ if(!hangar.some(h=>h.name.toLowerCase()===x.name.toLowerCase())) hangar.push(x); }
  persist(); render();
};
function s(name,mfr,role,size,pilot,med,scu,tractor){
  return { key:uid(), name, mfr, role, size, pilot, med, scu, tractor, selected:false };
}

$('#clearAll').onclick=()=>{ if(!confirm('Delete ALL hangar items?')) return; hangar=[]; persist(); render(); clearForm(); };

$('#export').onclick=()=>{
  const blob=new Blob([JSON.stringify(hangar,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download='jmbn-hangar.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
};
$('#import').onclick=()=>$('#file').click();
$('#file').addEventListener('change', e=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const arr=JSON.parse(r.result);
      if(!Array.isArray(arr)) throw new Error('Invalid JSON (expected an array)');
      arr.forEach(x=>{ if(!x.key) x.key=uid(); x.selected=!!x.selected; });
      if(confirm('Merge with existing hangar? Click Cancel to REPLACE.')){
        const map=new Map(hangar.map(s=>[s.key,s])); for(const x of arr){ map.set(x.key,x); } hangar=[...map.values()];
      }else{ hangar=arr; }
      persist(); render(); alert('Import complete.');
    }catch(err){ alert('Import failed: '+err.message); }
    e.target.value='';
  };
  r.readAsText(f);
});

/* ===== Render list ===== */
list.addEventListener('click',(e)=>{
  const b=e.target.closest('button'); if(!b) return;
  const {act, key} = b.dataset;
  const it=hangar.find(x=>x.key===key); if(!it) return;
  if(act==='edit'){ fillForm(it); window.scrollTo({top:0,behavior:'smooth'}); }
  if(act==='del'){ if(confirm('Delete this ship?')){ hangar=hangar.filter(x=>x.key!==key); persist(); render(); } }
  if(act==='sel'){ it.selected=!it.selected; persist(); render(); }
  if(act==='lo'){ openLoadoutModal(it.name, it.mfr); }
});

function render(){
  const q=($('#q')?.value||'').toLowerCase();
  const r=$('#fRole')?.value||'';
  const s=$('#fSize')?.value||'';
  const fs=$('#fSel')?.value||'';

  let arr=hangar.slice();
  if(q) arr=arr.filter(x=>`${x.name} ${x.mfr}`.toLowerCase().includes(q));
  if(r) arr=arr.filter(x=>x.role===r);
  if(s) arr=arr.filter(x=>x.size===s);
  if(fs==='1') arr=arr.filter(x=>x.selected===true);
  if(fs==='0') arr=arr.filter(x=>!x.selected);

  list.innerHTML = arr.length ? arr.map(row).join('') : `<div class="small">No ships. Add some with the editor on the right or click <b>Seed Demo Ships</b>.</div>`;
  syncSelectedNames();
}
function row(it){
  const tags = `
    ${it.role?`<span class="badge">${esc(it.role)}</span>`:''}
    ${it.size?`<span class="badge">${esc(it.size)}</span>`:''}
    ${it.pilot?`<span class="badge">Pilot: ${esc(it.pilot)}</span>`:''}
    ${it.med?`<span class="badge">MedBay: ${esc(it.med)}</span>`:''}
    ${it.scu!=null?`<span class="badge">SCU: ${esc(String(it.scu))}</span>`:''}
    ${it.tractor?`<span class="badge">Tractor: ${esc(it.tractor)}</span>`:''}
    ${it.selected?`<span class="badge">Selected</span>`:''}
  `;
  return `
    <div class="row">
      <div>
        <div class="shipTitle">${esc(it.name)}</div>
        <div class="shipSub">${esc(it.mfr||'â€”')}</div>
      </div>
      <div class="badgebar">${tags}</div>
      <div class="actions">
        <button data-act="sel" data-key="${it.key}" class="${it.selected?'btn-primary':''}">${it.selected?'Unselect':'Select'}</button>
        <button data-act="lo"  data-key="${it.key}">Loadouts</button>
        <button data-act="edit" data-key="${it.key}">Edit</button>
        <button data-act="del"  data-key="${it.key}" class="delete">Delete</button>
      </div>
    </div>`;
}
function persist(){ localStorage.setItem(HANGAR_KEY, JSON.stringify(hangar)); syncSelectedNames(); }
function syncSelectedNames(){
  const names = hangar.filter(x=>x.selected).map(x=>x.name).filter(Boolean);
  localStorage.setItem(HANGAR_SEL, JSON.stringify(names));
}

/* ===== Loadout modal logic (shared with Loadouts page) ===== */
let loData = JSON.parse(localStorage.getItem(LOADOUT_KEY)||'[]');
function loPersist(){ localStorage.setItem(LOADOUT_KEY, JSON.stringify(loData)); }

function getShipLoadout(name){
  const n=(name||'').trim();
  let s=loData.find(x=>x.name?.toLowerCase()===n.toLowerCase());
  if(!s){ s={ key:'L'+Math.random().toString(36).slice(2,8), name:n, mfr:'', role:'', size:'', pilot:'', med:'', components:[] }; loData.push(s); loPersist(); }
  return s;
}
function saveShipLoadout(s){
  const i=loData.findIndex(x=>x.key===s.key);
  if(i>=0) loData[i]=s; else loData.push(s);
  loPersist();
}

/* Modal DOM refs */
const loBackdrop=$('#loBackdrop'), loList=$('#loList');
const fields={
  title:$('#loShipTitle'), sub:$('#loShipSub'),
  cIdx:document.getElementById('loCompIdx'), cType:document.getElementById('loCType'),
  cName:document.getElementById('loCName'), cMfr:document.getElementById('loCMfr'),
  cBuy:document.getElementById('loCBuy'), cNotes:document.getElementById('loCNotes'),
};
let currentShip=null;

function openLoadoutModal(shipName, mfr=''){
  currentShip = getShipLoadout(shipName);
  if(mfr && !currentShip.mfr){ currentShip.mfr=mfr; saveShipLoadout(currentShip); }

  fields.title.textContent=currentShip.name||'';
  fields.sub.textContent=currentShip.mfr||'';

  clearCompForm();
  renderCompList();
  loBackdrop.style.display='flex';
}
function closeLoadoutModal(){ loBackdrop.style.display='none'; }

function renderCompList(){
  const arr=currentShip.components||[];
  if(!arr.length){ loList.innerHTML=`<div class="lo-empty">No components yet â€” use <b>Add Component</b> or the picker.</div>`; return; }
  loList.innerHTML=arr.map((c,i)=>`
    <div class="lo-row">
      <div><span class="lo-k">Type</span><span class="lo-v">${esc(c.type||'')}</span></div>
      <div><span class="lo-k">Component</span><span class="lo-v">${esc(c.name||'')}</span></div>
      <div><span class="lo-k">Where to Buy</span><span class="lo-v">${esc(c.buy||'')}</span></div>
      <div class="lo-actions">
        <button class="lo-btn" data-act="edit" data-idx="${i}">Edit</button>
        <button class="lo-btn" data-act="del" data-idx="${i}" style="border-color:#ff6b6b;color:#ff6b6b">Del</button>
      </div>
      <div style="grid-column:1/-1"><span class="lo-k">Manufacturer</span><span class="lo-v">${esc(c.mfr||'â€”')}</span></div>
      ${c.notes?`<div style="grid-column:1/-1"><span class="lo-k">Notes</span><div class="lo-v">${esc(c.notes)}</div></div>`:''}
    </div>`).join('');
  loList.querySelectorAll('button[data-act]').forEach(b=>{
    b.onclick=()=>{
      const idx=+b.dataset.idx;
      if(b.dataset.act==='del'){
        if(confirm('Remove this component?')){ currentShip.components.splice(idx,1); saveShipLoadout(currentShip); renderCompList(); }
      }else{
        const c=currentShip.components[idx];
        fields.cIdx.value=String(idx);
        fields.cType.value=c.type||'Quantum Drive';
        fields.cName.value=c.name||'';
        fields.cMfr.value=c.mfr||'';
        fields.cBuy.value=c.buy||'';
        fields.cNotes.value=c.notes||'';
      }
    };
  });
}
function clearCompForm(){ fields.cIdx.value=''; fields.cType.value='Quantum Drive'; fields.cName.value=''; fields.cMfr.value=''; fields.cBuy.value=''; fields.cNotes.value=''; }

document.getElementById('loClose').onclick=closeLoadoutModal;
document.getElementById('loAdd').onclick=()=>{ clearCompForm(); fields.cName.focus(); };
document.getElementById('loSaveComp').onclick=()=>{
  if(!currentShip) return;
  const entry={ type:fields.cType.value, name:fields.cName.value.trim(), mfr:fields.cMfr.value.trim(), buy:fields.cBuy.value.trim(), notes:fields.cNotes.value.trim() };
  if(!entry.name){ alert('Component name is required.'); return; }
  const idx=fields.cIdx.value===''?-1:+fields.cIdx.value;
  if(idx>=0) currentShip.components[idx]=entry; else currentShip.components.push(entry);
  saveShipLoadout(currentShip); clearCompForm(); renderCompList();
};
document.getElementById('loClearComp').onclick=clearCompForm;

/* ===== Components picker (reads from components.html) ===== */
const pickBack=document.getElementById('loPickBack'),
      pType=document.getElementById('loPType'),
      pSearch=document.getElementById('loPSearch'),
      pSource=document.getElementById('loPSource'),
      pList=document.getElementById('loPList');

document.getElementById('loPick').onclick=()=>{ buildSources(); pType.value=document.getElementById('loCType').value; pSearch.value=''; renderPicker(); pickBack.style.display='flex'; };
document.getElementById('loPickClose').onclick=()=>{ pickBack.style.display='none'; };
pickBack.addEventListener('click', e=>{ if(e.target===pickBack) pickBack.style.display='none'; });
pType.addEventListener('change', renderPicker);
pSearch.addEventListener('input', renderPicker);
pSource.addEventListener('change', ()=>{ loadFromSource(pSource.value); renderPicker(); });

function buildSources(){
  const candidates=Object.keys(localStorage);
  const likely=['jmbn-components','jmbn-components-v2','components-db','components','componentsList'];
  const ordered=[...new Set([...likely,...candidates])];
  const found=[];
  for(const k of ordered){
    try{ const v=JSON.parse(localStorage.getItem(k)); if(Array.isArray(v)&&v.some(isComponentLike)) found.push({key:k,count:v.length}); }catch{}
  }
  pSource.innerHTML=found.length?found.map((s,i)=>`<option value="${esc(s.key)}"${i===0?' selected':''}>${esc(s.key)} (${s.count})</option>`).join(''):`<option>No components DB found</option>`;
  if(found.length){ loadFromSource(found[0].key); } else { pickerState.items=[]; }
}
function isComponentLike(x){ if(!x||typeof x!=='object') return false; const f=Object.keys(x).map(y=>y.toLowerCase()); return f.some(k=>['name','title'].includes(k))&&f.some(k=>['type','slot','category'].includes(k)); }
function norm(it){ return { type:it.type||it.slot||it.category||'', name:it.name||it.title||'', mfr:it.mfr||it.manufacturer||it.brand||'', buy:it.buy||it.where||it.location||it.shop||'', notes:it.notes||it.desc||it.description||'', size:it.size||it.class||it.grade||it.rating||'' }; }
let pickerState={items:[],filtered:[]};
function loadFromSource(k){ try{ pickerState.items=(JSON.parse(localStorage.getItem(k)||'[]')||[]).map(norm); }catch{ pickerState.items=[]; } }
function renderPicker(){
  const t=(pType.value||'').toLowerCase(), q=(pSearch.value||'').toLowerCase().trim();
  pickerState.filtered=pickerState.items.filter(it=>{
    const matchType=!t||(it.type||'').toLowerCase()===t;
    const bag=`${it.name} ${it.mfr} ${it.buy} ${it.notes} ${it.size}`.toLowerCase();
    return matchType && (!q||bag.includes(q));
  });
  pList.innerHTML=pickerState.filtered.length?pickerState.filtered.map((it,i)=>`
    <div class="lo-pi">
      <div>
        <div class="lo-title" style="font-size:14px">${esc(it.name||'Unnamed')}</div>
        <div class="lo-meta"><b>${esc(it.type||'â€”')}</b> â€¢ ${esc(it.mfr||'â€”')}${it.size?` â€¢ ${esc(it.size)}`:''}${it.buy?` â€¢ ${esc(it.buy)}`:''}</div>
        ${it.notes?`<div style="font-size:12px;color:#c9b06a;margin-top:4px">${esc(it.notes)}</div>`:''}
      </div>
      <div><button class="lo-btn primary" data-pick="${i}">Use</button></div>
    </div>`).join(''):`<div class="lo-empty">No components found for this filter.</div>`;
  pList.querySelectorAll('[data-pick]').forEach(btn=>btn.onclick=()=>{
    const it=pickerState.filtered[+btn.dataset.pick];
    document.getElementById('loCType').value=it.type||document.getElementById('loCType').value;
    document.getElementById('loCName').value=it.name||'';
    document.getElementById('loCMfr').value=it.mfr||'';
    document.getElementById('loCBuy').value=it.buy||'';
    document.getElementById('loCNotes').value=it.notes||'';
    pickBack.style.display='none';
  });
}
</script>
</body>
</html>
