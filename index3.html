<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JMBN — Mission Payout Editor</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--card:#0c0c0c;--row:#0a0a0a;
  --border:#d6b44c;--accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;--ok:#7CFC9A;
  --fs:14px
}
*{box-sizing:border-box}
html,body{margin:0;background:#000;color:var(--text);font-family:'Play',system-ui,sans-serif;font-size:var(--fs);letter-spacing:.25px}

/* Shell */
.wrap{max-width:1180px;margin:22px auto;padding:0 14px}
.brand{display:flex;align-items:center;gap:10px;margin:0 0 14px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.brand img{width:44px;height:44px;object-fit:contain}
.brand h1{margin:0;color:var(--accent);font-size:clamp(18px,2.6vw,24px)}

/* Mission header */
.head{
  background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;
  box-shadow:0 0 18px rgba(214,180,76,.18); margin-bottom:12px
}
.head .title{font-weight:800;font-size:16px}
.head .sub{font-size:12px;color:var(--muted);margin-top:2px}
.badge{border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:11px;background:#0c0c0c;color:var(--muted)}
.mono{font-variant-numeric:tabular-nums}

/* Layout */
.main{display:grid;grid-template-columns:1fr 360px;gap:14px}
@media(max-width:1080px){.main{grid-template-columns:1fr}}

/* Roster list */
.card{
  background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;
  box-shadow:0 0 18px rgba(214,180,76,.18)
}
.card h3{margin:0 0 8px;color:var(--accent);font-size:16px}

.member{
  background:var(--card);border:1px solid var(--border);border-radius:10px;
  padding:10px;margin:10px 0;display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;
}
.member:hover{box-shadow:0 0 10px rgba(214,180,76,.25)}
.name{font-weight:800}
.meta{font-size:12px;color:var(--muted)}
.tag{display:inline-flex;align-items:center;gap:6px}
.tag .dot{width:8px;height:8px;border-radius:50%}
.tag .dot.ok{background:var(--ok)}
.tag .dot.bad{background:var(--bad)}

.ctrls{display:flex;align-items:center;gap:8px}
.ctrls input[type="number"]{
  width:120px;background:#0b0b0b;color:var(--text);border:1px solid var(--border);border-radius:8px;
  padding:6px 8px;font-family:inherit
}
.btn{
  cursor:pointer;border-radius:10px;border:1px solid var(--border);background:#101010;color:var(--text);padding:6px 10px;font-weight:700
}
.btn:hover{box-shadow:0 0 8px rgba(214,180,76,.35)}
.btn.red{border-color:#ff6b6b}
.small{font-size:12px;color:var(--muted)}

/* Right box */
.box{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
.box h4{margin:0 0 6px;color:var(--accent);font-size:14px}
.kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px;font-size:13px}
.kv .k{color:var(--muted)}
.sep{border:0;border-top:1px solid rgba(255,255,255,.08);margin:10px 0}

/* Inline log for debugging */
.log{margin-top:12px;border:1px dashed rgba(214,180,76,.4);border-radius:10px;padding:8px;font-size:12px;color:#f0dca0;background:#0b0b0b}
.log b{color:var(--accent)}
.empty{padding:10px;border:1px dashed rgba(255,255,255,.15);border-radius:10px;color:var(--muted);text-align:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="brand">
    <img src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" alt="JMBN">
    <h1>JMBN — Mission Payout Editor</h1>
  </div>

  <!-- Mission header -->
  <div class="head" id="missionHead">
    <div class="title" id="mTitle">Loading…</div>
    <div class="sub">
      <span id="mWhen">—</span> • Member pool = payout × <span class="mono">(100 − effective_org_cut%)</span>
      <span class="badge" id="mCutSrc">—</span>
    </div>
  </div>

  <section class="main">
    <!-- LEFT: roster -->
    <div class="card">
      <h3>Participants</h3>
      <div id="roster"><div class="empty">Loading roster…</div></div>
      <div class="small">Tip: override is a +/− aUEC amount added after base share. Use 0 to clear.</div>
      <div class="log" id="log" hidden></div>
    </div>

    <!-- RIGHT: facts -->
    <div class="box">
      <h4>Mission Facts</h4>
      <div class="kv">
        <div class="k">Payout</div><div class="v mono" id="fPay">—</div>
        <div class="k">Org cut %</div><div class="v mono" id="fCutPct">—</div>
        <div class="k">Org cut value</div><div class="v mono" id="fCutVal">—</div>
        <div class="k">Pool after cut</div><div class="v mono" id="fPool">—</div>
        <div class="k">Total weight</div><div class="v mono" id="fTWeight">—</div>
      </div>
      <hr class="sep">
      <h4>Notes</h4>
      <div class="small">Names from <code>v_profiles_detailed</code>. Overrides in <code>mission_user_overrides</code> (PK: <code>mission_id,user_id</code>).</div>
    </div>
  </section>
</div>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
(function(){
  const $ = s => document.querySelector(s);
  const fmt0 = n => (n===null||n===undefined||isNaN(n))?'—':Number(n).toLocaleString('en-US',{maximumFractionDigits:0});
  const fmt2 = n => (n===null||n===undefined||isNaN(n))?'—':Number(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
  const pct = n => (n===null||n===undefined||isNaN(n))?'—':(Number(n)*100).toFixed(1)+'%';
  const dateNice = iso => iso ? new Date(iso).toLocaleString() : '—';
  const log = (msg) => { const el = $('#log'); el.hidden = false; el.innerHTML += `<div>${msg}</div>`; };

  let sb, me, missionId;
  let cutPct = 0, payout = 0, pool = 0;
  let roster = [];               // [{user_id, weight, attending, rank_abbrev?}]
  const nameMap = new Map();     // user_id -> {label, rank}
  let overrides = new Map();     // user_id -> amount

  async function boot(){
    try{
      const session = await requireAuth(); if(!session) return;
      sb = getSupabase(); me = session.user.id;

      missionId = new URL(location.href).searchParams.get('id');
      if(!missionId){ alert('No mission id in URL (use ?id=...)'); return; }

      await loadMission();
      await loadRoster();          // tries view; then table; then v_missions_payout_live
      await loadOverrides();
      await loadNamesFor(roster.map(r=>r.user_id));

      renderFacts();
      renderRoster();
    }catch(e){
      log(`<b>boot</b>: ${e.message}`);
      console.warn(e);
      $('#roster').innerHTML = `<div class="empty">Failed to initialize.</div>`;
    }
  }

  /* -------- Mission -------- */
  async function loadMission(){
    try{
      const { data: m, error: em } = await sb
        .from('missions')
        .select('id,title,payout_auec,created_at')
        .eq('id', missionId)
        .maybeSingle();
      if(em) log(`<b>missions</b>: ${em.message}`);
      payout = Number(m?.payout_auec ?? 0);
      $('#mTitle').textContent = m?.title || 'Untitled mission';
      $('#mWhen').textContent  = dateNice(m?.created_at);

      const { data: cut, error: ec } = await sb
        .from('v_mission_org_cut_effective')
        .select('org_cut_pct, org_cut_source')
        .eq('mission_id', missionId)
        .maybeSingle();
      if(ec) log(`<b>v_mission_org_cut_effective</b>: ${ec.message}`);
      cutPct = Number(cut?.org_cut_pct ?? 0);
      $('#mCutSrc').textContent = cut?.org_cut_source || 'default';

      pool = payout * (1 - (isNaN(cutPct)?0:cutPct));
    }catch(e){
      log(`<b>loadMission</b>: ${e.message}`);
    }
  }

  /* -------- Roster & weight -------- */
  async function loadRoster(){
    // 1) Preferred: v_mission_roster_live
    try{
      const { data, error } = await sb
        .from('v_mission_roster_live')
        .select('user_id, weight, attending, rank_abbrev')
        .eq('mission_id', missionId)
        .order('weight', {ascending:false});
      if(error) throw error;
      if(data && data.length){
        roster = data.map(x => ({
          user_id: x.user_id,
          weight: Number(x.weight ?? 0),
          attending: coerceBool(x.attending),
          rank_abbrev: x.rank_abbrev || null
        }));
        return;
      }
    }catch(e){
      log(`<b>v_mission_roster_live</b>: ${e.message}`);
    }

    // 2) Fallback: mission_participants
    try{
      const { data, error } = await sb
        .from('mission_participants')
        .select('user_id, weight, attending')
        .eq('mission_id', missionId);
      if(error) throw error;
      if(data && data.length){
        roster = data.map(x => ({
          user_id: x.user_id,
          weight: Number(x.weight ?? 0),
          attending: coerceBool(x.attending),
          rank_abbrev: null
        }));
        return;
      }
    }catch(e){
      log(`<b>mission_participants</b>: ${e.message}`);
    }

    // 3) Last resort: v_missions_payout_live
    try{
      const { data, error } = await sb
        .from('v_missions_payout_live')
        .select('user_id, weight, mission_id')
        .eq('mission_id', missionId);
      if(error) throw error;
      if(data && data.length){
        roster = data.map(x => ({
          user_id: x.user_id,
          weight: Number(x.weight ?? 0),
          attending: true,
          rank_abbrev: null
        }));
        return;
      }
    }catch(e){
      log(`<b>v_missions_payout_live</b>: ${e.message}`);
    }

    roster = [];
  }

  /* -------- Overrides -------- */
  async function loadOverrides(){
    try{
      const { data, error } = await sb
        .from('mission_user_overrides')
        .select('user_id, amount')
        .eq('mission_id', missionId);
      if(error) throw error;
      overrides = new Map((data||[]).map(o => [o.user_id, Number(o.amount ?? 0)]));
    }catch(e){
      log(`<b>mission_user_overrides</b>: ${e.message}`);
      overrides = new Map();
    }
  }

  /* -------- Names -------- */
  async function loadNamesFor(userIds){
    const ids = Array.from(new Set((userIds||[]).filter(Boolean)));
    if(!ids.length) return;
    try{
      const { data, error } = await sb
        .from('v_profiles_detailed')
        .select('user_id, handle, display_name, current_rank_abbrev')
        .in('user_id', ids);
      if(error) throw error;
      for(const p of (data||[])){
        const label = (p.display_name && p.display_name.trim())
                    || (p.handle && p.handle.trim())
                    || (p.user_id ? String(p.user_id).slice(0,8) : '—');
        nameMap.set(p.user_id, { label, rank: p.current_rank_abbrev || null });
      }
    }catch(e){
      log(`<b>v_profiles_detailed</b>: ${e.message}`);
    }
  }
  const labelOf = (uid) => nameMap.get(uid)?.label || (uid ? String(uid).slice(0,8) : '—');
  const rankOf  = (uid) => nameMap.get(uid)?.rank || roster.find(r=>r.user_id===uid)?.rank_abbrev || '';

  const coerceBool = (v) => {
    if (typeof v === 'boolean') return v;
    if (v === null || v === undefined) return false;
    if (typeof v === 'number') return v !== 0;
    if (typeof v === 'string') return ['t','true','1','y','yes'].includes(v.toLowerCase());
    return false;
  };

  /* -------- Rendering -------- */
  function renderFacts(){
    const tWeight = roster.reduce((a,b)=>a + (Number(b.weight||0)||0), 0);
    $('#fPay').textContent    = fmt0(payout);
    $('#fCutPct').textContent = pct(cutPct);
    $('#fCutVal').textContent = fmt0(payout*(isNaN(cutPct)?0:cutPct));
    $('#fPool').textContent   = fmt0(pool);
    $('#fTWeight').textContent= fmt2(tWeight);
  }

  function renderRoster(){
    if(!roster.length){
      $('#roster').innerHTML = `<div class="empty">No participants found for this mission.</div>`;
      return;
    }
    const tWeight = roster.reduce((a,b)=>a + (Number(b.weight||0)||0), 0) || 1;
    const html = roster.map(r=>{
      const uid = r.user_id;
      const defPct = (Number(r.weight||0)/tWeight)*100;
      const ov = overrides.get(uid) || 0;
      const ovActive = Math.abs(ov) > 0.0001;
      return `
      <div class="member" data-uid="${uid}">
        <div>
          <div class="name">${labelOf(uid)}</div>
          <div class="meta">
            ${r.attending ? `Attending` : `Absent`} • ${rankOf(uid) ? `${rankOf(uid)} • `:''}
            <span class="mono">w:${fmt2(r.weight||0)}</span> •
            Weighted default: <span class="mono">${isFinite(defPct)?defPct.toFixed(1):'—'}%</span> •
            Pool(after cut): <span class="mono">${fmt0(pool)}</span>
            ${ovActive ? `<span class="badge tag"><span class="dot ok"></span>override active</span>` : ``}
          </div>
        </div>
        <div class="ctrls">
          <button class="btn minus" title="-1000">−</button>
          <input type="number" step="100" inputmode="numeric" placeholder="override aUEC" value="${Number.isFinite(ov)?ov:0}">
          <button class="btn plus" title="+1000">+</button>
          <button class="btn" data-act="save">Save</button>
          <button class="btn red" data-act="clear">Clear</button>
        </div>
      </div>`;
    }).join('');
    $('#roster').innerHTML = html;

    // Bind per-row controls
    document.querySelectorAll('.member').forEach(box=>{
      const uid = box.dataset.uid;
      const input = box.querySelector('input[type="number"]');
      const toNum = () => Number(input.value||0) || 0;

      box.querySelector('.minus').addEventListener('click', ()=>{ input.value = String(toNum() - 1000); });
      box.querySelector('.plus').addEventListener('click',  ()=>{ input.value = String(toNum() + 1000); });

      box.querySelector('[data-act="save"]').addEventListener('click', async ()=>{
        await saveOverride(uid, toNum());
      });
      box.querySelector('[data-act="clear"]').addEventListener('click', async ()=>{
        await saveOverride(uid, 0);
      });
    });
  }

  /* -------- Mutations -------- */
  async function saveOverride(userId, amount){
    try{
      if(!userId){ throw new Error('No userId'); }
      if(Number(amount) === 0){
        const { error } = await sb.from('mission_user_overrides')
          .delete()
          .eq('mission_id', missionId)
          .eq('user_id', userId);
        if(error) throw error;
        overrides.set(userId, 0);
      }else{
        const { error } = await sb.from('mission_user_overrides').upsert({
          mission_id: missionId,
          user_id: userId,
          amount: Number(amount)
        }, { onConflict: 'mission_id,user_id' });
        if(error) throw error;
        overrides.set(userId, Number(amount));
      }
      renderRoster();
    }catch(e){
      log(`<b>saveOverride</b>: ${e.message}`);
      alert('Failed to save override: '+e.message);
    }
  }

  boot();
})();
</script>
</body>
</html>