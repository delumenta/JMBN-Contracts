<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JMBN – Components HoloTable</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#000;
      --bg-panel:rgba(5,5,8,.9);
      --bg-sub:rgba(10,10,14,.9);

      --gold:#d6b44c;
      --gold-soft:rgba(214,180,76,.65);
      --gold-faint:rgba(214,180,76,.25);

      --accent:#f2d675;
      --text:#f7f1d0;
      --muted:rgba(201,176,106,.8);

      --holo-accent:#7dd9ff; /* light cyan, used sparingly */

      --radius:14px;
      --fs-base:14px;
      --fs-sm:12px;
      --fs-lg:16px;
    }

    *{box-sizing:border-box;margin:0;padding:0}

    html,body{
      height:100%;
      background:radial-gradient(circle at top,#211707 0,#000 55%);
      color:var(--text);
      font-family:'Play',sans-serif;
      overflow:hidden;
    }

    body{
      display:flex;
      flex-direction:column;
    }

    /* Header from header.html */
    #site-header{
      flex:0 0 auto;
      padding:10px 12px 0;
    }

    /* Main 3-panel layout */
    #layout{
      flex:1 1 auto;
      display:grid;
      grid-template-columns:28% 42% 30%;
      grid-template-rows:100%;
      min-height:0;
      border-top:1px solid var(--gold-faint);
    }

    /* ===== LEFT: HOLO MAP ===== */
    #holo-map-container{
      background:linear-gradient(160deg,#050507,#08080c);
      border-right:1px solid var(--gold-faint);
      box-shadow:inset 0 0 22px rgba(0,0,0,.9);
      padding:12px;
      position:relative;
      overflow:hidden;
    }

    #holo-map-title{
      text-align:center;
      letter-spacing:.14em;
      font-size:var(--fs-sm);
      text-transform:uppercase;
      color:var(--accent);
      margin-bottom:6px;
    }

    #holo-map{
      width:100%;
      height:100%;
      filter:drop-shadow(0 0 12px rgba(214,180,76,.25));
    }

    .map-ring{
      stroke:rgba(214,180,76,.22);
      stroke-width:.8;
      stroke-dasharray:3 2;
      fill:none;
    }

    .map-node{
      fill:var(--bg);
      stroke:var(--gold);
      stroke-width:1.5;
      r:5;
      cursor:pointer;
      transition:.18s;
    }
    .map-node:hover{
      fill:var(--gold);
      stroke:var(--accent);
      r:7;
    }

    .map-node-label{
      font-size:8px;
      fill:var(--muted);
    }

    .holo-path{
      stroke:var(--accent);
      stroke-width:2;
      fill:none;
      stroke-linecap:round;
      stroke-linejoin:round;
      filter:drop-shadow(0 0 6px rgba(214,180,76,.5));
      animation:pathGlow 3s ease-in-out infinite alternate;
    }
    @keyframes pathGlow{
      0%{stroke-opacity:.35;}
      100%{stroke-opacity:1;}
    }

    /* ===== CENTRE: COMPONENT CARDS ===== */
    #components-panel{
      background:radial-gradient(circle at top,#1a1306 0,#050505 65%);
      border-right:1px solid var(--gold-faint);
      padding:12px;
      overflow-y:auto;
    }

    #filters{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:8px;
      margin-bottom:10px;
    }

    .filter-input,
    .filter-select{
      background:rgba(10,8,4,.9);
      border-radius:999px;
      border:1px solid var(--gold-faint);
      padding:6px 10px;
      color:var(--text);
      font-size:var(--fs-base);
      outline:none;
      transition:border-color .15s,box-shadow .15s,background .15s;
    }
    .filter-input::placeholder{color:rgba(247,241,208,.5);}
    .filter-input:focus,
    .filter-select:focus{
      border-color:var(--accent);
      box-shadow:0 0 8px rgba(242,214,117,.45);
      background:#161008;
    }

    #cards-render{
      margin-top:4px;
    }

    .holo-card{
      background:radial-gradient(circle at top,#20180a 0,#070707 65%);
      border-radius:var(--radius);
      border:1px solid var(--gold-faint);
      padding:10px 11px 9px;
      margin-bottom:8px;
      position:relative;
      overflow:hidden;
      backdrop-filter:blur(4px);
      transition:transform .16s, box-shadow .16s, border-color .16s;
    }
    .holo-card:hover{
      transform:translateY(-2px);
      border-color:var(--gold-soft);
      box-shadow:0 0 18px rgba(214,180,76,.35);
    }

    .holo-card::after{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at 0 0,rgba(214,180,76,.18) 0,transparent 60%);
      opacity:0;
      pointer-events:none;
      animation:holoSweep 7s infinite linear;
      mix-blend-mode:screen;
    }
    @keyframes holoSweep{
      0%{transform:translate(-40%, -40%);opacity:0;}
      20%{opacity:.6;}
      40%{transform:translate(60%, 60%);opacity:0;}
      100%{opacity:0;}
    }

    .card-name{
      font-size:var(--fs-lg);
      color:var(--accent);
      letter-spacing:.08em;
      text-transform:uppercase;
      margin-bottom:2px;
    }
    .card-meta{
      font-size:var(--fs-sm);
      color:var(--muted);
      margin-bottom:4px;
    }
    .card-line{
      font-size:var(--fs-sm);
      color:var(--text);
    }

    .add-route-btn{
      margin-top:6px;
      font-size:var(--fs-sm);
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--gold-soft);
      background:rgba(214,180,76,.16);
      color:var(--accent);
      cursor:pointer;
      transition:background .15s, box-shadow .15s, transform .1s;
    }
    .add-route-btn:hover{
      background:rgba(214,180,76,.3);
      box-shadow:0 0 10px rgba(214,180,76,.5);
      transform:translateY(-1px);
    }

    /* ===== RIGHT: ROUTE PLANNER ===== */
    #route-panel{
      background:radial-gradient(circle at top,#231a09 0,#050505 65%);
      padding:12px;
      overflow-y:auto;
    }

    #route-title{
      text-align:center;
      font-size:var(--fs-lg);
      letter-spacing:.14em;
      text-transform:uppercase;
      color:var(--accent);
      margin-bottom:8px;
    }

    #selected-items{
      min-height:52px;
      border-radius:var(--radius);
      border:1px solid var(--gold-faint);
      padding:8px;
      background:rgba(9,7,3,.9);
      font-size:var(--fs-sm);
      margin-bottom:10px;
    }

    #selected-items .tag{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--gold-soft);
      margin:1px 4px 3px 0;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.08em;
    }
    .tag-remove{
      cursor:pointer;
      color:var(--muted);
    }

    #generate-route-btn{
      width:100%;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--gold-soft);
      background:rgba(214,180,76,.2);
      color:var(--accent);
      font-size:var(--fs-base);
      letter-spacing:.12em;
      text-transform:uppercase;
      cursor:pointer;
      transition:background .16s, box-shadow .16s, transform .1s;
    }
    #generate-route-btn:hover{
      background:rgba(214,180,76,.32);
      box-shadow:0 0 16px rgba(214,180,76,.5);
      transform:translateY(-1px);
    }

    #route-output{
      margin-top:12px;
      border-radius:var(--radius);
      border:1px solid var(--gold-faint);
      background:rgba(12,9,5,.92);
      padding:10px;
      font-size:var(--fs-sm);
    }

    .route-stop{
      margin-top:8px;
      padding:7px 8px;
      border-radius:var(--radius);
      border:1px solid var(--gold-soft);
      background:rgba(18,13,7,.96);
    }

    .route-stop-title{
      font-size:var(--fs-base);
      color:var(--accent);
    }
    .route-stop-items{
      margin-top:4px;
      color:var(--text);
    }

    .route-meta{
      font-size:var(--fs-sm);
      color:var(--muted);
      margin-bottom:4px;
    }

    @media (max-width:1100px){
      #layout{
        grid-template-columns:1fr;
        grid-template-rows:36% 64% auto;
      }
      #holo-map-container{border-right:none;border-bottom:1px solid var(--gold-faint);}
      #components-panel{border-right:none;border-bottom:1px solid var(--gold-faint);}
    }
  </style>
</head>
<body>
  <!-- shared JMBN header -->
  <header id="site-header"></header>

  <div id="layout">
    <!-- LEFT: MAP -->
    <aside id="holo-map-container">
      <div id="holo-map-title">STANTON SYSTEM – TRADE ROUTE OVERLAY</div>
      <svg id="holo-map" viewBox="-200 -200 400 400">
        <!-- rings -->
        <circle class="map-ring" cx="0" cy="0" r="40"></circle>
        <circle class="map-ring" cx="0" cy="0" r="80"></circle>
        <circle class="map-ring" cx="0" cy="0" r="130"></circle>

        <g id="map-paths"></g>
        <g id="map-nodes"></g>
      </svg>
    </aside>

    <!-- MIDDLE: COMPONENTS -->
    <main id="components-panel">
      <div id="filters">
        <input id="searchInput" class="filter-input" type="text" placeholder="Name or manufacturer…">
        <select id="filterComponent" class="filter-select">
          <option value="">All Components</option>
        </select>
        <select id="filterClass" class="filter-select">
          <option value="">All Classes</option>
        </select>
        <select id="filterSize" class="filter-select">
          <option value="">All Sizes</option>
        </select>
        <div></div><!-- 4th cell used above; this balances layout on some widths -->
      </div>

      <div id="cards-render"></div>
    </main>

    <!-- RIGHT: ROUTE PLANNER -->
    <section id="route-panel">
      <div id="route-title">ROUTE PLANNER</div>
      <div id="selected-items"></div>
      <button id="generate-route-btn">Generate Best Route</button>
      <div id="route-output"></div>
    </section>
  </div>

  <script>
    // === inject shared header ===
    fetch('header.html')
      .then(r => r.ok ? r.text() : '')
      .then(html => { document.getElementById('site-header').innerHTML = html; })
      .catch(() => {});

    // === DOM references (avoid relying on global IDs) ===
    const searchInput      = document.getElementById('searchInput');
    const filterComponent  = document.getElementById('filterComponent');
    const filterClass      = document.getElementById('filterClass');
    const filterSize       = document.getElementById('filterSize');
    const cardsRender      = document.getElementById('cards-render');
    const selectedBox      = document.getElementById('selected-items');
    const routeOutput      = document.getElementById('route-output');
    const generateBtn      = document.getElementById('generate-route-btn');
    const mapNodesGroup    = document.getElementById('map-nodes');
    const mapPathsGroup    = document.getElementById('map-paths');

    const DATA_COMPONENTS = 'data/components.js';
    const DATA_SHOPS      = 'data/shops.json';           // not heavily used yet, but wired for future
    const DATA_SHOP_INV   = 'data/shop_inventory.json';  // optional

    let allComponents = [];
    let selectedItems = new Set();

    // Stanton-ish coordinates (stylised)
    const mapCoords = {
      'Area18':       {x:  40, y:   0},
      'Bajini Point': {x:  80, y:  10},
      'Seraphin':     {x:  65, y: -25},
      'Everus Harbor':{x:  55, y:  40},
      'Port Tressler':{x: -30, y:-110},
      'Lorville':     {x: -20, y:  60},
      'GrimHex':      {x: -85, y: -25},
      'New Babbage':  {x: -50, y:-135},
      'Orison':       {x:  60, y: 120}
    };

    const travelCost = {
      'Area18': 0,
      'Bajini Point': 1,
      'Seraphin': 1,
      'Everus Harbor': 1,
      'Port Tressler': 2,
      'Lorville': 3,
      'GrimHex': 3,
      'New Babbage': 6, // avoid-ish
      'Orison': 8       // hard avoid
    };

    function routeLocationFromShopString(shopStr){
      if(!shopStr) return null;
      const s = shopStr.toLowerCase();
      if(s.includes('area 18') || s.includes('area18')) return 'Area18';
      if(s.includes('bajini')) return 'Bajini Point';
      if(s.includes('baijini')) return 'Bajini Point';
      if(s.includes('seraph')) return 'Seraphin';
      if(s.includes('everus')) return 'Everus Harbor';
      if(s.includes('tressler')) return 'Port Tressler';
      if(s.includes('lorville')) return 'Lorville';
      if(s.includes('grimhex')) return 'GrimHex';
      if(s.includes('new babbage') || s.includes('new_babbage')) return 'New Babbage';
      if(s.includes('orison')) return 'Orison';
      // generic R&Rs – very rough pass
      if(s.includes('arcl1')) return 'Bajini Point';
      if(s.includes('crul1') || s.includes('cru-l1')) return 'Everus Harbor';
      if(s.includes('hurl1') || s.includes('hur-l1') || s.includes('hur-l2')) return 'Lorville';
      return null;
    }

    // ==== INITIAL LOAD ====
    Promise.all([
      fetch(DATA_COMPONENTS).then(r=>r.json()),
      fetch(DATA_SHOPS).then(r=>r.ok?r.json():[]).catch(()=>[]),
      fetch(DATA_SHOP_INV).then(r=>r.ok?r.json():[]).catch(()=>[])
    ]).then(([components])=>{
      allComponents = Array.isArray(components)?components:[];
      buildFilters();
      renderCards(allComponents);
      renderMapNodes();
    }).catch(err=>{
      console.error('Failed to load data', err);
      cardsRender.innerHTML = '<div style="padding:16px;color:#ff6b6b;">Failed to load components data.</div>';
    });

    // ==== FILTERS ====
    function buildFilters(){
      const compSet = new Set();
      const classSet = new Set();
      const sizeSet = new Set();

      allComponents.forEach(c=>{
        if(c.Component) compSet.add(c.Component);
        if(c.Class)     classSet.add(c.Class);
        if(c.Size)      sizeSet.add(String(c.Size));
      });

      const addOpts = (set, select)=>{
        Array.from(set).sort().forEach(v=>{
          const opt=document.createElement('option');
          opt.value=v;
          opt.textContent=v;
          select.appendChild(opt);
        });
      };
      addOpts(compSet,  filterComponent);
      addOpts(classSet, filterClass);
      addOpts(sizeSet,  filterSize);

      searchInput.addEventListener('input', applyFilters);
      filterComponent.addEventListener('change', applyFilters);
      filterClass.addEventListener('change', applyFilters);
      filterSize.addEventListener('change', applyFilters);
    }

    function applyFilters(){
      const q   = searchInput.value.trim().toLowerCase();
      const fc  = filterComponent.value;
      const fcl = filterClass.value;
      const fs  = filterSize.value;

      const list = allComponents.filter(c=>{
        if(fc && c.Component !== fc) return false;
        if(fcl && c.Class !== fcl)   return false;
        if(fs && String(c.Size) !== fs) return false;

        if(q){
          const hay = [
            c.Names,
            c.Manufacturer,
            c.Component,
            c.Class
          ].map(v=>String(v||'').toLowerCase()).join(' ');
          if(!hay.includes(q)) return false;
        }
        return true;
      });

      renderCards(list);
    }

    // ==== CARDS ====
    function renderCards(list){
      if(!list.length){
        cardsRender.innerHTML = '<div style="padding:12px;color:var(--muted);font-size:var(--fs-sm);">No components match your filters.</div>';
        return;
      }
      let html='';
      for(const c of list){
        const medal = `S${c.Size?.toString().replace(/^S/i,'') || ''} • Grade ${c.Grade ?? ''} • ${c.Class || ''}`;
        const shopStr = Array.isArray(c.Shops) && c.Shops.length
          ? c.Shops.join(', ')
          : (c.WhereToBuy || '');
        html += `
          <article class="holo-card">
            <div class="card-name">${c.Names || ''}</div>
            <div class="card-meta">${c.Component || ''}</div>
            <div class="card-line" style="color:var(--muted);">${medal}</div>
            <div class="card-line" style="margin-top:3px;font-size:var(--fs-sm);">
              <span style="color:var(--muted);">Manufacturer:</span> ${c.Manufacturer || ''}
            </div>
            <div class="card-line" style="margin-top:3px;font-size:var(--fs-sm);">
              <span style="color:var(--muted);">Shops:</span> ${shopStr || '<span style="color:#777;">—</span>'}
            </div>
            <button class="add-route-btn" onclick="addToRoute('${(c.Names || '').replace(/'/g, "\\'")}')">
              Add to route
            </button>
          </article>
        `;
      }
      cardsRender.innerHTML = html;
    }

    // ==== ROUTE PLANNER ====
    window.addToRoute = function(name){
      selectedItems.add(name);
      renderSelectedItems();
    };

    function removeFromRoute(name){
      selectedItems.delete(name);
      renderSelectedItems();
    }

    function renderSelectedItems(){
      if(!selectedItems.size){
        selectedBox.innerHTML = '<span style="color:var(--muted);font-size:var(--fs-sm);">No components selected. Click “Add to route” on any card.</span>';
        return;
      }
      selectedBox.innerHTML = [...selectedItems].map(n=>`
        <span class="tag">
          ${n}
          <span class="tag-remove" onclick="removeFromRoute('${n.replace(/'/g,"\\'")}')">✕</span>
        </span>
      `).join('');
    }

    generateBtn.addEventListener('click',()=>{
      if(!selectedItems.size){
        alert('Select at least one component.');
        return;
      }
      const wanted = [...selectedItems];
      const route  = computeBestRoute(wanted);
      renderRoute(route, wanted);
      drawRouteOnMap(route);
    });

    function computeBestRoute(wanted){
      // Build location -> items mapping from Shops / WhereToBuy text
      const locMap = {};
      for(const c of allComponents){
        if(!wanted.includes(c.Names)) continue;
        let shopList = [];
        if(Array.isArray(c.Shops) && c.Shops.length){
          shopList = c.Shops;
        }else if(c.WhereToBuy){
          shopList = c.WhereToBuy.split(';').map(s=>s.trim()).filter(Boolean);
        }
        for(const s of shopList){
          const loc = routeLocationFromShopString(s);
          if(!loc) continue;
          if(!locMap[loc]) locMap[loc] = new Set();
          locMap[loc].add(c.Names);
        }
      }

      const locs = Object.keys(locMap);
      if(!locs.length){
        return ['Area18']; // fallback
      }

      const coversAll = (set)=>wanted.every(w=>set.has(w));

      // try single-stop
      for(const loc of locs){
        if(coversAll(locMap[loc])) return [loc];
      }

      // try 2-stop
      let best2=null;
      for(let i=0;i<locs.length;i++){
        for(let j=i+1;j<locs.length;j++){
          const s = new Set([...locMap[locs[i]], ...locMap[locs[j]]]);
          if(coversAll(s)){
            const r=[locs[i],locs[j]];
            const cost = routeCost(r);
            if(!best2 || cost<best2.cost) best2={route:r,cost};
          }
        }
      }
      if(best2) return best2.route;

      // try 3-stop
      let best3=null;
      for(let i=0;i<locs.length;i++){
        for(let j=i+1;j<locs.length;j++){
          for(let k=j+1;k<locs.length;k++){
            const s = new Set([...locMap[locs[i]], ...locMap[locs[j]], ...locMap[locs[k]]]);
            if(coversAll(s)){
              const r=[locs[i],locs[j],locs[k]];
              const cost = routeCost(r);
              if(!best3 || cost<best3.cost) best3={route:r,cost};
            }
          }
        }
      }
      if(best3) return best3.route;

      // greedy fallback – not perfect but usable
      const remaining = new Set(wanted);
      const chosen=[];
      while(remaining.size){
        let bestLoc=null;
        let bestGain=0;
        for(const loc of locs){
          let gain=0;
          for(const item of locMap[loc]){
            if(remaining.has(item)) gain++;
          }
          if(gain>bestGain){
            bestGain=gain;
            bestLoc=loc;
          }
        }
        if(!bestLoc) break;
        chosen.push(bestLoc);
        for(const item of locMap[bestLoc]) remaining.delete(item);
      }
      return chosen.length ? chosen : ['Area18'];
    }

    function routeCost(route){
      return route.reduce((sum,loc)=>sum+(travelCost[loc] ?? 4),0);
    }

    function renderRoute(route, wanted){
      if(!route || !route.length){
        routeOutput.innerHTML = '<div class="route-meta">No valid route could be computed from current data.</div>';
        return;
      }
      let html = `<div class="route-meta">Optimal route with <strong>${route.length}</strong> stop(s).</div>`;
      route.forEach((loc,idx)=>{
        const itemsHere = allComponents
          .filter(c=>wanted.includes(c.Names))
          .filter(c=>{
            let shopList=[];
            if(Array.isArray(c.Shops)&&c.Shops.length) shopList=c.Shops;
            else if(c.WhereToBuy) shopList=c.WhereToBuy.split(';').map(s=>s.trim());
            return shopList.some(s=>routeLocationFromShopString(s)===loc);
          })
          .map(c=>c.Names);
        html += `
          <div class="route-stop">
            <div class="route-stop-title">${idx+1}. ${loc}</div>
            <div class="route-stop-items">${itemsHere.length?itemsHere.join(', '):'<span style="color:var(--muted);">No items mapped here (data may be incomplete).</span>'}</div>
          </div>
        `;
      });
      routeOutput.innerHTML = html;
    }

    // ==== MAP RENDERING ====
    function renderMapNodes(){
      let html='';
      for(const [name,coord] of Object.entries(mapCoords)){
        html += `
          <g>
            <circle class="map-node" cx="${coord.x}" cy="${coord.y}" r="5"></circle>
            <text class="map-node-label" x="${coord.x+8}" y="${coord.y+3}">${name}</text>
          </g>
        `;
      }
      mapNodesGroup.innerHTML = html;
    }

    function drawRouteOnMap(route){
      mapPathsGroup.innerHTML='';
      if(!route || route.length<2) return;
      let html='';
      for(let i=0;i<route.length-1;i++){
        const a = mapCoords[route[i]];
        const b = mapCoords[route[i+1]];
        if(!a||!b) continue;
        html += `<line class="holo-path" x1="${a.x}" y1="${a.y}" x2="${b.x}" y2="${b.y}"></line>`;
      }
      mapPathsGroup.innerHTML = html;
    }
  </script>
</body>
</html>
