<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JMBN — Mission Payout Editor</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--card:#0c0c0c;--row:#0a0a0a;
  --border:#d6b44c;--accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;--ok:#7CFC9A;
  --fs:14px
}
*{box-sizing:border-box}
html,body{margin:0;background:#000;color:var(--text);font-family:'Play',system-ui,sans-serif;font-size:var(--fs);letter-spacing:.25px}
.wrap{max-width:1180px;margin:22px auto;padding:0 14px}
.brand{display:flex;align-items:center;gap:10px;margin:0 0 14px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.brand img{width:44px;height:44px;object-fit:contain}
.brand h1{margin:0;color:var(--accent);font-size:clamp(18px,2.6vw,24px)}

.head{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:0 0 18px rgba(214,180,76,.18);margin-bottom:12px}
.head .title{font-weight:800;font-size:16px}
.head .sub{font-size:12px;color:var(--muted);margin-top:2px}
.badge{border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:11px;background:#0c0c0c;color:var(--muted)}
.mono{font-variant-numeric:tabular-nums}

.main{display:grid;grid-template-columns:1fr 360px;gap:14px}
@media(max-width:1080px){.main{grid-template-columns:1fr}}

.card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:0 0 18px rgba(214,180,76,.18)}
.card h3{margin:0 0 8px;color:var(--accent);font-size:16px}

.member{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px;margin:10px 0;display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center}
.member:hover{box-shadow:0 0 10px rgba(214,180,76,.25)}
.name{font-weight:800}
.meta{font-size:12px;color:var(--muted)}
.tag{display:inline-flex;align-items:center;gap:6px}
.tag .dot{width:8px;height:8px;border-radius:50%}
.tag .dot.ok{background:var(--ok)}
.ctrls{display:flex;align-items:center;gap:8px}
.ctrls input[type="number"]{width:120px;background:#0b0b0b;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:6px 8px;font-family:inherit}
.btn{cursor:pointer;border-radius:10px;border:1px solid var(--border);background:#101010;color:var(--text);padding:6px 10px;font-weight:700}
.btn:hover{box-shadow:0 0 8px rgba(214,180,76,.35)}
.btn.red{border-color:#ff6b6b}
.small{font-size:12px;color:var(--muted)}
.box{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px}
.box h4{margin:0 0 6px;color:var(--accent);font-size:14px}
.kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px;font-size:13px}
.kv .k{color:var(--muted)}
.sep{border:0;border-top:1px solid rgba(255,255,255,.08);margin:10px 0}
.empty{padding:10px;border:1px dashed rgba(255,255,255,.15);border-radius:10px;color:var(--muted);text-align:center}
.log{margin-top:12px;border:1px dashed rgba(214,180,76,.4);border-radius:10px;padding:8px;font-size:12px;color:#f0dca0;background:#0b0b0b}
.log b{color:var(--accent)}
</style>
</head>
<body>
<div class="wrap">
  <div class="brand">
    <img src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" alt="JMBN">
    <h1>JMBN — Mission Payout Editor</h1>
  </div>

  <div class="head">
    <div class="title" id="mTitle">Loading…</div>
    <div class="sub">
      <span id="mWhen">—</span> • Member pool = payout × <span class="mono">(100 − effective_org_cut%)</span>
      <span class="badge" id="mCutSrc">—</span>
    </div>
  </div>

  <section class="main">
    <div class="card">
      <h3>Participants</h3>
      <div id="roster"><div class="empty">Loading roster…</div></div>
      <div class="small">Override is a +/− aUEC amount added after base share. Use 0 to clear.</div>
      <div class="log" id="log" hidden></div>
    </div>

    <div class="box">
      <h4>Mission Facts</h4>
      <div class="kv">
        <div class="k">Payout</div><div class="v mono" id="fPay">—</div>
        <div class="k">Org cut %</div><div class="v mono" id="fCutPct">—</div>
        <div class="k">Org cut value</div><div class="v mono" id="fCutVal">—</div>
        <div class="k">Pool after cut</div><div class="v mono" id="fPool">—</div>
        <div class="k">Total weight</div><div class="v mono" id="fTWeight">—</div>
      </div>
      <hr class="sep">
      <h4>Notes</h4>
      <div class="small">Reads <code>v_missions_payout_live</code>. Writes <code>mission_user_overrides</code>. Names from <code>v_profiles_detailed</code>.</div>
    </div>
  </section>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
(function(){
  const $ = s => document.querySelector(s);
  const fmt0 = n => (n==null || isNaN(n)) ? '—' : Number(n).toLocaleString('en-US',{maximumFractionDigits:0});
  const fmt2 = n => (n==null || isNaN(n)) ? '—' : Number(n).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
  const pct  = n => (n==null || isNaN(n)) ? '—' : (Number(n)*100).toFixed(1)+'%';
  const dateNice = iso => iso ? new Date(iso).toLocaleString() : '—';
  const log = (m)=>{ const el=$('#log'); el.hidden=false; el.innerHTML+=`<div>${m}</div>`; };

  let sb, missionId;
  let rows = [];                 // rows from v_missions_payout_live for this mission
  const nameMap = new Map();     // user_id -> { label, rank }

  async function boot(){
    try{
      // Auth bootstrap (works with your existing auth.js)
      if (typeof requireAuth === 'function') {
        const session = await requireAuth(); if(!session) return;
        sb = getSupabase();
      } else if (typeof getSupabase === 'function') {
        sb = getSupabase();
      } else {
        log('<b>init</b>: auth.js not found. Please include js/auth.js or inline Supabase init.');
        return;
      }

      missionId = new URL(location.href).searchParams.get('id');
      if(!missionId){ alert('No mission id in URL (use ?id=...)'); return; }

      await fetchPayoutRows();                 // v_missions_payout_live
      await fetchNamesForCurrentRows();        // v_profiles_detailed
      renderAll();
      bindRowButtons();
    }catch(e){
      log(`<b>boot</b>: ${e.message}`);
    }
  }

  async function fetchPayoutRows(){
    try{
      const { data, error } = await sb
        .from('v_missions_payout_live')
        .select('mission_id, mission_date, title, payout_auec, org_cut_pct, org_cut_source, org_cut_value, pool_after_cut, user_id, weight, total_weight, base_share, add_pay_override, final_share')
        .eq('mission_id', missionId)
        .order('weight', { ascending:false });
      if(error) throw error;
      rows = data || [];
    }catch(e){
      log(`<b>select v_missions_payout_live</b>: ${e.message}`);
      rows = [];
    }
  }

  async function fetchNamesForCurrentRows(){
    const ids = Array.from(new Set(rows.map(r=>r.user_id).filter(Boolean)));
    if(!ids.length) return;
    try{
      const { data, error } = await sb
        .from('v_profiles_detailed')
        .select('user_id, handle, display_name, current_rank_abbrev')
        .in('user_id', ids);
      if(error) throw error;
      for(const p of (data||[])){
        const label = (p.display_name && p.display_name.trim())
                    || (p.handle && p.handle.trim())
                    || String(p.user_id).slice(0,8);
        nameMap.set(p.user_id, { label, rank: p.current_rank_abbrev || '' });
      }
    }catch(e){
      log(`<b>select v_profiles_detailed</b>: ${e.message}`);
    }
  }

  function nameOf(uid){ return nameMap.get(uid)?.label || String(uid).slice(0,8); }
  function rankOf(uid){ return nameMap.get(uid)?.rank || ''; }

  function renderAll(){
    if(!rows.length){
      $('#mTitle').textContent = 'Mission not found';
      $('#roster').innerHTML = `<div class="empty">No participants found or you lack access.</div>`;
      return;
    }
    const h = rows[0];
    $('#mTitle').textContent = h.title || 'Untitled mission';
    $('#mWhen').textContent  = dateNice(h.mission_date);
    $('#mCutSrc').textContent= h.org_cut_source || 'default';
    $('#fPay').textContent   = fmt0(h.payout_auec);
    $('#fCutPct').textContent= pct(h.org_cut_pct);
    $('#fCutVal').textContent= fmt0(h.org_cut_value);
    $('#fPool').textContent  = fmt0(h.pool_after_cut);
    const totW = h.total_weight ?? rows.reduce((a,b)=>a+Number(b.weight||0),0);
    $('#fTWeight').textContent = fmt2(totW);

    const safeTotW = (totW && isFinite(totW)) ? totW : 1;
    $('#roster').innerHTML = rows.map(r=>{
      const defPct = (Number(r.weight||0)/safeTotW)*100;
      const ov = Number(r.add_pay_override||0);
      const active = Math.abs(ov) > 0.0001;
      return `
      <div class="member" data-uid="${r.user_id}">
        <div>
          <div class="name">${nameOf(r.user_id)}</div>
          <div class="meta">
            ${rankOf(r.user_id) ? rankOf(r.user_id)+' • ' : ''}
            <span class="mono">w:${fmt2(r.weight||0)}</span> •
            Base: <span class="mono">${fmt0(r.base_share)}</span> •
            Override: <span class="mono">${fmt0(ov)}</span> •
            Final: <span class="mono">${fmt0(r.final_share)}</span>
            ${active ? ` <span class="badge tag"><span class="dot ok"></span>override active</span>` : ``}
          </div>
        </div>
        <div class="ctrls">
          <button class="btn minus" title="-1000">−</button>
          <input type="number" step="100" inputmode="numeric" placeholder="override aUEC" value="${ov}">
          <button class="btn plus" title="+1000">+</button>
          <button class="btn" data-act="save">Save</button>
          <button class="btn red" data-act="clear">Clear</button>
        </div>
      </div>`;
    }).join('');
  }

  function bindRowButtons(){
    document.querySelectorAll('.member').forEach(box=>{
      const uid = box.dataset.uid;
      const input = box.querySelector('input[type="number"]');
      const toNum = () => Number(input.value||0) || 0;

      box.querySelector('.minus')?.addEventListener('click', ()=>{ input.value = String(toNum() - 1000); });
      box.querySelector('.plus')?.addEventListener('click',  ()=>{ input.value = String(toNum() + 1000); });

      box.querySelector('[data-act="save"]')?.addEventListener('click', async ()=>{
        await saveOverride(uid, toNum());
      });
      box.querySelector('[data-act="clear"]')?.addEventListener('click', async ()=>{
        await saveOverride(uid, 0);
      });
    });
  }

  async function saveOverride(userId, amount){
    try{
      if(!userId) throw new Error('no userId');
      if(Number(amount) === 0){
        const { error } = await sb.from('mission_user_overrides')
          .delete()
          .eq('mission_id', missionId)
          .eq('user_id', userId);
        if(error) throw error;
      }else{
        const { error } = await sb.from('mission_user_overrides').upsert({
          mission_id: missionId,
          user_id: userId,
          amount: Number(amount)
        }, { onConflict: 'mission_id,user_id' });
        if(error) throw error;
      }
      // Re-pull computed rows so base/final reflect new override
      await fetchPayoutRows();
      await fetchNamesForCurrentRows();
      renderAll();
      bindRowButtons();
    }catch(e){
      log(`<b>saveOverride</b>: ${e.message}`);
      alert('Failed to save override: '+e.message);
    }
  }

  boot();
})();
</script>
</body>
</html>