<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMBN Components</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png"
      href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png/v1/fill/w_66,h_66,al_c,q_85,usm_0.66_1.00_0.01,enc_auto/0_New_JMBN_Logo_Gold.png">

<style>
:root{
  --bg:#000;--panel:#0b0b0b;--border:#d6b44c;--card:#141414;
  --accent:#f2d675;--text:#f7f1d0;--muted:#c9b06a;--bad:#ff6b6b;
  --fs-base:14px;--fs-small:11px;--fs-table:13px;
  --fs-h1:clamp(18px,2.2vw,22px);--fs-h2:clamp(14px,1.6vw,16px)
}
*{box-sizing:border-box}
body{
  background:
    radial-gradient(1200px 900px at 15% -10%, rgba(242,214,117,.08), transparent 60%),
    radial-gradient(900px 700px at 120% 110%, rgba(214,180,76,.05), transparent 60%),
    #000;
  color:var(--text);
  font-family:'Play',sans-serif;
  margin:0;padding:14px;
  letter-spacing:.25px;
  font-size:var(--fs-base)
}

/* Shiny pill nav (header.html) */
.nav-btn{
  --gold:#f2d675;--gold2:#e7c760;--ring:#d6b44c;
  position:relative;display:inline-flex;align-items:center;justify-content:center;
  padding:7px 14px;border:1px solid var(--ring);border-radius:999px;
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);text-decoration:none;font-weight:700;
  box-shadow:inset 0 0 0 1px rgba(214,180,76,.12);
  transition:transform .15s ease, box-shadow .2s ease, background .2s ease, color .2s ease;
}
.nav-btn:hover{
  transform:translateY(-1px);
  box-shadow:0 0 12px rgba(214,180,76,.25), inset 0 0 0 1px rgba(214,180,76,.18);
  background:linear-gradient(180deg,#1a1a1a,#0a0a0a)
}
.nav-btn.active{
  color:#000;
  background:linear-gradient(180deg,var(--gold),var(--gold2));
  border-color:var(--ring);
  box-shadow:0 0 20px rgba(214,180,76,.45);
}
.nav-btn.active::after{
  content:"";position:absolute;inset:0;
  background:linear-gradient(120deg,rgba(255,255,255,0) 30%,rgba(255,255,255,.3) 50%,rgba(255,255,255,0) 70%);
  border-radius:inherit;
  transform:translateX(-120%);
  animation:shine 2.8s ease-in-out infinite;
  pointer-events:none;
}
@keyframes shine{
  0%{transform:translateX(-120%)}
  35%{transform:translateX(120%)}
  100%{transform:translateX(120%)}
}

/* Layout */
.panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
  padding:12px;
  margin-top:8px;
  box-shadow:0 0 18px rgba(214,180,76,.22)
}
.controls{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-bottom:8px
}
button{
  padding:7px 11px;
  border-radius:10px;
  background:linear-gradient(180deg,#0c0c0c,#060606);
  color:var(--accent);
  border:1px solid var(--border);
  cursor:pointer;
  font-family:'Play';
  transition:.2s
}
button:hover{background:var(--accent);color:#000}
.btn-primary{background:var(--accent);color:#000}
input,select{
  background:#0a0a0a;
  border:1px solid var(--border);
  border-radius:8px;
  padding:9px;
  color:var(--text);
  font-size:var(--fs-table);
  font-family:'Play'
}

/* KPIs */
.kpis{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:8px;
  margin:10px 0
}
.kpi-card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
  text-align:center
}
.kpi-card h3{
  margin:0;
  color:var(--muted);
  font-size:11px;
  text-transform:uppercase
}
.kpi-card .val{
  font-weight:700;
  font-size:18px;
  color:var(--accent);
  margin-top:4px
}
.small{font-size:var(--fs-small);color:var(--muted)}

/* Table */
.tableWrap{
  border:1px solid var(--border);
  border-radius:12px;
  overflow:auto;
  max-height:70vh;
  margin-top:10px
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:var(--fs-table)
}
th,td{
  border-bottom:1px solid rgba(214,180,76,.3);
  padding:8px;
  text-align:left
}
th{
  color:var(--accent);
  background:#080808;
  font-weight:500;
  font-size:12px
}
tr:nth-child(even){background:#111}
tr:hover{background:rgba(214,180,76,.08)}
</style>
</head>
<body>

<!-- Header mount -->
<div id="header-container"></div>
<script>
(async () => {
  try {
    const res = await fetch('header.html', { cache: 'no-cache' });
    const html = await res.text();
    document.getElementById('header-container').outerHTML = html;

    requestAnimationFrame(() => {
      const here = (location.pathname.split('/').pop() || 'index.html').toLowerCase();
      document.querySelectorAll('.nav-btn').forEach(a => {
        const href = (a.getAttribute('href')||'').toLowerCase();
        if (href === here) {
          a.classList.add('active');
          a.setAttribute('aria-current','page');
        }
      });
    });
  } catch (e) {
    console.warn('Header load failed:', e);
  }
})();
</script>

<div class="panel">
  <div class="controls">
    <input id="search" placeholder="Search (name, manufacturer)…">
    <select id="filterType"><option value="">All Types</option></select>
    <select id="filterSize"><option value="">All Sizes</option></select>
    <select id="filterGrade"><option value="">All Grades</option></select>
    <select id="filterClass"><option value="">All Classes</option></select>
    <button id="exportJSON">Export JSON</button>
    <button id="exportCSV">Export CSV</button>
  </div>

  <div class="kpis">
    <div class="kpi-card">
      <h3>Total Components</h3>
      <div class="val" id="kpiCount">0</div>
    </div>
    <div class="kpi-card">
      <h3>By Type (Top 3)</h3>
      <div class="val small" id="kpiType">—</div>
    </div>
    <div class="kpi-card">
      <h3>Source</h3>
      <div class="val small">data/components.js</div>
    </div>
  </div>

  <h2 style="color:var(--accent);font-size:var(--fs-h2);margin:8px 0 4px">
    Star Citizen Components
  </h2>

  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Manufacturer</th>
          <th>Type</th>
          <th>Size</th>
          <th>Grade</th>
          <th>Class</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>

<script>
const JSON_URL = 'data/components.js';

const $  = s => document.querySelector(s);
function esc(s=''){ const d=document.createElement('div'); d.textContent = s ?? ''; return d.innerHTML; }

let components = [];

/* Map your JSON (Names, Component, Size, Grade, Class, Manufacturer, Link) */
function mapJsonComponent(c){
  const name = c.Names || c.Name || '';
  const type = c.Component || '';
  const manufacturer = (c.Manufacturer || '').trim();

  let size = c.Size || '';
  if (typeof size === 'string') size = size.replace(/\s+/g,'');

  let grade = c.Grade;
  if (typeof grade === 'number') {
    const letters = 'ABCDEFG';
    const idx = Math.max(0, Math.min(letters.length - 1, grade - 1));
    grade = 'Grade ' + letters[idx];
  } else if (typeof grade === 'string' && grade.trim()) {
    grade = /^grade/i.test(grade) ? grade.trim() : ('Grade ' + grade.trim());
  } else {
    grade = '';
  }

  const cls  = c.Class || '';
  const link = c.Link || '';

  return { name, type, manufacturer, size, grade, class: cls, link };
}

async function loadFromJSON(){
  try{
    const res = await fetch(JSON_URL, { cache:'no-cache' });
    if (!res.ok) throw new Error('HTTP ' + res.status);

    const text = await res.text();
    console.log('[components] RAW first 200 chars:', text.slice(0,200) + '...');

    const json = JSON.parse(text);
    if (!Array.isArray(json)) throw new Error('Expected an array in ' + JSON_URL);

    components = json.map(mapJsonComponent);
    populateFilters();
    updateKPI();
    render();
  }catch(err){
    console.error('loadFromJSON error:', err);
    components = [];
    updateKPI();
    render();
    alert('Failed to load components from ' + JSON_URL + '\\n' + err.message);
  }
}

/* Filters */
function distinct(arr, key){
  return [...new Set(arr.map(x => x[key]).filter(Boolean))].sort();
}
function fillSelect(sel, values, label){
  const prev = sel.value;
  sel.innerHTML = `<option value="">${label}</option>` +
    values.map(v => `<option>${esc(v)}</option>`).join('');
  if (values.includes(prev)) sel.value = prev;
}
function populateFilters(){
  fillSelect($('#filterType'),  distinct(components,'type'),  'All Types');
  fillSelect($('#filterSize'),  distinct(components,'size'),  'All Sizes');
  fillSelect($('#filterGrade'), distinct(components,'grade'),'All Grades');
  fillSelect($('#filterClass'), distinct(components,'class'),'All Classes');
}

/* Render table */
function render(){
  const q  = ($('#search')?.value || '').toLowerCase().trim();
  const ft = $('#filterType')?.value || '';
  const fs = $('#filterSize')?.value || '';
  const fg = $('#filterGrade')?.value || '';
  const fc = $('#filterClass')?.value || '';

  let arr = components.slice();

  if (q){
    arr = arr.filter(c =>
      `${c.name} ${c.manufacturer}`.toLowerCase().includes(q)
    );
  }
  if (ft) arr = arr.filter(c => c.type  === ft);
  if (fs) arr = arr.filter(c => c.size  === fs);
  if (fg) arr = arr.filter(c => c.grade === fg);
  if (fc) arr = arr.filter(c => c.class === fc);

  const rows = arr.map(c => {
    const nameHtml = c.link
      ? `<a href="${esc(c.link)}" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none">${esc(c.name)}</a>`
      : `<span style="color:var(--accent)">${esc(c.name)}</span>`;
    return `
      <tr>
        <td>${nameHtml}</td>
        <td>${esc(c.manufacturer)}</td>
        <td>${esc(c.type)}</td>
        <td>${esc(c.size)}</td>
        <td>${esc(c.grade)}</td>
        <td>${esc(c.class || '')}</td>
      </tr>
    `;
  }).join('');

  $('#rows').innerHTML = rows || `
    <tr>
      <td colspan="6" class="small" style="padding:10px;">No components found.</td>
    </tr>
  `;
}

/* KPIs */
function updateKPI(){
  $('#kpiCount').textContent = String(components.length);
  const byType = {};
  components.forEach(c => { byType[c.type] = (byType[c.type] || 0) + 1; });
  const top = Object.entries(byType)
    .sort((a,b)=>b[1]-a[1])
    .slice(0,3)
    .map(([k,v]) => `${k}: ${v}`)
    .join(' • ') || '—';
  $('#kpiType').textContent = top;
}

/* Export */
function exportJSON(){
  const blob = new Blob([JSON.stringify(components,null,2)], {type:'application/json'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url;
  a.download = 'jmbn-components-view.json';
  a.click();
  URL.revokeObjectURL(url);
}
function exportCSV(){
  const headers = ['name','manufacturer','type','size','grade','class'];
  const rows    = components.map(c => headers.map(h => String(c[h] ?? '')));
  const csv = [
    headers.join(','),
    ...rows.map(r => '"' + r.map(s => s.replace(/"/g,'""')).join('","') + '"')
  ].join('\n');

  const blob = new Blob([csv], {type:'text/csv'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url;
  a.download = 'jmbn-components-view.csv';
  a.click();
  URL.revokeObjectURL(url);
}
document.getElementById('exportJSON').onclick = exportJSON;
document.getElementById('exportCSV').onclick = exportCSV;

/* Filter & search events */
['search','filterType','filterSize','filterGrade','filterClass'].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener('input', render);
});

/* Init with auth */
document.addEventListener('DOMContentLoaded', async () => {
  const session = await requireAuth();   // redirects to auth.html if not logged in
  if (!session) return;
  await loadFromJSON();
});
</script>

</body>
</html>
