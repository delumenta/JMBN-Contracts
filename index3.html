<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>JMBN — Earnings Admin (Aurora Ops)</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Play:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" type="image/png" href="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" sizes="32x32">

<style>
:root{
  --bg:#000;
  --panel:#0b0b0b;
  --row:#111;
  --border:#d6b44c;
  --accent:#f2d675;       /* warm gold */
  --accent2:#ffe58f;      /* lighter gold for hovers */
  --text:#f7f1d0;
  --muted:#c9b06a;
  --bad:#ff6b6b;
  --ok:#7CFC9A;
  --fs:14px;
  --shadow:0 0 22px rgba(214,180,76,.12);
  --glow:0 0 12px rgba(242,214,117,.25);
}
*{box-sizing:border-box}
html,body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:'Play',system-ui,sans-serif;font-size:var(--fs);letter-spacing:.2px
}
a{color:var(--accent);text-decoration:none}
.wrap{max-width:1180px;margin:20px auto;padding:0 14px 100px}

/* Topbar */
.topbar{display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);padding-bottom:10px;margin-bottom:16px}
.topbar img{width:40px;height:40px;object-fit:contain}
.topbar h1{margin:0;font-size:20px;color:var(--accent);letter-spacing:.5px}

/* Aurora Ops Cards */
.card{
  background:var(--panel);
  border:1px solid var(--border); border-left:4px solid var(--accent);
  border-radius:10px; box-shadow:var(--shadow);
  padding:14px; margin-bottom:14px;
  transition:box-shadow .2s ease,border-color .2s ease
}
.card:hover{box-shadow:var(--glow);border-color:var(--accent2)}
.hd{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);padding-bottom:8px;margin-bottom:12px}
.hd h3{margin:0;font-size:16px;color:var(--accent)}
.small{color:var(--muted);font-size:12px}
.badge{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);color:var(--accent);background:#111;border-radius:999px;padding:3px 8px;font-size:11px}

/* Inputs / Buttons */
input,select,button{font-family:'Play'}
input[type="number"], input[type="text"], input[type="date"], select{
  background:#0a0a0a;color:var(--text);border:1px solid var(--border);
  border-radius:10px;padding:8px 10px
}
button{
  border:1px solid var(--border);
  background:#111; color:var(--accent);
  border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:700
}
button:hover{background:var(--accent);color:#000;box-shadow:var(--glow)}
.btn-ok{border-color:var(--ok);color:var(--ok)}
.btn-bad{border-color:var(--bad);color:var(--bad)}
.pill{border-radius:999px;padding:6px 10px}

/* KPIs */
.grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
@media(max-width:900px){.grid3{grid-template-columns:1fr}}
.kpi{background:#111;border:1px solid rgba(214,180,76,.4);border-radius:10px;text-align:center;padding:12px}
.kpi h4{margin:0;color:var(--muted);font-size:11px;text-transform:uppercase}
.kpi .v{font-size:20px;color:var(--accent);font-weight:700}

/* Mission table (rows, not HTML table) */
.table{width:100%;border-collapse:separate;border-spacing:0 8px}
.row{
  display:grid;gap:10px;align-items:center;
  grid-template-columns:160px 1fr 120px 260px 140px 180px;
  background:#0a0a0a;border:1px solid rgba(214,180,76,.35);border-radius:10px;padding:8px
}
@media(max-width:1120px){.row{grid-template-columns:150px 1fr 120px 240px 140px}}
@media(max-width:900px){ .row{grid-template-columns:1fr} }
.cell{padding:4px 6px}
.meta{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.tag{font-size:11px;padding:2px 6px;border:1px solid var(--border);border-radius:999px;color:var(--accent);background:#121212}
.tag.dim{opacity:.75}
.note{font-size:11px;color:var(--muted)}
.right{display:flex;gap:8px;align-items:center;justify-content:flex-end}

/* Cut controller */
.cutCtrl{display:flex;align-items:center;gap:6px}
.cutCtrl button{width:32px;height:32px;padding:0}
.cutCtrl input{width:92px;text-align:center}

/* Alerts */
.alert{border:1px solid var(--bad);background:#240e0e;color:#ffbcbc;border-radius:10px;padding:8px 10px}
.ok{border:1px solid var(--ok);background:#102014;color:#adffcb;border-radius:10px;padding:8px 10px}

/* Drawer (Participants) */
.drawer{
  position:fixed;right:0;top:0;bottom:0;width:460px;max-width:96vw;background:#0b0b0b;border-left:1px solid var(--border);
  box-shadow:-10px 0 30px rgba(214,180,76,.15);transform:translateX(100%);transition:transform .25s ease;z-index:50
}
.drawer.open{transform:translateX(0)}
.dh{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid var(--border)}
.dh h3{margin:0;color:var(--accent);font-size:16px}
.db{padding:12px}

/* Participant row */
.urow{
  display:grid;grid-template-columns:1fr 110px 120px auto;gap:8px;align-items:center;
  padding:10px;border:1px solid rgba(214,180,76,.35);border-radius:10px;background:#0a0a0a;margin-bottom:8px
}
@media(max-width:430px){.urow{grid-template-columns:1fr}}
.urow .name{display:flex;flex-direction:column;gap:4px}
.urow .name b{font-size:14px}
.urow .name .sub{display:flex;gap:6px;flex-wrap:wrap}
.urow .ctrl{display:flex;gap:4px;align-items:center}
.urow .ctrl input{width:84px;text-align:center}
.urow .amt{text-align:right;font-weight:700}
.urow .act{display:flex;gap:6px;justify-content:flex-end}
</style>
</head>
<body>

<div class="wrap">
  <div class="topbar">
    <img src="https://static.wixstatic.com/media/08ea88_820ac3bc561d4233ad73a7af859f28bf~mv2.png" alt="JMBN">
    <h1>JMBN — Earnings Admin (Aurora Ops)</h1>
  </div>

  <!-- Global cut -->
  <div class="card">
    <div class="hd">
      <h3>Org Cut</h3>
      <span class="small">Global % applies unless mission override exists, or mission snapshot is set.</span>
    </div>
    <div class="meta" style="display:flex;gap:12px;flex-wrap:wrap">
      <div class="small">Default %</div>
      <input id="gCut" type="number" step="0.1" min="0" max="100" style="width:110px"/>
      <button id="gSave">Save</button>
      <span class="small" id="gStamp">—</span>
    </div>
  </div>

  <!-- Filters + Ledger -->
  <div class="card">
    <div class="hd">
      <h3>Mission Ledger</h3>
      <div class="meta" style="display:flex;gap:8px;flex-wrap:wrap">
        <input id="fFrom" type="date">
        <input id="fTo" type="date">
        <select id="fStatus">
          <option value="">All Status</option>
          <option value="planned">Planned</option>
          <option value="success">Success</option>
          <option value="abort">Abort</option>
          <option value="failed">Failed</option>
        </select>
        <button id="btnReload">Reload</button>
      </div>
    </div>

    <div class="grid3" style="margin-bottom:10px">
      <div class="kpi"><h4>ORG EARNED</h4><div class="v" id="kOrg">–</div></div>
      <div class="kpi"><h4>MEMBER SHARE</h4><div class="v" id="kMem">–</div></div>
      <div class="kpi"><h4>MISSIONS</h4><div class="v" id="kMis">–</div></div>
    </div>

    <div class="small" style="margin-bottom:8px">Use <b>– / +</b> to nudge a mission’s override. Type a value then press <b>Save</b>. Values are in <b>%</b>.</div>
    <div id="list">Loading…</div>
  </div>

  <!-- Last 4 -->
  <div class="card">
    <div class="hd">
      <h3>Last 4 Missions (Org)</h3>
      <span class="badge" id="lastCount">0</span>
    </div>
    <div id="last4" class="body">—</div>
  </div>
</div>

<!-- PARTICIPANTS DRAWER -->
<div id="drawer" class="drawer" aria-hidden="true">
  <div class="dh">
    <h3 id="dwTitle">Participants & Overrides</h3>
    <button id="drawerClose" title="Close">✕</button>
  </div>
  <div class="db">
    <div class="small" id="dwMeta">—</div>
    <div class="small" style="margin:8px 0 10px">
      Member pool = <code>payout</code> − <code>org_cut_value</code> (if present) otherwise <code>payout × (1 − org_cut_pct)</code>.<br>
      Default percent is <b>weighted by rank</b> from <code>v_missions_payout_live.weight ÷ total_weight</code>.
    </div>
    <div id="uList">Loading…</div>
  </div>
</div>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="js/auth.js"></script>
<script>
/* Utilities */
const $ = s => document.querySelector(s);
const esc = s => { const d=document.createElement('div'); d.textContent=s??''; return d.innerHTML; };
const fmt = n => (n==null || isNaN(n)) ? '–' : Number(n).toLocaleString();

/* State */
let sb, me, GLOBAL = 0, MISSIONS = [], OV = {}, drawerMission = null;

/* Boot */
document.addEventListener('DOMContentLoaded', async () => {
  const session = await requireAuth(); if(!session) return;
  sb = getSupabase(); me = session.user.id;

  setDefaultDates();
  await loadGlobal();
  await loadLedger();

  $('#drawerClose').onclick = closeDrawer;
  $('#gSave').onclick = saveGlobal;
  $('#btnReload').onclick = loadLedger;
});

function setDefaultDates(){
  const to = new Date(); const from = new Date(); from.setMonth(from.getMonth()-1);
  $('#fFrom').value = from.toISOString().slice(0,10);
  $('#fTo').value   = to.toISOString().slice(0,10);
}

/* Global cut */
async function loadGlobal(){
  const { data, error } = await sb.from('org_settings')
    .select('org_cut_pct, updated_at').order('updated_at', { ascending:false }).limit(1).maybeSingle();
  if(error){ $('#gStamp').textContent = 'Failed to load global'; return; }
  GLOBAL = Number(data?.org_cut_pct||0);
  $('#gCut').value = String(GLOBAL);
  $('#gStamp').textContent = data?.updated_at ? `Updated ${new Date(data.updated_at).toLocaleString()}` : '';
}
async function saveGlobal(){
  const clamp = v => Math.max(0, Math.min(100, Number(v)||0));
  const val = clamp($('#gCut').value);
  $('#gCut').value = String(val);
  const note = `Set by ${me.slice(0,8)}`;
  const { error } = await sb.from('org_settings').insert({ org_cut_pct: val, note });
  if(error){ alert('Saving global failed: '+error.message); return; }
  await loadGlobal();
  renderList();
}

/* Ledger */
async function loadLedger(){
  const list = $('#list');
  list.textContent = 'Loading…';

  const from = $('#fFrom').value ? new Date($('#fFrom').value) : null;
  const to   = $('#fTo').value ? new Date($('#fTo').value) : null;
  const status = $('#fStatus').value || '';

  let q = sb.from('missions')
     .select('id,title,start_time,payout_auec,status,org_cut_percent')
     .order('start_time',{ascending:false});
  if(from) q = q.gte('start_time', from.toISOString());
  if(to){ const end = new Date(to); end.setDate(end.getDate()+1); q = q.lt('start_time', end.toISOString()); }
  if(status) q = q.eq('status', status);

  const { data: rows, error } = await q;
  if(error){ list.innerHTML = `<div class="alert">${esc(error.message)}</div>`; return; }
  MISSIONS = rows || [];

  // mission-level overrides table
  OV = {};
  if(MISSIONS.length){
    const ids = MISSIONS.map(m=>m.id);
    const { data: orows } = await sb.from('mission_org_cut_overrides')
      .select('mission_id, org_cut_pct').in('mission_id', ids);
    (orows||[]).forEach(r=> OV[r.mission_id] = r);
  }

  renderList();
  renderLast4();
}
function effectiveCutPct(m){
  // Returns a % in 0..100 for display/math downstream
  let eff = (OV[m.id]?.org_cut_pct != null) ? Number(OV[m.id].org_cut_pct)
          : (m.org_cut_percent != null) ? Number(m.org_cut_percent)
          : Number(GLOBAL);
  if(eff < 0) eff = 0;
  if(eff > 100) eff = 100;
  return eff;
}
function rowBadgeSet(m){
  const bag = [];
  if(OV[m.id]) bag.push(`<span class="tag">override</span>`);
  if(m.org_cut_percent!=null) bag.push(`<span class="tag dim">snapshot</span>`);
  if(m.status) bag.push(`<span class="tag dim">${esc(m.status)}</span>`);
  return bag.join(' ');
}
function renderList(){
  const list = $('#list');
  if(!MISSIONS.length){
    list.innerHTML = `<div class="small">No missions in this window.</div>`;
    $('#kOrg').textContent = '–'; $('#kMem').textContent = '–'; $('#kMis').textContent = '0';
    return;
  }
  let totOrg=0, totPayout=0;
  const rows = MISSIONS.map(m=>{
    const payout = Number(m.payout_auec||0);
    const effPct = effectiveCutPct(m);
    const orgEarn = payout * (effPct/100);
    totOrg += orgEarn; totPayout += payout;

    const oVal = (OV[m.id]?.org_cut_pct!=null) ? OV[m.id].org_cut_pct : '';
    const hint = (m.org_cut_percent!=null)
      ? `Effective <b>${effPct}%</b> (${OV[m.id]?'override':'snapshot'})`
      : `Effective <b>${effPct}%</b> (${OV[m.id]?'override':'global'})`;

    return `
      <div class="row" data-id="${m.id}">
        <div class="cell small">${new Date(m.start_time).toLocaleString()}</div>
        <div class="cell">
          <div>${esc(m.title||'Untitled')}</div>
          <div class="meta" style="margin-top:4px">${rowBadgeSet(m)}</div>
        </div>
        <div class="cell"><b>${fmt(payout)}</b></div>

        <div class="cell">
          <div class="cutCtrl">
            <button data-minus>-</button>
            <input type="number" step="0.1" min="0" max="100" placeholder="override %" value="${oVal!==''?oVal:''}">
            <button data-plus>+</button>
            <button class="btn-ok" data-save>Save</button>
          </div>
          <div class="note">${hint}</div>
        </div>

        <div class="cell"><b>${fmt(orgEarn)}</b></div>

        <div class="cell right">
          <button class="pill" data-participants>Participants</button>
          <button class="btn-bad" data-clear ${OV[m.id]?'':'disabled'}>Clear Override</button>
        </div>
      </div>`;
  }).join('');

  list.innerHTML = `
    <div class="table">
      <div class="row" style="background:transparent;border-color:transparent">
        <div class="cell small">Date</div>
        <div class="cell small">Title</div>
        <div class="cell small">Payout</div>
        <div class="cell small">Cut % (Override) &amp; Effective</div>
        <div class="cell small">Org Earned</div>
        <div class="cell small">Actions</div>
      </div>
      ${rows}
    </div>`;

  // KPIs
  $('#kOrg').textContent = fmt(totOrg);
  $('#kMem').textContent = fmt(totPayout - totOrg);
  $('#kMis').textContent = String(MISSIONS.length);

  // wire
  list.querySelectorAll('.row').forEach(row=>{
    const id = row.dataset.id;
    const inp = row.querySelector('input[type="number"]');
    row.querySelector('[data-minus]')?.addEventListener('click', ()=>{ inp.value = String(Math.max(0,(Number(inp.value)||0)-0.5)); });
    row.querySelector('[data-plus]') ?.addEventListener('click', ()=>{ inp.value = String(Math.min(100,(Number(inp.value)||0)+0.5)); });
    row.querySelector('[data-save]') ?.addEventListener('click', ()=> saveMissionOverride(id, inp.value));
    row.querySelector('[data-clear]')?.addEventListener('click', ()=> clearMissionOverride(id));
    row.querySelector('[data-participants]')?.addEventListener('click', ()=> openDrawer(id));
  });
}
async function saveMissionOverride(missionId, val){
  const pct = Math.max(0, Math.min(100, Number(val)||0));
  if(isNaN(pct)) return alert('Enter a number 0–100.');
  const payload = { mission_id: missionId, org_cut_pct: pct, updated_by: me };
  const { error } = await sb.from('mission_org_cut_overrides').upsert(payload).select().maybeSingle();
  if(error) return alert('Save override failed: ' + error.message);
  OV[missionId] = { mission_id: missionId, org_cut_pct: pct };
  renderList();
}
async function clearMissionOverride(missionId){
  if(!confirm('Remove mission override?')) return;
  const { error } = await sb.from('mission_org_cut_overrides').delete().eq('mission_id', missionId);
  if(error) return alert('Clear failed: ' + error.message);
  delete OV[missionId];
  renderList();
}

/* Last 4 */
async function renderLast4(){
  const box = $('#last4');
  const { data, error } = await sb.from('missions')
    .select('id,title,start_time,payout_auec,status,org_cut_percent')
    .order('start_time',{ascending:false}).limit(4);
  if(error || !data?.length){ box.innerHTML='—'; $('#lastCount').textContent='0'; return; }
  const ids = data.map(m=>m.id);
  const { data: over } = await sb.from('mission_org_cut_overrides')
    .select('mission_id, org_cut_pct').in('mission_id', ids);
  const map = Object.fromEntries((over||[]).map(r=>[r.mission_id, r.org_cut_pct]));
  $('#lastCount').textContent = String(data.length);
  box.innerHTML = data.map(m=>{
    const eff = (map[m.id]!=null) ? map[m.id]
               : (m.org_cut_percent!=null ? m.org_cut_percent : GLOBAL);
    const effPct = Math.max(0, Math.min(100, Number(eff)||0));
    const payout = Number(m.payout_auec||0);
    const orgEarn = payout * effPct/100;
    return `
      <div class="row" style="grid-template-columns:180px 1fr 120px 160px 120px">
        <div class="cell small">${new Date(m.start_time).toLocaleString()}</div>
        <div class="cell">${esc(m.title||'Untitled')} <span class="tag dim">${esc(m.status||'')}</span></div>
        <div class="cell"><b>${fmt(payout)}</b></div>
        <div class="cell small">Cut: <b>${effPct}%</b></div>
        <div class="cell"><b>${fmt(orgEarn)}</b></div>
      </div>`;
  }).join('');
}

/* Participants Drawer */
function openDrawer(missionId){
  drawerMission = missionId;
  $('#drawer').classList.add('open');
  loadParticipants(missionId);
}
function closeDrawer(){
  $('#drawer').classList.remove('open');
  $('#uList').innerHTML='';
  drawerMission=null;
}

async function loadParticipants(missionId){
  const uList = $('#uList');
  uList.innerHTML = 'Loading…';

  const mission = MISSIONS.find(m=>m.id===missionId);
  $('#dwTitle').textContent = 'Participants & Overrides';
  $('#dwMeta').innerHTML = `${esc(mission?.title||'Untitled')} • ${new Date(mission?.start_time).toLocaleString()}`;

  // 1) from v_missions_payout_live
  let rows = [];
  try{
    const { data, error } = await sb.from('v_missions_payout_live')
      .select('user_id, weight, total_weight, base_share, final_share, payout_auec, org_cut_pct, org_cut_value')
      .eq('mission_id', missionId)
      .order('weight', { ascending:false });
    if(error) throw error;
    rows = data || [];
  }catch(e){
    uList.innerHTML = `<div class="alert">Failed to load participants: ${esc(e.message)}</div>`;
    return;
  }
  if(!rows.length){ uList.innerHTML = `<div class="small">No participants found for this mission.</div>`; return; }

  // 2) names from v_profiles_detailed
  const ids = [...new Set(rows.map(r=>r.user_id).filter(Boolean))];
  const nameMap = {};
  if(ids.length){
    try{
      const { data: prof } = await sb.from('v_profiles_detailed')
        .select('user_id, handle, display_name, current_rank_abbrev')
        .in('user_id', ids);
      (prof||[]).forEach(p=>{
        const label = (p.display_name?.trim()) || (p.handle?.trim()) || String(p.user_id).slice(0,8);
        nameMap[p.user_id] = { label, rank: p.current_rank_abbrev||'', handle: p.handle?('@'+p.handle):'' };
      });
    }catch(_){}
  }
  const labelOf = uid => nameMap[uid]?.label || String(uid).slice(0,8);
  const rankOf  = uid => nameMap[uid]?.rank  || '';
  const handleOf= uid => nameMap[uid]?.handle|| '';

  // 3) per-user overrides
  const { data: uov } = await sb.from('mission_user_overrides')
    .select('user_id, share_pct, share_fixed_auec, note')
    .eq('mission_id', missionId);
  const mapOv = Object.fromEntries((uov||[]).map(r=>[r.user_id, r]));

  // 4) pool math (prefer org_cut_value if present)
  const h = rows[0];
  const payout = Number(h.payout_auec||0);
  const cutVal = (h.org_cut_value!=null) ? Number(h.org_cut_value) : null;
  let cutPct = (h.org_cut_pct!=null) ? Number(h.org_cut_pct) : null;
  // normalize pct: supports 0..1 or 0..100 inputs
  if(cutPct!=null && cutPct > 1) cutPct = cutPct/100;
  const memberPool = (cutVal!=null) ? (payout - cutVal) : (payout * (1 - (cutPct ?? 0)));

  // 5) weighted default percentage by rank weight
  const totalWeight = Number(h.total_weight|| rows.reduce((a,b)=>a+Number(b.weight||0),0) || 0);

  uList.innerHTML = rows.map(r=>{
    const uid = r.user_id;
    const label  = labelOf(uid);
    const rank   = rankOf(uid);
    const handle = handleOf(uid);
    const weight = Number(r.weight||0);
    const defaultPct = totalWeight > 0 ? (weight/totalWeight)*100 : 0; // weighted default by rank

    const ov = mapOv[uid] || {};
    const hasFixed = (ov.share_fixed_auec!=null && !isNaN(Number(ov.share_fixed_auec)));
    const hasPct   = (ov.share_pct!=null);
    const pctUsed  = hasPct ? Number(ov.share_pct) : defaultPct;
    const amt = hasFixed ? Number(ov.share_fixed_auec) : (memberPool * (pctUsed/100));

    return `
      <div class="urow" data-uid="${uid}">
        <div class="name">
          <b>${esc(label)}</b>
          <div class="sub">
            ${rank?`<span class="tag">${esc(rank)}</span>`:''}
            <span class="tag dim">${esc(handle)}</span>
            <span class="tag dim">w:${weight.toFixed(2)}</span>
            <span class="tag">default ${defaultPct.toFixed(1)}%</span>
            ${ov.note?`<span class="tag dim">${esc(ov.note)}</span>`:''}
          </div>
        </div>

        <div class="ctrl">
          <button data-pct-minus>-</button>
          <input data-pct type="number" step="0.5" min="0" max="100" value="${hasPct?pctUsed.toFixed(1):''}" placeholder="${defaultPct.toFixed(1)}">
          <button data-pct-plus>+</button>
        </div>

        <div class="ctrl">
          <input data-fixed type="number" step="1" min="0" placeholder="fixed aUEC" value="${hasFixed?Number(ov.share_fixed_auec):''}">
        </div>

        <div class="amt">${hasFixed?'<span class="tag">fixed</span>':''} ${fmt(amt)}</div>

        <div class="act">
          <button class="btn-ok" data-saveu>Save</button>
          <button class="btn-bad" data-clearu ${mapOv[uid]?'':'disabled'}>Clear</button>
        </div>
      </div>`;
  }).join('');

  // 6) wire up row actions
  (uList||document).querySelectorAll('.urow').forEach(row=>{
    const uid   = row.dataset.uid;
    const ipPct = row.querySelector('[data-pct]');
    const ipFix = row.querySelector('[data-fixed]');
    row.querySelector('[data-pct-minus]')?.addEventListener('click', ()=>{ ipPct.value = String(Math.max(0,(Number(ipPct.value)||0)-0.5)); ipFix.value=''; });
    row.querySelector('[data-pct-plus]') ?.addEventListener('click', ()=>{ ipPct.value = String(Math.min(100,(Number(ipPct.value)||0)+0.5)); ipFix.value=''; });

    row.querySelector('[data-saveu]')?.addEventListener('click', async ()=>{
      const clampPct = v => Math.max(0, Math.min(100, Number(v)||0));
      const share_pct = ipPct?.value==='' ? null : clampPct(ipPct.value);
      const share_fixed_auec = ipFix?.value==='' ? null : Math.max(0, Number(ipFix.value)||0);
      const payload = { mission_id: missionId, user_id: uid, share_pct, share_fixed_auec, updated_by: me };
      const { error } = await sb.from('mission_user_overrides').upsert(payload).select().maybeSingle();
      if(error) return alert('Save failed: '+error.message);
      loadParticipants(missionId);
    });

    row.querySelector('[data-clearu]')?.addEventListener('click', async ()=>{
      const { error } = await sb.from('mission_user_overrides')
        .delete().eq('mission_id', missionId).eq('user_id', uid);
      if(error) return alert('Clear failed: '+error.message);
      loadParticipants(missionId);
    });
  });
}
</script>
</body>
</html>